b4w.register("victory_day_2015_main",function(ab,e){function bb(a,c){if(c){k=a;p.enable_controls();Ba.pause();cb();var b=db.get_std_assets_path();eb.load(b+"victory_day_2015/main_scene.json",fb,gb);Ca();window.addEventListener("resize",Ca)}else console.log("b4w init failure")}function X(a){if(r){var c=Y.get_coords_x(a);a=Y.get_coords_y(a);Da(c,a);Ea(c,a)}}function P(){ia&&(ia=!1,ja?(r=null,hb()):(D.pop(),D.pop(),l.remove_object(r),r=null,--t))}function hb(){var a=D[D.length-2],c=D[D.length-1],b=m.get_tsr(a,
h.create()),d=m.get_tsr(c,h.create()),E=h.transform_vec3(Fa,d,d);F.animate(0,1,500,function(d){var g=h.interpolate(b,E,I.smooth_step(d),h.create());m.set_tsr(a,g);1==d&&ib(a,c)})}function ib(a,c){var b=m.get_tsr(a,h.create()),d=m.get_tsr(c,h.create());Math.round(Math.random())?n.play_def(Ga):n.play_def(Ha);F.animate(0,1,500,function(g){var A=h.interpolate(b,d,I.smooth_step(g),h.create());m.set_tsr(a,A);1==g&&(k.addEventListener("mousedown",C),k.addEventListener("touchstart",C),R.append_stiff(a,c,
v.set(0,0,0,Z)),J.set_nodemat_value(K,["control_box","Value"],1))})}function C(a){a.preventDefault&&a.preventDefault();var c=Y.get_coords_x(a);a=Y.get_coords_y(a);var b=l.pick_object(c,a);if(b)switch(l.get_object_name(b)){case "rockets_box*rockets_box":if(16!=t){t+=1;r=b=J.copy(Ia,"rocket_"+t);D.push(b);var d="";10>t&&(d="0");ka=d=l.get_object_by_dupli_name("bm_13","rail_"+d+t);D.push(d);l.append_object(b);Da(c,a);Ea(c,a);ia=!0}break;case "control_box*control_box_button":aa=2,jb()}}function jb(){t&&
(k.removeEventListener("mousedown",C),k.removeEventListener("touchstart",C),n.stop(la),n.play_def(la),b.apply(B,"press_button_Action"),b.set_behavior(B,b.AB_FINISH_STOP),b.play(B),b.set_speed(L,-1),b.play(L,function(){b.apply(u,"bm_13_Armature_rotate_-37_Action");b.set_first_frame(u);b.set_behavior(u,b.AB_FINISH_STOP);b.play(u,kb)}))}function kb(){var a=b.apply,c=b.play,f=b.set_behavior;a(g,S);b.set_frame(g,b.get_anim_start_frame(u));f(g,b.AB_FINISH_STOP);c(g,lb);a(K,"hide_control_box_Action");a(B,
"hide_control_box_Action");f(K,b.AB_FINISH_STOP);f(B,b.AB_FINISH_STOP);c(K);c(B);n.stop(T)}function lb(){for(var a=1;a<=t;a++)mb(a)}function mb(a){var c=l.append_object,f=R.append_stiff,d=b.apply,E=J.copy,A=b.play,e=R.remove,U=l.remove_object,y=b.set_behavior,u=l.show_object,q="";10>a&&(q="0");var M=l.get_object_by_name("rocket_"+a),z=l.get_object_by_dupli_name("bm_13","rail_"+q+a);e(M);var p=E(Ja,"rocket_flash_"+a),w=E(Ka,"rocket_plume_"+a),x=E(ma,"rocket_start_smoke_"+a),r=E(na,"settling_smoke_"+
a);F.set_timeout(function(){c(p);c(w);c(x);c(r);u(x);u(r);d(p,"rocket_flash_Shader_NodetreeAction");d(w,"rocket_plume_start_Shader_NodetreeAction");d(x,"rocket_start_smoke_Shader_NodetreeAction");d(x,"rocket_start_smoke_finalscale",b.SLOT_1);d(r,"settling smoke_Shader_NodetreeAction");y(w,b.AB_FINISH_STOP);y(p,b.AB_FINISH_STOP);y(x,b.AB_FINISH_STOP);y(x,b.AB_FINISH_STOP,b.SLOT_1);y(r,b.AB_FINISH_STOP);y(N,b.AB_FINISH_STOP);y(O,b.AB_FINISH_STOP);f(p,M,oa);f(w,M,oa);f(x,z,ob);e(x);f(r,M,oa);A(p);A(x,
function(){U(x)});var E=h.identity(h.create()),q=h.identity(h.create());m.get_tsr(x,E);m.get_tsr(x,q);F.animate(0,.5,1E3,function(a){q[1]=E[1]-a;m.set_tsr(x,q)});F.set_timeout(function(){A(x,null,b.SLOT_1)},b.frame_to_sec(9));A(r,function(){e(r);U(r)});A(w,function(){d(w,"rocket_plume_loop__Shader_NodetreeAction");y(w,b.AB_CYCLIC);A(w)});F.set_timeout(function(){e(r)},100);n.play_def(pa);var v=m.get_tsr(M,h.identity(h.create())),B=h.create();h.copy(v,B);var nb=h.transform_vec3(La,v,B);if(qa?0:a==
(0>=t?1==t?1:t-1:t-0))qa=!0,d(N,"residual_smoke_Armature_Action"),d(O,"residual_smoke_Shader_NodetreeAction"),d(G,"rocket_smoke_Shader_NodetreeAction"),d(G,"rocket_smoke_finalscale",b.SLOT_1),b.set_first_frame(N),b.set_first_frame(O),b.set_first_frame(G),b.set_first_frame(G,b.SLOT_1),y(N,b.AB_FINISH_STOP),y(O,b.AB_FINISH_STOP),y(G,b.AB_FINISH_STOP),y(G,b.AB_FINISH_STOP,b.SLOT_1),A(G),A(G,null,b.SLOT_1),F.set_timeout(function(){u(O);A(N);b.play(O,function(){qa=!1;m.set_tsr(g,Ma);var a=m.get_rotation(g,
ra),a=Q.rotateX(a,Math.PI,Na);m.set_rotation_v(g,a);a=l.hide_object;a(ba);a(ca);a(sa);b.apply(V,"9may_atlas_Shader_NodetreeAction");b.set_first_frame(V);b.set_behavior(V,b.AB_FINISH_STOP);n.stop(da);n.play_def(da);ea=0;for(a=1;a<=t;a++)pb(a)})},500);1==a&&ta.set_light_params(H,{light_energy:20});F.animate(0,1,2E3,function(c){var b=h.interpolate(v,nb,I.smooth_step(c),h.identity(h.create()));m.set_tsr(M,b);m.set_translation(H,b[0],b[1]+8,b[2]);1==c&&(e(p),e(w),U(M),U(p),U(w),a==t&&(D=[],n.stop(pa),
k.addEventListener("mousedown",C),k.addEventListener("touchstart",C)))})},250*a)}function Da(a,c){var b=Oa.calc_ray(g,a,c,Z),d=m.get_translation(g,Pa),b=v.scale(b,3,ua),d=v.add(d,b,Qa);d[1]=I.clamp(d[1],.5,3);m.set_translation_v(r,d)}function Ea(a,b){var f=m.get_translation(r,Z),d=m.get_rotation(r,ra),h=m.get_translation(ka,Pa),e=m.get_rotation(ka,Na),l=Oa.project_point(g,h,ua),k=a-l[0],l=b-l[1],k=Math.sqrt(k*k+l*l);400>k?ja=!0:(ja=!1,k=400);l=I.quat_to_dir(d,I.AXIS_MY,ua);f=v.subtract(f,h,Qa);v.normalize(f,
f);f=Q.rotationTo(l,f,qb);Q.multiply(f,d,d);Q.normalize(d,d);d=Q.slerp(e,d,k/400,rb);m.set_rotation_v(r,d)}function va(){var a=document.querySelector("#content"),b=document.querySelector("#info_container"),f=document.querySelector("#footer");fa>window.innerHeight+10?(fa-50>=window.innerHeight&&(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),440>window.innerHeight?(a.style.display="none",f.style.backgroundImage="",a.style.backgroundImage=
""):(fa-50>=window.innerHeight&&(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),a.style.display="",a.style.height=b.offsetHeight-200-175+"px"),380>window.innerWidth&&(a.style.height=parseInt(a.style.height)+70+"px")):(a.style.height="",f.style.backgroundImage="",a.style.backgroundImage="")}function fb(){var a=p.get_url_params();if(a&&"lang"in a){var c="ru";"ru"==a.lang&&(c="en");var a=document.querySelector("#social_buttons."+c),f=document.querySelector("#info."+
c),c=document.querySelector("#run_button."+c);a.parentNode.removeChild(a);f.parentNode.removeChild(f);c.parentNode.removeChild(c)}W=document.querySelector("#replay");wa=W.querySelector("#replay_circle");z=document.querySelector("#info_container");ga=document.querySelector("#blend4web_logo");ha=document.querySelector("#social_buttons");c=l.get_object_by_dupli_name;a=l.get_object_by_name;g=l.get_active_camera();V=c("9_may_logo","planes");ba=c("firework","firework_1");ca=c("firework","firework_2_1");
sa=c("firework","firework_2_2");Ia=c("rocket","rocket");Ra=a("Empty_camera_position_2");T=c("red_square","noise_spk");la=c("control_box","button_spk");Ga=c("bm_13","load_spk");Ha=c("bm_13","load_spk_2");u=c("bm_13","bm_13_Armature");da=c("bg","fireworks_spk");K=c("control_box","control_box");B=c("control_box","control_box_button");pa=c("bm_13","shot_spk");Ja=c("rocket_plume_flash","rocket_flash");Ka=c("rocket_plume_flash","rocket_plume");ma=c("rocket_start_smoke","rocket_start_smoke");N=c("residual_smoke",
"residual_smoke_Armature");O=l.get_object_children(N)[0];na=c("settling smoke","settling smoke");G=c("rocket_smoke","rocket_smoke");H=a("rocket_Point_1");Sa=a("bm_13");L=c("rockets_box","rockets_box_Armature");Ta=ta.get_light_params(H);c=m.get_tsr;a=v.set;c(g,xa);c(ba,ya);c(ca,za);za[3]=1;v.subtract(za,ya,Aa);c(Ra,Ma);a(0,-1.1,0,Fa);a(0,85,0,La);c(H,Ua);c=l.get_object_by_name("control_box");f=h.multiply(h.invert(xa,h.create()),m.get_tsr(c),h.create());a=Math.abs(f[1]);f=h.get_quat_view(f);R.append_stiff_viewport(c,
g,{right:0,bottom:0,distance:a,rotation:f});R.append_track(H,Sa);Va();b.apply(g,S);b.set_last_frame(g);window.addEventListener("resize",va)}function Va(){S=window.innerWidth>window.innerHeight?"Camera_wide screen_Action":"Camera_narrow_screen_Action";g&&1==aa&&!b.is_play(g)&&b.apply(g,S)}function pb(a){var c=J.copy,f=l.show_object,d=l.append_object,h=l.remove_object,g=b.apply,e=b.play,k=b.SLOT_1,r=m.set_tsr,q=c(ba,"firework_"+a),p=c(ca,"firework_"+a+t+1),n=c(sa,"firework_"+a+t+2);f(q);f(p);f(n);var c=
Math.floor(Math.random()*Wa.length),c=Wa[c],f=.4*-Math.random()+-.2,u=2*Math.random()+-1,v=.3*-Math.random()+0;J.set_nodemat_rgb(p,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);J.set_nodemat_rgb(n,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);c=Xa(ya,f,u,0,v,sb);f=Xa(c,Aa[0],Aa[1],.03*a,0,tb);r(q,c);r(p,f);r(n,f);var w=null;t==a&&(w=ub);F.set_timeout(function(){d(q);d(p);d(n);g(q,"firework_1_Shader_NodetreeAction");g(p,"firework_2_Action");g(p,"firework_2_Shader_NodetreeAction",k);g(n,"firework_2_Action");
g(n,"firework_2_Shader_NodetreeAction",k);e(q,function(){h(q)});e(n);e(p,function(){h(p)});e(n,function(){h(n);w&&w()},k)},ea);ea+=500*(.5+Math.random())}function ub(){n.stop(da);b.play(V,vb)}function vb(){wa.addEventListener("click",Ya);var a=W.style;a.opacity=0;a.display="block";a=ga.style;a.opacity=0;a.display="block";a=ha.style;a.opacity=0;a.display="block";p.css_animate(W,"opacity",0,1,1E3,"","",function(){p.css_animate(ga,"opacity",0,1,300);p.css_animate(ha,"opacity",0,1,500)});b.apply(u,"bm_13_Armature_rotate_-20_Action");
b.set_behavior(u,b.AB_FINISH_STOP);b.set_first_frame(u)}function Ya(){ga.style.display="";ha.style.display="";W.style.display="";J.set_nodemat_value(K,["control_box","Value"],0);b.set_first_frame(g);wa.removeEventListener("click",Ya);t=0;m.set_tsr(g,xa);m.set_tsr(H,Ua);ta.set_light_params(H,Ta);b.apply(g,S);b.set_first_frame(K);b.set_first_frame(B);n.play_def(T);aa=1;Za()}function Xa(a,b,f,d,g,e){h.identity(e);g=Q.setAxisAngle(I.AXIS_Z,g,ra);b=v.set(b,f,d,Z);h.set_trans(b,e);h.set_quat(g,e);h.multiply(a,
e,e);return e}function Ca(){p.resize_to_container();Va()}function gb(a){var b=q.querySelector("#preloader_line_left"),f=q.querySelector("#preloader_line_right"),d=q.querySelector("#percentage");100==a?wb():(40>=a?b.style.width=2*a+"%":40<a&&60>a?b.style.width="100%":60<a&&(b.style.width="100%",f.style.width=2*(a-50)+"%"),d.innerHTML=a)}function cb(){q=document.querySelector("#preloader_container");var a=q.querySelector("#bg_image_container"),b=q.querySelector("#bg_fade_container"),f=q.querySelector("#sun_container"),
d=q.querySelector("#preloader"),e=p.css_animate;e(b,"opacity",0,.6,300);e(q,"opacity",0,1,300,"","",function(){e(a,"opacity",0,1,300,"","",function(){e(f,"opacity",0,1,300,"","",function(){e(d,"opacity",0,1,300,"","",function(){Ba.resume();main_canvas_container.style.visibility="visible"})})})})}function wb(){xb();p.css_animate(q,"opacity",1,0,300,"","",function(){q.parentNode.removeChild(q)})}function xb(){var a=z.querySelector("#close_info_but"),b=z.querySelector("#run_button"),e=z.querySelector("#info"),
d=z.querySelector("#sound_cont");a.addEventListener("click",$a);b.addEventListener("click",$a);d.addEventListener("click",yb);z.style.display="block";e.style.display="block";b.style.display="block";document.querySelector("#content");fa=z.scrollHeight;va()}function yb(){var a=z.querySelector("#sound_cont");"active"==a.className?(a.className="",n.mute(null,!0)):(a.className="active",n.mute(null,!1))}function $a(){var a=document.querySelector("#background_color");window.removeEventListener("resize",
va);l.hide_object(ma);l.hide_object(na);z.parentNode.removeChild(z);a.parentNode.removeChild(a);a=l.get_object_by_dupli_name("red_square","clock_spk");n.stop(a);n.stop(T);n.play_def(a);n.play_def(T);b.set_speed(g,-1);b.set_behavior(g,b.AB_FINISH_STOP);b.play(g,Za)}function Za(){b.apply(L,"opening_rockets_box_Action");b.set_first_frame(L);b.set_behavior(L,b.AB_FINISH_STOP);b.play(L,zb)}function zb(){b.apply(u,"bm_13_Armature_rotate_-20_Action");b.set_first_frame(u);b.set_behavior(u,b.AB_FINISH_STOP);
b.play(u,Ab)}function Ab(){k.removeEventListener("mousedown",C);k.removeEventListener("touchstart",C);k.removeEventListener("mousemove",X);k.removeEventListener("touchmove",X);k.removeEventListener("mouseup",P);k.removeEventListener("touchend",P);document.removeEventListener("mouseout",P);k.addEventListener("mousedown",C);k.addEventListener("touchstart",C);k.addEventListener("mousemove",X);k.addEventListener("touchmove",X);k.addEventListener("mouseup",P);k.addEventListener("touchend",P);document.addEventListener("mouseout",
P);aa=1}var b=e("animation"),p=e("app"),Oa=e("camera"),db=e("config"),R=e("constraints");e("controls");var eb=e("data"),ta=e("lights"),Ba=e("main"),Y=e("mouse"),J=e("objects"),l=e("scenes"),n=e("sfx"),F=e("time"),m=e("transform"),h=e("tsr"),I=e("util"),Q=e("quat"),v=e("vec3"),D=[],Wa=[[255,255,0],[255,0,148],[0,255,0],[0,0,255],[161,0,255],[255,255,255],[94,255,255]],xa=new Float32Array(8),Ma=new Float32Array(8),ya=new Float32Array(8),za=new Float32Array(8),Ua=new Float32Array(8),sb=new Float32Array(8),
tb=new Float32Array(8),Aa=new Float32Array(3),Fa=new Float32Array(3),La=new Float32Array(3),Z=new Float32Array(3),Pa=new Float32Array(3),ua=new Float32Array(3),Qa=new Float32Array(3),oa=new Float32Array([0,0,0]),ob=new Float32Array([0,0,1]);new Float32Array([0,-1.2,0]);var qb=new Float32Array(4),ra=new Float32Array(4),Na=new Float32Array(4),rb=new Float32Array(4),V=null,Sa=null,u=null,la=null,k=null,g=null,Ra=null,K=null,B=null,r=null,ka=null,ba=null,ca=null,sa=null,da=null,H=null,Ga=null,Ha=null,
T=null,Ia=null,N=null,O=null,Ja=null,Ka=null,G=null,ma=null,L=null,na=null,pa=null,ga=null,z=null,W=null,wa=null,ha=null,fa=0,q=null,ja=!1,ia=!1,qa=!1,S="",aa=0,ea=0,t=0,Ta=null;ab.init=function(){p.init({canvas_container_id:"main_canvas_container",callback:bb,alpha:!1,report_init_failure:!0,console_verbose:!0,show_fps:!1})}});b4w.require("victory_day_2015_main").init();
