var b4w=typeof b4w==="object"?b4w:function(exports){var _module={};exports.module=_module;var _ns_requires={};exports.cleanup=function(module_id,ns){ns=ns||"__b4w_default";var mod=_module[module_id];if(mod)mod._compiled=null;_ns_requires[ns]=null};exports.register=function(module_id,fun){if(_module[module_id])return;_module[module_id]=fun};exports.require=require;function require(module_id,ns){var mod=_module[module_id];if(!mod)throw new Error('Module "'+module_id+'" not found');ns=ns||"__b4w_default";
if(!_ns_requires[ns])_ns_requires[ns]=function(ns){return function(module_id){var mod=_module[module_id];if(!mod)throw new Error('Module "'+module_id+'" not found');if(!mod._compiled)mod._compiled={};if(!mod._compiled[ns]){mod._compiled[ns]={};mod(mod._compiled[ns],_ns_requires[ns])}return mod._compiled[ns]}}(ns);return _ns_requires[ns](module_id)}exports.module_check=function(module_id){if(_module[module_id])return true;else return false};exports.get_namespace=function(mod_ns_require){for(var ns in _ns_requires)if(_ns_requires[ns]==
mod_ns_require)return ns;return""};exports.worker_listeners=[];exports.worker_namespaces=[];return exports}({});if(typeof module=="object"&&module.exports)GLOBAL.b4w={module:{}};
b4w.module["__version"]=function(exports,require){var TYPE="RELEASE";var DATE=new Date(2016,5-1,31,15,25,45);var VERSION=[16,5];exports.version=version;function version(){if(TYPE=="DEBUG"){var d=date();return[parseInt(String(d.getFullYear()).slice(-2)),d.getMonth()+1]}else return VERSION}exports.version_str=function(){var str="";var ver=version();for(var i=0;i<ver.length;i++){if(i==1)str+=ver[i]<10?"0"+ver[i]:ver[i];else str+=ver[i];if(i!=ver.length-1)str+="."}return str};exports.type=function(){return TYPE};
exports.date=date;function date(){if(TYPE=="DEBUG")return new Date;else return DATE}exports.date_str=date_str;function date_str(){var d=date();var day=d.getDate();day=day<10?"0"+String(day):String(day);var month=d.getMonth()+1;month=month<10?"0"+String(month):String(month);var year=String(d.getFullYear());var hour=d.getHours();hour=hour<10?"0"+String(hour):String(hour);var minute=d.getMinutes();minute=minute<10?"0"+String(minute):String(minute);var second=d.getSeconds();second=second<10?"0"+String(second):
String(second);var date_str=day+"."+month+"."+year+" "+hour+":"+minute+":"+second;return date_str}exports.timestamp=function(){var ts=date_str();ts=ts.split(" ").join("").split(":").join("").split(".").join("");ts="?t="+ts;return ts}};if(typeof module=="object"&&module.exports)b4w.module["__version"](exports);b4w.module["__config"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");exports.P_LOW=1;exports.P_HIGH=2;exports.P_ULTRA=3;exports.P_CUSTOM=4;exports.context={alpha:true,antialias:false,premultipliedAlpha:true};exports.context_save=m_util.clone_object_r(exports.context);exports.defaults={alpha_sort:true,alpha_sort_threshold:.1,min_format_version:[5,7],max_fps:1E4,console_verbose:false,do_not_load_resources:false,use_min50:false,fps_measurement_interval:1.5,fps_callback_interval:10,
background_color:[0,0,0,0],canvas_resolution_factor:1,texture_min_filter:3,allow_cors:false,force_low_quality_nodes:false,anisotropic_filtering:true,show_hud_debug_info:false,depth_textures:true,shadows:true,stereo:"NONE",reflections:true,refractions:true,ssao:true,dof:true,god_rays:true,bloom:true,motion_blur:true,compositing:true,antialiasing:true,smaa:false,debug_view:false,water_wireframe_debug:false,foam:true,parallax:true,dynamic_grass:true,procedural_fog:true,water_dynamic:true,shore_smoothing:true,
shore_distance:true,max_texture_size:1024,max_cube_map_size:512,use_dds:true,precision:"highp",quality:exports.P_HIGH,allow_vertex_textures:true,no_phy_interp_hack:false,shader_constants_hack:false,disable_blend_shadows_hack:false,vert_anim_mix_normals_hack:false,is_mobile_device:false,disable_doppler_hack:false,init_wa_context_hack:false,clear_procedural_sky_hack:false,sky_update_hack:false,seq_video_fallback:false,allow_hidpi:false,firefox_shadows_slink_hack:false,mobile_firefox_media_hack:false,
enable_selectable:true,enable_outlining:true,glow_materials:true,max_vertex_uniform_vectors:128,ie11_edge_touchscreen_hack:false,macos_tex_reuse_hack:false,loaded_data_version:[0,0],edge_min_tex_size_hack:false,quality_aa_method:true,amd_skinning_hack:false,url_params:null,webgl2:true,msaa_samples:4,safari_canvas_alpha_hack:false,resize_cubemap_canvas_hack:false,chrome_html_bkg_music_hack:false,media_auto_activation:true,max_cast_lamps:4,mac_os_shadow_hack:false,allow_shaders_debug_ext:false,gl_debug:false,
gamepad_setting_cont:""};exports.defaults_save=m_util.clone_object_r(exports.defaults);exports.animation={framerate:-1,frames_blending_hack:false,frame_steps:1};exports.controls={mouse_wheel_notch_multiplier:1/120};exports.assets={dir:"ASSETS=../../assets/",max_requests:15,prevent_caching:true,min50_available:false,dds_available:false};exports.assets_save=m_util.clone_object_r(exports.assets);exports.paths={shaders_dir:"",shaders_include_dir:"include/",shaders_postp_dir:"postprocessing/",built_in_data_module:"built_in_data",
js_src_search_paths:["b4w.min.js","b4w.full.min.js","b4w.simple.min.js","b4w.whitespace.min.js","src/b4w.js","USER_DEFINED_MODULE"],resources_dir:"./",smaa_search_texture_path:"",smaa_area_texture_path:""};exports.hmd_params={"webvr":{distortion_coefs:[.22,.28],chromatic_aberration_coefs:[-.015,.02,.025,.02]},"nonwebvr":{inter_lens_dist:.064,base_line_dist:.035,screen_to_lens_dist:.039,distortion_coefs:[.34,.55],chromatic_aberration_coefs:[0,0,0,0],width_dist:.11,height_dist:.062,bevel_size:.004}};
exports.physics={enabled:true,max_fps:60,uranium_path:"",calc_fps:false,ping:false,use_workers:true};exports.physics_save=m_util.clone_object_r(exports.physics);exports.scenes={grass_tex_size:2*512,cubemap_tex_size:384,cube_reflect_low:32,cube_reflect_medium:128,cube_reflect_high:256,plane_reflect_low:.25,plane_reflect_medium:.5,plane_reflect_high:1};exports.scenes_save=m_util.clone_object_r(exports.scenes);exports.sfx={webaudio:true,mix_mode:false,audio_loading_hack:false,clamp_playback_rate_hack:false,
disable_playback_rate_hack:false};exports.sfx_save=m_util.clone_object_r(exports.sfx);exports.outlining={outlining_overview_mode:false,outline_color:[1,.4,.05],outline_duration:.2,outline_period:3.8,outline_relapses:1};exports.debug_subs={enabled:false,subs_type:"COPY",subs_number:0,slink_type:"COLOR"};exports.debug_subs_save=m_util.clone_object_r(exports.debug_subs);exports.apply_quality=function(){var cfg_def=exports.defaults;var cfg_phy=exports.physics;var cfg_scs=exports.scenes;switch(cfg_def.quality){case exports.P_ULTRA:cfg_def.shadows=
true,cfg_def.shore_smoothing=true,cfg_def.ssao=true;cfg_def.dof=true;cfg_def.god_rays=true;cfg_def.bloom=true;cfg_def.reflections=true;cfg_def.refractions=true;cfg_def.foam=true;cfg_def.parallax=true;cfg_def.dynamic_grass=true;cfg_def.procedural_fog=true;cfg_scs.grass_tex_size=4*512;cfg_def.texture_min_filter=3;cfg_def.anisotropic_filtering=true;cfg_def.use_min50=false;cfg_def.precision="highp";cfg_def.water_dynamic=true;cfg_def.shore_distance=true;cfg_def.antialiasing=true;cfg_def.smaa=false;cfg_def.compositing=
true;cfg_def.motion_blur=true;cfg_def.allow_hidpi=true;cfg_def.enable_outlining=true;cfg_def.glow_materials=true;cfg_def.msaa_samples=16;cfg_phy.max_fps=120;break;case exports.P_HIGH:cfg_def.shadows=true;cfg_def.shore_smoothing=true;cfg_def.ssao=true;cfg_def.dof=true;cfg_def.god_rays=true;cfg_def.bloom=true;cfg_def.reflections=true;cfg_def.refractions=true;cfg_def.foam=true;cfg_def.parallax=true;cfg_def.dynamic_grass=true;cfg_def.procedural_fog=true;cfg_scs.grass_tex_size=2*512;cfg_def.texture_min_filter=
3;cfg_def.anisotropic_filtering=true;cfg_def.use_min50=false;cfg_def.precision="highp";cfg_def.water_dynamic=true;cfg_def.shore_distance=true;cfg_def.antialiasing=true;cfg_def.smaa=false;cfg_def.compositing=true;cfg_def.motion_blur=true;cfg_def.allow_hidpi=false;cfg_def.enable_outlining=true;cfg_def.glow_materials=true;cfg_def.msaa_samples=4;cfg_phy.max_fps=60;break;case exports.P_LOW:cfg_def.shadows=false;cfg_def.shore_smoothing=false;cfg_def.ssao=false;cfg_def.dof=false;cfg_def.god_rays=false;cfg_def.bloom=
false;cfg_def.reflections=false;cfg_def.refractions=false;cfg_def.foam=false;cfg_def.parallax=false;cfg_def.dynamic_grass=false;cfg_def.procedural_fog=false;cfg_scs.grass_tex_size=1*512;cfg_def.texture_min_filter=2;cfg_def.anisotropic_filtering=false;cfg_def.use_min50=true;cfg_def.precision="mediump";cfg_def.water_dynamic=false;cfg_def.shore_distance=false;cfg_def.antialiasing=false;cfg_def.smaa=false;cfg_def.compositing=false;cfg_def.motion_blur=false;cfg_def.allow_hidpi=false;cfg_def.enable_outlining=
false;cfg_def.glow_materials=false;cfg_def.msaa_samples=1;cfg_phy.max_fps=60;break}};exports.set=set;function set(prop,value){switch(prop){case "allow_cors":exports.defaults.allow_cors=value;break;case "allow_hidpi":exports.defaults.allow_hidpi=value;break;case "alpha":exports.context.alpha=value;break;case "alpha_sort":exports.defaults.alpha_sort=value;break;case "alpha_sort_threshold":exports.defaults.alpha_sort_threshold=value;break;case "anaglyph_use":m_print.error_deprecated_cfg("anaglyph_use",
"stereo");exports.defaults.stereo=value?"ANAGLYPH":exports.defaults.stereo;break;case "animation_framerate":exports.animation.framerate=value;break;case "antialiasing":exports.defaults.antialiasing=value;break;case "assets_dds_available":exports.assets.dds_available=value;break;case "assets_min50_available":exports.assets.min50_available=value;break;case "audio":exports.sfx.webaudio=value;break;case "background_color":exports.defaults.background_color=value;break;case "built_in_module_name":exports.paths.built_in_data_module=
value;break;case "canvas_resolution_factor":exports.defaults.canvas_resolution_factor=value;break;case "console_verbose":exports.defaults.console_verbose=value;break;case "do_not_load_resources":exports.defaults.do_not_load_resources=value;break;case "gamepad_setting_cont":exports.defaults.gamepad_setting_cont=value;break;case "stereo":exports.defaults.stereo=value;break;case "media_auto_activation":exports.defaults.media_auto_activation=value;break;case "physics_enabled":exports.physics.enabled=
value;break;case "physics_uranium_path":exports.physics.uranium_path=value;break;case "physics_calc_fps":exports.physics.calc_fps=value;break;case "physics_use_workers":exports.physics.use_workers=value;break;case "precision":exports.defaults.precision=value;break;case "prevent_caching":exports.assets.prevent_caching=value;break;case "quality":exports.defaults.quality=value;break;case "sfx_mix_mode":exports.sfx.mix_mode=value;break;case "shaders_dir":exports.paths.shaders_dir=value;break;case "show_hud_debug_info":exports.defaults.show_hud_debug_info=
value;break;case "smaa":exports.defaults.smaa=value;break;case "smaa_search_texture_path":exports.paths.smaa_search_texture_path=value;break;case "smaa_area_texture_path":exports.paths.smaa_area_texture_path=value;break;case "debug_view":exports.defaults.debug_view=value;break;case "enable_selectable":exports.defaults.enable_selectable=value;break;case "enable_outlining":exports.defaults.enable_outlining=value;break;case "outlining_overview_mode":exports.outlining.outlining_overview_mode=value;break;
case "glow_materials":exports.defaults.glow_materials=value;break;case "url_params":exports.defaults.url_params=value;break;case "gl_debug":exports.defaults.gl_debug=value;break;default:m_print.error("Unknown config property: "+prop);break}}exports.get=function(prop){switch(prop){case "allow_cors":return exports.defaults.allow_cors;case "allow_hidpi":return exports.defaults.allow_hidpi;case "alpha":return exports.context.alpha;case "alpha_sort":return exports.defaults.alpha_sort;case "alpha_sort_threshold":return exports.defaults.alpha_sort_threshold;
case "anaglyph_use":return exports.defaults.stereo=="ANAGLYPH";case "animation_framerate":return exports.animation.framerate;case "antialiasing":return exports.defaults.antialiasing;case "assets_dds_available":return exports.assets.dds_available;case "assets_min50_available":return exports.assets.min50_available;case "audio":return exports.sfx.webaudio;case "background_color":return exports.defaults.background_color;case "built_in_module_name":return exports.paths.built_in_data_module;case "canvas_resolution_factor":return exports.defaults.canvas_resolution_factor;
case "console_verbose":return exports.defaults.console_verbose;case "do_not_load_resources":return exports.defaults.do_not_load_resources;case "gamepad_setting_cont":return exports.defaults.gamepad_setting_cont;case "is_mobile_device":return exports.defaults.is_mobile_device;case "stereo":return exports.defaults.stereo;case "media_auto_activation":return exports.defaults.media_auto_activation;case "physics_enabled":return exports.physics.enabled;case "physics_uranium_path":return exports.physics.uranium_path;
case "physics_calc_fps":return exports.physics.calc_fps;case "physics_use_workers":return exports.physics.use_workers;case "precision":return exports.defaults.precision;case "prevent_caching":return exports.assets.prevent_caching;case "quality":return exports.defaults.quality;case "sfx_mix_mode":return exports.sfx.mix_mode;case "shaders_dir":return exports.paths.shaders_dir;case "show_hud_debug_info":return exports.defaults.show_hud_debug_info;case "smaa":return exports.defaults.smaa;case "smaa_search_texture_path":return exports.paths.smaa_search_texture_path;
case "smaa_area_texture_path":return exports.paths.smaa_area_texture_path;case "debug_view":return exports.defaults.debug_view;case "enable_selectable":return exports.defaults.enable_selectable;case "enable_outlining":return exports.defaults.enable_outlining;case "outlining_overview_mode":return exports.outlining.outlining_overview_mode;case "glow_materials":return exports.defaults.glow_materials;case "url_params":return exports.defaults.url_params;case "gl_debug":return exports.defaults.gl_debug;
default:m_print.error("Unknown config property: "+prop);break}};exports.reset=function(){exports.context=m_util.clone_object_r(exports.context_save);exports.defaults=m_util.clone_object_r(exports.defaults_save);exports.assets=m_util.clone_object_r(exports.assets_save);exports.physics=m_util.clone_object_r(exports.physics_save);exports.scenes=m_util.clone_object_r(exports.scenes_save);exports.sfx=m_util.clone_object_r(exports.sfx_save);exports.debug_subs=m_util.clone_object_r(exports.debug_subs_save)};
exports.is_built_in_data=is_built_in_data;function is_built_in_data(){return b4w.module_check(exports.paths.built_in_data_module)}exports.set_paths=function(){var cfg_pth=exports.paths;var cfg_phy=exports.physics;if(!is_built_in_data()&&cfg_pth.shaders_dir=="")cfg_pth.shaders_dir=js_src_dir()+"../shaders/";if(is_built_in_data()){cfg_pth.smaa_search_texture_path="smaa_search_texture.png";cfg_pth.smaa_area_texture_path="smaa_area_texture.png"}else if(cfg_pth.smaa_search_texture_path==""||cfg_pth.smaa_area_texture_path==
""){var resources_dir=js_src_dir()+cfg_pth.resources_dir;cfg_pth.smaa_search_texture_path=cfg_pth.smaa_search_texture_path||resources_dir+"smaa_search_texture.png";cfg_pth.smaa_area_texture_path=cfg_pth.smaa_area_texture_path||resources_dir+"smaa_area_texture.png"}if(cfg_phy.enabled&&cfg_phy.uranium_path==""){var resources_dir=js_src_dir()+cfg_pth.resources_dir;cfg_phy.uranium_path=resources_dir+"uranium.js"}};function js_src_dir(){var cfg_pth=exports.paths;var src_path=null;var scripts=document.getElementsByTagName("script");
for(var i=0;i<scripts.length;i++){var src=scripts[i].src;for(var j=0;j<cfg_pth.js_src_search_paths.length;j++){var script_path=cfg_pth.js_src_search_paths[j];if(src.indexOf(script_path)>=0){src_path=src;break}}if(src_path!==null)break}if(!src_path){m_print.warn("Couldn't determine path to ancillary resources, "+"fallback to the current page directory");src_path=document.location.href}var index=src_path.indexOf("?");if(index>=0)src_path=src_path.substring(0,index);return src_path.substring(0,src_path.lastIndexOf("/")+
1)}exports.get_std_assets_path=function(){return exports.assets.dir.replace("ASSETS=","")}};b4w.module["__anchors"]=function(exports,require){var m_batch=require("__batch");var m_cam=require("__camera");var m_cont=require("__container");var m_obj=require("__objects");var m_print=require("__print");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_time=require("__time");var m_tsr=require("__tsr");var _anchors=[];var _is_paused=false;var _clicked_elem=null;var _in_use=false;var _is_anim=false;var _anchor_batch_pos=new Float32Array(0);var _pixels=new Uint8Array(16);
var _vec2_tmp=new Float32Array(2);var _vec3_tmp=new Float32Array(3);exports.append=function(obj){if(has_anchor_obj(obj))return;var det_vis=obj.anchor.detect_visibility&&Boolean(m_scenes.get_subs(m_scenes.get_main(),"ANCHOR_VISIBILITY"));var anchor={type:obj.anchor.type,obj:obj,x:0,y:0,depth:0,appearance:"out",detect_visibility:det_vis,element:null,move_cb:null,annotation_max_width:obj.anchor.max_width,annotation_height:0,annotation_width:0,element_id:obj.anchor.element_id};switch(anchor.type){case "ANNOTATION":anchor.element=
create_annotation(obj,anchor.annotation_max_width);anchor.annotation_height=anchor.element.offsetHeight;anchor.annotation_width=anchor.element.offsetWidth;break;case "ELEMENT":anchor.element=document.getElementById(obj.anchor.element_id);if(anchor.element){anchor.annotation_height=anchor.element.offsetHeight;anchor.annotation_width=anchor.element.offsetWidth}else{m_print.warn("Anchor HTML element was not found, making it generic");anchor.type="GENERIC"}break;case "GENERIC":break}_anchors.push(anchor);
resize_anchor_batch_pos();if(!_in_use)add_click_listener()};function add_click_listener(){_in_use=true;var canvas_cont=m_cont.get_container();canvas_cont.addEventListener("mouseup",function(e){if(_is_anim)return;if(_is_paused)return;var anchor_cont=_clicked_elem;if(!anchor_cont)return;if(anchor_cont.lastElementChild.style.visibility=="visible"){close_descr();_clicked_elem=null;return}if(anchor_cont.style.opacity!=1)return;var anchor_descr=anchor_cont.lastElementChild;var descr_body=anchor_descr.firstElementChild;
var body_text=descr_body.innerHTML;anchor_descr.style.visibility="visible";var descr_width=Math.min(parseInt(anchor_descr.style.width)||200,str_width(body_text)-24);var descr_height=str_height(body_text,descr_width);var width_anim=false;var height_anim=false;var parent_width=anchor_cont.offsetWidth-24;var parent_height=anchor_cont.offsetHeight-16;if(descr_height==parent_height)anchor_descr.style.height=descr_height+"px";if(descr_width!=parent_width){width_anim=true;_is_anim=true;m_time.animate(parent_width,
descr_width,200,function(e){if(e==descr_width){width_anim=false;if(!height_anim)_is_anim=false;if(is_anim)descr_body.style.visibility="visible"}anchor_descr.style.width=e+"px"})}else width_anim=false;if(descr_height!=parent_height){height_anim=true;_is_anim=true;m_time.animate(parent_height,descr_height,200,function(e){if(e==descr_height){height_anim=false;if(!width_anim)_is_anim=false;if(is_anim)descr_body.style.visibility="visible"}anchor_descr.style.height=e+"px"})}else height_anim=false;function is_anim(){return anchor_descr.style.visibility==
"visible"&&!width_anim&&!height_anim}})}function has_anchor_obj(obj){for(var i=0;i<_anchors.length;i++)if(_anchors[i].obj==obj)return true;return false}function close_descr(){var last_child=_clicked_elem.lastElementChild;last_child.style.visibility="hidden";last_child.firstElementChild.style.visibility="hidden"}function create_annotation(obj,max_width){var anchor_cont=document.createElement("div");var anchor_title_elem=document.createElement("span");var anchor_desc="";var anchor_title=obj.name;var canvas_cont=
m_cont.get_container();var meta_tags=m_obj.get_meta_tags(obj);add_cont_style(anchor_cont);anchor_cont.style.visibility="hidden";canvas_cont.appendChild(anchor_cont);if(meta_tags){anchor_desc=meta_tags.description||anchor_desc;anchor_title=meta_tags.title||anchor_title}anchor_title_elem.innerHTML=anchor_title;add_noselect_style(anchor_title_elem);add_inner_style(anchor_title_elem);anchor_cont.appendChild(anchor_title_elem);if(anchor_desc)create_anchor_descr_elem(anchor_desc,anchor_cont,max_width);
return anchor_cont}function add_cont_style(elem){elem.style.cssText+="background-color:   #000;"+"border-radius:      20px 20px 20px 0px;"+"box-shadow:         0px 0px 10px rgb(180, 180, 200);"+"-webkit-box-shadow: 0px 0px 10px rgb(180, 180, 200);"+"font-size:          12px;"+"line-height:        15px;"+"opacity:            1.0;"+"padding:            8px 12px;"+"position:           absolute;"}function add_inner_style(elem){elem.style.cssText+="color:       #fff;"+"font-family: Arial;"+"font-size:   12px;"+
"font-weight: bold;"+"line-height: 15px;"}function add_descr_style(elem){elem.style.cssText+="background-color:   #000;"+"border-radius:      20px 20px 20px 0px;"+"bottom:             0;"+"box-shadow:         0px 0px 10px rgb(180, 180, 200);"+"-webkit-box-shadow: 0px 0px 10px rgb(180, 180, 200);"+"font-size:          12px;"+"left:               0;"+"line-height:        15px;"+"opacity:            1.0;"+"overflow:           hidden;"+"padding:            8px 12px;"+"position:           absolute;"+"z-index:            2;"}
function add_noselect_style(elem){elem.style.cssText+="-webkit-touch-callout: none;"+"-webkit-user-select:   none;"+"-khtml-user-select:    none;"+"-moz-user-select:      none;"+"-ms-user-select:       none;"+"user-select:           none;"+"cursor:                default;"}function create_anchor_descr_elem(anchor_desc,anchor_cont,max_width){var desc_elem=document.createElement("div");var desc_body_elem=document.createElement("span");if(max_width)desc_elem.style.width=max_width+"px";add_descr_style(desc_elem);
add_inner_style(desc_body_elem);desc_body_elem.innerHTML=anchor_desc;desc_elem.style.visibility="hidden";desc_body_elem.style.visibility="hidden";desc_elem.appendChild(desc_body_elem);anchor_cont.appendChild(desc_elem);anchor_cont.addEventListener("mousedown",function(e){if(_is_anim)return;if(anchor_cont==_clicked_elem)return;if(anchor_cont.style.opacity!=1)return;if(_is_paused)return;if(_clicked_elem&&_clicked_elem.lastElementChild.style.visibility=="visible")close_descr();_clicked_elem=anchor_cont})}
function str_width(str){var descr=document.createElement("div");var descr_body=document.createElement("span");descr_body.innerHTML=str;add_inner_style(descr_body);add_descr_style(descr);descr.appendChild(descr_body);document.body.appendChild(descr);var width=descr.offsetWidth+1;document.body.removeChild(descr);return width}function str_height(str,width){var descr=document.createElement("div");var descr_body=document.createElement("span");descr_body.innerHTML=str;add_inner_style(descr_body);add_descr_style(descr);
descr.style.width=width+"px";descr.style.display="inline-block";descr.appendChild(descr_body);document.body.appendChild(descr);var height=descr.offsetHeight-16;document.body.removeChild(descr);return height}function resize_anchor_batch_pos(){var num=0;for(var i=0;i<_anchors.length;i++)if(_anchors[i].detect_visibility)num++;_anchor_batch_pos=new Float32Array(3*num)}exports.remove=function(obj){for(var i=0;i<_anchors.length;i++){var anchor=_anchors[i];if(anchor.obj==obj){if(anchor.type=="ANNOTATION")remove_annotation(anchor);
_anchors.splice(i,1);resize_anchor_batch_pos();i--;break}}};function sort_anchors_zindex(a,b){return b.depth-a.depth}exports.update=function(){var det_vis_cnt=0;for(var i=_anchors.length;i--;){var anchor=_anchors[i];if(anchor.detect_visibility){var trans=m_tsr.get_trans_view(anchor.obj.render.world_tsr);_anchor_batch_pos.set(trans,3*det_vis_cnt++)}var pp=anchor_project(anchor,_vec3_tmp);var x=pp[0];var y=pp[1];var depth=pp[2];if(x==anchor.x&&y==anchor.y&&depth==anchor.depth)continue;switch(anchor.type){case "ANNOTATION":var element=
anchor.element;element.style.left=Math.floor(x)+"px";element.style.top=Math.floor(y-anchor.annotation_height)+"px";break;case "ELEMENT":var element=anchor.element;var bounding_box=element.getBoundingClientRect();element.style.cssText+="left:"+Math.floor(x-bounding_box.width/2)+"px;"+"top:"+Math.floor(y-bounding_box.height/2)+"px;";break;case "GENERIC":break}anchor.x=x;anchor.y=y;anchor.depth=depth;if(anchor.move_cb)anchor.move_cb(x,y,anchor.appearance,anchor.obj,element)}_anchors.sort(sort_anchors_zindex);
for(var i=0;i<_anchors.length;i++){var anchor=_anchors[i];if(anchor.type!="GENERIC")anchor.element.style.zIndex=i}if(det_vis_cnt>0){var subs_anchor=m_scenes.get_subs(m_scenes.get_main(),"ANCHOR_VISIBILITY");var batch_anchor=subs_anchor.bundles[0].batch;m_batch.update_anchor_visibility_batch(batch_anchor,_anchor_batch_pos)}};function anchor_project(anchor,dest){var camobj=m_scenes.get_camera(m_scenes.get_main());var trans=m_tsr.get_trans_view(anchor.obj.render.world_tsr);var dest=m_cam.project_point(camobj,
trans,dest);return dest}exports.update_visibility=function(){var canvas_cont=m_cont.get_container();for(var i=_anchors.length;i--;){var anchor=_anchors[i];var obj=anchor.obj;var x=anchor.x;var y=anchor.y;var depth=anchor.depth;if(x<0||y<0||depth<0||depth>1||m_scenes.is_hidden(obj)||x>=canvas_cont.clientWidth||y>=canvas_cont.clientHeight)var appearance="out";else var appearance="visible";if(anchor.detect_visibility&&appearance!="out")appearance=pick_anchor_visibility(anchor);if(appearance==anchor.appearance)continue;
switch(anchor.type){case "ANNOTATION":case "ELEMENT":var element=anchor.element;if(!element)break;if(appearance=="out"){element.style.visibility="hidden";if(element.children.length)element.children[0].style.visibility="hidden"}else if(appearance=="visible"){element.style.visibility="visible";if(element.children.length)element.children[0].style.visibility="visible";element.style.opacity=1}else{element.style.visibility="visible";element.style.opacity=.1;if(element.children.length)element.children[0].style.visibility=
"visible";if(anchor.type=="ANNOTATION"&&element.children.length>1){var child=element.children[1];child.style.visibility="hidden";if(child.children.length)child.children[0].style.visibility="hidden"}}break;case "GENERIC":break}anchor.appearance=appearance;if(anchor.move_cb)anchor.move_cb(x,y,anchor.appearance,obj,element)}};function pick_anchor_visibility(anchor){var subs_anchor=m_scenes.get_subs(m_scenes.get_main(),"ANCHOR_VISIBILITY");var anchor_cam=subs_anchor.camera;var viewport_xy=m_cont.canvas_to_viewport_coords(anchor.x,
anchor.y,_vec2_tmp,anchor_cam);m_render.read_pixels(anchor_cam.framebuffer,viewport_xy[0],anchor_cam.height-viewport_xy[1],2,2,_pixels);if(_pixels[0]+_pixels[4]+_pixels[8]+_pixels[12]==4*255)return"visible";else if(anchor.appearance=="out"||_pixels[0]+_pixels[4]+_pixels[8]+_pixels[12]==0)return"covered";else return anchor.appearance}exports.attach_move_cb=function(obj,callback){for(var i=0;i<_anchors.length;i++)if(_anchors[i].obj==obj)_anchors[i].move_cb=callback};exports.detach_move_cb=function(obj){for(var i=
0;i<_anchors.length;i++)if(_anchors[i].obj==obj)_anchors[i].move_cb=null};function remove_annotation(anchor){var canvas_cont=m_cont.get_container();canvas_cont.removeChild(anchor.element)}exports.cleanup=function(){for(var i=0;i<_anchors.length;i++){var anchor=_anchors[i];if(anchor.type=="ANNOTATION")remove_annotation(anchor)}_anchors.length=0};exports.is_anchor=function(obj){for(var i=0;i<_anchors.length;i++)if(_anchors[i].obj==obj)return true;return false};exports.get_element_id=function(obj){for(var i=
0;i<_anchors.length;i++)if(_anchors[i].obj==obj)return _anchors[i].element_id;return false};exports.pause=function(){_is_paused=true};exports.resume=function(){_is_paused=false};exports.pick_anchor=function(x,y){var index=-1;for(var i=0;i<_anchors.length;i++)if(_anchors[i].appearance=="visible"&&check_anchor_coords(_anchors[i],x,y))if(index<0){var min_dist=_anchors[i].depth;index=i}else if(_anchors[i].depth<min_dist){index=i;min_dist=_anchors[i].depth}if(index<0)return null;else return _anchors[index].obj};
function check_anchor_coords(anchor,x,y){var width=Math.round(anchor.annotation_width);var height=Math.round(anchor.annotation_height);var a_x=anchor.x;var a_y=anchor.y;if(x>=a_x&&x<=a_x+width&&y<a_y&&y>=a_y-height)return true;else return false}};b4w.module["__armature"]=function(exports,require){var m_util=require("__util");var m_tsr=require("__tsr");var m_quat=require("__quat");var m_mat4=require("__mat4");var m_vec3=require("__vec3");var _tsr_tmp=m_tsr.create();var _tsr_tmp2=m_tsr.create();var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);function init_bone_pointer(){var bone_ptr={bone_index:0,vgroup_index:-1,parent_bone_ptr:null,descend_bones_ptrs:[],chain:[],constraint:null,tsr_bone_rest:m_tsr.create(),
tsr_bone_pose:m_tsr.create(),tsr_local_rest:m_tsr.create(),tsr_local_pose:m_tsr.create(),tsr_basis:m_tsr.create(),tsr_channel_cache:m_tsr.create(),tsr_channel_cache_valid:false,tail:new Float32Array(3)};return bone_ptr}exports.update_object=update_object;function update_object(bpy_armobj,armobj){var arm_bones=bpy_armobj["data"]["bones"];var pose_bones=bpy_armobj["pose"]["bones"];var bone_pointers={};for(var i=0;i<pose_bones.length;i++){var pose_bone=pose_bones[i];var arm_bone=pose_bone["bone"];var bone_name=
arm_bone["name"];var bpointer=bone_pointers[bone_name]=init_bone_pointer();var mat_loc=new Float32Array(arm_bone["matrix_local"]);var mat_loc_inv=new Float32Array(16);m_mat4.invert(mat_loc,mat_loc_inv);var mat_bas=new Float32Array(pose_bone["matrix_basis"]);var tail=bpointer.tail;m_vec3.subtract(arm_bone["tail_local"],arm_bone["head_local"],tail);m_util.vecdir_multiply_matrix(tail,mat_loc_inv,tail);m_tsr.from_mat4(mat_loc,bpointer.tsr_local_rest);m_tsr.from_mat4(mat_bas,bpointer.tsr_basis);m_tsr.copy(bpointer.tsr_local_rest,
bpointer.tsr_local_pose)}for(var i=0;i<arm_bones.length;i++){var bone=arm_bones[i];var bone_name=bone["name"];var pose_bone=m_util.keysearch("name",bone_name,pose_bones);var bpointer=bone_pointers[bone_name];var parent_pose_bones=pose_bone["parent_recursive"];bpointer.chain.push(bpointer);for(var j=0;j<parent_pose_bones.length;j++){var parent_bone=parent_pose_bones[j];var parent_bone_name=parent_bone["name"];var parent_bone_ptr=bone_pointers[parent_bone_name];bpointer.chain.push(parent_bone_ptr)}if(parent_pose_bones.length){var parent_bone=
parent_pose_bones[0];var parent_bone_name=parent_bone["name"];var parent_bone_ptr=bone_pointers[parent_bone_name];bpointer.parent_bone_ptr=parent_bone_ptr;m_tsr.invert(parent_bone_ptr.tsr_local_rest,_tsr_tmp);m_tsr.multiply(_tsr_tmp,bpointer.tsr_local_rest,bpointer.tsr_bone_rest);parent_bone_ptr.descend_bones_ptrs.push(bpointer)}else m_tsr.copy(bpointer.tsr_local_rest,bpointer.tsr_bone_rest);bpointer.bone_index=i;bpointer.name=bone_name;m_tsr.multiply(bpointer.tsr_bone_rest,bpointer.tsr_basis,bpointer.tsr_bone_pose)}armobj.render.bone_pointers=
bone_pointers}exports.get_bone_tsr=function(armobj,bone_name,get_pose_tail,use_bone_space,dest_tsr){var render=armobj.render;var frame_factor=render.frame_factor;var bone_pointer=render.bone_pointers[bone_name];var index=bone_pointer.bone_index;var tsr_local=bone_pointer.tsr_local_rest;var transcale=_vec4_tmp;var trans_before=render.trans_before;var trans_after=render.trans_after;var quats_before=render.quats_before;var quats_after=render.quats_after;var x=trans_before[4*index];var y=trans_before[4*
index+1];var z=trans_before[4*index+2];var s=trans_before[4*index+3];var xn=trans_after[4*index];var yn=trans_after[4*index+1];var zn=trans_after[4*index+2];var sn=trans_after[4*index+3];transcale[0]=(1-frame_factor)*x+frame_factor*xn;transcale[1]=(1-frame_factor)*y+frame_factor*yn;transcale[2]=(1-frame_factor)*z+frame_factor*zn;transcale[3]=(1-frame_factor)*s+frame_factor*sn;var quat=_quat4_tmp;var quatn=_quat4_tmp2;quat[0]=quats_before[4*index];quat[1]=quats_before[4*index+1];quat[2]=quats_before[4*
index+2];quat[3]=quats_before[4*index+3];quatn[0]=quats_after[4*index];quatn[1]=quats_after[4*index+1];quatn[2]=quats_after[4*index+2];quatn[3]=quats_after[4*index+3];m_quat.slerp(quat,quatn,frame_factor,quat);var tsr_bone=_tsr_tmp;m_tsr.set_transcale(transcale,tsr_bone);m_tsr.set_quat(quat,tsr_bone);if(get_pose_tail){var tsr_local_tail=_tsr_tmp2;m_tsr.translate(tsr_local,bone_pointer.tail,tsr_local_tail);m_tsr.multiply(tsr_bone,tsr_local_tail,tsr_bone)}else m_tsr.multiply(tsr_bone,tsr_local,tsr_bone);
if(use_bone_space){var parent_bone_ptr=bone_pointer.parent_bone_ptr;if(parent_bone_ptr){var tsr_par_local=parent_bone_ptr.tsr_local_pose;var inv_tsr_par_local=_tsr_tmp2;m_tsr.invert(tsr_par_local,inv_tsr_par_local);m_tsr.multiply(inv_tsr_par_local,tsr_bone,tsr_bone)}var tsr_bone_rest=bone_pointer.tsr_bone_rest;var inv_tsr_bone_rest=_tsr_tmp2;m_tsr.invert(tsr_bone_rest,inv_tsr_bone_rest);m_tsr.multiply(inv_tsr_bone_rest,tsr_bone,tsr_bone)}m_tsr.copy(tsr_bone,dest_tsr)};exports.set_bone_tsr=function(armobj,
bone_name,tsr,use_bone_space){var render=armobj.render;var bone_pointer=render.bone_pointers[bone_name];var trans_before=render.trans_before;var quats_before=render.quats_before;if(use_bone_space)m_tsr.multiply(bone_pointer.tsr_bone_rest,tsr,bone_pointer.tsr_bone_pose);else m_tsr.copy(tsr,bone_pointer.tsr_local_pose);update_bone_tsr_r(bone_pointer,use_bone_space,trans_before,quats_before);render.frame_factor=0;update_skinned_renders(armobj)};exports.update_skinned_renders=update_skinned_renders;function update_skinned_renders(armobj){var render=
armobj.render;var skinned_renders=render.skinned_renders;var bone_maps=render.mesh_to_arm_bone_maps;for(var i=0;i<skinned_renders.length;i++){var skinned_render=skinned_renders[i];var bone_map=bone_maps[i];for(var j=0;j<bone_map.length;j+=2){var sk_ind=bone_map[j];var arm_ind=bone_map[j+1];for(var k=0;k<4;k++){skinned_render.quats_before[sk_ind+k]=render.quats_before[arm_ind+k];skinned_render.quats_after[sk_ind+k]=render.quats_after[arm_ind+k];skinned_render.trans_before[sk_ind+k]=render.trans_before[arm_ind+
k];skinned_render.trans_after[sk_ind+k]=render.trans_after[arm_ind+k]}}skinned_render.frame_factor=render.frame_factor}}exports.update_bone_tsr_r=update_bone_tsr_r;function update_bone_tsr_r(bone_pointer,use_bone_space,trans,quats){var tsr_bone_pose=bone_pointer.tsr_bone_pose;var tsr_local_rest=bone_pointer.tsr_local_rest;var tsr_local_pose=bone_pointer.tsr_local_pose;var parent_bone_ptr=bone_pointer.parent_bone_ptr;if(parent_bone_ptr){var tsr_par_local=parent_bone_ptr.tsr_local_pose;if(use_bone_space)m_tsr.multiply(tsr_par_local,
tsr_bone_pose,tsr_local_pose);else{var inv_tsr_par_local=_tsr_tmp2;m_tsr.invert(tsr_par_local,inv_tsr_par_local);m_tsr.multiply(inv_tsr_par_local,tsr_local_pose,tsr_bone_pose)}}else if(use_bone_space)m_tsr.copy(tsr_bone_pose,tsr_local_pose);else m_tsr.copy(tsr_local_pose,tsr_bone_pose);var dest_tsr=_tsr_tmp;m_tsr.invert(tsr_local_rest,dest_tsr);m_tsr.multiply(tsr_local_pose,dest_tsr,dest_tsr);var index=bone_pointer.bone_index;trans[4*index]=dest_tsr[0];trans[4*index+1]=dest_tsr[1];trans[4*index+2]=
dest_tsr[2];trans[4*index+3]=dest_tsr[3];quats[4*index]=dest_tsr[4];quats[4*index+1]=dest_tsr[5];quats[4*index+2]=dest_tsr[6];quats[4*index+3]=dest_tsr[7];var descend_ptrs=bone_pointer.descend_bones_ptrs;for(var i=0;i<descend_ptrs.length;i++){var desc_bone_ptr=descend_ptrs[i];if(desc_bone_ptr.constraint)continue;update_bone_tsr_r(desc_bone_ptr,true,trans,quats)}}exports.check_bone=function(armobj,bone_name){return bone_name in armobj.render.bone_pointers}};b4w.module["__boundings"]=function(exports,require){var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_math=require("__math");var m_mat3=require("__mat3");var m_quat=require("__quat");var _bb_corners_cache=new Float32Array(3*8);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _vec3_tmp4=new Float32Array(3);var _mat3_tmp=new Float32Array(9);var _mat3_tmp2=new Float32Array(9);var _mat3_tmp3=new Float32Array(9);
var _mat3_tmp4=new Float32Array(9);var ELL_EPS=1E-9;var MATRIX_PRES=5E-4;var MIN_SEMIAXIS_LEN=1E-8;exports.copy_bb=function(bb_from,bb_to){bb_to.min_x=bb_from.min_x;bb_to.max_x=bb_from.max_x;bb_to.min_y=bb_from.min_y;bb_to.max_y=bb_from.max_y;bb_to.min_z=bb_from.min_z;bb_to.max_z=bb_from.max_z};exports.big_bounding_box=function(){return{max_x:1E12,min_x:-1E12,max_y:1E12,min_y:-1E12,max_z:1E12,min_z:-1E12}};exports.zero_bounding_box=function(dest){if(!dest)dest={};dest.max_x=0;dest.min_x=0;dest.max_y=
0;dest.min_y=0;dest.max_z=0;dest.min_z=0;return dest};exports.calc_min_bb_side=function(bb){var min=bb.max_x-bb.min_x;var y_size=bb.max_y-bb.min_y;if(y_size<min)min=y_size;var z_size=bb.max_z-bb.min_z;if(z_size<min)min=z_size;return min};exports.expand_bounding_box=function(bb,bb_exp){var max_x=bb.max_x;var max_y=bb.max_y;var max_z=bb.max_z;var min_x=bb.min_x;var min_y=bb.min_y;var min_z=bb.min_z;bb.max_x=Math.max(bb_exp.max_x,max_x);bb.max_y=Math.max(bb_exp.max_y,max_y);bb.max_z=Math.max(bb_exp.max_z,
max_z);bb.min_x=Math.min(bb_exp.min_x,min_x);bb.min_y=Math.min(bb_exp.min_y,min_y);bb.min_z=Math.min(bb_exp.min_z,min_z);return bb};exports.bb_from_coords=bb_from_coords;function bb_from_coords(coords,bb){var max_x=coords[0];var max_y=coords[1];var max_z=coords[2];var min_x=coords[0];var min_y=coords[1];var min_z=coords[2];for(var i=3;i<coords.length;i+=3){var x=coords[i];var y=coords[i+1];var z=coords[i+2];max_x=Math.max(max_x,x);max_y=Math.max(max_y,y);max_z=Math.max(max_z,z);min_x=Math.min(min_x,
x);min_y=Math.min(min_y,y);min_z=Math.min(min_z,z)}bb.max_x=max_x;bb.max_y=max_y;bb.max_z=max_z;bb.min_x=min_x;bb.min_y=min_y;bb.min_z=min_z;return bb}exports.bounding_box_transform=function(bb,tsr,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var bb_corners=extract_bb_corners(bb,_bb_corners_cache);m_tsr.transform_vectors(bb_corners,tsr,bb_corners);return bb_from_coords(bb_corners,bb_new)};exports.extract_bb_corners=extract_bb_corners;function extract_bb_corners(bb,dest){if(!dest)var dest=
new Float32Array(3*8);var max_x=bb.max_x;var max_y=bb.max_y;var max_z=bb.max_z;var min_x=bb.min_x;var min_y=bb.min_y;var min_z=bb.min_z;dest[0]=min_x;dest[1]=min_y;dest[2]=min_z;dest[3]=max_x;dest[4]=min_y;dest[5]=min_z;dest[6]=max_x;dest[7]=max_y;dest[8]=min_z;dest[9]=min_x;dest[10]=max_y;dest[11]=min_z;dest[12]=min_x;dest[13]=min_y;dest[14]=max_z;dest[15]=max_x;dest[16]=min_y;dest[17]=max_z;dest[18]=max_x;dest[19]=max_y;dest[20]=max_z;dest[21]=min_x;dest[22]=max_y;dest[23]=max_z;return dest}exports.shrink_bounding_box=
function(bb,bb_shrink,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var s_min_x=bb_shrink.min_x;var s_max_x=bb_shrink.max_x;var s_min_y=bb_shrink.min_y;var s_max_y=bb_shrink.max_y;var s_min_z=bb_shrink.min_z;var s_max_z=bb_shrink.max_z;if(s_min_x>=bb.max_x||s_max_x<=bb.min_x||s_min_y>=bb.max_y||s_max_y<=bb.min_y||s_min_z>=bb.max_z||s_max_z<=bb.min_z){bb_new.min_x=-.1;bb_new.max_x=.1;bb_new.min_y=-.1;bb_new.max_y=.1;bb_new.min_z=-.2;bb_new.max_z=-.1;return bb_new}bb_new.min_x=Math.max(bb.min_x,
s_min_x);bb_new.max_x=Math.min(bb.max_x,s_max_x);bb_new.min_y=Math.max(bb.min_y,s_min_y);bb_new.max_y=Math.min(bb.max_y,s_max_y);bb_new.min_z=Math.max(bb.min_z,s_min_z);bb_new.max_z=Math.min(bb.max_z,s_max_z);return bb_new};exports.stretch_bounding_box=function(bb,factor,bb_new){if(!bb_new)var bb_new=exports.zero_bounding_box();var size_x=bb.max_x-bb.min_x;var size_y=bb.max_y-bb.min_y;var size_z=bb.max_z-bb.min_z;bb_new.min_x=bb.min_x-.5*(factor-1)*size_x;bb_new.max_x=bb.max_x+.5*(factor-1)*size_x;
bb_new.min_y=bb.min_y-.5*(factor-1)*size_y;bb_new.max_y=bb.max_y+.5*(factor-1)*size_y;bb_new.min_z=bb.min_z-.5*(factor-1)*size_z;bb_new.max_z=bb.max_z+.5*(factor-1)*size_z;return bb_new};exports.bounding_sphere_transform=function(bs,tsr,bs_new){if(!bs_new)var bs_new=exports.zero_bounding_sphere();m_tsr.transform_vec3(bs.center,tsr,bs_new.center);bs_new.radius=bs.radius*m_tsr.get_scale(tsr);return bs_new};exports.bounding_ellipsoid_transform=function(be,tsr,be_new){if(!be_new)var be_new=zero_bounding_ellipsoid();
m_tsr.transform_vec3(be.center,tsr,be_new.center);m_vec3.copy(be.axis_x,be_new.axis_x);m_vec3.copy(be.axis_y,be_new.axis_y);m_vec3.copy(be.axis_z,be_new.axis_z);m_tsr.transform_dir_vec3(be_new.axis_x,tsr,be_new.axis_x);m_tsr.transform_dir_vec3(be_new.axis_y,tsr,be_new.axis_y);m_tsr.transform_dir_vec3(be_new.axis_z,tsr,be_new.axis_z);return be_new};exports.create_bounding_sphere=function(radius,center){return{radius:radius,center:new Float32Array(center)}};exports.zero_bounding_sphere=function(){return{center:new Float32Array([0,
0,0]),radius:0}};exports.zero_bounding_ellipsoid=zero_bounding_ellipsoid;function zero_bounding_ellipsoid(){return{axis_x:new Float32Array(3),axis_y:new Float32Array(3),axis_z:new Float32Array(3),center:new Float32Array([0,0,0])}}exports.create_bounding_ellipsoid=create_bounding_ellipsoid;function create_bounding_ellipsoid(axis_x,axis_y,axis_z,center,quat){return{axis_x:new Float32Array(axis_x),axis_y:new Float32Array(axis_y),axis_z:new Float32Array(axis_z),center:new Float32Array([center[0],center[1],
center[2]])}}exports.big_bounding_sphere=function(){return{center:new Float32Array([0,0,0]),radius:1E12}};exports.expand_bounding_sphere=function(bs,bs_exp){var v=m_vec3.subtract(bs_exp.center,bs.center,m_vec3.create());if(m_vec3.length(v)==0)m_vec3.set(1,0,0,v);var vn=m_vec3.normalize(v,m_vec3.create());var e1p=m_vec3.scale(vn,bs.radius,m_vec3.create());m_vec3.add(e1p,bs.center,e1p);var e1n=m_vec3.scale(vn,-bs.radius,m_vec3.create());m_vec3.add(e1n,bs.center,e1n);var e2p=m_vec3.scale(vn,bs_exp.radius,
m_vec3.create());m_vec3.add(e2p,bs_exp.center,e2p);var e2n=m_vec3.scale(vn,-bs_exp.radius,m_vec3.create());m_vec3.add(e2n,bs_exp.center,e2n);var min_max=find_min_max_extent([e1p,e1n,e2p,e2n],vn);var min=min_max[0];var max=min_max[1];bs.center=m_vec3.scale(m_vec3.add(min,max,m_vec3.create()),.5,m_vec3.create());bs.radius=m_vec3.length(m_vec3.subtract(max,min,m_vec3.create()))/2};exports.create_bounding_ellipsoid_by_bb=create_bounding_ellipsoid_by_bb;function create_bounding_ellipsoid_by_bb(points,
use_rotation){var center=m_math.calk_average_position(points,_vec3_tmp4);if(use_rotation)var cov_matrix=m_math.calc_covariance_matrix(points,center,_mat3_tmp2);else var cov_matrix=m_mat3.identity(_mat3_tmp2);var t_mat=m_math.find_eigenvectors(cov_matrix,MATRIX_PRES,_mat3_tmp);m_vec3.copy(points,_vec3_tmp);m_vec3.transformMat3(_vec3_tmp,t_mat,_vec3_tmp);var max_dot_x=_vec3_tmp[0];var min_dot_x=max_dot_x;var max_dot_y=_vec3_tmp[1];var min_dot_y=max_dot_y;var max_dot_z=_vec3_tmp[2];var min_dot_z=max_dot_z;
var max_x=0;var min_x=0;var max_y=0;var min_y=0;var max_z=0;var min_z=0;for(var i=3;i<points.length;i=i+3){_vec3_tmp[0]=points[i];_vec3_tmp[1]=points[i+1];_vec3_tmp[2]=points[i+2];m_vec3.transformMat3(_vec3_tmp,t_mat,_vec3_tmp);var dot_x=_vec3_tmp[0];var dot_y=_vec3_tmp[1];var dot_z=_vec3_tmp[2];if(dot_x>max_dot_x){max_dot_x=dot_x;max_x=i}if(dot_x<min_dot_x){min_dot_x=dot_x;min_x=i}if(dot_y>max_dot_y){max_dot_y=dot_y;max_y=i}if(dot_y<min_dot_y){min_dot_y=dot_y;min_y=i}if(dot_z>max_dot_z){max_dot_z=
dot_z;max_z=i}if(dot_z<min_dot_z){min_dot_z=dot_z;min_z=i}}var a=max_dot_x-min_dot_x;var b=max_dot_y-min_dot_y;var c=max_dot_z-min_dot_z;a=Math.max(a,ELL_EPS);b=Math.max(b,ELL_EPS);c=Math.max(c,ELL_EPS);var max_semi_axis=Math.max(a,b,c);if(max_semi_axis==a){var max_lm=max_x;var min_lm=min_x}else if(max_semi_axis==b){var max_lm=max_y;var min_lm=min_y}else{var max_lm=max_z;var min_lm=min_z}var scale_mat=m_mat3.identity(_mat3_tmp2);scale_mat[0]=a!=0?1/a:1/MIN_SEMIAXIS_LEN;scale_mat[4]=b!=0?1/b:1/MIN_SEMIAXIS_LEN;
scale_mat[8]=c!=0?1/c:1/MIN_SEMIAXIS_LEN;m_mat3.transpose(t_mat,_mat3_tmp3);_vec3_tmp[0]=points[0];_vec3_tmp[1]=points[1];_vec3_tmp[2]=points[2];m_vec3.transformMat3(_vec3_tmp,_mat3_tmp3,_vec3_tmp);m_vec3.transformMat3(_vec3_tmp,scale_mat,_vec3_tmp);m_vec3.transformMat3(_vec3_tmp,t_mat,_vec3_tmp);var max_x=_vec3_tmp[0],min_x=_vec3_tmp[0];var max_y=_vec3_tmp[1],min_y=_vec3_tmp[1];var max_z=_vec3_tmp[2],min_z=_vec3_tmp[2];for(var i=3;i<points.length;i=i+3){_vec3_tmp[0]=points[i];_vec3_tmp[1]=points[i+
1];_vec3_tmp[2]=points[i+2];m_vec3.transformMat3(_vec3_tmp,_mat3_tmp3,_vec3_tmp);m_vec3.transformMat3(_vec3_tmp,scale_mat,_vec3_tmp);m_vec3.transformMat3(_vec3_tmp,t_mat,_vec3_tmp);max_x=Math.max(max_x,_vec3_tmp[0]);min_x=Math.min(min_x,_vec3_tmp[0]);max_y=Math.max(max_y,_vec3_tmp[1]);min_y=Math.min(min_y,_vec3_tmp[1]);max_z=Math.max(max_z,_vec3_tmp[2]);min_z=Math.min(min_z,_vec3_tmp[2])}var r=Math.sqrt((max_x-min_x)*(max_x-min_x)+(max_y-min_y)*(max_y-min_y)+(max_z-min_z)*(max_z-min_z))/2;r=Math.min(r,
1);_vec3_tmp3[0]=(max_x+min_x)/2;_vec3_tmp3[1]=(max_y+min_y)/2;_vec3_tmp3[2]=(max_z+min_z)/2;var s_center=_vec3_tmp3;var scale_mat=m_mat3.identity(_mat3_tmp2);scale_mat[0]=a;scale_mat[4]=b;scale_mat[8]=c;m_vec3.transformMat3(s_center,_mat3_tmp3,s_center);m_vec3.transformMat3(s_center,scale_mat,s_center);m_vec3.transformMat3(s_center,t_mat,s_center);var axis_x=[t_mat[0],t_mat[3],t_mat[6]];var axis_y=[t_mat[1],t_mat[4],t_mat[7]];var axis_z=[t_mat[2],t_mat[5],t_mat[8]];m_vec3.scale(axis_x,a*r,axis_x);
m_vec3.scale(axis_y,b*r,axis_y);m_vec3.scale(axis_z,c*r,axis_z);return create_bounding_ellipsoid(axis_x,axis_y,axis_z,s_center)}exports.calc_be_local_by_tsr=function(be_world,world_tsr){var be_local=m_util.clone_object_r(be_world);var trans=m_tsr.get_trans_value(world_tsr,_vec3_tmp4);m_vec3.subtract(be_local.center,trans,be_local.center);return be_local};function find_min_max_extent(exts,dir){var dir_n=m_vec3.normalize(dir,m_vec3.create());var min=exts[0];var max=exts[0];for(var i=1;i<exts.length;i++){var proj=
m_vec3.dot(exts[i],dir_n);if(proj<m_vec3.dot(min,dir_n))min=exts[i];if(proj>m_vec3.dot(max,dir_n))max=exts[i]}return[min,max]}exports.create_bounding_capsule=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y-2*radius);var bcap_local={radius:radius,height:height,center:new Float32Array([0,(max_y+min_y)/2,0])};return bcap_local};exports.create_bounding_cylinder=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=
bounding_box.min_y;var height=Math.max(0,max_y-min_y);var bcyl_local={radius:radius,height:height,center:new Float32Array([0,(max_y+min_y)/2,0])};return bcyl_local};exports.create_bounding_cone=function(radius,bounding_box){var max_y=bounding_box.max_y;var min_y=bounding_box.min_y;var height=Math.max(0,max_y-min_y);var bcon_local={radius:radius,height:height,center:new Float32Array([0,(max_y+min_y)/2,0])};return bcon_local};exports.check_bb_intersection=function(bb1,bb2){if(bb1.min_x>bb2.max_x||bb1.max_x<
bb2.min_x)return false;else if(bb1.min_y>bb2.max_y||bb1.max_y<bb2.min_y)return false;else if(bb1.min_z>bb2.max_z||bb1.max_z<bb2.min_z)return false;else return true};exports.recalculate_mesh_boundings=function(mesh){var max_x=0,max_y=0,max_z=0,min_x=0,min_y=0,min_z=0;var sub_max_x=0,sub_max_y=0,sub_max_z=0;var sub_min_x=0,sub_min_y=0,sub_min_z=0;var srad=0;var crad=0;for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];if(submesh["position"].length){max_x=min_x=submesh["position"][0];
max_y=min_y=submesh["position"][1];max_z=min_z=submesh["position"][2];break}}for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var positions=submesh["position"];sub_max_x=sub_min_x=submesh["position"][0];sub_max_y=sub_min_y=submesh["position"][1];sub_max_z=sub_min_z=submesh["position"][2];for(var j=0;j<positions.length/3;j++){var x=positions[3*j];var y=positions[3*j+1];var z=positions[3*j+2];max_x=Math.max(x,max_x);max_y=Math.max(y,max_y);max_z=Math.max(z,max_z);min_x=Math.min(x,
min_x);min_y=Math.min(y,min_y);min_z=Math.min(z,min_z);sub_max_x=Math.max(x,sub_max_x);sub_max_y=Math.max(y,sub_max_y);sub_max_z=Math.max(z,sub_max_z);sub_min_x=Math.min(x,sub_min_x);sub_min_y=Math.min(y,sub_min_y);sub_min_z=Math.min(z,sub_min_z);srad=Math.max(Math.sqrt(x*x+y*y+z*z),srad);crad=Math.max(Math.sqrt(x*x+z*z),crad)}var sub_bb=submesh["boundings"]["bounding_box"];sub_bb["max_x"]=sub_max_x;sub_bb["min_x"]=sub_min_x;sub_bb["max_y"]=sub_max_y;sub_bb["min_y"]=sub_min_y;sub_bb["max_z"]=sub_max_z;
sub_bb["min_z"]=sub_min_z;var bb_points=_bb_corners_cache;bb_points[0]=sub_min_x;bb_points[1]=sub_min_y;bb_points[2]=sub_min_z;bb_points[3]=sub_max_x;bb_points[4]=sub_min_y;bb_points[5]=sub_min_z;bb_points[6]=sub_max_x;bb_points[7]=sub_max_y;bb_points[8]=sub_min_z;bb_points[9]=sub_min_x;bb_points[10]=sub_max_y;bb_points[11]=sub_min_z;bb_points[12]=sub_min_x;bb_points[13]=sub_min_y;bb_points[14]=sub_max_z;bb_points[15]=sub_max_x;bb_points[16]=sub_min_y;bb_points[17]=sub_max_z;bb_points[18]=sub_max_x;
bb_points[19]=sub_max_y;bb_points[20]=sub_max_z;bb_points[21]=sub_min_x;bb_points[22]=sub_max_y;bb_points[23]=sub_max_z;var be_local=create_bounding_ellipsoid_by_bb(bb_points,false);submesh["boundings"]["bounding_ellipsoid_center"]=be_local.center;submesh["boundings"]["bounding_ellipsoid_axes"]=[be_local.axis_x[0],be_local.axis_y[1],be_local.axis_z[2]]}mesh["b4w_bounding_box"]["max_x"]=max_x;mesh["b4w_bounding_box"]["min_x"]=min_x;mesh["b4w_bounding_box"]["max_y"]=max_y;mesh["b4w_bounding_box"]["min_y"]=
min_y;mesh["b4w_bounding_box"]["max_z"]=max_z;mesh["b4w_bounding_box"]["min_z"]=min_z;mesh["b4w_bounding_box_source"]["max_x"]=max_x;mesh["b4w_bounding_box_source"]["min_x"]=min_x;mesh["b4w_bounding_box_source"]["max_y"]=max_y;mesh["b4w_bounding_box_source"]["min_y"]=min_y;mesh["b4w_bounding_box_source"]["max_z"]=max_z;mesh["b4w_bounding_box_source"]["min_z"]=min_z;mesh["b4w_bounding_sphere_radius"]=srad;mesh["b4w_bounding_cylinder_radius"]=crad;var bb_points=_bb_corners_cache;bb_points[0]=min_x;
bb_points[1]=min_y;bb_points[2]=min_z;bb_points[3]=max_x;bb_points[4]=min_y;bb_points[5]=min_z;bb_points[6]=max_x;bb_points[7]=max_y;bb_points[8]=min_z;bb_points[9]=min_x;bb_points[10]=max_y;bb_points[11]=min_z;bb_points[12]=min_x;bb_points[13]=min_y;bb_points[14]=max_z;bb_points[15]=max_x;bb_points[16]=min_y;bb_points[17]=max_z;bb_points[18]=max_x;bb_points[19]=max_y;bb_points[20]=max_z;bb_points[21]=min_x;bb_points[22]=max_y;bb_points[23]=max_z;var be_local=create_bounding_ellipsoid_by_bb(bb_points,
false);mesh["b4w_bounding_ellipsoid_center"]=be_local.center;mesh["b4w_bounding_ellipsoid_axes"]=[be_local.axis_x[0],be_local.axis_y[1],be_local.axis_z[2]]};exports.get_frustum_mec=function(corners){var p0=corners.subarray(0,3);var p1=corners.subarray(6,9);var p2=corners.subarray(12,15);var p3=corners.subarray(18,21);var l=m_vec3.subtract(p1,p0,_vec3_tmp);m_vec3.normalize(l,l);var normal=m_util.get_plane_normal(p0,p1,p2,_vec3_tmp2);var m=m_vec3.cross(normal,l,normal);m_vec3.normalize(m,m);var q0=
m_vec3.create();var q1=m_vec3.create();m_vec3.subtract(p1,p0,_vec3_tmp3);q1[0]=m_vec3.dot(_vec3_tmp3,l);q1[1]=m_vec3.dot(_vec3_tmp3,m);var q2=m_vec3.create();m_vec3.subtract(p2,p0,_vec3_tmp3);q2[0]=m_vec3.dot(_vec3_tmp3,l);q2[1]=m_vec3.dot(_vec3_tmp3,m);var q3=m_vec3.create();m_vec3.subtract(p3,p0,_vec3_tmp3);q3[0]=m_vec3.dot(_vec3_tmp3,l);q3[1]=m_vec3.dot(_vec3_tmp3,m);var bs=exports.zero_bounding_sphere();bs=get_mec_2d([q0,q1,q2,q3],bs);var center_origin=m_vec3.scale(l,bs.center[0],_vec3_tmp3);
m_vec3.scaleAndAdd(center_origin,m,bs.center[1],center_origin);m_vec3.add(center_origin,p0,bs.center);return bs};function get_mec_2d(points,bs){bs=mec_by_2_points(bs,points[0],points[1]);for(var i=2;i<points.length;i++)if(m_vec3.distance(bs.center,points[i])>bs.radius)bs=mec_step1(bs,points,points[i],i-1);return bs}function mec_step1(bs,points,q,points_range){bs=mec_by_2_points(bs,q,points[0]);for(var i=1;i<=points_range;i++)if(m_vec3.distance(bs.center,points[i])>bs.radius)bs=mec_step2(bs,points,
q,points[i],i-1);return bs}function mec_step2(bs,points,q0,q1,points_range){bs=mec_by_2_points(bs,q0,q1);for(var i=0;i<=points_range;i++)if(m_vec3.distance(bs.center,points[i])>bs.radius)bs=mec_by_3_points(bs,q0,q1,points[i]);return bs}function mec_by_2_points(bs,A,B){m_vec3.add(A,B,bs.center);m_vec3.scale(bs.center,.5,bs.center);bs.radius=m_vec3.distance(bs.center,A);return bs}function mec_by_3_points(bs,A,B,C){var BC=m_vec3.subtract(B,C,_vec3_tmp3);var a_sq=m_vec3.squaredLength(BC);var AC=m_vec3.subtract(A,
C,_vec3_tmp3);var b_sq=m_vec3.squaredLength(AC);var AB=m_vec3.subtract(A,B,_vec3_tmp3);var c_sq=m_vec3.squaredLength(AB);var a_coeff=a_sq*(b_sq+c_sq-a_sq);var b_coeff=b_sq*(c_sq+a_sq-b_sq);var c_coeff=c_sq*(a_sq+b_sq-c_sq);var sum=a_coeff+b_coeff+c_coeff;m_vec3.copy(A,bs.center);m_vec3.scale(bs.center,a_coeff/sum,bs.center);m_vec3.scaleAndAdd(bs.center,B,b_coeff/sum,bs.center);m_vec3.scaleAndAdd(bs.center,C,c_coeff/sum,bs.center);bs.radius=m_vec3.distance(bs.center,A);return bs}};b4w.module["__compat"]=function(exports,require){var m_cfg=require("__config");var m_debug=require("__debug");var m_ext=require("__extensions");var m_print=require("__print");var MIN_VARYINGS_REQUIRED=10;var MIN_FRAGMENT_UNIFORMS_SUPPORTED=128;var AMD_MESA_RENDER_NAMES=["R600","RV610","RV630","RV620","RV635","RV670","RS780","RS880","RV770","RV730","RV710","RV740","CEDAR","REDWOOD","JUNIPER","CYPRESS","PALM (Wrestler/Ontario)","SUMO (Llano)","SUMO2 (Llano)","ARUBA (Trinity/Richland)","BARTS","TURKS",
"CAICOS","CAYMAN"];exports.NVIDIA_OLD_GPU_CUBEMAP_MAX_SIZE=256;var cfg_anim=m_cfg.animation;var cfg_def=m_cfg.defaults;var cfg_ctx=m_cfg.context;var cfg_scs=m_cfg.scenes;var cfg_sfx=m_cfg.sfx;var cfg_phy=m_cfg.physics;exports.detect_tegra_invalid_enum_issue=function(gl){if(gl.getError()==gl.INVALID_ENUM)m_print.warn("Possible Tegra invalid enum issue detected, ignoring")};exports.set_hardware_defaults=function(gl){cfg_def.max_vertex_uniform_vectors=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS);cfg_def.max_texture_size=
gl.getParameter(gl.MAX_TEXTURE_SIZE);cfg_def.max_cube_map_size=gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE);if(!cfg_def.webgl2)cfg_def.msaa_samples=1;else cfg_def.msaa_samples=Math.min(cfg_def.msaa_samples,gl.getParameter(gl.MAX_SAMPLES));if(cfg_def.webgl2&&m_debug.check_multisample_issue())cfg_def.msaa_samples=1;var depth_tex_available=Boolean(m_ext.get_depth_texture());if(check_user_agent("Firefox/28.0")&&(check_user_agent("Linux")||check_user_agent("Macintosh"))){m_print.warn("Firefox 28 detected, applying depth hack");
depth_tex_available=false}if(!check_user_agent("Windows Phone"))if(check_user_agent("iPad")||check_user_agent("iPhone")){m_print.warn("iOS detected, applying alpha hack, applying vertex "+"animation mix normals hack, disable smaa. Disable ssao "+"for performance. Disable video textures. Initialize "+"WebAudio context with empty sound.");if(!cfg_ctx.alpha)cfg_def.background_color[3]=1;cfg_def.vert_anim_mix_normals_hack=true;cfg_def.smaa=false;cfg_def.ssao=false;cfg_def.precision="highp";cfg_def.init_wa_context_hack=
true;cfg_scs.cubemap_tex_size=256}else if(check_user_agent("Mac OS X")&&check_user_agent("Safari")&&!check_user_agent("Chrome")){m_print.warn("OS X / Safari detected, force to wait complete loading. "+"Applying playback rate hack for video textures. "+"Applying canvas alpha hack.");cfg_def.safari_canvas_alpha_hack=true;cfg_sfx.audio_loading_hack=true;cfg_sfx.clamp_playback_rate_hack=true}if(check_user_agent("Windows")&&(check_user_agent("Chrome/40")||check_user_agent("Firefox/33")||check_user_agent("Firefox/34")||
check_user_agent("Firefox/35")||check_user_agent("Firefox/36"))){m_print.warn("Windows/Chrome40 or Firefox33-36 detected. Applying clear procedural skydome hack.");cfg_def.clear_procedural_sky_hack=true}if(check_user_agent("Chrome")&&!detect_mobile()&&m_cfg.is_built_in_data()){m_print.warn("Chrome (non-mobile) was detected for a single HTML-exported "+'file. "Background Music" speakers were changed to "Background Sound".');cfg_def.chrome_html_bkg_music_hack=true}if(check_user_agent("Mac OS X")){cfg_def.mac_os_shadow_hack=
true;m_print.warn("OS X detected, applying shadows hack.")}if(detect_mobile()){m_print.warn("Mobile detected, applying various hacks for video textures.");cfg_def.is_mobile_device=true;if(!(check_user_agent("iPad")||check_user_agent("iPhone"))&&!check_user_agent("Windows Phone")){m_print.warn("Mobile (not iOS) detected, disable playback rate for video textures.");cfg_sfx.disable_playback_rate_hack=true}}if((check_user_agent("Firefox/35.0")||check_user_agent("Firefox/36.0"))&&check_user_agent("Windows")){m_print.warn("Windows/Firefox 35/36 detected, applying shadows slink hack");
cfg_def.firefox_shadows_slink_hack=true}if(check_user_agent("iPhone")||is_ie11()||check_user_agent("Edge")){m_print.warn("iPhone, IE11 or Edge detected. Enable sequential video fallback for video textures.");cfg_def.seq_video_fallback=true}if(gl.getParameter(gl.MAX_VARYING_VECTORS)<MIN_VARYINGS_REQUIRED){m_print.warn("Not enough varyings, disable shadows on blend objects");cfg_def.disable_blend_shadows_hack=true}if(check_user_agent("Windows Phone")){m_print.warn("Windows Phone detected. Disable debug view mode, "+
"glow materials, ssao, smaa, shadows, reflections, refractions.");cfg_def.debug_view=false;cfg_def.precision="highp";cfg_def.glow_materials=false;cfg_def.ssao=false;cfg_def.smaa=false;cfg_def.shadows=false;cfg_def.reflections=false;cfg_def.refractions=false;cfg_def.quality_aa_method=false}if(check_user_agent("UCBrowser")||check_user_agent("Firefox")&&cfg_def.is_mobile_device){m_print.warn("Mobile Firefox detected, disable workers.");cfg_phy.use_workers=false}var rinfo=m_ext.get_renderer_info();if(rinfo){var vendor=
gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL);var renderer=gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL);var mali_4x_re=/\b4\d{2}\b/;if(check_user_agent("Macintosh")&&renderer.indexOf("Intel HD Graphics 3000")>-1){m_print.warn("OS X / Intel HD 3000 detected, applying depth hack");depth_tex_available=false}if(vendor.indexOf("ARM")>-1&&mali_4x_re.test(renderer)){m_print.warn("ARM Mali-400 series detected, applying depth and frames blending hacks");depth_tex_available=false;cfg_anim.frames_blending_hack=
true}if(vendor.indexOf("ARM")>-1&&renderer.indexOf("Mali-T604")>-1){m_print.warn('ARM Mali-T604 detected, set "highp" precision and disable shadows.');cfg_def.precision="highp";cfg_def.shadows=false}if(vendor.indexOf("ARM")>-1&&renderer.indexOf("Mali-T760")>-1){m_print.warn('ARM Mali-T760 detected, set "highp" precision and disable SSAO.');cfg_def.precision="highp";cfg_def.ssao=false;cfg_def.amd_skinning_hack=true}if(vendor.indexOf("Qualcomm")>-1&&renderer.indexOf("Adreno")>-1){m_print.warn("Qualcomm Adreno detected, applying shader constants hack.");
cfg_def.shader_constants_hack=true;if(renderer.indexOf("305")>-1){m_print.warn('Qualcomm Adreno305 detected, set "highp" precision.');cfg_def.precision="highp"}if(renderer.indexOf("330")>-1){m_print.warn('Qualcomm Adreno330 detected, set "highp" precision.');cfg_def.precision="highp"}if(renderer.indexOf("420")>-1){m_print.warn("Qualcomm Adreno420 detected, setting max cubemap size to 4096, "+"setting max texture size to 4096.");cfg_def.max_texture_size=4096;cfg_def.max_cube_map_size=4096}}if(vendor.indexOf("NVIDIA")>
-1&&renderer.indexOf("Tegra 3")>-1){m_print.warn("NVIDIA Tegra 3 detected, force low quality for "+"B4W_LEVELS_OF_QUALITY nodes.");cfg_def.force_low_quality_nodes=true}if(check_user_agent("Windows")&&check_user_agent("Chrome")&&!check_user_agent("Edge")&&(renderer.match(/NVIDIA GeForce 8..0/)||renderer.match(/NVIDIA GeForce 9..0/)||renderer.match(/NVIDIA GeForce( (G|GT|GTS|GTX))? 2../))){m_print.warn("Chrome / Windows / NVIDIA GeForce 8/9/200 series detected, "+"setting max cubemap size to 256, use canvas for resizing.");
cfg_def.max_cube_map_size=exports.NVIDIA_OLD_GPU_CUBEMAP_MAX_SIZE;cfg_def.resize_cubemap_canvas_hack=true}var architecture="";for(var i=0;i<AMD_MESA_RENDER_NAMES.length;i++)if(renderer.indexOf(AMD_MESA_RENDER_NAMES[i])>-1){architecture=AMD_MESA_RENDER_NAMES[i];break}if(architecture){m_print.warn("Architecture "+architecture+" detected. Blending between frames"+" and shadows on blend objects will be disabled.");cfg_def.amd_skinning_hack=true;cfg_def.disable_blend_shadows_hack=true}}if(gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)==
0){m_print.warn("Vertex textures are not allowed. Disabling vertex textures");cfg_def.allow_vertex_textures=false}if(!depth_tex_available){cfg_def.foam=false;cfg_def.parallax=false;cfg_def.dynamic_grass=false;cfg_def.water_dynamic=false;cfg_def.shore_smoothing=false;cfg_def.shore_distance=false;cfg_def.smaa=false}cfg_def.use_dds=Boolean(m_ext.get_s3tc());cfg_def.depth_tex_available=depth_tex_available;if(gl.getShaderPrecisionFormat)var high=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.HIGH_FLOAT);
if(!gl.getShaderPrecisionFormat||high.precision===0)cfg_def.precision="mediump";if(is_ie11()){m_print.warn("IE11 detected. Set sky cubemap texture size to 512 (power of two).");cfg_scs.cubemap_tex_size=512}if(is_ie11()&&check_user_agent("Touch")||check_user_agent("Edge")){m_print.warn("IE11 and touchscreen or Edge detected. Behaviour of the mouse move sensor will be changed.");cfg_def.ie11_edge_touchscreen_hack=true}if(gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS)<=MIN_FRAGMENT_UNIFORMS_SUPPORTED){m_print.warn("Not enough fragment uniforms, force low quality for "+
"B4W_LEVELS_OF_QUALITY nodes.");cfg_def.force_low_quality_nodes=true}if(check_user_agent("Chrome")&&!check_user_agent("Edge"))m_print.log("Chrome detected. Some of deprecated functions related to the Doppler effect won't be called.");if(check_user_agent("Chrome")&&!check_user_agent("Edge")||check_user_agent("Firefox"))cfg_def.disable_doppler_hack=true;if(detect_mobile()&&check_user_agent("Firefox")){m_print.log("Mobile firefox detected. Applying autoplay media hack.");cfg_def.mobile_firefox_media_hack=
true}if(check_user_agent("Edge")){m_print.warn("Microsoft Edge detected, set up new minimal texture size.");cfg_def.edge_min_tex_size_hack=true}if(check_user_agent("SamsungBrowser")){m_print.warn("Default Android browser detected, setting max cubemap size to 1024, "+"setting max texture size to 1024.");cfg_def.max_texture_size=1024;cfg_def.max_cube_map_size=1024}};exports.check_user_agent=check_user_agent;function check_user_agent(str){var user_agent=navigator.userAgent;if(user_agent.indexOf(str)>
-1)return true;else return false}exports.detect_mobile=detect_mobile;function detect_mobile(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)}exports.apply_context_alpha_hack=function(){if(check_user_agent("Firefox/35.0")&&check_user_agent("Windows")){m_print.warn("Windows/Firefox 35 detected, forcing context's alpha");
m_cfg.context.alpha=true}};exports.is_ie11=is_ie11;function is_ie11(){return!window.ActiveXObject&&"ActiveXObject"in window}};b4w.module["__constraints"]=function(exports,require){var m_armat=require("__armature");var m_cam=require("__camera");var m_mat3=require("__mat3");var m_print=require("__print");var m_quat=require("__quat");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var CONS_TYPE_STIFF_OBJ=1;var CONS_TYPE_STIFF_BONE=2;var CONS_TYPE_TRACK_OBJ=3;var CONS_TYPE_TRACK_POINT=4;var CONS_TYPE_FOLLOW_OBJ=5;var CONS_TYPE_FOLLOW_POINT=6;var CONS_TYPE_STIFF_TRANS_OBJ=7;var CONS_TYPE_COPY_TRANS_OBJ=
8;var CONS_TYPE_SEMI_STIFF_OBJ=9;var CONS_TYPE_SEMI_STIFF_CAM_OBJ=10;var CONS_TYPE_CHILD_OF=11;var CONS_TYPE_CHILD_OF_BONE=12;var CONS_TYPE_SEMI_SOFT_CAM_OBJ=13;var CONS_TYPE_STIFF_TRANS_ROT_OBJ=14;var CONS_TYPE_STIFF_VIEWPORT=15;var BONE_CONS_TYPE_STIFF_OBJ=1;exports.CONS_TYPE_STIFF_OBJ=CONS_TYPE_STIFF_OBJ;exports.CONS_TYPE_STIFF_BONE=CONS_TYPE_STIFF_BONE;exports.CONS_TYPE_TRACK_OBJ=CONS_TYPE_TRACK_OBJ;exports.CONS_TYPE_TRACK_POINT=CONS_TYPE_TRACK_POINT;exports.CONS_TYPE_FOLLOW_OBJ=CONS_TYPE_FOLLOW_OBJ;
exports.CONS_TYPE_FOLLOW_POINT=CONS_TYPE_FOLLOW_POINT;exports.CONS_TYPE_STIFF_TRANS_OBJ=CONS_TYPE_STIFF_TRANS_OBJ;exports.CONS_TYPE_COPY_TRANS_OBJ=CONS_TYPE_COPY_TRANS_OBJ;exports.CONS_TYPE_SEMI_STIFF_OBJ=CONS_TYPE_SEMI_STIFF_OBJ;exports.CONS_TYPE_SEMI_STIFF_CAM_OBJ=CONS_TYPE_SEMI_STIFF_CAM_OBJ;exports.CONS_TYPE_CHILD_OF=CONS_TYPE_CHILD_OF;exports.CONS_TYPE_CHILD_OF_BONE=CONS_TYPE_CHILD_OF_BONE;exports.CONS_TYPE_SEMI_SOFT_CAM_OBJ=CONS_TYPE_SEMI_SOFT_CAM_OBJ;exports.CONS_TYPE_STIFF_TRANS_ROT_OBJ=CONS_TYPE_STIFF_TRANS_ROT_OBJ;
exports.CONS_TYPE_STIFF_VIEWPORT=CONS_TYPE_STIFF_VIEWPORT;exports.BONE_CONS_TYPE_STIFF_OBJ=BONE_CONS_TYPE_STIFF_OBJ;var _vec2_tmp=new Float32Array(2);var _vec2_tmp_2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp_2=new Float32Array(3);var _vec3_tmp_3=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _mat3_tmp2=new Float32Array(9);var _tsr_tmp=m_tsr.create();var _parent_y_axis=new Float32Array(3);exports.append_stiff_obj=
function(obj,obj_parent,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;cons.scale_offset=scale_offset;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_bone=function(obj,armobj,bone_name,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_BONE);cons.obj_parent=armobj;cons.bone_name=bone_name;cons.offset=
new Float32Array(offset);cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;cons.scale_offset=scale_offset;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_stiff_obj=function(obj,obj_parent,offset,rotation_offset){var cons=init_cons(CONS_TYPE_SEMI_STIFF_OBJ);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_quat=m_tsr.get_quat_view(obj_parent.render.world_tsr);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.parent_prev_rotation=
new Float32Array(p_quat);if(rotation_offset){m_quat.copy(rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_semi_stiff_cam_obj=function(obj,obj_parent,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down){var cons=init_cons(CONS_TYPE_SEMI_STIFF_CAM_OBJ);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_quat=m_tsr.get_quat_view(obj_parent.render.world_tsr);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);
cons.parent_prev_rotation=new Float32Array(p_quat);cons.clamp_left=m_util.angle_wrap_0_2pi(clamp_left);cons.clamp_right=m_util.angle_wrap_0_2pi(clamp_right);cons.clamp_up=m_util.angle_wrap_periodic(clamp_up,-Math.PI,Math.PI);cons.clamp_down=m_util.angle_wrap_periodic(clamp_down,-Math.PI,Math.PI);if(rotation_offset){cons.rotation_offset=new Float32Array(rotation_offset);m_quat.copy(rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else cons.rotation_offset=m_quat.create();apply_cons(obj,cons);
update_cons(obj,cons,0)};exports.append_semi_soft_cam_obj=function(obj,obj_parent,offset,softness){var cons=init_cons(CONS_TYPE_SEMI_SOFT_CAM_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.softness=softness;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_trans_rot_obj=function(obj,obj_parent,offset,rotation_offset,scale_offset){var cons=init_cons(CONS_TYPE_STIFF_TRANS_ROT_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);cons.scale_offset=
scale_offset||1;cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;apply_cons(obj,cons);update_cons(obj,cons,0)};function init_cons(type){var cons={};cons.type=type;return cons}function apply_cons(obj,cons){if(obj.constraint&&obj.constraint.obj_parent)remove_parent_descendant(obj.constraint.obj_parent,obj);if(cons.obj_parent)assign_parent_descendant(cons.obj_parent,obj);obj.constraint=cons}function assign_parent_descendant(obj_parent,obj){if(obj_parent.cons_descends.indexOf(obj)==
-1)obj_parent.cons_descends.push(obj);else throw"Descendant object override is forbidden";}exports.remove_parent_descendant=remove_parent_descendant;function remove_parent_descendant(obj_parent,obj){var ind=obj_parent.cons_descends.indexOf(obj);if(ind!=-1)obj_parent.cons_descends.splice(ind,1);else throw"No descendant object";}exports.append_track_obj=function(obj,obj_parent){var cons=init_cons(CONS_TYPE_TRACK_OBJ);cons.obj_parent=obj_parent;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_track_point=
function(obj,target){var cons=init_cons(CONS_TYPE_TRACK_POINT);cons.target=new Float32Array(target);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_follow_obj=function(obj,obj_parent,dist_min,dist_max){var cons=init_cons(CONS_TYPE_FOLLOW_OBJ);cons.obj_parent=obj_parent;cons.dist_min=dist_min;cons.dist_max=dist_max;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_follow_point=function(obj,target,dist_min,dist_max){var cons=init_cons(CONS_TYPE_FOLLOW_POINT);cons.target=new Float32Array(target);
cons.dist_min=dist_min;cons.dist_max=dist_max;apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_trans_obj=function(obj,obj_parent,offset){var cons=init_cons(CONS_TYPE_STIFF_TRANS_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_copy_trans_obj=function(obj,obj_parent,offset){var cons=init_cons(CONS_TYPE_COPY_TRANS_OBJ);cons.obj_parent=obj_parent;cons.offset=new Float32Array(offset);apply_cons(obj,cons);
update_cons(obj,cons,0)};exports.append_child_of=function(obj,obj_parent,tsr_offset){var cons=init_cons(CONS_TYPE_CHILD_OF);cons.obj_parent=obj_parent;cons.tsr_offset=new Float32Array(tsr_offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_child_of_bone=function(obj,armobj,bone_name,tsr_offset){var cons=init_cons(CONS_TYPE_CHILD_OF_BONE);cons.obj_parent=armobj;cons.bone_name=bone_name;cons.tsr_offset=new Float32Array(tsr_offset);apply_cons(obj,cons);update_cons(obj,cons,0)};exports.append_stiff_viewport=
function(obj,camobj,positioning){var cons=init_cons(CONS_TYPE_STIFF_VIEWPORT);cons.obj_parent=camobj;if(m_util.isdef(positioning.left)){cons.left_edge=true;cons.left_right_dist=positioning.left}else if(m_util.isdef(positioning.right)){cons.left_edge=false;cons.left_right_dist=positioning.right}else{m_print.error("append_stiff_viewport: Wrong positioning params");return}if(m_util.isdef(positioning.top)){cons.top_edge=true;cons.top_bottom_dist=positioning.top}else if(m_util.isdef(positioning.bottom)){cons.top_edge=
false;cons.top_bottom_dist=positioning.bottom}else{m_print.error("append_stiff_viewport: Wrong positioning params");return}if(m_util.isdef(positioning.distance))cons.distance=positioning.distance;else{m_print.error("append_stiff_viewport: Wrong positioning params");return}if(m_util.isdef(positioning.rotation))cons.rotation_offset=new Float32Array(positioning.rotation);else cons.rotation_offset=null;if(m_util.isdef(positioning.hor_units))cons.hor_units=positioning.hor_units;else cons.hor_units="widths";
if(m_util.isdef(positioning.vert_units))cons.vert_units=positioning.vert_units;else cons.vert_units="heights";apply_cons(obj,cons);update_cons(obj,cons,0)};exports.update_constraint=function(obj,elapsed){if(obj.constraint)update_cons(obj,obj.constraint,elapsed)};function update_cons(obj,cons,elapsed){switch(cons.type){case CONS_TYPE_STIFF_OBJ:var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_world_tsr=cons.obj_parent.render.world_tsr;var p_quat=m_tsr.get_quat_view(cons.obj_parent.render.world_tsr);
if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else m_quat.copy(p_quat,quat);var trans=m_tsr.transform_vec3(cons.offset,p_world_tsr,_vec3_tmp);m_tsr.set_trans(trans,obj.render.world_tsr);var p_scale=m_tsr.get_scale(cons.obj_parent.render.world_tsr);m_tsr.set_scale(cons.scale_offset*p_scale,obj.render.world_tsr);break;case CONS_TYPE_SEMI_STIFF_OBJ:var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);
var p_world_tsr=cons.obj_parent.render.world_tsr;var p_quat=m_tsr.get_quat_view(cons.obj_parent.render.world_tsr);m_quat.multiply(m_quat.invert(cons.parent_prev_rotation,cons.parent_prev_rotation),quat,quat);m_quat.multiply(p_quat,quat,quat);m_tsr.transform_vec3(cons.offset,p_world_tsr,trans);m_quat.copy(p_quat,cons.parent_prev_rotation);break;case CONS_TYPE_SEMI_STIFF_CAM_OBJ:var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_world_tsr=cons.obj_parent.render.world_tsr;
var p_quat=m_tsr.get_quat_view(cons.obj_parent.render.world_tsr);m_quat.multiply(m_quat.invert(cons.parent_prev_rotation,cons.parent_prev_rotation),quat,quat);m_quat.multiply(p_quat,quat,quat);m_tsr.transform_vec3(cons.offset,p_world_tsr,trans);m_quat.copy(p_quat,cons.parent_prev_rotation);clamp_orientation(obj,cons);break;case CONS_TYPE_SEMI_SOFT_CAM_OBJ:var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_world_tsr=cons.obj_parent.render.world_tsr;
var p_trans=m_tsr.get_trans_view(p_world_tsr);var softness=cons.softness;var trans_pivot=_vec3_tmp;var quat_pivot=_quat4_tmp;var softness_ratio=.16;m_tsr.transform_vec3(cons.offset,p_world_tsr,trans_pivot);m_util.smooth_v(trans_pivot,trans,elapsed,softness,trans);var dir_to_obj=_vec3_tmp;m_vec3.sub(p_trans,trans,dir_to_obj);m_vec3.normalize(dir_to_obj,dir_to_obj);cam_rotate_to(quat,dir_to_obj,quat_pivot);m_util.smooth_q(quat_pivot,quat,elapsed,softness*softness_ratio,quat);break;case CONS_TYPE_STIFF_BONE:var quat=
m_tsr.get_quat_view(obj.render.world_tsr);var p_tsr=_tsr_tmp;m_armat.get_bone_tsr(cons.obj_parent,cons.bone_name,true,false,p_tsr);m_tsr.multiply(cons.obj_parent.render.world_tsr,p_tsr,p_tsr);quat[0]=p_tsr[4];quat[1]=p_tsr[5];quat[2]=p_tsr[6];quat[3]=p_tsr[7];if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(quat,cons.rotation_offset,quat)}m_tsr.set_scale(cons.scale_offset*p_tsr[3],obj.render.world_tsr);var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_tsr.transform_vec3(cons.offset,
p_tsr,trans);break;case CONS_TYPE_TRACK_OBJ:var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var t_trans=m_tsr.get_trans_view(cons.obj_parent.render.world_tsr);rotate_to(trans,quat,t_trans);break;case CONS_TYPE_TRACK_POINT:var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var t_trans=cons.target;rotate_to(trans,quat,t_trans);break;case CONS_TYPE_FOLLOW_OBJ:var trans=m_tsr.get_trans_view(obj.render.world_tsr);
var quat=m_tsr.get_quat_view(obj.render.world_tsr);var t_trans=m_tsr.get_trans_view(cons.obj_parent.render.world_tsr);rotate_to(trans,quat,t_trans);var dist=m_vec3.dist(trans,t_trans);if(dist>cons.dist_max)var delta=dist-cons.dist_max;else if(dist<cons.dist_min)var delta=dist-cons.dist_min;else var delta=0;if(delta){m_vec3.sub(t_trans,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,_vec3_tmp);m_vec3.scale(_vec3_tmp,delta,_vec3_tmp);m_vec3.add(trans,_vec3_tmp,trans)}break;case CONS_TYPE_FOLLOW_POINT:var trans=
m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var t_trans=cons.target;rotate_to(trans,quat,t_trans);var dist=m_vec3.dist(trans,t_trans);if(dist>cons.dist_max)var delta=dist-cons.dist_max;else if(dist<cons.dist_min)var delta=dist-cons.dist_min;else var delta=0;if(delta){m_vec3.sub(t_trans,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,_vec3_tmp);m_vec3.scale(_vec3_tmp,delta,_vec3_tmp);m_vec3.add(trans,_vec3_tmp,trans)}break;case CONS_TYPE_STIFF_TRANS_OBJ:var p_world_tsr=
cons.obj_parent.render.world_tsr;var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_tsr.transform_vec3(cons.offset,p_world_tsr,trans);break;case CONS_TYPE_COPY_TRANS_OBJ:var p_trans=m_tsr.get_trans_view(cons.obj_parent.render.world_tsr);var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_vec3.add(p_trans,cons.offset,trans);break;case CONS_TYPE_STIFF_TRANS_ROT_OBJ:var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_world_tsr=cons.obj_parent.render.world_tsr;var p_quat=m_tsr.get_quat_view(cons.obj_parent.render.world_tsr);
if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,quat);m_quat.multiply(p_quat,quat,quat)}else m_quat.copy(p_quat,quat);var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_tsr.transform_vec3(cons.offset,p_world_tsr,trans);break;case CONS_TYPE_CHILD_OF:var prender=cons.obj_parent.render;var render=obj.render;m_tsr.multiply(prender.world_tsr,cons.tsr_offset,render.world_tsr);break;case CONS_TYPE_CHILD_OF_BONE:var tsr_offset=cons.tsr_offset;var p_tsr=_tsr_tmp;m_armat.get_bone_tsr(cons.obj_parent,
cons.bone_name,true,false,p_tsr);m_tsr.multiply(cons.obj_parent.render.world_tsr,p_tsr,p_tsr);m_tsr.multiply(p_tsr,tsr_offset,obj.render.world_tsr);break;case CONS_TYPE_STIFF_VIEWPORT:var camobj=cons.obj_parent;var cam=m_cam.get_first_cam(camobj);var trans=m_tsr.get_trans_view(obj.render.world_tsr);var left=m_cam.get_edge(cam,"LEFT");var right=m_cam.get_edge(cam,"RIGHT");var top=m_cam.get_edge(cam,"TOP");var bottom=m_cam.get_edge(cam,"BOTTOM");if(cons.hor_units=="heights")var hor_stride=top-bottom;
else var hor_stride=right-left;if(cons.left_edge){var left=m_cam.get_edge(cam,"LEFT");trans[0]=left+hor_stride*cons.left_right_dist}else{var right=m_cam.get_edge(cam,"RIGHT");trans[0]=right-hor_stride*cons.left_right_dist}if(cons.vert_units=="heights")var vert_stride=top-bottom;else var vert_stride=right-left;if(cons.top_edge)trans[2]=-(top-vert_stride*cons.top_bottom_dist);else trans[2]=-(bottom+vert_stride*cons.top_bottom_dist);if(m_cam.is_ortho(cam))trans[1]=-cons.distance;else{trans[1]=-1;m_vec3.normalize(trans,
trans);var scale=cons.distance/Math.abs(trans[1]);m_vec3.scale(trans,scale,trans)}m_tsr.transform_dir_vec3(trans,camobj.render.world_tsr,trans);var cam_trans=m_tsr.get_trans_view(camobj.render.world_tsr);m_vec3.add(cam_trans,trans,trans);var obj_quat=m_tsr.get_quat_view(obj.render.world_tsr);var cam_quat=m_tsr.get_quat_view(camobj.render.world_tsr);if(cons.rotation_offset){m_quat.copy(cons.rotation_offset,obj_quat);m_quat.multiply(cam_quat,obj_quat,obj_quat)}else m_quat.copy(cam_quat,obj_quat);break;
default:break}if(obj.render.type=="CAMERA"){var corr_axis=m_util.AXIS_Y;if(cons.type==CONS_TYPE_SEMI_STIFF_CAM_OBJ){var p_quat=m_tsr.get_quat_view(cons.obj_parent.render.world_tsr);corr_axis=m_vec3.transformQuat(corr_axis,p_quat,_parent_y_axis)}m_cam.update_camera_upside_down(obj);correct_up(obj,corr_axis)}}exports.append_stiff_bone_to_obj=function(armobj,obj,bone_name,offset,rotation_offset,scale_offset){var cons=init_cons(BONE_CONS_TYPE_STIFF_OBJ);var bone_pointer=armobj.render.bone_pointers[bone_name];
cons.bone_name=bone_name;cons.target=obj;cons.offset=new Float32Array(offset);cons.rotation_offset=rotation_offset?new Float32Array(rotation_offset):null;cons.scale_offset=scale_offset;apply_bone_cons(armobj,cons);update_bone_cons(armobj,cons)};function apply_bone_cons(armobj,cons){var target=cons.target;var bone_name=cons.bone_name;var bone_pointer=armobj.render.bone_pointers[bone_name];remove_arm_bone_descendant(target,armobj,bone_name);target.cons_armat_bone_descends.push([armobj,bone_name]);bone_pointer.constraint=
cons}function remove_arm_bone_descendant(obj,armobj,bone_name){var cons_armat_bone_descends=obj.cons_armat_bone_descends;for(var i=0;i<cons_armat_bone_descends;i++){var cons_desc=cons_armat_bone_descends[i];if(cons_desc[0]==armobj&&cons_desc[1]==bone_name){cons_armat_bone_descends.splice(i,1);return}}}exports.update_bone_constraint=function(armobj,bone_name){var bone_pointer=armobj.render.bone_pointers[bone_name];if(bone_pointer.constraint)update_bone_cons(armobj,bone_pointer.constraint)};function update_bone_cons(armobj,
cons){switch(cons.type){case BONE_CONS_TYPE_STIFF_OBJ:var target_obj=cons.target;var target_tsr=target_obj.render.world_tsr;var armobj_tsr=armobj.render.world_tsr;var b_tsr=_tsr_tmp;m_tsr.invert(armobj_tsr,b_tsr);m_tsr.multiply(b_tsr,target_tsr,b_tsr);m_armat.set_bone_tsr(armobj,cons.bone_name,b_tsr,false);break;default:break}armobj.need_update_transform=true}function clamp_orientation(obj,cons){var quat=m_tsr.get_quat_view(obj.render.world_tsr);var p_quat=m_tsr.get_quat_view(cons.obj_parent.render.world_tsr);
var quat_base=m_quat.multiply(p_quat,cons.rotation_offset,_quat4_tmp);var base_angles=m_cam.get_camera_angles_from_quat(quat_base,_vec2_tmp);var curr_angles=m_cam.get_camera_angles_from_quat(quat,_vec2_tmp_2);var d_phi=m_util.calc_returning_angle(curr_angles[0],base_angles[0]+cons.clamp_right,base_angles[0]+cons.clamp_left);var d_theta=m_util.calc_returning_angle(curr_angles[1],base_angles[1]+cons.clamp_down,base_angles[1]+cons.clamp_up);m_cam.rotate_eye_camera(obj,d_phi,d_theta)}exports.rotate_to=
rotate_to;function rotate_to(trans,quat,target){var dir_from=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,dir_from);m_vec3.normalize(dir_from,dir_from);var dir_to=_vec3_tmp_2;m_vec3.subtract(target,trans,dir_to);m_vec3.normalize(dir_to,dir_to);var rotation=m_util.rotation_to_stable(dir_from,dir_to,_vec4_tmp);m_quat.multiply(rotation,quat,quat);m_quat.normalize(quat,quat)}function cam_rotate_to(quat,dir,dest){var mat_dst=_mat3_tmp;var x_cam_world=mat_dst.subarray(0,3);var y_cam_world=mat_dst.subarray(3,
6);var z_cam_world=mat_dst.subarray(6,9);m_vec3.copy(dir,y_cam_world);m_vec3.negate(y_cam_world,y_cam_world);m_vec3.normalize(y_cam_world,y_cam_world);var up_down=Boolean(Math.abs(m_vec3.dot(dir,m_util.AXIS_Y))>.999999);if(up_down){var mat_src=m_mat3.fromQuat(m_quat.normalize(quat,dest),_mat3_tmp2);m_vec3.copy(mat_src.subarray(0,3),x_cam_world)}else m_vec3.cross(m_util.AXIS_Y,y_cam_world,x_cam_world);m_vec3.normalize(x_cam_world,x_cam_world);m_vec3.cross(x_cam_world,y_cam_world,z_cam_world);m_vec3.normalize(z_cam_world,
z_cam_world);m_quat.fromMat3(mat_dst,dest);m_quat.normalize(dest,dest)}exports.correct_up=correct_up;function correct_up(camobj,up_axis,strict){var render=camobj.render;var quat=m_tsr.get_quat_view(render.world_tsr);var y_cam_world=m_util.quat_to_dir(quat,m_util.AXIS_Y,_vec3_tmp);m_vec3.normalize(y_cam_world,y_cam_world);if(Math.abs(m_vec3.dot(up_axis,y_cam_world))>.999999)var rotation=m_quat.identity(_quat4_tmp);else{var x_cam_world_new=m_vec3.cross(up_axis,y_cam_world,_vec3_tmp_2);m_vec3.normalize(x_cam_world_new,
x_cam_world_new);if(render.move_style==m_cam.MS_TARGET_CONTROLS){if(render.target_cam_upside_down)m_vec3.negate(x_cam_world_new,x_cam_world_new)}else{var z_cam_world=m_util.quat_to_dir(quat,m_util.AXIS_Z,_vec3_tmp_3);if(m_vec3.dot(z_cam_world,up_axis)>0)m_vec3.negate(x_cam_world_new,x_cam_world_new)}var x_cam_world=m_util.quat_to_dir(quat,m_util.AXIS_X,_vec3_tmp_3);m_vec3.normalize(x_cam_world,x_cam_world);var cosine=m_util.clamp(m_vec3.dot(x_cam_world,x_cam_world_new),-1,1);if(cosine<=-.999999){var angle=
Math.acos(cosine);var rotation=m_quat.setAxisAngle(y_cam_world,angle,_quat4_tmp)}else var rotation=m_quat.rotationTo(x_cam_world,x_cam_world_new,_quat4_tmp);m_quat.normalize(rotation,rotation)}m_quat.multiply(rotation,quat,quat);if(strict){var mz_cam_world=m_util.quat_to_dir(quat,m_util.AXIS_MZ,_vec3_tmp);if(m_vec3.dot(up_axis,mz_cam_world)<0)m_quat.rotateY(quat,Math.PI,quat)}m_cam.update_camera_upside_down(camobj)}exports.check_constraint=function(obj){if(obj.constraint)return true;else return false};
exports.remove=function(obj){if(obj.constraint.obj_parent)remove_parent_descendant(obj.constraint.obj_parent,obj);obj.constraint=null};exports.get_type=function(obj){if(obj.constraint)return obj.constraint.type;else return null};exports.has_child_of=function(obj){var cons=obj.constraint;if(cons&&(cons.type==CONS_TYPE_CHILD_OF||cons.type==CONS_TYPE_CHILD_OF_BONE))return true;else return false};exports.get_child_of_parent_tsr=function(obj){var cons=obj.constraint;if(cons&&cons.type==CONS_TYPE_CHILD_OF)return cons.obj_parent.render.world_tsr;
else if(cons&&cons.type==CONS_TYPE_CHILD_OF_BONE){var p_tsr=_tsr_tmp;m_armat.get_bone_tsr(cons.obj_parent,cons.bone_name,true,false,p_tsr);m_tsr.multiply(cons.obj_parent.render.world_tsr,p_tsr,p_tsr);return p_tsr}else return null};exports.get_child_of_offset=function(obj){var cons=obj.constraint;if(cons&&(cons.type==CONS_TYPE_CHILD_OF||cons.type==CONS_TYPE_CHILD_OF_BONE))return cons.tsr_offset;else return null}};b4w.module["__container"]=function(exports,require){var m_anchors=require("__anchors");var m_cfg=require("__config");var m_data=require("__data");var m_hud=require("__hud");var m_print=require("__print");var m_scenes=require("__scenes");var m_time=require("__time");var m_trans=require("__transform");var m_util=require("__util");var cfg_def=m_cfg.defaults;var _canvas=null;var _canvas_hud=null;var _canvas_cont=null;var _offsets_updating_needed=false;var _viewport_layout={width:0,height:0,scale:1,offset_top:0,
offset_left:0};var _gl=null;exports.DEFAULT_CANVAS_W=320;exports.DEFAULT_CANVAS_H=240;exports.setup_context=function(gl){_gl=gl};exports.get_canvas=get_canvas;function get_canvas(){return _canvas}exports.get_canvas_hud=get_canvas_hud;function get_canvas_hud(){return _canvas_hud}exports.get_container=get_container;function get_container(){return _canvas_cont}exports.init=function(canvas,canvas_hud){if(canvas&&canvas.parentNode){_canvas=canvas;_canvas_hud=canvas_hud;_canvas_cont=canvas.parentNode}else m_util.panic("canvas container is not available")};
exports.insert_to_container=function(elem,stack_order){stack_order=stack_order||"LAST";switch(stack_order){case "FIRST":var cont_first_child=_canvas_cont.firstElementChild;_canvas_cont.insertBefore(elem,cont_first_child);break;case "JUST_BEFORE_CANVAS":_canvas_cont.insertBefore(elem,_canvas);break;case "JUST_AFTER_CANVAS":if(_canvas.nextElementSibling)_canvas_cont.insertBefore(elem,_canvas.nextElementSibling);else _canvas_cont.appendChild(elem,_canvas);break;case "LAST":_canvas_cont.appendChild(elem,
_canvas);break;default:m_print.error(stack_order+" invalid stack order");break}};exports.get_viewport_width=function(){return _viewport_layout.width};exports.get_viewport_height=function(){return _viewport_layout.height};exports.set_canvas_offsets=set_canvas_offsets;function set_canvas_offsets(left,top){_viewport_layout.offset_left=left;_viewport_layout.offset_top=top}exports.update_canvas_offsets=update_canvas_offsets;function update_canvas_offsets(){var boundaries=_canvas.getBoundingClientRect();
set_canvas_offsets(boundaries.left,boundaries.top)}exports.setup_viewport_dim=setup_viewport_dim;function setup_viewport_dim(width,height,scale){_viewport_layout.width=width;_viewport_layout.height=height;_viewport_layout.scale=scale;update_canvas_offsets()}exports.force_offsets_updating=function(){_offsets_updating_needed=true};function get_offset_top(){if(_offsets_updating_needed){update_canvas_offsets();_offsets_updating_needed=false}return _viewport_layout.offset_top}function get_offset_left(){if(_offsets_updating_needed){update_canvas_offsets();
_offsets_updating_needed=false}return _viewport_layout.offset_left}exports.client_to_canvas_coords=function(client_x,client_y,dest){if(!dest)dest=new Float32Array(2);dest[0]=client_x-get_offset_left();dest[1]=client_y-get_offset_top();return dest};exports.canvas_to_viewport_coords=function(canvas_x,canvas_y,dest,camera){if(!dest)dest=new Float32Array(2);dest[0]=canvas_x*_viewport_layout.scale;dest[1]=canvas_y*_viewport_layout.scale;if(camera){var camera_resolution_scale=camera.width/_viewport_layout.width;
dest[0]*=camera_resolution_scale;dest[1]*=camera_resolution_scale}return dest};exports.viewport_to_canvas_coords=function(viewport_x,viewport_y,dest,camera){if(!dest)dest=new Float32Array(2);dest[0]=viewport_x/_viewport_layout.scale;dest[1]=viewport_y/_viewport_layout.scale;if(camera){var camera_resolution_scale=camera.width/_viewport_layout.width;dest[0]/=camera_resolution_scale;dest[1]/=camera_resolution_scale}return dest};exports.is_child=function(elem){if(!elem||!elem.parentNode)return false;
else if(elem.parentNode==_canvas_cont)return true;else return exports.is_child(elem.parentNode)};exports.is_hidpi=is_hidpi;function is_hidpi(){if(cfg_def.allow_hidpi&&window.devicePixelRatio>=2)return true;return false}exports.find_script=function(src){var scripts=document.getElementsByTagName("script");var norm_src=m_util.normpath_preserve_protocol(src);for(var i=0;i<scripts.length;i++)if(scripts[i].src==norm_src)return scripts[i];return null};exports.resize=resize;function resize(width,height,update_canvas_css){if(!width||
!height){width=exports.DEFAULT_CANVAS_W;height=exports.DEFAULT_CANVAS_H;var canvas_cont=get_container();canvas_cont.style.width=exports.DEFAULT_CANVAS_W+"px";canvas_cont.style.height=exports.DEFAULT_CANVAS_H+"px"}var canvas_webgl=get_canvas();var canvas_hud=get_canvas_hud();if(update_canvas_css!==false){canvas_webgl.style.width=width+"px";canvas_webgl.style.height=height+"px";if(canvas_hud){canvas_hud.style.width=width+"px";canvas_hud.style.height=height+"px"}}if(canvas_hud){canvas_hud.width=width;
canvas_hud.height=height;m_hud.update_dim()}var cw=Math.floor(width*cfg_def.canvas_resolution_factor);var ch=Math.floor(height*cfg_def.canvas_resolution_factor);if(is_hidpi()){cw*=window.devicePixelRatio;ch*=window.devicePixelRatio}var main_scene=m_scenes.get_main();if(main_scene){var sc_render=main_scene._render;cw=Math.floor(cw*sc_render.resolution_factor);ch=Math.floor(ch*sc_render.resolution_factor)}canvas_webgl.width=cw;canvas_webgl.height=ch;if(cw>_gl.drawingBufferWidth||ch>_gl.drawingBufferHeight){m_print.warn("Canvas size exceeds platform limits, downscaling");
var downscale=Math.min(_gl.drawingBufferWidth/cw,_gl.drawingBufferHeight/ch);cw*=downscale;ch*=downscale;canvas_webgl.width=cw;canvas_webgl.height=ch}m_scenes.setup_dim(cw,ch,cw/width);if(m_scenes.check_active())m_trans.update_transform(m_scenes.get_active()._camera);m_data.update_media_controls(canvas_webgl.width,canvas_webgl.height);if(!m_data.is_primary_loaded())return;m_anchors.update();m_scenes.update(m_time.get_timeline(),0);m_anchors.update_visibility()}};b4w.module["__controls"]=function(exports,require){var m_cfg=require("__config");var m_cont=require("__container");var m_input=require("__input");var m_obj=require("__objects");var m_print=require("__print");var m_phy=require("__physics");var m_quat=require("__quat");var m_time=require("__time");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var cfg_ctl=m_cfg.controls;var cfg_dft=m_cfg.defaults;var _objects=[];var _global_object={};
var _sensors_cache=[];var _manifolds_cache=[];var _accumulators_cache=[];var _vec2_tmp=new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=m_vec3.create();var _quat_tmp=m_quat.create();var _manifolds_updated=false;var _update_counter=0;var ST_CUSTOM=10;var ST_KEYBOARD=20;var ST_MOUSE_WHEEL=30;var ST_MOUSE_MOVE=40;var ST_MOUSE_CLICK=50;var ST_TOUCH_MOVE=60;var ST_TOUCH_ZOOM=70;var ST_TOUCH_ROTATE=75;var ST_TOUCH_CLICK=80;var ST_COLLISION=90;var ST_COLLISION_IMPULSE=100;var ST_RAY=
110;var ST_MOTION=120;var ST_V_VELOCITY=130;var ST_TIMER=140;var ST_ELAPSED=150;var ST_TIMELINE=160;var ST_SELECTION=170;var ST_GYRO_DELTA=180;var ST_GYRO_ANGLES=190;var ST_GYRO_QUAT=200;var ST_HMD_QUAT=210;var ST_HMD_POSITION=220;var ST_CALLBACK=230;var ST_GAMEPAD_BTNS=240;var ST_GMPD_AXIS=250;exports.CT_POSITIVE=10;exports.CT_CONTINUOUS=20;exports.CT_TRIGGER=30;exports.CT_SHOT=40;exports.CT_LEVEL=50;exports.CT_CHANGE=60;exports.PL_SINGLE_TOUCH_MOVE=0;exports.PL_MULTITOUCH_MOVE_ZOOM=1;exports.PL_MULTITOUCH_MOVE_PAN=
2;exports.PL_MULTITOUCH_MOVE_ROTATE=3;var SENSOR_SMOOTH_PERIOD=.3;var KEY_SHIFT=16;exports.update=function(timeline,elapsed){for(var i=0;i<_sensors_cache.length;i++){var sensor=_sensors_cache[i];update_sensor(sensor,timeline,elapsed)}for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds_arr=obj.sensor_manifolds_arr;for(var j=0;j<manifolds_arr.length;j++){var manifold=manifolds_arr[j];if(manifold.update_counter==_update_counter)continue;manifold.update_counter=_update_counter;var pulse=
manifold_gen_pulse(manifold);if(pulse){var cb_obj=obj==_global_object?null:obj;_manifolds_updated=false;manifold.callback(cb_obj,manifold.id,pulse,manifold.callback_param);if(_manifolds_updated){i=-1;break}}}}for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds_arr=obj.sensor_manifolds_arr;for(var j=0;j<manifolds_arr.length;j++){var manifold=manifolds_arr[j];discharge_sensors(manifold.sensors)}}for(var i=0;i<_accumulators_cache.length;i++){var accum=_accumulators_cache[i];update_accumulator(accum)}_update_counter++};
exports.create_custom_sensor=function(value){var sensor=init_sensor(ST_CUSTOM);sensor_set_value(sensor,value);return sensor};function init_sensor(type,element){if(!element)element=m_cont.get_container();var sensor={type:type,value:0,payload:null,element:element,do_activation:false,key:0,collision_id:"",calc_pos_norm:false,collision_obj:null,collision_cb:function(){},col_imp_obj:null,col_imp_cb:function(){},source_object:null,from:new Float32Array(3),to:new Float32Array(3),is_binary_value:false,ign_src_rot:false,
ray_test_id:0,ray_test_cb:function(){},axis:"",time_last:0,trans_last:new Float32Array(3),quat_last:new Float32Array(4),threshold:0,quat_temp:new Float32Array(4),avg_linear_vel:0,avg_angular_vel:0,rotation_threshold:0,avg_vertical_vel:0,period:0,repeat:false,auto_release:false,gamepad_id:0,callback:function(){}};return sensor}function update_accumulator(accum){if(!accum.is_updated_keyboard){for(var i=0;i<accum.downed_keys.length;i++)if(accum.downed_keys[i]==1)accum.downed_keys[i]=2;else if(accum.downed_keys[i]==
3)accum.downed_keys[i]=0;accum.is_updated_keyboard=true}accum.wheel_delta=0;accum.mouse_last_x=accum.mouse_curr_x;accum.mouse_last_y=accum.mouse_curr_y;accum.downed_keys[0]=false;accum.touches_last_x.set(accum.touches_curr_x);accum.touches_last_y.set(accum.touches_curr_y);accum.touch_zoom_last_dist=accum.touch_zoom_curr_dist;accum.gyro_gamma_last=accum.gyro_gamma_new;accum.gyro_beta_last=accum.gyro_beta_new;accum.gyro_alpha_last=accum.gyro_alpha_new;accum.is_updated_gyro_quat=false}function get_accumulator(element){if(!element)element=
m_cont.get_container();for(var i=0;i<_accumulators_cache.length;i++){var accumulator=_accumulators_cache[i];if(element==accumulator.element)return accumulator}var accumulator={element:element,is_updated_keyboard:true,is_mouse_downed:false,is_touch_ended:true,mouse_last_x:0,mouse_last_y:0,mouse_curr_x:0,mouse_curr_y:0,touches_last_x:new Float32Array(2),touches_curr_x:new Float32Array(2),touches_last_y:new Float32Array(2),touches_curr_y:new Float32Array(2),touch_zoom_curr_dist:0,touch_zoom_last_dist:0,
touch_start_rot:0,downed_keys:new Uint8Array(256),wheel_delta:0,selected_obj:null,is_updated_gyro_quat:false,gyro_quat:m_quat.create(),gyro_gamma_new:0,gyro_beta_new:0,gyro_alpha_new:0,gyro_gamma_last:0,gyro_beta_last:0,gyro_alpha_last:Infinity,orientation_quat_cb:null,orientation_angles_cb:null,mouse_wheel_cb:null,mouse_down_which_cb:null,mouse_select_cb:null,touch_select_cb:null,mouse_up_which_cb:null,mouse_location_cb:null,keyboard_downed_keys_cb:null,touch_start_cb:null,touch_move_cb:null,touch_end_cb:null,
registered_accum_values:{}};accumulator.orientation_quat_cb=function(angles){if(!accumulator.is_updated_gyro_quat){m_input.gyro_angles_to_quat(angles,accumulator.gyro_quat);accumulator.is_updated_gyro_quat=true}};accumulator.orientation_angles_cb=function(quat){var euler_angles=m_vec3.copy(quat,_vec3_tmp);accumulator.gyro_alpha_new=euler_angles[0];accumulator.gyro_beta_new=euler_angles[1];accumulator.gyro_gamma_new=euler_angles[2];if(accumulator.gyro_alpha_last==Infinity){accumulator.gyro_alpha_last=
euler_angles[0];accumulator.gyro_beta_last=euler_angles[1];accumulator.gyro_gamma_last=euler_angles[2]}};accumulator.mouse_wheel_cb=function(wd){accumulator.wheel_delta+=wd*cfg_ctl.mouse_wheel_notch_multiplier};accumulator.mouse_down_which_cb=function(wd){var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accumulator.element);var loc=m_input.get_vector_param(device,m_input.MOUSE_LOCATION,_vec2_tmp);accumulator.mouse_last_x=loc[0];accumulator.mouse_last_y=loc[1];accumulator.mouse_curr_x=
loc[0];accumulator.mouse_curr_y=loc[1];accumulator.is_mouse_downed=true;accumulator.which=wd};accumulator.mouse_select_cb=function(wd){var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accumulator.element);var loc=m_input.get_vector_param(device,m_input.MOUSE_LOCATION,_vec2_tmp);var canvas_xy=m_cont.client_to_canvas_coords(loc[0],loc[1],_vec2_tmp);accumulator.selected_obj=m_obj.pick_object(canvas_xy[0],canvas_xy[1])};accumulator.touch_select_cb=function(touches){if(touches.length==
1){var canvas_xy=m_cont.client_to_canvas_coords(touches[0].clientX,touches[0].clientY,_vec2_tmp);accumulator.selected_obj=m_obj.pick_object(canvas_xy[0],canvas_xy[1])}};accumulator.mouse_up_which_cb=function(wd){accumulator.is_mouse_downed=false};accumulator.mouse_location_cb=function(location){if(!cfg_dft.ie11_edge_touchscreen_hack||accumulator.is_mouse_downed){accumulator.mouse_curr_x=location[0];accumulator.mouse_curr_y=location[1]}};accumulator.keyboard_down_keys_cb=function(key){if(accumulator.downed_keys[key]!=
2){accumulator.downed_keys[key]=1;accumulator.is_updated_keyboard=false}};accumulator.keyboard_up_keys_cb=function(key){if(accumulator.downed_keys[key]==1)accumulator.downed_keys[key]=0;else{accumulator.is_updated_keyboard&=false;accumulator.downed_keys[key]=3}};accumulator.touch_start_cb=function(touches){accumulator.is_touch_ended=false;if(touches.length==1){accumulator.touches_last_x[0]=touches[0].clientX;accumulator.touches_last_x[1]=-1;accumulator.touches_last_y[0]=touches[0].clientY;accumulator.touches_last_y[1]=
-1}else if(touches.length>1){var zoom_dist=touch_zoom_dist(touches);accumulator.touch_zoom_curr_dist=accumulator.touch_zoom_last_dist=zoom_dist;accumulator.touches_last_x[0]=touches[0].clientX;accumulator.touches_last_x[1]=touches[1].clientX;accumulator.touches_last_y[0]=touches[0].clientY;accumulator.touches_last_y[1]=touches[1].clientY;accumulator.touch_start_rot=touch_rotation(touches)}accumulator.touches_curr_x.set(accumulator.touches_last_x);accumulator.touches_curr_y.set(accumulator.touches_last_y)};
accumulator.touch_move_cb=function(touches){if(touches.length===1){accumulator.touches_curr_x[0]=touches[0].clientX;accumulator.touches_curr_x[1]=-1;accumulator.touches_curr_y[0]=touches[0].clientY;accumulator.touches_curr_y[1]=-1}else if(touches.length>1){accumulator.touches_curr_x[0]=touches[0].clientX;accumulator.touches_curr_x[1]=touches[1].clientX;accumulator.touches_curr_y[0]=touches[0].clientY;accumulator.touches_curr_y[1]=touches[1].clientY;var zoom_dist=touch_zoom_dist(touches);accumulator.touch_zoom_curr_dist=
zoom_dist}};accumulator.touch_end_cb=function(touches){if(touches.length==0)accumulator.is_touch_ended=true};_accumulators_cache.push(accumulator);return accumulator}function register_accum_value(accum,value_name){if(value_name in accum.registered_accum_values&&accum.registered_accum_values[value_name]>0){accum.registered_accum_values[value_name]+=1;return}accum.registered_accum_values[value_name]=1;switch(value_name){case "orientation_quat":var device=m_input.get_device_by_type_element(m_input.DEVICE_GYRO);
if(device)m_input.attach_param_cb(device,m_input.GYRO_ORIENTATION_ANGLES,accum.orientation_quat_cb);break;case "orientation_angles":var device=m_input.get_device_by_type_element(m_input.DEVICE_GYRO);if(device)m_input.attach_param_cb(device,m_input.GYRO_ORIENTATION_ANGLES,accum.orientation_angles_cb);break;case "mouse_wheel":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.attach_param_cb(device,m_input.MOUSE_WHEEL,accum.mouse_wheel_cb);break;case "mouse_down_which":var device=
m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.attach_param_cb(device,m_input.MOUSE_DOWN_WHICH,accum.mouse_down_which_cb);break;case "mouse_select":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.attach_param_cb(device,m_input.MOUSE_DOWN_WHICH,accum.mouse_select_cb);break;case "touch_select":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.attach_param_cb(device,
m_input.TOUCH_START,accum.touch_select_cb);break;case "mouse_up_which":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.attach_param_cb(device,m_input.MOUSE_UP_WHICH,accum.mouse_up_which_cb);break;case "mouse_location":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.attach_param_cb(device,m_input.MOUSE_LOCATION,accum.mouse_location_cb);break;case "keyboard_downed_keys":var device=m_input.get_device_by_type_element(m_input.DEVICE_KEYBOARD,
accum.element);if(device){m_input.attach_param_cb(device,m_input.KEYBOARD_DOWN,accum.keyboard_down_keys_cb);m_input.attach_param_cb(device,m_input.KEYBOARD_UP,accum.keyboard_up_keys_cb)}break;case "touch_start":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.attach_param_cb(device,m_input.TOUCH_START,accum.touch_start_cb);break;case "touch_move":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.attach_param_cb(device,
m_input.TOUCH_MOVE,accum.touch_move_cb);break;case "touch_end":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.attach_param_cb(device,m_input.TOUCH_END,accum.touch_end_cb);break}}function unregister_accum_value(accum,value_name){if(!value_name in accum.registered_accum_values)return;else if(accum.registered_accum_values[value_name]>0){accum.registered_accum_values[value_name]-=1;if(accum.registered_accum_values[value_name])return}else return;switch(value_name){case "orientation_quat":var device=
m_input.get_device_by_type_element(m_input.DEVICE_GYRO);if(device)m_input.detach_param_cb(device,m_input.GYRO_ORIENTATION_QUAT,accum.orientation_quat_cb);break;case "orientation_angles":var device=m_input.get_device_by_type_element(m_input.DEVICE_GYRO);if(device)m_input.detach_param_cb(device,m_input.GYRO_ORIENTATION_ANGLES,accum.orientation_angles_cb);break;case "mouse_wheel":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.detach_param_cb(device,
m_input.MOUSE_WHEEL,accum.mouse_wheel_cb);break;case "mouse_down_which":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.detach_param_cb(device,m_input.MOUSE_DOWN_WHICH,accum.mouse_down_which_cb);break;case "mouse_select":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.detach_param_cb(device,m_input.MOUSE_DOWN_WHICH,accum.mouse_select_cb);break;case "touch_select":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,
accum.element);if(device)m_input.detach_param_cb(device,m_input.TOUCH_START,accum.touch_select_cb);break;case "mouse_up_which":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.detach_param_cb(device,m_input.MOUSE_UP_WHICH,accum.mouse_up_which_cb);break;case "mouse_location":var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,accum.element);if(device)m_input.detach_param_cb(device,m_input.MOUSE_LOCATION,accum.mouse_location_cb);break;
case "keyboard_downed_keys":var device=m_input.get_device_by_type_element(m_input.DEVICE_KEYBOARD,accum.element);if(device){m_input.detach_param_cb(device,m_input.KEYBOARD_DOWN,accum.keyboard_down_keys_cb);m_input.detach_param_cb(device,m_input.KEYBOARD_UP,accum.keyboard_up_keys_cb)}break;case "touch_start":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.detach_param_cb(device,m_input.TOUCH_START,accum.touch_start_cb);break;case "touch_move":var device=
m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.detach_param_cb(device,m_input.TOUCH_MOVE,accum.touch_move_cb);break;case "touch_end":var device=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,accum.element);if(device)m_input.detach_param_cb(device,m_input.TOUCH_END,accum.touch_end_cb);break}}exports.create_keyboard_sensor=function(key){var element=document;var sensor=init_sensor(ST_KEYBOARD,element);sensor.key=key;sensor.do_activation=true;return sensor};
exports.create_gamepad_btn_sensor=function(btn,id){var element=document;var sensor=init_sensor(ST_GAMEPAD_BTNS,element);id=id||m_input.get_first_gmpd_id();sensor.gamepad_id=id;sensor.key=btn;sensor.do_activation=true;return sensor};exports.create_gamepad_axis_sensor=function(axis,id){var element=document;var sensor=init_sensor(ST_GMPD_AXIS,element);id=id==undefined?m_input.get_first_gmpd_id():id;sensor.gamepad_id=id;sensor.key=axis;sensor.do_activation=true;return sensor};exports.create_collision_sensor=
function(obj,collision_id,calc_pos_norm){if(!(obj&&m_phy.obj_has_physics(obj))){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_COLLISION);sensor.collision_obj=obj;sensor.collision_id=collision_id;sensor.calc_pos_norm=calc_pos_norm;sensor.payload={coll_obj:null,coll_pos:calc_pos_norm?new Float32Array(3):null,coll_norm:calc_pos_norm?new Float32Array(3):null,coll_dist:0};sensor.collision_cb=function(is_collision,coll_obj,coll_pos,coll_norm,coll_dist){sensor_set_value(sensor,
is_collision);var payload=sensor.payload;payload.coll_obj=coll_obj;if(sensor.calc_pos_norm){payload.coll_pos.set(coll_pos);payload.coll_norm.set(coll_norm);payload.coll_dist=coll_dist}};sensor.do_activation=true;return sensor};exports.create_collision_impulse_sensor=function(obj){if(!(obj&&obj.physics)){m_print.error("Wrong collision impulse object");return null}var sensor=init_sensor(ST_COLLISION_IMPULSE);sensor.col_imp_obj=obj;sensor.col_imp_cb=function(impulse){sensor_set_value(sensor,impulse)};
sensor.do_activation=true;return sensor};exports.create_ray_sensor=function(obj_src,from,to,collision_id,is_binary_value,calc_pos_norm,ign_src_rot){var sensor=init_sensor(ST_RAY);sensor.source_object=obj_src;sensor.from=from;sensor.to=to;sensor.collision_id=collision_id;sensor.is_binary_value=is_binary_value;sensor.calc_pos_norm=calc_pos_norm;sensor.ign_src_rot=ign_src_rot;sensor.payload={hit_fract:0,obj_hit:null,hit_time:0,hit_pos:new Float32Array(3),hit_norm:new Float32Array(3),ray_test_id:0};sensor.ray_test_cb=
function(id,hit_fract,obj_hit,hit_time,hit_pos,hit_norm){if(sensor.is_binary_value)sensor_set_value(sensor,hit_fract==-1?0:1);else sensor_set_value(sensor,hit_fract);sensor.payload.hit_fract=hit_fract;sensor.payload.obj_hit=obj_hit;sensor.payload.hit_time=hit_time;if(sensor.calc_pos_norm){sensor.payload.hit_pos.set(hit_pos);sensor.payload.hit_norm.set(hit_norm)}};sensor.do_activation=true;return sensor};exports.create_mouse_click_sensor=function(element){var sensor=init_sensor(ST_MOUSE_CLICK,element);
sensor.do_activation=true;return sensor};exports.create_mouse_wheel_sensor=function(element){var sensor=init_sensor(ST_MOUSE_WHEEL,element);sensor.do_activation=true;return sensor};exports.create_mouse_move_sensor=function(axis,element){var sensor=init_sensor(ST_MOUSE_MOVE,element);sensor.axis=axis||"XY";sensor.payload=sensor.axis=="XY"?new Float32Array(2):0;sensor.do_activation=true;return sensor};exports.create_touch_move_sensor=function(axis,element){var sensor=init_sensor(ST_TOUCH_MOVE,element);
sensor.axis=axis||"XY";sensor.payload=0;sensor.do_activation=true;return sensor};exports.create_touch_zoom_sensor=function(element){var sensor=init_sensor(ST_TOUCH_ZOOM,element);sensor.payload=0;sensor.do_activation=true;return sensor};exports.create_touch_rotate_sensor=function(element){var sensor=init_sensor(ST_TOUCH_ROTATE,element);sensor.payload=0;sensor.do_activation=true;return sensor};exports.create_touch_click_sensor=function(element){var sensor=init_sensor(ST_TOUCH_CLICK,element);sensor.payload=
0;sensor.do_activation=true;return sensor};exports.create_motion_sensor=function(obj,threshold,rotation_threshold){if(!obj){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_MOTION);sensor.source_object=obj;var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);sensor.quat_temp=new Float32Array(4);sensor.trans_last=new Float32Array(trans);sensor.quat_last=new Float32Array(quat);sensor.avg_linear_vel=0;sensor.avg_angular_vel=
0;sensor.threshold=threshold||.1;sensor.rotation_threshold=rotation_threshold||.1;sensor.time_last=0;sensor.payload=new Float32Array([0,0]);return sensor};exports.create_vertical_velocity_sensor=function(obj,threshold){if(!obj){m_print.error("Wrong collision object");return null}var sensor=init_sensor(ST_V_VELOCITY);sensor.source_object=obj;var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);sensor.trans_last=new Float32Array(trans);sensor.quat_last=
new Float32Array(quat);sensor.avg_vertical_vel=0;sensor.threshold=threshold||1;sensor.time_last=0;sensor.payload=0;return sensor};exports.create_timer_sensor=function(period,do_repeat){var sensor=init_sensor(ST_TIMER);sensor.period=period;sensor.repeat=do_repeat;sensor.do_activation=true;return sensor};exports.reset_timer_sensor=function(obj,manifold_id,num,period){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("reset_timer_sensor(): wrong object");
return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("reset_timer_sensor(): sensor not found");return null}sensor.time_last=m_time.get_timeline();sensor.period=period};exports.create_elapsed_sensor=function(){var sensor=init_sensor(ST_ELAPSED);sensor.time_last=0;return sensor};exports.create_gyro_delta_sensor=function(){var sensor=init_sensor(ST_GYRO_DELTA,window);sensor.payload=new Float32Array(3);var device=m_input.get_device_by_type_element(m_input.DEVICE_GYRO);
if(device)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);sensor.do_activation=true;return sensor};exports.create_gyro_angles_sensor=function(){var sensor=init_sensor(ST_GYRO_ANGLES,window);sensor.payload=new Float32Array(3);var device=m_input.get_device_by_type_element(m_input.DEVICE_GYRO);if(device)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);sensor.do_activation=true;return sensor};exports.create_gyro_quat_sensor=function(){var sensor=init_sensor(ST_GYRO_QUAT,window);sensor.payload=
m_quat.create();var device=m_input.get_device_by_type_element(m_input.DEVICE_GYRO);if(device)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);sensor.do_activation=true;return sensor};exports.create_hmd_quat_sensor=function(){var sensor=init_sensor(ST_HMD_QUAT,window);sensor.payload=m_quat.create();var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(device)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);sensor.do_activation=true;return sensor};exports.create_hmd_position_sensor=
function(){var sensor=init_sensor(ST_HMD_POSITION,window);sensor.payload=m_vec3.create();var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(device)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);sensor.do_activation=true;return sensor};exports.create_timeline_sensor=function(){var sensor=init_sensor(ST_TIMELINE);return sensor};exports.create_selection_sensor=function(obj,auto_release){var sensor=init_sensor(ST_SELECTION);sensor.source_object=obj;sensor.auto_release=auto_release;
sensor.do_activation=true;return sensor};exports.create_callback_sensor=function(callback,value){var sensor=init_sensor(ST_CALLBACK);sensor.callback=callback;sensor_set_value(sensor,value);return sensor};exports.sensor_set_value=sensor_set_value;function sensor_set_value(sensor,value){sensor.value=Number(value)}function manifold_logic_result(manifold){var sensors=manifold.sensors;var values=manifold.sensor_values;for(var i=0;i<sensors.length;i++)values[i]=sensors[i].value;var logic_result=manifold.logic_fun(values);
return logic_result}exports.get_sensor_value=function(obj,manifold_id,num){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds||!manifolds[manifold_id]){m_print.error("get_sensor_value(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("get_sensor_value(): sensor not found");return null}return sensor.value};exports.get_sensor_payload=function(obj,manifold_id,num){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds||
!manifolds[manifold_id]){m_print.error("get_sensor_payload(): wrong object");return null}var sensor=manifolds[manifold_id].sensors[num];if(!sensor){m_print.error("get_sensor_payload(): sensor not found");return null}return sensor.payload};function update_sensor(sensor,timeline,elapsed){if(!elapsed)return;switch(sensor.type){case ST_MOTION:var obj=sensor.source_object;var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var dist=m_vec3.dist(sensor.trans_last,
trans);var quat_temp=sensor.quat_temp;m_quat.invert(sensor.quat_last,quat_temp);m_quat.multiply(quat,quat_temp,quat_temp);m_quat.normalize(quat_temp,quat_temp);var angle=Math.abs(2*Math.acos(quat_temp[3]));var linear_vel=dist/elapsed;sensor.avg_linear_vel=m_util.smooth(linear_vel,sensor.avg_linear_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload[0]=linear_vel;var angular_vel=angle/elapsed;sensor.avg_angular_vel=m_util.smooth(angular_vel,sensor.avg_angular_vel,elapsed,SENSOR_SMOOTH_PERIOD);sensor.payload[1]=
angular_vel;if(sensor.avg_linear_vel>=sensor.threshold||sensor.avg_angular_vel>=sensor.rotation_threshold)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);m_vec3.copy(trans,sensor.trans_last);m_quat.copy(quat,sensor.quat_last);sensor.time_last=timeline;break;case ST_V_VELOCITY:var obj=sensor.source_object;var trans=m_tsr.get_trans_view(obj.render.world_tsr);var vel=Math.abs(trans[1]-sensor.trans_last[1])/elapsed;sensor.avg_vertical_vel=m_util.smooth(vel,sensor.avg_vertical_vel,elapsed,SENSOR_SMOOTH_PERIOD);
sensor.payload=vel;if(sensor.avg_vertical_vel>=sensor.threshold)sensor_set_value(sensor,1);else sensor_set_value(sensor,0);m_vec3.copy(trans,sensor.trans_last);sensor.time_last=timeline;break;case ST_TIMER:if(!sensor.do_activation&&sensor.period>=0&&timeline-sensor.time_last>=sensor.period){sensor_set_value(sensor,1);if(sensor.repeat)sensor.time_last=timeline;else sensor.period=-sensor.period}break;case ST_ELAPSED:if(!sensor.time_last)sensor.time_last=timeline;sensor_set_value(sensor,timeline-sensor.time_last);
sensor.time_last=timeline;break;case ST_TIMELINE:sensor_set_value(sensor,timeline);break;case ST_GYRO_DELTA:var accum=get_accumulator(sensor.element);sensor.payload[0]=accum.gyro_gamma_new-accum.gyro_gamma_last;sensor.payload[1]=accum.gyro_beta_new-accum.gyro_beta_last;sensor.payload[2]=accum.gyro_alpha_new-accum.gyro_alpha_last;break;case ST_GYRO_ANGLES:var accum=get_accumulator(sensor.element);sensor.payload[0]=accum.gyro_gamma_new;sensor.payload[1]=accum.gyro_beta_new;sensor.payload[2]=accum.gyro_alpha_new;
break;case ST_GYRO_QUAT:var accum=get_accumulator(sensor.element);m_quat.copy(accum.gyro_quat,sensor.payload);break;case ST_HMD_QUAT:var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);m_input.get_vector_param(device,m_input.HMD_ORIENTATION_QUAT,sensor.payload);break;case ST_HMD_POSITION:var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);m_input.get_vector_param(device,m_input.HMD_POSITION,sensor.payload);break;case ST_GAMEPAD_BTNS:var device=get_gmpd_device_by_id(sensor.gamepad_id);
sensor.value=m_input.get_gamepad_btn_value(device,sensor.key);break;case ST_GMPD_AXIS:var device=get_gmpd_device_by_id(sensor.gamepad_id);sensor.value=m_input.get_gamepad_axis_value(device,sensor.key);break;case ST_CALLBACK:sensor_set_value(sensor,sensor.callback());break;case ST_MOUSE_WHEEL:var accum=get_accumulator(sensor.element);sensor_set_value(sensor,accum.wheel_delta);break;case ST_MOUSE_MOVE:var accum=get_accumulator(sensor.element);if(!cfg_dft.ie11_edge_touchscreen_hack||accum.is_mouse_downed){var delta_x=
accum.mouse_curr_x-accum.mouse_last_x;var delta_y=accum.mouse_curr_y-accum.mouse_last_y;switch(sensor.axis){case "X":sensor_set_value(sensor,delta_x);sensor.payload=accum.mouse_curr_x;break;case "Y":sensor_set_value(sensor,delta_y);sensor.payload=accum.mouse_curr_y;break;case "XY":var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);sensor_set_value(sensor,delta);sensor.payload[0]=accum.mouse_curr_x;sensor.payload[1]=accum.mouse_curr_y;break}}break;case ST_MOUSE_CLICK:var accum=get_accumulator(sensor.element);
sensor_set_value(sensor,accum.is_mouse_downed);sensor.payload=accum.which;break;case ST_SELECTION:var accum=get_accumulator(sensor.element);if(sensor.auto_release&&!accum.is_mouse_downed&&accum.is_touch_ended||accum.selected_obj!=sensor.source_object)sensor_set_value(sensor,0);else sensor_set_value(sensor,1);break;case ST_KEYBOARD:var accum=get_accumulator(sensor.element);sensor.payload=accum.downed_keys[sensor.key];if(sensor.payload==1||accum.downed_keys[0]&&sensor.key==KEY_SHIFT)sensor_set_value(sensor,
1);else if(!sensor.payload||sensor.payload==3)sensor_set_value(sensor,0);break;case ST_TOUCH_MOVE:var accum=get_accumulator(sensor.element);if(accum.touches_curr_x[1]==-1&&accum.touches_curr_y[1]==-1){var delta_x=accum.touches_curr_x[0]-accum.touches_last_x[0];var delta_y=accum.touches_curr_y[0]-accum.touches_last_y[0];var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);if(accum.touches_last_x[1]!=-1&&accum.touches_last_y[1]!=-1){var delta_second_x=accum.touches_curr_x[0]-accum.touches_last_x[1];
var delta_second_y=accum.touches_curr_y[0]-accum.touches_last_y[1];var delta_second=Math.sqrt(delta_second_x*delta_second_x+delta_second_y*delta_second_y);if(delta_second<delta){delta_x=delta_second_x;delta_y=delta_second_y;delta=delta_second}}sensor.payload=exports.PL_SINGLE_TOUCH_MOVE}else{var cur_center=_vec2_tmp;cur_center[0]=(accum.touches_curr_x[0]+accum.touches_curr_x[1])/2;cur_center[1]=(accum.touches_curr_y[0]+accum.touches_curr_y[1])/2;var last_center=_vec2_tmp2;last_center[0]=(accum.touches_last_x[0]+
accum.touches_last_x[1])/2;last_center[1]=(accum.touches_last_y[0]+accum.touches_last_y[1])/2;var delta_x=cur_center[0]-last_center[0];var delta_y=cur_center[1]-last_center[1];var delta=Math.sqrt(delta_x*delta_x+delta_y*delta_y);sensor.payload=exports.PL_MULTITOUCH_MOVE_PAN}switch(sensor.axis){case "X":sensor_set_value(sensor,delta_x);break;case "Y":sensor_set_value(sensor,delta_y);break;case "XY":sensor_set_value(sensor,delta);break}break;case ST_TOUCH_ZOOM:var accum=get_accumulator(sensor.element);
var delta_dist=accum.touch_zoom_curr_dist-accum.touch_zoom_last_dist;sensor.payload=exports.PL_MULTITOUCH_MOVE_ZOOM;sensor_set_value(sensor,delta_dist);break;case ST_TOUCH_ROTATE:var accum=get_accumulator(sensor.element);if(accum.touches_curr_x[1]!=-1){var x=accum.touches_curr_x[0]-accum.touches_curr_x[1],y=accum.touches_curr_y[0]-accum.touches_curr_y[1];var delta_rotation=Math.atan2(y,x);sensor.payload=exports.PL_MULTITOUCH_MOVE_ROTATE;sensor_set_value(sensor,delta_rotation-accum.touch_start_rot)}break;
case ST_TOUCH_CLICK:var accum=get_accumulator(sensor.element);if(accum.is_touch_ended)sensor_set_value(sensor,0);else sensor_set_value(sensor,1);break;default:break}}function manifold_gen_pulse(manifold){var pulse=0;switch(manifold.type){case exports.CT_POSITIVE:var logic_result=manifold_logic_result(manifold);if(logic_result)pulse=1;else pulse=0;break;case exports.CT_CONTINUOUS:var last_pulse=manifold.last_pulse;var logic_result=manifold_logic_result(manifold);if(logic_result){pulse=1;manifold.last_pulse=
1}else if(last_pulse==1){pulse=-1;manifold.last_pulse=-1}else pulse=0;break;case exports.CT_TRIGGER:var last_pulse=manifold.last_pulse;var logic_result=manifold_logic_result(manifold);if(logic_result&&last_pulse==-1){pulse=1;manifold.last_pulse=1}else if(!logic_result&&last_pulse==1){pulse=-1;manifold.last_pulse=-1}else pulse=0;break;case exports.CT_SHOT:var last_pulse=manifold.last_pulse;var logic_result=manifold_logic_result(manifold);if(logic_result&&last_pulse==-1){pulse=1;manifold.last_pulse=
1}else if(!logic_result&&last_pulse==1){pulse=0;manifold.last_pulse=-1}else pulse=0;break;case exports.CT_LEVEL:var logic_result=manifold_logic_result(manifold);if(manifold.last_logic_result!=logic_result){pulse=1;manifold.last_logic_result=logic_result}else pulse=0;break;case exports.CT_CHANGE:var sensors=manifold.sensors;var last_values=manifold.last_sensor_values;for(var i=0;i<sensors.length;i++){var value=sensors[i].value;if(!pulse&&value!=last_values[i])pulse=1;last_values[i]=value}break;default:m_util.panic("Wrong sensor manifold type: "+
manifold.type);break}return pulse}function discharge_sensors(sensors){for(var i=0;i<sensors.length;i++){var sensor=sensors[i];switch(sensor.type){case ST_MOUSE_WHEEL:sensor_set_value(sensor,0);break;case ST_MOUSE_MOVE:sensor_set_value(sensor,0);break;case ST_TOUCH_MOVE:sensor_set_value(sensor,0);break;case ST_TOUCH_ZOOM:sensor_set_value(sensor,0);break;case ST_TOUCH_ROTATE:sensor_set_value(sensor,0);break;case ST_TOUCH_CLICK:sensor_set_value(sensor,0);break;case ST_TIMER:sensor_set_value(sensor,0);
break;default:break}}}exports.cleanup=function(){_objects=[];_global_object={};for(var i=0;i<_sensors_cache.length;i++)deactivate_sensor(_sensors_cache[i]);_sensors_cache.length=0;_manifolds_cache.length=0};exports.check_sensor_manifold=function(obj,id){obj=obj||_global_object;if(!obj.sensor_manifolds)return false;if(id&&obj.sensor_manifolds[id])return true;else if(id)return false;else for(var i in obj.sensor_manifolds)return true;return false};exports.create_sensor_manifold=function(obj,id,type,
sensors,logic_fun,callback,callback_param){obj=obj||_global_object;obj.sensor_manifolds_arr=obj.sensor_manifolds_arr||[];obj.sensor_manifolds=obj.sensor_manifolds||{};var manifolds=obj.sensor_manifolds;var manifolds_arr=obj.sensor_manifolds_arr;var old_manifold=manifolds[id];if(old_manifold)remove_sensor_manifold(obj,id);var manifold={id:id,type:type,sensors:sensors.slice(0),logic_fun:logic_fun,sensor_values:new Array(sensors.length),callback:callback,callback_param:callback_param,last_pulse:-1,last_logic_result:0,
last_sensor_values:new Array(sensors.length),update_counter:-1};manifolds[id]=manifold;manifolds_arr.push(manifold);if(_objects.indexOf(obj)==-1)_objects.push(obj);var sensors=manifold.sensors;for(var i=0;i<sensors.length;i++){var sensor=sensors[i];activate_sensor(sensor);var sens_ind=_sensors_cache.indexOf(sensor);if(sens_ind==-1){_sensors_cache.push(sensor);_manifolds_cache.push([manifold])}else _manifolds_cache[sens_ind].push(manifold)}_manifolds_updated=true};exports.default_AND_logic_fun=default_AND_logic_fun;
function default_AND_logic_fun(s){for(var i=0;i<s.length;i++)if(!s[i])return s[i];return s[s.length-1]}exports.default_OR_logic_fun=function(s){for(var i=0;i<s.length;i++)if(s[i])return s[i];return s[s.length-1]};function activate_sensor(sensor){if(sensor.do_activation){switch(sensor.type){case ST_COLLISION:m_phy.append_collision_test(sensor.collision_obj,sensor.collision_id,sensor.collision_cb,sensor.calc_pos_norm);break;case ST_COLLISION_IMPULSE:m_phy.apply_collision_impulse_test(sensor.col_imp_obj,
sensor.col_imp_cb);break;case ST_RAY:sensor.ray_test_id=m_phy.append_ray_test(sensor.source_object,sensor.from,sensor.to,sensor.collision_id,sensor.ray_test_cb,false,false,sensor.calc_pos_norm,sensor.ign_src_rot);sensor.payload.ray_test_id=sensor.ray_test_id;break;case ST_TIMER:sensor.time_last=m_time.get_timeline();if(sensor.period<0)sensor.period=-sensor.period;break;case ST_KEYBOARD:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"keyboard_downed_keys");break;case ST_MOUSE_WHEEL:var accumulator=
get_accumulator(sensor.element);register_accum_value(accumulator,"mouse_wheel");break;case ST_MOUSE_MOVE:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"mouse_down_which");register_accum_value(accumulator,"mouse_up_which");register_accum_value(accumulator,"mouse_location");break;case ST_MOUSE_CLICK:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"mouse_down_which");register_accum_value(accumulator,"mouse_up_which");break;case ST_TOUCH_MOVE:var accumulator=
get_accumulator(sensor.element);register_accum_value(accumulator,"touch_start");register_accum_value(accumulator,"touch_move");register_accum_value(accumulator,"touch_end");break;case ST_TOUCH_ZOOM:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"touch_start");register_accum_value(accumulator,"touch_move");break;case ST_TOUCH_ROTATE:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"touch_start");register_accum_value(accumulator,"touch_move");
break;case ST_TOUCH_CLICK:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"touch_start");register_accum_value(accumulator,"touch_end");break;case ST_SELECTION:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"mouse_select");register_accum_value(accumulator,"touch_select");register_accum_value(accumulator,"touch_start");register_accum_value(accumulator,"touch_end");register_accum_value(accumulator,"mouse_down_which");register_accum_value(accumulator,
"mouse_up_which");break;case ST_GYRO_DELTA:case ST_GYRO_ANGLES:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"orientation_angles");break;case ST_GYRO_QUAT:var accumulator=get_accumulator(sensor.element);register_accum_value(accumulator,"orientation_quat");break;case ST_GAMEPAD_BTNS:if(sensor.gamepad_id==0)m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD0);else if(sensor.gamepad_id==1)m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD1);else if(sensor.gamepad_id==
2)m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD2);else m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD3);break}sensor.do_activation=false}}exports.remove_sensor_manifold=remove_sensor_manifold;function remove_sensor_manifold(obj,id){obj=obj||_global_object;var manifolds=obj.sensor_manifolds;if(!manifolds)return;var manifolds_arr=obj.sensor_manifolds_arr;if(id){var manifold=manifolds[id];if(manifold){var sensors=manifold.sensors;for(var i=0;i<sensors.length;i++){var sensor=sensors[i];
var sens_users=get_sensor_users(sensor,_sensors_cache,_manifolds_cache);if(sens_users.length==1){deactivate_sensor(sensor);var sens_ind=_sensors_cache.indexOf(sensor);if(sens_ind>-1){_sensors_cache.splice(sens_ind,1);_manifolds_cache.splice(sens_ind,1)}else m_util.panic("Sensors cache is corrupted")}else if(sens_users.length>1)sens_users.splice(sens_users.indexOf(manifold),1)}delete manifolds[id];var man_index=manifolds_arr.indexOf(manifold);if(man_index>-1)manifolds_arr.splice(man_index,1);else m_util.panic("Incorrect manifolds array");
if(!Object.getOwnPropertyNames(manifolds).length)remove_from_objects(obj)}}else{var removed_ids=[];for(var id in manifolds)removed_ids.push(id);for(var i=0;i<removed_ids.length;i++)remove_sensor_manifold(obj,removed_ids[i])}_manifolds_updated=true}function remove_from_objects(obj){var obj_index=_objects.indexOf(obj);if(obj_index>-1)_objects.splice(obj_index,1);else{m_print.error("Wrong object");return}}function get_sensor_users(sensor,sensors_cache,manifolds_cache){var sens_ind=sensors_cache.indexOf(sensor);
if(sens_ind>-1)return manifolds_cache[sens_ind];else return[]}function deactivate_sensor(sensor){switch(sensor.type){case ST_COLLISION:m_phy.remove_collision_test(sensor.collision_obj,sensor.collision_id,sensor.collision_cb);sensor.do_activation=true;break;case ST_COLLISION_IMPULSE:m_phy.clear_collision_impulse_test(sensor.col_imp_obj);sensor.do_activation=true;break;case ST_RAY:m_phy.remove_ray_test(sensor.ray_test_id);sensor.do_activation=true;break;case ST_TIMER:sensor.do_activation=true;break;
case ST_KEYBOARD:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"keyboard_downed_keys");sensor.do_activation=true;break;case ST_MOUSE_WHEEL:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"mouse_wheel");sensor.do_activation=true;break;case ST_MOUSE_MOVE:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"mouse_down_which");unregister_accum_value(accumulator,"mouse_up_which");unregister_accum_value(accumulator,
"mouse_location");sensor.do_activation=true;break;case ST_MOUSE_CLICK:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"mouse_down_which");unregister_accum_value(accumulator,"mouse_up_which");sensor.do_activation=true;break;case ST_TOUCH_MOVE:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"touch_start");unregister_accum_value(accumulator,"touch_move");unregister_accum_value(accumulator,"touch_end");sensor.do_activation=true;break;
case ST_TOUCH_ZOOM:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"touch_start");unregister_accum_value(accumulator,"touch_move");sensor.do_activation=true;break;case ST_TOUCH_ROTATE:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"touch_start");unregister_accum_value(accumulator,"touch_move");sensor.do_activation=true;break;case ST_TOUCH_CLICK:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,
"touch_start");unregister_accum_value(accumulator,"touch_end");sensor.do_activation=true;break;case ST_SELECTION:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"mouse_select");unregister_accum_value(accumulator,"touch_select");unregister_accum_value(accumulator,"touch_start");unregister_accum_value(accumulator,"touch_end");unregister_accum_value(accumulator,"mouse_down_which");unregister_accum_value(accumulator,"mouse_up_which");sensor.do_activation=true;break;
case ST_GYRO_DELTA:case ST_GYRO_ANGLES:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"orientation_angles");sensor.do_activation=true;break;case ST_GYRO_QUAT:var accumulator=get_accumulator(sensor.element);unregister_accum_value(accumulator,"orientation_quat");sensor.do_activation=true;break;case ST_HMD_QUAT:case ST_HMD_POSITION:sensor.do_activation=true;break}}exports.reset=function(){for(var i=0;i<_objects.length;i++){var obj=_objects[i];var manifolds=obj.sensor_manifolds;
var manifolds_arr=obj.sensor_manifolds_arr;for(var j in manifolds)delete manifolds[j];manifolds_arr.length=0}for(var i=0;i<_sensors_cache.length;i++)deactivate_sensor(_sensors_cache[i]);_objects.length=0;_sensors_cache.length=0;_manifolds_cache.length=0};exports.debug=function(){m_print.log(String(_objects.length)+" objects with manifolds",_objects);m_print.log(String(_sensors_cache.length)+" sensors",_sensors_cache);var collisions=[];var rays=[];for(var i=0;i<_sensors_cache.length;i++){var sensor=
_sensors_cache[i];if(sensor.type==ST_COLLISION)collisions.push(sensor);if(sensor.type==ST_RAY)rays.push(sensor)}m_print.log(String(collisions.length)+" collision sensors",collisions);m_print.log(String(rays.length)+" ray sensors",rays)};function touch_zoom_dist(touches){var touch1=touches[0];var touch2=touches[1];var x=touch1.clientX-touch2.clientX,y=touch1.clientY-touch2.clientY;return Math.sqrt(x*x+y*y)}function touch_rotation(touches){var touch1=touches[0];var touch2=touches[1];var x=touch1.clientX-
touch2.clientX,y=touch1.clientY-touch2.clientY;return Math.atan2(y,x)}function get_gmpd_device_by_id(gamepad_id){if(gamepad_id==0)var device=m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD0);else if(gamepad_id==1)var device=m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD1);else if(gamepad_id==2)var device=m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD2);else var device=m_input.get_device_by_type_element(m_input.DEVICE_GAMEPAD3);return device}};b4w.module["__curve"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var m_vec3=require("__vec3");var SPLINE_POINTS=1E3;exports.create_spline=function(bpy_obj){var spline={};var bpy_curve=bpy_obj["data"];var bpy_spline=bpy_curve["splines"][0];if(!(bpy_spline&&bpy_spline["type"]=="NURBS"&&bpy_spline["use_endpoint_u"]))return null;var order=bpy_spline["order_u"];spline.order=order;var points=bpy_spline["points"];var knot=gen_open_knot(points.length/5,order,[]);
spline.knot=knot;if(bpy_curve["dimensions"]=="2D")spline.is_3d=false;else if(bpy_curve["dimensions"]=="3D")spline.is_3d=true;else throw"Wrong curve dimensions";var cpoints=[];var weights=[];for(var i=0;i<points.length;i+=5){cpoints.push(points[i]);cpoints.push(points[i+1]);cpoints.push(points[i+2]);if(spline.is_3d)cpoints.push(points[i+3]);weights.push(points[i+4])}spline.cpoints=cpoints;spline.weights=weights;var points=spline_points(spline,SPLINE_POINTS,[]);var ncoords=spline.is_3d?4:3;var clen=
new Float32Array(SPLINE_POINTS);clen[0]=0;for(var i=1;i<SPLINE_POINTS;i+=1){var x0=points[(i-1)*ncoords];var y0=points[(i-1)*ncoords+1];var z0=points[(i-1)*ncoords+2];var x=points[i*ncoords];var y=points[i*ncoords+1];var z=points[i*ncoords+2];var len=Math.sqrt((x-x0)*(x-x0)+(y-y0)*(y-y0)+(z-z0)*(z-z0));clen[i]=clen[i-1]+len}spline.cumulative_length=clen;return spline};function gen_open_knot(n,order,dest){if(!dest)var dest=[];var nplusorder=n+order;var nplus2=n+2;dest[0]=0;for(var i=2;i<=nplusorder;i++)if(i>
order&&i<nplus2)dest[i-1]=dest[i-2]+1;else dest[i-1]=dest[i-2];return dest}function gen_periodic_knot(n,order,dest){if(!dest)var dest=[];var nplusorder=n+order;var nplus2=n+2;dest[0]=0;for(var i=2;i<=nplusorder;i++)dest[i-1]=i-1;return dest}function gen_rational_basis(order,t,knot,weights,r){var n=weights.length;if(!r)var r=new Float32Array(n);var nplusorder=n+order;var temp=new Float32Array(nplusorder);for(var i=1;i<=nplusorder-1;i++)if(t>=knot[i-1]&&t<knot[i+1-1])temp[i-1]=1;else temp[i-1]=0;for(var k=
2;k<=order;k++)for(var i=1;i<=nplusorder-k;i++){if(temp[i-1]!=0)var d=(t-knot[i-1])*temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var d=0;if(temp[i+1-1]!=0)var e=(knot[i+k-1]-t)*temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var e=0;temp[i-1]=d+e}if(t==knot[nplusorder-1])temp[n-1]=1;var sum=0;for(var i=1;i<=n;i++)sum=sum+temp[i-1]*weights[i-1];for(var i=1;i<=n;i++)if(sum!=0)r[i-1]=temp[i-1]*weights[i-1]/sum;else r[i-1]=0;return r}function gen_rational_dbasis(order,t,knot,weights,rd){var num=weights.length;
if(!rd)var rd=new Float32Array(num);var n=new Float32Array(num);var d=new Float32Array(num);gen_basis_d(num,order,t,knot,n,d);var sum=0;for(var i=1;i<=num;i++)sum=sum+n[i-1]*weights[i-1];var dsum=0;for(var i=1;i<=num;i++)dsum=dsum+d[i-1]*weights[i-1];for(var i=1;i<=num;i++)if(sum!=0){var rd1=d[i-1]*weights[i-1]/sum;var rd2=n[i-1]*weights[i-1]*dsum/(sum*sum);rd[i-1]=rd1+rd2}else rd[i-1]=0;return rd}function gen_basis_d(num,order,t,knot,n,d){if(!n)var n=new Float32Array(num);if(!d)var d=new Float32Array(num);
var nplusorder=num+order;var temp=new Float32Array(nplusorder);var tempd=new Float32Array(nplusorder);for(var i=1;i<=nplusorder-1;i++)if(t>=knot[i-1]&&t<knot[i+1-1])temp[i-1]=1;else temp[i-1]=0;if(t==knot[nplusorder-1])temp[num-1]=1;for(var k=2;k<=order;k++)for(var i=1;i<=nplusorder-k;i++){if(temp[i-1]!=0)var b1=(t-knot[i-1])*temp[i-1]/(knot[i+k-1-1]-knot[i-1]);else var b1=0;if(temp[i+1-1]!=0)var b2=(knot[i+k-1]-t)*temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var b2=0;if(temp[i-1]!=0)var f1=temp[i-
1]/(knot[i+k-1-1]-knot[i-1]);else var f1=0;if(temp[i+1-1]!=0)var f2=-temp[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var f2=0;if(tempd[i-1]!=0)var f3=(t-knot[i-1])*tempd[i-1]/(knot[i+k-1-1]-knot[i-1]);else var f3=0;if(tempd[i+1-1]!=0)var f4=(knot[i+k-1]-t)*tempd[i+1-1]/(knot[i+k-1]-knot[i+1-1]);else var f4=0;temp[i-1]=b1+b2;tempd[i-1]=f1+f2+f3+f4}for(var i=1;i<=num;i++){n[i-1]=temp[i-1];d[i-1]=tempd[i-1]}return n}function spline_points(spline,num,dest){if(!dest)var dest=[];var cpoints=spline.cpoints;var ncoords=
spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;var t=0;var step=knot[nplusorder-1]/(num-1);var icount=0;for(var i=0;i<num;i++){if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var basis=gen_rational_basis(order,t,knot,weights);for(var j=0;j<ncoords;j++){dest[ncoords*i+j]=0;for(var k=0;k<n;k++){var temp=basis[k]*cpoints[ncoords*k+j];dest[ncoords*i+j]+=temp}}t=t+step}return dest}exports.spline_point=function(spline,
t,dest){if(!dest)var dest=[];var t=clamped_t(spline,t);var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var basis=new Float32Array(n);gen_rational_basis(order,t,knot,weights,basis);for(var i=0;i<ncoords;i++){dest[i]=0;for(var j=0;j<n;j++)dest[i]+=basis[j]*cpoints[ncoords*j+i]}return dest};function clamped_t(spline,t){var t_clamped=
Math.max(t,0);var max_t=spline_max_t(spline);t_clamped=Math.min(t,max_t);return t_clamped}exports.spline_derivative=function(spline,t,dest){if(!dest)var dest=[];var cpoints=spline.cpoints;var ncoords=spline.is_3d?4:3;var weights=spline.weights;var knot=spline.knot;var order=spline.order;var n=cpoints.length/ncoords;var nplusorder=n+order;if(knot[nplusorder-1]-t<5E-6)t=knot[nplusorder-1];var dbasis=new Float32Array(n);gen_rational_dbasis(order,t,knot,weights,dbasis);for(var i=0;i<ncoords;i++){dest[i]=
0;for(var j=0;j<n;j++)dest[i]+=dbasis[j]*cpoints[ncoords*j+i]}return dest};exports.spline_max_t=spline_max_t;function spline_max_t(spline){var knot=spline.knot;return knot[knot.length-1]}exports.spline_length=spline_length;function spline_length(spline){var clen=spline.cumulative_length;return clen[clen.length-1]}exports.spline_len_to_t=function(spline,len){if(len<=0)return 0;var max_t=spline_max_t(spline);if(len>=spline_length(spline))return max_t;var clen=spline.cumulative_length;var index=m_util.binary_search_max(clen,
len,0,clen.length-1);var index_float=index+(len-clen[index])/(clen[index+1]-clen[index]);var t=max_t*index_float/SPLINE_POINTS;return t};exports.linear_interpolation=function(y1,x1,y0,x0,x){return y0+(x-x0)*(y1-y0)/(x1-x0)};exports.linear=function(x,v1,v4){var x1=v1[0],y1=v1[1],x2=v4[0],y2=v4[1];var k=(y2-y1)/(x2-x1);var b=y1-k*x1;return k*x+b};exports.bezier=function(x,v1,v2,v3,v4,precision){var t=bezier_find_root(0,1,x,v1[0],v2[0],v3[0],v4[0],precision);var y=bezier_parametric(t,v1[1],v2[1],v3[1],
v4[1]);return y};function bezier_find_root(t0_so_far,t1_so_far,x_needed,x0,x1,x2,x3,precision){var t=t0_so_far+(t1_so_far-t0_so_far)/2;var x=bezier_parametric(t,x0,x1,x2,x3);var dx=x-x_needed;var precision=precision?precision:.01;if(Math.abs(dx)<precision)return t;if(dx>0)return bezier_find_root(t0_so_far,t,x_needed,x0,x1,x2,x3,precision);else return bezier_find_root(t,t1_so_far,x_needed,x0,x1,x2,x3,precision)}function bezier_parametric(t,p0,p1,p2,p3){var t1=1-t;return p0*t1*t1*t1+3*p1*t1*t1*t+3*
p2*t1*t*t+p3*t*t*t}exports.calchandle_curvemap=function(bezt,prev,next,h1,h2){var p1=new Float32Array(3);var p2=new Float32Array(3);var p3=new Float32Array(3);var dvec_a=new Float32Array(3);var dvec_b=new Float32Array(3);var tvec=new Float32Array(3);m_vec3.copy(bezt[1],p2);if(prev==null){m_vec3.copy(next[1],p3);p1[0]=2*p2[0]-p3[0];p1[1]=2*p2[1]-p3[1]}else m_vec3.copy(prev[1],p1);if(next==null){m_vec3.copy(prev[1],p1);p3[0]=2*p2[0]-p1[0];p3[1]=2*p2[1]-p1[1]}else m_vec3.copy(next[1],p3);m_vec3.subtract(p2,
p1,dvec_a);m_vec3.subtract(p3,p2,dvec_b);var len_a=m_vec3.length(dvec_a);var len_b=m_vec3.length(dvec_b);if(len_a==0)len_a=1;if(len_b==0)len_b=1;if(h1=="AUTO"||h2=="AUTO"){tvec[0]=dvec_b[0]/len_b+dvec_a[0]/len_a;tvec[1]=dvec_b[1]/len_b+dvec_a[1]/len_a;var len=m_vec3.length(tvec)*2.5614;if(len!=0){if(h1=="AUTO"){len_a/=len;m_vec3.scaleAndAdd(p2,tvec,-len_a,bezt[0])}if(h2=="AUTO"){len_b/=len;m_vec3.scaleAndAdd(p2,tvec,len_b,bezt[2])}}}if(h1=="VECTOR")m_vec3.scaleAndAdd(p2,dvec_a,-1/3,bezt[0]);if(h2==
"VECTOR")m_vec3.scaleAndAdd(p2,dvec_b,1/3,bezt[2])};exports.correct_bezpart=function(v1,v2,v3,v4){var h1=[];var h2=[];var len1,len2,len,fac;h1[0]=v1[0]-v2[0];h1[1]=v1[1]-v2[1];h2[0]=v4[0]-v3[0];h2[1]=v4[1]-v3[1];len=v4[0]-v1[0];len1=Math.abs(h1[0]);len2=Math.abs(h2[0]);if(len1+len2==0)return;if(len1+len2>len){fac=len/(len1+len2);v2[0]=v1[0]-fac*h1[0];v2[1]=v1[1]-fac*h1[1];v3[0]=v4[0]-fac*h2[0];v3[1]=v4[1]-fac*h2[1]}}};b4w.module["__dds"]=function(exports,require){var m_print=require("__print");var DDS_MAGIC=542327876;var DDSD_CAPS=1,DDSD_HEIGHT=2,DDSD_WIDTH=4,DDSD_PITCH=8,DDSD_PIXELFORMAT=4096,DDSD_MIPMAPCOUNT=131072,DDSD_LINEARSIZE=524288,DDSD_DEPTH=8388608;var DDSCAPS_COMPLEX=8,DDSCAPS_MIPMAP=4194304,DDSCAPS_TEXTURE=4096;var DDSCAPS2_CUBEMAP=512,DDSCAPS2_CUBEMAP_POSITIVEX=1024,DDSCAPS2_CUBEMAP_NEGATIVEX=2048,DDSCAPS2_CUBEMAP_POSITIVEY=4096,DDSCAPS2_CUBEMAP_NEGATIVEY=8192,DDSCAPS2_CUBEMAP_POSITIVEZ=16384,DDSCAPS2_CUBEMAP_NEGATIVEZ=
32768,DDSCAPS2_VOLUME=2097152;var DDPF_ALPHAPIXELS=1,DDPF_ALPHA=2,DDPF_FOURCC=4,DDPF_RGB=64,DDPF_YUV=512,DDPF_LUMINANCE=131072;var FOURCC_DXT1=fourcc_to_int32("DXT1");var FOURCC_DXT3=fourcc_to_int32("DXT3");var FOURCC_DXT5=fourcc_to_int32("DXT5");var HEADER_LENGTH_INT=31;var OFFSET_MAGIC=0;var OFFSET_SIZE=1;var OFFSET_FLAGS=2;var OFFSET_HEIGHT=3;var OFFSET_WIDTH=4;var OFFSET_MIPMAPCOUNT=7;var OFFSET_PF_FLAGS=20;var OFFSET_PF_FOUR_CC=21;exports.dxt_to_rgb_565=dxt_to_rgb_565;function dxt_to_rgb_565(src,
src16Offset,width,height){var c=new Uint16Array(4);var dst=new Uint16Array(width*height);var nWords=width*height/4;var m=0;var dstI=0;var i=0;var r0=0,g0=0,b0=0,r1=0,g1=0,b1=0;var blockWidth=width/4;var blockHeight=height/4;for(var blockY=0;blockY<blockHeight;blockY++)for(var blockX=0;blockX<blockWidth;blockX++){i=src16Offset+4*(blockY*blockWidth+blockX);c[0]=src[i];c[1]=src[i+1];r0=c[0]&31;g0=c[0]&2016;b0=c[0]&63488;r1=c[1]&31;g1=c[1]&2016;b1=c[1]&63488;c[2]=5*r0+3*r1>>3|5*g0+3*g1>>3&2016|5*b0+3*
b1>>3&63488;c[3]=5*r1+3*r0>>3|5*g1+3*g0>>3&2016|5*b1+3*b0>>3&63488;m=src[i+2];dstI=blockY*4*width+blockX*4;dst[dstI]=c[m&3];dst[dstI+1]=c[m>>2&3];dst[dstI+2]=c[m>>4&3];dst[dstI+3]=c[m>>6&3];dstI+=width;dst[dstI]=c[m>>8&3];dst[dstI+1]=c[m>>10&3];dst[dstI+2]=c[m>>12&3];dst[dstI+3]=c[m>>14];m=src[i+3];dstI+=width;dst[dstI]=c[m&3];dst[dstI+1]=c[m>>2&3];dst[dstI+2]=c[m>>4&3];dst[dstI+3]=c[m>>6&3];dstI+=width;dst[dstI]=c[m>>8&3];dst[dstI+1]=c[m>>10&3];dst[dstI+2]=c[m>>12&3];dst[dstI+3]=c[m>>14]}return dst}
exports.upload_dds_levels=upload_dds_levels;function upload_dds_levels(gl,ext,arrayBuffer,loadMipmaps){var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT),fourCC,blockBytes,internalFormat,width,height,dataLength,dataOffset,rgb565Data,byteArray,mipmapCount,i;if(header[OFFSET_MAGIC]!=DDS_MAGIC){m_print.error("Invalid magic number in DDS header");return 0}if(!header[OFFSET_PF_FLAGS]&DDPF_FOURCC){m_print.error("Unsupported format, must contain a FourCC code");return 0}fourCC=header[OFFSET_PF_FOUR_CC];
switch(fourCC){case FOURCC_DXT1:blockBytes=8;internalFormat=ext?ext.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case FOURCC_DXT3:blockBytes=16;internalFormat=ext?ext.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case FOURCC_DXT5:blockBytes=16;internalFormat=ext?ext.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:m_print.error("Unsupported FourCC code:",int32_to_fourcc(fourCC));return null}mipmapCount=1;if(header[OFFSET_FLAGS]&DDSD_MIPMAPCOUNT&&loadMipmaps!==false)mipmapCount=Math.max(1,header[OFFSET_MIPMAPCOUNT]);
width=header[OFFSET_WIDTH];height=header[OFFSET_HEIGHT];dataOffset=header[OFFSET_SIZE]+4;if(ext)for(i=0;i<mipmapCount;++i){dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=new Uint8Array(arrayBuffer,dataOffset,dataLength);gl.compressedTexImage2D(gl.TEXTURE_2D,i,internalFormat,width,height,0,byteArray);dataOffset+=dataLength;width=Math.max(width*.5,1);height=Math.max(height*.5,1)}else if(fourCC==FOURCC_DXT1){dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;byteArray=
new Uint16Array(arrayBuffer);rgb565Data=dxt_to_rgb_565(byteArray,dataOffset/2,width,height);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,width,height,0,gl.RGB,gl.UNSIGNED_SHORT_5_6_5,rgb565Data);if(loadMipmaps)gl.generateMipmap(gl.TEXTURE_2D)}else{m_print.error("No manual decoder for",int32_to_fourcc(fourCC),"and no native support");return 0}return mipmapCount}exports.get_width_height=function(arrayBuffer){var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT);return{width:header[OFFSET_WIDTH],height:header[OFFSET_HEIGHT]}};
exports.get_compress_ratio=function(arrayBuffer){var comp_ratio=1;var header=new Int32Array(arrayBuffer,0,HEADER_LENGTH_INT);var fourCC=header[OFFSET_PF_FOUR_CC];switch(fourCC){case FOURCC_DXT1:var comp_ratio=6;break;case FOURCC_DXT3:case FOURCC_DXT5:var comp_ratio=4;break;default:m_print.error("Unsupported FourCC code:",int32_to_fourcc(fourCC));break}return comp_ratio};exports.load_dds_texture_ex=load_dds_texture_ex;function load_dds_texture_ex(gl,ext,src,texture,loadMipmaps,callback){var xhr=new XMLHttpRequest;
xhr.open("GET",src,true);xhr.responseType="arraybuffer";xhr.onload=function(){if(xhr.status==200){gl.bindTexture(gl.TEXTURE_2D,texture);var mipmaps=upload_dds_levels(gl,ext,xhr.response,loadMipmaps);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,mipmaps>1?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)}if(callback)callback(texture)};xhr.send(null);return texture}exports.load_dds_texture=function(gl,ext,src,callback){var texture=gl.createTexture();
load_dds_texture_ex(gl,ext,src,texture,true,callback);return texture};function fourcc_to_int32(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)}function int32_to_fourcc(value){return String.fromCharCode(value&255,value>>8&255,value>>16&255,value>>24&255)}};b4w.module["__debug"]=function(exports,require){var m_compat=require("__compat");var m_cfg=require("__config");var m_ext=require("__extensions");var m_print=require("__print");var m_tex=require("__textures");var m_time=require("__time");var m_util=require("__util");var m_graph=require("__graph");var cfg_def=m_cfg.defaults;var ERRORS={};var RENDER_TIME_SMOOTH_INTERVALS=10;var FAKE_LOAD_INTERVAL=5E3;var FAKE_LOAD_START_PERCENTAGE=0;var FAKE_LOAD_END_PERCENTAGE=100;var _gl=null;var _exec_counters={};
var _telemetry_messages=[];var _depth_only_issue=-1;var _multisample_issue=-1;var _assert_struct_last_obj=null;var _assert_struct_init=false;exports.DV_NONE=0;exports.DV_OPAQUE_WIREFRAME=1;exports.DV_TRANSPARENT_WIREFRAME=2;exports.DV_FRONT_BACK_VIEW=3;exports.DV_DEBUG_SPHERES=4;exports.DV_CLUSTERS_VIEW=5;exports.DV_BATCHES_VIEW=6;exports.setup_context=function(gl){var errors=["INVALID_ENUM","INVALID_VALUE","INVALID_OPERATION","OUT_OF_MEMORY","INVALID_FRAMEBUFFER_OPERATION","CONTEXT_LOST_WEBGL"];
for(var i in errors){var error=errors[i];if(error in gl)ERRORS[gl[error]]=error}_gl=gl};exports.check_gl=function(msg){if(!cfg_def.gl_debug)return;var error=_gl.getError();if(error==_gl.NO_ERROR)return;if(error in ERRORS)m_util.panic("GL Error: "+error+", gl."+ERRORS[error]+" ("+msg+")");else m_util.panic("Unknown GL error: "+error+" ("+msg+")")};exports.check_bound_fb=function(){if(!cfg_def.gl_debug)return true;switch(_gl.checkFramebufferStatus(_gl.FRAMEBUFFER)){case _gl.FRAMEBUFFER_COMPLETE:return true;
case _gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:m_print.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");return false;case _gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:m_print.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");return false;case _gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:m_print.error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");return false;case _gl.FRAMEBUFFER_UNSUPPORTED:m_print.error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");
return false;default:m_print.error("FRAMEBUFFER CHECK FAILED");return false}};exports.check_depth_only_issue=function(){if(_depth_only_issue!=-1)return _depth_only_issue;var framebuffer=_gl.createFramebuffer();_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);var texture=m_tex.create_texture("DEBUG",m_tex.TT_DEPTH);m_tex.resize(texture,1,1);var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,w_target,w_tex,0);if(_gl.checkFramebufferStatus(_gl.FRAMEBUFFER)!=
_gl.FRAMEBUFFER_COMPLETE){_depth_only_issue=true;m_print.warn("depth-only issue was found")}else _depth_only_issue=false;_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return _depth_only_issue};exports.check_multisample_issue=function(){if(_multisample_issue!=-1)return _multisample_issue;var rb=_gl.createRenderbuffer();_gl.bindRenderbuffer(_gl.RENDERBUFFER,rb);_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,cfg_def.msaa_samples,_gl.RGBA8,1,1);var num_samples=_gl.getRenderbufferParameter(_gl.RENDERBUFFER,
_gl.RENDERBUFFER_SAMPLES);if(num_samples!=cfg_def.msaa_samples){_multisample_issue=true;m_print.warn("multisample issue was found: requested "+cfg_def.msaa_samples+", got "+num_samples);if(_gl.getError()==_gl.INVALID_OPERATION)m_print.warn("the error from multisample issue detected, ignoring")}else _multisample_issue=false;_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);return _multisample_issue};exports.check_ff_cubemap_out_of_memory=function(){if(m_compat.check_user_agent("Firefox")&&_gl.getError()==
_gl.OUT_OF_MEMORY){m_print.warn("Firefox/old GPUs cubemap issue was found.");return true}return false};exports.check_shader_compiling=function(shader,shader_id,shader_text){if(!cfg_def.gl_debug)return;if(!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){var ext_ds=cfg_def.allow_shaders_debug_ext&&m_ext.get_debug_shaders();if(ext_ds)var shader_text=ext_ds.getTranslatedShaderSource(shader);shader_text=supply_line_numbers(shader_text);m_print.error("shader compilation failed:\n"+shader_text+"\n"+_gl.getShaderInfoLog(shader)+
" ("+shader_id+")");throw"Engine failed: see above for error messages";}};function supply_line_numbers(text){var lines=text.split("\n");for(var i=0;i<lines.length;i++)lines[i]=i+1+" "+lines[i];text=lines.join("\n");return text}exports.check_shader_linking=function(program,shader_id,vshader,fshader,vshader_text,fshader_text){if(!cfg_def.gl_debug)return;if(!_gl.getProgramParameter(program,_gl.LINK_STATUS)){var ext_ds=cfg_def.allow_shaders_debug_ext&&m_ext.get_debug_shaders();if(ext_ds){var vshader_text=
ext_ds.getTranslatedShaderSource(vshader);var fshader_text=ext_ds.getTranslatedShaderSource(fshader)}vshader_text=supply_line_numbers(vshader_text);fshader_text=supply_line_numbers(fshader_text);m_print.error("shader linking failed:\n"+vshader_text+"\n\n\n"+fshader_text+"\n"+_gl.getProgramInfoLog(program)+" ("+shader_id+")");throw"Engine failed: see above for error messages";}};exports.render_time_start=function(subs){if(!(cfg_def.show_hud_debug_info||subs.type=="PERFORMANCE"))return;var ext=m_ext.get_disjoint_timer_query();
if(ext){var query=ext.createQueryEXT();subs.debug_render_time_queries.push(query);ext.beginQueryEXT(ext.TIME_ELAPSED_EXT,query)}else subs.debug_render_time_queries.push(performance.now())};exports.render_time_stop=function(subs){if(!(cfg_def.show_hud_debug_info||subs.type=="PERFORMANCE"))return;var ext=m_ext.get_disjoint_timer_query();if(ext){ext.endQueryEXT(ext.TIME_ELAPSED_EXT);process_timer_queries(subs)}else{var queries=subs.debug_render_time_queries;var render_time=performance.now()-queries.pop();
if(!subs.debug_render_time)subs.debug_render_time=render_time;else subs.debug_render_time=m_util.smooth(render_time,subs.debug_render_time,1,RENDER_TIME_SMOOTH_INTERVALS)}};exports.process_timer_queries=process_timer_queries;function process_timer_queries(subs){var ext=m_ext.get_disjoint_timer_query();var queries=subs.debug_render_time_queries;for(var i=0;i<queries.length;i++){var query=queries[i];var available=ext.getQueryObjectEXT(query,ext.QUERY_RESULT_AVAILABLE_EXT);var disjoint=_gl.getParameter(ext.GPU_DISJOINT_EXT);
if(available&&!disjoint){var elapsed=ext.getQueryObjectEXT(query,ext.QUERY_RESULT_EXT);var render_time=elapsed/1E6;if(!subs.debug_render_time)subs.debug_render_time=render_time;else subs.debug_render_time=m_util.smooth(render_time,subs.debug_render_time,1,RENDER_TIME_SMOOTH_INTERVALS);queries.splice(i,1);i--}}}exports.exec_count=function(counter){if(counter in _exec_counters)_exec_counters[counter]+=1;else _exec_counters[counter]=1};exports.update=function(){for(var i in _exec_counters){m_print.log(i,
_exec_counters[i]);_exec_counters[i]=0}};exports.fbmsg=function(){var msg=[performance.now()];for(var i=0;i<arguments.length;i++){var arg=arguments[i];if(m_util.is_vector(arg))for(var j=0;j<arg.length;j++)msg.push(arg[j]);else msg.push(arguments[i])}_telemetry_messages.push(msg)};exports.msg=function(){var id_count=1;for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];if(msg[1]==arguments[0])id_count++}var msg=[id_count];for(var i=0;i<arguments.length;i++){var arg=arguments[i];
if(m_util.is_vector(arg))for(var j=0;j<arg.length;j++)msg.push(arg[j]);else msg.push(arguments[i])}_telemetry_messages.push(msg)};var COLORS=["color: #3366FF","color: #CC33FF","color: #FF3366","color: #33FF66","color: #FFCC33"];exports.print_telemetry=function(time){if(!time)time=1;var color_counter=0;var color_by_id={};var start_time_ms=Math.max(0,performance.now()-time*1E3);for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];var time=msg[0];if(time<start_time_ms)continue;
var id=String(msg[1]);if(!color_by_id[id])color_by_id[id]=COLORS[color_counter++%COLORS.length];var color=color_by_id[id];var console_args=["%c"+(time/1E3).toFixed(6),color,id];for(var j=2;j<msg.length;j++)console_args.push(msg[j]);m_print.log.apply(this,console_args)}_telemetry_messages.splice(0)};exports.plot_telemetry=function(time){if(!time)time=1;var msg_by_id={};var start_time_ms=Math.max(0,performance.now()-time*1E3);for(var i=0;i<_telemetry_messages.length;i++){var msg=_telemetry_messages[i];
var time=msg[0];if(time<start_time_ms)continue;for(var j=2;j<msg.length;j++){var id=String(msg[1]);if(msg.length>3)id+="_"+String(j-2);if(!msg_by_id[id])msg_by_id[id]=id+"\n";msg_by_id[id]+=String(time)+" "+msg[j]+"\n"}}var plot_str="";for(var id in msg_by_id)plot_str+=msg_by_id[id]+"\n\n";m_print.log(plot_str);_telemetry_messages.splice(0)};exports.check_browser=function(name){var user_agent=navigator.userAgent.toLowerCase();var check_ua=function(name){if(user_agent.indexOf(name)>-1)return true;
else return false};switch(name.toLowerCase()){case "chrome":return check_ua("mozilla")&&check_ua("applewebkit")&&check_ua("chrome");case "firefox":return check_ua("mozilla")&&check_ua("gecko")&&check_ua("firefox");case "msie":return check_ua("mozilla")&&check_ua("trident")&&check_ua("msie");case "opera":return check_ua("opera")&&check_ua("presto");case "safari":return check_ua("mozilla")&&check_ua("applewebkit")&&check_ua("safari")&&!check_ua("chrome");default:return false}};exports.check_finite=
function(o){if(m_util.is_vector(o)){for(var i=0;i<o.length;i++)if(!isFinite(o[i]))return false;return Boolean(o.length)}else if(!isFinite(o))return false;else return true};exports.assert_cons=function(value,constructor){if(value.constructor!=constructor)m_util.panic("Type assertion failed: value <"+value+"> has type <"+value.constructor+">, required <"+constructor+">")};exports.assert_structure=assert_structure;function assert_structure(obj1,obj2){if(typeof obj1!=typeof obj2)m_util.panic("Structure assertion failed: incompatible types");
if(!(obj1!==null&&obj2!==null&&typeof obj1=="object"))return;for(var i in obj1)if(!(i in obj2))m_util.panic("Structure assertion failed: missing key in the first object: "+i);for(var i in obj2){if(!(i in obj1))m_util.panic("Structure assertion failed: missing key in the second object: "+i);if(typeof obj1[i]!=typeof obj2[i])m_util.panic("Structure assertion failed: incompatible types for key "+i)}}exports.assert_structure_seq=function(obj){if(!_assert_struct_init)_assert_struct_init=true;else assert_structure(obj,
_assert_struct_last_obj);_assert_struct_last_obj=obj};exports.fake_load=function(stageload_cb,interval,start,end,loaded_cb){stageload_cb=stageload_cb||null;if(!stageload_cb)m_util.panic("Stage load callback is undefined");interval=interval||FAKE_LOAD_INTERVAL;start=start||FAKE_LOAD_START_PERCENTAGE;end=end||FAKE_LOAD_END_PERCENTAGE;if(end>100)m_util.panic("Max percentage must be less than 100");if(start<0)m_util.panic("Min percentage must be greater than 0");if(start>end)m_util.panic("Max percentage must be greater than min percentage");
var animator=m_time.animate(start,end,interval,function(e){var rounded_percentage=e.toFixed();stageload_cb(rounded_percentage);if(rounded_percentage==100){m_time.clear_animation(animator);if(loaded_cb)loaded_cb();return}})};exports.nodegraph_to_dot=function(graph,detailed_print){if(detailed_print){var get_data_info=function(attr){var data_info="";switch(attr.type){case "GEOMETRY_UV":data_info="\nuv_layer: "+attr.data.value;break;case "TEXTURE_COLOR":case "TEXTURE_NORMAL":data_info="\ntexture: "+attr.data.value.name+
"\n("+attr.data.value.image.filepath+")";break}if(data_info=="")data_info="\n---";return data_info};var nodes_label_cb=function(id,attr){var node_text=attr.type+"("+attr.name+")";var inputs=attr.inputs;node_text+="\n\nINPUTS:";if(inputs.length)for(var i=0;i<inputs.length;i++){node_text+="\n"+inputs[i].identifier+": ";if(inputs[i].is_linked)node_text+="linked";else node_text+=inputs[i].default_value}else node_text+="\n---";var outputs=attr.outputs;node_text+="\n\nOUTPUTS:";if(outputs.length)for(var i=
0;i<outputs.length;i++){node_text+="\n"+outputs[i].identifier+": ";if(outputs[i].is_linked)node_text+="linked(default "+outputs[i].default_value+")";else node_text+="not used"}else node_text+="\n---";node_text+="\n\nDATA:";node_text+=get_data_info(attr);return node_text};var edges_label_cb=function(id1,id2,attr){var node1=m_graph.get_node_attr(graph,id1);var node2=m_graph.get_node_attr(graph,id2);var out1=node1.outputs[attr[0]];var in2=node2.inputs[attr[1]];return out1.identifier+"\n==>\n"+in2.identifier}}else{var nodes_label_cb=
function(id,attr){return attr.type};var edges_label_cb=function(id1,id2,attr){var node1=m_graph.get_node_attr(graph,id1);var node2=m_graph.get_node_attr(graph,id2);var out1=node1.outputs[attr[0]];var in2=node2.inputs[attr[1]];return out1.identifier+"\n==>\n"+in2.identifier}}return m_graph.debug_dot(graph,nodes_label_cb,edges_label_cb)}};b4w.module["__extensions"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var cfg_def=m_cfg.defaults;var _gl=null;var _ext_cache={};exports.setup_context=function(gl){_gl=gl};exports.get_s3tc=function(){var ext_s3tc=get("WEBGL_compressed_texture_s3tc")||get("WEBKIT_WEBGL_compressed_texture_s3tc")||get("MOZ_WEBGL_compressed_texture_s3tc");return ext_s3tc};exports.get_depth_texture=function(){if(cfg_def.webgl2)return{};var ext_dtex=get("WEBGL_depth_texture")||
get("WEBKIT_WEBGL_depth_texture")||get("MOZ_WEBGL_depth_texture");return ext_dtex};exports.get_aniso=function(){var ext_aniso=get("EXT_texture_filter_anisotropic")||get("WEBKIT_EXT_texture_filter_anisotropic")||get("MOZ_EXT_texture_filter_anisotropic");return ext_aniso};exports.get_debug_shaders=function(){var ext_ds=get("WEBGL_debug_shaders");return ext_ds};exports.get_renderer_info=function(){var ext_ri=get("WEBGL_debug_renderer_info");return ext_ri};exports.get_elem_index_uint=function(){if(cfg_def.webgl2)return{};
var ext_elem_index_uint=get("OES_element_index_uint");return ext_elem_index_uint};exports.get_standard_derivatives=function(){if(cfg_def.webgl2)return null;var ext_standard_derivatives=get("OES_standard_derivatives");return ext_standard_derivatives};exports.get_disjoint_timer_query=function(){var ext=get("EXT_disjoint_timer_query");return ext};function get(name){if(name in _ext_cache)return _ext_cache[name];var ext=_gl.getExtension(name)||null;_ext_cache[name]=ext;if(ext)var color="0a0";else var color=
"a00";m_print.log("%cGET EXTENSION","color: #"+color,name);return ext}exports.cleanup=function(){_ext_cache={}}};b4w.module["__graph"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var NULL_NODE=-1;var NULL=0;var FORWARD_DIR=10;var BACKWARD_DIR=20;var TWO_WAY=30;var _next_pair_cache=[NULL_NODE,NULL_NODE];exports.NULL_NODE=NULL_NODE;exports.FORWARD_DIR=FORWARD_DIR;exports.BACKWARD_DIR=BACKWARD_DIR;exports.TWO_WAY=TWO_WAY;exports.create=function(){var node_edge_arr=arguments;var nodes=[];var edges=[];for(var i=0;i<node_edge_arr.length;i++){var node_edge=node_edge_arr[i];
switch(node_edge.length){case 2:nodes.push(node_edge[0],node_edge[1]);break;case 3:edges.push(node_edge[0],node_edge[1],node_edge[2]);break;default:throw"Wrong graph constructor params";break}}var graph={nodes:nodes,edges:edges};return graph};exports.clone=function(graph,nodes_cb,edges_cb){if(nodes_cb){var nodes=new Array(graph.nodes.length);for(var i=0;i<graph.nodes.length;i+=2){nodes[i]=graph.nodes[i];nodes[i+1]=nodes_cb(graph.nodes[i+1])}}else var nodes=m_util.clone_object_r(graph.nodes);if(edges_cb){var edges=
new Array(graph.edges.length);for(var i=0;i<graph.edges.length;i+=3){edges[i]=graph.edges[i];edges[i+1]=graph.edges[i+1];edges[i+2]=edges_cb(graph.edges[i+2])}}else var edges=m_util.clone_object_r(graph.edges);var graph={nodes:nodes,edges:edges};return graph};exports.create_node_edge_arr=function(nodes_arr,edges_arr){var nodes=[];var edges=[];for(var i=0;i<nodes_arr.length;i++)nodes.push(nodes_arr[i][0],nodes_arr[i][1]);for(var i=0;i<edges_arr.length;i++)edges.push(edges_arr[i][0],edges_arr[i][1],
edges_arr[i][2]);var graph={nodes:nodes,edges:edges};return graph};exports.append_node=append_node;function append_node(graph,id,attr){if(!attr)attr=null;if(has_node(graph,id))throw"Graph already has node with given ID";else graph.nodes.push(id,attr)}exports.has_node=has_node;function has_node(graph,id){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==id)return true;return false}exports.append_edge=append_edge;function append_edge(graph,id1,id2,attr){if(!attr)attr=null;if(!has_node(graph,
id1)||!has_node(graph,id2))throw"Wrong node IDs";else graph.edges.push(id1,id2,attr)}exports.remove_node=remove_node;function remove_node(graph,id){if(!has_node(graph,id))throw"Node not found";var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==id){nodes.splice(i,2);i-=2}}exports.remove_edge=remove_edge;function remove_edge(graph,id1,id2,edge_num){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+
1]==id2){if(edge_num==-1)edges.splice(i,3);else{if(edge_num==count){edges.splice(i,3);break}count++}i-=3}}exports.remove_edge_by_attr=remove_edge_by_attr;function remove_edge_by_attr(graph,id1,id2,attr){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2&&edges[i+2][0]==attr[0]&&edges[i+2][1]==attr[1]){edges.splice(i,3);break}}exports.append_node_attr=function(graph,attr){if(node_by_attr(graph,attr)==NULL_NODE){var node_id=
gen_node_id(graph);append_node(graph,node_id,attr);return node_id}else throw"Non-unique attribute";};exports.replace_edge_attr=function(graph,id1,id2,attr_old,attr_new){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2&&edges[i+2]==attr_old)edges[i+2]=attr_new};exports.append_subgraph=function(subgraph,graph,subgraph_graph_edges,graph_subgraph_edges){subgraph_graph_edges=subgraph_graph_edges||[];graph_subgraph_edges=graph_subgraph_edges||[];var ids_new={};for(var i=
0;i<subgraph.nodes.length;i+=2){var id_sub=subgraph.nodes[i];var attr=subgraph.nodes[i+1];var id_sub_new=gen_node_id(graph);append_node(graph,id_sub_new,attr);ids_new[id_sub]=id_sub_new}for(var i=0;i<subgraph.edges.length;i+=3){var id1_sub_new=ids_new[subgraph.edges[i]];var id2_sub_new=ids_new[subgraph.edges[i+1]];var attr_edge=subgraph.edges[i+2];append_edge(graph,id1_sub_new,id2_sub_new,attr_edge)}for(var i=0;i<subgraph_graph_edges.length;i+=3){var id1_sub_new=ids_new[subgraph_graph_edges[i]];var id2=
subgraph_graph_edges[i+1];var attr_edge=subgraph_graph_edges[i+2];append_edge(graph,id1_sub_new,id2,attr_edge)}for(var i=0;i<graph_subgraph_edges.length;i+=3){var id1=graph_subgraph_edges[i];var id2_sub_new=ids_new[graph_subgraph_edges[i+1]];var attr_edge=graph_subgraph_edges[i+2];append_edge(graph,id1,id2_sub_new,attr_edge)}};exports.gen_node_id=gen_node_id;function gen_node_id(graph){var nodes=graph.nodes;var counter=-1;for(var i=0;i<nodes.length;i+=2)counter=Math.max(counter,nodes[i]);return++counter}
exports.node_by_attr=node_by_attr;function node_by_attr(graph,attr){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i+1]==attr)return nodes[i];return NULL_NODE}exports.append_edge_attr=function(graph,attr_node1,attr_node2,attr_edge){var id1=node_by_attr(graph,attr_node1);var id2=node_by_attr(graph,attr_node2);if(id1!=NULL_NODE&&id2!=NULL_NODE)append_edge(graph,id1,id2,attr_edge);else throw"Attributes not found";};exports.traverse=function(graph,callback){var nodes=graph.nodes;for(var i=
0;i<nodes.length;i+=2)if(callback(nodes[i],nodes[i+1]))break};exports.traverse_edges=function(graph,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(callback(edges[i],edges[i+1],edges[i+2]))break};exports.traverse_inputs=function(graph,node,callback){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){var node_in=edges[i];if(callback(node_in,get_node_attr(graph,node_in),edges[i+2]))return}};exports.traverse_outputs=function(graph,node,callback){var edges=graph.edges;
for(var i=0;i<edges.length;i+=3)if(edges[i]==node){var node_out=edges[i+1];if(callback(node_out,get_node_attr(graph,node_out),edges[i+2]))return}};exports.topsort=topsort;function topsort(graph){var new_nodes=[];var visit_state={};set_unvisited(graph,visit_state);var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(in_edge_count(graph,nodes[i])==0)topsort_iter(graph,nodes[i],visit_state,new_nodes);var new_graph={nodes:new_nodes,edges:graph.edges.slice(0)};return new_graph}function set_unvisited(graph,
visit_state){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)visit_state[nodes[i]]=false}function topsort_iter(graph,node_id,visit_state,new_nodes){if(!visit_state[node_id]){visit_state[node_id]=true;for(var i=0;i<out_edge_count(graph,node_id);i++){var other=get_out_edge(graph,node_id,i);topsort_iter(graph,other,visit_state,new_nodes)}new_nodes.unshift(node_id,get_node_attr(graph,node_id))}}exports.topsort_attr=function(graph){var nodes=topsort(graph).nodes;var result=[];for(var i=0;i<nodes.length;i+=
2)result.push(nodes[i+1]);return result};exports.is_connected=function(graph){};exports.subgraph_node_conn=function(graph,node_id,dir){if(!has_node(graph,node_id))throw"No such node";var visit_state={};set_unvisited(graph,visit_state);subgraph_node_conn_iter(graph,node_id,visit_state,dir);var new_nodes=[];for(var id in visit_state)if(visit_state[id]){var id=Number(id);new_nodes.push(id,get_node_attr(graph,id))}var new_graph={nodes:new_nodes,edges:graph.edges.slice(0)};cleanup_loose_edges(new_graph);
return new_graph};function subgraph_node_conn_iter(graph,node_id,visit_state,dir){if(!visit_state[node_id]){visit_state[node_id]=true;if(dir==FORWARD_DIR||dir==TWO_WAY)for(var i=0;i<out_edge_count(graph,node_id);i++){var other=get_out_edge(graph,node_id,i);subgraph_node_conn_iter(graph,other,visit_state,dir)}if(dir==BACKWARD_DIR||dir==TWO_WAY)for(var i=0;i<in_edge_count(graph,node_id);i++){var other=get_in_edge(graph,node_id,i);subgraph_node_conn_iter(graph,other,visit_state,dir)}}}exports.cleanup_loose_edges=
cleanup_loose_edges;function cleanup_loose_edges(graph){var nodes=graph.nodes;var edges=graph.edges;for(var i=0;i<edges.length;i+=3){var node1=edges[i];var node2=edges[i+1];if(!has_node(graph,node1)||!has_node(graph,node2)){edges.splice(i,3);i-=3}}}exports.get_source_nodes=function(graph){var result=[];var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2){var node=nodes[i];if(!in_edge_count(graph,node))result.push(node)}return result};exports.get_sink_nodes=get_sink_nodes;function get_sink_nodes(graph){var result=
[];var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2){var node=nodes[i];if(!out_edge_count(graph,node))result.push(node)}return result}exports.match=function(graph1,graph2,node_comp,edge_comp){var state={};state.g1=gen_ordered_graph(graph1);state.g2=gen_ordered_graph(graph2);state.node_comp=node_comp||function(attr1,attr2){return attr1==attr2};state.edge_comp=edge_comp||function(attr1,attr2){return attr1==attr2};var n1=node_count(graph1);var n2=node_count(graph2);state.n1=n1;state.n2=n2;state.order=
NULL;state.core_len=state.orig_core_len=0;state.t1both_len=state.t1in_len=state.t1out_len=0;state.t2both_len=state.t2in_len=state.t2out_len=0;state.added_node1=NULL_NODE;state.core_1=Array(n1);state.core_2=Array(n2);state.in_1=new Array(n1);state.in_2=new Array(n2);state.out_1=new Array(n1);state.out_2=new Array(n2);state.share_count=[1];for(var i=0;i<n1;i++){state.core_1[i]=NULL_NODE;state.in_1[i]=0;state.out_1[i]=0}for(var i=0;i<n2;i++){state.core_2[i]=NULL_NODE;state.in_2[i]=0;state.out_2[i]=0}var c1=
new Array(n1);var c2=new Array(n1);var res=match_iter(c1,c2,state);if(res){for(var i=0;i<c1.length;i++){c1[i]=graph1.nodes[2*c1[i]];c2[i]=graph2.nodes[2*c2[i]]}return[c1,c2]}else return null};function node_count(graph){return graph.nodes.length/2}function gen_ordered_graph(graph){var nodes=graph.nodes;var edges=graph.edges;var new_nodes=[];var new_edges=[];var map=[];for(var i=0;i<nodes.length;i++){map[nodes[2*i]]=i;new_nodes.push(i,nodes[2*i+1])}for(var i=0;i<edges.length;i+=3)new_edges.push(map[edges[i]],
map[edges[i+1]],edges[i+2]);var new_graph={nodes:new_nodes,edges:new_edges};return new_graph}function match_iter(c1,c2,state){if(state_is_goal(state)){state_get_core_set(state,c1,c2);return true}if(state_is_dead(state))return false;var n1=NULL_NODE;var n2=NULL_NODE;var found=false;while(!found&&state_next_pair(state,_next_pair_cache,n1,n2)){var n1=_next_pair_cache[0];var n2=_next_pair_cache[1];if(state_is_feasible_pair(state,n1,n2)){var new_state=state_clone(state);state_add_pair(new_state,n1,n2);
found=match_iter(c1,c2,new_state);state_back_track(new_state)}}return found}function state_is_goal(state){return state.core_len==state.n1}function state_core_len(state){return state.core_len}function state_get_core_set(state,c1,c2){for(var i=0,j=0;i<state.n1;i++)if(state.core_1[i]!=NULL_NODE){c1[j]=i;c2[j]=state.core_1[i];j++}}function state_is_dead(state){return state.n1>state.n2||state.t1both_len>state.t2both_len||state.t1out_len>state.t2out_len||state.t1in_len>state.t2in_len}function state_next_pair(state,
next_pair,prev_n1,prev_n2){if(prev_n1==NULL_NODE)prev_n1=0;if(prev_n2==NULL_NODE)prev_n2=0;else prev_n2++;var t1both_len=state.t1both_len;var t2both_len=state.t2both_len;var t1out_len=state.t1out_len;var t2out_len=state.t2out_len;var t1in_len=state.t1in_len;var t2in_len=state.t2in_len;var core_len=state.core_len;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;if(t1both_len>core_len&&
t2both_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||out_1[prev_n1]==0||in_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(t1out_len>core_len&&t2out_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||out_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(t1in_len>core_len&&t2in_len>core_len)while(prev_n1<n1&&(core_1[prev_n1]!=NULL_NODE||in_1[prev_n1]==0)){prev_n1++;prev_n2=0}else if(prev_n1==0&&state.order!=NULL){var i=0;while(i<n1&&core_1[prev_n1=state.order[i]]!=NULL_NODE)i++;if(i==
n1)prev_n1=n1}else while(prev_n1<n1&&core_1[prev_n1]!=NULL_NODE){prev_n1++;prev_n2=0}if(t1both_len>core_len&&t2both_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||out_2[prev_n2]==0||in_2[prev_n2]==0))prev_n2++;else if(t1out_len>core_len&&t2out_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||out_2[prev_n2]==0))prev_n2++;else if(t1in_len>core_len&&t2in_len>core_len)while(prev_n2<n2&&(core_2[prev_n2]!=NULL_NODE||in_2[prev_n2]==0))prev_n2++;else while(prev_n2<n2&&core_2[prev_n2]!=
NULL_NODE)prev_n2++;if(prev_n1<n1&&prev_n2<n2){next_pair[0]=prev_n1;next_pair[1]=prev_n2;return true}return false}function state_is_feasible_pair(state,node1,node2){var g1=state.g1;var g2=state.g2;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;assert(node1<n1);assert(node2<n2);assert(core_1[node1]==NULL_NODE);assert(core_2[node2]==NULL_NODE);if(!compatible_node(state.node_comp,g1,node1,
g2,node2))return false;var termout1=0,termout2=0,termin1=0,termin2=0,new1=0,new2=0;for(var i=0;i<out_edge_count(g1,node1);i++){var other1=get_out_edge(g1,node1,i);if(core_1[other1]!=NULL_NODE){var other2=core_1[other1];if(!has_edge(g2,node2,other2)||!compatible_edge(state.edge_comp,g1,node1,other1,g2,node2,other2))return false}else{if(in_1[other1])termin1++;if(out_1[other1])termout1++;if(!in_1[other1]&&!out_1[other1])new1++}}for(var i=0;i<in_edge_count(g1,node1);i++){var other1=get_in_edge(g1,node1,
i);if(core_1[other1]!=NULL_NODE){var other2=core_1[other1];if(!has_edge(g2,other2,node2)||!compatible_edge(state.edge_comp,g1,other1,node1,g2,other2,node2))return false}else{if(in_1[other1])termin1++;if(out_1[other1])termout1++;if(!in_1[other1]&&!out_1[other1])new1++}}for(var i=0;i<out_edge_count(g2,node2);i++){var other2=get_out_edge(g2,node2,i);if(core_2[other2]!=NULL_NODE){var other1=core_2[other2];if(!has_edge(g1,node1,other1))return false}else{if(in_2[other2])termin2++;if(out_2[other2])termout2++;
if(!in_2[other2]&&!out_2[other2])new2++}}for(var i=0;i<in_edge_count(g2,node2);i++){var other2=get_in_edge(g2,node2,i);if(core_2[other2]!=NULL_NODE){var other1=core_2[other2];if(!has_edge(g1,other1,node1))return false}else{if(in_2[other2])termin2++;if(out_2[other2])termout2++;if(!in_2[other2]&&!out_2[other2])new2++}}return termin1<=termin2&&termout1<=termout2&&new1<=new2}function assert(expr){if(!expr)throw"Assertion failed";}function compatible_node(node_comp,graph1,node1,graph2,node2){if(node_comp(get_node_attr(graph1,
node1),get_node_attr(graph2,node2)))return true;else return false}exports.get_node_id=function(graph,attr){var nodes=graph.nodes;for(var i=1;i<nodes.length;i+=2)if(nodes[i]==attr)return nodes[i-1];return null};exports.get_node_attr=get_node_attr;function get_node_attr(graph,node){var nodes=graph.nodes;for(var i=0;i<nodes.length;i+=2)if(nodes[i]==node)return nodes[i+1];return null}exports.out_edge_count=out_edge_count;function out_edge_count(graph,node){var edges=graph.edges;var count=0;for(var i=
0;i<edges.length;i+=3)if(edges[i]==node)count++;return count}exports.in_edge_count=in_edge_count;function in_edge_count(graph,node){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node)count++;return count}exports.get_out_edge=get_out_edge;function get_out_edge(graph,node,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node){if(count==num)return edges[i+1];count++}return NULL_NODE}exports.get_in_edge=get_in_edge;function get_in_edge(graph,
node,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){if(count==num)return edges[i];count++}return NULL_NODE}function has_edge(graph,node1,node2){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2)return true;return false}function compatible_edge(edge_comp,graph1,node11,node12,graph2,node21,node22){var graph1_edge_count=get_edge_count(graph1,node11,node12);var graph2_edge_count=get_edge_count(graph2,node21,node22);
for(var i=0;i<graph1_edge_count;i++){var edge_match=false;for(var j=0;j<graph2_edge_count;j++)if(edge_comp(get_edge_attr(graph1,node11,node12,i),get_edge_attr(graph2,node21,node22,j))){edge_match=true;break}if(!edge_match)return false}return true}exports.get_edge_count=get_edge_count;function get_edge_count(graph,node1,node2){var count=0;var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2)count++;return count}exports.get_edge_attr=get_edge_attr;function get_edge_attr(graph,
node1,node2,num){var edges=graph.edges;var count=0;for(var i=0;i<edges.length;i+=3)if(edges[i]==node1&&edges[i+1]==node2){if(count==num)return edges[i+2];count++}return null}function state_add_pair(state,node1,node2){var g1=state.g1;var g2=state.g2;var n1=state.n1;var n2=state.n2;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;assert(node1<n1);assert(node2<n2);assert(state.core_len<n1);assert(state.core_len<n2);var core_len=
++state.core_len;state.added_node1=node1;if(!in_1[node1]){in_1[node1]=core_len;state.t1in_len++;if(out_1[node1])state.t1both_len++}if(!out_1[node1]){out_1[node1]=core_len;state.t1out_len++;if(in_1[node1])state.t1both_len++}if(!in_2[node2]){in_2[node2]=core_len;state.t2in_len++;if(out_2[node2])state.t2both_len++}if(!out_2[node2]){out_2[node2]=core_len;state.t2out_len++;if(in_2[node2])state.t2both_len++}core_1[node1]=node2;core_2[node2]=node1;for(var i=0;i<in_edge_count(g1,node1);i++){var other=get_in_edge(g1,
node1,i);if(!in_1[other]){in_1[other]=core_len;state.t1in_len++;if(out_1[other])state.t1both_len++}}for(var i=0;i<out_edge_count(g1,node1);i++){var other=get_out_edge(g1,node1,i);if(!out_1[other]){out_1[other]=core_len;state.t1out_len++;if(in_1[other])state.t1both_len++}}for(var i=0;i<in_edge_count(g2,node2);i++){var other=get_in_edge(g2,node2,i);if(!in_2[other]){in_2[other]=core_len;state.t2in_len++;if(out_2[other])state.t2both_len++}}for(var i=0;i<out_edge_count(g2,node2);i++){var other=get_out_edge(g2,
node2,i);if(!out_2[other]){out_2[other]=core_len;state.t2out_len++;if(in_2[other])state.t2both_len++}}}function state_back_track(state){assert(state.core_len-state.orig_core_len<=1);assert(state.added_node1!=NULL_NODE);var g1=state.g1;var g2=state.g2;var core_len=state.core_len;var added_node1=state.added_node1;var core_1=state.core_1;var core_2=state.core_2;var in_1=state.in_1;var in_2=state.in_2;var out_1=state.out_1;var out_2=state.out_2;if(state.orig_core_len<core_len){if(in_1[added_node1]==core_len)in_1[added_node1]=
0;for(var i=0;i<in_edge_count(g1,added_node1);i++){var other=get_in_edge(g1,added_node1,i);if(in_1[other]==core_len)in_1[other]=0}if(out_1[added_node1]==core_len)out_1[added_node1]=0;for(var i=0;i<out_edge_count(g1,added_node1);i++){var other=get_out_edge(g1,added_node1,i);if(out_1[other]==core_len)out_1[other]=0}var node2=core_1[added_node1];if(in_2[node2]==core_len)in_2[node2]=0;for(var i=0;i<in_edge_count(g2,node2);i++){var other=get_in_edge(g2,node2,i);if(in_2[other]==core_len)in_2[other]=0}if(out_2[node2]==
core_len)out_2[node2]=0;for(var i=0;i<out_edge_count(g2,node2);i++){var other=get_out_edge(g2,node2,i);if(out_2[other]==core_len)out_2[other]=0}core_1[added_node1]=NULL_NODE;core_2[node2]=NULL_NODE;state.core_len=state.orig_core_len;state.added_node1=NULL_NODE}}function state_clone(state){var new_state={};new_state.g1=state.g1;new_state.g2=state.g2;new_state.node_comp=state.node_comp;new_state.edge_comp=state.edge_comp;new_state.n1=state.n1;new_state.n2=state.n2;new_state.order=state.order;new_state.core_len=
new_state.orig_core_len=state.core_len;new_state.t1in_len=state.t1in_len;new_state.t1out_len=state.t1out_len;new_state.t1both_len=state.t1both_len;new_state.t2in_len=state.t2in_len;new_state.t2out_len=state.t2out_len;new_state.t2both_len=state.t2both_len;new_state.added_node1=NULL_NODE;new_state.core_1=state.core_1;new_state.core_2=state.core_2;new_state.in_1=state.in_1;new_state.in_2=state.in_2;new_state.out_1=state.out_1;new_state.out_2=state.out_2;new_state.share_count=state.share_count;state.share_count[0]+=
1;return new_state}exports.replace=function(graph,rnode_ids,new_node_attr){var nodes=graph.nodes;var edges=graph.edges;var new_node_id=gen_node_id(graph);for(var i=0;i<rnode_ids.length;i++){var rnode_id=rnode_ids[i];remove_node(graph,rnode_id);for(var j=0;j<edges.length;j+=3){if(edges[j]==rnode_id)edges[j]=new_node_id;if(edges[j+1]==rnode_id)edges[j+1]=new_node_id;if(edges[j]==edges[j+1]){edges.splice(j,3);j-=3}}}append_node(graph,new_node_id,new_node_attr)};exports.reconnect_edges=function(graph,
id1,id2,new_id1,new_id2){if(!has_edge(graph,id1,id2))throw"Edge not found";var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i]==id1&&edges[i+1]==id2){edges[i]=new_id1;edges[i+1]=new_id2}};exports.enforce_acyclic=function(graph,main_node){if(!main_node)var main_node=get_sink_nodes(graph)[0];var edges=graph.edges;if(!edges.length||edges.indexOf(main_node)==-1)return graph;var graph_data={};var count=0;for(var i=0;i<edges.length;i=i+3){if(edges[i+1]in graph_data)graph_data[edges[i+1]].push(edges[i]);
else graph_data[edges[i+1]]=[edges[i]];count++}var tracking=[];var wrong_edges=[];function find_redundant_edges(node,top_edges){var index=tracking.indexOf(node);if(index!=-1){var cycle=tracking.slice(tracking.indexOf(node));if(graph_data[cycle[cycle.length-1]].indexOf(cycle[0])!=-1){wrong_edges.push([node,cycle[cycle.length-1]]);return}}tracking.push(node);for(var i=0;i<top_edges.length;i++)if(top_edges[i]in graph_data)find_redundant_edges(top_edges[i],graph_data[top_edges[i]])}find_redundant_edges(main_node,
graph_data[main_node]);for(var i=0;i<wrong_edges.length;i++){var count=0;for(var k=0;k<edges.length;k=k+3){if(wrong_edges[i][1]==edges[k+1]&&wrong_edges[i][0]==edges[k])remove_edge(graph,edges[k],edges[k+1],count);count++}}return graph};exports.debug_dot=function(graph,node_label_cb,edge_label_cb){var nodes=graph.nodes;var edges=graph.edges;var dot_str="digraph debug {\n";dot_str+="    ";dot_str+="node [shape=box];\n";for(var i=0;i<nodes.length;i+=2){var node=nodes[i];var attr=nodes[i+1];var label=
node_label_cb?node_label_cb(node,attr):String(node);dot_str+="    ";dot_str+=String(node)+' [label="'+label.replace(/\"/g,'\\"')+'"];\n'}for(var i=0;i<edges.length;i+=3){var node1=edges[i];var node2=edges[i+1];var attr=edges[i+2];dot_str+="    ";dot_str+=String(node1)+" -> "+String(node2);if(edge_label_cb)dot_str+=' [label="'+edge_label_cb(node1,node2,attr)+'"]';dot_str+=";\n"}dot_str+="}";return dot_str}};b4w.module["__ipc"]=function(exports,require){var _wait_for_loading=true;var IN_LOADED=exports.IN_LOADED=0;var IN_COLLISION=exports.IN_COLLISION=1;var IN_COLLISION_POS_NORM=exports.IN_COLLISION_POS_NORM=2;var IN_COLLISION_IMPULSE=exports.IN_COLLISION_IMPULSE=3;var IN_ERROR=exports.IN_ERROR=4;var IN_FBMSG=exports.IN_FBMSG=5;var IN_FLOATER_BOB_TRANSFORM=exports.IN_FLOATER_BOB_TRANSFORM=6;var IN_LOG=exports.IN_LOG=7;var IN_PROP_OFFSET=exports.IN_PROP_OFFSET=8;var IN_RAY_HIT=exports.IN_RAY_HIT=9;var IN_RAY_HIT_POS_NORM=
exports.IN_RAY_HIT_POS_NORM=10;var IN_REMOVE_RAY_TEST=exports.IN_REMOVE_RAY_TEST=11;var IN_TRANSFORM=exports.IN_TRANSFORM=12;var IN_VEHICLE_SPEED=exports.IN_VEHICLE_SPEED=13;var IN_PING=exports.IN_PING=14;var IN_FPS=exports.IN_FPS=15;var IN_DEBUG_STATS=exports.IN_DEBUG_STATS=16;var OUT_INIT=exports.OUT_INIT=100;var OUT_ACTIVATE=exports.OUT_ACTIVATE=101;var OUT_ADD_BOAT_BOB=exports.OUT_ADD_BOAT_BOB=102;var OUT_ADD_CAR_WHEEL=exports.OUT_ADD_CAR_WHEEL=103;var OUT_ADD_FLOATER_BOB=exports.OUT_ADD_FLOATER_BOB=
104;var OUT_APPEND_BOUNDING_BODY=exports.OUT_APPEND_BOUNDING_BODY=105;var OUT_APPEND_BOAT=exports.OUT_APPEND_BOAT=106;var OUT_APPEND_CAR=exports.OUT_APPEND_CAR=107;var OUT_APPEND_CHARACTER=exports.OUT_APPEND_CHARACTER=108;var OUT_APPEND_COLLISION_TEST=exports.OUT_APPEND_COLLISION_TEST=109;var OUT_APPEND_CONSTRAINT=exports.OUT_APPEND_CONSTRAINT=110;var OUT_APPEND_FLOATER=exports.OUT_APPEND_FLOATER=111;var OUT_APPEND_GHOST_MESH_BODY=exports.OUT_APPEND_GHOST_MESH_BODY=112;var OUT_APPEND_STATIC_MESH_BODY=
exports.OUT_APPEND_STATIC_MESH_BODY=113;var OUT_APPEND_WATER=exports.OUT_APPEND_WATER=114;var OUT_REMOVE_BODY=exports.OUT_REMOVE_BODY=115;var OUT_APPLY_CENTRAL_FORCE=exports.OUT_APPLY_CENTRAL_FORCE=116;var OUT_APPLY_COLLISION_IMPULSE_TEST=exports.OUT_APPLY_COLLISION_IMPULSE_TEST=117;var OUT_APPLY_TORQUE=exports.OUT_APPLY_TORQUE=118;var OUT_CHARACTER_JUMP=exports.OUT_CHARACTER_JUMP=119;var OUT_CHARACTER_ROTATION_INCREMENT=exports.OUT_CHARACTER_ROTATION_INCREMENT=120;var OUT_CLEAR_COLLISION_IMPULSE_TEST=
exports.OUT_CLEAR_COLLISION_IMPULSE_TEST=121;var OUT_DISABLE_SIMULATION=exports.OUT_DISABLE_SIMULATION=122;var OUT_ENABLE_SIMULATION=exports.OUT_ENABLE_SIMULATION=123;var OUT_PAUSE=exports.OUT_PAUSE=124;var OUT_APPEND_RAY_TEST=exports.OUT_APPEND_RAY_TEST=125;var OUT_REMOVE_RAY_TEST=exports.OUT_REMOVE_RAY_TEST=126;var OUT_CHANGE_RAY_TEST_FROM_TO=exports.OUT_CHANGE_RAY_TEST_FROM_TO=127;var OUT_REMOVE_COLLISION_TEST=exports.OUT_REMOVE_COLLISION_TEST=128;var OUT_REMOVE_CONSTRAINT=exports.OUT_REMOVE_CONSTRAINT=
129;var OUT_RESUME=exports.OUT_RESUME=130;var OUT_SET_CHARACTER_FLY_VELOCITY=exports.OUT_SET_CHARACTER_FLY_VELOCITY=131;var OUT_SET_CHARACTER_HOR_ROTATION=exports.OUT_SET_CHARACTER_HOR_ROTATION=132;var OUT_SET_CHARACTER_MOVE_DIR=exports.OUT_SET_CHARACTER_MOVE_DIR=133;var OUT_SET_CHARACTER_MOVE_TYPE=exports.OUT_SET_CHARACTER_MOVE_TYPE=134;var OUT_SET_CHARACTER_ROTATION=exports.OUT_SET_CHARACTER_ROTATION=135;var OUT_SET_CHARACTER_RUN_VELOCITY=exports.OUT_SET_CHARACTER_RUN_VELOCITY=136;var OUT_SET_CHARACTER_VERT_ROTATION=
exports.OUT_SET_CHARACTER_VERT_ROTATION=137;var OUT_SET_CHARACTER_WALK_VELOCITY=exports.OUT_SET_CHARACTER_WALK_VELOCITY=138;var OUT_SET_GRAVITY=exports.OUT_SET_GRAVITY=139;var OUT_SET_LINEAR_VELOCITY=exports.OUT_SET_LINEAR_VELOCITY=140;var OUT_SET_TRANSFORM=exports.OUT_SET_TRANSFORM=141;var OUT_SET_WATER_TIME=exports.OUT_SET_WATER_TIME=142;var OUT_ADD_WATER_WRAPPER=exports.OUT_ADD_WATER_WRAPPER=143;var OUT_UPDATE_BOAT_CONTROLS=exports.OUT_UPDATE_BOAT_CONTROLS=144;var OUT_UPDATE_CAR_CONTROLS=exports.OUT_UPDATE_CAR_CONTROLS=
145;var OUT_PING=exports.OUT_PING=146;var OUT_DEBUG=exports.OUT_DEBUG=147;var OUT_UPDATE_WORLD=exports.OUT_UPDATE_WORLD=148;var _worker_listeners=b4w.worker_listeners;var _worker_namespaces=b4w.worker_namespaces;var _msg_cache_IN_TRANSFORM={msg_id:IN_TRANSFORM,body_id:0,time:0,trans:new Float32Array(3),quat:new Float32Array(4),linvel:new Float32Array(3),angvel:new Float32Array(3),len:0};var _msg_cache_IN_PROP_OFFSET={msg_id:IN_PROP_OFFSET,chassis_hull_body_id:0,prop_ind:0,trans:new Float32Array(3),
quat:new Float32Array(4),len:0};var _msg_cache_IN_RAY_HIT={msg_id:IN_RAY_HIT,id:0,body_id_hit:0,hit_fract:0,hit_time:0,len:0};var _msg_cache_IN_RAY_HIT_POS_NORM={msg_id:IN_RAY_HIT_POS_NORM,id:0,body_id_hit:0,hit_fract:0,hit_time:0,hit_pos:new Float32Array(3),hit_norm:new Float32Array(3),len:0};var _msg_cache_IN_COLLISION={msg_id:IN_COLLISION,body_id_a:0,body_id_b:0,result:0,len:0};var _msg_cache_IN_COLLISION_POS_NORM={msg_id:IN_COLLISION_POS_NORM,body_id_a:0,body_id_b:0,result:0,coll_point:new Float32Array(3),
coll_norm:new Float32Array(3),coll_dist:0,len:0};var _msg_cache_OUT_SET_TRANSFORM={msg_id:OUT_SET_TRANSFORM,body_id:0,trans:new Float32Array(3),quat:new Float32Array(4),len:0};var _msg_cache_list=[_msg_cache_IN_TRANSFORM,_msg_cache_IN_PROP_OFFSET,_msg_cache_IN_RAY_HIT,_msg_cache_IN_RAY_HIT_POS_NORM,_msg_cache_IN_COLLISION,_msg_cache_IN_COLLISION_POS_NORM,_msg_cache_OUT_SET_TRANSFORM];exports.create_worker=function(path,fallback){var worker={is_main:path?true:false,web_worker:null,buf_arr:[],fb_worker_ns:""};
if(fallback){var web_worker_fallback={addEventListener:function(type,listener,useCapture){if(type!="message")panic("Wrong web worker event");set_fallback_listener(worker.fb_worker_ns,worker.is_main,listener)},removeEventListener:function(type,listener,useCapture){if(type!="message")panic("Wrong web worker event");set_fallback_listener(worker.fb_worker_ns,worker.is_main,null)},postMessage:function(msg,msg2){var listener=find_fallback_listener(worker.fb_worker_ns,!worker.is_main);listener({"data":msg})},
terminate:function(){for(var i=0;i<_worker_namespaces.length;i+=2)if(_worker_namespaces[i+1]==worker.fb_worker_ns){_worker_listeners.splice(i,2);_worker_namespaces.splice(i,2);return}}};worker.web_worker=web_worker_fallback;if(worker.is_main){var m_util=require("__util");var m_cont=require("__container");var main_ns=b4w.get_namespace(require);var worker_ns=m_util.unique_name(main_ns+"_worker");_worker_namespaces.push(main_ns);_worker_namespaces.push(worker_ns);_worker_listeners.push(null);_worker_listeners.push(null);
worker.fb_worker_ns=worker_ns;var uranium_js=m_cont.find_script(path);if(uranium_js)if(_wait_for_loading)uranium_js.addEventListener("load",function(){b4w.require("__bindings",worker.fb_worker_ns)},false);else{b4w.cleanup("__bindings",worker.fb_worker_ns);b4w.cleanup("__ipc",worker.fb_worker_ns);b4w.require("__bindings",worker.fb_worker_ns)}else{var uranium_js=document.createElement("script");uranium_js.src=path;uranium_js.defer="defer";uranium_js.async="async";uranium_js.addEventListener("load",
function(){_wait_for_loading=false;b4w.require("__bindings",worker.fb_worker_ns)},false);document.head.appendChild(uranium_js)}}else worker.fb_worker_ns=b4w.get_namespace(require)}else if(path)worker.web_worker=new Worker(path);else worker.web_worker=self;return worker};function set_fallback_listener(worker_ns,is_main,listener){for(var i=0;i<_worker_namespaces.length;i+=2)if(_worker_namespaces[i+1]==worker_ns)_worker_listeners[i+Number(!is_main)]=listener}function find_fallback_listener(worker_ns,
is_main){for(var i=0;i<_worker_namespaces.length;i+=2)if(_worker_namespaces[i+1]==worker_ns)return _worker_listeners[i+Number(!is_main)];return null}exports.attach_handler=function(worker,process_message_cb){assign_msg_cache_length(_msg_cache_list);var preprocess_message_cb=function(event_data){if(event_data.constructor==ArrayBuffer)event_data=new Float32Array(event_data);else if(event_data[0].constructor==ArrayBuffer){for(var i=0;i<event_data.length;i++)preprocess_message_cb(event_data[i]);return}var msg_id=
event_data[0]|0;switch(msg_id){case IN_TRANSFORM:var data=_msg_cache_IN_TRANSFORM;data.body_id=event_data[1]|0;data.time=event_data[2];data.trans[0]=event_data[3];data.trans[1]=event_data[4];data.trans[2]=event_data[5];data.quat[0]=event_data[6];data.quat[1]=event_data[7];data.quat[2]=event_data[8];data.quat[3]=event_data[9];data.linvel[0]=event_data[10];data.linvel[1]=event_data[11];data.linvel[2]=event_data[12];data.angvel[0]=event_data[13];data.angvel[1]=event_data[14];data.angvel[2]=event_data[15];
break;case IN_PROP_OFFSET:var data=_msg_cache_IN_PROP_OFFSET;data.chassis_hull_body_id=event_data[1]|0;data.prop_ind=event_data[2]|0;data.trans[0]=event_data[3];data.trans[1]=event_data[4];data.trans[2]=event_data[5];data.quat[0]=event_data[6];data.quat[1]=event_data[7];data.quat[2]=event_data[8];data.quat[3]=event_data[9];break;case IN_RAY_HIT:var data=_msg_cache_IN_RAY_HIT;data.id=event_data[1]|0;data.body_id_hit=event_data[2]|0;data.hit_fract=event_data[3];data.hit_time=event_data[4];break;case IN_RAY_HIT_POS_NORM:var data=
_msg_cache_IN_RAY_HIT_POS_NORM;data.id=event_data[1]|0;data.body_id_hit=event_data[2]|0;data.hit_fract=event_data[3];data.hit_time=event_data[4];data.hit_pos[0]=event_data[5];data.hit_pos[1]=event_data[6];data.hit_pos[2]=event_data[7];data.hit_norm[0]=event_data[8];data.hit_norm[1]=event_data[9];data.hit_norm[2]=event_data[10];break;case IN_COLLISION:var data=_msg_cache_IN_COLLISION;data.body_id_a=event_data[1]|0;data.body_id_b=event_data[2]|0;data.result=!!event_data[3];break;case IN_COLLISION_POS_NORM:var data=
_msg_cache_IN_COLLISION_POS_NORM;data.body_id_a=event_data[1]|0;data.body_id_b=event_data[2]|0;data.result=!!event_data[3];data.coll_point[0]=event_data[4];data.coll_point[1]=event_data[5];data.coll_point[2]=event_data[6];data.coll_norm[0]=event_data[7];data.coll_norm[1]=event_data[8];data.coll_norm[2]=event_data[9];data.coll_dist=event_data[10];break;case OUT_SET_TRANSFORM:var data=_msg_cache_OUT_SET_TRANSFORM;data.body_id=event_data[1]|0;data.trans[0]=event_data[2];data.trans[1]=event_data[3];data.trans[2]=
event_data[4];data.quat[0]=event_data[5];data.quat[1]=event_data[6];data.quat[2]=event_data[7];data.quat[3]=event_data[8];break;default:var data=event_data;break}process_message_cb(worker,msg_id,data)};worker.web_worker.addEventListener("message",function(event){preprocess_message_cb(event.data)},false)};function assign_msg_cache_length(msg_cache_list){for(var i=0;i<msg_cache_list.length;i++){var cache=msg_cache_list[i];var len=0;for(var j in cache){var prop=cache[j];switch(prop.constructor){case Float32Array:len+=
prop.length;break;case Number:len+=1;break;default:break}}len-=1;cache.len=len}}exports.cleanup=function(){};exports.post_msg=function(worker,msg_id){if(!worker)return;switch(msg_id){case IN_TRANSFORM:var data=_msg_cache_IN_TRANSFORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id;msg[2]=data.time;msg[3]=data.trans[0];msg[4]=data.trans[1];msg[5]=data.trans[2];msg[6]=data.quat[0];msg[7]=data.quat[1];msg[8]=data.quat[2];msg[9]=data.quat[3];msg[10]=data.linvel[0];msg[11]=data.linvel[1];
msg[12]=data.linvel[2];msg[13]=data.angvel[0];msg[14]=data.angvel[1];msg[15]=data.angvel[2];worker.buf_arr.push(msg.buffer);break;case IN_PROP_OFFSET:var data=_msg_cache_IN_PROP_OFFSET;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.chassis_hull_body_id;msg[2]=data.prop_ind;msg[3]=data.trans[0];msg[4]=data.trans[1];msg[5]=data.trans[2];msg[6]=data.quat[0];msg[7]=data.quat[1];msg[8]=data.quat[2];msg[9]=data.quat[3];worker.buf_arr.push(msg.buffer);break;case IN_RAY_HIT:var data=_msg_cache_IN_RAY_HIT;
var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.id;msg[2]=data.body_id_hit;msg[3]=data.hit_fract;msg[4]=data.hit_time;worker.buf_arr.push(msg.buffer);break;case IN_RAY_HIT_POS_NORM:var data=_msg_cache_IN_RAY_HIT_POS_NORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.id;msg[2]=data.body_id_hit;msg[3]=data.hit_fract;msg[4]=data.hit_time;msg[5]=data.hit_pos[0];msg[6]=data.hit_pos[1];msg[7]=data.hit_pos[2];msg[8]=data.hit_norm[0];msg[9]=data.hit_norm[1];msg[10]=data.hit_norm[2];
worker.buf_arr.push(msg.buffer);break;case IN_COLLISION:var data=_msg_cache_IN_COLLISION;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id_a;msg[2]=data.body_id_b;msg[3]=data.result;worker.buf_arr.push(msg.buffer);break;case IN_COLLISION_POS_NORM:var data=_msg_cache_IN_COLLISION_POS_NORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id_a;msg[2]=data.body_id_b;msg[3]=data.result;msg[4]=data.coll_point[0];msg[5]=data.coll_point[1];msg[6]=data.coll_point[2];
msg[7]=data.coll_norm[0];msg[8]=data.coll_norm[1];msg[9]=data.coll_norm[2];msg[10]=data.coll_dist;worker.buf_arr.push(msg.buffer);break;case OUT_SET_TRANSFORM:var data=_msg_cache_OUT_SET_TRANSFORM;var msg=new Float32Array(data.len);msg[0]=data.msg_id;msg[1]=data.body_id;msg[2]=data.trans[0];msg[3]=data.trans[1];msg[4]=data.trans[2];msg[5]=data.quat[0];msg[6]=data.quat[1];msg[7]=data.quat[2];msg[8]=data.quat[3];worker.buf_arr.push(msg.buffer);break;default:var msg=[];for(var i=1;i<arguments.length;i++)msg.push(arguments[i]);
worker.web_worker.postMessage(msg);break}};exports.post_msg_arr=function(worker){if(!worker||!worker.buf_arr.length)return;worker.web_worker.postMessage(worker.buf_arr);worker.buf_arr.length=0};exports.get_msg_cache=function(msg_id){switch(msg_id){case IN_TRANSFORM:return _msg_cache_IN_TRANSFORM;case IN_PROP_OFFSET:return _msg_cache_IN_PROP_OFFSET;case IN_RAY_HIT:return _msg_cache_IN_RAY_HIT;case IN_RAY_HIT_POS_NORM:return _msg_cache_IN_RAY_HIT_POS_NORM;case IN_COLLISION:return _msg_cache_IN_COLLISION;
case IN_COLLISION_POS_NORM:return _msg_cache_IN_COLLISION_POS_NORM;case OUT_SET_TRANSFORM:return _msg_cache_OUT_SET_TRANSFORM;default:return null}};exports.terminate=function(worker){worker.web_worker.terminate();worker.web_worker=null};exports.is_active=function(worker){return!!worker.web_worker};exports.is_fallback=function(worker){return!!worker.fb_worker_ns}};b4w.module["__hud"]=function(exports,require){var m_graph=require("__graph");var m_print=require("__print");var START_POINT_X=30;var START_POINT_Y=80;var LINE_WIDTH=20;var OFFSETS=[5,24,7,10,4,3,6];var _canvas_context=null;var _carriage=[0,0];exports.init=function(canvas_elem){var ctx=canvas_elem.getContext("2d");set_style(ctx);_canvas_context=ctx;return ctx};function set_style(ctx){ctx.font="bold 15px Courier";ctx.textBaseline="middle";ctx.shadowBlur=0;ctx.shadowColor=null}exports.update_dim=function(){if(_canvas_context)set_style(_canvas_context)};
exports.reset=function(){var ctx=_canvas_context;if(!ctx)return;ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);reset_carriage()};exports.show_debug_info=function(scenes,elapsed){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="left";ctx.fillStyle="rgba(0,255,0,255)";print(" FPS",(1/elapsed).toFixed(2));new_line();var sum_bundles=0;var sum_rcalls=0;var sum_rtimes=0;for(var i=0;i<scenes.length;i++){var sum=
show_debug_info_scene(scenes[i]);sum_bundles+=sum[0];sum_rcalls+=sum[1];sum_rtimes+=sum[2];new_line()}print(" -----------------------------------------------");print("    ","TOTAL ACTIVE","","",sum_rcalls,"of",sum_bundles,"  ",sum_rtimes.toFixed(3))};function show_debug_info_scene(scene){print(' SCENE "'+scene["name"]+'"');print(" Active        Subscene       Lamps      Size   RenderCalls  Time");if(!scene._render){print("No INFO");return}var sum_bundles=0;var sum_rcalls=0;var sum_rtimes=0;var next_slot=
2;var graph=scene._render.graph;m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type=="SINK")return;var type=subs.type;var size=Math.round(subs.camera.width)+"x"+Math.round(subs.camera.height);var bundles=subs.bundles.length;var rcalls=subs.debug_render_calls;if(subs.type=="MAIN_CUBE_REFLECT"||subs.type=="MAIN_CUBE_REFLECT_BLEND")bundles*=6;var is_active=subs.do_render;var render_time=is_active?subs.debug_render_time:0;if(!subs.enqueue)subs.debug_render_time=0;var activity_prefix=
is_active?" (\u2713)":" (\u2715)";print(activity_prefix,type,subs.num_lights,size,rcalls,"of",bundles,"  ",render_time.toFixed(3));subs.debug_render_calls=0;if(is_active){sum_bundles+=bundles;sum_rcalls+=rcalls;sum_rtimes+=render_time}});return[sum_bundles,sum_rcalls,sum_rtimes]}function reset_carriage(){_carriage[0]=0;_carriage[1]=0}function new_line(){_carriage[0]++}exports.print=function(){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="left";ctx.fillStyle="rgba(0,255,0,255)";print.apply(Math,
arguments)};function print(){var x=START_POINT_X;var y=START_POINT_Y+_carriage[0]*LINE_WIDTH;var text=arguments[0];for(var i=1;i<arguments.length;i++){var arg=arguments[i];var num_spaces=OFFSETS[i]-String(arg).length;text+=spaces(num_spaces)+arguments[i]}new_line();_canvas_context.fillText(text,x,y)}function spaces(n){var s="";for(var i=0;i<n;i++)s+=" ";return s}function wrap_text(context,text,x,y,maxWidth,lineHeight){var words=text.split(" ");var line="";for(var n=0;n<words.length;n++){var testLine=
line+words[n]+" ";var metrics=context.measureText(testLine);var testWidth=metrics.width;if(testWidth>maxWidth){context.fillText(line,x,y);line=words[n]+" ";y+=lineHeight}else line=testLine}context.fillText(line,x,y)}exports.plot_array=function(header,slot,arr,arg_min,arg_max,val_min,val_max){var ctx=_canvas_context;if(!ctx)return;var box=create_strip_box(slot);box_split_v(box,4,5,box);ctx.textAlign="center";ctx.fillStyle="#00FF00";_canvas_context.fillText(header,box_mid_h(box),box.y-10);ctx.strokeStyle=
"#00FF00";ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(box.x,box.y);ctx.lineTo(box.x+box.w,box.y);ctx.lineTo(box.x+box.w,box.y+box.h);ctx.lineTo(box.x,box.y+box.h);ctx.closePath();ctx.stroke();if(!val_min&&!val_max){val_min=1E6;val_max=-1E6;for(var i=0;i<arr.length;i++){val_min=Math.min(val_min,arr[i]);val_max=Math.max(val_max,arr[i])}}ctx.textAlign="right";_canvas_context.fillText(String(val_min),box.x-10,box.y+box.h);_canvas_context.fillText(String(val_max),box.x-10,box.y);ctx.textAlign="center";
_canvas_context.fillText(String(arg_min),box.x,box.y+box.h+15);_canvas_context.fillText(String(arg_max),box.x+box.w,box.y+box.h+15);ctx.strokeStyle="#FF0000";ctx.lineWidth=1.5;ctx.beginPath();var dx=box.w/(arr.length-1);var dy=box.h/(val_max-val_min);for(var i=0;i<arr.length;i++){var x=box.x+dx*i;var y=box.y+box.h-(arr[i]-val_min)*dy;if(i==0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.stroke()};function box_create(){return{x:0,y:0,w:0,h:0}}function box_set(x,y,w,h,dest){dest.x=x;dest.y=y;dest.w=w;dest.h=
h;return dest}function box_split_h(box,part,parts,dest){var dw=box.w/parts;dest.x=box.x+dw*part;dest.y=box.y;dest.w=dw;dest.h=box.h;return dest}function box_split_v(box,part,parts,dest){var dh=box.h/parts;dest.x=box.x;dest.y=box.y+dh*part;dest.w=box.w;dest.h=dh;return dest}function box_trim_h(box,ratio,dest){var dw=box.w*ratio;dest.x=box.x+dw;dest.y=box.y;dest.w=box.w-2*dw;dest.h=box.h;return dest}function box_trim_v(box,ratio,dest){var dh=box.h*ratio;dest.x=box.x;dest.y=box.y+dh;dest.w=box.w;dest.h=
box.h-2*dh;return dest}function box_mid_h(box){return box.x+box.w/2}function box_mid_v(box){return box.y+box.h/2}function box_debug_draw(box){var ctx=_canvas_context;var ss=ctx.strokeStyle;var lw=ctx.lineWidth;ctx.strokeStyle="#FF0000";ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(box.x,box.y);ctx.lineTo(box.x+box.w,box.y);ctx.lineTo(box.x+box.w,box.y+box.h);ctx.lineTo(box.x,box.y+box.h);ctx.closePath();ctx.stroke();ctx.strokeStyle=ss;ctx.lineWidth=lw}function create_strip_box(slot){var ctx=_canvas_context;
var box=box_create();box_set(0,0,ctx.canvas.width,ctx.canvas.height,box);box_trim_h(box,.01,box);box_trim_v(box,.02,box);box_split_h(box,slot,8,box);box_trim_h(box,.02,box);return box}exports.draw_mixer_strip=function(id,is_active,slot,params,active_param,mute,solo){var ctx=_canvas_context;if(!ctx)return;ctx.textAlign="center";ctx.fillStyle="#00FF00";ctx.font="bold 12px Courier";var box_strip=create_strip_box(slot);var strip_title=is_active?"["+id+"]":id;_canvas_context.fillText(strip_title,box_mid_h(box_strip),
box_strip.y);if(mute>=0)_canvas_context.fillText(mute?"[M]":"[ ]",box_mid_h(box_strip)-15,box_strip.y+30);if(solo>=0)_canvas_context.fillText(solo?"[S]":"[ ]",box_mid_h(box_strip)+15,box_strip.y+30);var box_param=box_create();for(var i=0;i<params.length;i++){var param=params[i];var is_volume=param[0]=="VOLUME";if(is_volume)box_set(box_strip.x,box_strip.y+350,box_strip.w,250,box_param);else box_set(box_strip.x,box_strip.y+10+50*i,box_strip.w,box_strip.h,box_param);draw_param_bar(ctx,is_volume,box_param,
param,i==active_param)}};function draw_param_bar(ctx,vertical,box,param,is_active){var name=param[0];var value=param[1];var min=param[2];var max=param[3];var steps=param[4];var is_log=param[5];var step=(max-min)/steps;if(step<1)var digits=Math.floor(1/step-1E-5).toFixed(0).length;else var digits=0;if(is_log)var val_pos_factor=Math.log(value/min)/Math.log(max/min);else var val_pos_factor=(value-min)/(max-min);ctx.textAlign="center";if(is_active)ctx.fillText("["+name+"]",box_mid_h(box),box.y);else ctx.fillText(name,
box_mid_h(box),box.y);ctx.strokeStyle="#00FF00";if(vertical)ctx.lineWidth=3;else ctx.lineWidth=1;if(vertical){ctx.textAlign="right";ctx.fillText(max.toFixed(digits),box_mid_h(box)-10,box.y+15);ctx.textAlign="right";ctx.fillText(min.toFixed(digits),box_mid_h(box)-10,box.y+box.h-15)}else{ctx.textAlign="right";ctx.fillText(min.toFixed(digits),box.x+28,box.y+15);ctx.textAlign="left";ctx.fillText(max.toFixed(digits),box.x+box.w-28,box.y+15)}ctx.beginPath();if(vertical){var val_pos_y=box.y+15+(box.h-30)*
(1-val_pos_factor);ctx.moveTo(box_mid_h(box),box.y+15);ctx.lineTo(box_mid_h(box),box.y+box.h-15);ctx.moveTo(box_mid_h(box)-5,box.y+15);ctx.lineTo(box_mid_h(box)+5,box.y+15);ctx.moveTo(box_mid_h(box)-5,box.y+box.h-15);ctx.lineTo(box_mid_h(box)+5,box.y+box.h-15);ctx.moveTo(box_mid_h(box)-5,val_pos_y);ctx.lineTo(box_mid_h(box)+5,val_pos_y)}else{var val_pos_x=box.x+30+(box.w-60)*val_pos_factor;ctx.moveTo(box.x+30,box.y+15);ctx.lineTo(box.x+box.w-30,box.y+15);ctx.moveTo(box.x+30,box.y+15-5);ctx.lineTo(box.x+
30,box.y+15+5);ctx.moveTo(box.x+box.w-30,box.y+15-5);ctx.lineTo(box.x+box.w-30,box.y+15+5);ctx.moveTo(val_pos_x,box.y+15-5);ctx.lineTo(val_pos_x,box.y+15+5)}ctx.stroke();if(name=="EQ_Q"){var Q=value;var Y=1+1/(2*Q*Q)+Math.sqrt((2+1/(Q*Q))*(2+1/(Q*Q))/4-1);var N=Math.log(Y)/Math.log(2);if(vertical){ctx.textAlign="left";ctx.fillText(value.toFixed(digits),box_mid_h(box)+10,val_pos_y);ctx.textAlign="left";ctx.fillText("("+N.toFixed(digits+1)+")",box_mid_h(box)+10,val_pos_y+10)}else{ctx.textAlign="right";
ctx.fillText(value.toFixed(digits),val_pos_x,box.y+30);ctx.textAlign="left";ctx.fillText("("+N.toFixed(digits+1)+")",val_pos_x,box.y+30)}}else if(vertical){ctx.textAlign="left";ctx.fillText(value.toFixed(digits),box_mid_h(box)+10,val_pos_y)}else{ctx.textAlign="center";ctx.fillText(value.toFixed(digits),val_pos_x,box.y+30)}}};b4w.module["__renderer"]=function(exports,require){var m_batch=require("__batch");var m_cam=require("__camera");var m_cfg=require("__config");var m_debug=require("__debug");var m_textures=require("__textures");var m_tsr=require("__tsr");var m_util=require("__util");var USE_BACKFACE_CULLING=true;var DEBUG_DISABLE_RENDER_LOCK=false;var SHADOW_BG_COLOR=[1,1,1,1];var DEPTH_BG_COLOR=[1,1,1,1];var COLOR_PICKING_BG_COLOR=[0,0,0,1];var BLACK_BG_COLOR=[0,0,0,0];var SKY_HACK_COLOR=new Uint8Array([.36*255,.56*
255,.96*255,255]);var FLOAT_BYTE_SIZE=4;var CUBEMAP_UPPER_SIDE=2;var CUBEMAP_BOTTOM_SIDE=3;var JITTER=[new Float32Array([.25,-.25]),new Float32Array([-.25,.25])];var SUBSAMPLE_IND=[new Float32Array([1,1,1,0]),new Float32Array([2,2,2,0])];var _gl=null;var _subpixel_index=0;var _vec3_tmp=new Float32Array(3);var _ivec4_tmp=new Uint8Array(4);var _mat3_tmp=new Float32Array(9);var _tsr_tmp=new Float32Array(8);var cfg_ctx=m_cfg.context;var cfg_def=m_cfg.defaults;exports.setup_context=function(gl){var bc=
cfg_def.background_color;gl.clearColor(bc[0],bc[1],bc[2],bc[3]);gl.clearDepth(1);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);if(USE_BACKFACE_CULLING){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CCW);gl.cullFace(gl.BACK)}else gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA);_gl=gl};exports.draw=function(subscene){if(!subscene.do_render)return;if(subscene.type=="RESOLVE"){m_debug.render_time_start(subscene);draw_resolve(subscene);m_debug.render_time_stop(subscene);
m_debug.check_gl("draw resolve")}else if(subscene.type=="COPY"){m_debug.render_time_start(subscene);draw_copy(subscene);m_debug.render_time_stop(subscene);m_debug.check_gl("draw copy")}else{m_debug.render_time_start(subscene);prepare_subscene(subscene);if(subscene.type=="MAIN_CUBE_REFLECT"||subscene.type=="MAIN_CUBE_REFLECT_BLEND")draw_cube_reflection_subs(subscene);else draw_subs(subscene);m_debug.render_time_stop(subscene);m_debug.check_gl("draw subscene: "+subscene.type);_gl.bindFramebuffer(_gl.FRAMEBUFFER,
null)}};function draw_cube_reflection_subs(subscene){var camera=subscene.camera;var color_attachment=camera.color_attachment;var w_tex=color_attachment.w_texture;var v_matrs=subscene.cube_view_matrices;for(var i=0;i<6;i++){var w_target=get_cube_target_by_id(i);camera.view_matrix=subscene.cube_view_matrices[i];m_tsr.from_mat4(camera.view_matrix,camera.view_tsr);m_cam.calc_sky_vp_inverse(camera);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0);clear_binded_framebuffer(subscene);
var bundles=subscene.bundles;for(var j=0;j<bundles.length;j++)bundles[j].do_render=bundles[j].do_render_cube[i];draw_subs(subscene)}}function draw_resolve(subscene){var camera=subscene.camera;_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,camera.framebuffer_prev);_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,camera.framebuffer);var blit_mask=0;if(camera.color_attachment)blit_mask|=_gl.COLOR_BUFFER_BIT;if(camera.depth_attachment)blit_mask|=_gl.DEPTH_BUFFER_BIT;_gl.blitFramebuffer(0,0,camera.width,camera.height,
0,0,camera.width,camera.height,blit_mask,_gl.NEAREST)}function draw_copy(subscene){var camera=subscene.camera;_gl.bindFramebuffer(_gl.FRAMEBUFFER,camera.framebuffer_prev);var tex=camera.color_attachment;var w_tex=tex.w_texture;_gl.bindTexture(_gl.TEXTURE_2D,w_tex);_gl.copyTexSubImage2D(_gl.TEXTURE_2D,0,0,0,0,0,camera.width,camera.height,0)}function draw_subs(subscene){var camera=subscene.camera;var bundles=subscene.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];if(bundle.do_render){var obj_render=
bundle.obj_render;var batch=bundle.batch;draw_bundle(subscene,camera,obj_render,batch)}}}exports.clear=function(subscene){var camera=subscene.camera;_gl.bindFramebuffer(_gl.FRAMEBUFFER,camera.framebuffer);clear_binded_framebuffer(subscene)};function prepare_subscene(subscene){var camera=subscene.camera;_gl.bindFramebuffer(_gl.FRAMEBUFFER,camera.framebuffer);if(subscene.assign_texture){var tex=camera.color_attachment;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,tex.w_target,tex.w_texture,
0)}_gl.viewport(0,0,camera.width,camera.height);if(subscene.type!="MAIN_CUBE_REFLECT"&&subscene.type!="MAIN_CUBE_REFLECT_BLEND")clear_binded_framebuffer(subscene);if(subscene.blend)_gl.enable(_gl.BLEND);else _gl.disable(_gl.BLEND);if(subscene.depth_test)_gl.enable(_gl.DEPTH_TEST);else _gl.disable(_gl.DEPTH_TEST);switch(subscene.type){case "SHADOW_CAST":_gl.enable(_gl.POLYGON_OFFSET_FILL);_gl.polygonOffset(subscene.self_shadow_polygon_offset,subscene.self_shadow_polygon_offset);_gl.cullFace(_gl.BACK);
break;case "MAIN_PLANE_REFLECT":case "MAIN_PLANE_REFLECT_BLEND":_gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.FRONT);break;case "MAIN_GLOW":if(cfg_def.msaa_samples>1){_gl.enable(_gl.POLYGON_OFFSET_FILL);_gl.polygonOffset(-2,-2);break}default:_gl.disable(_gl.POLYGON_OFFSET_FILL);_gl.cullFace(_gl.BACK)}}function clear_binded_framebuffer(subscene){if(subscene){var bitfield=(subscene.clear_color?_gl.COLOR_BUFFER_BIT:0)|(subscene.clear_depth?_gl.DEPTH_BUFFER_BIT:0);if(!bitfield)return;switch(subscene.type){case "MAIN_GLOW":var bc=
BLACK_BG_COLOR;break;case "SHADOW_CAST":var bc=SHADOW_BG_COLOR;break;case "SHADOW_RECEIVE":var bc=DEPTH_BG_COLOR;break;case "COLOR_PICKING":case "COLOR_PICKING_XRAY":case "ANCHOR_VISIBILITY":var bc=COLOR_PICKING_BG_COLOR;break;case "OUTLINE_MASK":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_EDGE_DETECTION":var bc=BLACK_BG_COLOR;break;default:var bc=cfg_def.background_color;break}}else{var bitfield=_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT;var bc=cfg_def.background_color}_gl.colorMask(true,true,
true,true);_gl.depthMask(true);_gl.clearColor(bc[0],bc[1],bc[2],bc[3]);_gl.clear(bitfield)}function setup_smaa_jitter(subscene){var jitter=JITTER[_subpixel_index];var camera=subscene.camera;subscene.jitter_projection_space[0]=jitter[0]*2/camera.width;subscene.jitter_projection_space[1]=jitter[1]*2/camera.height;if(subscene.type=="SMAA_BLENDING_WEIGHT_CALCULATION")subscene.jitter_subsample_ind=SUBSAMPLE_IND[_subpixel_index]}function draw_bundle(subscene,camera,obj_render,batch){var shader=batch.shader;
_gl.useProgram(shader.program);var bufs_data=batch.bufs_data;var attribute_setters=batch.attribute_setters;var transient_uniform_setters=shader.transient_uniform_setters;var i=transient_uniform_setters.length;while(i--){var setter=transient_uniform_setters[i];setter.fun(_gl,setter.loc,subscene,obj_render,batch,camera)}if(shader.need_uniforms_update&&!shader.no_permanent_uniforms){if(!shader.permanent_uniform_setters.length)assign_uniform_setters(shader);var permanent_uniform_setters=shader.permanent_uniform_setters;
var i=permanent_uniform_setters.length;while(i--){var setter=permanent_uniform_setters[i];setter.fun(_gl,setter.loc,subscene,obj_render,batch,camera)}shader.need_uniforms_update=false}_gl.depthMask(batch.depth_mask);if(USE_BACKFACE_CULLING)if(batch.use_backface_culling)_gl.enable(_gl.CULL_FACE);else _gl.disable(_gl.CULL_FACE);setup_textures(batch.textures);if(subscene.type=="SKY"){draw_sky_buffers(subscene,bufs_data,shader,obj_render,attribute_setters);subscene.debug_render_calls+=6}else{draw_buffers(bufs_data,
attribute_setters,obj_render.va_frame);subscene.debug_render_calls++}}function draw_sky_buffers(subscene,bufs_data,shader,obj_render,attribute_setters){var camera=subscene.camera;var uniforms=shader.uniforms;var color_attachment=camera.color_attachment;var w_tex=color_attachment.w_texture;var v_matrs=subscene.cube_view_matrices;for(var i=0;i<6;i++){var w_target=get_cube_target_by_id(i);if(cfg_def.clear_procedural_sky_hack){var w_target_cube=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target_cube,w_tex);
_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,SKY_HACK_COLOR)}else{_gl.uniformMatrix4fv(uniforms["u_cube_view_matrix"],false,v_matrs[i]);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0);draw_buffers(bufs_data,attribute_setters,obj_render.va_frame)}if(subscene.need_fog_update&&i!=CUBEMAP_BOTTOM_SIDE)update_subs_sky_fog(subscene,i)}}function update_subs_sky_fog(subscene,cubemap_side_ind){var col=_ivec4_tmp;if(cfg_def.clear_procedural_sky_hack)col.set(SKY_HACK_COLOR);
else{_gl.readPixels(191,191,1,1,_gl.RGBA,_gl.UNSIGNED_BYTE,col);if(col[0]==255||col[1]==255||col[2]==255)_gl.readPixels(191,220,1,1,_gl.RGBA,_gl.UNSIGNED_BYTE,col)}var res_r=col[0];var res_g=col[1];var res_b=col[2];res_r/=255;res_g/=255;res_b/=255;if(cubemap_side_ind===CUBEMAP_UPPER_SIDE){subscene.cube_fog[3]=res_r;subscene.cube_fog[7]=res_g;subscene.cube_fog[11]=res_b}else if(cubemap_side_ind<2){subscene.cube_fog[4*cubemap_side_ind]=res_r;subscene.cube_fog[4*cubemap_side_ind+1]=res_g;subscene.cube_fog[4*
cubemap_side_ind+2]=res_b}else{subscene.cube_fog[4*(cubemap_side_ind-2)]=res_r;subscene.cube_fog[4*(cubemap_side_ind-2)+1]=res_g;subscene.cube_fog[4*(cubemap_side_ind-2)+2]=res_b}}function setup_float_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib1f(attribute_loc,value)}function setup_vec2_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib2fv(attribute_loc,
value)}function setup_vec3_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib3fv(attribute_loc,value)}function setup_vec4_attribute(attributes,name,value){var attribute_loc=attributes[name];if(attribute_loc==undefined)return;_gl.vertexAttrib4fv(attribute_loc,value)}function draw_buffers(bufs_data,attribute_setters,frame){_gl.bindBuffer(_gl.ARRAY_BUFFER,bufs_data.vbo);for(var i=0;i<attribute_setters.length;i++){var setter=attribute_setters[i];
_gl.enableVertexAttribArray(setter.loc);var offset=setter.base_offset+setter.frame_length*frame;_gl.vertexAttribPointer(setter.loc,setter.num_comp,_gl.FLOAT,false,0,offset)}if(bufs_data.ibo){_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.drawElements(bufs_data.mode,bufs_data.count,bufs_data.ibo_type,0)}else _gl.drawArrays(bufs_data.mode,0,bufs_data.count);for(var i=0;i<attribute_setters.length;i++){var setter=attribute_setters[i];_gl.disableVertexAttribArray(setter.loc)}}function get_cube_target_by_id(id){switch(id){case 0:return _gl.TEXTURE_CUBE_MAP_POSITIVE_X;
case 1:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_X;case 2:return _gl.TEXTURE_CUBE_MAP_POSITIVE_Y;case 3:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_Y;case 4:return _gl.TEXTURE_CUBE_MAP_POSITIVE_Z;case 5:return _gl.TEXTURE_CUBE_MAP_NEGATIVE_Z}}exports.assign_attribute_setters=function(batch){var attr_setters=batch.attribute_setters;attr_setters.length=0;var bufs_data=batch.bufs_data;var shader=batch.shader;if(!bufs_data||!shader)m_util.panic("Incomplete batch");var pointers=bufs_data.pointers;var attributes=shader.attributes;
for(var name in attributes){var p=pointers[name];var setter={loc:attributes[name],base_offset:p.offset*FLOAT_BYTE_SIZE,frame_length:p.frames>1?p.length*FLOAT_BYTE_SIZE:0,num_comp:p.num_comp};attr_setters.push(setter)}};exports.assign_uniform_setters=assign_uniform_setters;function assign_uniform_setters(shader){var uniforms=shader.uniforms;var transient_uniform_setters=[];var permanent_uniform_setters=[];var permanent_uniform_setters_table={};for(var uni in uniforms){var transient_uni=false;switch(uni){case "u_proj_matrix":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.proj_matrix)};transient_uni=true;break;case "u_view_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_matrix)};transient_uni=true;break;case "u_view_tsr":case "u_view_tsr_frag":var fun=function(gl,loc,subscene,obj_render,batch,camera){if(camera.reflection_plane)gl.uniformMatrix3fv(loc,false,camera.real_view_tsr);else gl.uniformMatrix3fv(loc,false,camera.view_tsr)};
transient_uni=true;break;case "u_view_zup_tsr":var fun=function(gl,loc,subscene,obj_render,batch,camera){if(camera.reflection_plane)gl.uniformMatrix3fv(loc,false,camera.real_view_zup_tsr);else gl.uniformMatrix3fv(loc,false,camera.view_zup_tsr)};transient_uni=true;break;case "u_view_zup_tsr_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){if(camera.reflection_plane)gl.uniformMatrix3fv(loc,false,camera.real_view_inv_zup_tsr);else gl.uniformMatrix3fv(loc,false,camera.view_inv_zup_tsr)};
transient_uni=true;break;case "u_shadow_cast_billboard_view_tsr":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix3fv(loc,false,camera.shadow_cast_billboard_view_tsr)};transient_uni=true;break;case "u_view_proj_prev":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.prev_view_proj_matrix)};transient_uni=true;break;case "u_view_proj_matrix":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_proj_matrix)};
transient_uni=true;break;case "u_view_proj_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.view_proj_inv_matrix)};transient_uni=true;break;case "u_sky_vp_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,camera.sky_vp_inv_matrix)};transient_uni=true;break;case "u_camera_eye":case "u_camera_eye_frag":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,m_tsr.get_trans_value(camera.world_tsr,
_vec3_tmp))};transient_uni=true;break;case "u_camera_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,m_tsr.get_quat_view(camera.world_tsr))};transient_uni=true;break;case "u_view_max_depth":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.far)};transient_uni=true;break;case "u_camera_range":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2f(loc,camera.near,camera.far)};break;case "u_csm_center_dists":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,camera.csm_center_dists)};break;case "u_cam_water_depth":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.cam_water_depth)};transient_uni=true;break;case "u_waves_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.water_waves_height)};break;case "u_waves_length":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.water_waves_length)};break;
case "u_fog_color_density":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.fog_color_density)};break;case "u_fog_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.fog_params)};break;case "u_underwater_fog_color_density":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.water_fog_color_density)};break;case "u_bloom_key":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
subscene.bloom_key)};break;case "u_bloom_edge_lum":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.bloom_edge_lum)};break;case "u_time":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.time)};transient_uni=true;break;case "u_wind":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.wind)};transient_uni=true;break;case "u_sky_tex_dvar":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
subscene.sky_tex_default_value)};break;case "u_sky_tex_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.sky_tex_fac)};break;case "u_sky_tex_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sky_tex_color)};break;case "u_horizon_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.horizon_color)};break;case "u_zenith_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,
subscene.zenith_color)};break;case "u_environment_energy":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.environment_energy)};break;case "u_sky_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sky_color)};break;case "u_rayleigh_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_brightness)};break;case "u_mie_brightness":var fun=function(gl,loc,subscene,obj_render,batch,
camera){gl.uniform1f(loc,subscene.mie_brightness)};break;case "u_spot_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.spot_brightness)};break;case "u_scatter_strength":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.scatter_strength)};break;case "u_rayleigh_strength":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_strength)};break;case "u_mie_strength":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_strength)};break;case "u_rayleigh_collection_power":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.rayleigh_collection_power)};break;case "u_mie_collection_power":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_collection_power)};break;case "u_mie_distribution":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mie_distribution)};
break;case "u_light_positions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_positions)};break;case "u_light_directions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_directions)};break;case "u_light_color_intensities":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.light_color_intensities)};break;case "u_light_factors":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,
subscene.light_factors)};break;case "u_sun_quaternion":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.sun_quaternion)};break;case "u_sun_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sun_intensity)};break;case "u_sun_direction":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.sun_direction)};break;case "u_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
camera.height)};transient_uni=true;break;case "u_model_tsr":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix3fv(loc,false,obj_render.world_tsr)};transient_uni=true;break;case "u_model_zup_tsr":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix3fv(loc,false,obj_render.world_zup_tsr)};transient_uni=true;break;case "u_model_zup_tsr_inverse":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix3fv(loc,false,obj_render.world_inv_zup_tsr)};
transient_uni=true;break;case "u_transb":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.trans_before)};transient_uni=true;break;case "u_transa":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.trans_after)};transient_uni=true;break;case "u_arm_rel_trans":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.arm_rel_trans)};transient_uni=true;break;case "u_arm_rel_quat":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.arm_rel_quat)};transient_uni=true;break;case "u_quat":var fun=function(gl,loc,subscene,obj_render,batch,camera){var quat=m_tsr.get_quat_view(obj_render.world_tsr);gl.uniform4fv(loc,quat)};transient_uni=true;break;case "u_quatsb":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.quats_before)};transient_uni=true;break;case "u_quatsa":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,
obj_render.quats_after)};transient_uni=true;break;case "u_frame_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.frame_factor)};transient_uni=true;break;case "au_center_pos":var fun=function(gl,loc,subscene,obj_render,batch,camera){};transient_uni=true;break;case "au_wind_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.wind_bending_amp)};transient_uni=true;break;case "au_wind_bending_freq":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.wind_bending_freq)};transient_uni=true;break;case "au_detail_bending_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.detail_bending_freq)};transient_uni=true;break;case "au_detail_bending_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.detail_bending_amp)};transient_uni=true;break;case "au_branch_bending_amp":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,obj_render.branch_bending_amp)};transient_uni=true;break;case "u_node_values":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1fv(loc,batch.node_values)};transient_uni=true;break;case "u_node_rgbs":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.node_rgbs)};transient_uni=true;break;case "u_diffuse_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.diffuse_color)};transient_uni=
true;break;case "u_diffuse_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.diffuse_intensity)};transient_uni=true;break;case "u_diffuse_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.diffuse_params)};transient_uni=true;break;case "u_emit":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.emit)};transient_uni=true;break;case "u_ambient":var fun=function(gl,loc,subscene,obj_render,batch,
camera){gl.uniform1f(loc,batch.ambient)};transient_uni=true;break;case "u_specular_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.specular_color)};transient_uni=true;break;case "u_specular_alpha":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.specular_alpha)};transient_uni=true;break;case "u_specular_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.specular_params)};transient_uni=true;
break;case "u_reflect_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.reflect_factor)};transient_uni=true;break;case "u_mirror_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.mirror_factor)};transient_uni=true;break;case "u_grass_map_dim":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.grass_map_dim)};transient_uni=true;break;case "u_grass_size":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,batch.grass_size)};transient_uni=true;break;case "u_scale_threshold":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.grass_scale_threshold)};transient_uni=true;break;case "u_cube_fog":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,batch.cube_fog)};break;case "u_jitter_amp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.jitter_amp)};transient_uni=true;break;case "u_jitter_freq":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.jitter_freq)};transient_uni=true;break;case "u_debug_view_mode":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,batch.debug_view_mode)};break;case "u_debug_colors_seed":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.debug_colors_seed)};break;case "u_wireframe_edge_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.wireframe_edge_color)};
break;case "u_cluster_id":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.cluster_id)};transient_uni=true;break;case "u_batch_debug_id":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.debug_id)};transient_uni=true;break;case "u_subpixel_jitter":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,subscene.jitter_projection_space)};transient_uni=true;break;case "u_subsample_indices":var fun=function(gl,loc,subscene,
obj_render,batch,camera){gl.uniform4fv(loc,subscene.jitter_subsample_ind)};transient_uni=true;break;case "u_refr_bump":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.refr_bump)};transient_uni=true;break;case "u_line_width":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.line_width)};transient_uni=true;break;case "u_lamp_light_positions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.lamp_light_positions)};
break;case "u_lamp_light_directions":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.lamp_light_directions)};break;case "u_lamp_light_color_intensities":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.lamp_light_color_intensities)};break;case "u_lamp_light_factors":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.lamp_light_factors)};break;case "u_halo_size":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,batch.halo_size)};transient_uni=true;break;case "u_halo_hardness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_hardness)};transient_uni=true;break;case "u_halo_rings_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.halo_rings_color)};transient_uni=true;break;case "u_halo_lines_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.halo_lines_color)};transient_uni=
true;break;case "u_halo_stars_blend":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_stars_blend)};transient_uni=true;break;case "u_halo_stars_height":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.halo_stars_height)};transient_uni=true;break;case "u_fresnel_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.fresnel_params)};transient_uni=true;break;case "u_texture_scale":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.texture_scale)};transient_uni=true;break;case "u_parallax_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.parallax_scale)};transient_uni=true;break;case "u_color_id":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,obj_render.color_id)};transient_uni=true;break;case "u_line_points":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.line_points)};
transient_uni=true;break;case "u_diffuse_color_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.diffuse_color_factor)};transient_uni=true;break;case "u_alpha_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.alpha_factor)};transient_uni=true;break;case "u_specular_color_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.specular_color_factor)};transient_uni=true;break;case "u_normal_factor":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.normal_factor)};transient_uni=true;break;case "u_normalmap0_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[0])};transient_uni=true;break;case "u_normalmap1_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[1])};transient_uni=true;break;case "u_normalmap2_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,
batch.normalmap_scales[2])};transient_uni=true;break;case "u_normalmap3_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.normalmap_scales[3])};transient_uni=true;break;case "u_foam_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.foam_factor)};transient_uni=true;break;case "u_foam_uv_freq":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_uv_freq)};transient_uni=true;break;case "u_foam_mag":var fun=
function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_mag)};transient_uni=true;break;case "u_foam_scale":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,batch.foam_scale)};transient_uni=true;break;case "u_water_norm_uv_velocity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.water_norm_uv_velocity)};transient_uni=true;break;case "u_shallow_water_col":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,
batch.shallow_water_col)};transient_uni=true;break;case "u_shore_water_col":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.shore_water_col)};transient_uni=true;break;case "u_water_shallow_col_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.shallow_water_col_fac)};transient_uni=true;break;case "u_water_shore_col_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.shore_water_col_fac)};transient_uni=
true;break;case "u_p_length":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.time_length)};transient_uni=true;break;case "u_p_cyclic":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,batch.particles_data.cyclic)};transient_uni=true;break;case "u_p_max_lifetime":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.lifetime)};transient_uni=true;break;case "u_p_fade_in":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.fade_in)};transient_uni=true;break;case "u_p_fade_out":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.fade_out)};transient_uni=true;break;case "u_p_size":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.size)};transient_uni=true;break;case "u_p_alpha_start":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
batch.particles_data.alpha_start)};transient_uni=true;break;case "u_p_alpha_end":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.alpha_end)};transient_uni=true;break;case "u_p_nfactor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.nfactor)};transient_uni=true;break;case "u_p_gravity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.gravity)};transient_uni=
true;break;case "u_p_mass":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.mass)};transient_uni=true;break;case "u_p_color_ramp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,batch.particles_data.color_ramp)};transient_uni=true;break;case "u_p_wind_fac":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.wind_factor)};transient_uni=true;break;case "u_texel_size":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform2fv(loc,subscene.texel_size)};transient_uni=true;break;case "u_p_time":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.time)};transient_uni=true;break;case "u_p_tilt":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.tilt)};transient_uni=true;break;case "u_p_tilt_rand":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,batch.particles_data.tilt_rand)};
transient_uni=true;break;case "u_position":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,batch.positions)};transient_uni=true;break;case "u_va_frame_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.va_frame_factor)};transient_uni=true;break;case "u_normal_offset":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.self_shadow_normal_offset)};break;case "u_pcf_blur_radii":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,camera.pcf_blur_radii)};break;case "u_v_light_ts":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.v_light_ts)};transient_uni=true;break;case "u_v_light_r":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.v_light_r)};transient_uni=true;break;case "u_v_light_tsr":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix3fv(loc,false,subscene.v_light_tsr)};
transient_uni=true;break;case "u_p_light_matrix0":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[0])};transient_uni=true;break;case "u_p_light_matrix1":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[1])};transient_uni=true;break;case "u_p_light_matrix2":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[2])};
transient_uni=true;break;case "u_p_light_matrix3":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniformMatrix4fv(loc,false,subscene.p_light_matrix[3])};transient_uni=true;break;case "u_motion_blur_exp":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.motion_blur_exp)};transient_uni=true;break;case "u_motion_blur_decay_threshold":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.mb_decay_threshold)};transient_uni=true;
break;case "u_refl_plane":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,obj_render.reflection_plane)};transient_uni=true;break;case "u_radial_blur_step":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.radial_blur_step)};break;case "u_god_rays_intensity":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.god_rays_intensity)};break;case "u_ssao_radius_increase":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform1f(loc,subscene.ssao_radius_increase)};break;case "u_ssao_blur_discard_value":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_blur_discard_value)};transient_uni=true;break;case "u_ssao_influence":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_influence)};break;case "u_ssao_dist_factor":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.ssao_dist_factor)};break;
case "u_dof_dist":var fun=function(gl,loc,subscene,obj_render,batch,camera){if(camera.dof_on)gl.uniform1f(loc,camera.dof_distance);else gl.uniform1f(loc,0)};transient_uni=true;break;case "u_dof_front":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_front)};transient_uni=true;break;case "u_dof_rear":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,camera.dof_rear)};transient_uni=true;break;case "u_outline_intensity":var fun=function(gl,
loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,obj_render.outline_intensity)};transient_uni=true;break;case "u_outline_color":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform3fv(loc,subscene.outline_color)};break;case "u_draw_outline":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.draw_outline_flag)};transient_uni=true;break;case "u_glow_mask_small_coeff":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.small_glow_mask_coeff)};
transient_uni=true;break;case "u_glow_mask_large_coeff":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.large_glow_mask_coeff)};transient_uni=true;break;case "u_brightness":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.brightness)};break;case "u_contrast":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.contrast)};break;case "u_exposure":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,
subscene.exposure)};break;case "u_saturation":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1f(loc,subscene.saturation)};break;case "u_enable_hmd_stereo":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform1i(loc,subscene.enable_hmd_stereo)};break;case "u_distortion_params":var fun=function(gl,loc,subscene,obj_render,batch,camera){gl.uniform4fv(loc,subscene.distortion_params)};break;case "u_chromatic_aberration_coefs":var fun=function(gl,loc,subscene,obj_render,
batch,camera){gl.uniform4fv(loc,subscene.chromatic_aberration_coefs)};break;default:var fun=null;break}if(fun){var setter={name:uni,fun:fun,loc:uniforms[uni]};if(transient_uni)transient_uniform_setters.push(setter);else{permanent_uniform_setters.push(setter);permanent_uniform_setters_table[uni]=setter}}}shader.transient_uniform_setters=transient_uniform_setters;if(permanent_uniform_setters.length){shader.permanent_uniform_setters=permanent_uniform_setters;shader.permanent_uniform_setters_table=permanent_uniform_setters_table}else shader.no_permanent_uniforms=
true}exports.assign_texture_uniforms=function(batch){var shader=batch.shader;var textures=batch.textures;var names=batch.texture_names;_gl.useProgram(shader.program);for(var i=0;i<textures.length;i++){var tex=textures[i];var name=names[i];_gl.uniform1i(shader.uniforms[name],i)}};function setup_textures(textures){for(var i=0;i<textures.length;i++){var tex=textures[i];_gl.activeTexture(_gl.TEXTURE0+i);_gl.bindTexture(tex.w_target,tex.w_texture)}}exports.read_pixels=read_pixels;function read_pixels(framebuffer,
x,y,width,height,storage){if(!width)var width=1;if(!height)var height=1;if(!storage)var storage=new Uint8Array(4*width*height);if(storage.length!=4*width*height)m_util.panic("read_pixels(): Wrong storage");_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.readPixels(x,y,width,height,_gl.RGBA,_gl.UNSIGNED_BYTE,storage);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return storage}exports.update_batch_permanent_uniform=function(batch,uni_name){var shader=batch.shader;if(shader.no_permanent_uniforms)return;
_gl.useProgram(shader.program);if(!shader.permanent_uniform_setters.length)assign_uniform_setters(shader);var setter=shader.permanent_uniform_setters_table[uni_name];setter.fun(_gl,setter.loc,null,null,batch,null)};exports.render_target_create=function(color_attachment,depth_attachment){var framebuffer=_gl.createFramebuffer();_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);if(m_textures.is_renderbuffer(color_attachment)){var renderbuffer=color_attachment.w_renderbuffer;_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,
_gl.COLOR_ATTACHMENT0,_gl.RENDERBUFFER,renderbuffer)}else if(m_textures.is_texture(color_attachment)){var texture=color_attachment;var w_tex=texture.w_texture;var w_target=texture.w_target==_gl.TEXTURE_CUBE_MAP?_gl.TEXTURE_CUBE_MAP_NEGATIVE_Z:texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_tex,0)}if(m_textures.is_renderbuffer(depth_attachment)){var renderbuffer=depth_attachment.w_renderbuffer;_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,
_gl.RENDERBUFFER,renderbuffer)}else if(m_textures.is_texture(depth_attachment)){var texture=depth_attachment;var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,w_target,w_tex,0)}m_debug.check_bound_fb();_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);return framebuffer};exports.render_target_cleanup=function(framebuffer,color_attachment,depth_attachment,width,height){if(framebuffer==null){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);
_gl.viewport(0,0,width,height);_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT);return}if(m_textures.is_renderbuffer(color_attachment))_gl.deleteRenderbuffer(color_attachment.w_renderbuffer);else if(m_textures.is_texture(color_attachment))_gl.deleteTexture(color_attachment.w_texture);if(m_textures.is_renderbuffer(depth_attachment))_gl.deleteRenderbuffer(depth_attachment.w_renderbuffer);else if(m_textures.is_texture(depth_attachment))_gl.deleteTexture(depth_attachment.w_texture);_gl.deleteFramebuffer(framebuffer)};
exports.increment_subpixel_index=function(){_subpixel_index=(_subpixel_index+1)%2};exports.draw_resized_cubemap_texture=function(texture,w_target,pot_dim,img_dim,w_tex,tex_num){var w_texture=texture.w_texture;_gl.viewport(0,0,pot_dim,pot_dim);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_texture,0);var batch=m_batch.create_postprocessing_batch("FLIP_CUBEMAP_COORDS");var shader=batch.shader;_gl.activeTexture(_gl.TEXTURE0);_gl.bindTexture(_gl.TEXTURE_2D,w_tex);var delta_x=
0;var delta_y=0;if(pot_dim!=img_dim){delta_x=1/(6*img_dim);delta_y=1/(4*img_dim)}_gl.uniform1i(shader.uniforms["u_tex_number"],tex_num);_gl.uniform2fv(shader.uniforms["u_delta"],[delta_x,delta_y]);_gl.useProgram(shader.program);var attribute_setters=batch.attribute_setters;var bufs_data=batch.bufs_data;draw_buffers(bufs_data,attribute_setters,0);_gl.bindTexture(_gl.TEXTURE_2D,null)};exports.draw_resized_texture=function(texture,size_x,size_y,fbo,w_tex,batch_type){_gl.bindFramebuffer(_gl.FRAMEBUFFER,
fbo);var w_texture=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);_gl.viewport(0,0,size_x,size_y);_gl.texImage2D(w_target,0,_gl.RGBA,size_x,size_y,0,_gl.RGBA,_gl.UNSIGNED_BYTE,null);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,w_target,w_texture,0);var batch=m_batch.create_postprocessing_batch(batch_type);var shader=batch.shader;_gl.bindTexture(w_target,null);_gl.activeTexture(_gl.TEXTURE0);_gl.bindTexture(w_target,w_tex);_gl.useProgram(shader.program);
var attribute_setters=batch.attribute_setters;var bufs_data=batch.bufs_data;draw_buffers(bufs_data,attribute_setters,0);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);_gl.bindTexture(w_target,null)};exports.cleanup=function(){_subpixel_index=0}};b4w.module["__shaders"]=function(exports,require){var m_assets=require("__assets");var m_cfg=require("__config");var m_debug=require("__debug");var m_print=require("__print");var m_util=require("__util");var cfg_pth=m_cfg.paths;var _compiled_shaders={};var _shader_ast_cache={};var _shader_texts=null;var SHADERS=["anchors.glslf","anchors.glslv","color_id.glslf","color_id.glslv","shadow.glslf","shadow.glslv","grass_map.glslf","grass_map.glslv","halo.glslf","halo.glslv","line.glslf","line.glslv","main.glslf",
"main.glslv","main_stack.glslf","particle_system.glslf","particle_system_stack.glslf","particle_system.glslv","procedural_skydome.glslf","procedural_skydome.glslv","special_lens_flares.glslf","special_lens_flares.glslv","special_skydome.glslf","special_skydome.glslv","special_water.glslf","special_water.glslv","debug_view.glslf","debug_view.glslv","postprocessing/antialiasing.glslf","postprocessing/bloom_combine.glslf","postprocessing/compositing.glslf","postprocessing/depth_pack.glslf","postprocessing/dof.glslf",
"postprocessing/glow.glslf","postprocessing/bloom_blur.glslf","postprocessing/god_rays.glslf","postprocessing/god_rays.glslv","postprocessing/god_rays_combine.glslf","postprocessing/luminance.glslf","postprocessing/luminance_av.glslf","postprocessing/luminance_trunced.glslf","postprocessing/luminance_trunced.glslv","postprocessing/motion_blur.glslf","postprocessing/outline.glslf","postprocessing/performance.glslf","postprocessing/postprocessing.glslf","postprocessing/postprocessing.glslv","postprocessing/smaa.glslf",
"postprocessing/smaa.glslv","postprocessing/ssao.glslf","postprocessing/ssao_blur.glslf","postprocessing/stereo.glslf","include/blending.glslf","include/caustics.glslf","include/color_util.glslf","include/depth_fetch.glslf","include/dynamic_grass.glslv","include/environment.glslf","include/fog.glslf","include/fxaa.glslf","include/halo_color.glslf","include/lighting_nodes.glslf","include/math.glslv","include/mirror.glslf","include/nodes.glslf","include/nodes.glslv","include/pack.glslf","include/particles.glslv",
"include/particles_nodes.glslf","include/particles_nodes.glslv","include/precision_statement.glslf","include/procedural.glslf","include/refraction.glslf","include/scale_texcoord.glslv","include/shadow.glslf","include/shadow.glslv","include/skin.glslv","include/std_enums.glsl","include/to_world.glslv","include/wind_bending.glslv"];var DEBUG_COMPILATION_UNIQUENESS=false;var _debug_hash_codes=[];var _gl=null;var _shaders_loaded=false;exports.setup_context=function(gl){_gl=gl};exports.set_directive=set_directive;
function set_directive(shaders_info,name,value){var dirs=shaders_info.directives;if(typeof value=="string"){var dir=get_directive(shaders_info,value);if(dir)var value=dir[1]}for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name){dirs[i][1]=value;return}dirs.push([name,value])}exports.get_directive=get_directive;function get_directive(shaders_info,name){var dirs=shaders_info.directives;for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name)return dirs[i];return false}exports.is_enabled=function(shaders_info,
name){var dirs=shaders_info.directives;for(var i=0;i<dirs.length;i++)if(dirs[i][0]==name&&dirs[i][1]==1)return true;return false};exports.set_default_directives=function(sinfo){sinfo.directives=[];var dir_names=["ALPHA","ALPHA_CLIP","ANAGLYPH","BEND_CENTER_ONLY","BILLBOARD_PRES_GLOB_ORIENTATION","CAUSTICS","CSM_BLEND_BETWEEEN_CASCADES","CSM_FADE_LAST_CASCADE","CSM_SECTION0","CSM_SECTION1","CSM_SECTION2","CSM_SECTION3","DEBUG_SPHERE","DEBUG_SPHERE_DYNAMIC","DEPTH_RGBA","DISABLE_DISTORTION_CORRECTION",
"DISABLE_FOG","DOUBLE_SIDED_LIGHTING","DYNAMIC","DYNAMIC_GRASS","DYNAMIC_GRASS_COLOR","DYNAMIC_GRASS_SIZE","FOAM","FRAMES_BLENDING","BILLBOARD_JITTERED","BILLBOARD_SPHERICAL","HAIR_BILLBOARD","SHADOW_TEX_RES","MAIN_BEND_COL","MAX_BONES","NUM_NORMALMAPS","PARALLAX","PARALLAX_STEPS","PROCEDURAL_FOG","PROCEDURAL_SKYDOME","REFLECTION","REFLECTION_PASS","REFLECTION_TYPE","REFRACTIVE","USE_REFRACTION","USE_REFRACTION_CORRECTION","SHORE_SMOOTHING","SKINNED","SKY_COLOR","SKY_TEXTURE","SSAO_HEMISPHERE","SSAO_BLUR_DEPTH",
"SSAO_ONLY","SSAO_WHITE","STATIC_BATCH","TEXTURE_COLOR","TEXTURE_NORM","TEXTURE_SPEC","TEXTURE_STENCIL_ALPHA_MASK","VERTEX_ANIM","VERTEX_ANIM_MIX_NORMALS_FACTOR","VERTEX_COLOR","WATER_EFFECTS","WIND_BEND","DETAIL_BEND","SHORE_PARAMS","ALPHA_AS_SPEC","DEPTH_RGBA","MTEX_NEGATIVE","MTEX_RGBTOINT","NUM_LIGHTS","NUM_LFACTORS","NUM_LAMP_LIGHTS","MAX_STEPS","BILLBOARD_ALIGN","SHADOW_USAGE","POST_EFFECT","SSAO_QUALITY","TEXTURE_BLEND_TYPE","TEXTURE_COORDS","AA_METHOD","AU_QUALIFIER","BILLBOARD","BILLBOARD_RANDOM",
"PRECISION","EPSILON","USE_ENVIRONMENT_LIGHT","USE_FOG","WEBGL2","WO_SKYBLEND","WO_SKYPAPER","WO_SKYREAL","WO_SKYTEX","WOMAP_BLEND","WOMAP_HORIZ","WOMAP_ZENUP","WOMAP_ZENDOWN","WIREFRAME_QUALITY","SIZE_RAMP_LENGTH","COLOR_RAMP_LENGTH","PARTICLES_SHADELESS","NUM_CAST_LAMPS","SUN_NUM","MAC_OS_SHADOW_HACK","USE_COLOR_RAMP","HALO_PARTICLES","PARTICLE_BATCH"];for(var i=0;i<dir_names.length;i++){var name=dir_names[i];var val;switch(name){case "ALPHA":case "ALPHA_CLIP":case "ANAGLYPH":case "BILLBOARD_PRES_GLOB_ORIENTATION":case "CAUSTICS":case "CSM_SECTION0":case "CSM_SECTION1":case "CSM_SECTION2":case "CSM_SECTION3":case "DEBUG_SPHERE":case "DEBUG_SPHERE_DYNAMIC":case "DEPTH_RGBA":case "DISABLE_DISTORTION_CORRECTION":case "DISABLE_FOG":case "DOUBLE_SIDED_LIGHTING":case "DYNAMIC":case "DYNAMIC_GRASS":case "DYNAMIC_GRASS_COLOR":case "DYNAMIC_GRASS_SIZE":case "FOAM":case "FRAMES_BLENDING":case "BILLBOARD_JITTERED":case "MAIN_BEND_COL":case "MAX_BONES":case "MTEX_NEGATIVE":case "MTEX_RGBTOINT":case "NUM_LIGHTS":case "NUM_LFACTORS":case "NUM_NORMALMAPS":case "PARALLAX":case "PARALLAX_STEPS":case "PROCEDURAL_FOG":case "PROCEDURAL_SKYDOME":case "REFLECTION":case "REFLECTION_PASS":case "REFLECTION_TYPE":case "REFRACTIVE":case "USE_REFRACTION":case "USE_REFRACTION_CORRECTION":case "SHORE_SMOOTHING":case "SKINNED":case "SKY_COLOR":case "SKY_TEXTURE":case "SSAO_HEMISPHERE":case "SSAO_BLUR_DEPTH":case "SSAO_ONLY":case "SSAO_WHITE":case "STATIC_BATCH":case "TEXTURE_COLOR":case "TEXTURE_NORM":case "TEXTURE_SPEC":case "TEXTURE_STENCIL_ALPHA_MASK":case "VERTEX_ANIM":case "VERTEX_COLOR":case "WATER_EFFECTS":case "WIND_BEND":case "DETAIL_BEND":case "SHORE_PARAMS":case "BILLBOARD":case "BILLBOARD_RANDOM":case "HAIR_BILLBOARD":case "USE_ENVIRONMENT_LIGHT":case "USE_FOG":case "WO_SKYBLEND":case "WO_SKYPAPER":case "WO_SKYREAL":case "WO_SKYTEX":case "WOMAP_BLEND":case "WOMAP_HORIZ":case "WOMAP_ZENUP":case "WOMAP_ZENDOWN":case "WIREFRAME_QUALITY":case "SIZE_RAMP_LENGTH":case "COLOR_RAMP_LENGTH":case "PARTICLES_SHADELESS":case "SMAA_JITTER":case "NUM_CAST_LAMPS":case "SUN_NUM":case "MAC_OS_SHADOW_HACK":case "USE_COLOR_RAMP":case "HALO_PARTICLES":case "PARTICLE_BATCH":val=
0;break;case "ALPHA_AS_SPEC":case "BEND_CENTER_ONLY":case "CSM_BLEND_BETWEEEN_CASCADES":case "CSM_FADE_LAST_CASCADE":case "DEPTH_RGBA":case "BILLBOARD_SPHERICAL":case "NUM_LAMP_LIGHTS":case "MAX_STEPS":val=1;break;case "WEBGL2":val=m_cfg.defaults.webgl2|0;break;case "EPSILON":if(m_cfg.defaults.precision=="highp")val=1E-6;else val=1E-4;break;case "SHADOW_TEX_RES":val=glsl_value(2048);break;case "AA_METHOD":val="AA_METHOD_FXAA_QUALITY";break;case "AU_QUALIFIER":val="NOT_ASSIGNED";break;case "BILLBOARD_ALIGN":val=
"BILLBOARD_ALIGN_VIEW";break;case "POST_EFFECT":val="POST_EFFECT_NONE";break;case "SHADOW_USAGE":val="NO_SHADOWS";break;case "SSAO_QUALITY":val="SSAO_QUALITY_32";break;case "TEXTURE_BLEND_TYPE":val="TEXTURE_BLEND_TYPE_MIX";break;case "TEXTURE_COORDS":val="TEXTURE_COORDS_UV_ORCO";break;case "PRECISION":val=m_cfg.defaults.precision;break;case "VERTEX_ANIM_MIX_NORMALS_FACTOR":val="u_va_frame_factor";break;default:m_print.error("Unknown directive ("+sinfo.vert+", "+sinfo.frag+"): "+name);break}set_directive(sinfo,
name,val)}};exports.get_vname=function(sinfo){return sinfo.vert};exports.get_fname=function(sinfo){return sinfo.frag};exports.inherit_directives=function(sinfo_to,sinfo_from){var dirs=sinfo_from.directives;for(var i=0;i<dirs.length;i++){var name=dirs[i][0];var value=dirs[i][1];if(get_directive(sinfo_to,name))set_directive(sinfo_to,name,value)}};exports.get_compiled_shader=get_compiled_shader;function get_compiled_shader(shaders_info){var shader_id=JSON.stringify(shaders_info);var compiled_shader=
_compiled_shaders[shader_id];if(compiled_shader)return compiled_shader;var vshader=shaders_info.vert;var fshader=shaders_info.frag;var vshader_ast=get_shader_ast(cfg_pth.shaders_dir,vshader);var fshader_ast=get_shader_ast(cfg_pth.shaders_dir,fshader);if(!vshader_ast||!fshader_ast)return null;var vshader_text=preprocess_shader("vert",vshader_ast,shaders_info);var fshader_text=preprocess_shader("frag",fshader_ast,shaders_info);_compiled_shaders[shader_id]=compiled_shader=init_shader(_gl,vshader_text,
fshader_text,shader_id,shaders_info);return compiled_shader}function get_shader_ast(dir,filename){var cache_id=dir+filename;if(_shader_ast_cache[cache_id])return _shader_ast_cache[cache_id];if(!_shader_texts){var ast=require("shader_texts")[filename];if(!ast)return null}else{var main_text=_shader_texts[filename];if(!main_text)return null;var ast=require("__gpp_parser").parser.parse(main_text)}_shader_ast_cache[cache_id]=ast;return ast}function set_shader_texts(shader_name,shadet_text){if(!_shader_texts)_shader_texts=
{};_shader_texts[shader_name]=shadet_text}exports.load_shaders=function(){_shaders_loaded=false;if(!b4w.module_check("shader_texts")){var shader_assets=[];var asset_type=m_assets.AT_TEXT;for(var i=0;i<SHADERS.length;i++){var shader_path=m_util.normpath_preserve_protocol(cfg_pth.shaders_dir+SHADERS[i]);shader_assets.push({id:SHADERS[i],type:asset_type,url:shader_path})}var asset_cb=function(shader_text,shader_name,type,path){set_shader_texts(shader_name,shader_text)};var pack_cb=function(){_shaders_loaded=
true};if(shader_assets.length)m_assets.enqueue(shader_assets,asset_cb,pack_cb);else m_print.error("Shaders have not been found.")}else _shaders_loaded=true};exports.check_shaders_loaded=function(){return _shaders_loaded};function preprocess_shader(type,ast,shaders_info){var node_elements=shaders_info.node_elements;var dirs_arr=shaders_info.directives||[];var lines=[];var dirs={};for(var i=0;i<dirs_arr.length;i++)dirs[dirs_arr[i][0]]=[dirs_arr[i][1]];for(var i=0;i<node_elements.length;i++)dirs["USE_NODE_"+
node_elements[i].id]=[1];var fdirs={};var shader_nodes={};var usage_inputs=[];for(var i in node_elements)for(var j in node_elements[i].inputs)usage_inputs.push(node_elements[i].inputs[j]);process_group(ast);var text=lines.join("\n");var input_index=0;var output_index=0;var param_index=0;return text;function process_group(elem){var parts=elem.parts;for(var i=0;i<parts.length;i++){var pelem=parts[i];switch(pelem.type){case "condition":process_condition(pelem);break;case "include":process_include(pelem);
break;case "var":case "export":case "import":break;case "define":process_define(pelem);break;case "error":process_error(pelem);break;case "line":break;case "pragma":process_pragma(pelem);break;case "undef":process_undef(pelem);break;case "warning":process_warning(pelem);break;case "extension":process_extension(pelem);break;case "#":break;case "node":process_node(pelem);break;case "nodes_global":process_nodes_global(node_elements);break;case "nodes_main":process_nodes_main(node_elements);break;case "textline":process_textline(pelem);
break;default:throw"Unknown element type: "+pelem.type;break}}}function process_condition(elem){var parts=elem.parts;for(var i=0;i<parts.length;i++){var pelem=parts[i];switch(pelem.type){case "if":case "elif":var expression=pelem.expression;var result=expression_result(expression);if(result){process_group(pelem.group);return}break;case "else":process_group(pelem.group);return;case "ifdef":if(pelem.name in dirs)process_group(pelem.group);break;case "ifndef":if(!(pelem.name in dirs))process_group(pelem.group);
break}}}function expression_result(expression,node_dirs){var expr_list=expand_macro(expression,dirs,fdirs,true,node_dirs);return eval_expression(expr_list)}function eval_expression(expr_list){var operand_stack=[];for(var i=0;i<expr_list.length;i++)if(!(expr_list[i]instanceof Object)){var operand=expr_list[i];var expr_identifier=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/;if(expr_identifier.test(operand))operand_stack.push(0);else operand_stack.push(parseFloat(expr_list[i]))}else switch(expr_list[i].type){case "conditional_expr":var falseExpression=
operand_stack.pop();var trueExpression=operand_stack.pop();var condition=operand_stack.pop();if(condition)operand_stack.push(trueExpression);else operand_stack.push(falseExpression);break;case "logical_or_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++){var operand=operand_stack.pop();result=result||operand}operand_stack.push(result);break;case "logical_and_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++){var operand=operand_stack.pop();result=
result&&operand}operand_stack.push(result);break;case "logical_bitor_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++)result|=operand_stack.pop();operand_stack.push(result);break;case "logical_bitxor_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++)result^=operand_stack.pop();operand_stack.push(result);break;case "logical_bitand_expr":var result=operand_stack.pop();for(var j=0;j<expr_list[i].places-1;j++)result&=operand_stack.pop();operand_stack.push(result);
break;case "equal_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1==operand2);break;case "non_equal_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1!=operand2);break;case "le_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1<=operand2);break;case "ge_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1>=
operand2);break;case "l_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1<operand2);break;case "g_expr":var operand2=operand_stack.pop();var operand1=operand_stack.pop();operand_stack.push(operand1>operand2);break;case "left_shift_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1<<operand2);break;case "right_shift_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1>>
operand2);break;case "add_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1+operand2);break;case "sub_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1-operand2);break;case "mul_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1*operand2);break;case "div_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1/
operand2);break;case "mod_expr":var operand1=operand_stack.pop();var operand2=operand_stack.pop();operand_stack.push(operand1%operand2);break;case "pre_inc_expr":case "post_inc_expr":var operand=operand_stack.pop();operand_stack.push(++operand);break;case "pre_dec_expr":case "post_dec_expr":var operand=operand_stack.pop();operand_stack.push(--operand);break;case "positive_expr":var operand=operand_stack.pop();operand_stack.push(+operand);break;case "negative_expr":var operand=operand_stack.pop();
operand_stack.push(-operand);break;case "one_compl_expr":var operand=operand_stack.pop();operand_stack.push(~operand);break;case "logic_negative_expr":var operand=operand_stack.pop();operand_stack.push(!operand);break;default:m_util.panic("Unknown operation type: "+expr_list[i].type);break}if(operand_stack.length==1)return operand_stack[0];else m_util.panic("Incorrect expression: "+expr_list.join(" "))}function process_include(elem){var file=elem.file;var ast_inc=get_shader_ast(cfg_pth.shaders_dir,
cfg_pth.shaders_include_dir+file);process_group(ast_inc)}function process_define(elem){var name=elem.name;var tokens=elem.tokens;dirs[name]=tokens;if(elem.params)fdirs[name]=elem.params}function process_error(elem){var tokens=elem.tokens;throw"Shader error: #error "+tokens.join(" ");}function process_pragma(elem){var name=elem.name;var tokens=elem.tokens;lines.push("#pragma "+name+" "+tokens.join(" "))}function process_undef(elem){var name=elem.name;delete dirs[name];delete fdirs[name]}function process_warning(elem){var tokens=
elem.tokens;m_print.warn("Shader warning: #warning "+tokens.join(" "))}function process_extension(elem){var tokens=elem.tokens;var token_list=expand_macro(tokens,dirs,fdirs,false);lines.push("#extension "+token_list.join(" "))}function process_node(elem){shader_nodes[elem.name]=elem}function check_optional_node_param(nelem,decl,param_index){if(nelem.id=="PARTICLE_INFO"&&decl.is_optional){if(dirs["PARTICLE_BATCH"]==1){var node_param_usage=false;switch(param_index){case 0:node_param_usage=particle_output_usage(nelem.dirs,
"PART_INFO_IND")||particle_output_usage(nelem.dirs,"PART_INFO_AGE")||particle_output_usage(nelem.dirs,"PART_INFO_LT")||particle_output_usage(nelem.dirs,"PART_INFO_SIZE");break;case 1:node_param_usage=particle_output_usage(nelem.dirs,"PART_INFO_LOC");break;case 2:node_param_usage=particle_output_usage(nelem.dirs,"PART_INFO_VEL");break;case 3:node_param_usage=particle_output_usage(nelem.dirs,"PART_INFO_A_VEL");break;case 4:node_param_usage=particle_output_usage(nelem.dirs,"PART_INFO_IND")}return node_param_usage}return false}return true}
function process_nodes_global(node_elements){for(var i=0;i<node_elements.length;i++){var nelem=node_elements[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;var param_index=0;for(var j=0;j<node_parts.declarations.length;j++){var decl=node_parts.declarations[j];if(decl.type=="node_param"){if(check_optional_node_param(nelem,decl,param_index)){var glob_var_line=decl.qualifier.join(" ")+" ";if(type=="vert")glob_var_line+=nelem.vparams[param_index];else if(type=="frag"){glob_var_line+=
nelem.params[param_index];if(nelem.param_values[param_index]!==null)glob_var_line+=" = "+nelem.param_values[param_index]}glob_var_line+=";";lines.push(glob_var_line)}param_index++}}}}function process_nodes_main(nodes){for(var i=0;i<nodes.length;i++){var nelem=nodes[i];var node_parts=shader_nodes[nelem.id];if(!node_parts)continue;var replaces={};var node_dirs={};for(var j=0;j<nelem.dirs.length;j++)node_dirs[nelem.dirs[j][0]]=[nelem.dirs[j][1]];input_index=0;output_index=0;param_index=0;process_node_declaration(nelem,
node_parts.declarations,replaces,node_dirs);lines.push("{");process_node_statements(nelem,node_parts.statements,replaces,node_dirs);lines.push("}")}}function process_node_declaration(nelem,declarations,replaces,node_dirs){for(var j=0;j<declarations.length;j++){var decl=declarations[j];switch(decl.type){case "node_in":var new_name=nelem.inputs[input_index];if(nelem.input_values[input_index]!==null){if((nelem.id=="MATERIAL_BEGIN"&&input_index===3||!node_dirs["MATERIAL_EXT"]&&(nelem.id=="MATERIAL_BEGIN"&&
input_index===4||nelem.id=="MATERIAL_END"&&input_index===3||nelem.id=="MATERIAL_END"&&input_index===4||nelem.id=="MATERIAL_END"&&input_index===5)||nelem.id=="TEXTURE_COLOR"||nelem.id=="TEXTURE_NORMAL")&&decl.is_optional){replaces[decl.name]=nelem.input_values[input_index];input_index++;continue}var main_var_line=decl.qualifier.join(" ")+" ";main_var_line+=new_name;main_var_line+=" = "+nelem.input_values[input_index];main_var_line+=";";lines.push(main_var_line)}replaces[decl.name]=new_name;input_index++;
break;case "node_out":var new_name=nelem.outputs[output_index];if(!decl.is_optional||usage_inputs.indexOf(new_name)>-1){var main_var_line=decl.qualifier.join(" ")+" ";main_var_line+=new_name;main_var_line+=";";lines.push(main_var_line);replaces[decl.name]=new_name}if(usage_inputs.indexOf(new_name)>-1)node_dirs["USE_OUT_"+decl.name]=[1];output_index++;break;case "node_param":if(type=="vert")var new_name=nelem.vparams[param_index];else if(type=="frag")var new_name=nelem.params[param_index];replaces[decl.name]=
new_name;param_index++;break}}return replaces}function process_node_statements(nelem,statements,replaces,node_dirs){for(var i=0;i<statements.length;i++){var part=statements[i];switch(part.type){case "node_condition":process_node_condition(nelem,part.parts,replaces,node_dirs);break;case "textline":var tokens=[];for(var k=0;k<part.tokens.length;k++){var tok=part.tokens[k];if(tok in replaces)tokens.push(replaces[tok]);else tokens.push(tok)}var token_list=expand_macro(tokens,dirs,fdirs,true,node_dirs);
lines.push(token_list.join(" "));break}}}function process_node_condition(nelem,node_if_elements,replaces,node_dirs){for(var i=0;i<node_if_elements.length;i++){var nielem=node_if_elements[i];switch(nielem.type){case "node_if":case "node_elif":var expression=nielem.expression;var result=expression_result(expression,node_dirs);if(result){process_node_statements(nelem,nielem.statements,replaces,node_dirs);return}break;case "node_else":process_node_statements(nelem,nielem.statements,replaces,node_dirs);
return;case "node_ifdef":if(nielem.name in dirs||nielem.name in node_dirs)process_node_statements(nelem,nielem.statements,replaces,node_dirs);break;case "node_ifndef":if(!(nielem.name in dirs)&&!(nielem.name in node_dirs))process_node_statements(nelem,nielem.statements,replaces,node_dirs);break}}}function process_textline(elem){var tokens=elem.tokens;var token_list=expand_macro(tokens,dirs,fdirs,false);lines.push(token_list.join(" "))}}function expand_macro(tokens,dirs,fdirs,empty_as_zero,node_dirs){var result=
[];expand_macro_iter(tokens,dirs,fdirs,empty_as_zero,result,node_dirs);return result}function expand_macro_iter(tokens,dirs,fdirs,empty_as_zero,result,node_dirs){for(var i=0;i<tokens.length;i++){var token=tokens[i];if(token in dirs||node_dirs&&token in node_dirs){var new_tokens=node_dirs&&node_dirs[token]||dirs[token];if(new_tokens.length==0&&empty_as_zero)result.push(0);else expand_macro_iter(new_tokens,dirs,fdirs,empty_as_zero,result,node_dirs)}else result.push(token)}}function init_shader(gl,vshader_text,
fshader_text,shader_id,shaders_info){var vshader=compile_shader(gl,shader_id,vshader_text,gl.VERTEX_SHADER,shaders_info);var fshader=compile_shader(gl,shader_id,fshader_text,gl.FRAGMENT_SHADER,shaders_info);var program=gl.createProgram();gl.attachShader(program,vshader);gl.attachShader(program,fshader);gl.linkProgram(program);gl.validateProgram(program);if(gl.getProgramParameter(program,gl.VALIDATE_STATUS)==gl.FALSE)m_print.error("shader program is not valid",shader_id);m_debug.check_shader_linking(program,
shader_id,vshader,fshader,vshader_text,fshader_text);var compiled_shader={vshader:vshader,fshader:fshader,program:program,attributes:{},uniforms:{},permanent_uniform_setters:[],permanent_uniform_setters_table:{},need_uniforms_update:true,no_permanent_uniforms:false,transient_uniform_setters:[],shaders_info:shaders_info};var att_count=gl.getProgramParameter(program,gl.ACTIVE_ATTRIBUTES);for(var i=0;i<att_count;i++){var att=gl.getActiveAttrib(program,i);var att_name=att.name;var att_loc=gl.getAttribLocation(program,
att_name);compiled_shader.attributes[att_name]=att_loc}var uni_count=gl.getProgramParameter(program,gl.ACTIVE_UNIFORMS);for(var i=0;i<uni_count;i++){var uni=gl.getActiveUniform(program,i);var uni_name=uni.name.split("[0]").join("");var uni_loc=gl.getUniformLocation(program,uni_name);compiled_shader.uniforms[uni_name]=uni_loc}return compiled_shader}exports.debug_get_compilation_stats=function(){return _debug_hash_codes};function debug_compilation_uniqueness(shader_id,shader_text,shader_type,shaders_info){if(shader_type==
_gl.VERTEX_SHADER)var shader_filename=shaders_info.vert;else var shader_filename=shaders_info.frag;var hc=m_util.hash_code_string(shader_text,0);var info=_debug_hash_codes[hc];if(info)info.count++;else{info={count:1,shader_filename:shader_filename,hc:hc};_debug_hash_codes[hc]=info}}function compile_shader(gl,shader_id,shader_text,shader_type,shaders_info){if(DEBUG_COMPILATION_UNIQUENESS)debug_compilation_uniqueness(shader_id,shader_text,shader_type,shaders_info);var shader=gl.createShader(shader_type);
gl.shaderSource(shader,shader_text);gl.compileShader(shader);m_debug.check_shader_compiling(shader,shader_id,shader_text);return shader}exports.get_compiled_shaders=function(){return _compiled_shaders};exports.cleanup=cleanup;function cleanup(){for(var shader_id in _compiled_shaders){var shader=_compiled_shaders[shader_id];_gl.deleteProgram(shader.program);_gl.deleteShader(shader.vshader);_gl.deleteShader(shader.fshader);delete _compiled_shaders[shader_id]}for(var id in _shader_ast_cache)delete _shader_ast_cache[id];
for(var hc in _debug_hash_codes)delete _debug_hash_codes[hc]}exports.debug_shaders_info=function(shaders_info){var dirs=shaders_info.directives;m_print.log("Shader: "+shaders_info.vert+" "+shaders_info.frag+", "+String(dirs.length)+" directives: ");for(var i=0;i<dirs.length;i++)m_print.log("  "+dirs[i][0],dirs[i][1])};exports.glsl_value=glsl_value;function glsl_value(value,dim){if(!dim&&value.length)dim=value.length;else if(!dim)dim=1;switch(dim){case 1:return glsl_float(value);break;case 2:return"vec2("+
glsl_float(value[0])+","+glsl_float(value[1])+")";break;case 3:return"vec3("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+")";break;case 4:return"vec4("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+")";break;case 9:return"mat3("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+","+glsl_float(value[4])+","+glsl_float(value[5])+","+glsl_float(value[6])+","+glsl_float(value[7])+
","+glsl_float(value[8])+")";break;case 16:return"mat4("+glsl_float(value[0])+","+glsl_float(value[1])+","+glsl_float(value[2])+","+glsl_float(value[3])+","+glsl_float(value[4])+","+glsl_float(value[5])+","+glsl_float(value[6])+","+glsl_float(value[7])+","+glsl_float(value[8])+","+glsl_float(value[9])+","+glsl_float(value[10])+","+glsl_float(value[11])+","+glsl_float(value[12])+","+glsl_float(value[13])+","+glsl_float(value[14])+","+glsl_float(value[15])+")";break;default:throw"Wrong glsl value dimension";
break}}function glsl_float(value){return value%1?String(value):String(value)+".0"}exports.check_uniform=function(shader,name){if(name in shader.uniforms)return true;else return false};exports.get_varyings_count=function(shader){return(_gl.getShaderSource(shader).match(/(?:^|\s)varying(?=\s)/g)||[]).length};function particle_output_usage(ndirs,dir){for(var i=0;i<ndirs.length;i++)if(ndirs[i][0]==dir)return true;return false}};b4w.module["__geometry"]=function(exports,require){var m_bounds=require("__boundings");var m_ext=require("__extensions");var m_print=require("__print");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _bb_corners_tmp=new Float32Array(24);var MAX_SUBMESH_LENGTH=256*256;var BINARY_FLOAT_SIZE=4;var COMB_SORT_JUMP_COEFF=1.247330950103979;var POS_NUM_COMP=3;var NOR_NUM_COMP=
3;var TAN_NUM_COMP=4;var COL_NUM_COMP=3;var INFLUENCE_NUM_COMP=4;exports.DM_TRIANGLES=10;exports.DM_POINTS=20;exports.DM_DYNAMIC_TRIANGLES=30;exports.DM_DYNAMIC_POINTS=40;exports.DM_LINES=50;exports.SORT_NUMERIC=0;exports.SORT_STRING=1;exports.DM_DEFAULT=exports.DM_TRIANGLES;var _gl=null;exports.setup_context=function(gl){_gl=gl};exports.delete_buffers=function(geometry_id){var buffers=_buffers[geometry_id];_gl.deleteBuffer(buffers.ibo);_gl.deleteBuffer(buffers.vbo);delete _buffers[geometry_id]};
exports.submesh_to_bufs_data=function(submesh,z_sort,draw_mode,vc_usage){if(is_long_submesh(submesh))submesh_drop_indices(submesh);var indices=submesh.indices;var base_length=submesh.base_length;var va_frames=submesh.va_frames;var va_common={};for(var attr_name in submesh.va_common)if(!(attr_name in vc_usage)||vc_usage[attr_name].generate_buffer)va_common[attr_name]=submesh.va_common[attr_name];var bufs_data=init_bufs_data();if(submesh.shape_keys.length>0)submesh_init_shape_keys(submesh,va_frames[0]);
generate_bufs_data_arrays(bufs_data,indices,va_frames,va_common,base_length);update_draw_mode(bufs_data,draw_mode);update_gl_buffers(bufs_data);if(z_sort&&is_indexed(submesh)){var positions=va_frames[0]["a_position"];bufs_data.info_for_z_sort_updates={median_cache:new Float32Array(indices.length),median_world_cache:new Float32Array(indices.length),dist_cache:new Float32Array(indices.length/3),zsort_eye_last:new Float32Array(3),bb_min_side:m_bounds.calc_min_bb_side(submesh.submesh_bd.bb_local)}}bufs_data.shape_keys=
submesh.shape_keys;return bufs_data};exports.submesh_init_shape_keys=submesh_init_shape_keys;function submesh_init_shape_keys(submesh,frame){for(var i=1;i<submesh.shape_keys.length;i++){var geometry=submesh.shape_keys[i].geometry;var a_pos=geometry["a_position"];var a_nor=geometry["a_normal"];var f_a_pos=frame["a_position"];var f_a_nor=frame["a_normal"];var pos_nor_length=a_pos.length;var value=submesh.shape_keys[i].init_value;for(var j=0;j<pos_nor_length;j++){f_a_pos[j]+=value*a_pos[j];f_a_nor[j]+=
value*a_nor[j]}var a_tan=geometry["a_tangent"];var f_a_tan=frame["a_tangent"];var tan_length=a_tan.length;for(var j=0;j<tan_length;j++)f_a_tan[j]+=value*a_tan[j]}}exports.is_long_submesh=is_long_submesh;function is_long_submesh(submesh){var base_length=submesh.base_length;if(base_length>MAX_SUBMESH_LENGTH){if(m_ext.get_elem_index_uint())return false;return true}return false}exports.is_indexed=is_indexed;function is_indexed(submesh){if(submesh.indices.length>0)return true;else return false}exports.submesh_drop_indices=
submesh_drop_indices;function submesh_drop_indices(submesh,count,is_manually_dropped){if(!is_indexed(submesh))return submesh;count=count||1;if(!is_manually_dropped)m_print.log('%cDEBUG max vertices exceeded for indexed submesh "'+submesh.name+'": '+submesh.base_length*count+", will use drawArrays","color: #aa0");var indices=submesh.indices;var base_length=submesh.base_length;var va_common=submesh.va_common;var va_frames=submesh.va_frames;for(var name in va_common){var arr=va_common[name];var nc=num_comp(arr,
base_length);va_common[name]=expand_vertex_array_i(indices,arr,nc)}for(var i=0;i<va_frames.length;i++){var va_frame=va_frames[i];for(var name in va_frame){var arr=va_frame[name];var nc=num_comp(arr,base_length);va_frame[name]=expand_vertex_array_i(indices,arr,nc)}}for(var i=0;i<submesh.shape_keys.length;i++){var geometry=submesh.shape_keys[i].geometry;for(var att_name in geometry){var arr=geometry[att_name];var nc=num_comp(arr,base_length);geometry[att_name]=expand_vertex_array_i(indices,arr,nc)}}submesh.base_length=
indices.length;submesh.indices=new Uint16Array(0);return submesh}function expand_vertex_array_i(indices,vertex_array,num_comp){if(vertex_array.length==0)return new Float32Array(0);var len=indices.length*num_comp;var new_vertex_array=new Float32Array(len);for(var i=0;i<indices.length;i++){var index=indices[i];for(var j=0;j<num_comp;j++)new_vertex_array[num_comp*i+j]=vertex_array[num_comp*index+j]}return new_vertex_array}exports.update_bufs_data_index_array=function(bufs_data,draw_mode,indices){update_draw_mode(bufs_data,
draw_mode);bufs_data.count=indices.length;bufs_data.ibo_array=indices;if(indices instanceof Uint16Array)bufs_data.ibo_type=_gl.UNSIGNED_SHORT;else bufs_data.ibo_type=_gl.UNSIGNED_INT;return bufs_data};function init_bufs_data(){return{ibo_array:null,vbo_array:null,ibo_type:0,count:0,pointers:{},mode:0,usage:0,debug_ibo_bytes:0,debug_vbo_bytes:0,vbo:null,ibo:null,info_for_z_sort_updates:null,shape_keys:null}}exports.update_bufs_data_array=function(bufs_data,attrib_name,num_comp,array){var vbo_array=
bufs_data.vbo_array;var pointers=bufs_data.pointers;var pointer=pointers[attrib_name];if(pointer){if(num_comp&&pointer.num_comp!=num_comp)m_util.panic('invalid num_comp for "'+attrib_name+'"');vbo_array.set(array,pointer.offset)}else{var len=vbo_array.length;var vbo_array_new=new Float32Array(len+array.length);vbo_array_new.set(bufs_data.vbo_array);vbo_array_new.set(array,len);bufs_data.vbo_array=vbo_array_new;pointers[attrib_name]={num_comp:num_comp,offset:len}}update_gl_buffers(bufs_data);return bufs_data};
exports.extract_array=extract_array;function extract_array(bufs_data,name){var vbo_array=bufs_data.vbo_array;var pointers=bufs_data.pointers;var pointer=pointers[name];if(pointer)return vbo_array.subarray(pointer.offset,pointer.offset+pointer.length);else throw"extract_array() failed; invalid name: "+name;}function update_draw_mode(bufs_data,draw_mode){var mode;var usage;switch(draw_mode){case exports.DM_DEFAULT:case exports.DM_TRIANGLES:mode=_gl.TRIANGLES;usage=_gl.STATIC_DRAW;break;case exports.DM_POINTS:mode=
_gl.POINTS;usage=_gl.STATIC_DRAW;break;case exports.DM_DYNAMIC_TRIANGLES:mode=_gl.TRIANGLES;usage=_gl.DYNAMIC_DRAW;break;case exports.DM_DYNAMIC_POINTS:mode=_gl.POINTS;usage=_gl.DYNAMIC_DRAW;break;case exports.DM_LINES:mode=_gl.LINES;usage=_gl.STATIC_DRAW;break;default:throw"Wrong draw_mode";}bufs_data.mode=mode;bufs_data.usage=usage}exports.make_static=function(bufs_data){bufs_data.usage=_gl.STATIC_DRAW};exports.make_dynamic=function(bufs_data){bufs_data.usage=_gl.DYNAMIC_DRAW};function generate_bufs_data_arrays(bufs_data,
indices,va_frames,va_common,base_length){if(indices.length){var count=indices.length;if(base_length<=MAX_SUBMESH_LENGTH){var ibo_array=new Uint16Array(indices);var ibo_type=_gl.UNSIGNED_SHORT}else{var ibo_array=new Uint32Array(indices);var ibo_type=_gl.UNSIGNED_INT}}else{var count=base_length;var ibo_array=null}var vbo_array_length=calc_vbo_length(va_frames,va_common);var vbo_array=new Float32Array(vbo_array_length);var offset=0;var pointers={};for(var name in va_common){var arr=va_common[name];var len=
arr.length;if(!len)continue;vbo_array.set(arr,offset);pointers[name]={attribute_name:name,num_comp:num_comp(arr,base_length),offset:offset,frames:1,length:len};offset+=len}var frames_count=va_frames.length;for(var name in va_frames[0]){var arr0=va_frames[0][name];var len=arr0.length;var ncomp=num_comp(arr0,base_length);if(!len)continue;pointers[name]={num_comp:ncomp,offset:offset,frames:frames_count,length:len};if(frames_count>1)pointers[name+"_next"]={num_comp:ncomp,offset:offset+len,frames:frames_count,
length:len};for(var i=0;i<frames_count;i++){var va_frame=va_frames[i];var arr=va_frame[name];vbo_array.set(arr,offset);offset+=len}}bufs_data.count=count;bufs_data.ibo_array=ibo_array;bufs_data.vbo_array=vbo_array;bufs_data.ibo_type=ibo_type;bufs_data.pointers=pointers}function calc_vbo_length(va_frames,va_common){var len=0;var frames_count=va_frames.length;for(var name in va_frames[0]){var arr=va_frames[0][name];len+=arr.length*frames_count}for(var name in va_common){var arr=va_common[name];len+=
arr.length}return len}exports.update_gl_buffers=update_gl_buffers;function update_gl_buffers(bufs_data){if(bufs_data.ibo_array){if(!bufs_data.ibo)bufs_data.ibo=_gl.createBuffer();_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo_array,bufs_data.usage);bufs_data.debug_ibo_bytes=bufs_data.ibo_array.byteLength}else bufs_data.debug_ibo_bytes=0;if(!bufs_data.vbo)bufs_data.vbo=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,bufs_data.vbo);_gl.bufferData(_gl.ARRAY_BUFFER,
bufs_data.vbo_array,bufs_data.usage);bufs_data.debug_vbo_bytes=bufs_data.vbo_array.byteLength}exports.cleanup_bufs_data=function(bufs_data){if(bufs_data.ibo)_gl.deleteBuffer(bufs_data.ibo);if(bufs_data.vbo)_gl.deleteBuffer(bufs_data.vbo)};exports.has_empty_submesh=function(mesh,index){var bsub=mesh["submeshes"][index];if(bsub["base_length"])return false;else return true};exports.submesh_apply_transform=submesh_apply_transform;function submesh_apply_transform(submesh,transform){var base_length=submesh.base_length;
for(var f=0;f<submesh.va_frames.length;f++){var positions=submesh.va_frames[f]["a_position"];m_tsr.transform_vectors(positions,transform,positions,0);var normals=submesh.va_frames[f]["a_normal"];if(normals.length>0)m_tsr.transform_dir_vectors(normals,transform,normals,0);var tangents=submesh.va_frames[f]["a_tangent"];if(tangents.length>0)m_tsr.transform_tangents(tangents,transform,tangents,0)}var au_center_pos=submesh.va_common["au_center_pos"];if(au_center_pos&&au_center_pos.length)m_tsr.transform_vectors(au_center_pos,
transform,au_center_pos,0);return submesh}exports.submesh_apply_particle_transform=submesh_apply_particle_transform;function submesh_apply_particle_transform(submesh,transform){var au_center_pos=submesh.va_common["au_center_pos"];if(au_center_pos&&au_center_pos.length){var cen_pos_transformed=new Float32Array(au_center_pos);m_tsr.transform_vectors(cen_pos_transformed,transform,cen_pos_transformed,0);for(var i=0;i<submesh.va_frames.length;i++)for(var j=0;j<cen_pos_transformed.length;j++)submesh.va_frames[i]["a_position"][j]+=
cen_pos_transformed[j]-au_center_pos[j];au_center_pos.set(cen_pos_transformed)}else throw'Attribute "au_center_pos" is missing in particle submesh';return submesh}exports.submesh_apply_params=submesh_apply_params;function submesh_apply_params(submesh,params){var base_length=submesh.base_length;for(var param in params){var param_len=params[param].length;var len=params[param].length*base_length;submesh.va_common[param]=new Float32Array(param_len*base_length);for(var i=0;i<base_length;i++)for(var j=
0;j<param_len;j++)submesh.va_common[param][i*param_len+j]=params[param][j]}return submesh}function gen_buf_clone_source(source,n){var len=source.length;var new_buf=new Float32Array(len*n);for(var i=0;i<n;i++)for(var j=0;j<len;j++)new_buf[i*len+j]=source[j];return new_buf}exports.submesh_list_join=submesh_list_join;function submesh_list_join(submeshes){var submesh0=submeshes[0];var new_submesh=submesh_list_join_prepare_dest(submeshes);var new_submesh_bd=new_submesh.submesh_bd;new_submesh_bd.bb_world=
m_util.clone_object_r(submesh0.submesh_bd.bb_world);new_submesh_bd.be_world=m_util.clone_object_r(submesh0.submesh_bd.be_world);new_submesh_bd.bb_local=m_util.clone_object_r(submesh0.submesh_bd.bb_local);new_submesh_bd.be_local=m_util.clone_object_r(submesh0.submesh_bd.be_local);var i_offset=0;var v_ind_offset=0;var keys={};var bounding_verts=[];for(var i=0;i<submeshes.length;i++){var submesh=submeshes[i];var indices=submesh.indices;var base_length=submesh.base_length;var va_common=submesh.va_common;
var va_frames=submesh.va_frames;m_bounds.extract_bb_corners(submesh.submesh_bd.bb_world,_bb_corners_tmp);m_bounds.expand_bounding_box(new_submesh_bd.bb_world,submesh.submesh_bd.bb_world);for(var k=0;k<_bb_corners_tmp.length;k++)bounding_verts.push(_bb_corners_tmp[k]);for(var j=0;j<indices.length;j++){var ind=indices[j];new_submesh.indices[i_offset+j]=ind+v_ind_offset}i_offset+=indices.length;for(var param_name in va_common){var arr=va_common[param_name];var offset=v_ind_offset*num_comp(arr,base_length);
new_submesh.va_common[param_name].set(arr,offset)}for(var j=0;j<submesh.va_frames.length;j++){var va_frame=submesh.va_frames[j];var new_va_frame=new_submesh.va_frames[j];for(var param_name in va_frame){var arr=va_frame[param_name];var offset=v_ind_offset*num_comp(arr,base_length);new_va_frame[param_name].set(arr,offset)}}v_ind_offset+=base_length}new_submesh.submesh_bd.be_world=m_bounds.create_bounding_ellipsoid_by_bb(bounding_verts,true);if(new_submesh.shape_keys.length>0)for(var i=0;i<new_submesh.shape_keys.length;i++){var geometry=
new_submesh.shape_keys[i].geometry;var a_pos_offset=0;var a_nor_offset=0;var a_tan_offset=0;for(var j=0;j<submeshes.length;j++){var cur_key_geom=submeshes[j].shape_keys[i].geometry;geometry["a_position"].set(cur_key_geom["a_position"],a_pos_offset);geometry["a_normal"].set(cur_key_geom["a_normal"],a_nor_offset);geometry["a_tangent"].set(cur_key_geom["a_tangent"],a_tan_offset);a_pos_offset+=cur_key_geom["a_position"].length;a_nor_offset+=cur_key_geom["a_normal"].length;a_tan_offset+=cur_key_geom["a_tangent"].length}}return new_submesh}
function submesh_list_join_prepare_dest(submeshes){var new_submesh=m_util.create_empty_submesh("JOIN_"+submeshes.length+"_SUBMESHES");var len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].indices.length;new_submesh.indices=new Uint32Array(len);var pos_len=0;var nor_len=0;var tan_len=0;if(submeshes[0].shape_keys.length>0)for(var j=0;j<submeshes[0].shape_keys.length;j++){for(var i=0;i<submeshes.length;i++){pos_len+=submeshes[i].shape_keys[j].geometry["a_position"].length;nor_len+=submeshes[i].shape_keys[j].geometry["a_normal"].length;
tan_len+=submeshes[i].shape_keys[j].geometry["a_tangent"].length}var geometry={"a_position":new Float32Array(pos_len),"a_normal":new Float32Array(nor_len),"a_tangent":new Float32Array(tan_len)};var key={init_value:submeshes[0].shape_keys[j].init_value,geometry:geometry};new_submesh.shape_keys.push(key)}len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].base_length;new_submesh.base_length=len;var submesh0=submeshes[0];for(var param_name in submesh0.va_common){len=0;for(var i=0;i<submeshes.length;i++)len+=
submeshes[i].va_common[param_name].length;new_submesh.va_common[param_name]=new Float32Array(len)}for(var param_name in submesh0.va_frames[0]){len=0;for(var i=0;i<submeshes.length;i++)len+=submeshes[i].va_frames[0][param_name].length;for(var i=0;i<submesh0.va_frames.length;i++){new_submesh.va_frames[i]=new_submesh.va_frames[i]||{};new_submesh.va_frames[i][param_name]=new Float32Array(len)}}return new_submesh}exports.make_clone_submesh=function(src_submesh,params,transforms,em_obj){if(!src_submesh.base_length)return m_util.create_empty_submesh("EMPTY");
var count=transforms.length;if(src_submesh.base_length*count>MAX_SUBMESH_LENGTH&&!m_ext.get_elem_index_uint())submesh_drop_indices(src_submesh,count);var indices=src_submesh.indices;var base_length=src_submesh.base_length;var va_common=src_submesh.va_common;var va_frames=src_submesh.va_frames;for(var param in params){var param_len=params[param].length;var len=param_len*base_length;va_common[param]=new Float32Array(len);for(var i=0;i<base_length;i++)for(var j=0;j<param_len;j++)va_common[param][i*param_len+
j]=params[param][j]}var new_submesh=m_util.create_empty_submesh("CLONE_"+count+"_SUBMESHES");new_submesh.base_length=base_length*count;new_submesh.indices=new Uint32Array(indices.length*count);var submesh_bd=new_submesh.submesh_bd;var bb_tmp=m_bounds.zero_bounding_box();var bs_tmp=m_bounds.zero_bounding_sphere();var bounding_verts=[];for(var i=0;i<count;i++){var i_offset=indices.length*i;var v_offset=base_length*i;for(var j=0;j<indices.length;j++){var ind=indices[j];new_submesh.indices[i_offset+j]=
ind+v_offset}}for(var param_name in va_common){var arr=va_common[param_name];var len=arr.length*count;var ncomp=num_comp(arr,base_length);new_submesh.va_common[param_name]=new Float32Array(len);for(var i=0;i<count;i++){var v_offset=base_length*ncomp*i;new_submesh.va_common[param_name].set(arr,v_offset)}}for(var param_name in va_frames[0])for(var i=0;i<va_frames.length;i++){var arr=va_frames[i][param_name];var len=arr.length*count;var ncomp=num_comp(arr,base_length);new_submesh.va_frames[i]=new_submesh.va_frames[i]||
{};new_submesh.va_frames[i][param_name]=new Float32Array(len);for(var j=0;j<count;j++){var transform=transforms[j];var v_offset=base_length*ncomp*j;switch(param_name){case "a_position":m_tsr.transform_vectors(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;case "a_normal":m_tsr.transform_dir_vectors(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;case "a_tangent":m_tsr.transform_tangents(arr,transform,new_submesh.va_frames[i][param_name],v_offset);break;default:throw"Wrong attribute name: "+
param_name;break}}}var submesh_bd=new_submesh.submesh_bd;var bb_tmp=m_bounds.zero_bounding_box();var bounding_verts=[];for(var i=0;i<count;i++){bb_tmp=m_bounds.bounding_box_transform(src_submesh.submesh_bd.bb_local,transforms[i],bb_tmp);m_bounds.expand_bounding_box(submesh_bd.bb_local,bb_tmp);bb_tmp=m_bounds.bounding_box_transform(bb_tmp,em_obj.render.world_tsr,bb_tmp);m_bounds.expand_bounding_box(submesh_bd.bb_world,bb_tmp);m_bounds.extract_bb_corners(bb_tmp,_bb_corners_tmp);for(var j=0;j<_bb_corners_tmp.length;j++)bounding_verts.push(_bb_corners_tmp[j])}submesh_bd.be_world=
m_bounds.create_bounding_ellipsoid_by_bb(bounding_verts,true);submesh_bd.be_local=m_bounds.calc_be_local_by_tsr(submesh_bd.be_world,em_obj.render.world_tsr);return new_submesh};exports.extract_submesh=extract_submesh;function extract_submesh(mesh,material_index,attr_names,bone_skinning_info,vertex_colors_usage,uv_maps_usage){var bsub=mesh["submeshes"][material_index];var base_length=bsub["base_length"];var mat=mesh["materials"][material_index];var submesh=m_util.create_empty_submesh("SUBMESH_"+mesh["name"]+
"_"+mat["name"]);submesh.base_length=base_length;var use_shape_keys=false;if(has_attr(attr_names,"a_texcoord"))var texcoords=extract_texcoords(mesh,material_index);else var texcoords=new Float32Array(0);if(has_attr(attr_names,"a_orco_tex_coord"))var local_coord=extract_orco_texcoords_nodes(mesh,bsub);else var local_coord=new Float32Array(0);var influences=extract_influences(attr_names,base_length,bone_skinning_info,bsub["group"]);if(vertex_colors_usage)var submesh_vc_usage=m_util.clone_object_r(vertex_colors_usage);
else var submesh_vc_usage={};submesh_vc_usage["a_color"]={generate_buffer:true};if(has_attr(attr_names,"a_color")&&mesh["active_vcol_name"])submesh_vc_usage["a_color"].src=[{name:mesh["active_vcol_name"],mask:7}];else submesh_vc_usage["a_color"].src=[];var va_common={"a_texcoord":texcoords,"a_influence":influences,"a_orco_tex_coord":local_coord};extract_vcols(va_common,submesh_vc_usage,bsub["vertex_colors"],bsub["color"],base_length,mesh["name"]);assign_node_uv_maps(mesh["uv_textures"],bsub["texcoord"],
bsub["texcoord2"],uv_maps_usage,base_length,va_common,mesh["name"]);submesh.va_common=va_common;submesh.indices=new Uint32Array(bsub["indices"]);var frames=bsub["position"].length/base_length/POS_NUM_COMP;if(has_attr(attr_names,"a_normal")&&bsub["normal"].length)var use_normal=true;else var use_normal=false;if(use_normal&&has_attr(attr_names,"a_tangent")&&bsub["tangent"].length)var use_tangent=true;else var use_tangent=false;var texslot=mat["texture_slots"][0];if(use_normal&&mat["texture_slots"].length&&
has_attr(attr_names,"a_tangent")&&texslot["texture_coords"]=="ORCO"&&texslot["use_map_normal"])var use_orco_nmap_coords=true;else var use_orco_nmap_coords=false;if(mesh["b4w_shape_keys"].length>0)use_shape_keys=true;for(var i=0;i<frames;i++){var va_frame=create_frame(submesh,bsub,attr_names,base_length,use_normal,use_tangent,use_orco_nmap_coords,i,mesh["name"]);if(use_shape_keys){var sk_frame={};sk_frame.name=mesh["b4w_shape_keys"][i]["name"];submesh.shape_keys.push(sk_frame);if(i!=0){sk_frame.geometry=
va_frame;sk_frame.init_value=mesh["b4w_shape_keys"][i]["value"];continue}else{sk_frame.geometry=create_frame(submesh,bsub,attr_names,base_length,use_normal,use_tangent,use_orco_nmap_coords,i,mesh["name"]);sk_frame.init_value=1}}submesh.va_frames.push(va_frame)}if(frames>1&&!use_shape_keys){var va_frame0=submesh.va_frames[0];var va_frame={};for(var prop in va_frame0)va_frame[prop]=new Float32Array(va_frame0[prop]);submesh.va_frames.push(va_frame)}if(has_attr(attr_names,"a_polyindex")){submesh_drop_indices(submesh,
1,true);submesh.va_common["a_polyindex"]=extract_polyindices(submesh)}submesh.submesh_bd=submesh_bd_to_b4w(bsub["boundings"]);return submesh}function submesh_bd_to_b4w(submesh_bd){var be_axes=submesh_bd["bounding_ellipsoid_axes"];return{bb_local:{max_x:submesh_bd["bounding_box"]["max_x"],max_y:submesh_bd["bounding_box"]["max_y"],max_z:submesh_bd["bounding_box"]["max_z"],min_x:submesh_bd["bounding_box"]["min_x"],min_y:submesh_bd["bounding_box"]["min_y"],min_z:submesh_bd["bounding_box"]["min_z"]},be_local:m_bounds.create_bounding_ellipsoid([be_axes[0],
0,0],[0,be_axes[1],0],[0,0,be_axes[2]],submesh_bd["bounding_ellipsoid_center"],[0,0,0,1]),bb_world:null,be_world:null}}function create_frame(submesh,bsub,attr_names,base_length,use_normal,use_tangent,use_orco_nmap_coords,frame_index,mesh_name){var va_frame={};var pos_arr=new Float32Array(base_length*POS_NUM_COMP);var nor_arr=new Float32Array(use_normal?base_length*NOR_NUM_COMP:0);var tan_arr=new Float32Array(use_tangent||use_orco_nmap_coords?base_length*TAN_NUM_COMP:0);var from_index=frame_index*
base_length*POS_NUM_COMP;var to_index=from_index+base_length*POS_NUM_COMP;pos_arr.set(bsub["position"].subarray(from_index,to_index),0);if(use_normal){var from_index=frame_index*base_length*NOR_NUM_COMP;var to_index=from_index+base_length*NOR_NUM_COMP;nor_arr.set(bsub["normal"].subarray(from_index,to_index),0)}if(use_tangent){var from_index=frame_index*base_length*TAN_NUM_COMP;var to_index=from_index+base_length*TAN_NUM_COMP;tan_arr.set(bsub["tangent"].subarray(from_index,to_index),0)}else if(use_orco_nmap_coords)generate_orco_tangents(nor_arr,
tan_arr,base_length,mesh_name);else if(use_normal&&has_attr(attr_names,"a_tangent")){var tan_arr=new Float32Array(base_length*TAN_NUM_COMP);for(var i=0;i<tan_arr.length;i++)tan_arr[i]=1}va_frame["a_position"]=pos_arr;va_frame["a_normal"]=nor_arr;va_frame["a_tangent"]=tan_arr;return va_frame}function extract_texcoords(mesh,material_index){var texcoords=null;var material=mesh["materials"][material_index];var submesh=mesh["submeshes"][material_index];if(material["texture_slots"].length){var slot=material["texture_slots"][0];
switch(slot["texture_coords"]){case "UV":var index=mesh["uv_textures"].indexOf(slot["uv_layer"]);if(index==0)texcoords=new Float32Array(submesh["texcoord"]);else if(index==1)texcoords=new Float32Array(submesh["texcoord2"]);break;case "ORCO":texcoords=generate_orco_texcoords(mesh["b4w_bounding_box_source"],submesh);break}}if(texcoords===null)texcoords=new Float32Array(submesh["base_length"]*2);return texcoords}function extract_orco_texcoords_nodes(mesh,submesh){var bb=mesh["b4w_bounding_box_source"];
var local_coords=new Float32Array(submesh["base_length"]*3);var pos=submesh["position"];var size_x=bb["max_x"]-bb["min_x"];var size_y=bb["max_y"]-bb["min_y"];var size_z=bb["max_z"]-bb["min_z"];var localco_index=0;for(var i=0;i<submesh["position"].length;i+=3){if(size_x==0)local_coords[localco_index++]=.5;else local_coords[localco_index++]=m_util.clamp(parseFloat(((submesh["position"][i]-bb.min_x)/size_x).toFixed(5)),0,1);if(size_z==0)local_coords[localco_index++]=.5;else local_coords[localco_index++]=
m_util.clamp(parseFloat(((bb.max_z-submesh["position"][i+2])/size_z).toFixed(5)),0,1);if(size_y==0)local_coords[localco_index++]=.5;else local_coords[localco_index++]=m_util.clamp(parseFloat(((submesh["position"][i+1]-bb.min_y)/size_y).toFixed(5)),0,1)}return local_coords}function generate_orco_texcoords(bb,submesh){var texcoords=new Float32Array(submesh["base_length"]*2);var pos=submesh["position"];var center_x=(bb["max_x"]+bb["min_x"])/2;var center_z=(bb["max_z"]+bb["min_z"])/2;var size_x=bb["max_x"]-
bb["min_x"];var size_z=bb["max_z"]-bb["min_z"];var texco_index=0;for(var i=0;i<submesh["position"].length;i+=3){texcoords[texco_index++]=(submesh["position"][i]-center_x)/size_x+.5;texcoords[texco_index++]=(center_z-submesh["position"][i+2])/size_z+.5}return texcoords}function generate_orco_tangents(nor_arr,tan_arr,base_length,mesh_name){m_print.warn("Not precise tangents calculation for normalmap "+'using GENERATED texture coordinates in mesh: "'+mesh_name+'". Please add a UV-map.');for(var i=0;i<
base_length;i++){var nor=_vec3_tmp;var tan=_vec3_tmp2;nor[0]=nor_arr[NOR_NUM_COMP*i];nor[1]=nor_arr[NOR_NUM_COMP*i+1];nor[2]=nor_arr[NOR_NUM_COMP*i+2];m_vec3.cross(nor,m_util.AXIS_Z,tan);if(m_vec3.length(tan)==0)m_vec3.cross(nor,m_util.AXIS_X,tan);m_vec3.normalize(tan,tan);tan_arr[TAN_NUM_COMP*i]=tan[0];tan_arr[TAN_NUM_COMP*i+1]=tan[1];tan_arr[TAN_NUM_COMP*i+2]=tan[2];tan_arr[TAN_NUM_COMP*i+3]=1}}function extract_vcols(va_common,vc_usage,submesh_vc,bsub_color,base_length,mesh_name){var submesh_vc_names=
submesh_vc_get_names(submesh_vc);for(var attr_name in vc_usage){var colors_data=vc_usage[attr_name].src;if(colors_data.length){var dst_channels_count=0;for(var i=0;i<colors_data.length;i++)dst_channels_count+=m_util.rgb_mask_get_channels_count(colors_data[i].mask);va_common[attr_name]=new Float32Array(dst_channels_count*base_length);var dst_channel_index_offset=0;for(var i=0;i<colors_data.length;i++){var color_name=colors_data[i].name;var color_mask=colors_data[i].mask;var channels_presence=m_util.rgb_mask_get_channels_presence(color_mask);
var color_name_index=submesh_vc_names.indexOf(color_name);if(color_name_index==-1)m_util.panic('vertex color "'+color_name+'" for mesh "'+mesh_name+'" not found.');var mask_exported=submesh_vc[color_name_index]["mask"];var exported_channels_count=m_util.rgb_mask_get_channels_count(mask_exported);if((color_mask&mask_exported)!==color_mask)m_print.error("Wrong color extraction from "+color_name+" to "+attr_name+".");var exported_colors_offset=submesh_vc_get_offset(submesh_vc,color_name_index,base_length);
for(var j=0;j<base_length;j++)for(var k=0;k<COL_NUM_COMP;k++)if(channels_presence[k]){var dst_channel_index=dst_channel_index_offset+m_util.rgb_mask_get_channel_presence_index(color_mask,k);var exported_channel_index=m_util.rgb_mask_get_channel_presence_index(mask_exported,k);va_common[attr_name][j*dst_channels_count+dst_channel_index]=bsub_color[exported_colors_offset+j*exported_channels_count+exported_channel_index]}dst_channel_index_offset+=exported_channels_count}}else va_common[attr_name]=new Float32Array(0)}}
function submesh_vc_get_names(submesh_vc){var submesh_vc_names=[];for(var i=0;i<submesh_vc.length;i++)submesh_vc_names.push(submesh_vc[i]["name"]);return submesh_vc_names}function submesh_vc_get_offset(submesh_vc,vc_index,base_length){var offset=0;for(var i=0;i<vc_index;i++)offset+=m_util.rgb_mask_get_channels_count(submesh_vc[i]["mask"]);return offset*base_length}function assign_node_uv_maps(mesh_uvs,bsub_texcoord,bsub_texcoord2,uv_maps_usage,base_length,va_common,mesh_name){if(!uv_maps_usage)return;
for(var uv_name in uv_maps_usage){var uv_map_index=mesh_uvs.indexOf(uv_name);if(uv_map_index==0)var uv_node_arr=new Float32Array(bsub_texcoord);else if(uv_map_index==1)var uv_node_arr=new Float32Array(bsub_texcoord2);va_common[uv_maps_usage[uv_name]]=uv_node_arr}}exports.extract_halo_submesh=function(submesh){var base_length=submesh.base_length;var position_in=submesh.va_frames[0]["a_position"];var pos_arr=new Float32Array(12*base_length);var bb_vert_arr=new Float32Array(8*base_length);var indices_out=
new Uint32Array(4*submesh.indices.length);var random_vals=new Float32Array(4*base_length);for(var i=0;i<base_length;i++){pos_arr[12*i]=position_in[3*i];pos_arr[12*i+1]=position_in[3*i+1];pos_arr[12*i+2]=position_in[3*i+2];pos_arr[12*i+3]=position_in[3*i];pos_arr[12*i+4]=position_in[3*i+1];pos_arr[12*i+5]=position_in[3*i+2];pos_arr[12*i+6]=position_in[3*i];pos_arr[12*i+7]=position_in[3*i+1];pos_arr[12*i+8]=position_in[3*i+2];pos_arr[12*i+9]=position_in[3*i];pos_arr[12*i+10]=position_in[3*i+1];pos_arr[12*
i+11]=position_in[3*i+2];bb_vert_arr[8*i]=-.5;bb_vert_arr[8*i+1]=-.5;bb_vert_arr[8*i+2]=-.5;bb_vert_arr[8*i+3]=.5;bb_vert_arr[8*i+4]=.5;bb_vert_arr[8*i+5]=.5;bb_vert_arr[8*i+6]=.5;bb_vert_arr[8*i+7]=-.5;indices_out[6*i]=4*i+2;indices_out[6*i+1]=4*i+1;indices_out[6*i+2]=4*i;indices_out[6*i+3]=4*i+2;indices_out[6*i+4]=4*i;indices_out[6*i+5]=4*i+3;var random_val=Math.random();random_vals[4*i]=random_val;random_vals[4*i+1]=random_val;random_vals[4*i+2]=random_val;random_vals[4*i+3]=random_val}var halo_submesh=
m_util.create_empty_submesh("HALO");halo_submesh.va_frames=[];halo_submesh.va_frames[0]={};halo_submesh.base_length=4*base_length;halo_submesh.va_frames[0]["a_position"]=pos_arr;halo_submesh.va_common["a_halo_bb_vertex"]=bb_vert_arr;halo_submesh.va_common["a_random_vals"]=random_vals;halo_submesh.indices=indices_out;return halo_submesh};exports.has_attr=has_attr;function has_attr(attr_names,name){if(attr_names.indexOf(name)>-1)return true;else return false}exports.extract_submesh_all_mats=function(mesh,
attr_names,common_vc_usage,render){var submeshes=[];for(var i=0;i<mesh["submeshes"].length;i++){var submesh=extract_submesh(mesh,i,attr_names,null,common_vc_usage,null);if(submesh.base_length){var submesh_bd=submesh.submesh_bd;if(render){submesh_bd.bb_world=m_bounds.bounding_box_transform(submesh_bd.bb_local,render.world_tsr);submesh_bd.be_world=m_bounds.bounding_ellipsoid_transform(submesh_bd.be_local,render.world_tsr)}submeshes.push(submesh)}}if(submeshes.length==0)var submesh_all=m_util.create_empty_submesh("EMPTY");
else if(submeshes.length==1)var submesh_all=submeshes[0];else var submesh_all=submesh_list_join(submeshes);return submesh_all};function extract_influences(attr_names,base_length,bone_skinning_info,groups){if(has_attr(attr_names,"a_influence")&&bone_skinning_info){var influences=new Float32Array(base_length*INFLUENCE_NUM_COMP);var groups_num=groups.length/base_length;var deform_bone_indices=get_deform_bone_indices(bone_skinning_info,groups_num);var buf_length=groups_num>3?groups_num:4;var weights_buf=
new Float32Array(buf_length);var bones_buf=new Uint32Array(buf_length);var res_buf=new Float32Array(INFLUENCE_NUM_COMP);var zero_weights=new Float32Array(buf_length);var zero_bones=new Uint32Array(buf_length);var zero_res=new Float32Array(INFLUENCE_NUM_COMP);for(var i=0;i<base_length;i++){weights_buf.set(zero_weights);bones_buf.set(zero_bones);res_buf.set(zero_res);influences.set(get_vertex_influences(groups,groups_num,i,base_length,deform_bone_indices,weights_buf,bones_buf,res_buf),i*INFLUENCE_NUM_COMP)}}else var influences=
new Float32Array(0);return influences}function get_deform_bone_indices(bone_skinning_info,groups_num){var deform_bone_indices=new Float32Array(groups_num);for(var i=0;i<groups_num;i++){deform_bone_indices[i]=-1;for(var j in bone_skinning_info){var bone_sk_info=bone_skinning_info[j];if(bone_sk_info.vgroup_index===i){deform_bone_indices[i]=bone_sk_info.deform_bone_index;break}}}return deform_bone_indices}function get_vertex_influences(vertex_groups,groups_num,vert_index,base_length,deform_bone_indices,
weights_buf,bones_buf,res_buf){var precision=.01;var no_weights=true;for(var i=0;i<groups_num;i++){var weight=vertex_groups[i*base_length+vert_index];if(weight!==-1){var bone_index=deform_bone_indices[i];if(bone_index!==-1){weights_buf[i]=weight;bones_buf[i]=bone_index;no_weights=false}}}if(no_weights)return res_buf;sort_two_arrays(weights_buf,bones_buf,exports.SORT_NUMERIC,false);var sum_weights=0;for(var i=0;i<INFLUENCE_NUM_COMP;i++)sum_weights+=weights_buf[i];if(sum_weights<precision)return res_buf;
for(var i=0;i<INFLUENCE_NUM_COMP;i++)weights_buf[i]/=sum_weights;if(Math.abs(weights_buf[0]-1)<precision)res_buf[0]=bones_buf[0]+1;else for(var i=0;i<INFLUENCE_NUM_COMP;i++)res_buf[i]=bones_buf[i]+weights_buf[i];return res_buf}function num_comp(array,base_length){if(base_length==0)return 0;var array_length=array.length;var factor=array_length/base_length;if(factor!=Math.floor(factor))throw"Array size mismatch during geometry calculation: array length="+array_length+", base length="+base_length;return factor}
exports.update_buffers_movable=function(bufs_data,world_tsr,eye){var indices=bufs_data.ibo_array;var positions=extract_array(bufs_data,"a_position");var zinfo=bufs_data.info_for_z_sort_updates;var median_cache=zinfo.median_cache;var median_world_cache=zinfo.median_world_cache;var dist_cache=zinfo.dist_cache;var sort_back_to_front=zinfo.sort_back_to_front;compute_triangle_medians(indices,positions,median_cache);m_tsr.transform_vectors(median_cache,world_tsr,median_world_cache);compute_triangle_dists(median_world_cache,
eye,dist_cache);var indices=sort_triangles(dist_cache,indices);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,bufs_data.ibo);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,indices,_gl.DYNAMIC_DRAW)};function compute_triangle_medians(indices,positions,medians){var num_faces=indices.length/3;for(var i=0;i<num_faces;i++){var index0=indices[3*i];var index1=indices[3*i+1];var index2=indices[3*i+2];var pos00=positions[3*index0];var pos01=positions[3*index0+1];var pos02=positions[3*index0+2];var pos10=positions[3*index1];
var pos11=positions[3*index1+1];var pos12=positions[3*index1+2];var pos20=positions[3*index2];var pos21=positions[3*index2+1];var pos22=positions[3*index2+2];medians[3*i]=(pos00+pos10+pos20)/3;medians[3*i+1]=(pos01+pos11+pos21)/3;medians[3*i+2]=(pos02+pos12+pos22)/3}return medians}function compute_triangle_dists(medians,eye,dists){var len=medians.length/3;for(var i=0;i<len;i++){var dx=medians[3*i]-eye[0];var dy=medians[3*i+1]-eye[1];var dz=medians[3*i+2]-eye[2];dists[i]=dx*dx+dy*dy+dz*dz}return dists}
function sort_triangles(dists,indices){var dlen=dists.length;if(dlen<2)return indices;var gap=dlen;var swapped=false;var t;while(gap>1||swapped){if(gap>1)gap=Math.floor(gap/COMB_SORT_JUMP_COEFF);swapped=false;for(var i=0;gap+i<dlen;i++)if(dists[i]-dists[i+gap]<0){t=dists[i];dists[i]=dists[i+gap];dists[i+gap]=t;swap_indices(indices,i,i+gap);swapped=true}}return indices}exports.sort_two_arrays=sort_two_arrays;function sort_two_arrays(main_arr,extra_arr,type,ascending){var arr_length=main_arr.length;
var gap=arr_length;var swapped=false;var tmp;var order_factor=ascending?-1:1;while(gap>1||swapped){if(gap>1)gap=Math.floor(gap/COMB_SORT_JUMP_COEFF);swapped=false;for(var i=0;gap+i<arr_length;i++){if(type==exports.SORT_NUMERIC)var condition=order_factor*(main_arr[i]-main_arr[i+gap])<0;else var condition=main_arr[i]<main_arr[i+gap]&&ascending;if(condition){tmp=main_arr[i];main_arr[i]=main_arr[i+gap];main_arr[i+gap]=tmp;tmp=extra_arr[i];extra_arr[i]=extra_arr[i+gap];extra_arr[i+gap]=tmp;swapped=true}}}}
function swap_indices(indices,pos1,pos2){var t0=indices[3*pos1];var t1=indices[3*pos1+1];var t2=indices[3*pos1+2];indices[3*pos1]=indices[3*pos2];indices[3*pos1+1]=indices[3*pos2+1];indices[3*pos1+2]=indices[3*pos2+2];indices[3*pos2]=t0;indices[3*pos2+1]=t1;indices[3*pos2+2]=t2}exports.calc_normals=function(indices,positions,shared_indices){var num_vertices=positions.length/POS_NUM_COMP;var num_faces=indices.length/3;var normals=[];var pos0=new Array(3);var pos1=new Array(3);var pos2=new Array(3);
for(var i=0;i<num_faces;i++){var index0=indices[3*i];var index1=indices[3*i+1];var index2=indices[3*i+2];for(var j=0;j<POS_NUM_COMP;j++){pos0[j]=positions[POS_NUM_COMP*index0+j];pos1[j]=positions[POS_NUM_COMP*index1+j];pos2[j]=positions[POS_NUM_COMP*index2+j]}if(shared_indices){var angle0=angle(pos0,pos1,pos2);var angle1=angle(pos1,pos2,pos0);var angle2=Math.PI-angle0-angle1}else{var angle0=1;var angle1=1;var angle2=1}calc_normal_for_face(index0,index1,index2,pos0,pos1,pos2,angle0,angle1,angle2,normals)}if(shared_indices)smooth_normals(shared_indices,
normals);for(var i=0;i<num_vertices;i++)normalize_normal(i,normals);return normals};function angle(pos,pos1,pos2){var vec1=[];var vec2=[];m_vec3.subtract(pos1,pos,vec1);m_vec3.subtract(pos2,pos,vec2);m_vec3.normalize(vec1,vec1);m_vec3.normalize(vec2,vec2);return Math.acos(m_vec3.dot(vec1,vec2))}function calc_normal_for_face(index0,index1,index2,pos0,pos1,pos2,angle0,angle1,angle2,dest){var normal=calc_normal_by_pos(pos0,pos1,pos2);for(var i=0;i<NOR_NUM_COMP;i++){var i0=NOR_NUM_COMP*index0+i;var i1=
NOR_NUM_COMP*index1+i;var i2=NOR_NUM_COMP*index2+i;dest[i0]=angle0*normal[i];dest[i1]=angle1*normal[i];dest[i2]=angle2*normal[i]}}function calc_normal_by_pos(pos0,pos1,pos2){var vec1=[],vec2=[],normal=[];m_vec3.subtract(pos1,pos0,vec1);m_vec3.subtract(pos2,pos0,vec2);m_vec3.cross(vec1,vec2,normal);m_vec3.normalize(normal,normal);return normal}function smooth_normals(shared_indices,normals){for(var i in shared_indices){var indices=shared_indices[i];for(var j=0;j<NOR_NUM_COMP;j++){var offset0=NOR_NUM_COMP*
indices[0]+j;for(var k=1;k<indices.length;k++){var offset=NOR_NUM_COMP*indices[k]+j;normals[offset0]+=normals[offset]}for(var k=1;k<indices.length;k++){var offset=NOR_NUM_COMP*indices[k]+j;normals[offset]=normals[offset0]}}}}function normalize_normal(i,normals){var normal=new Float32Array(NOR_NUM_COMP);for(var j=0;j<NOR_NUM_COMP;j++){var index=NOR_NUM_COMP*i+j;normal[j]=normals[index]}m_vec3.normalize(normal,normal);for(var j=0;j<NOR_NUM_COMP;j++){var index=NOR_NUM_COMP*i+j;normals[index]=normal[j]}}
exports.calc_shared_indices=calc_shared_indices;function calc_shared_indices(indices,shared_locations,locations){var sh_loc_set={};var len=shared_locations.length/3;for(var i=0;i<len;i++){var key=String(shared_locations[3*i])+String(shared_locations[3*i+1])+String(shared_locations[3*i+2]);sh_loc_set[key]=[]}var len=indices.length;for(var i=0;i<len;i++){var index=indices[i];var key=String(locations[3*index])+String(locations[3*index+1])+String(locations[3*index+2]);if(key in sh_loc_set)sh_loc_set[key].push(index)}return sh_loc_set}
exports.geometry_random_points=function(submesh,n,process_normals,seed){var triangles=extract_triangles(submesh,null,false);if(process_normals)var triangles_n=extract_triangles(submesh,null,true);var tnum=triangles.length;var areas=new Float32Array(tnum);var A=_vec3_tmp;var B=_vec3_tmp2;var C=_vec3_tmp3;for(var i=0;i<tnum;i++){var tri=triangles[i];A.set(tri.subarray(0,3));B.set(tri.subarray(3,6));C.set(tri.subarray(6));areas[i]=triangle_area(A,B,C)}var cumulative_areas=new Float32Array(tnum);cumulative_areas[0]=
areas[0];for(var i=1;i<tnum;i++)cumulative_areas[i]=cumulative_areas[i-1]+areas[i];var geom_area=cumulative_areas[areas.length-1];var points=[];for(var i=0;i<n;i++){var area=geom_area*m_util.rand_r(seed);var tri_index=m_util.binary_search_max(cumulative_areas,area,0,cumulative_areas.length-1);if(process_normals)var tri=triangles_n[tri_index];else var tri=triangles[tri_index];points[i]=triangle_random_point(tri,seed)}return points};exports.extract_triangles=extract_triangles;function extract_triangles(submesh,
dest,process_normals){if(!dest)var dest=[];if(process_normals)var positions=submesh.va_frames[0]["a_normal"];else var positions=submesh.va_frames[0]["a_position"];if(is_indexed(submesh)){var indices=submesh.indices;var tnum=indices.length/3;for(var i=0;i<tnum;i++){var tri=new Float32Array(9);var i0=indices[3*i];tri[0]=positions[3*i0];tri[1]=positions[3*i0+1];tri[2]=positions[3*i0+2];var i1=indices[3*i+1];tri[3]=positions[3*i1];tri[4]=positions[3*i1+1];tri[5]=positions[3*i1+2];var i2=indices[3*i+2];
tri[6]=positions[3*i2];tri[7]=positions[3*i2+1];tri[8]=positions[3*i2+2];dest[i]=tri}}else{var tnum=positions.length/9;for(var i=0;i<positions.length;i++){var tri=new Float32Array(9);tri[0]=positions[9*i];tri[1]=positions[9*i+1];tri[2]=positions[9*i+2];tri[3]=positions[9*i+3];tri[4]=positions[9*i+4];tri[5]=positions[9*i+5];tri[6]=positions[9*i+6];tri[7]=positions[9*i+7];tri[8]=positions[9*i+8];dest[i]=tri}}return dest}exports.extract_polyindices=extract_polyindices;function extract_polyindices(submesh){var polyindices=
new Float32Array(submesh.base_length);for(var i=0;i<submesh.base_length;i++)polyindices[i]=i%3;return polyindices}function triangle_area(A,B,C){return Math.sqrt(triangle_area_squared(A,B,C))}exports.triangle_area_squared=triangle_area_squared;function triangle_area_squared(A,B,C){var a=m_vec3.dist(A,B);var b=m_vec3.dist(A,C);var c=m_vec3.dist(B,C);var p=(a+b+c)/2;return p*(p-a)*(p-b)*(p-c)}function triangle_random_point(triangle,seed,dest){if(!dest)var dest=new Float32Array(3);var x0=triangle[0];
var y0=triangle[1];var z0=triangle[2];var x1=triangle[3];var y1=triangle[4];var z1=triangle[5];var x2=triangle[6];var y2=triangle[7];var z2=triangle[8];var w1=m_util.rand_r(seed);var w2=m_util.rand_r(seed);if(w1+w2>1){w1=1-w1;w2=1-w2}var w0=1-w1-w2;var x=w0*x0+w1*x1+w2*x2;var y=w0*y0+w1*y1+w2*y2;var z=w0*z0+w1*z1+w2*z2;dest[0]=x;dest[1]=y;dest[2]=z;return dest}exports.scale_submesh_xyz=function(submesh,scale,center){var positions=submesh.va_frames[0]["a_position"];for(var i=0;i<positions.length;i+=
3){positions[i]=(positions[i]-center[0])*scale[0]+center[0];positions[i+1]=(positions[i+1]-center[1])*scale[1]+center[1];positions[i+2]=(positions[i+2]-center[2])*scale[2]+center[2]}};exports.apply_shape_key=function(obj,key_name,new_value){var batches=obj.scenes_data[0].batches;var sk_data=obj.render.shape_keys_values;for(var i=1;i<sk_data.length;i++)if(sk_data[i]["name"]==key_name)sk_data[i]["value"]=new_value;for(var i=0;i<batches.length;i++){if(batches[i].forked_batch||!batches[i].use_shape_keys||
batches[i].debug_sphere)continue;var pointers=batches[i].bufs_data.pointers;var vbo_array=batches[i].bufs_data.vbo_array;var vbo=batches[i].bufs_data.vbo;_gl.bindBuffer(_gl.ARRAY_BUFFER,vbo);apply_shape_key_pos(pointers["a_position"],batches[i],vbo_array,sk_data);apply_shape_key_nor(pointers["a_normal"],batches[i],vbo_array,sk_data);apply_shape_key_tan(pointers["a_tangent"],batches[i],vbo_array,sk_data)}};function apply_shape_key_pos(pos_pointer,batch,vbo_array,sk_data){if(pos_pointer){var pos_offset=
pos_pointer.offset;var pos_length=pos_pointer.length+pos_offset;var pos=batch.bufs_data.shape_keys[0].geometry["a_position"];for(var i=pos_offset;i<pos_length;i++)vbo_array[i]=pos[i-pos_offset];for(var i=1;i<batch.bufs_data.shape_keys.length;i++){var positions=batch.bufs_data.shape_keys[i].geometry["a_position"];var value=sk_data[i]["value"];if(!value)continue;for(var j=pos_offset;j<pos_length;j++)vbo_array[j]+=value*positions[j-pos_offset]}_gl.bufferSubData(_gl.ARRAY_BUFFER,BINARY_FLOAT_SIZE*pos_offset,
vbo_array.subarray(pos_offset))}}function apply_shape_key_nor(nor_pointer,batch,vbo_array,sk_data){if(nor_pointer){var nor_offset=nor_pointer.offset;var nor_length=nor_pointer.length+nor_offset;var nor=batch.bufs_data.shape_keys[0].geometry["a_normal"];for(var i=nor_offset;i<nor_length;i++)vbo_array[i]=nor[i-nor_offset];for(var i=1;i<batch.bufs_data.shape_keys.length;i++){var normals=batch.bufs_data.shape_keys[i].geometry["a_normal"];var value=sk_data[i]["value"];if(!value)continue;for(var j=nor_offset;j<
nor_length;j++)vbo_array[j]+=value*normals[j-nor_offset]}normalize_buffer(vbo_array,nor_offset,nor_length,3,2);_gl.bufferSubData(_gl.ARRAY_BUFFER,BINARY_FLOAT_SIZE*nor_offset,vbo_array.subarray(nor_offset))}}function apply_shape_key_tan(tan_pointer,batch,vbo_array,sk_data){if(tan_pointer){var tan_offset=tan_pointer.offset;var tan_length=tan_pointer.length+tan_offset;var tan=batch.bufs_data.shape_keys[0].geometry["a_tangent"];for(var i=tan_offset;i<tan_length;i++)vbo_array[i]=tan[i-tan_offset];for(var i=
1;i<batch.bufs_data.shape_keys.length;i++){var tangents=batch.bufs_data.shape_keys[i].geometry["a_tangent"];var value=sk_data[i]["value"];if(!value)continue;for(var j=tan_offset;j<tan_length;j++)vbo_array[j]+=value*tangents[j-tan_offset]}normalize_buffer(vbo_array,tan_offset,tan_length,4,3);_gl.bufferSubData(_gl.ARRAY_BUFFER,BINARY_FLOAT_SIZE*tan_offset,vbo_array.subarray(tan_offset))}}function normalize_buffer(buffer,offset,buf_len,vec_len,rest){var len=buf_len-offset;for(var i=0;i<len;i=i+vec_len)if(i%
vec_len==rest)vec3.normalize(buffer.subarray(i+offset-rest,i+offset+1),buffer.subarray(i+offset-rest,i+offset+1))}exports.check_shape_keys=function(obj){return obj.render.use_shape_keys};exports.get_shape_keys_names=function(obj){var shape_keys_names=[];if(obj.render)for(var i=1;i<obj.render.shape_keys_values.length;i++)shape_keys_names.push(obj.render.shape_keys_values[i]["name"]);return shape_keys_names};exports.get_shape_key_value=function(obj,key_name){if(obj.render)for(var i=1;i<obj.render.shape_keys_values.length;i++)if(key_name==
obj.render.shape_keys_values[i]["name"])return obj.render.shape_keys_values[i]["value"];return 0};exports.has_shape_key=function(obj,key_name){var shape_keys=obj.render.shape_keys_values;if(shape_keys)for(var i=1;i<shape_keys.length;i++)if(shape_keys[i]["name"]==key_name)return true;return false};exports.has_dyn_geom=function(obj){if(obj&&obj.render&&obj.render.dynamic_geometry)return true;else return false};exports.draw_line=function(batch,positions,is_split){var bufs_data=batch.bufs_data;if(bufs_data){if(is_split)var num_line_segm=
positions.length/3/2;else var num_line_segm=positions.length/3-1;var tri_pos=new Float32Array(num_line_segm*4*3);var tri_dir=new Float32Array(num_line_segm*4*3);var tri_ind=new Uint16Array(num_line_segm*6);for(var i=0;i<num_line_segm;i++){if(is_split){var pos_offset=2*3*i;var pos_offset_next=2*3*i+3}else{var pos_offset=3*i;var pos_offset_next=3*(i+1)}var pos_x=positions[pos_offset];var pos_y=positions[pos_offset+1];var pos_z=positions[pos_offset+2];var pos_x_next=positions[pos_offset_next];var pos_y_next=
positions[pos_offset_next+1];var pos_z_next=positions[pos_offset_next+2];var dir_x=pos_x_next-pos_x;var dir_y=pos_y_next-pos_y;var dir_z=pos_z_next-pos_z;tri_pos[i*4*3]=pos_x;tri_pos[i*4*3+1]=pos_y;tri_pos[i*4*3+2]=pos_z;tri_dir[i*4*3]=dir_x;tri_dir[i*4*3+1]=dir_y;tri_dir[i*4*3+2]=dir_z;tri_pos[i*4*3+3]=pos_x_next;tri_pos[i*4*3+4]=pos_y_next;tri_pos[i*4*3+5]=pos_z_next;tri_dir[i*4*3+3]=-dir_x;tri_dir[i*4*3+4]=-dir_y;tri_dir[i*4*3+5]=-dir_z;tri_pos[i*4*3+6]=pos_x;tri_pos[i*4*3+7]=pos_y;tri_pos[i*4*
3+8]=pos_z;tri_dir[i*4*3+6]=-dir_x;tri_dir[i*4*3+7]=-dir_y;tri_dir[i*4*3+8]=-dir_z;tri_pos[i*4*3+9]=pos_x_next;tri_pos[i*4*3+10]=pos_y_next;tri_pos[i*4*3+11]=pos_z_next;tri_dir[i*4*3+9]=dir_x;tri_dir[i*4*3+10]=dir_y;tri_dir[i*4*3+11]=dir_z;tri_ind[i*6]=4*i;tri_ind[i*6+1]=4*i+1;tri_ind[i*6+2]=4*i+2;tri_ind[i*6+3]=4*i;tri_ind[i*6+4]=4*i+3;tri_ind[i*6+5]=4*i+1}var new_vbo_size=0;for(var attr in bufs_data.pointers){var pointer=bufs_data.pointers[attr];new_vbo_size+=tri_pos.length/3*pointer.num_comp}bufs_data.vbo_array=
new Float32Array(new_vbo_size);var vbo_array=bufs_data.vbo_array;exports.update_bufs_data_index_array(bufs_data,batch.draw_mode,tri_ind);var offset=0;for(var attr in bufs_data.pointers){var pointer=bufs_data.pointers[attr];switch(attr){case "a_position":vbo_array.set(tri_pos,offset);pointer.offset=offset;pointer.length=tri_pos.length;offset+=pointer.length;break;case "a_direction":vbo_array.set(tri_dir,offset);pointer.offset=offset;pointer.length=tri_dir.length;offset+=pointer.length;break;default:pointer.offset=
offset;pointer.length=tri_pos.length/3*pointer.num_comp;var new_array=new Float32Array(pointer.length);vbo_array.set(new_array,offset);offset+=pointer.length;break}}update_gl_buffers(bufs_data)}}};b4w.module["__objects"]=function(exports,require){var m_anim=require("__animation");var m_batch=require("__batch");var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_cons=require("__constraints");var m_geom=require("__geometry");var m_lights=require("__lights");var m_nla=require("__nla");var m_obj_util=require("__obj_util");var m_particles=require("__particles");var m_phy=require("__physics");var m_print=require("__print");var m_primitives=require("__primitives");
var m_quat=require("__quat");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_trans=require("__transform");var m_tex=require("__textures");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_armat=require("__armature");var m_anchors=require("__anchors");var cfg_def=m_cfg.defaults;var cfg_out=m_cfg.outlining;var DEBUG_DISABLE_STATIC_OBJS=false;var DEFAULT_LOD_DIST_MAX=1E6;var _all_objects={"ALL":[]};var _bb_corners_tmp=new Float32Array(24);var _color_id_counter=
0;var _cube_refl_counter=0;var _refl_plane_objs=[];var _outline_anim_objs=[];var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var COLOR_ID_THRESHOLD=3;var DATA_ID_ALL=-1;exports.GET_OBJECT_BY_NAME=0;exports.GET_OBJECT_BY_DUPLI_NAME=1;exports.GET_OBJECT_BY_DUPLI_NAME_LIST=2;exports.DATA_ID_ALL=DATA_ID_ALL;exports.update=function(timeline,elapsed){var armatures=_all_objects["ARMATURE"];for(var i=0;i<_outline_anim_objs.length;i++){var obj=_outline_anim_objs[i];update_obj_outline_intensity(obj,
timeline);if(obj.render.outline_intensity)request_scenes_outline(obj)}if(!armatures)return;for(var i=0;i<armatures.length;i++){var armobj=armatures[i];if(armobj.need_update_transform){m_trans.update_transform(armobj);armobj.need_update_transform=false}}};exports.set_outline_intensity=set_outline_intensity;function set_outline_intensity(obj,value){obj.render.outline_intensity=value;request_scenes_outline(obj)}function request_scenes_outline(obj){var scenes_data=obj.scenes_data;var obj_render=obj.render;
for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];var scene=sc_data.scene;var render=scene._render;if(render.outline&&obj_render.outline_intensity)m_scenes.request_outline(scene)}}exports.apply_outline_anim=function(obj,tau,T,N){var oa=obj.outline_animation;oa.time_start=0;oa.outline_time=tau;oa.period=T;oa.relapses=N;var ind=_outline_anim_objs.indexOf(obj);if(ind==-1)_outline_anim_objs.push(obj)};exports.clear_outline_anim=clear_outline_anim;function clear_outline_anim(obj){obj.render.outline_intensity=
0;var ind=_outline_anim_objs.indexOf(obj);if(ind!=-1)_outline_anim_objs.splice(ind,1)}exports.update_object=function(bpy_obj,obj){obj.uuid=bpy_obj["uuid"];obj.bpy_origin=true;prepare_default_actions(bpy_obj,obj);bpy_obj._is_dynamic=obj.is_dynamic=calc_is_dynamic(bpy_obj,obj);bpy_obj._is_updated=true;prepare_physics_settings(bpy_obj,obj);if(obj.type==="MESH")var render_type=obj.is_dynamic?"DYNAMIC":"STATIC";else var render_type=obj.type;var render=obj.render=m_obj_util.create_render(render_type);prepare_parenting_props(bpy_obj,
obj);var pos=bpy_obj["location"];var scale=bpy_obj["scale"][0];var rot=_quat4_tmp;m_util.quat_bpy_b4w(bpy_obj["rotation_quaternion"],rot);m_trans.set_translation(obj,pos);m_trans.set_rotation(obj,rot);m_trans.set_scale(obj,scale);obj.use_default_animation=bpy_obj["b4w_use_default_animation"];obj.anim_behavior_def=m_anim.anim_behavior_bpy_b4w(bpy_obj["b4w_anim_behavior"]);if(bpy_obj["b4w_object_tags"])obj.metatags={title:bpy_obj["b4w_object_tags"]["title"],description:bpy_obj["b4w_object_tags"]["description"],
category:bpy_obj["b4w_object_tags"]["category"]};if(bpy_obj["b4w_viewport_alignment"])obj.viewport_alignment={alignment:bpy_obj["b4w_viewport_alignment"]["alignment"],distance:bpy_obj["b4w_viewport_alignment"]["distance"]};switch(bpy_obj["type"]){case "ARMATURE":m_armat.update_object(bpy_obj,obj);var bone_pointers=render.bone_pointers;var pose_data=m_anim.calc_pose_data(bone_pointers);if(bpy_obj["b4w_animation_mixing"]){var length=pose_data.quats.length;render.quats_before=new Float32Array(pose_data.quats);
render.quats_after=new Float32Array(pose_data.quats);render.trans_before=new Float32Array(pose_data.trans);render.trans_after=new Float32Array(pose_data.trans)}else{render.quats_before=pose_data.quats;render.quats_after=pose_data.quats;render.trans_before=pose_data.trans;render.trans_after=pose_data.trans}for(var bone_name in bone_pointers){var bpointer=bone_pointers[bone_name];if(bpointer.chain.length==1)m_armat.update_bone_tsr_r(bpointer,true,pose_data.trans,pose_data.quats)}render.pose_data=pose_data;
render.frame_factor=0;render.anim_mixing=bpy_obj["b4w_animation_mixing"];break;case "MESH":render.do_not_render=bpy_obj["b4w_do_not_render"];render.bb_original=m_batch.bb_bpy_to_b4w(bpy_obj["data"]["b4w_bounding_box"]);render.selectable=cfg_out.outlining_overview_mode||bpy_obj["b4w_selectable"];render.origin_selectable=bpy_obj["b4w_selectable"];render.outlining=cfg_out.outlining_overview_mode||bpy_obj["b4w_outlining"];render.origin_outlining=bpy_obj["b4w_outlining"];render.outline_on_select=cfg_out.outlining_overview_mode||
bpy_obj["b4w_outline_on_select"];render.billboard=bpy_obj["b4w_billboard"];render.billboard_pres_glob_orientation=bpy_obj["b4w_pres_glob_orientation"];render.billboard_type="BASIC";render.billboard_spherical=bpy_obj["b4w_billboard_geometry"]=="SPHERICAL";var oa_set=render.outline_anim_settings_default;oa_set.outline_duration=bpy_obj["b4w_outline_settings"]["outline_duration"],oa_set.outline_period=bpy_obj["b4w_outline_settings"]["outline_period"],oa_set.outline_relapses=bpy_obj["b4w_outline_settings"]["outline_relapses"];
if(render.selectable){render.color_id=m_util.gen_color_id(_color_id_counter);_color_id_counter++}prepare_vertex_anim(bpy_obj,obj);prepare_shape_keys(bpy_obj,obj);render.shadow_cast=bpy_obj["b4w_shadow_cast"];render.shadow_receive=bpy_obj["b4w_shadow_receive"];render.shadow_cast_only=bpy_obj["b4w_shadow_cast_only"]&&render.shadow_cast;render.reflexible=bpy_obj["b4w_reflexible"];render.reflexible_only=bpy_obj["b4w_reflexible_only"]&&render.reflexible;render.reflective=bpy_obj["b4w_reflective"];render.reflection_type=
bpy_obj["b4w_reflection_type"];render.caustics=bpy_obj["b4w_caustics"];render.wind_bending=bpy_obj["b4w_wind_bending"];render.wind_bending_angle=bpy_obj["b4w_wind_bending_angle"];var amp=m_batch.wb_angle_to_amp(bpy_obj["b4w_wind_bending_angle"],render.bb_original,bpy_obj["scale"][0]);render.wind_bending_amp=amp;render.wind_bending_freq=bpy_obj["b4w_wind_bending_freq"];render.detail_bending_freq=bpy_obj["b4w_detail_bending_freq"];render.detail_bending_amp=bpy_obj["b4w_detail_bending_amp"];render.branch_bending_amp=
bpy_obj["b4w_branch_bending_amp"];render.hide=false;render.main_bend_col=bpy_obj["b4w_main_bend_stiffness_col"];var bnd_st=bpy_obj["b4w_detail_bend_colors"];render.detail_bend_col={};render.detail_bend_col.leaves_stiffness=bnd_st["leaves_stiffness_col"];render.detail_bend_col.leaves_phase=bnd_st["leaves_phase_col"];render.detail_bend_col.overall_stiffness=bnd_st["overall_stiffness_col"];render.do_not_cull=bpy_obj["b4w_do_not_cull"];render.disable_fogging=bpy_obj["b4w_disable_fogging"];render.dynamic_geometry=
bpy_obj["b4w_dynamic_geometry"];var first_mat=first_mesh_material(bpy_obj);render.friction=first_mat["physics"]["friction"];render.elasticity=first_mat["physics"]["elasticity"];render.lod_dist_min=0;render.lod_dist_max=DEFAULT_LOD_DIST_MAX;render.lod_transition_ratio=bpy_obj["b4w_lod_transition"];render.last_lod=true;break;case "LINE":render.do_not_cull=true;render.bb_local=m_bounds.zero_bounding_box();render.bs_local=m_bounds.zero_bounding_sphere();render.be_local=m_bounds.zero_bounding_ellipsoid();
render.bb_world=m_bounds.zero_bounding_box();render.bs_world=m_bounds.zero_bounding_sphere();render.be_world=m_bounds.zero_bounding_ellipsoid();break;case "CAMERA":m_cam.camera_object_to_camera(bpy_obj,obj);m_cam.assign_boundings(obj);break;case "LAMP":m_lights.lamp_to_light(bpy_obj,obj);break;case "SPEAKER":obj.sfx=m_sfx.create_sfx();var is_enabled=false;for(var i=0;i<obj.scenes_data.length;i++)if(obj.scenes_data[i].scene["b4w_enable_audio"]){var is_enabled=true;break}if(is_enabled)m_sfx.update_object(bpy_obj,
obj);break;case "EMPTY":var bb=m_bounds.zero_bounding_box();render.bb_local=bb;var bs=m_bounds.zero_bounding_sphere();render.bs_local=bs;if(bpy_obj["field"])obj.field={type:bpy_obj["field"]["type"],strength:bpy_obj["field"]["strength"]};if(bpy_obj["b4w_anchor"])obj.anchor={type:bpy_obj["b4w_anchor"]["type"],detect_visibility:bpy_obj["b4w_anchor"]["detect_visibility"],element_id:bpy_obj["b4w_anchor"]["element_id"],max_width:bpy_obj["b4w_anchor"]["max_width"]};break;default:break}objects_storage_add(obj)};
exports.update_world=function(bpy_world,world){world.uuid=bpy_world["uuid"];world.bpy_origin=true;prepare_default_actions(bpy_world,world);bpy_world._is_dynamic=world.is_dynamic=calc_is_dynamic(bpy_world,world);bpy_world._is_updated=true;var render_type=world.type;var render=world.render=m_obj_util.create_render(render_type);world.use_default_animation=bpy_world["b4w_use_default_animation"];world.anim_behavior_def=m_anim.anim_behavior_bpy_b4w(bpy_world["b4w_anim_behavior"]);objects_storage_add(world)};
exports.update_object_relations=function(bpy_obj,obj){var render=obj.render;if(obj.parent){if(!obj.parent_is_dupli&&obj.physics_settings.use_collision_compound&&obj.parent.physics_settings.use_collision_compound)obj.use_obj_physics=false;var scenes_have_phy=false;for(var i=0;i<obj.scenes_data.length;i++)if(obj.scenes_data[i].scene._physics){var scenes_have_phy=true;break}if(scenes_have_phy&&has_dynamic_physics(obj)){if(obj.parent_is_dupli)var offset=m_tsr.copy(render.world_tsr,m_tsr.create());else var offset=
render.world_tsr;m_tsr.multiply(obj.parent.render.world_tsr,offset,render.world_tsr);m_trans.set_translation(obj,m_tsr.get_trans_view(render.world_tsr));m_trans.set_scale(obj,m_tsr.get_scale(render.world_tsr));m_trans.set_rotation(obj,m_tsr.get_quat_view(render.world_tsr))}else if(obj.parent_is_dupli||!obj.parent_bone){var offset=m_tsr.copy(render.world_tsr,m_tsr.create());if(obj.viewport_alignment&&obj.parent.type=="CAMERA"){var positioning={distance:obj.viewport_alignment.distance,rotation:m_tsr.get_quat_view(offset)};
switch(obj.viewport_alignment.alignment){case "TOP_LEFT":positioning.top=0;positioning.left=0;break;case "TOP":positioning.top=0;positioning.left=.5;break;case "TOP_RIGHT":positioning.top=0;positioning.right=0;break;case "LEFT":positioning.top=.5;positioning.left=0;break;case "CENTER":positioning.top=.5;positioning.left=.5;break;case "RIGHT":positioning.top=.5;positioning.right=0;break;case "BOTTOM_LEFT":positioning.bottom=0;positioning.left=0;break;case "BOTTOM":positioning.bottom=0;positioning.left=
.5;break;case "BOTTOM_RIGHT":positioning.bottom=0;positioning.right=0;break}m_cons.append_stiff_viewport(obj,obj.parent,positioning)}else m_cons.append_child_of(obj,obj.parent,offset)}else{var offset=m_tsr.copy(render.world_tsr,m_tsr.create());m_cons.append_child_of_bone(obj,obj.parent,obj.parent_bone,offset)}}if(obj.type=="ARMATURE"){var pose_bones=bpy_obj["pose"]["bones"];for(var i=0;i<pose_bones.length;i++){var pose_bone=pose_bones[i];var constraints=pose_bone["constraints"];if(constraints)for(var j=
0;j<constraints.length;j++){var cons=constraints[j];if(cons["type"]!="COPY_TRANSFORMS"||cons["subtarget"]||cons["mute"])continue;var target_obj=cons["target"]._object;m_cons.append_stiff_bone_to_obj(obj,target_obj,pose_bone["name"],m_util.VEC3_IDENT,m_util.QUAT4_IDENT,1)}}}if(obj.type=="MESH")var bpy_armobj=m_anim.get_bpy_armobj(bpy_obj);if(bpy_armobj){var armobj=bpy_armobj._object;var amr_pose_data=armobj.render.pose_data;prepare_skinning_info(bpy_obj,obj,armobj);var pose_data=m_anim.extract_skinned_pose_data(amr_pose_data.trans,
amr_pose_data.quats,render.bone_skinning_info);if(bpy_armobj["b4w_animation_mixing"]){render.quats_before=new Float32Array(pose_data.quats);render.quats_after=new Float32Array(pose_data.quats);render.trans_before=new Float32Array(pose_data.trans);render.trans_after=new Float32Array(pose_data.trans)}else{render.quats_before=pose_data.quats;render.quats_after=pose_data.quats;render.trans_before=pose_data.trans;render.trans_after=pose_data.trans}render.arm_rel_trans=new Float32Array(4);render.arm_rel_quat=
m_quat.create();render.pose_data=pose_data;render.frame_factor=0}if(render.reflective)attach_reflection_data(bpy_obj,obj)};function has_dynamic_physics(obj){var render=obj.render;var phy_set=obj.physics_settings;return obj.is_vehicle||obj.is_floating||m_phy.is_character(obj)||obj.use_obj_physics&&!phy_set.use_ghost&&phy_set.mass>0&&(phy_set.physics_type=="DYNAMIC"||phy_set.physics_type=="RIGID_BODY")}exports.update_force=update_force;function update_force(obj){if(obj.field){var scenes_data=obj.scenes_data;
for(var i=0;i<scenes_data.length;i++){var scene=scenes_data[i].scene;m_scenes.update_force_scene(scene,obj)}}}function attach_reflection_data(bpy_obj,obj){var render=obj.render;if(render.reflection_type=="CUBE")render.cube_reflection_id=_cube_refl_counter++;else if(render.reflection_type=="PLANE"){var refl_plane_obj=get_reflection_plane_obj(bpy_obj,obj);if(!refl_plane_obj)refl_plane_obj=create_default_refl_plane(obj);var refl_plane_id=null;for(var i=0;i<_refl_plane_objs.length;i++){var rp=_refl_plane_objs[i];
if(rp==refl_plane_obj){refl_plane_id=i;break}}if(refl_plane_id==null){refl_plane_id=_refl_plane_objs.length;_refl_plane_objs.push(refl_plane_obj)}refl_plane_obj.render.plane_reflection_id=refl_plane_id;render.plane_reflection_id=refl_plane_id;refl_plane_obj.reflective_objs.push(obj)}}function create_default_refl_plane(obj){var unique_name=m_util.unique_name("%reflection%");var reflection_plane=m_obj_util.create_object(unique_name,"EMPTY");var render=m_obj_util.create_render("EMPTY");reflection_plane.render=
render;copy_scene_data(obj,reflection_plane);m_cons.append_stiff_obj(reflection_plane,obj,[0,0,0],null,1);objects_storage_add(reflection_plane);return reflection_plane}function get_reflection_plane_obj(bpy_obj,obj){var constraints=bpy_obj["constraints"];for(var i=0;i<constraints.length;i++){var cons=constraints[i];if(cons["type"]=="LOCKED_TRACK"&&cons.name=="REFLECTION PLANE")if(cons["target"]._object)return cons["target"]._object;else m_print.warn('Reflection plane target "'+cons["target"]["name"]+
'" for object: "'+obj.name+"\" is not present on the scene. Using object's Z-axis.")}return null}exports.copy_scene_data=copy_scene_data;function copy_scene_data(from_obj,to_obj){var from_data=from_obj.scenes_data;var to_data=to_obj.scenes_data;for(var i=0;i<from_data.length;i++){var is_already_attached=false;for(var j=0;j<to_data.length;j++)if(from_data[i].scene==to_data[j].scene){is_already_attached=true;break}if(!is_already_attached)if(check_bpy_obj_scene_compatibility(to_obj,from_data[i].scene))m_obj_util.append_scene_data(to_obj,
from_data[i].scene)}}exports.check_bpy_obj_scene_compatibility=check_bpy_obj_scene_compatibility;function check_bpy_obj_scene_compatibility(bpy_obj,bpy_scene){if(!bpy_scene._is_main&&bpy_obj["type"]=="SPEAKER")return false;if(!bpy_scene._is_primary_thread&&(bpy_obj["type"]=="LAMP"||bpy_obj["type"]=="CAMERA"))return false;return true}exports.update_objects_dynamics=function(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render&&(obj.render.type=="DYNAMIC"||obj.render.type=="CAMERA"))m_trans.update_transform(obj);
if(obj.use_default_animation&&m_anim.obj_is_animatable(obj)){m_anim.apply_def(obj);if(obj.anim_slots.length)m_anim.play(obj,null,m_anim.SLOT_ALL)}}};function calc_is_dynamic(bpy_obj,obj){if(bpy_obj["dg_parent"]&&bpy_obj["dg_parent"]._is_dynamic)return true;if(bpy_obj["parent"]&&bpy_obj["parent"]._is_dynamic)return true;switch(bpy_obj["type"]){case "MESH":return calc_mesh_is_dynamic(bpy_obj,obj);break;case "EMPTY":return calc_empty_is_dynamic(bpy_obj,obj);break;default:return true;break}}function calc_empty_is_dynamic(bpy_obj,
obj){var is_animated=m_anim.bpy_obj_is_animatable(bpy_obj,obj);var has_nla=m_nla.bpy_obj_has_nla(bpy_obj);var has_do_not_batch=bpy_obj["b4w_do_not_batch"];var anchor=Boolean(bpy_obj["b4w_anchor"]);return is_animated||has_nla||has_do_not_batch||anchor}function calc_mesh_is_dynamic(bpy_obj,obj){var is_animated=m_anim.bpy_obj_is_animatable(bpy_obj,obj);var has_do_not_batch=bpy_obj["b4w_do_not_batch"];var is_collision=bpy_obj["b4w_collision"];var is_vehicle_part=bpy_obj["b4w_vehicle"];var is_floater_part=
bpy_obj["b4w_floating"];var is_character=bpy_obj["b4w_character"];var dyn_grass_emitter=m_particles.has_dynamic_grass_particles(bpy_obj);var has_nla=m_nla.bpy_obj_has_nla(bpy_obj);var has_shape_keys=bpy_obj["data"]["b4w_shape_keys"].length>0;var has_dynamic_geometry=bpy_obj["b4w_dynamic_geometry"];return DEBUG_DISABLE_STATIC_OBJS||is_animated||has_do_not_batch||is_collision||is_vehicle_part||has_shape_keys||is_floater_part||dyn_grass_emitter||is_character||has_nla||has_dynamic_geometry||has_dynamic_mat(bpy_obj)}
function has_dynamic_mat(bpy_obj){var mesh=bpy_obj["data"];for(var i=0;i<mesh["materials"].length;i++){var mat=mesh["materials"][i];if(mat["name"]=="LENS_FLARES")return true;if(has_dynamic_nodes(mat["node_tree"]))return true}return false}function has_dynamic_nodes(node_tree){if(!node_tree)return false;var nodes=node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node["type"]=="VECT_TRANSFORM"){var convert_from=node["convert_from"];var convert_to=node["convert_to"];var output=node.outputs[0];
if(output.is_linked&&!(convert_from=="WORLD"&&convert_to=="CAMERA")&&!(convert_from=="CAMERA"&&convert_to=="WORLD")&&!(convert_from=="OBJECT"&&convert_to=="OBJECT"))return true}}return false}function prepare_skinning_info(bpy_obj,obj,armobj){var render=obj.render;var mesh=bpy_obj["data"];obj.armobj=armobj;var vertex_groups=mesh["vertex_groups"];if(!vertex_groups.length)return;var arm_bone_pointers=armobj.render.bone_pointers;var deform_bone_index=0;var bone_skinning_info={};for(var bone_name in arm_bone_pointers){var vgroup=
m_util.keysearch("name",bone_name,vertex_groups);if(!vgroup)continue;var arm_bpointer=arm_bone_pointers[bone_name];bone_skinning_info[bone_name]={vgroup_index:vgroup["index"],bone_index:arm_bpointer.bone_index,deform_bone_index:deform_bone_index++}}render.bone_skinning_info=bone_skinning_info;var num_bones=deform_bone_index;var max_bones=m_anim.get_max_bones();render.max_bones=num_bones;if(num_bones>2*max_bones){render.is_skinning=false;m_print.error('too many bones for "'+bpy_obj["name"]+'" / '+
render.max_bones+" bones (max "+max_bones+" with blending, "+2*max_bones+" without blending)."+" Skinning will be disabled.")}else render.is_skinning=true}function prepare_shape_keys(bpy_obj,obj){if(bpy_obj["type"]!="MESH")throw"Wrong object type: "+bpy_obj["name"];var render=obj.render;if(bpy_obj["data"]["b4w_shape_keys"].length){render.use_shape_keys=true;for(var i=0;i<bpy_obj["data"]["b4w_shape_keys"].length;i++){var key={};key["value"]=bpy_obj["data"]["b4w_shape_keys"][i]["value"];key["name"]=
bpy_obj["data"]["b4w_shape_keys"][i]["name"];render.shape_keys_values.push(key)}}else render.use_shape_keys=false}function first_mesh_material(bpy_obj){if(bpy_obj["type"]!=="MESH")throw"Wrong object";return bpy_obj["data"]["materials"][0]}exports.get_meta_tags=function(obj){return m_util.clone_object_r(obj.metatags)};exports.cleanup=function(){_color_id_counter=0;_cube_refl_counter=0;_refl_plane_objs.length=0;_outline_anim_objs.length=0;_all_objects={"ALL":[]}};exports.copy=function(obj,name,deep_copy){var new_obj=
copy_object(obj,name,deep_copy);new_obj.render.is_copied=true;new_obj.render.color_id=m_util.gen_color_id(_color_id_counter);_color_id_counter++;return new_obj};function copy_object(obj,new_name,deep_copy){var origin_name=new_name;var dg_parent=m_obj_util.get_dg_parent(obj);var name=dg_parent?m_obj_util.gen_dupli_name(dg_parent.name,new_name):new_name;if(get_object_by_name(name,_all_objects["ALL"],false,DATA_ID_ALL)){var i=1;var num;while(true){num="."+(String(i).length<3?("000"+String(i)).slice(-3):
String(i));if(!get_object_by_name(name+num,_all_objects["ALL"],false,DATA_ID_ALL))break;i++}m_print.error('Object "'+name+'" already exists. '+'Name was replaced by "'+name+num+'".');origin_name+=num;name+=num}var new_obj=m_obj_util.create_object(name,obj.type,origin_name);new_obj.bpy_origin=obj.bpy_origin;new_obj.is_dynamic=obj.is_dynamic;new_obj.is_hair_dupli=obj.is_hair_dupli;new_obj.use_default_animation=obj.use_default_animation;new_obj.render=m_obj_util.copy_object_props_by_value(obj.render);
new_obj.metatags=m_obj_util.copy_object_props_by_value(obj.metatags);copy_scene_data(obj,new_obj);new_obj.action_anim_cache=m_obj_util.copy_bpy_object_props_by_link(obj.action_anim_cache);new_obj.parent=m_obj_util.copy_bpy_object_props_by_link(obj.parent);new_obj.parent_is_dupli=obj.parent_is_dupli;new_obj.parent_bone=obj.parent_bone;new_obj.vertex_anim=m_obj_util.copy_bpy_object_props_by_link(obj.vertex_anim);new_obj.anim_behavior_def=obj.anim_behavior_def;if(obj.physics&&!(obj.is_vehicle||obj.is_character||
obj.is_floating)){new_obj.use_obj_physics=obj.use_obj_physics;new_obj.physics=null}new_obj.collision_id=obj.collision_id;new_obj.correct_bounding_offset=obj.correct_bounding_offset;new_obj.physics_settings=m_obj_util.copy_object_props_by_value(obj.physics_settings);copy_batches(obj,new_obj,deep_copy);m_obj_util.scene_data_set_active(new_obj,false);objects_storage_add(new_obj);return new_obj}function copy_batches(obj,new_obj,deep_copy){var bpy_bufs_data=[];for(var i=0;i<obj.scenes_data.length;i++){var sc_data=
obj.scenes_data[i];var new_sc_data=new_obj.scenes_data[i];var batches=sc_data.batches;if(deep_copy){var new_batches=new_sc_data.batches;for(var j=0;j<batches.length;j++)if(!batches[j].forked_batch){var new_batch=m_obj_util.copy_object_props_by_value(batches[j]);new_batches.push(new_batch);bpy_bufs_data.push(batches[j].bufs_data)}for(var j=0;j<batches.length;j++)if(batches[j].forked_batch){var new_forked_batch=m_obj_util.copy_object_props_by_value(batches[j]);new_batches.push(new_forked_batch);for(var k=
0;k<bpy_bufs_data.length;k++)if(bpy_bufs_data[k]==batches[j].bufs_data)new_forked_batch.bufs_data=new_batches[k].bufs_data}for(var j=0;j<new_batches.length;j++){if(new_batches[j].bufs_data)m_geom.update_gl_buffers(new_batches[j].bufs_data);new_batches[j].odd_id_prop=new_obj.uuid;m_batch.update_batch_id(new_batches[j],m_batch.calculate_render_id(new_obj.render))}m_tex.share_batch_canvas_textures(new_batches)}else new_sc_data.batches=m_obj_util.copy_batches_props_by_link_nr(batches)}}function prepare_physics_settings(bpy_obj,
obj){obj.is_vehicle=bpy_obj["b4w_vehicle"];obj.is_character=bpy_obj["b4w_character"];obj.is_floating=bpy_obj["b4w_floating"];obj.use_obj_physics=bpy_obj["b4w_collision"];obj.collision_id=bpy_obj["b4w_collision_id"];obj.correct_bounding_offset=bpy_obj["b4w_correct_bounding_offset"];var game=bpy_obj["game"];obj.physics_settings={physics_type:game["physics_type"],use_ghost:game["use_ghost"],use_sleep:game["use_sleep"],mass:game["mass"],velocity_min:game["velocity_min"],velocity_max:game["velocity_max"],
damping:game["damping"],rotation_damping:game["rotation_damping"],lock_location_x:game["lock_location_x"],lock_location_y:game["lock_location_y"],lock_location_z:game["lock_location_z"],lock_rotation_x:game["lock_rotation_x"],lock_rotation_y:game["lock_rotation_y"],lock_rotation_z:game["lock_rotation_z"],collision_margin:game["collision_margin"],collision_group:game["collision_group"],collision_mask:game["collision_mask"],use_collision_bounds:game["use_collision_bounds"],collision_bounds_type:game["collision_bounds_type"],
use_collision_compound:game["use_collision_compound"]};var vs=bpy_obj["b4w_vehicle_settings"];if(vs)obj.vehicle_settings={name:vs["name"],part:vs["part"],suspension_rest_length:vs["suspension_rest_length"],suspension_compression:vs["suspension_compression"],suspension_stiffness:vs["suspension_stiffness"],suspension_damping:vs["suspension_damping"],wheel_friction:vs["wheel_friction"],roll_influence:vs["roll_influence"],max_suspension_travel_cm:vs["max_suspension_travel_cm"],force_max:vs["force_max"],
brake_max:vs["brake_max"],steering_max:vs["steering_max"],max_speed_angle:vs["max_speed_angle"],delta_tach_angle:vs["delta_tach_angle"],speed_ratio:vs["speed_ratio"],steering_ratio:vs["steering_ratio"],inverse_control:vs["inverse_control"],floating_factor:vs["floating_factor"],water_lin_damp:vs["water_lin_damp"],water_rot_damp:vs["water_rot_damp"],synchronize_position:vs["synchronize_position"]};var fs=bpy_obj["b4w_floating_settings"];if(fs)obj.floating_settings={name:fs["name"],part:fs["part"],floating_factor:fs["floating_factor"],
water_lin_damp:fs["water_lin_damp"],water_rot_damp:fs["water_rot_damp"],synchronize_position:fs["synchronize_position"]};var cs=bpy_obj["b4w_character_settings"];if(cs)obj.character_settings={walk_speed:cs["walk_speed"],run_speed:cs["run_speed"],step_height:cs["step_height"],jump_strength:cs["jump_strength"],waterline:cs["waterline"]};for(var i=0;i<bpy_obj["constraints"].length;i++){var cons=bpy_obj["constraints"][i];if(cons["type"]!="RIGID_BODY_JOINT")continue;obj.physics_constraints.push({target:cons["target"]._object,
pivot_type:cons["pivot_type"],pivot_x:cons["pivot_x"],pivot_y:cons["pivot_y"],pivot_z:cons["pivot_z"],axis_x:cons["axis_x"],axis_y:cons["axis_y"],axis_z:cons["axis_z"],use_limit_x:cons["use_limit_x"],use_limit_y:cons["use_limit_y"],use_limit_z:cons["use_limit_z"],use_angular_limit_x:cons["use_angular_limit_x"],use_angular_limit_y:cons["use_angular_limit_y"],use_angular_limit_z:cons["use_angular_limit_z"],limit_max_x:cons["limit_max_x"],limit_max_y:cons["limit_max_y"],limit_max_z:cons["limit_max_z"],
limit_min_x:cons["limit_min_x"],limit_min_y:cons["limit_min_y"],limit_min_z:cons["limit_min_z"],limit_angle_max_x:cons["limit_angle_max_x"],limit_angle_max_y:cons["limit_angle_max_y"],limit_angle_max_z:cons["limit_angle_max_z"],limit_angle_min_x:cons["limit_angle_min_x"],limit_angle_min_y:cons["limit_angle_min_y"],limit_angle_min_z:cons["limit_angle_min_z"]})}}function prepare_default_actions(bpy_obj,obj){var obj_anim_data=bpy_obj["animation_data"];var data_anim_data=bpy_obj["data"]?bpy_obj["data"]["animation_data"]:
null;if(obj_anim_data&&obj_anim_data["action"]){var action=obj_anim_data["action"];if(action._render.type==m_anim.AT_OBJECT||action._render.type==m_anim.AT_ARMATURE&&obj.type=="ARMATURE"||action._render.type==m_anim.AT_LIGHT&&obj.type=="LAMP"||action._render.type==m_anim.AT_ENVIRONMENT&&obj.type=="WORLD")obj.actions.push(action)}if(data_anim_data&&data_anim_data["action"]&&(obj.type=="SPEAKER"||obj.type=="LAMP"))obj.actions.push(data_anim_data["action"]);if(obj.type=="MESH")obj.actions.push.apply(obj.actions,
m_anim.get_bpy_material_actions(bpy_obj))}function prepare_vertex_anim(bpy_obj,obj){for(var i=0;i<bpy_obj["data"]["b4w_vertex_anim"].length;i++){var va=bpy_obj["data"]["b4w_vertex_anim"][i];obj.vertex_anim.push({name:va["name"],frame_start:va["frame_start"],frame_end:va["frame_end"],averaging:va["averaging"],averaging_interval:va["averaging_interval"],allow_nla:va["allow_nla"]})}obj.render.vertex_anim=obj.vertex_anim.length?true:false}function prepare_parenting_props(bpy_obj,obj){if(bpy_obj["parent"]){obj.parent=
bpy_obj["parent"]._object;if(bpy_obj["parent_type"]=="BONE"&&bpy_obj["parent"]["type"]=="ARMATURE")obj.parent_bone=bpy_obj["parent_bone"];if(bpy_obj["pinverse_tsr"]){obj.pinverse_tsr=m_tsr.create();m_tsr.copy(bpy_obj["pinverse_tsr"],obj.pinverse_tsr)}}else if(bpy_obj["dg_parent"]){obj.parent=bpy_obj["dg_parent"]._object;obj.parent_is_dupli=true}}exports.update_boundings=function(obj){var render=obj.render;var batches=obj.scenes_data[0].batches;var max_x,max_y,max_z,min_x,min_y,min_z;var bmax_x,bmax_y,
bmax_z,bmin_x,bmin_y,bmin_z;var bounding_verts=[];for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type=="MAIN"){var vbo_array=batches[0].bufs_data.vbo_array;var pos_offset=batches[0].bufs_data.pointers["a_position"].offset;max_x=min_x=vbo_array[pos_offset];max_y=min_y=vbo_array[pos_offset+1];max_z=min_z=vbo_array[pos_offset+2]}}for(var i=0;i<batches.length;i++){var batch=batches[i];if(!batch.bufs_data||!(batch.be_world&&batch.bb_world))continue;var vbo_array=batch.bufs_data.vbo_array;
var pos_offset=batch.bufs_data.pointers["a_position"].offset;var pos_length=batch.bufs_data.pointers["a_position"].length+pos_offset;bmax_x=bmin_x=vbo_array[pos_offset];bmax_y=bmin_y=vbo_array[pos_offset+1];bmax_z=bmin_z=vbo_array[pos_offset+2];for(var j=pos_offset;j<pos_length;j=j+3){var x=vbo_array[j];var y=vbo_array[j+1];var z=vbo_array[j+2];bmax_x=Math.max(x,bmax_x);bmax_y=Math.max(y,bmax_y);bmax_z=Math.max(z,bmax_z);bmin_x=Math.min(x,bmin_x);bmin_y=Math.min(y,bmin_y);bmin_z=Math.min(z,bmin_z)}batch.bb_local.max_x=
bmax_x.toFixed(3);batch.bb_local.max_y=bmax_y.toFixed(3);batch.bb_local.max_z=bmax_z.toFixed(3);batch.bb_local.min_x=bmin_x.toFixed(3);batch.bb_local.min_y=bmin_y.toFixed(3);batch.bb_local.min_z=bmin_z.toFixed(3);m_bounds.bounding_box_transform(batch.bb_local,render.world_tsr,batch.bb_world);m_bounds.extract_bb_corners(batch.bb_world,_bb_corners_tmp);bounding_verts.length=0;for(var k=0;k<_bb_corners_tmp.length;k++)bounding_verts.push(_bb_corners_tmp[k]);batch.be_world=m_bounds.create_bounding_ellipsoid_by_bb(bounding_verts,
true);batch.be_local=m_bounds.calc_be_local_by_tsr(batch.be_world,render.world_tsr);if(batch.type=="MAIN"){max_x=Math.max(bmax_x,max_x);max_y=Math.max(bmax_y,max_y);max_z=Math.max(bmax_z,max_z);min_x=Math.min(bmin_x,min_x);min_y=Math.min(bmin_y,min_y);min_z=Math.min(bmin_z,min_z)}}var bb_local={max_x:parseFloat(max_x.toFixed(3)),max_y:parseFloat(max_y.toFixed(3)),max_z:parseFloat(max_z.toFixed(3)),min_x:parseFloat(min_x.toFixed(3)),min_y:parseFloat(min_y.toFixed(3)),min_z:parseFloat(min_z.toFixed(3))};
var x_width=max_x-min_x;var y_width=max_y-min_y;var z_width=max_z-min_z;var s_cen_x=.5*(max_x+min_x);var s_cen_y=.5*(max_y+min_y);var s_cen_z=.5*(max_z+min_z);var c_cen_x=s_cen_x;var c_cen_y=s_cen_y;var c_cen_z=s_cen_z;var s_rad=Math.max(x_width,Math.max(y_width,z_width))/2;var c_rad=Math.max(x_width,z_width)/2;var tmp_s_cen=[s_cen_x/(x_width?x_width:1),s_cen_y/(y_width?y_width:1),s_cen_z/(z_width?z_width:1)];var tmp_rad=.5;if(render.billboard){var x=Math.max(Math.abs(bb_local.max_x),Math.abs(bb_local.min_x));
var y=Math.max(Math.abs(bb_local.max_y),Math.abs(bb_local.min_y));var z=Math.max(Math.abs(bb_local.max_z),Math.abs(bb_local.min_z));var sphere_radius=Math.sqrt(x*x+y*y+z*z);var cylinder_radius=Math.sqrt(x*x+y*y);bb_local.max_x=bb_local.max_y=bb_local.max_z=sphere_radius;bb_local.min_x=bb_local.min_y=bb_local.min_z=-sphere_radius;c_rad=cylinder_radius;s_rad=sphere_radius;var bs_center=new Float32Array([0,0,0]);var be_axes=new Float32Array([s_rad,s_rad,s_rad]);var be_center=new Float32Array([0,0,0])}else{for(var i=
0;i<batches.length;i++){var batch=batches[i];if(batch.type!="MAIN")continue;var vbo_array=batch.bufs_data.vbo_array;var pointers=batches[i].bufs_data.pointers;var pos_offset=pointers["a_position"].offset;var pos_length=pointers["a_position"].length+pos_offset;for(var j=pos_offset;j<pos_length;j=j+3){var x=vbo_array[j];var y=vbo_array[j+1];var z=vbo_array[j+2];var s_cen_dist=Math.sqrt((s_cen_x-x)*(s_cen_x-x)+(s_cen_y-y)*(s_cen_y-y)+(s_cen_z-z)*(s_cen_z-z));if(s_cen_dist>s_rad){var g_x=s_cen_x-s_rad*
(x-s_cen_x)/s_cen_dist;var g_y=s_cen_y-s_rad*(y-s_cen_y)/s_cen_dist;var g_z=s_cen_z-s_rad*(z-s_cen_z)/s_cen_dist;s_cen_x=(g_x+x)/2;s_cen_y=(g_y+y)/2;s_cen_z=(g_z+z)/2;s_rad=Math.sqrt((s_cen_x-x)*(s_cen_x-x)+(s_cen_y-y)*(s_cen_y-y)+(s_cen_z-z)*(s_cen_z-z))}var c_cen_dist=Math.sqrt((c_cen_x-x)*(c_cen_x-x)+(c_cen_z-z)*(c_cen_z-z));if(c_cen_dist>c_rad){var g_x=c_cen_x-c_rad*(x-c_cen_x)/c_cen_dist;var g_z=c_cen_z-c_rad*(z-c_cen_z)/c_cen_dist;c_cen_x=(g_x+x)/2;c_cen_z=(g_z+z)/2;c_rad=Math.sqrt((c_cen_x-
x)*(c_cen_x-x)+(c_cen_z-z)*(c_cen_z-z))}x/=x_width?x_width:1;y/=y_width?y_width:1;z/=z_width?z_width:1;var s_cen_tmp=Math.sqrt((tmp_s_cen[0]-x)*(tmp_s_cen[0]-x)+(tmp_s_cen[1]-y)*(tmp_s_cen[1]-y)+(tmp_s_cen[2]-z)*(tmp_s_cen[2]-z));if(s_cen_tmp>tmp_rad){var g_x=tmp_s_cen[0]-tmp_rad*(x-tmp_s_cen[0])/s_cen_tmp;var g_y=tmp_s_cen[1]-tmp_rad*(y-tmp_s_cen[1])/s_cen_tmp;var g_z=tmp_s_cen[2]-tmp_rad*(z-tmp_s_cen[2])/s_cen_tmp;tmp_s_cen[0]=(g_x+x)/2;tmp_s_cen[1]=(g_y+y)/2;tmp_s_cen[2]=(g_z+z)/2;tmp_rad=Math.sqrt((tmp_s_cen[0]-
x)*(tmp_s_cen[0]-x)+(tmp_s_cen[1]-y)*(tmp_s_cen[1]-y)+(tmp_s_cen[2]-z)*(tmp_s_cen[2]-z))}}}var e_cen_x=x_width?x_width*tmp_s_cen[0]:max_x;var e_cen_y=y_width?y_width*tmp_s_cen[1]:max_y;var e_cen_z=z_width?z_width*tmp_s_cen[2]:max_z;var e_axis_x=tmp_rad*x_width;var e_axis_y=tmp_rad*y_width;var e_axis_z=tmp_rad*z_width;var bs_center=new Float32Array([s_cen_x,s_cen_y,s_cen_z]);var be_axes=new Float32Array([e_axis_x,e_axis_y,e_axis_z]);var be_center=new Float32Array([e_cen_x,e_cen_y,e_cen_z]);c_rad=parseFloat(c_rad.toFixed(3))}render.bb_local=
bb_local;m_batch.set_local_cylinder_capsule(render,c_rad,c_rad,bb_local);var bs_local=m_bounds.create_bounding_sphere(s_rad,bs_center);render.bs_local=bs_local;var be_local=m_bounds.create_bounding_ellipsoid([be_axes[0],0,0],[0,be_axes[1],0],[0,0,be_axes[2]],be_center);render.be_local=be_local;m_trans.update_transform(obj);if(cfg_def.debug_view)for(var i=0;i<batches.length;i++)if(batches[i].type==="DEBUG_VIEW"&&batches[i].debug_sphere){var submesh=m_primitives.generate_uv_sphere(16,8,1,be_local.center,
false,false);var scale=[be_local.axis_x[0],be_local.axis_y[1],be_local.axis_z[2]];m_geom.scale_submesh_xyz(submesh,scale,be_local.center);m_geom.submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=m_geom.extract_polyindices(submesh);m_batch.update_batch_geometry(batches[i],submesh);break}};exports.get_scene_objs=get_scene_objs;function get_scene_objs(scene,type,data_id){var objs_by_type=_all_objects[type]||[];var objs=[];for(var i=0;i<objs_by_type.length;i++){var obj=objs_by_type[i];
if(obj.render.data_id!=data_id&&data_id!=DATA_ID_ALL)continue;var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var sc_data=scenes_data[j];if(sc_data.scene==scene)objs.push(obj)}}return objs}exports.get_scene_objs_derived=function(scene,type,data_id){var objs_by_type=_all_objects[type]||[];var objs=[];for(var i=0;i<objs_by_type.length;i++){var obj=objs_by_type[i];if(obj.render.data_id!=data_id&&data_id!=DATA_ID_ALL||!obj.bpy_origin)continue;var scenes_data=obj.scenes_data;for(var j=
0;j<scenes_data.length;j++){var sc_data=scenes_data[j];if(sc_data.scene==scene)objs.push(obj)}}return objs};exports.get_all_objects=function(data_id){var all_objs=_all_objects["ALL"];if(data_id==DATA_ID_ALL)return all_objs;var objs=[];for(var i=0;i<all_objs.length;i++){var obj=all_objs[i];if(obj.render.data_id==data_id)objs.push(obj)}return objs};function sort_func(l1,l2){if(l2.use_diffuse&&l2.use_specular&&!(l1.use_diffuse&&l1.use_specular))return true;if(!l1.use_diffuse)if(l2.use_diffuse||!l1.use_specular&&
l2.use_specular)return true;return false}exports.sort_lamps=function(scene){var lamps=get_scene_objs(scene,"LAMP",DATA_ID_ALL);if(lamps.length!=scene._render.num_lamps_added)return;var lamp_indexes=[];for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var scene_data=m_obj_util.get_scene_data(lamp,scene);lamp_indexes[scene_data.light_index]=i}for(var i=0;i<lamp_indexes.length-1;i++)for(var j=i+1;j<lamp_indexes.length;j++)if(sort_func(lamps[lamp_indexes[i]].light,lamps[lamp_indexes[j]].light)){var tmp=
lamp_indexes[i];lamp_indexes[i]=lamp_indexes[j];lamp_indexes[j]=tmp}for(var i=0;i<lamp_indexes.length;i++){var lamp=lamps[lamp_indexes[i]];var lamp_sc_data=m_obj_util.get_scene_data(lamp,scene);lamp_sc_data.light_index=i;m_scenes.update_lamp_scene(lamps[lamp_indexes[i]],scene)}};exports.update_all_mesh_shaders=function(scene){var lamps=get_scene_objs(scene,"LAMP",DATA_ID_ALL);var objs=get_scene_objs(scene,"MESH",DATA_ID_ALL);for(var i=0;i<objs.length;i++){var sc_data=m_obj_util.get_scene_data(objs[i],
scene);var batches=sc_data.batches;for(var j=0;j<batches.length;j++){var batch=batches[j];if(batch.type!="MAIN")continue;m_batch.update_batch_lights(batch,lamps,scene);m_batch.update_shader(batch)}}};exports.get_selectable_objects=function(){var sel_objects=[];var objects=_all_objects["MESH"];for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render.selectable&&obj.bpy_origin)sel_objects.push(obj)}return sel_objects};exports.get_outlining_objects=function(){var outlining_objects=[];var objects=
_all_objects["MESH"];for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.render.outlining&&obj.bpy_origin)outlining_objects.push(obj)}return outlining_objects};exports.get_object=function(){var obj_found=null;var obj_name="";var objs=_all_objects["ALL"];switch(arguments[0]){case exports.GET_OBJECT_BY_NAME:obj_name=arguments[1];obj_found=get_object_by_name(arguments[1],objs,true,arguments[2]);break;case exports.GET_OBJECT_BY_DUPLI_NAME:obj_name=arguments[2];obj_found=get_object_by_dupli_name(arguments[1],
arguments[2],objs,arguments[3]);break;case exports.GET_OBJECT_BY_DUPLI_NAME_LIST:obj_name=arguments[1][arguments[1].length-1];obj_found=get_object_by_dupli_name_list(arguments[1],objs,arguments[2]);break;default:break}return obj_found};function get_object_by_name(name,objects,use_origin_name,data_id){var obj_found=null;for(var i=0;i<objects.length;i++){var obj=objects[i];var obj_name=use_origin_name?obj.origin_name:obj.name;if(obj_name==name&&(obj.render.data_id==data_id||data_id==DATA_ID_ALL)){obj_found=
obj;if(!m_obj_util.get_dg_parent(obj_found))break}}return obj_found}function get_object_by_dupli_name(empty_name,dupli_name,objects,data_id){for(var i=0;i<objects.length;i++){var obj=objects[i];if(obj.origin_name==dupli_name&&(obj.render.data_id==data_id||data_id==DATA_ID_ALL)){var dg_parent=m_obj_util.get_dg_parent(obj);if(dg_parent&&dg_parent.origin_name==empty_name)return obj}}return null}function get_object_by_dupli_name_list(name_list,objects,data_id){for(var i=0;i<objects.length;i++){var obj=
objects[i];var j=name_list.length-1;var curr_obj=obj;var is_valid=true;while(j>=0&&is_valid){is_valid=curr_obj&&(curr_obj.origin_name==name_list[j]&&(curr_obj.render.data_id==data_id||data_id==DATA_ID_ALL));if(curr_obj)curr_obj=m_obj_util.get_dg_parent(curr_obj);j--}if(is_valid&&!curr_obj)return obj}return null}exports.get_world_by_name=function(name,data_id){var full_name="%meta_world%"+name;var wrds=_all_objects["WORLD"];return get_object_by_name(full_name,wrds,true,data_id)};function update_obj_outline_intensity(obj,
timeline){var outline_intensity=0;var oa=obj.outline_animation;if(oa.time_start==0)oa.time_start=timeline;var dt=timeline-oa.time_start;if(oa.relapses&&dt/oa.period>=oa.relapses){clear_outline_anim(obj);return}var periodic_time=dt%oa.period;if(periodic_time<oa.outline_time){var outline_time=periodic_time/(oa.outline_time/5);var stage=Math.floor(outline_time);switch(stage){case 0:outline_intensity=(outline_time-stage)/2;break;case 1:outline_intensity=(outline_time-stage)/2+.5;break;case 2:outline_intensity=
1;break;case 3:outline_intensity=1-(outline_time-stage)/2;break;case 4:outline_intensity=.5-(outline_time-stage)/2;break}}obj.render.outline_intensity=outline_intensity}exports.pick_object=function(canvas_x,canvas_y){var main_scene=m_scenes.get_main();if(!main_scene){m_print.error("No active scene");return null}var anchor=m_anchors.pick_anchor(canvas_x,canvas_y);if(anchor)return anchor;var color=m_scenes.pick_color(main_scene,canvas_x,canvas_y);if(!color)return null;var sobjs=get_scene_objs(main_scene,
"MESH",DATA_ID_ALL);for(var i=0;i<sobjs.length;i++){var render=sobjs[i].render;var color_id=render.color_id;if(color_id)if(Math.abs(255*color_id[0]-color[0])<COLOR_ID_THRESHOLD&&Math.abs(255*color_id[1]-color[1])<COLOR_ID_THRESHOLD&&Math.abs(255*color_id[2]-color[2])<COLOR_ID_THRESHOLD){if(render.outlining&&render.outline_on_select)if(cfg_out.outlining_overview_mode)exports.apply_outline_anim(sobjs[i],cfg_out.outline_duration,cfg_out.outline_period,cfg_out.outline_relapses);else{var oa_set=render.outline_anim_settings_default;
exports.apply_outline_anim(sobjs[i],oa_set.outline_duration,oa_set.outline_period,oa_set.outline_relapses)}return sobjs[i]}}return null};exports.set_wind_params=function(scene,wind_params){var objs=get_scene_objs(scene,"EMPTY",DATA_ID_ALL);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.field&&obj.field.type==="WIND")var wind_obj=obj}if(!wind_obj){m_print.error("There is no wind on the scene");return 0}if(typeof wind_params.wind_dir=="number"){var angle=m_util.deg_to_rad(wind_params.wind_dir);
m_vec3.set(Math.sin(angle),0,Math.cos(angle),_vec3_tmp);m_util.dir_to_quat(_vec3_tmp,m_util.AXIS_Y,_quat4_tmp);m_trans.set_rotation(wind_obj,_quat4_tmp)}if(typeof wind_params.wind_strength=="number")wind_obj.field.strength=wind_params.wind_strength;update_force(wind_obj)};exports.remove_object=function(obj){if(m_cons.check_constraint(obj))m_cons.remove(obj);objects_storage_remove(obj)};exports.objects_storage_add=objects_storage_add;function objects_storage_add(obj){_all_objects["ALL"].push(obj);
if(!_all_objects[obj.type])_all_objects[obj.type]=[];_all_objects[obj.type].push(obj);var plane_refl_id=obj.render.plane_reflection_id;if(plane_refl_id!=null)for(var i=0;i<_refl_plane_objs.length;i++){var refl_plane=_refl_plane_objs[i];if(refl_plane.render.plane_reflection_id==plane_refl_id)refl_plane.reflective_objs.push(obj)}}function objects_storage_remove(obj){var all_objs=_all_objects["ALL"];var typed_objs=_all_objects[obj.type];var ind_all=all_objs.indexOf(obj);var ind_typed=typed_objs.indexOf(obj);
if(ind_all!=-1)all_objs.splice(ind_all,1);if(ind_typed!=-1)typed_objs.splice(ind_typed,1)}exports.objects_storage_check=function(obj){return _all_objects[obj.type]&&_all_objects[obj.type].indexOf(obj)>-1}};b4w.module["__obj_util"]=function(exports,require){var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var m_cfg=require("__config");var cfg_def=m_cfg.defaults;var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _quat4_tmp2=new Float32Array(4);var _tsr_tmp=m_tsr.create();var _tsr_tmp2=m_tsr.create();var DEBUG_DISABLE_STATIC_OBJS=false;exports.create_render=create_render;function create_render(type){var render={id:0,
type:type,data_id:0,world_tsr:m_tsr.create_ext(),world_zup_tsr:m_tsr.create_ext(),world_inv_zup_tsr:m_tsr.create_ext(),pivot:new Float32Array(3),hover_pivot:new Float32Array(3),init_dist:0,init_top:0,is_copied:false,color_id:null,outline_intensity:0,target_cam_upside_down:false,vertical_axis:m_vec3.create(),use_panning:false,move_style:0,velocity_trans:1,velocity_rot:1,velocity_zoom:1,dof_distance:0,dof_front:0,dof_rear:0,dof_power:0,dof_object:null,underwater:false,horizontal_limits:null,vertical_limits:null,
distance_limits:null,hover_vert_trans_limits:null,hover_horiz_trans_limits:null,pivot_limits:null,enable_hover_hor_rotation:true,outline_anim_settings_default:{outline_duration:1,outline_period:1,outline_relapses:0},cube_reflection_id:null,plane_reflection_id:null,reflection_plane:new Float32Array(4),friction:0,elasticity:0,lod_dist_max:0,lod_dist_min:0,lod_transition_ratio:0,do_not_render:false,shadow_cast:false,shadow_receive:false,shadow_cast_only:false,reflexible:false,reflexible_only:false,reflective:false,
reflection_type:"",caustics:false,wind_bending:false,disable_fogging:false,dynamic_geometry:false,dynamic_grass:false,do_not_cull:false,hide:false,last_lod:false,selectable:false,origin_selectable:false,outlining:false,origin_outlining:false,outline_on_select:false,is_hair_particles:false,is_visible:false,force_zsort:false,wind_bending_angle:0,wind_bending_amp:0,wind_bending_freq:0,detail_bending_freq:0,detail_bending_amp:0,branch_bending_amp:0,main_bend_col:"",detail_bend_col:null,bend_center_only:false,
billboard:false,billboard_pres_glob_orientation:false,billboard_type:"",billboard_spherical:false,frame_factor:0,time:0,va_frame:0,va_frame_factor:0,max_bones:0,frames_blending:false,vertex_anim:false,use_shape_keys:false,shape_keys_values:[],is_skinning:false,anim_mixing:false,anim_mix_factor:1,anim_mix_factor_change_speed:0,anim_destination_mix_factor:1,two_last_skeletal_slots:new Int8Array([-1,-1]),skinned_renders:[],mesh_to_arm_bone_maps:[],skinning_data_cache:[],quats_before:null,quats_after:null,
trans_before:null,trans_after:null,bone_pointers:null,bone_skinning_info:null,pose_data:null,arm_rel_trans:null,arm_rel_quat:null,bb_original:null,bb_local:null,bcyl_local:null,bcap_local:null,bcon_local:null,bs_local:null,be_local:null};render.lod_dist_max=1E4;m_vec3.copy(m_util.AXIS_Y,render.vertical_axis);return render}exports.create_object=create_object;function create_object(name,type,origin_name){if(!origin_name)origin_name=name;var obj={name:name,uuid:m_util.gen_uuid(),origin_name:origin_name,
type:type,bpy_origin:false,is_dynamic:false,is_hair_dupli:false,use_default_animation:false,render:null,constraint:null,sfx:null,light:null,armobj:null,anchor:null,field:null,metatags:null,scenes_data:[],vertex_anim:[],cons_descends:[],cons_armat_bone_descends:[],anim_slots:[],reflective_objs:[],nla_events:[],action_anim_cache:[],sensor_manifolds:null,sensor_manifolds_arr:[],parent:null,parent_is_dupli:false,parent_bone:"",viewport_alignment:null,pinverse_tsr:null,use_obj_physics:false,collision_id:"",
correct_bounding_offset:"AUTO",is_vehicle:false,is_character:false,is_floating:false,physics:null,vehicle:null,floater:null,vehicle_settings:null,floating_settings:null,character_settings:null,physics_constraints:[],physics_settings:{physics_type:"NO_COLLISION",use_ghost:false,use_sleep:false,mass:0,velocity_min:0,velocity_max:0,damping:0,rotation_damping:0,lock_location_x:false,lock_location_y:false,lock_location_z:false,lock_rotation_x:false,lock_rotation_y:false,lock_rotation_z:false,collision_margin:0,
collision_group:0,collision_mask:0,use_collision_bounds:false,collision_bounds_type:"BOX",use_collision_compound:false},outline_animation:{time_start:0,outline_time:0,period:0,relapses:0},anim_behavior_def:0,actions:[],need_update_transform:false,need_inv_zup_tsr:false,meta_objects:[]};return obj}exports.copy_bpy_object_props_by_link=function(obj){if(obj instanceof Array)return obj.slice();else return obj};exports.copy_batches_props_by_link_nr=function(batches){var new_batches=[];for(var i=0;i<batches.length;i++){var batch=
batches[i];var new_batch={};for(var prop in batch)if(batch[prop]==batch.bb_world)new_batch.bb_world=copy_object_props_by_value(batch.bb_world);else if(batch[prop]==batch.be_world)new_batch.be_world=copy_object_props_by_value(batch.be_world);else new_batch[prop]=batch[prop];new_batches.push(new_batch)}return new_batches};exports.copy_object_props_by_value=copy_object_props_by_value;function copy_object_props_by_value(obj){if(!(obj instanceof Object))return obj;var textures=null;var texture_names=null;
var shape_keys=null;if(obj.textures){textures=obj.textures;obj.textures=null}if(obj.texture_names){texture_names=obj.texture_names;obj.texture_names=null}if(obj.shape_keys){shape_keys=obj.shape_keys;obj.shape_keys=null}var obj_clone;var Constructor=obj.constructor;switch(Constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:obj_clone=new Constructor(obj);break;case Array:obj_clone=new Constructor(obj.length);
for(var i=0;i<obj.length;i++)obj_clone[i]=copy_object_props_by_value(obj[i]);break;case WebGLUniformLocation:case WebGLProgram:case WebGLShader:obj_clone=obj;break;case WebGLFramebuffer:case WebGLTexture:case WebGLBuffer:obj_clone=null;break;case Function:obj_clone=obj;break;default:obj_clone=new Constructor;for(var prop in obj)obj_clone[prop]=copy_object_props_by_value(obj[prop]);break}if(textures){obj_clone.textures=textures;obj.textures=textures}if(texture_names){obj_clone.texture_names=texture_names;
obj.texture_names=texture_names}if(shape_keys){obj_clone.shape_keys=shape_keys;obj.shape_keys=shape_keys}return obj_clone}exports.is_dynamic=function(obj){return obj.is_dynamic};exports.is_dynamic_mesh=function(obj){return obj.type=="MESH"&&obj.is_dynamic};exports.append_scene_data=function(obj,scene){var sc_data=init_scene_data(scene);obj.scenes_data.push(sc_data)};exports.append_batch=function(obj,scene,batch){var sc_data=get_scene_data(obj,scene);sc_data.batches.push(batch)};exports.remove_scene_data=
function(obj,scene){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];if(sc_data.scene==scene){scenes_data.splice(i,1);break}}};exports.get_scene_data=get_scene_data;function get_scene_data(obj,scene){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];if(sc_data.scene==scene)return sc_data}return null}exports.update_refl_objects=function(objects,reflection_plane){for(var i=0;i<objects.length;i++)m_vec4.copy(reflection_plane,
objects[i].render.reflection_plane)};function init_scene_data(scene){var sc_data={scene:scene,is_active:false,batches:[],plane_refl_subs:[],cube_refl_subs:null,shadow_subscenes:[],light_index:0,obj_has_nla_on_scene:false,cameras:[],shadow_cameras:[]};return sc_data}exports.scene_data_set_active=function(obj,flag,scene){for(var i=0;i<obj.scenes_data.length;i++){var sc_data=obj.scenes_data[i];if(!scene||sc_data.scene==scene)sc_data.is_active=flag}};exports.get_shadow_lamps=function(lamps,use_ssao){var shadow_lamps=
[];var max_shadow_lamps_num=use_ssao?cfg_def.max_cast_lamps-1:cfg_def.max_cast_lamps;for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(lamp.light.generate_shadows&&shadow_lamps.length<max_shadow_lamps_num)shadow_lamps.push(lamp)}if(shadow_lamps.length)return shadow_lamps;else if(lamps[0])return[lamps[0]];else return[]};exports.check_obj_soft_particles_accessibility=function(bpy_obj,pset){if(pset["b4w_enable_soft_particles"]&&pset["b4w_particles_softness"]>0){var index=pset["material"]-1;var materials=
bpy_obj["data"]["materials"];if(index>=0&&index<materials.length&&(materials[index]["game_settings"]["alpha_blend"]=="ADD"||materials[index]["game_settings"]["alpha_blend"]=="ALPHA"||materials[index]["game_settings"]["alpha_blend"]=="ALPHA_SORT"))return true}return false};exports.check_inv_zup_tsr_is_needed=function(obj){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var dirs=batches[j].shaders_info.directives;
for(var k=0;k<dirs.length;k++){var dir=dirs[k];if(dir[0]=="USE_ZUP_MODEL_MATRIX_INVERSE"&&dir[1]=="1")return true}}}return false};exports.gen_dupli_name=function(dg_parent_name,name){return dg_parent_name+"*"+name};exports.get_parent=function(obj){return!obj.parent_is_dupli?obj.parent:null};exports.get_dg_parent=get_dg_parent;function get_dg_parent(obj){if(obj.parent_is_dupli)return obj.parent;else if(obj.parent)return get_dg_parent(obj.parent);else return null}exports.get_dg_objects=function(dg_parent,
objects){var dg_objs=[];for(var i=0;i<objects.length;i++){var obj=objects[i];if(get_dg_parent(obj)==dg_parent)dg_objs.push(obj)}return dg_objs};exports.is_mesh=function(obj){return obj.type==="MESH"};exports.is_armature=function(obj){return obj.type==="ARMATURE"};exports.is_speaker=function(obj){return obj.type==="SPEAKER"};exports.is_camera=function(obj){return obj.type==="CAMERA"};exports.is_lamp=function(obj){return obj.type==="LAMP"};exports.is_empty=function(obj){return obj.type==="EMPTY"};exports.is_line=
function(obj){return obj.type==="LINE"};exports.is_world=function(obj){return obj.type==="WORLD"}};b4w.module["__particles"]=function(exports,require){var m_cfg=require("__config");var m_batch=require("__batch");var m_geom=require("__geometry");var m_tex=require("__textures");var m_time=require("__time");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var STDGRAVITY=9.81;var DELAYRANDFACTOR=10;var cfg_def=m_cfg.defaults;var _tsr_tmp=new Float32Array(8);var _vec3_tmp=new Float32Array(3);var _particles_objs_cache=[];function create_particles_data(name,type){var pdata=
{name:name,p_type:type,time:0,prev_time:-1,use_world_space:false,frame_start:0,frame_end:0,time_length:0,lifetime_frames:0,lifetime:0,cyclic:false,mass:0,nfactor:0,gravity:0,fade_in:0,fade_out:0,wind_factor:0,size:0,alpha_start:0,alpha_end:0,color_ramp_length:0,color_ramp:new Float32Array(16),positions:null,positions_cache:null,normals:null,normals_cache:null,delay_attrs:null,delay_attrs_masked:null,emitter_tsr_snapshots:null,p_data:null,tilt:0,tilt_rand:0};return pdata}var _rand=function(){throw"_rand() undefined";
};exports.update=function(){for(var i=0;i<_particles_objs_cache.length;i++){var obj=_particles_objs_cache[i];var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var sc_data=scenes_data[j];var batches=sc_data.batches;update_emitter_transform(obj,batches)}}};exports.obj_has_particles=function(obj){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++)if(batches[j].particles_data)return true}return false};
exports.obj_has_anim_particles=function(obj){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata&&pdata.p_type=="EMITTER")return true}}return false};exports.bpy_obj_has_particles=function(bpy_obj){return bpy_obj["particle_systems"].length>0};exports.bpy_obj_has_anim_particles=function(bpy_obj){for(var i=0;i<bpy_obj["particle_systems"].length;i++){var psettings=bpy_obj["particle_systems"][i]["settings"];
if(psettings["type"]=="EMITTER")return true}return false};exports.has_dynamic_grass_particles=function(bpy_obj){for(var i=0;i<bpy_obj["particle_systems"].length;i++){var psettings=bpy_obj["particle_systems"][i]["settings"];if(psettings["type"]=="HAIR"&&psettings["b4w_dynamic_grass"])return true}return false};exports.init_particles_data=function(batch,psystem,pmaterial){var pdata=batch.particles_data=create_particles_data(psystem["name"],psystem["settings"]["type"]);pdata.frame_start=psystem["settings"]["frame_start"];
pdata.frame_end=psystem["settings"]["frame_end"];pdata.time_length=(pdata.frame_end-pdata.frame_start)/m_time.get_framerate();pdata.lifetime_frames=psystem["settings"]["lifetime"];pdata.lifetime=pdata.lifetime_frames/m_time.get_framerate();pdata.cyclic=psystem["settings"]["b4w_cyclic"]?1:0;pdata.mass=psystem["settings"]["mass"];pdata.nfactor=psystem["settings"]["normal_factor"];pdata.gravity=psystem["settings"]["effector_weights"]["gravity"]*STDGRAVITY;pdata.fade_in=psystem["settings"]["b4w_fade_in"]/
m_time.get_framerate();pdata.fade_out=psystem["settings"]["b4w_fade_out"]/m_time.get_framerate();pdata.wind_factor=psystem["settings"]["effector_weights"]["wind"];pdata.use_world_space=psystem["settings"]["b4w_coordinate_system"]=="WORLD"?true:false;var size;var alpha_start;var alpha_end;if(batch.halo_particles){size=pmaterial["halo"]["size"];var hardness=pmaterial["halo"]["hardness"];if(hardness<30){var alpha_start=.5;var alpha_end=.9}else if(hardness<40){var alpha_start=.1;var alpha_end=1}else if(hardness<
50){var alpha_start=0;var alpha_end=.8}else{var alpha_start=0;var alpha_end=.5}}else{size=psystem["settings"]["particle_size"];alpha_start=1;alpha_end=1}pdata.size=size;pdata.alpha_start=alpha_start;pdata.alpha_end=alpha_end;if(pmaterial["use_nodes"]&&psystem["settings"]["render_type"]=="BILLBOARD"){m_batch.set_batch_directive(batch,"NODES",1);m_batch.set_batch_directive(batch,"PARTICLE_BATCH",1);batch.use_nodes=true;batch.has_nodes=true}var tex_slot=psystem["settings"]["texture_slots"];if(tex_slot[0]&&
tex_slot[0]["use_map_size"]&&tex_slot[0]["texture"]&&tex_slot[0]["texture"]["type"]=="BLEND"&&tex_slot[0]["texture"]["use_color_ramp"]&&cfg_def.allow_vertex_textures){var image_data=[];m_tex.calc_color_ramp_data(tex_slot[0]["texture"]["color_ramp"],m_tex.PART_COLORRAMP_TEXT_SIZE,image_data);image_data=new Uint8Array(image_data.map(function(val){return m_util.clamp(val*255,0,255)}));m_batch.append_texture_to_batch(batch,image_data,"u_color_ramp_tex",m_tex.PART_COLORRAMP_TEXT_SIZE);m_batch.set_batch_directive(batch,
"USE_COLOR_RAMP",1)}var m_tex_slot=pmaterial["texture_slots"];var cramp_varr=[-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0];if(m_tex_slot[0]&&m_tex_slot[0]["texture_coords"]=="STRAND"&&m_tex_slot[0]["texture"]&&m_tex_slot[0]["texture"]["type"]=="BLEND"&&m_tex_slot[0]["texture"]["use_color_ramp"]){var color_ramp_elems=m_tex_slot[0]["texture"]["color_ramp"]["elements"];var rlen=Math.min(color_ramp_elems.length*4,cramp_varr.length);for(var i=0;i<rlen;i+=4){var rel=color_ramp_elems[i/4];cramp_varr[i]=rel["position"];
cramp_varr[i+1]=rel["color"][0];cramp_varr[i+2]=rel["color"][1];cramp_varr[i+3]=rel["color"][2]}pdata.color_ramp_length=color_ramp_elems.length}pdata.color_ramp.set(cramp_varr)};exports.generate_emitter_particles_submesh=function(batch,emitter_mesh,psystem,render){var pdata=batch.particles_data;var tsr=render.world_tsr;var pcount=psystem["settings"]["count"];var time_start=psystem["settings"]["frame_start"]/m_time.get_framerate();var time_end=psystem["settings"]["frame_end"]/m_time.get_framerate();
var lifetime=psystem["settings"]["lifetime"]/m_time.get_framerate();var lifetime_random=psystem["settings"]["lifetime_random"];var emit_from=psystem["settings"]["emit_from"];var vel_factor_rand=psystem["settings"]["factor_random"];var ang_vel_mode=psystem["settings"]["angular_velocity_mode"];var ang_vel_factor=psystem["settings"]["angular_velocity_factor"];var is_rand_delay=psystem["settings"]["b4w_randomize_emission"];var cyclic=psystem["settings"]["b4w_cyclic"];pdata.tilt=psystem["settings"]["billboard_tilt"];
pdata.tilt_rand=psystem["settings"]["billboard_tilt_random"];init_particle_rand(psystem["seed"]);var emitter_submesh=m_geom.extract_submesh_all_mats(emitter_mesh,["a_position","a_normal"],null,render);var pos_norm=distribute_positions_normals(pcount,emit_from,emitter_submesh);var positions=pos_norm[0];var normals=pos_norm[1];pdata.positions=new Float32Array(positions);pdata.normals=new Float32Array(normals);pdata.positions_cache=new Float32Array(positions.length);pdata.normals_cache=new Float32Array(normals.length);
var delay_attrs=gen_delay_attrs(pcount,time_start,time_end,is_rand_delay,cyclic);pdata.delay_attrs=new Float32Array(delay_attrs);pdata.delay_attrs_masked=new Float32Array(delay_attrs);if(pdata.use_world_space){pdata.emitter_tsr_snapshots=new Float32Array(delay_attrs.length*8);for(var i=0;i<delay_attrs.length*8;i++)for(var j=0;j<8;j++)pdata.emitter_tsr_snapshots[8*i+j]=tsr[j];pose_emitter_world(pdata,positions,normals,tsr,positions,normals)}var submesh=m_util.create_empty_submesh("EMITTER_PARTICLES");
var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=positions;va_frame["a_normal"]=normals;submesh.va_frames[0]=va_frame;batch.draw_mode=m_geom.DM_DYNAMIC_TRIANGLES;submesh.indices=gen_bb_indices(pcount);submesh.va_common["a_p_bb_vertex"]=gen_bb_vertices(pcount);submesh.base_length=positions.length/3;var larr=gen_lifetimes(pcount,lifetime,lifetime_random);submesh.va_common["a_p_data"]=gen_part_data(pcount,larr,delay_attrs);submesh.va_common["a_p_vels"]=gen_velocities(pcount,vel_factor_rand,
ang_vel_mode,ang_vel_factor);pdata.p_data=new Float32Array(submesh.va_common["a_p_data"]);return submesh};function pose_emitter_world(pdata,positions,normals,tsr,positions_new,normals_new){var delay_attrs=pdata.delay_attrs;var em_snapshots=pdata.emitter_tsr_snapshots;var time=pdata.time;var prev_time=pdata.prev_time;var step=4;for(var j=0;j<delay_attrs.length;j+=step){var delay=delay_attrs[j];var need_emitter_pos=time>prev_time&&time>=delay&&delay>prev_time||time<prev_time&&(delay>prev_time||time>=
delay);if(need_emitter_pos)for(var k=0;k<8;k++){em_snapshots[8*j+k]=tsr[k];_tsr_tmp[k]=tsr[k]}else for(var k=0;k<8;k++)_tsr_tmp[k]=em_snapshots[8*j+k];var pos=_vec3_tmp;pos[0]=positions[3*j];pos[1]=positions[3*j+1];pos[2]=positions[3*j+2];m_tsr.transform_vec3(pos,_tsr_tmp,pos);positions_new[3*j]=pos[0];positions_new[3*j+1]=pos[1];positions_new[3*j+2]=pos[2];var norm=_vec3_tmp;norm[0]=normals[3*j];norm[1]=normals[3*j+1];norm[2]=normals[3*j+2];m_tsr.transform_dir_vec3(norm,_tsr_tmp,norm);normals_new[3*
j]=norm[0];normals_new[3*j+1]=norm[1];normals_new[3*j+2]=norm[2];for(var k=1;k<4;k++){positions_new[3*(j+k)]=positions_new[3*j];positions_new[3*(j+k)+1]=positions_new[3*j+1];positions_new[3*(j+k)+2]=positions_new[3*j+2];normals_new[3*(j+k)]=norm[0];normals_new[3*(j+k)+1]=norm[1];normals_new[3*(j+k)+2]=norm[2]}}}function update_emitter_transform(obj,batches){for(var i=0;i<batches.length;i++){var batch=batches[i];var pdata=batch.particles_data;if(!pdata||!pdata.use_world_space||batch.forked_batch)continue;
var pcache=pdata.positions_cache;var ncache=pdata.normals_cache;var positions=pdata.positions;var normals=pdata.normals;pose_emitter_world(pdata,positions,normals,obj.render.world_tsr,pcache,ncache);pdata.need_buffers_update=true}}function init_particle_rand(seed){if(seed){m_util.srand(seed);_rand=function(){return m_util.rand()}}else _rand=function(){return Math.random()}}function gen_bb_vertices(pcount){var bbv=[];for(var i=0;i<pcount;i++)bbv.push(-.5,-.5,-.5,.5,.5,.5,.5,-.5);var bb_vertices=new Float32Array(bbv);
return bb_vertices}function gen_bb_indices(pcount){var bbi=[];for(var i=0;i<pcount;i++)bbi.push(4*i,4*i+2,4*i+1,4*i,4*i+3,4*i+2);var bb_indices=new Uint16Array(bbi);return bb_indices}function distribute_positions_normals(pcount,emit_from,emitter_submesh){switch(emit_from){case "VERT":var ecoords=emitter_submesh.va_frames[0]["a_position"];var encoords=emitter_submesh.va_frames[0]["a_normal"];var pindices=gen_pindices(pcount,ecoords);var positions=gen_positions(pindices,ecoords);var normals=gen_normals(pindices,
encoords);break;case "FACE":var positions=[];var normals=[];var seed=[];m_util.init_rand_r_seed(0,seed);var rand_pos=m_geom.geometry_random_points(emitter_submesh,pcount,false,seed);m_util.init_rand_r_seed(0,seed);var rand_norm=m_geom.geometry_random_points(emitter_submesh,pcount,true,seed);for(var i=0;i<rand_pos.length;i++){positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);
positions.push(rand_pos[i][0],rand_pos[i][1],rand_pos[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2]);normals.push(rand_norm[i][0],rand_norm[i][1],rand_norm[i][2])}var positions=new Float32Array(positions);var normals=new Float32Array(normals);break;case "VOLUME":throw"Particle emission from volume is not supported";break;default:throw"Wrong emit from option";
break}return[positions,normals]}function gen_pindices(pcount,ecoords){var vcount=ecoords.length/3;var indices=[];for(var i=0;i<pcount;i++){var vrand=Math.round((vcount-1)*_rand());indices.push(vrand);indices.push(vrand);indices.push(vrand);indices.push(vrand)}return indices}function gen_positions(indices,ecoords){var parr=[];for(var i=0;i<indices.length;i++){parr.push(ecoords[3*indices[i]]);parr.push(ecoords[3*indices[i]+1]);parr.push(ecoords[3*indices[i]+2])}var positions=new Float32Array(parr);
return positions}function gen_normals(indices,encoords){var narr=[];for(var i=0;i<indices.length;i++){narr.push(encoords[3*indices[i]]);narr.push(encoords[3*indices[i]+1]);narr.push(encoords[3*indices[i]+2])}var normals=new Float32Array(narr);return normals}function gen_delay_attrs(pcount,mindelay,maxdelay,random,cyclic){var darr=[];var delayint=(maxdelay-mindelay)/pcount;for(var i=0;i<pcount;i++){var delay;if(random)delay=delayint*i+DELAYRANDFACTOR*delayint*(.5-_rand());else delay=delayint*i;if(!cyclic)delay+=
mindelay;darr.push(delay);darr.push(delay);darr.push(delay);darr.push(delay)}var delay_attrs=new Float32Array(darr);return delay_attrs}function gen_lifetimes(pcount,lifetime,lifetime_random){var larr=[];var delta=lifetime*lifetime_random;for(var i=0;i<pcount;i++){var delta_rand=delta*_rand();larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand);larr.push(lifetime-delta_rand)}return larr}function gen_part_data(pcount,lifetimes,delay_attrs){var data=[];for(var i=
0;i<pcount;i++){var random=Math.random();data.push(lifetimes[i*4],delay_attrs[i*4],random);data.push(lifetimes[i*4+1],delay_attrs[i*4+1],random);data.push(lifetimes[i*4+2],delay_attrs[i*4+2],random);data.push(lifetimes[i*4+3],delay_attrs[i*4+3],random)}return new Float32Array(data)}function gen_velocities(pcount,vel_factor_rand,ang_vel_mode,ang_vel_factor){var varr=[];for(var i=0;i<pcount;i++){var vvec=[_rand()-.5,_rand()-.5,_rand()-.5];m_vec3.normalize(vvec,vvec);varr.push(vel_factor_rand*vvec[0]);
varr.push(vel_factor_rand*vvec[1]);varr.push(vel_factor_rand*vvec[2]);switch(ang_vel_mode){case "NONE":varr.push(0);break;case "SPIN":case "VELOCITY":varr.push(ang_vel_factor);break;case "RAND":varr.push(ang_vel_factor*2*(_rand()-.5));break;default:throw"Undefined velocity factor";}var last=varr.slice(-4);for(var j=0;j<12;j++)varr.push(last[j%4])}var vels=new Float32Array(varr);return vels}exports.set_time=function(obj,psys_name,time){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=
scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name||batches[j].forked_batch)continue;pdata.prev_time=pdata.time;pdata.time=time}}};exports.prepare_lens_flares=function(submesh){var base_length=submesh.base_length;var sub_pos=submesh.va_frames[0]["a_position"];var sub_tco=submesh.va_common["a_texcoord"];var bb_dist_arr=[];var bb_vert_arr=[];for(var i=0;i<base_length;i++){bb_vert_arr.push(sub_pos[3*i]);bb_vert_arr.push(sub_pos[3*
i+1]);bb_dist_arr.push(sub_pos[3*i+2])}var bb_dist_arr=new Float32Array(bb_dist_arr);var bb_vert_arr=new Float32Array(bb_vert_arr);submesh.va_common["a_lf_dist"]=bb_dist_arr;submesh.va_common["a_lf_bb_vertex"]=bb_vert_arr;submesh.va_common["a_texcoord"]=sub_tco;return submesh};exports.set_size=function(obj,psys_name,size){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||
pdata.name!=psys_name)continue;pdata.size=size}}};exports.set_normal_factor=function(obj,psys_name,nfactor){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name)continue;pdata.nfactor=nfactor}}};exports.set_factor=function(obj,psys_name,factor){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;
for(var j=0;j<batches.length;j++){var batch=batches[j];var pdata=batch.particles_data;if(!pdata||pdata.name!=psys_name)continue;var delay_attrs=pdata.delay_attrs;if(factor==1)var delay_attrs_masked=delay_attrs;else if(factor==0){var inc=4;var delay_attrs_masked=pdata.delay_attrs_masked;for(var k=0;k<delay_attrs_masked.length;k+=inc){delay_attrs_masked[k]=1E4;delay_attrs_masked[k+1]=delay_attrs_masked[k];delay_attrs_masked[k+2]=delay_attrs_masked[k];delay_attrs_masked[k+3]=delay_attrs_masked[k]}}else{var step=
4/factor;var delay_attrs_masked=pdata.delay_attrs_masked;var ind=0;for(var k=0;k<delay_attrs_masked.length;k+=4){if(k>=ind){delay_attrs_masked[k]=delay_attrs[k];ind+=step}else delay_attrs_masked[k]=1E4;delay_attrs_masked[k+1]=delay_attrs_masked[k];delay_attrs_masked[k+2]=delay_attrs_masked[k];delay_attrs_masked[k+3]=delay_attrs_masked[k]}}var pbuf=batch.bufs_data;var pointers=pbuf.pointers;var pointer=pointers["a_p_data"];if(pointer){var vbo_array=pbuf.vbo_array;var end=3*delay_attrs_masked.length;
var p_data=pdata.p_data;for(var k=0;k<p_data.length;k=k+3)p_data[k+1]=delay_attrs_masked[Math.round(k/3)];m_geom.update_bufs_data_array(pbuf,"a_p_data",3,p_data)}}}};exports.update_start_pos=function(obj,trans,quats){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||!pdata.use_world_space)continue;for(var k=0;k<pdata.delay_attrs.length*8;k++){pdata.emitter_tsr_snapshots[8*
k]=trans[0];pdata.emitter_tsr_snapshots[8*k+1]=trans[1];pdata.emitter_tsr_snapshots[8*k+2]=trans[2];pdata.emitter_tsr_snapshots[8*k+3]=trans[3];pdata.emitter_tsr_snapshots[8*k+4]=quats[0];pdata.emitter_tsr_snapshots[8*k+5]=quats[1];pdata.emitter_tsr_snapshots[8*k+6]=quats[2];pdata.emitter_tsr_snapshots[8*k+7]=quats[3]}}}};exports.update_particles_submesh=function(submesh,batch,pcount,material){if(batch.part_use_tangent){var data=[];for(var i=0;i<pcount;i++)data.push(1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,
1);submesh.va_common["a_tangent"]=new Float32Array(data)}if(batch.part_node_data){var data=[];for(var i=0;i<pcount;i++)data.push(i,i,i,i);submesh.va_common[batch.part_node_data.name]=new Float32Array(data)}};exports.update_particles_objs_cache=function(obj){if(_particles_objs_cache.indexOf(obj)==-1)_particles_objs_cache.push(obj)};exports.remove_obj_from_cache=function(obj){var ind=_particles_objs_cache.indexOf(obj);if(ind!=-1)_particles_objs_cache.splice(ind,1)};exports.cleanup=function(){_particles_objs_cache.length=
0}};b4w.module["__primitives"]=function(exports,require){var m_cfg=require("__config");var m_geom=require("__geometry");var m_print=require("__print");var m_util=require("__util");var cfg_def=m_cfg.defaults;exports.generate_line=function(){var submesh=m_util.create_empty_submesh("LINE");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(3);va_frame["a_direction"]=new Float32Array(3);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(1);submesh.base_length=1;
return submesh};exports.generate_plane=function(x_size,z_size){var grid_submesh=generate_grid(2,2,x_size,z_size);grid_submesh.name="PLANE";return grid_submesh};exports.generate_grid=generate_grid;function generate_grid(x_subdiv,z_subdiv,x_size,z_size){var indices=[];var positions=[];var normals=[];var texcoords=[];var delta_x=2*x_size/(x_subdiv-1);var delta_z=2*z_size/(z_subdiv-1);for(var i=0;i<x_subdiv;i++){var x=-x_size+i*delta_x;for(var j=0;j<z_subdiv;j++){var z=-z_size+j*delta_z;positions.push(x,
0,z);normals.push(0,1,0);texcoords.push(i/(x_subdiv-1),j/(z_subdiv-1));if(i&&j){var idx0=i*z_subdiv+j;var idx1=idx0-1;var idx2=(i-1)*z_subdiv+j;var idx3=idx2-1;indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,idx2)}}}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);va_frame["a_normal"]=new Float32Array(normals);var submesh=m_util.create_empty_submesh("GRID_PLANE");submesh.va_frames[0]=va_frame;submesh.va_common["a_texcoord"]=new Float32Array(texcoords);
submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh}exports.generate_multigrid=function(num_cascads,subdivs,detailed_dist){var min_casc_size=detailed_dist/Math.pow(2,num_cascads-1);var x_size=min_casc_size;var z_size=min_casc_size;var x_subdiv=subdivs+1;var z_subdiv=subdivs+1;var indices=[];var positions=[];var tangents=[];var normals=[];var prev_x=0;var prev_z=0;var last_added_ind=-1;function is_merged_vertex(i,j){if(i%2==1&&(j==0||j==z_subdiv-1)||j%2==
1&&(i==0||i==x_subdiv-1))return true;else return false}var prev_utmost_verts=[];for(var c=0;c<num_cascads;c++){var delta_x=2*x_size/(x_subdiv-1);var delta_z=2*z_size/(z_subdiv-1);var cur_utmost_verts=[];var casc_indices=[];var all_skipped=0;for(var i=0;i<x_subdiv;i++){var x=-x_size+i*delta_x;var indices_in_row=[];for(var j=0;j<z_subdiv;j++){var z=-z_size+j*delta_z;if(!(x>-prev_x&&x<prev_x&&z>-prev_z&&z<prev_z)){var coinciding_ind=null;for(var k=0;k<prev_utmost_verts.length;k+=3)if(x==prev_utmost_verts[k]&&
z==prev_utmost_verts[k+1]){coinciding_ind=prev_utmost_verts[k+2];break}if(coinciding_ind!==null)var idx0=coinciding_ind;else var idx0=last_added_ind+1;if(!is_merged_vertex(i,j)){if(coinciding_ind==null){if(j==0||j==z_subdiv-1||i==0||i==x_subdiv-1){if(c==num_cascads-1)var cascad_step=delta_x;else var cascad_step=2*delta_x;cur_utmost_verts.push(x,z,idx0)}else var cascad_step=delta_x;positions.push(x,cascad_step,z);normals.push(0,1,0);tangents.push(1,0,0);last_added_ind++}indices_in_row.push(idx0)}else{indices_in_row.push(-2);
all_skipped++}if(i&&j)if(i==1)if(is_merged_vertex(i-1,j))if(j>1){var idx1=idx0-1;var idx2=casc_indices[i-1][j+1];var idx3=idx2-1;indices.push(idx0,idx1,idx3);indices.push(idx0,idx3,idx2)}else{var idx2=casc_indices[i-1][j+1];var idx3=idx2-1;indices.push(idx0,idx3,idx2)}else{if(!is_merged_vertex(i,j)){var idx1=idx0-1;var idx2=casc_indices[i-1][j];indices.push(idx0,idx1,idx2)}}else if(i==x_subdiv-1){if(!is_merged_vertex(i,j))if(j==z_subdiv-1){var idx1=idx0-1;var idx2=casc_indices[i-1][j-1];var idx3=
casc_indices[i-2][j];indices.push(idx0,idx1,idx2);indices.push(idx0,idx2,idx3)}else{var idx1=idx0-1;var idx2=casc_indices[i-1][j];var idx3=idx2-1;var idx4=idx2+1;indices.push(idx0,idx1,idx3);indices.push(idx0,idx3,idx2);indices.push(idx0,idx2,idx4);if(j==2){idx4=casc_indices[i-2][j-2];indices.push(idx1,idx4,idx3)}}}else if(j==1)if(!is_merged_vertex(i,j-1)){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j];var idx3=casc_indices[i-2][j-1];indices.push(idx0,idx1,idx2);indices.push(idx1,idx3,
idx2)}else{var idx1=casc_indices[i-1][j];var idx2=casc_indices[i-1][j-1];indices.push(idx0,idx2,idx1)}else if(j==z_subdiv-1){if(!is_merged_vertex(i,j)){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j-1];var idx3=casc_indices[i-2][j];indices.push(idx0,idx1,idx2);indices.push(idx0,idx2,idx3)}}else if(casc_indices[i-1][j]!=-1&&casc_indices[i-1][j-1]!=-1&&indices_in_row[j-1]!=-1){var idx1=indices_in_row[j-1];var idx2=casc_indices[i-1][j];var idx3=casc_indices[i-1][j-1];indices.push(idx0,idx1,
idx2);indices.push(idx1,idx3,idx2);if(j==z_subdiv-2&&is_merged_vertex(i,j+1)){var idx4=casc_indices[i-1][j+1];indices.push(idx0,idx2,idx4)}}else if(j==z_subdiv-2&&is_merged_vertex(i,j+1)){var idx2=casc_indices[i-1][j];var idx4=casc_indices[i-1][j+1];indices.push(idx0,idx2,idx4)}}else{indices_in_row.push(-1);all_skipped++}}casc_indices.push(indices_in_row)}prev_utmost_verts=cur_utmost_verts;prev_x=x_size;prev_z=z_size;x_size*=2;z_size*=2}var required_mesh_size=2E4;if(prev_x<required_mesh_size){var casc_step=
-(2*prev_x)/(x_subdiv-1);positions.push(-required_mesh_size,casc_step,-required_mesh_size);positions.push(-required_mesh_size,casc_step,required_mesh_size);positions.push(-prev_x,casc_step,-prev_z);positions.push(-prev_x,casc_step,prev_z);positions.push(required_mesh_size,casc_step,-required_mesh_size);positions.push(required_mesh_size,casc_step,required_mesh_size);positions.push(prev_x,casc_step,-prev_z);positions.push(prev_x,casc_step,prev_z);var idx0=last_added_ind+1;indices.push(idx0+3,idx0+2,
idx0+1,idx0+2,idx0+0,idx0+1,idx0+6,idx0+4,idx0+2,idx0+4,idx0+0,idx0+2,idx0+5,idx0+7,idx0+1,idx0+7,idx0+3,idx0+1,idx0+5,idx0+4,idx0+7,idx0+7,idx0+4,idx0+6);for(var i=0;i<8;i++){normals.push(0,1,0);tangents.push(1,0,0)}}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);va_frame["a_tangent"]=new Float32Array(tangents);va_frame["a_normal"]=new Float32Array(normals);var submesh=m_util.create_empty_submesh("multigrid_plane");submesh.va_frames[0]=va_frame;submesh.indices=
new Uint32Array(indices);submesh.base_length=positions.length/3;if(cfg_def.water_wireframe_debug){m_geom.submesh_drop_indices(submesh,1,true);va_frame["a_polyindex"]=m_geom.extract_polyindices(submesh)}return submesh};exports.generate_from_triangles=function(verts){var len=verts.length;if(len%3)throw"Wrong array";var indices=[];var positions=[];for(var i=0;i<len;i+=3){var v1=verts[i];var v2=verts[i+1];var v3=verts[i+2];add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,
positions);indices.push(i,i+1,i+2)}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=m_util.create_empty_submesh("FROM_TRIANGLES");submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh};exports.generate_from_quads=generate_from_quads;function generate_from_quads(verts){var len=verts.length;if(len%4)throw"Wrong array";var indices=[];var positions=[];for(var i=0;i<len;i+=4){var v1=
verts[i];var v2=verts[i+1];var v3=verts[i+2];var v4=verts[i+3];add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);indices.push(i,i+1,i+2);indices.push(i,i+2,i+3)}var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array(positions);var submesh=m_util.create_empty_submesh("FROM_QUADS");submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array(indices);submesh.base_length=positions.length/3;return submesh}
exports.generate_frustum=function(corners){var corners=m_util.vectorize(corners,[]);var quads=[];quads.push(corners[0],corners[1],corners[2],corners[3]);quads.push(corners[0],corners[3],corners[5],corners[4]);quads.push(corners[3],corners[2],corners[6],corners[5]);quads.push(corners[1],corners[7],corners[6],corners[2]);quads.push(corners[0],corners[4],corners[7],corners[1]);quads.push(corners[4],corners[5],corners[6],corners[7]);var submesh=generate_from_quads(quads);submesh.name="FRUSTUM";return submesh};
exports.generate_fullscreen_tri=function(){var submesh=m_util.create_empty_submesh("FULLSCREEN_TRI");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([0,0,1,0,0,1]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,1,2]);submesh.base_length=3;return submesh};exports.generate_fullscreen_quad=function(){var submesh=m_util.create_empty_submesh("FULLSCREEN_QUAD");var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([-1,1,
1,1,-1,-1,1,-1]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,1,2,3]);submesh.base_length=4;return submesh};exports.generate_billboard=function(){var submesh=m_util.create_empty_submesh("BILLBOARD");var va_frame=m_util.create_empty_va_frame();va_frame["a_bb_vertex"]=new Float32Array([-.5,-.5,-.5,.5,.5,.5,.5,-.5]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,0,3,2]);submesh.base_length=4;return submesh};exports.generate_cube=function(){var submesh=m_util.create_empty_submesh("CUBEMAP_BOARD");
var va_frame=m_util.create_empty_va_frame();va_frame["a_position"]=new Float32Array([-1,-1,-1,1,1,1,1,-1]);submesh.va_frames[0]=va_frame;submesh.indices=new Uint32Array([0,2,1,0,3,2]);submesh.base_length=4;return submesh};exports.generate_uv_sphere=function(segments,rings,size,center,use_smooth,use_wireframe){var submesh=m_util.create_empty_submesh("UV_SPHERE");var x,y;var positions=[];var grid_positions=[];var indices=[];for(y=0;y<=rings;y++)for(x=0;x<=segments;x++){var u=x/segments;var v=y/rings;
var xpos=-size*Math.cos(u*2*Math.PI)*Math.sin(v*Math.PI);var ypos=size*Math.cos(v*Math.PI);var zpos=size*Math.sin(u*2*Math.PI)*Math.sin(v*Math.PI);if(use_smooth){var edge=1E-5;xpos=Math.abs(xpos)<edge?0:xpos;ypos=Math.abs(ypos)<edge?0:ypos;zpos=Math.abs(zpos)<edge?0:zpos}grid_positions.push(xpos+center[0],ypos+center[1],zpos+center[2])}var v_index=0;for(y=0;y<rings;y++)for(x=0;x<segments;x++){var v1=extract_vec3(grid_positions,(segments+1)*y+x+1);var v2=extract_vec3(grid_positions,(segments+1)*y+
x);var v3=extract_vec3(grid_positions,(segments+1)*(y+1)+x);var v4=extract_vec3(grid_positions,(segments+1)*(y+1)+x+1);if(Math.abs(v1[1])==size+center[1]){add_vec3_to_array(v1,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);if(use_wireframe)indices.push(v_index,v_index+1,v_index+1,v_index+2,v_index+2,v_index);else indices.push(v_index,v_index+1,v_index+2);v_index+=3}else if(Math.abs(v3[1])==size+center[1]){add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);
add_vec3_to_array(v3,positions);if(use_wireframe)indices.push(v_index,v_index+1,v_index+1,v_index+2,v_index+2,v_index);else indices.push(v_index,v_index+1,v_index+2);v_index+=3}else{add_vec3_to_array(v1,positions);add_vec3_to_array(v2,positions);add_vec3_to_array(v3,positions);add_vec3_to_array(v4,positions);if(use_wireframe){indices.push(v_index,v_index+1);indices.push(v_index+1,v_index+2);indices.push(v_index+2,v_index+3);indices.push(v_index+3,v_index)}else{indices.push(v_index,v_index+1,v_index+
2);indices.push(v_index,v_index+2,v_index+3)}v_index+=4}}var va_frame={};va_frame["a_position"]=positions;if(use_wireframe)va_frame["a_normal"]=[];else{var shared_indices=m_geom.calc_shared_indices(indices,grid_positions,positions);va_frame["a_normal"]=m_geom.calc_normals(indices,positions,shared_indices)}va_frame["a_tangent"]=[];submesh.va_common["a_influence"]=[];submesh.va_common["a_color"]=[];submesh.va_common["a_texcoord"]=[];submesh.va_frames[0]=va_frame;submesh.indices=indices;submesh.base_length=
positions.length/3;return submesh};function extract_vec3(array,position){var offset=position*3;var x=array[offset];var y=array[offset+1];var z=array[offset+2];return[x,y,z]}function add_vec3_to_array(vec,array){array.push(vec[0],vec[1],vec[2])}exports.generate_index=function(num){var submesh=m_util.create_empty_submesh("INDEX");var va_frame=m_util.create_empty_va_frame();va_frame["a_index"]=new Float32Array(num);for(var i=0;i<num;i++)va_frame["a_index"][i]=i;submesh.va_frames[0]=va_frame;submesh.indices=
new Uint16Array(0);submesh.base_length=num;return submesh}};b4w.module["__prerender"]=function(exports,require){var m_cfg=require("__config");var m_debug=require("__debug");var m_geom=require("__geometry");var m_render=require("__renderer");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_def=m_cfg.defaults;var USE_FRUSTUM_CULLING=true;var SUBS_UPDATE_DO_RENDER=["MAIN_OPAQUE","MAIN_BLEND","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT_BLEND","MAIN_GLOW","SHADOW_CAST","SHADOW_RECEIVE",
"OUTLINE_MASK","DEBUG_VIEW","COLOR_PICKING","MAIN_XRAY","COLOR_PICKING_XRAY"];var _vec3_tmp=new Float32Array(3);exports.prerender_subs=function(subs){if(SUBS_UPDATE_DO_RENDER.indexOf(subs.type)>-1){var has_render_bundles=false;var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];var batch=bundle.batch;if(subs.type=="MAIN_CUBE_REFLECT"||subs.type=="MAIN_CUBE_REFLECT_BLEND")for(var j=0;j<6;j++){subs.camera.frustum_planes=subs.cube_cam_frustums[j];bundle.do_render_cube[j]=
prerender_bundle(bundle,subs);if(bundle.do_render_cube[j]){has_render_bundles=true;update_particles_buffers(batch)}}else{bundle.do_render=prerender_bundle(bundle,subs);if(bundle.do_render){has_render_bundles=true;update_particles_buffers(batch)}}if(subs.need_perm_uniforms_update)batch.shader.need_uniforms_update=true}subs.need_perm_uniforms_update=false;switch(subs.type){case "DEBUG_VIEW":break;default:if(subs.type==="MAIN_OPAQUE"||subs.type==="SHADOW_RECEIVE"||subs.type==="MAIN_GLOW"||subs.type===
"MAIN_PLANE_REFLECT"||subs.type==="MAIN_CUBE_REFLECT"||has_render_bundles)subs.do_render=true;else{if(subs.do_render)m_render.clear(subs);subs.do_render=false}break}}else if(subs.need_perm_uniforms_update){var bundles=subs.bundles;for(var i=0;i<bundles.length;i++)if(subs.need_perm_uniforms_update)bundles[i].batch.shader.need_uniforms_update=true;subs.need_perm_uniforms_update=false}if(subs.type=="MAIN_BLEND")zsort(subs)};function zsort(subs){if(!cfg_def.alpha_sort||!subs.bundles)return;var eye=m_tsr.get_trans_value(subs.camera.world_tsr,
_vec3_tmp);for(var i=0;i<subs.bundles.length;i++){var bundle=subs.bundles[i];if(!bundle.do_render)continue;var obj_render=bundle.obj_render;var batch=bundle.batch;if(batch&&batch.z_sort){var bufs_data=batch.bufs_data;if(!bufs_data)continue;var info=bufs_data.info_for_z_sort_updates;var cam_shift=m_vec3.dist(eye,info.zsort_eye_last);var shift_param=cfg_def.alpha_sort_threshold*Math.min(info.bb_min_side,1);var batch_cam_updated=cam_shift>shift_param;if(!batch_cam_updated&&!obj_render.force_zsort)continue;
m_geom.update_buffers_movable(bufs_data,obj_render.world_tsr,eye);m_vec3.copy(eye,info.zsort_eye_last)}obj_render.force_zsort=false}}function prerender_bundle(bundle,subs){var obj_render=bundle.obj_render;var batch=bundle.batch;obj_render.is_visible=false;if(obj_render.hide)return false;var cam=subs.camera;if(subs.type=="SHADOW_CAST")var eye=cam.lod_eye;else var eye=m_tsr.get_trans_value(cam.world_tsr,_vec3_tmp);if(!is_lod_visible(obj_render,eye))return false;obj_render.is_visible=true;if(subs.type==
"OUTLINE_MASK"&&!Boolean(obj_render.outline_intensity))return false;if(USE_FRUSTUM_CULLING&&is_out_of_frustum(obj_render,cam.frustum_planes,batch))return false;if(subs.type=="DEBUG_VIEW")if(bundle.batch.debug_view_mode==m_debug.DV_DEBUG_SPHERES)return bundle.batch.debug_sphere;else return!bundle.batch.debug_sphere;return true}function is_out_of_frustum(obj_render,planes,batch){if(obj_render.do_not_cull)return false;var be=batch.be_world;var pt=be.center;var axis_x=be.axis_x;var axis_y=be.axis_y;var axis_z=
be.axis_z;var is_out=m_util.ellipsoid_is_out_of_frustum(pt,planes,axis_x,axis_y,axis_z);return is_out}function is_lod_visible(obj_render,eye){var center=obj_render.bs_world.center;var dist_min=obj_render.lod_dist_min;var dist_max=obj_render.lod_dist_max;var dist=Math.sqrt((center[0]-eye[0])*(center[0]-eye[0])+(center[1]-eye[1])*(center[1]-eye[1])+(center[2]-eye[2])*(center[2]-eye[2]));var tr_int=obj_render.lod_transition_ratio*obj_render.bs_world.radius;if(dist>=dist_min&&dist<dist_max+tr_int)return true;
else return false}function update_particles_buffers(batch){var pdata=batch.particles_data;if(!(pdata&&pdata.need_buffers_update))return;var pbuf=batch.bufs_data;m_geom.make_dynamic(pbuf);var vbo_array=pbuf.vbo_array;var pointers=pbuf.pointers;var pos_pointer=pointers["a_position"];var norm_pointer=pointers["a_normal"];vbo_array.set(pdata.positions_cache,pos_pointer.offset);vbo_array.set(pdata.normals_cache,norm_pointer.offset);m_geom.update_gl_buffers(pbuf)}};b4w.module["__print"]=function(exports,require){var _verbose=false;var _error_count=0;var _warning_count=0;var _deprecated_methods={};exports.set_verbose=function(v){_verbose=v};exports.log_raw=function(){console.log.apply(console,arguments)};exports.log=function(){if(_verbose){var args=compose_args_prefix(arguments,"B4W LOG");console.log.apply(console,args)}};function compose_args_prefix(args_in,prefix){var args_out=[];if(args_in[0].indexOf("%c")>-1)args_out.push(args_in[0].replace("%c","%c"+prefix+
": "));else args_out.push(prefix+": "+args_in[0]);for(var i=1;i<args_in.length;i++)args_out.push(args_in[i]);return args_out}exports.error=error;function error(){_error_count++;var args=compose_args_prefix(arguments,"B4W ERROR");console.error.apply(console,args)}exports.error_once=error_once;function error_once(message){if(!(message in _deprecated_methods)){_deprecated_methods[message]=message;error([message])}}exports.error_deprecated=error_deprecated;function error_deprecated(depr_func,new_func){error_once(depr_func+
"() is deprecated, use "+new_func+"() instead.")}exports.error_deprecated_arr=function(depr_func,new_func_arr){switch(new_func_arr.length>1){case true:error_once(depr_func+"() is deprecated, use "+new_func_arr.slice(0,-1).join("(), ")+"() or "+new_func_arr[new_func_arr.length-1]+"() instead.");break;case false:error_deprecated(depr_func,new_func_arr[0]);break}};exports.error_deprecated_cfg=function(depr_cfg,new_cfg){error_once('Config option "'+depr_cfg+'" is deprecated, use "'+new_cfg+'" instead.')};
exports.warn=function(){_warning_count++;var args=compose_args_prefix(arguments,"B4W WARN");console.warn.apply(console,args)};exports.info=function(){var args=compose_args_prefix(arguments,"B4W INFO");console.info.apply(console,args)};exports.export_error=function(){_error_count++;var args=compose_args_prefix(arguments,"B4W EXPORT ERROR");console.error.apply(console,args)};exports.export_warn=function(){_warning_count++;var args=compose_args_prefix(arguments,"B4W EXPORT WARNING");console.warn.apply(console,
args)};exports.time=function(){if(_verbose)console.time.apply(console,arguments)};exports.timeEnd=function(){if(_verbose)console.timeEnd.apply(console,arguments)};exports.group=function(){if(_verbose)console.group.apply(console,arguments)};exports.groupCollapsed=function(){if(_verbose)console.groupCollapsed.apply(console,arguments)};exports.groupEnd=function(){if(_verbose)console.groupEnd.apply(console,arguments)};exports.clear=function(){if(typeof console.clear=="function")console.clear.apply(console,
arguments)};exports.get_warning_count=function(){return _warning_count};exports.get_error_count=function(){return _error_count};exports.clear_errors_warnings=function(){_warning_count=0;_error_count=0}};b4w.module["print"]=b4w.module["__print"];b4w.module["__reformer"]=function(exports,require){var m_bounds=require("__boundings");var m_curve=require("__curve");var m_mat4=require("__mat4");var m_print=require("__print");var m_quat=require("__quat");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var m_logn=require("__logic_nodes");var REPORT_COMPATIBILITY_ISSUES=true;var REQUIRED_FOR_PART_SYS_BIN_FORMAT=[5,4];var _unreported_compat_issues=false;var _params_reported={};function reform_node(node){switch(node["type"]){case "VALTORGB":if(!node["color_ramp"]){node["color_ramp"]=
{"elements":[{"position":.5,"color":[1,1,1,1]}]};report("node Color Ramp",node,"color_ramp")}break;case "CURVE_RGB":if(!node["curve_mapping"]){node["curve_mapping"]={"curves_data":[[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]],"curves_handle_types":["EXTRAPOLATED","EXTRAPOLATED","EXTRAPOLATED","EXTRAPOLATED"],"curve_extend":[["AUTO","AUTO"],["AUTO","AUTO"],["AUTO","AUTO"],["AUTO","AUTO"]]};report("node RGB Curves",node,"curve_mapping")}break;case "CURVE_VEC":if(!node["curve_mapping"]){node["curve_mapping"]=
{"curves_data":[[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]],"curves_handle_types":["EXTRAPOLATED","EXTRAPOLATED","EXTRAPOLATED"],"curve_extend":[["AUTO","AUTO"],["AUTO","AUTO"],["AUTO","AUTO"]]};report("node Vector Curves",node,"curve_mapping")}break;case "MAPPING":if(!node["vector_type"]){node["vector_type"]="POINT";report("node Mapping",node,"vector_type")}break;case "MATERIAL":case "MATERIAL_EXT":if(!("alpha"in node)){node["alpha"]=1;report("node material",node,"alpha")}if(!("darkness"in node)){node["darkness"]=
1;report("node material",node,"darkness")}if(!("diffuse_toon_size"in node)){node["diffuse_toon_size"]=.5;report("node material",node,"diffuse_toon_size")}if(!("diffuse_toon_smooth"in node)){node["diffuse_toon_smooth"]=.1;report("node material",node,"diffuse_toon_smooth")}if(!("diffuse_intensity"in node)){node["diffuse_intensity"]=1;report("node material",node,"diffuse_intensity")}if(!("specular_shader"in node)){node["specular_shader"]="COOKTORR";report("node material",node,"specular_shader")}if(!("specular_ior"in
node)){node["specular_ior"]=4;report("node material",node,"specular_ior")}if(!("specular_hardness"in node)){node["specular_hardness"]=50;report("node material",node,"specular_hardness")}if(!("specular_slope"in node)){node["specular_slope"]=.1;report("node material",node,"specular_slope")}if(!("specular_toon_size"in node)){node["specular_toon_size"]=.5;report("node material",node,"specular_toon_size")}if(!("specular_toon_smooth"in node)){node["specular_toon_smooth"]=.1;report("node material",node,
"specular_toon_smooth")}if(!("specular_intensity"in node)){node["specular_intensity"]=.5;report("node material",node,"specular_intensity")}if(!("diffuse_shader"in node)){node["diffuse_shader"]="LAMBERT";report("node material",node,"diffuse_shader")}if(!("roughness"in node)){node["roughness"]=.5;report("node material",node,"roughness")}if(!("diffuse_fresnel"in node)){node["diffuse_fresnel"]=.1;report("node material",node,"diffuse_fresnel")}if(!("diffuse_fresnel_factor"in node)){node["diffuse_fresnel_factor"]=
.5;report("node material",node,"diffuse_fresnel_factor")}break;case "MATH":case "MIX_RGB":if(!("use_clamp"in node)){node["use_clamp"]=false;report("node "+node["type"],node,"use_clamp")}break;case "GROUP":node["node_tree_name"]=node["node_tree_name"].replace(/\.[0-9]{3,}$/g,"");switch(node["node_tree_name"]){case "CLAMP":case "LEVELS_OF_QUALITY":case "LINEAR_TO_SRGB":case "NORMAL_VIEW":case "PARALLAX":case "REFLECT":case "REFRACTION":case "REPLACE":case "SMOOTHSTEP":case "SRGB_TO_LINEAR":case "TIME":case "TRANSLUCENCY":case "VECTOR_VIEW":node["node_tree_name"]=
"B4W_"+node["node_tree_name"];break;default:break}break;case "VECT_TRANSFORM":if(!("convert_from"in node)){node["convert_from"]="WORLD";report("node "+node["type"],node,"convert_from")}if(!("convert_to"in node)){node["convert_to"]="WORLD";report("node "+node["type"],node,"convert_to")}if(!("vector_type"in node)){node["vector_type"]="POINT";report("node "+node["type"],node,"vector_type")}break}}exports.check_particles_bin_format=function(loaded_data_version){return m_util.version_cmp(loaded_data_version,
REQUIRED_FOR_PART_SYS_BIN_FORMAT)!=-1};exports.check_bpy_data=function(bpy_data){_params_reported={};var check_modifier=function(mod,bpy_obj){switch(mod["type"]){case "ARRAY":if(!("fit_type"in mod)){report_modifier(mod["type"],bpy_obj,bpy_data["b4w_filepath_blend"]);return false}break;default:break}return true};var worlds=bpy_data["worlds"];if(worlds.length==0){report_missing_datablock("world",bpy_data["b4w_filepath_blend"]);var world={"name":"DEFAULT","horizon_color":new Float32Array([0,0,0]),"zenith_color":new Float32Array([0,
0,0]),"light_settings":{"use_environment_light":false,"environment_energy":1,"environment_color":"PLAIN"},"fog_settings":{"use_fog":false,"intensity":0,"depth":25,"start":5,"height":0,"falloff":"INVERSE_QUADRATIC","use_custom_color":true,"color":[.5,.5,.5]},"use_sky_paper":false,"use_sky_blend":false,"use_sky_real":false,"texture_slots":[]};worlds.push(world)}var worlds=bpy_data["worlds"];for(var i=0;i<worlds.length;i++){var world=worlds[i];if(!("use_sky_blend"in world)){report("world",world,"use_sky_blend");
world["use_sky_blend"]=false}if(!("use_sky_paper"in world)){report("world",world,"use_sky_paper");world["use_sky_paper"]=false}if(!("use_sky_real"in world)){report("world",world,"use_sky_real");world["use_sky_real"]=false}if(!("b4w_sky_settings"in world)||!("rayleigh_brightness"in world["b4w_sky_settings"])){report("world",world,"rayleigh_brightness");world["b4w_sky_settings"]={"render_sky":false,"procedural_skydome":false,"use_as_enviroment_map":false,"color":[.24,.43,.75],"rayleigh_brightness":3.3,
"mie_brightness":.1,"spot_brightness":10,"scatter_strength":.2,"rayleigh_strength":.2,"mie_strength":.006,"rayleigh_collection_power":.5,"mie_collection_power":.5,"mie_distribution":.4}}if(!("fog_settings"in world)){report("world",world,"fog_settings");world["fog_settings"]={"use_fog":false,"intensity":0,"depth":25,"start":0,"height":0,"falloff":"QUADRATIC","use_custom_color":true,"color":[.5,.5,.5]};if("b4w_fog_color"in world){world["fog_settings"]["use_custom_color"]=true;world["fog_settings"]["color"]=
world["b4w_fog_color"]}if("b4w_fog_density"in world)if(world["b4w_fog_density"]>0)world["fog_settings"]["depth"]=1/world["b4w_fog_density"]}if(!("render_sky"in world["b4w_sky_settings"])){report("world",world,"render_sky");world["b4w_sky_settings"]["render_sky"]=false}var texture_slots=world["texture_slots"];for(var j=0;j<texture_slots.length;j++){var slot=texture_slots[j];if(!("blend_type"in slot)){slot["blend_type"]="MIX";report("world_texture_slot",slot,"blend_type")}if(!("use_map_blend"in slot)){slot["use_map_blend"]=
false;report("world_texture_slot",slot,"use_map_blend")}if(!("use_map_horizon"in slot)){slot["use_map_horizon"]=true;report("world_texture_slot",slot,"use_map_horizon")}if(!("use_map_zenith_up"in slot)){slot["use_map_zenith_up"]=false;report("world_texture_slot",slot,"use_map_zenith_up")}if(!("use_rgb_to_intensity"in slot)){slot["use_rgb_to_intensity"]=false;report("world_texture_slot",slot,"use_rgb_to_intensity")}if(!("invert"in slot)){slot["invert"]=false;report("world_texture_slot",slot,"invert")}if(!("color"in
slot)){slot["color"]=[1,0,1];report("world_texture_slot",slot,"color")}if(!("blend_factor"in slot)){slot["blend_factor"]=0;report("world_texture_slot",slot,"blend_factor")}if(!("horizon_factor"in slot)){slot["horizon_factor"]=1;report("world_texture_slot",slot,"horizon_factor")}if(!("zenith_up_factor"in slot)){slot["zenith_up_factor"]=0;report("world_texture_slot",slot,"zenith_up_factor")}if(!("zenith_down_factor"in slot)){slot["zenith_down_factor"]=0;report("world_texture_slot",slot,"zenith_down_factor")}if(!("default_value"in
slot)){slot["default_value"]=1;report("world_texture_slot",slot,"default_value")}}if(!("b4w_use_default_animation"in world)){report("world",world,"b4w_use_default_animation");world["b4w_use_default_animation"]=false}if(!("b4w_anim_behavior"in world)){report("world",world,"b4w_anim_behavior");world["b4w_anim_behavior"]="CYCLIC"}}var scenes=bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];var sc_world=scene["world"];if(!("timeline_markers"in scene)){scene["timeline_markers"]=
null;report("scene",scene,"timeline_markers")}if(!("b4w_reflection_quality"in scene)){scene["b4w_reflection_quality"]="MEDIUM";report("scene",scene,"b4w_reflection_quality")}if(!("b4w_use_nla"in scene)){scene["b4w_use_nla"]=false;report("scene",scene,"b4w_use_nla")}if(!("fps"in scene)){scene["fps"]=24;report("scene",scene,"fps")}if(!("b4w_nla_cyclic"in scene)){scene["b4w_nla_cyclic"]=false;report("scene",scene,"b4w_nla_cyclic")}if(!("b4w_logic_nodes"in scene)){scene["b4w_logic_nodes"]=[];report("scene",
scene,"b4w_logic_nodes")}if("b4w_detect_collisions"in scene){report_deprecated("scene",scene,"b4w_detect_collisions");delete scene["b4w_detect_collisions"]}if(!("audio_doppler_speed"in scene))scene["audio_doppler_speed"]=343.3;if(!("audio_doppler_factor"in scene))scene["audio_doppler_factor"]=1;if(!("b4w_dynamic_compressor_settings"in scene)){scene["b4w_dynamic_compressor_settings"]={"threshold":-24,"knee":30,"ratio":12,"attack":.003,"release":.25};report("scene",scene,"b4w_dynamic_compressor_settings")}if(!("b4w_enable_convolution_engine"in
scene))scene["b4w_enable_convolution_engine"]=false;if(!("b4w_enable_bloom"in scene)){scene["b4w_enable_bloom"]=false;report("scene",scene,"b4w_enable_bloom")}if(!("b4w_enable_motion_blur"in scene)){scene["b4w_enable_motion_blur"]=false;report("scene",scene,"b4w_enable_motion_blur")}if(!("b4w_enable_color_correction"in scene)){scene["b4w_enable_color_correction"]=false;report("scene",scene,"b4w_enable_color_correction")}if(!("b4w_antialiasing_quality"in scene)){scene["b4w_antialiasing_quality"]="MEDIUM";
report("scene",scene,"b4w_antialiasing_quality")}if(!("b4w_tags"in scene)){scene["b4w_tags"]={"title":"","description":""};report("scene",scene,"b4w_tags")}if(!("b4w_enable_object_selection"in scene)){scene["b4w_enable_object_selection"]="AUTO";report("scene",scene,"b4w_enable_object_selection")}if(!("b4w_enable_outlining"in scene)){scene["b4w_enable_outlining"]="AUTO";report("scene",scene,"b4w_enable_outlining")}if(!("b4w_enable_glow_materials"in scene)){scene["b4w_enable_glow_materials"]="AUTO";
report("scene",scene,"b4w_enable_glow_materials")}if(!("b4w_enable_anchors_visibility"in scene)){scene["b4w_enable_anchors_visibility"]="AUTO";report("scene",scene,"b4w_enable_anchors_visibility")}if(!("b4w_outline_color"in scene)){scene["b4w_outline_color"]=[1,1,1];report("scene",scene,"b4w_outline_color")}if(!("b4w_outline_factor"in scene)){if("b4w_glow_factor"in scene)scene["b4w_outline_factor"]=scene["b4w_glow_factor"];else scene["b4w_outline_factor"]=1;report("scene",scene,"b4w_outline_factor")}if(!("b4w_shadow_settings"in
scene)){report("scene",scene,"b4w_shadow_settings");var w_shadows=sc_world["b4w_shadow_settings"];if(w_shadows)scene["b4w_shadow_settings"]=w_shadows;else scene["b4w_shadow_settings"]={"csm_resolution":2048,"self_shadow_polygon_offset":1,"b4w_enable_csm":false,"csm_num":1,"csm_first_cascade_border":10,"first_cascade_blur_radius":3,"csm_last_cascade_border":100,"last_cascade_blur_radius":1.5,"fade_last_cascade":true,"blend_between_cascades":true}}var shadows=scene["b4w_shadow_settings"];if(!("csm_resolution"in
shadows)){report("scene",scene,"b4w_shadow_settings.csm_resolution");shadows["csm_resolution"]=2048}if(!("self_shadow_polygon_offset"in shadows)){report("scene",scene,"b4w_shadow_settings.self_shadow_polygon_offset");shadows["self_shadow_polygon_offset"]=1}if(!("self_shadow_normal_offset"in shadows)){report("scene",scene,"b4w_shadow_settings.self_shadow_normal_offset");shadows["self_shadow_normal_offset"]=.01}if(!("b4w_enable_csm"in shadows)){report("scene",scene,"b4w_shadow_settings.b4w_enable_csm");
shadows["b4w_enable_csm"]=false}if(!("csm_num"in shadows)){report("scene",scene,"b4w_shadow_settings.csm_num");shadows["csm_num"]=1}if(!("csm_first_cascade_border"in shadows)){report("scene",scene,"b4w_shadow_settings.csm_first_cascade_border");shadows["csm_first_cascade_border"]=10}if(!("first_cascade_blur_radius"in shadows)){report("scene",scene,"b4w_shadow_settings.first_cascade_blur_radius");shadows["first_cascade_blur_radius"]=3}if(!("csm_last_cascade_border"in shadows)){report("scene",scene,
"b4w_shadow_settings.csm_last_cascade_border");shadows["csm_last_cascade_border"]=100}if(!("last_cascade_blur_radius"in shadows)){report("scene",scene,"b4w_shadow_settings.last_cascade_blur_radius");shadows["last_cascade_blur_radius"]=1.5}if(!("fade_last_cascade"in shadows)){report("scene",scene,"b4w_shadow_settings.fade_last_cascade");shadows["fade_last_cascade"]=true}if(!("blend_between_cascades"in shadows)){report("scene",scene,"b4w_shadow_settings.blend_between_cascades");shadows["blend_between_cascades"]=
true}if(!("b4w_ssao_settings"in scene)){report("scene",scene,"b4w_ssao_settings");var w_ssao=sc_world["b4w_ssao_settings"];if(w_ssao)scene["b4w_ssao_settings"]=w_ssao;else scene["b4w_ssao_settings"]={"dist_factor":0,"samples":16,"hemisphere":false,"blur_depth":false,"blur_discard_value":1}}var ssao=scene["b4w_ssao_settings"];if(!("dist_factor"in ssao)){report("scene",scene,"b4w_ssao_settings.dist_factor");ssao["dist_factor"]=0}if(!("samples"in ssao)){report("scene",scene,"b4w_ssao_settings.samples");
ssao["samples"]=16}if(!("hemisphere"in ssao)){report("scene",scene,"b4w_ssao_settings.hemisphere");ssao["hemisphere"]=false}if(!("blur_depth"in ssao)){report("scene",scene,"b4w_ssao_settings.blur_depth");ssao["blur_depth"]=false}if(!("blur_discard_value"in ssao)){report("scene",scene,"b4w_ssao_settings.blur_discard_value");ssao["blur_discard_value"]=1}if(!("b4w_bloom_settings"in scene)){report("scene",scene,"b4w_bloom_settings");var w_bloom=sc_world["b4w_bloom_settings"];if(w_bloom)scene["b4w_bloom_settings"]=
w_bloom;else scene["b4w_bloom_settings"]={"key":.2,"blur":4,"edge_lum":1}}if(!("key"in scene["b4w_bloom_settings"])){report("scene",scene,"b4w_bloom_settings.key");scene["b4w_bloom_settings"]["key"]=.2}if(!("blur"in scene["b4w_bloom_settings"])){report("scene",scene,"b4w_bloom_settings.blur");scene["b4w_bloom_settings"]["blur"]=4}if(!("edge_lum"in scene["b4w_bloom_settings"])){report("scene",scene,"b4w_bloom_settings.edge_lum");scene["b4w_bloom_settings"]["edge_lum"]=1}if(!("b4w_motion_blur_settings"in
scene)){report("scene",scene,"b4w_motion_blur_settings");var w_motion_blur=sc_world["b4w_motion_blur_settings"];if(w_motion_blur)scene["b4w_motion_blur_settings"]=w_motion_blur;else scene["b4w_motion_blur_settings"]={"motion_blur_factor":.01,"motion_blur_decay_threshold":.01}}if(!("motion_blur_factor"in scene["b4w_motion_blur_settings"])){report("scene",scene,"b4w_motion_blur_settings.motion_blur_factor");scene["b4w_motion_blur_settings"]["motion_blur_factor"]=.01}if(!("motion_blur_decay_threshold"in
scene["b4w_motion_blur_settings"])){report("scene",scene,"b4w_motion_blur_settings.motion_blur_decay_threshold");scene["b4w_motion_blur_settings"]["motion_blur_decay_threshold"]=.01}if(!("b4w_color_correction_settings"in scene)){report("scene",scene,"b4w_color_correction_settings");var w_color_correction=sc_world["b4w_color_correction_settings"];if(w_color_correction)scene["b4w_color_correction_settings"]=w_color_correction;else scene["b4w_color_correction_settings"]={"brightness":0,"contrast":0,
"exposure":1,"saturation":1}}if(!("b4w_god_rays_settings"in scene)){report("scene",scene,"b4w_god_rays_settings");var w_god_rays=sc_world["b4w_god_rays_settings"];if(w_god_rays)scene["b4w_god_rays_settings"]=w_god_rays;else scene["b4w_god_rays_settings"]={"intensity":.7,"max_ray_length":1,"steps_per_pass":10}}if(!("steps_per_pass"in scene["b4w_god_rays_settings"])){report("scene",scene,"b4w_god_rays_settings.steps_per_pass");scene["b4w_god_rays_settings"]["steps_per_pass"]=10}if(!("b4w_glow_settings"in
scene)){report("scene",scene,"b4w_glow_settings");scene["b4w_glow_settings"]={"render_glow_over_blend":false,"small_glow_mask_coeff":2,"large_glow_mask_coeff":2,"small_glow_mask_width":2,"large_glow_mask_width":6};var glow_set=scene["b4w_glow_settings"];if("b4w_render_glow_over_blend"in sc_world)glow_set["render_glow_over_blend"]=sc_world["b4w_render_glow_over_blend"];if("b4w_small_glow_mask_coeff"in sc_world)glow_set["small_glow_mask_coeff"]=sc_world["b4w_small_glow_mask_coeff"];if("b4w_large_glow_mask_coeff"in
sc_world)glow_set["large_glow_mask_coeff"]=sc_world["b4w_large_glow_mask_coeff"];if("b4w_small_glow_mask_width"in sc_world)glow_set["small_glow_mask_width"]=sc_world["b4w_small_glow_mask_width"];if("b4w_large_glow_mask_width"in sc_world)glow_set["large_glow_mask_width"]=sc_world["b4w_large_glow_mask_width"]}var r_shadows=scene["b4w_render_shadows"];if(r_shadows!="AUTO"&&r_shadows!="OFF"&&r_shadows!="ON")if(r_shadows)scene["b4w_render_shadows"]="ON";else scene["b4w_render_shadows"]="OFF";var r_refl=
scene["b4w_render_reflections"];if(r_refl!="OFF"&&r_refl!="ON")if(r_refl)scene["b4w_render_reflections"]="ON";else scene["b4w_render_reflections"]="OFF";var r_refr=scene["b4w_render_refractions"];if(r_refr!="AUTO"&&r_refr!="OFF"&&r_refr!="ON")if(r_refr)scene["b4w_render_refractions"]="ON";else scene["b4w_render_refractions"]="OFF";if(!("b4w_render_dynamic_grass"in scene)){report("scene",scene,"b4w_render_dynamic_grass");scene["b4w_render_dynamic_grass"]="AUTO"}if(scene["b4w_nla_script"])report_deprecated("scene",
scene,"b4w_nla_script")}var meshes=bpy_data["meshes"];for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(!mesh["b4w_bounding_box"]){report("mesh",mesh,"b4w_bounding_box");mesh["b4w_bounding_box"]={"max_x":0,"max_y":0,"max_z":0,"min_x":0,"min_y":0,"min_z":0}}if(!mesh["b4w_bounding_box_source"]){report("mesh",mesh,"b4w_bounding_box_source");mesh["b4w_bounding_box_source"]=mesh["b4w_bounding_box"]}if(!mesh["uv_textures"]){report("mesh",mesh,"uv_textures");mesh["uv_textures"]=[]}if(!mesh["b4w_bounding_sphere_center"])mesh["b4w_bounding_sphere_center"]=
[0,0,0];if(!mesh["b4w_bounding_cylinder_center"])mesh["b4w_bounding_cylinder_center"]=[0,0,0];if(!mesh["b4w_bounding_ellipsoid_center"])mesh["b4w_bounding_ellipsoid_center"]=[0,0,0];if(!mesh["b4w_bounding_ellipsoid_axes"]){var bb=mesh["b4w_bounding_box"];mesh["b4w_bounding_ellipsoid_axes"]=[(bb["max_x"]-bb["min_x"])/2,(bb["max_y"]-bb["min_y"])/2,(bb["max_z"]-bb["min_z"])/2]}if(!("b4w_shape_keys"in mesh)){mesh["b4w_shape_keys"]=[];report("mesh",mesh,"b4w_shape_keys")}var submesh_is_ok=true;for(var k=
0;k<mesh["submeshes"].length;k++){var submesh=mesh["submeshes"][k];if(!("boundings"in submesh)){submesh_is_ok=false;submesh["boundings"]={"bounding_ellipsoid_axes":mesh["b4w_bounding_ellipsoid_axes"],"bounding_ellipsoid_center":mesh["b4w_bounding_ellipsoid_center"],"bounding_box":{"max_x":mesh["b4w_bounding_box"]["max_x"],"max_y":mesh["b4w_bounding_box"]["max_y"],"max_z":mesh["b4w_bounding_box"]["max_z"],"min_x":mesh["b4w_bounding_box"]["min_x"],"min_y":mesh["b4w_bounding_box"]["min_y"],"min_z":mesh["b4w_bounding_box"]["min_z"]}}}}if(!submesh_is_ok)report("mesh",
mesh,"submesh_bd");check_export_props(mesh);for(var j=0;j<mesh["b4w_vertex_anim"].length;j++){var va=mesh["b4w_vertex_anim"][j];if(!("allow_nla"in va)){report('mesh["b4w_vertex_anim"]',mesh,"allow_nla");va["allow_nla"]=true}}}var cameras=bpy_data["cameras"];for(var i=0;i<cameras.length;i++){var camera=cameras[i];if(!camera["type"]){camera["type"]="PERSP";report("camera",camera,"type")}if("b4w_eye_target_dist"in camera){delete camera["b4w_eye_target_dist"];report_deprecated("camera",camera,"b4w_eye_target_dist")}if(!("b4w_hover_zero_level"in
camera)){camera["b4w_hover_zero_level"]=0;report("camera",camera,"b4w_hover_zero_level")}if(!("b4w_trans_velocity"in camera)){camera["b4w_trans_velocity"]=1;report("camera",camera,"b4w_trans_velocity")}if(!("b4w_rot_velocity"in camera)){camera["b4w_rot_velocity"]=1;report("camera",camera,"b4w_rot_velocity")}if(!("b4w_zoom_velocity"in camera)){camera["b4w_zoom_velocity"]=.1;report("camera",camera,"b4w_zoom_velocity")}if(!("b4w_use_target_distance_limits"in camera)){camera["b4w_use_target_distance_limits"]=
camera["b4w_use_distance_limits"]||false;report("camera",camera,"b4w_use_target_distance_limits")}if(!("b4w_use_zooming"in camera)){camera["b4w_use_zooming"]=camera["b4w_use_distance_limits"]||false;report("camera",camera,"b4w_use_zooming")}if(!("b4w_distance_min"in camera)){camera["b4w_distance_min"]=1;report("camera",camera,"b4w_distance_min")}if(!("b4w_distance_max"in camera)){camera["b4w_distance_max"]=100;report("camera",camera,"b4w_distance_max")}if(!("b4w_horizontal_translation_min"in camera)){camera["b4w_horizontal_translation_min"]=
-100;report("camera",camera,"b4w_horizontal_translation_min")}if(!("b4w_horizontal_translation_max"in camera)){camera["b4w_horizontal_translation_max"]=100;report("camera",camera,"b4w_horizontal_translation_max")}if(!("b4w_vertical_translation_min"in camera)){camera["b4w_vertical_translation_min"]=-100;report("camera",camera,"b4w_vertical_translation_min")}if(!("b4w_vertical_translation_max"in camera)){camera["b4w_vertical_translation_max"]=100;report("camera",camera,"b4w_vertical_translation_max")}if(!("b4w_use_horizontal_clamping"in
camera)){camera["b4w_use_horizontal_clamping"]=false;report("camera",camera,"b4w_use_horizontal_clamping")}if(!("b4w_rotation_left_limit"in camera)){camera["b4w_rotation_left_limit"]=-Math.PI;report("camera",camera,"b4w_rotation_left_limit")}if(!("b4w_rotation_right_limit"in camera)){camera["b4w_rotation_right_limit"]=Math.PI;report("camera",camera,"b4w_rotation_right_limit")}if(!("b4w_horizontal_clamping_type"in camera)){camera["b4w_horizontal_clamping_type"]="LOCAL";report("camera",camera,"b4w_horizontal_clamping_type")}if(!("b4w_use_vertical_clamping"in
camera)){camera["b4w_use_vertical_clamping"]=false;report("camera",camera,"b4w_use_vertical_clamping")}if(!("b4w_rotation_down_limit"in camera)){camera["b4w_rotation_down_limit"]=-Math.PI/2;report("camera",camera,"b4w_rotation_down_limit")}if(!("b4w_rotation_up_limit"in camera)){camera["b4w_rotation_up_limit"]=Math.PI/2;report("camera",camera,"b4w_rotation_up_limit")}if(!("b4w_vertical_clamping_type"in camera)){camera["b4w_vertical_clamping_type"]="LOCAL";report("camera",camera,"b4w_vertical_clamping_type")}if(!("b4w_hover_angle_min"in
camera)){camera["b4w_hover_angle_min"]=Math.PI/6;report("camera",camera,"b4w_hover_angle_min")}if(!("b4w_hover_angle_max"in camera)){camera["b4w_hover_angle_max"]=Math.PI/6;report("camera",camera,"b4w_hover_angle_max")}if(!("b4w_enable_hover_hor_rotation"in camera)){camera["b4w_enable_hover_hor_rotation"]=true;report("camera",camera,"b4w_enable_hover_hor_rotation")}if(!("b4w_use_panning"in camera)){camera["b4w_use_panning"]=true;report("camera",camera,"b4w_use_panning")}if(!("b4w_use_pivot_limits"in
camera)){camera["b4w_use_pivot_limits"]=false;camera["b4w_pivot_z_min"]=0;camera["b4w_pivot_z_max"]=10;report("camera",camera,"b4w_use_pivot_limits")}}var lamps=bpy_data["lamps"];for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(!("b4w_generate_shadows"in lamp)){lamp["b4w_generate_shadows"]=false;report("lamp",lamp,"b4w_generate_shadows")}if(!("b4w_dynamic_intensity"in lamp)){lamp["b4w_dynamic_intensity"]=false;report("lamp",lamp,"b4w_dynamic_intensity")}if(!("use_diffuse"in lamp)){lamp["use_diffuse"]=
true;report("lamp",lamp,"use_diffuse")}if(!("use_specular"in lamp)){lamp["use_specular"]=true;report("lamp",lamp,"use_specular")}}var speakers=bpy_data["speakers"];for(var i=0;i<speakers.length;i++){var speaker=speakers[i];if(!("b4w_behavior"in speaker))if(speaker["b4w_background_music"])speaker["b4w_behavior"]="BACKGROUND_SOUND";else speaker["b4w_behavior"]="POSITIONAL";if(!("b4w_disable_doppler"in speaker))speaker["b4w_disable_doppler"]=false;if(!("b4w_delay"in speaker))speaker["b4w_delay"]=0;if(!("b4w_delay_random"in
speaker))speaker["b4w_delay_random"]=0;if(!("b4w_volume_random"in speaker))speaker["b4w_volume_random"]=0;if(!("b4w_pitch_random"in speaker))speaker["b4w_pitch_random"]=0;if(!("b4w_fade_in"in speaker))speaker["b4w_fade_in"]=0;if(!("b4w_fade_out"in speaker))speaker["b4w_fade_out"]=0;if(!("b4w_loop"in speaker))speaker["b4w_loop"]=false;if(!("b4w_loop_count"in speaker))speaker["b4w_loop_count"]=0;if(!("b4w_loop_count_random"in speaker))speaker["b4w_loop_count_random"]=0;if(!("b4w_playlist_id"in speaker))speaker["b4w_playlist_id"]=
"";if(speaker["animation_data"])check_strip_props(speaker["animation_data"])}var textures=bpy_data["textures"];for(var i=0;i<textures.length;i++){var texture=textures[i];if(!("b4w_anisotropic_filtering"in texture)){texture["b4w_anisotropic_filtering"]="OFF";report("texture",texture,"b4w_anisotropic_filtering")}if(!("b4w_water_foam"in texture)){texture["b4w_water_foam"]=false;report("texture",texture,"b4w_water_foam")}if(!("b4w_foam_uv_freq"in texture)){texture["b4w_foam_uv_freq"]=[1,1];report("texture",
texture,"b4w_foam_uv_freq")}if(!("b4w_foam_uv_magnitude"in texture)){texture["b4w_foam_uv_magnitude"]=[1,1];report("texture",texture,"b4w_foam_uv_magnitude")}if(!("b4w_parallax_steps"in texture)){texture["b4w_parallax_steps"]=5;report("material",texture,"b4w_parallax_steps")}if(!("b4w_parallax_lod_dist"in texture)){texture["b4w_parallax_lod_dist"]=10;report("material",texture,"b4w_parallax_lod_dist")}if(!("b4w_shore_dist_map"in texture)){texture["b4w_shore_dist_map"]=false;report("texture",texture,
"b4w_shore_dist_map")}if(!("b4w_shore_boundings"in texture)){texture["b4w_shore_boundings"]=new Float32Array(4);texture["b4w_shore_boundings"]=[1E3,-1E3,1E3,-1E3];report("texture",texture,"b4w_shore_boundings")}if(!("b4w_max_shore_dist"in texture)){texture["b4w_max_shore_dist"]=100;report("texture",texture,"b4w_max_shore_dist")}if(!("b4w_disable_compression"in texture)){texture["b4w_disable_compression"]=false;report("texture",texture,"b4w_disable_compression")}if(!("b4w_source_type"in texture)){texture["b4w_source_type"]=
"";report("texture",texture,"b4w_source_type")}if(!("b4w_source_id"in texture)){texture["b4w_source_id"]="";report("texture",texture,"b4w_source_id")}if(!("b4w_source_size"in texture)){texture["b4w_source_size"]=1024;report("texture",texture,"b4w_source_size")}if(!("b4w_enable_canvas_mipmapping"in texture)){texture["b4w_enable_canvas_mipmapping"]=true;report("texture",texture,"b4w_enable_canvas_mipmapping")}if(!("b4w_nla_video"in texture)){texture["b4w_nla_video"]=false;report("texture",texture,"b4w_nla_video")}}var materials=
bpy_data["materials"];for(var i=0;i<materials.length;i++){var mat=materials[i];if(mat["game_settings"]["alpha_blend"]=="ALPHA_ANTIALIASING")mat["game_settings"]["alpha_blend"]="CLIP";if("b4w_node_mat_type"in mat)report_deprecated("material",mat,"b4w_node_mat_type");if("b4w_skydome"in mat)report_deprecated("material",mat,"b4w_skydome");if("b4w_procedural_skydome"in mat)report_deprecated("material",mat,"b4w_procedural_skydome");if(mat["b4w_water"]){if(!("b4w_water_shore_smoothing"in mat)){mat["b4w_water_shore_smoothing"]=
false;report("material",mat,"b4w_water_shore_smoothing")}if(!("b4w_water_dynamic"in mat)){mat["b4w_water_dynamic"]=false;report("material",mat,"b4w_water_dynamic")}if(!("b4w_waves_height"in mat)){mat["b4w_waves_height"]=1;report("material",mat,"b4w_waves_height")}if(!("b4w_waves_length"in mat)){mat["b4w_waves_length"]=1;report("material",mat,"b4w_waves_length")}if(!("b4w_water_dst_noise_scale0"in mat)){mat["b4w_water_dst_noise_scale0"]=.05;report("material",mat,"b4w_water_dst_noise_scale0")}if(!("b4w_water_dst_noise_scale1"in
mat)){mat["b4w_water_dst_noise_scale1"]=.03;report("material",mat,"b4w_water_dst_noise_scale1")}if(!("b4w_water_dst_noise_freq0"in mat)){mat["b4w_water_dst_noise_freq0"]=1.3;report("material",mat,"b4w_water_dst_noise_freq0")}if(!("b4w_water_dst_noise_freq1"in mat)){mat["b4w_water_dst_noise_freq1"]=1;report("material",mat,"b4w_water_dst_noise_freq1")}if(!("b4w_water_dir_min_shore_fac"in mat)){mat["b4w_water_dir_min_shore_fac"]=.4;report("material",mat,"b4w_water_dir_min_shore_fac")}if(!("b4w_water_dir_freq"in
mat)){mat["b4w_water_dir_freq"]=.5;report("material",mat,"b4w_water_dir_freq")}if(!("b4w_water_dir_noise_scale"in mat)){mat["b4w_water_dir_noise_scale"]=.05;report("material",mat,"b4w_water_dir_noise_scale")}if(!("b4w_water_dir_noise_freq"in mat)){mat["b4w_water_dir_noise_freq"]=.07;report("material",mat,"b4w_water_dir_noise_freq")}if(!("b4w_water_dir_min_noise_fac"in mat)){mat["b4w_water_dir_min_noise_fac"]=.5;report("material",mat,"b4w_water_dir_min_noise_fac")}if(!("b4w_water_dst_min_fac"in mat)){mat["b4w_water_dst_min_fac"]=
.2;report("material",mat,"b4w_water_dst_min_fac")}if(!("b4w_water_waves_hor_fac"in mat)){mat["b4w_water_waves_hor_fac"]=5;report("material",mat,"b4w_water_waves_hor_fac")}if(!("b4w_water_absorb_factor"in mat)){mat["b4w_water_absorb_factor"]=6;report("material",mat,"b4w_water_absorb_factor")}if(!("b4w_water_fog_color"in mat)){mat["b4w_water_fog_color"]=new Float32Array(3);mat["b4w_water_fog_color"]=[.5,.7,.7];report("material",mat,"b4w_water_fog_color")}if(!("b4w_foam_factor"in mat)){mat["b4w_foam_factor"]=
5;report("material",mat,"b4w_foam_factor")}if(!("b4w_generated_mesh"in mat)){mat["b4w_generated_mesh"]=false;report("material",mat,"b4w_generated_mesh")}if(!("b4w_water_num_cascads"in mat)){mat["b4w_water_num_cascads"]=5;report("material",mat,"b4w_water_num_cascads")}if(!("b4w_water_subdivs"in mat)){mat["b4w_water_subdivs"]=64;report("material",mat,"b4w_water_subdivs")}if(!("b4w_water_detailed_dist"in mat)){mat["b4w_water_detailed_dist"]=1E3;report("material",mat,"b4w_water_detailed_dist")}if(!("b4w_water_enable_caust"in
mat)){mat["b4w_water_enable_caust"]=false;report("material",mat,"b4w_water_enable_caust")}if(!("b4w_water_caust_scale"in mat)){mat["b4w_water_caust_scale"]=.25;report("material",mat,"b4w_water_caust_scale")}if(!("b4w_water_caust_brightness"in mat)){mat["b4w_water_caust_brightness"]=.5;report("material",mat,"b4w_water_caust_brightness")}}if(!("b4w_dynamic_grass_size"in mat))mat["b4w_dynamic_grass_size"]="";if(!("b4w_dynamic_grass_color"in mat))mat["b4w_dynamic_grass_color"]="";if(!("diffuse_intensity"in
mat)){mat["diffuse_intensity"]=1;report("material",mat,"diffuse_intensity")}if(!("b4w_use_ghost"in mat))mat["b4w_use_ghost"]=false;if(!("b4w_collision_margin"in mat)){mat["b4w_collision_margin"]=.04;report("material",mat,"b4w_collision_margin")}if(!("b4w_collision_group"in mat)){mat["b4w_collision_group"]=128;report("material",mat,"b4w_collision_group")}if(!("b4w_collision_mask"in mat)){mat["b4w_collision_mask"]=127;report("material",mat,"b4w_collision_mask")}if(!("b4w_do_not_render"in mat)){mat["b4w_do_not_render"]=
false;report("material",mat,"b4w_do_not_render")}if(mat.type=="HALO"&&!("b4w_halo_sky_stars"in mat)){mat["b4w_halo_sky_stars"]=false;report("material",mat,"b4w_halo_sky_stars")}if(mat.type=="HALO"&&!("b4w_halo_stars_blend_height"in mat)){mat["b4w_halo_stars_blend_height"]=10;report("material",mat,"b4w_halo_stars_blend_height")}if(mat.type=="HALO"&&!("b4w_halo_stars_min_height"in mat)){mat["b4w_halo_stars_min_height"]=0;report("material",mat,"b4w_halo_stars_min_height")}if(!("specular_shader"in mat)){mat["specular_shader"]=
"COOKTORR";report("material",mat,"specular_shader")}if(!("diffuse_shader"in mat)){mat["diffuse_shader"]="LAMBERT";report("material",mat,"diffuse_shader")}if(!("roughness"in mat)){mat["roughness"]=.5;report("material",mat,"roughness")}if(!("diffuse_fresnel"in mat)){mat["diffuse_fresnel"]=.1;report("material",mat,"diffuse_fresnel")}if(!("diffuse_fresnel_factor"in mat)){mat["diffuse_fresnel_factor"]=.5;report("material",mat,"diffuse_fresnel_factor")}if(!("specular_slope"in mat)){mat["specular_slope"]=
.2;report("material",mat,"specular_slope")}if(!("specular_toon_size"in mat)){mat["specular_toon_size"]=.5;report("material",mat,"specular_toon_size")}if(!("specular_toon_smooth"in mat)){mat["specular_toon_smooth"]=.1;report("material",mat,"specular_toon_smooth")}if(!("specular_alpha"in mat)){mat["specular_alpha"]=1;report("material",mat,"specular_alpha")}if(!("b4w_wettable"in mat)){mat["b4w_wettable"]=false;report("material",mat,"b4w_wettable")}if(!("b4w_refractive"in mat)){mat["b4w_refractive"]=
false;report("material",mat,"b4w_refractive")}if(!("b4w_refr_bump"in mat)){mat["b4w_refr_bump"]=0;report("material",mat,"b4w_refr_bump")}if(!("b4w_shallow_water_col"in mat)){mat["b4w_shallow_water_col"]=[0,.8,.3];report("material",mat,"b4w_shallow_water_col")}if(!("b4w_shore_water_col"in mat)){mat["b4w_shore_water_col"]=[0,.9,.2];report("material",mat,"b4w_shore_water_col")}if(!("b4w_shallow_water_col_fac"in mat)){mat["b4w_shallow_water_col_fac"]=1;report("material",mat,"b4w_shallow_water_col_fac")}if(!("b4w_shore_water_col_fac"in
mat)){mat["b4w_shore_water_col_fac"]=.5;report("material",mat,"b4w_shore_water_col_fac")}if(!("b4w_water_sss_strength"in mat)){mat["b4w_water_sss_strength"]=5.9;report("material",mat,"b4w_water_sss_strength")}if(!("b4w_water_sss_width"in mat)){mat["b4w_water_sss_width"]=.45;report("material",mat,"b4w_water_sss_width")}if(!("b4w_render_above_all"in mat)){mat["b4w_render_above_all"]=false;report("material",mat,"b4w_render_above_all")}if(!("b4w_water_norm_uv_velocity"in mat)){mat["b4w_water_norm_uv_velocity"]=
.05;report("material",mat,"b4w_water_norm_uv_velocity")}if(!("specular_ior"in mat)){mat["specular_ior"]=1;report("material",mat,"specular_ior")}if(!("darkness"in mat)){mat["darkness"]=0;report("material",mat,"darkness")}if(!("diffuse_toon_size"in mat)){mat["diffuse_toon_size"]=0;report("material",mat,"diffuse_toon_size")}if(!("diffuse_toon_smooth"in mat)){mat["diffuse_toon_smooth"]=0;report("material",mat,"diffuse_toon_smooth")}var texture_slots=mat["texture_slots"];for(var j=0;j<texture_slots.length;j++){var slot=
texture_slots[j];if(!("blend_type"in slot)){slot["blend_type"]="MIX";report("texture_slot",slot,"blend_type")}}if(mat["node_tree"]){var nodes=mat["node_tree"]["nodes"];for(var j=0;j<nodes.length;j++)reform_node(nodes[j]);if(mat["node_tree"]["animation_data"])check_strip_props(mat["node_tree"]["animation_data"])}}var node_groups=bpy_data["node_groups"];for(var i=0;i<node_groups.length;i++){var nodes=node_groups[i]["node_tree"]["nodes"];for(var j=0;j<nodes.length;j++)reform_node(nodes[j])}var objects=
bpy_data["objects"];for(var i=0;i<objects.length;i++){var bpy_obj=objects[i];switch(bpy_obj["type"]){case "MESH":if(!("b4w_dynamic_geometry"in bpy_obj))bpy_obj["b4w_dynamic_geometry"]=false;if(!("b4w_reflexible"in bpy_obj))bpy_obj["b4w_reflexible"]=false;if(!("b4w_reflexible_only"in bpy_obj))bpy_obj["b4w_reflexible_only"]=false;if(!("b4w_reflective"in bpy_obj))bpy_obj["b4w_reflective"]=false;if(!("b4w_reflection_type"in bpy_obj)){bpy_obj["b4w_reflection_type"]="PLANE";report("object",bpy_obj,"b4w_reflection_type")}if(!("b4w_wind_bending"in
bpy_obj)){bpy_obj["b4w_wind_bending"]=false;report("object",bpy_obj,"b4w_wind_bending")}if(!("b4w_wind_bending_angle"in bpy_obj)){bpy_obj["b4w_wind_bending_angle"]=10;bpy_obj["b4w_wind_bending_freq"]=.25;report("object",bpy_obj,"wind bending params")}if(!("b4w_detail_bending_amp"in bpy_obj)){bpy_obj["b4w_detail_bending_amp"]=.1;bpy_obj["b4w_branch_bending_amp"]=.3;report("object",bpy_obj,"detail bending params")}if(!("b4w_detail_bending_freq"in bpy_obj)){bpy_obj["b4w_detail_bending_freq"]=1;report("object",
bpy_obj,"b4w_detail_bending_freq")}if(!("b4w_main_bend_stiffness_col"in bpy_obj)){bpy_obj["b4w_main_bend_stiffness_col"]="";report("object",bpy_obj,"b4w_main_bend_stiffness_col")}if(!("b4w_detail_bend_colors"in bpy_obj)){bpy_obj["b4w_detail_bend_colors"]={"leaves_stiffness_col":"","leaves_phase_col":"","overall_stiffness_col":""};report("object",bpy_obj,"b4w_detail_bend_colors")}if(!("b4w_caustics"in bpy_obj))bpy_obj["b4w_caustics"]=false;if("vertex_groups"in bpy_obj&&bpy_obj["vertex_groups"].length&&
bpy_obj["data"]&&bpy_obj["data"]["vertex_groups"].length==0){bpy_obj["data"]["vertex_groups"]=bpy_obj["vertex_groups"];delete bpy_obj["vertex_groups"];report("object",bpy_obj,"vertex_groups")}if("b4w_vertex_anim"in bpy_obj&&bpy_obj["b4w_vertex_anim"].length&&bpy_obj["data"]&&bpy_obj["data"]["b4w_vertex_anim"].length==0){bpy_obj["data"]["b4w_vertex_anim"]=bpy_obj["b4w_vertex_anim"];delete bpy_obj["b4w_vertex_anim"];report("object",bpy_obj,"b4w_vertex_anim")}if(!("b4w_do_not_render"in bpy_obj))bpy_obj["b4w_do_not_render"]=
false;if(!("use_ghost"in bpy_obj["game"]))bpy_obj["game"]["use_ghost"]=false;if(!("use_sleep"in bpy_obj["game"]))bpy_obj["game"]["use_sleep"]=false;if(!("velocity_min"in bpy_obj["game"]))bpy_obj["game"]["velocity_min"]=0;if(!("velocity_max"in bpy_obj["game"]))bpy_obj["game"]["velocity_max"]=0;if(!("collision_group"in bpy_obj["game"]))bpy_obj["game"]["collision_group"]=1;if(!("collision_mask"in bpy_obj["game"]))bpy_obj["game"]["collision_mask"]=255;if("b4w_vehicle_settings"in bpy_obj){if(bpy_obj["b4w_vehicle_settings"]){if(!("steering_ratio"in
bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["steering_ratio"]=10;if(!("steering_max"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["steering_max"]=1;if(!("inverse_control"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["inverse_control"]=false;if(!("force_max"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["force_max"]=1500;if(!("brake_max"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["brake_max"]=
100;if(!("speed_ratio"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["speed_ratio"]=.027;if(!("max_speed_angle"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["max_speed_angle"]=Math.PI;if(!("delta_tach_angle"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["delta_tach_angle"]=4.43;if(!("suspension_compression"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["suspension_compression"]=4.4;if(!("suspension_stiffness"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["suspension_stiffness"]=
20;if(!("suspension_damping"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["suspension_damping"]=2.3;if(!("wheel_friction"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["wheel_friction"]=1E3;if(!("roll_influence"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["roll_influence"]=.1;if(!("max_suspension_travel_cm"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["max_suspension_travel_cm"]=30;if(!("floating_factor"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["floating_factor"]=
3;if(!("floating_factor"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["floating_factor"]=3;if(!("water_lin_damp"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["water_lin_damp"]=.9;if(!("water_rot_damp"in bpy_obj["b4w_vehicle_settings"]))bpy_obj["b4w_vehicle_settings"]["water_rot_damp"]=.9}}else{bpy_obj["b4w_vehicle_settings"]=null;report("object",bpy_obj,"b4w_vehicle_settings")}if("b4w_floating_settings"in bpy_obj){if(bpy_obj["b4w_floating_settings"]){if(!("floating_factor"in
bpy_obj["b4w_floating_settings"]))bpy_obj["b4w_floating_settings"]["floating_factor"]=3;if(!("water_lin_damp"in bpy_obj["b4w_floating_settings"]))bpy_obj["b4w_floating_settings"]["water_lin_damp"]=.8;if(!("water_rot_damp"in bpy_obj["b4w_floating_settings"]))bpy_obj["b4w_floating_settings"]["water_rot_damp"]=.8}}else{bpy_obj["b4w_floating_settings"]=null;report("object",bpy_obj,"b4w_floating_settings")}if("b4w_character_settings"in bpy_obj){if(bpy_obj["b4w_character_settings"]){if(!("walk_speed"in
bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["walk_speed"]=4;if(!("run_speed"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["run_speed"]=8;if(!("step_height"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["step_height"]=.25;if(!("jump_strength"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["jump_strength"]=5;if(!("waterline"in bpy_obj["b4w_character_settings"]))bpy_obj["b4w_character_settings"]["waterline"]=
0}}else{bpy_obj["b4w_character_settings"]=null;report("object",bpy_obj,"b4w_character_settings")}if(!("b4w_selectable"in bpy_obj)){bpy_obj["b4w_selectable"]=false;report("object",bpy_obj,"b4w_selectable")}if(!("b4w_outlining"in bpy_obj)){bpy_obj["b4w_outlining"]=false;report("object",bpy_obj,"b4w_outlining")}if(!("b4w_outline_on_select"in bpy_obj)){bpy_obj["b4w_outline_on_select"]=false;report("object",bpy_obj,"b4w_outline_on_select")}if(!("b4w_billboard"in bpy_obj)){bpy_obj["b4w_billboard"]=false;
report("object",bpy_obj,"b4w_billboard")}if(!("b4w_billboard_geometry"in bpy_obj)){bpy_obj["b4w_billboard_geometry"]="SPHERICAL";report("object",bpy_obj,"b4w_billboard_geometry")}if(!("b4w_pres_glob_orientation"in bpy_obj)){bpy_obj["b4w_pres_glob_orientation"]=false;report("object",bpy_obj,"b4w_pres_glob_orientation")}if(!("b4w_outline_settings"in bpy_obj)){if("b4w_glow_settings"in bpy_obj)bpy_obj["b4w_outline_settings"]=bpy_obj["b4w_glow_settings"];else{bpy_obj["b4w_outline_settings"]={};bpy_obj["b4w_outline_settings"]["outline_duration"]=
1;bpy_obj["b4w_outline_settings"]["outline_period"]=1;bpy_obj["b4w_outline_settings"]["outline_relapses"]=0}report("object",bpy_obj,"b4w_outline_settings")}if(!("b4w_lod_transition"in bpy_obj)){bpy_obj["b4w_lod_transition"]=.01;report("object",bpy_obj,"b4w_lod_transition")}if(!("lod_levels"in bpy_obj)){bpy_obj["lod_levels"]=[];report("object",bpy_obj,"lod_levels")}if(!("b4w_animation_mixing"in bpy_obj)){bpy_obj["b4w_animation_mixing"]=false;report("object",bpy_obj,"b4w_animation_mixing")}break;case "EMPTY":if(!("b4w_anchor"in
bpy_obj)){bpy_obj["b4w_anchor"]=null;report("object",bpy_obj,"b4w_anchor")}if(bpy_obj["b4w_anchor"]&&!("max_width"in bpy_obj["b4w_anchor"]))bpy_obj["b4w_anchor"]["max_width"]=250;break;default:break}if(!("collision_margin"in bpy_obj["game"])){bpy_obj["game"]["collision_margin"]=.04;report("object",bpy_obj,"collision_margin")}if(!("b4w_anim_behavior"in bpy_obj)){bpy_obj["b4w_anim_behavior"]=bpy_obj["b4w_cyclic_animation"]?"CYCLIC":"FINISH_STOP";report("object",bpy_obj,"b4w_anim_behavior")}if(!("rotation_quaternion"in
bpy_obj)){var quat=[0,0,0,1];m_util.euler_to_quat(bpy_obj["rotation_euler"],quat);quat_b4w_bpy(quat,quat);bpy_obj["rotation_quaternion"]=quat;report("object",bpy_obj,"rotation_quaternion")}if("webgl_do_not_batch"in bpy_obj){bpy_obj["b4w_do_not_batch"]=bpy_obj["webgl_do_not_batch"];if(bpy_obj["webgl_do_not_batch"])report_deprecated("object",bpy_obj,"webgl_do_not_batch")}if(!("b4w_shadow_cast_only"in bpy_obj)){bpy_obj["b4w_shadow_cast_only"]=false;report("object",bpy_obj,"b4w_shadow_cast_only")}if(!("b4w_correct_bounding_offset"in
bpy_obj)){bpy_obj["b4w_correct_bounding_offset"]="AUTO";report("object",bpy_obj,"b4w_correct_bounding_offset")}var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var psys=psystems[j];var pset=psys["settings"];if(!("use_rotation_dupli"in pset)){pset["use_rotation_dupli"]=false;report("particle_settings",pset,"use_rotation_dupli")}if(!("use_whole_group"in pset)){pset["use_whole_group"]=false;report("particle_settings",pset,"use_whole_group")}if(!psys["transforms"]){psys["transforms"]=
new Float32Array;report("particle_system",psys,"transforms")}if(!("b4w_billboard_align"in pset)){pset["b4w_billboard_align"]="VIEW";report("particle_settings",pset,"b4w_billboard_align")}if(!("b4w_dynamic_grass"in pset)){pset["b4w_dynamic_grass"]=false;report("object",pset,"b4w_dynamic_grass")}if(!("b4w_dynamic_grass_scale_threshold"in pset)){pset["b4w_dynamic_grass_scale_threshold"]=.01;report("object",pset,"b4w_dynamic_grass_scale_threshold")}if(!("b4w_initial_rand_rotation"in pset)){pset["b4w_initial_rand_rotation"]=
false;report("particle_settings",pset,"b4w_initial_rand_rotation")}if(!("b4w_rotation_type"in pset)){pset["b4w_rotation_type"]="Z";report("particle_settings",pset,"b4w_rotation_type")}if(!("b4w_rand_rotation_strength"in pset)){pset["b4w_rand_rotation_strength"]=1;report("particle_settings",pset,"b4w_rand_rotation_strength")}if(!("b4w_hair_billboard"in pset)){pset["b4w_hair_billboard"]=false;report("particle_settings",pset,"b4w_hair_billboard")}if(!("b4w_hair_billboard_type"in pset)){pset["b4w_hair_billboard_type"]=
"BASIC";report("particle_settings",pset,"b4w_hair_billboard_type")}if(!("b4w_hair_billboard_jitter_amp"in pset)){pset["b4w_hair_billboard_jitter_amp"]=0;report("particle_settings",pset,"b4w_hair_billboard_jitter_amp")}if(!("b4w_hair_billboard_jitter_freq"in pset)){pset["b4w_hair_billboard_jitter_freq"]=0;report("particle_settings",pset,"b4w_hair_billboard_jitter_freq")}if(!("b4w_hair_billboard_geometry"in pset)){pset["b4w_hair_billboard_geometry"]="SPHERICAL";report("particle_settings",pset,"b4w_hair_billboard_geometry")}if(!("b4w_wind_bend_inheritance"in
pset)){pset["b4w_wind_bend_inheritance"]="PARENT";report("particle_settings",pset,"b4w_wind_bend_inheritance")}if(!("b4w_shadow_inheritance"in pset)){pset["b4w_shadow_inheritance"]="PARENT";report("particle_settings",pset,"b4w_shadow_inheritance")}if(!("b4w_reflection_inheritance"in pset)){pset["b4w_reflection_inheritance"]="PARENT";report("particle_settings",pset,"b4w_reflection_inheritance")}if(!("b4w_vcol_from_name"in pset)){pset["b4w_vcol_from_name"]="";report("particle_settings",pset,"b4w_vcol_from_name")}if(!("b4w_vcol_to_name"in
pset)){pset["b4w_vcol_to_name"]="";report("particle_settings",pset,"b4w_vcol_to_name")}if(!("b4w_coordinate_system"in pset)){pset["b4w_coordinate_system"]="LOCAL";report("particle_settings",pset,"b4w_coordinate_system")}if(!("b4w_allow_nla"in pset)){pset["b4w_allow_nla"]=true;report("particle_settings",pset,"b4w_allow_nla")}if(!("b4w_enable_soft_particles"in pset)){pset["b4w_enable_soft_particles"]=false;report("particle_settings",pset,"b4w_enable_soft_particles")}if(!("b4w_particles_softness"in pset)){pset["b4w_particles_softness"]=
1;report("particle_settings",pset,"b4w_particles_softness")}if(!("billboard_tilt"in pset)){pset["billboard_tilt"]=0;report("particle_settings",pset,"billboard_tilt")}if(!("billboard_tilt_random"in pset)){pset["billboard_tilt_random"]=0;report("particle_settings",pset,"billboard_tilt_random")}}if(!("constraints"in bpy_obj)){bpy_obj["constraints"]=[];report("object",bpy_obj,"constraints")}var mods=bpy_obj["modifiers"];for(var j=0;j<mods.length;j++)if(!check_modifier(mods[j],bpy_obj)){mods.splice(j,
1);j--}if(!("animation_data"in bpy_obj)){bpy_obj["animation_data"]={"action":null,"nla_tracks":[]};report("object",bpy_obj,"animation_data")}if(bpy_obj["animation_data"]){if(!("action"in bpy_obj["animation_data"])){bpy_obj["animation_data"]["action"]=null;report_raw("no action in animation data "+bpy_obj["name"])}if(!("nla_tracks"in bpy_obj["animation_data"])){bpy_obj["animation_data"]["nla_tracks"]=[];report_raw("no NLA in animation data "+bpy_obj["name"])}check_strip_props(bpy_obj["animation_data"])}if(!("b4w_collision_id"in
bpy_obj)){bpy_obj["b4w_collision_id"]="";report("object",bpy_obj,"b4w_collision_id")}if(!("b4w_viewport_alignment"in bpy_obj)){bpy_obj["b4w_viewport_alignment"]=null;report("object",bpy_obj,"b4w_viewport_alignment")}if(!("pinverse_tsr"in bpy_obj)){bpy_obj["pinverse_tsr"]=null;report("object",bpy_obj,"pinverse_tsr")}if(!("b4w_cluster_data"in bpy_obj)){bpy_obj["b4w_cluster_data"]={"cluster_id":-1};report("object",bpy_obj,"b4w_cluster_data")}if(check_negative_scale(bpy_obj))report_raw('negative scale for object "'+
bpy_obj["name"]+'", can lead to some errors');if(!check_uniform_scale(bpy_obj))report_raw("non-uniform scale for object "+bpy_obj["name"])}if(_unreported_compat_issues)m_print.error("Compatibility issues detected");for(var param in _params_reported){var param_data=_params_reported[param];var param_name=param.match(/.*?(?=>>|$)/i)[0];m_print.warn('Property "'+String(param_name)+'" is '+param_data.report_type+' for "'+param_data.type+'". To fix this, reexport '+bpy_data["b4w_filepath_blend"])}};function check_strip_props(animation_data){var nla_tracks=
animation_data["nla_tracks"];if(nla_tracks)for(var j=0;j<nla_tracks.length;j++){var track=nla_tracks[j];for(var k=0;k<track["strips"].length;k++){var strip=track["strips"][k];if(!("action"in strip)){strip["action"]=null;report("strip",strip,"action")}if(!("action_frame_start"in strip)){strip["action_frame_start"]=0;report("strip",strip,"action_frame_start")}if(!("action_frame_end"in strip)){strip["action_frame_end"]=strip["frame_end"]-strip["frame_start"];report("strip",strip,"action_frame_end")}if(!("repeat"in
strip)){strip["repeat"]=1;report("strip",strip,"repeat")}if(!("use_reverse"in strip)){strip["use_reverse"]=false;report("strip",strip,"use_reverse")}if(!("scale"in strip)){strip["scale"]=1;report("strip",strip,"scale")}}}}function check_export_props(bpy_obj){var export_props=["b4w_apply_scale","b4w_apply_modifiers","b4w_export_edited_normals","b4w_loc_export_vertex_anim","b4w_shape_keys"];var prop_found=null;for(var i=0;i<export_props.length;i++)if(bpy_obj[export_props[i]])if(!prop_found)prop_found=
export_props[i];else{bpy_obj[export_props[i]]=false;m_print.warn('WARNING property "'+export_props[i]+'" of object "'+bpy_obj["name"]+'" has been set to "false". Foreground property "'+prop_found+'" already exists.')}}function quat_b4w_bpy(quat,dest){var x=quat[0];var y=quat[1];var z=quat[2];var w=quat[3];dest[0]=w;dest[1]=x;dest[2]=y;dest[3]=z;return dest}function report(type,bpy_datablock,missing_param){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}var param_id=missing_param+
">>"+type;if(!(param_id in _params_reported))_params_reported[param_id]={storage:[],report_type:"undefined",type:type};_params_reported[param_id].storage.push(bpy_datablock["name"])}function report_missing_datablock(type,file_path_blend){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.warn("WARNING "+"Datablock "+type+' is missing, reexport "'+file_path_blend+'" scene')}function report_deprecated(type,bpy_datablock,deprecated_param){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=
true;return}var param_id=deprecated_param+">>"+type;if(!(param_id in _params_reported))_params_reported[param_id]={storage:[],report_type:"deprecated",type:type};_params_reported[param_id].storage.push(bpy_datablock["name"])}function report_modifier(type,bpy_obj,file_path_blend){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=true;return}m_print.error("WARNING "+"Incomplete modifier "+String(type)+" for "+'"'+bpy_obj["name"]+'"'+', reexport "'+file_path_blend+'" scene')}function report_raw(msg){if(!REPORT_COMPATIBILITY_ISSUES){_unreported_compat_issues=
true;return}m_print.warn(msg)}function check_uniform_scale(bpy_obj){var scale=bpy_obj["scale"];var eps=.005;if(scale[0]==0&&scale[1]==0&&scale[2]==0)return true;var delta1=Math.abs((scale[0]-scale[1])/scale[0]);var delta2=Math.abs((scale[1]-scale[2])/scale[1]);return delta1<eps&&delta2<eps}function check_negative_scale(bpy_obj){return bpy_obj["scale"][0]<0||bpy_obj["scale"][1]<0||bpy_obj["scale"][2]<0}exports.check_anim_fcurve_completeness=function(fcurve,action){if(!("num_channels"in fcurve)){fcurve["num_channels"]=
1;report_raw('B4W Warning: no channels number in animation fcurve for "'+action["name"]+'" action, reexport scene')}};exports.apply_mesh_modifiers=function(bpy_obj){if(!has_modifiers(bpy_obj))return null;var mesh=mesh_copy(bpy_obj["data"],bpy_obj["data"]["name"]+"_MOD");var modifiers=bpy_obj["modifiers"];for(var i=0;i<modifiers.length;i++){var mod=modifiers[i];switch(mod["type"]){case "ARRAY":apply_array_modifier(mesh,mod);break;case "CURVE":apply_curve_modifier(mesh,mod);break;default:break}m_bounds.recalculate_mesh_boundings(mesh)}return mesh};
function has_modifiers(bpy_obj){var modifiers=bpy_obj["modifiers"];for(var i=0;i<modifiers.length;i++){var mod=modifiers[i];var type=mod["type"];if(type=="ARRAY"||type=="CURVE")return true}return false}function apply_array_modifier(mesh,mod){var dx=0;var dy=0;var dz=0;var trans_matrix=new Float32Array(16);var new_meshes=[];for(var i=1;i<mod["count"];i++){if(mod["use_constant_offset"]){dx+=mod["constant_offset_displace"][0];dy+=mod["constant_offset_displace"][1];dz+=mod["constant_offset_displace"][2]}if(mod["use_relative_offset"]){var bb=
mesh["b4w_bounding_box"];dx+=(bb["max_x"]-bb["min_x"])*mod["relative_offset_displace"][0];dy+=(bb["max_y"]-bb["min_y"])*mod["relative_offset_displace"][1];dz+=(bb["max_z"]-bb["min_z"])*mod["relative_offset_displace"][2]}m_util.trans_matrix(dx,dy,dz,trans_matrix);var mc=mesh_copy(mesh);mesh_transform_locations(mc,trans_matrix);new_meshes.push(mc)}for(var i=0;i<new_meshes.length;i++)mesh_join(mesh,new_meshes[i])}function apply_curve_modifier(mesh,mod){var bpy_obj=mod["object"];var spline=m_curve.create_spline(bpy_obj);
var matrix=new Float32Array(16);var ncoords=spline.is_3d?4:3;var point=new Float32Array(ncoords);var deriv=new Float32Array(ncoords);var trans=new Float32Array(3);var quat=new Float32Array(4);var qtilt=new Float32Array(4);var tangent_a=new Float32Array(3);var tangent_b=new Float32Array(3);var loc=new Float32Array(3);var nor=new Float32Array(4);var tan=new Float32Array(4);for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var position=submesh["position"];var normal=submesh["normal"];
var tangent=submesh["tangent"];var deform_index=deform_axis_index(mod["deform_axis"]);tangent_a[0]=0;tangent_a[1]=0;tangent_a[2]=0;tangent_a[deform_index]=1;var slen=m_curve.spline_length(spline);for(var j=0;j<position.length/3;j++){loc[0]=position[3*j];loc[1]=position[3*j+1];loc[2]=position[3*j+2];var loc_spline_len=loc[deform_index];var t=m_curve.spline_len_to_t(spline,loc_spline_len);m_curve.spline_point(spline,t,point);trans[0]=point[0];trans[1]=point[1];trans[2]=point[2];m_curve.spline_derivative(spline,
t,deriv);tangent_b[0]=deriv[0];tangent_b[1]=0;tangent_b[2]=deriv[2];m_vec3.normalize(tangent_b,tangent_b);m_quat.rotationTo(tangent_a,tangent_b,quat);if(loc_spline_len<0){point[0]=tangent_b[0];point[1]=tangent_b[1];point[2]=tangent_b[2];m_vec3.scale(point,loc_spline_len,point);m_vec3.add(trans,point,trans)}else if(loc_spline_len>slen){point[0]=tangent_b[0];point[1]=tangent_b[1];point[2]=tangent_b[2];m_vec3.scale(point,loc_spline_len-slen,point);m_vec3.add(trans,point,trans)}m_mat4.fromRotationTranslation(quat,
trans,matrix);if(spline.is_3d){var tilt=point[3];m_quat.setAxisAngle(tangent_a,tilt,qtilt);m_vec3.transformQuat(loc,qtilt,loc)}loc[deform_index]=0;m_vec3.transformMat4(loc,matrix,loc);position[3*j]=loc[0];position[3*j+1]=loc[1];position[3*j+2]=loc[2];if(normal.length){nor[0]=normal[3*j];nor[1]=normal[3*j+1];nor[2]=normal[3*j+2];nor[3]=0;m_vec4.transformMat4(nor,matrix,nor);normal[3*j]=nor[0];normal[3*j+1]=nor[1];normal[3*j+2]=nor[2]}if(tangent.length){tan[0]=tangent[3*j];tan[1]=tangent[3*j+1];tan[2]=
tangent[3*j+2];tan[3]=0;m_vec4.transformMat4(tan,matrix,tan);tangent[3*j]=tan[0];tangent[3*j+1]=tan[1];tangent[3*j+2]=tan[2]}}}}function deform_axis_index(deform_axis){switch(deform_axis){case "POS_X":case "NEG_X":return 0;case "POS_Y":case "NEG_Y":return 1;case "POS_Z":case "NEG_Z":return 2;default:throw"Wrong deform axis value "+deform_axis;}}function modify_mesh_points_interval(mesh,x_min,x_max,y_min,y_max,z_min,z_max,matrix){var locations=mesh["vertices"]["locations"];var loc=new Float32Array(3);
for(var i=0;i<locations.length/3;i++){var x=locations[3*i];var y=locations[3*i+1];var z=locations[3*i+2];if((x_max-x_min==0||x>=x_min&&x<x_max)&&(y_max-y_min==0||y>=y_min&&y<y_max)&&(z_max-z_min==0||z>=z_min&&z<z_max)){loc[0]=x;loc[1]=y;loc[2]=z;m_vec3.transformMat4(loc,matrix,loc);locations[3*i]=loc[0];locations[3*i+1]=loc[1];locations[3*i+2]=loc[2]}}}exports.create_material=function(name){var mat={"name":name,"uuid":m_util.gen_uuid(),"use_nodes":false,"diffuse_shader":"LAMBERT","diffuse_color":[.8,
.8,.8],"diffuse_intensity":1,"alpha":1,"raytrace_transparency":{"fresnel":0,"fresnel_factor":1.25},"raytrace_mirror":{"reflect_factor":0,"fresnel":0,"fresnel_factor":1.25},"specular_color":[1,1,1],"specular_intensity":.5,"specular_shader":"COOKTORR","specular_hardness":50,"specular_slope":.2,"emit":0,"ambient":1,"use_vertex_color_paint":false,"b4w_water":false,"b4w_water_shore_smoothing":false,"b4w_water_dynamic":false,"b4w_generated_mesh":false,"b4w_waves_height":1,"b4w_water_fog_color":[.5,.5,.5],
"b4w_water_fog_density":.06,"b4w_water_num_cascads":5,"b4w_water_subdivs":64,"b4w_water_detailed_dist":1E3,"b4w_terrain":false,"b4w_collision":false,"b4w_collision_id":"","b4w_double_sided_lighting":false,"b4w_water_enable_caust":false,"b4w_water_caust_scale":.25,"b4w_water_caust_brightness":.5,"physics":{"friction":.5,"elasticity":0},"type":"SURFACE","use_transparency":false,"use_shadeless":false,"offset_z":0,"b4w_render_above_all":false,"game_settings":{"alpha_blend":"OPAQUE","use_backface_culling":true},
"halo":{"size":.5,"hardness":50,"b4w_halo_rings_color":[1,1,1],"b4w_halo_lines_color":[1,1,1],"b4w_halo_stars_blend_height":10,"b4w_halo_stars_min_height":0},"node_tree":null,"texture_slots":[]};return mat};function mesh_copy(mesh,new_name){if(!new_name)var new_name=mesh["name"]+"_COPY";var materials=mesh["materials"];var submeshes=mesh["submeshes"];mesh["materials"]=null;mesh["submeshes"]=null;var mesh_new=m_util.clone_object_json(mesh);mesh["materials"]=materials;mesh["submeshes"]=submeshes;mesh_new["name"]=
new_name;mesh_new["materials"]=mesh["materials"].slice(0);mesh_new["submeshes"]=[];for(var i=0;i<submeshes.length;i++){var submesh=submeshes[i];var submesh_new=m_util.clone_object_nr(submesh);mesh_new["submeshes"].push(submesh_new)}return mesh_new}function mesh_join(mesh,mesh2){for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];var submesh2=mesh2["submeshes"][i];var base_length=submesh["base_length"];var index_length=submesh["indices"].length;submesh["base_length"]+=submesh2["base_length"];
for(var prop in submesh){if(prop=="base_length"||prop=="boundings")continue;if(prop=="indices"){submesh[prop]=m_util.uint32_concat(submesh[prop],submesh2[prop]);for(var j=index_length;j<submesh["indices"].length;j++)submesh["indices"][j]+=base_length}else if(prop=="vertex_colors");else submesh[prop]=m_util.float32_concat(submesh[prop],submesh2[prop])}}return mesh}function mesh_transform_locations(mesh,matrix){for(var i=0;i<mesh["submeshes"].length;i++){var submesh=mesh["submeshes"][i];m_util.positions_multiply_matrix(submesh["position"],
matrix,submesh["position"],0);m_util.vectors_multiply_matrix(submesh["normal"],matrix,submesh["normal"],0);m_util.tangents_multiply_matrix(submesh["tangent"],matrix,submesh["tangent"],0)}}exports.assign_logic_nodes_object_params=function(bpy_objects,bpy_world,scene){function set_bpy_objs_props(objects_paths,props){for(var id in objects_paths){var path=objects_paths[id];var name=path[0];if(path.length>1)for(var k=1;k<path.length;k++)name+="*"+path[k];for(var k=0;k<bpy_objects.length;k++){var bpy_obj=
bpy_objects[k];if(bpy_obj["name"]==name)for(var key in props)bpy_obj[key]=props[key]}}}var script=scene["b4w_logic_nodes"];for(var i=0;i<script.length;i++){var subtree=script[i];for(var j=0;j<subtree.length;j++){var snode=subtree[j];var rename={"register1":"variable1","register2":"variable2","registerd":"variabled"};for(var key in rename)if(key in snode)snode[rename[key]]=snode[key];for(var v in snode["variables"])if(typeof snode["variables"][v][0]!="boolean")snode["variables"][v]=[false,snode["variables"][v]];
if(["MATH","CONDJUMP","PAGEPARAM","REGSTORE"].indexOf(snode["type"])>=0){if("variable1"in snode)snode["variables"]["v1"]=[false,snode["variable1"]];if("variable2"in snode)snode["variables"]["v2"]=[false,snode["variable2"]];if("variabled"in snode)snode["variables"]["vd"]=[false,snode["variabled"]]}switch(snode["type"]){case "SELECT":for(var k=0;k<bpy_objects.length;k++){var bpy_obj=bpy_objects[k];if(bpy_obj["name"]==snode["object"])bpy_obj["b4w_selectable"]=true}if(!snode["bools"])snode["bools"]={};
if(!snode["bools"]["not_wait"])snode["bools"]["not_wait"]=false;report_raw('Logic nodes type "SELECT" is deprecated');break;case "SWITCH_SELECT":set_bpy_objs_props(snode["objects_paths"],{"b4w_selectable":true});if(snode["links"]instanceof Array){report_raw('Format of a "SWITCH_SELECT" node is outdated. '+'It is recommended to reexport the scene "'+scene.name+'"');var links={};var kk=0;for(k in snode["objects_paths"]){links[k]=snode["links"][kk];kk++}snode["links"]=links}break;case "SELECT_PLAY":report_raw('Logic nodes type "SELECT_PLAY" is deprecated, '+
'node will be muted. To fix this, reexport the scene "'+scene.name+'"');snode["mute"]=true;break;case "SELECT_PLAY_ANIM":report_raw('Logic nodes type "SELECT_PLAY_ANIM" is deprecated');break;case "SHOW":case "HIDE":case "SET_SHADER_NODE_PARAM":case "INHERIT_MAT":set_bpy_objs_props(snode["objects_paths"],{"b4w_do_not_batch":true});break;case "PLAY":scene["b4w_use_nla"]=true;break;case "MOVE_TO":set_bpy_objs_props(snode["objects_paths"],{"b4w_do_not_batch":true});break;case "TRANSFORM_OBJECT":set_bpy_objs_props(snode["objects_paths"],
{"b4w_do_not_batch":true});break;case "OUTLINE":set_bpy_objs_props(snode["objects_paths"],{"b4w_outlining":true});break;case "CONDJUMP":if(snode["condition"])snode["common_usage_names"]["condition"]=snode["condition"];if("cnd"in snode["floats"])snode["common_usage_names"]["condition"]=snode["floats"]["cnd"];else switch(snode["common_usage_names"]["condition"]){case "GEQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_GEQUAL;break;case "LEQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_LEQUAL;
break;case "GREATER":snode["common_usage_names"]["condition"]=m_logn.NC_GREATER;break;case "LESS":snode["common_usage_names"]["condition"]=m_logn.NC_LESS;break;case "NOTEQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_NOTEQUAL;break;case "EQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_EQUAL;break}if(snode["number1"]!=undefined)snode["input1"]=snode["number1"];if(snode["number2"]!=undefined)snode["input2"]=snode["number2"];if(!snode["bools"])snode["bools"]={};if(snode["bools"]["str"]===
undefined){snode["bools"]["str"]=false;snode["floats"]["inp1"]=snode["input1"];snode["floats"]["inp2"]=snode["input2"]}break;case "SEND_REQ":if(!snode["bools"])snode["bools"]={};if(!snode["strings"])snode["strings"]={};if(snode["bools"]["ct"]===undefined)snode["bools"]["ct"]=false;if(snode["url"]!=undefined){snode["bools"]["url"]=false;snode["strings"]["url"]=snode["url"]}break;case "MATH":if(snode["number1"]!=undefined)snode["input1"]=snode["number1"];if(snode["number2"]!=undefined)snode["input2"]=
snode["number2"];if(snode["input1"]!=undefined)snode["floats"]["inp1"]=snode["input1"];if(snode["input2"]!=undefined)snode["floats"]["inp2"]=snode["input2"];break;case "REGSTORE":if(!snode["floats"])snode["floats"]={};if(!snode["strings"])snode["strings"]={};if(snode["number1"]!=undefined)snode["input1"]=snode["number1"];if(snode["input1"]!=undefined)switch(typeof snode["input1"]){case "number":snode["floats"]["inp1"]=snode["input1"];snode["common_usage_names"]["variable_type"]="NUMBER";break;default:snode["strings"]["inp1"]=
snode["input1"];snode["common_usage_names"]["variable_type"]="STRING"}switch(snode["common_usage_names"]["variable_type"]){case "NUMBER":snode["common_usage_names"]["variable_type"]=m_logn.NT_NUMBER;break;case "STRING":snode["common_usage_names"]["variable_type"]=m_logn.NT_STRING;break}break;case "PAGEPARAM":if(!snode["bools"])snode["bools"]={};if(snode["bools"]["hsh"]===undefined)snode["bools"]["hsh"]=false;if(!snode["floats"])snode["floats"]={};if(snode["floats"]["ptp"]===undefined)snode["floats"]["ptp"]=
0;break;case "PLAY_ANIM":set_bpy_objs_props(snode["objects_paths"],{"b4w_do_not_batch":true});if(!snode["bools"])snode["bools"]={};if(snode["bools"]["env"]===undefined)snode["bools"]["env"]=false;break;case "STOP_ANIM":if(!snode["bools"])snode["bools"]={};if(snode["bools"]["env"]===undefined)snode["bools"]["env"]=false;break;case "STRING":if("cnd"in snode["floats"])snode["common_usage_names"]["condition"]=snode["floats"]["cnd"];else switch(snode["common_usage_names"]["condition"]){case "GEQUAL":snode["common_usage_names"]["condition"]=
m_logn.NC_GEQUAL;break;case "LEQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_LEQUAL;break;case "GREATER":snode["common_usage_names"]["condition"]=m_logn.NC_GREATER;break;case "LESS":snode["common_usage_names"]["condition"]=m_logn.NC_LESS;break;case "NOTEQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_NOTEQUAL;break;case "EQUAL":snode["common_usage_names"]["condition"]=m_logn.NC_EQUAL;break}break;case "REDIRECT":if(snode["url"]!=undefined){snode["bools"]["url"]=false;snode["strings"]["url"]=
snode["url"]}break;case "ENTRYPOINT":if(!snode["bools"])snode["bools"]={};if(snode["bools"]["js"]===undefined)snode["bools"]["js"]=false;if(snode["bools"]["js"])snode["mute"]=true;break;case "JS_CALLBACK":var cb_params_dict=snode["common_usage_names"]["js_cb_params"];for(var key in cb_params_dict)switch(cb_params_dict[key]){case "OBJECT":cb_params_dict[key]=m_logn.NCPT_OBJECT;break;case "VARIABLE":cb_params_dict[key]=m_logn.NCPT_VARIABLE;break}break}}}}};b4w.module["__scenegraph"]=function(exports,require){var m_cam=require("__camera");var m_cfg=require("__config");var m_debug=require("__debug");var m_graph=require("__graph");var m_render=require("__renderer");var m_scs=require("__scenes");var m_tex=require("__textures");var m_util=require("__util");var cfg_dbg=m_cfg.debug_subs;var cfg_def=m_cfg.defaults;var cfg_out=m_cfg.outlining;var cfg_scs=m_cfg.scenes;var DEBUG_DISABLE_TEX_REUSE=false;var LEFT_ONLY_SUBS_TYPES=["GRASS_MAP","SHADOW_CAST","MAIN_CUBE_REFLECT",
"MAIN_CUBE_REFLECT_BLEND"];function cam_copy(cam){var dof_object=cam.dof_object;cam.dof_object=null;var cam_new=m_util.clone_object_r(cam);cam_new.dof_object=dof_object;cam.dof_object=dof_object;cam_new.framebuffer=null;cam_new.color_attachment=null;cam_new.depth_attachment=null;return cam_new}function enforce_graph_consistency(graph,depth_tex){var slinks=[];m_graph.traverse_edges(graph,function(node1,node2,attr){var slink=attr;if(slinks.indexOf(slink)>-1)m_graph.replace_edge_attr(graph,node1,node2,
slink,clone_slink(slink));else slinks.push(slink)});m_graph.traverse(graph,function(id,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(!depth_tex&&(subs.type=="MAIN_PLANE_REFLECT"||subs.type=="MAIN_CUBE_REFLECT"||subs.type=="MAIN_XRAY"))slink.use_renderbuffer=true;if(slinks.indexOf(slink)>-1)subs.slinks_internal[i]=clone_slink(slink);else slinks.push(slink)}if(subs.type=="ANTIALIASING")m_graph.traverse_inputs(graph,id,function(id_in,attr_in,
attr_edge){var subs_in=attr_in;if(subs_in.type=="MOTION_BLUR")for(var i=0;i<subs_in.slinks_internal.length;i++){var slink_mb_int=subs_in.slinks_internal[i];slink_mb_int.min_filter=m_tex.TF_LINEAR;slink_mb_int.mag_filter=m_tex.TF_LINEAR}});if(!depth_tex)m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var subs=attr_in;var slink=attr_edge;if(slink.from=="DEPTH")slink.use_renderbuffer=true})});m_graph.traverse(graph,function(id,attr){var subs=attr;var dest={};combine_same_slinks(graph,
id,dest);for(var i in dest){var slinks=dest[i];var min_filt_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(slinks[j].min_filter==m_tex.TF_LINEAR){min_filt_slink=slinks[j];break}var mag_filt_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(slinks[j].mag_filter==m_tex.TF_LINEAR){mag_filt_slink=slinks[j];break}var not_rb_slink=slinks[0];for(var j=0;j<slinks.length;j++)if(!slinks[j].use_renderbuffer){not_rb_slink=slinks[j];break}for(var j=0;j<slinks.length;j++){slinks[j].min_filter=min_filt_slink.min_filter;
slinks[j].mag_filter=mag_filt_slink.mag_filter;slinks[j].use_renderbuffer=not_rb_slink.use_renderbuffer}}})}function combine_same_slinks(graph,id,dest){m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;if(!slink.active)return;if(slink.from==slink.to){dest[slink.from]=dest[slink.from]||[];if(dest[slink.from].indexOf(slink)==-1)dest[slink.from].push(slink);combine_same_slinks(graph,id_in,dest)}});m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=
attr_edge;if(!slink.active)return;dest[slink.from]=dest[slink.from]||[];if(dest[slink.from].indexOf(slink)==-1)dest[slink.from].push(slink)});var subs=m_graph.get_node_attr(graph,id);if(subs.type=="MOTION_BLUR")for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];dest[slink.from].push(slink)}}exports.check_slink_tex_conn=function(slink){switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "SCREEN":case "OFFSCREEN":case "RESOLVE":case "COPY":case "NONE":return false;
default:return true}};function process_subscene_links(graph){var FORCE_UNIQUE_TEXTURE_SUBS=["MOTION_BLUR","SMAA_RESOLVE","SMAA_NEIGHBORHOOD_BLENDING","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT"];var graph_sorted=m_graph.topsort(graph);var tex_storage=[];m_graph.traverse(graph_sorted,function(id,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(FORCE_UNIQUE_TEXTURE_SUBS.indexOf(subs.type)>-1)slink.unique_texture=true;var tex=tex_aquire(tex_storage,
slink,calc_slink_id(slink));slink.texture=tex;subs.textures_internal[i]=tex}for(var i=0;i<subs.textures_internal.length;i++){var tex=subs.textures_internal[i];tex_dec_ref(tex_storage,tex)}m_graph.traverse_outputs(graph_sorted,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(FORCE_UNIQUE_TEXTURE_SUBS.indexOf(subs.type)>-1)slink.unique_texture=true;if(slink.texture)return;var tex=find_nearest_tex(graph_sorted,id,slink.from);if(tex&&slink.active&&!slink.texture){tex_inc_ref(tex_storage,
tex);slink.texture=tex;return}var tex=tex_aquire(tex_storage,slink,calc_slink_id(slink));slink.texture=tex});m_graph.traverse_inputs(graph_sorted,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;var subs_in=attr_in;tex_dec_ref(tex_storage,slink.texture)});m_graph.traverse_outputs(graph_sorted,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.texture&&slink.to=="NONE")tex_dec_ref(tex_storage,slink.texture)})})}function calc_slink_id(slink){var id_obj=m_util.clone_object_json(slink);
delete id_obj.to;delete id_obj.active;delete id_obj.texture;return JSON.stringify(id_obj)}function find_nearest_tex(graph,id,type){var tex=null;m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==slink.to&&slink.from==type&&slink.texture){tex=slink.texture;return true}});m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==type&&slink.texture){tex=slink.texture;return true}});
return tex}function tex_inc_ref(storage,tex){for(var i=0;i<storage.length;i++){var item=storage[i];if(item.tex===tex)item.ref++}}function tex_dec_ref(storage,tex){for(var i=0;i<storage.length;i++){var item=storage[i];if(item.tex===tex&&item.ref)item.ref--}}function tex_aquire(storage,slink,slink_id){if(slink.parent_slink){tex_inc_ref(storage,slink.parent_slink.texture);return slink.parent_slink.texture}if(slink.unique_texture)return tex_create_for_slink(slink);var storage_item_free=null;for(var i=
0;i<storage.length;i++){var item=storage[i];if(item.id==slink_id&&item.ref===0){storage_item_free=item;break}}if(storage_item_free&&!(DEBUG_DISABLE_TEX_REUSE||cfg_def.macos_tex_reuse_hack)){storage_item_free.ref++;return storage_item_free.tex}else{var tex=tex_create_for_slink(slink);storage.push({id:slink_id,ref:1,tex:tex});return tex}}function tex_create_for_slink(slink){var size_x=slink.size_mult_x*slink.size;var size_y=slink.size_mult_y*slink.size;switch(slink.from){case "COLOR":if(slink.use_renderbuffer){var tex=
m_tex.create_texture("COLOR_RB",slink.multisample?m_tex.TT_RB_RGBA_MS:m_tex.TT_RB_RGBA);m_tex.resize(tex,size_x,size_y)}else{var tex=m_tex.create_texture("COLOR",m_tex.TT_RGBA_INT);m_tex.resize(tex,size_x,size_y);m_tex.set_filters(tex,slink.min_filter,slink.mag_filter)}return tex;case "DEPTH":if(slink.use_renderbuffer){var tex=m_tex.create_texture("DEPTH_RB",slink.multisample?m_tex.TT_RB_DEPTH_MS:m_tex.TT_RB_DEPTH);m_tex.resize(tex,size_x,size_y)}else{var tex=m_tex.create_texture("DEPTH_TEX",m_tex.TT_DEPTH);
m_tex.resize(tex,size_x,size_y);m_tex.set_filters(tex,slink.min_filter,slink.mag_filter)}return tex;case "CUBEMAP":var tex=m_tex.create_cubemap_texture("CUBEMAP",size_x);return tex;case "SCREEN":case "NONE":return null;default:throw"Wrong slink param: "+slink.from;}}exports.traverse_slinks=traverse_slinks;function traverse_slinks(graph,callback){var exit=false;m_graph.traverse_edges(graph,function(node1,node2,attr){var slink=attr;if(!slink)return;var subs1=m_graph.get_node_attr(graph,node1);var subs2=
m_graph.get_node_attr(graph,node2);if(callback(slink,false,subs1,subs2)){exit=true;return true}});if(exit)return;m_graph.traverse(graph,function(node,attr){var subs=attr;for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(callback(slink,true,subs,null))return true}})}function assign_render_targets(graph){m_graph.traverse(graph,function(nid,subs){if(subs.type=="SINK")return;var cam=subs.camera;m_graph.traverse_outputs(graph,nid,function(nid_out,subs_out,slink){if(slink.active&&
slink.texture){m_cam.set_attachment(cam,slink.from,slink.texture);if(slink.from==slink.to&&subs_out.camera)m_cam.set_attachment(subs_out.camera,slink.from,slink.texture)}});for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(slink.active&&slink.from==slink.to){var tex=subs.textures_internal[i];m_cam.set_attachment(cam,slink.from,tex)}}if((cam.color_attachment||cam.depth_attachment)&&!cam.framebuffer)cam.framebuffer=m_render.render_target_create(cam.color_attachment,
cam.depth_attachment)});m_graph.traverse(graph,function(nid,subs){if(subs.type=="RESOLVE"||subs.type=="COPY"){var inputs=get_inputs(graph,subs);var cam=subs.camera;cam.framebuffer_prev=inputs[0].camera.framebuffer}})}exports.create_rendering_graph=function(sc_render,cam_scene_data,cam_render,render_to_textures){var graph=m_graph.create();var prev_level=[];var curr_level=[];var shadow_subscenes=[];var shadow_links=[];var reflect_subscenes=[];var reflect_links=[];var cube_refl_subscenes=[];var cube_reflect_links=
[];var num_lights=sc_render.lamps_number;var water_params=sc_render.water_params;var shore_smoothing=sc_render.shore_smoothing;var soft_particles=sc_render.soft_particles;var ssao=sc_render.ssao;var god_rays=sc_render.god_rays;var refl_params=sc_render.reflection_params;var mat_params=sc_render.materials_params;var bloom_params=sc_render.bloom_params;var motion_blur=sc_render.motion_blur;var compositing=sc_render.compositing;var antialiasing=sc_render.antialiasing;var wls_params=sc_render.world_light_set;
var wfs_params=sc_render.world_fog_set;var shadow_params=sc_render.shadow_params;var mb_params=sc_render.mb_params;var cc_params=sc_render.cc_params;var gr_params=sc_render.god_rays_params;var outline_params=sc_render.outline_params;var dof=sc_render.dof;var depth_tex=sc_render.depth_tex;var refractions=sc_render.refractions;var rtt=Boolean(render_to_textures.length);var msaa=cfg_def.msaa_samples>1;var slink_color_o=create_slink("COLOR","COLOR",1,1,1,true);var slink_depth_o=create_slink("DEPTH","DEPTH",
1,1,1,true);if(msaa){var slink_color_resolve_o=clone_slink(slink_depth_o);var slink_depth_resolve_o=clone_slink(slink_depth_o);slink_color_o.multisample=true;slink_color_o.use_renderbuffer=true;slink_depth_o.multisample=true;slink_depth_o.use_renderbuffer=true}var main_cam=cam_scene_data.cameras[0];if(shadow_params){m_cam.update_camera_shadows(main_cam,shadow_params);for(var j=0;j<shadow_params.lamp_types.length;j++){var csm_num=shadow_params.csm_num;for(var i=0;i<csm_num;i++){var subs_shadow=create_subs_shadow_cast(i,
j,shadow_params,num_lights);m_graph.append_node_attr(graph,subs_shadow);shadow_subscenes.push(subs_shadow);var tex_size=shadow_params.csm_resolution;var cam=subs_shadow.camera;cam_scene_data.shadow_cameras.push(cam);cam.width=tex_size;cam.height=tex_size;subs_shadow.clear_color=false;var index=j>0?j:i;shadow_links.push(create_slink("DEPTH","u_shadow_map"+index,tex_size,1,1,false));if(m_debug.check_depth_only_issue()||cfg_def.firefox_shadows_slink_hack)subs_shadow.slinks_internal.push(create_slink("COLOR",
"COLOR",tex_size,1,1,false))}}}if(refl_params&&refl_params.num_cube_refl&&!rtt)for(var i=0;i<refl_params.num_cube_refl;i++){var cam=m_cam.create_camera(m_cam.TYPE_PERSP);cam.width=sc_render.cubemap_refl_size;cam.height=sc_render.cubemap_refl_size;m_cam.set_frustum(cam,90,.1,100);m_cam.set_projection(cam,cam.aspect);var subs_refl=create_subs_main("CUBE_REFLECT",cam,false,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);subs_refl.cube_view_matrices=m_util.generate_inv_cubemap_matrices();
for(var j=0;j<6;j++)subs_refl.cube_cam_frustums.push(m_cam.create_frustum_planes());m_graph.append_node_attr(graph,subs_refl);var slink_refl_c=create_slink("CUBEMAP","u_cube_reflection",sc_render.cubemap_refl_size,1,1,false);slink_refl_c.min_filter=m_tex.TF_LINEAR;slink_refl_c.mag_filter=m_tex.TF_LINEAR;cube_reflect_links.push(slink_refl_c);if(refl_params.has_blend_reflexible){var subs_refl_blend=create_subs_main("CUBE_REFLECT_BLEND",cam,false,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);
subs_refl_blend.cube_view_matrices=subs_refl.cube_view_matrices;subs_refl_blend.cube_cam_frustums=subs_refl.cube_cam_frustums;m_graph.append_node_attr(graph,subs_refl_blend);var slink_depth_refl=create_slink("DEPTH","DEPTH",sc_render.cubemap_refl_size,1,1,false);var slink_color_refl=create_slink("COLOR","COLOR",sc_render.cubemap_refl_size,1,1,false);m_graph.append_edge_attr(graph,subs_refl,subs_refl_blend,slink_depth_refl);m_graph.append_edge_attr(graph,subs_refl,subs_refl_blend,slink_color_refl);
cube_refl_subscenes.push(subs_refl_blend);refl_params.cube_refl_subs_blend.push(subs_refl_blend)}else{var slink_refl_d=create_slink("DEPTH","DEPTH",sc_render.cubemap_refl_size,1,1,false);subs_refl.slinks_internal.push(slink_refl_d);cube_refl_subscenes.push(subs_refl)}refl_params.cube_refl_subs.push(subs_refl)}if(refl_params&&refl_params.refl_plane_objs.length>0&&!rtt)for(var j=0;j<refl_params.refl_plane_objs.length;j++){var cam=cam_copy(main_cam);cam.reflection_plane=new Float32Array(4);cam_scene_data.cameras.push(cam);
var subs_refl=create_subs_main("PLANE_REFLECT",cam,false,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);m_graph.append_node_attr(graph,subs_refl);var slink_refl_c=create_slink("COLOR","u_plane_reflection",sc_render.plane_refl_size,1,1,true);slink_refl_c.min_filter=m_tex.TF_LINEAR;slink_refl_c.mag_filter=m_tex.TF_LINEAR;reflect_links.push(slink_refl_c);if(refl_params.has_blend_reflexible){var subs_refl_blend=create_subs_main("PLANE_REFLECT_BLEND",cam,false,water_params,num_lights,
wfs_params,wls_params,null,sc_render.sun_exist);m_graph.append_node_attr(graph,subs_refl_blend);var slink_depth_refl=create_slink("DEPTH","DEPTH",sc_render.plane_refl_size,1,1,true);var slink_color_refl=create_slink("COLOR","COLOR",sc_render.plane_refl_size,1,1,true);slink_color_refl.min_filter=m_tex.TF_NEAREST;slink_color_refl.mag_filter=m_tex.TF_NEAREST;m_graph.append_edge_attr(graph,subs_refl,subs_refl_blend,slink_depth_refl);m_graph.append_edge_attr(graph,subs_refl,subs_refl_blend,slink_color_refl);
refl_params.plane_refl_subs_blend.push([subs_refl_blend]);reflect_subscenes.push(subs_refl_blend)}else{var slink_refl_d=create_slink("DEPTH","DEPTH",sc_render.plane_refl_size,1,1,true);subs_refl.slinks_internal.push(slink_refl_d);reflect_subscenes.push(subs_refl)}refl_params.plane_refl_subs.push([subs_refl])}if(sc_render.dynamic_grass){var subs_grass_map=create_subs_grass_map();m_graph.append_node_attr(graph,subs_grass_map);var tex_size=cfg_scs.grass_tex_size;subs_grass_map.camera.width=tex_size;
subs_grass_map.camera.height=tex_size;var slink_grass_map_d=create_slink("DEPTH","u_grass_map_depth",tex_size,1,1,false);slink_grass_map_d.min_filter=m_tex.TF_LINEAR;slink_grass_map_d.mag_filter=m_tex.TF_LINEAR;var slink_grass_map_c=create_slink("COLOR","u_grass_map_color",tex_size,1,1,false);slink_grass_map_c.min_filter=m_tex.TF_LINEAR;slink_grass_map_c.mag_filter=m_tex.TF_LINEAR}else{var subs_grass_map=null;var slink_grass_map_d=null;var slink_grass_map_c=null}if(depth_tex&&shadow_params){var cam_sh_receive=
cam_copy(main_cam);cam_scene_data.cameras.push(cam_sh_receive);var subs_receive=create_subs_shadow_receive(graph,cam_sh_receive,num_lights);m_graph.append_node_attr(graph,subs_receive);subs_receive.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;for(var i=0;i<shadow_subscenes.length;i++){var subs_shadow=shadow_subscenes[i];var slink_shadow=shadow_links[i];m_graph.append_edge_attr(graph,subs_shadow,subs_receive,slink_shadow)}var slink_depth_c=create_slink("COLOR","u_color",1,1,1,
true);var slink_depth_d=create_slink("DEPTH","u_depth",1,1,1,true);if(ssao){var cam_ssao=cam_copy(main_cam);cam_scene_data.cameras.push(cam_ssao);var ssao_params=sc_render.ssao_params;var subs_ssao=create_subs_ssao(cam_ssao,wfs_params,ssao_params);m_graph.append_node_attr(graph,subs_ssao);var slink_ssao=create_slink("COLOR","u_ssao_mask",1,1,1,true);m_graph.append_edge_attr(graph,subs_receive,subs_ssao,slink_depth_c);m_graph.append_edge_attr(graph,subs_receive,subs_ssao,slink_depth_d);var cam_ssao_blur=
cam_copy(main_cam);cam_scene_data.cameras.push(cam_ssao_blur);var subs_ssao_blur=create_subs_ssao_blur(cam_ssao_blur,ssao_params);m_graph.append_node_attr(graph,subs_ssao_blur);var slink_ssao_blur=create_slink("COLOR","u_shadow_mask",1,1,1,true);m_graph.append_edge_attr(graph,subs_ssao,subs_ssao_blur,slink_ssao);m_graph.append_edge_attr(graph,subs_receive,subs_ssao_blur,slink_depth_d)}if(msaa)subs_receive.slinks_internal.push(create_slink("DEPTH","DEPTH",1,1,1,true));else subs_receive.slinks_internal.push(slink_depth_o);
if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_receive,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_receive,slink_grass_map_c)}}else var subs_receive=null;var subs_main_opaque=create_subs_main("OPAQUE",main_cam,true,water_params,num_lights,wfs_params,wls_params,null,sc_render.sun_exist);m_graph.append_node_attr(graph,subs_main_opaque);if(msaa){var subs_res_opaque=create_subs_resolve();m_graph.append_node_attr(graph,subs_res_opaque);curr_level.push(subs_res_opaque);
var slink_resolve_in_c=create_slink("COLOR","RESOLVE",1,1,1,true);slink_resolve_in_c.multisample=true;slink_resolve_in_c.use_renderbuffer=true;var slink_resolve_in_d=create_slink("DEPTH","RESOLVE",1,1,1,true);slink_resolve_in_d.multisample=true;slink_resolve_in_d.use_renderbuffer=true;m_graph.append_edge_attr(graph,subs_main_opaque,subs_res_opaque,slink_resolve_in_c);m_graph.append_edge_attr(graph,subs_main_opaque,subs_res_opaque,slink_resolve_in_d);if(subs_receive)if(slink_ssao)m_graph.append_edge_attr(graph,
subs_ssao_blur,subs_main_opaque,slink_ssao_blur);else if(shadow_params)m_graph.append_edge_attr(graph,subs_receive,subs_main_opaque,create_slink("COLOR","u_shadow_mask",1,1,1,true));else m_util.panic("Internal error")}else{curr_level.push(subs_main_opaque);if(subs_receive)if(slink_ssao)m_graph.append_edge_attr(graph,subs_ssao_blur,subs_main_opaque,slink_ssao_blur);else if(shadow_params)m_graph.append_edge_attr(graph,subs_receive,subs_main_opaque,create_slink("COLOR","u_shadow_mask",1,1,1,true));else m_util.panic("Internal error")}if(subs_grass_map){m_graph.append_edge_attr(graph,
subs_grass_map,subs_main_opaque,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_main_opaque,slink_grass_map_c)}if(reflect_subscenes.length){var num_refl_subs=reflect_subscenes.length;for(var j=0;j<num_refl_subs;j++)m_graph.append_edge_attr(graph,reflect_subscenes[j],subs_main_opaque,reflect_links[j])}if(cube_refl_subscenes.length)for(var j=0;j<cube_refl_subscenes.length;j++)m_graph.append_edge_attr(graph,cube_refl_subscenes[j],subs_main_opaque,cube_reflect_links[j]);prev_level=
curr_level;curr_level=[];if(!rtt&&sc_render.color_picking){var cam=cam_copy(main_cam);cam_scene_data.cameras.push(cam);var subs_color_picking=create_subs_color_picking(cam,false,num_lights);m_graph.append_node_attr(graph,subs_color_picking);if(sc_render.xray){var cam=cam_copy(main_cam);cam_scene_data.cameras.push(cam);var subs_color_picking_xray=create_subs_color_picking(cam,true,num_lights);m_graph.append_node_attr(graph,subs_color_picking_xray);var cp_slink_c=create_slink("COLOR","COLOR",1,1,1,
true);m_graph.append_edge_attr(graph,subs_color_picking,subs_color_picking_xray,cp_slink_c);var cp_slink_d=create_slink("DEPTH","DEPTH",1,1,1,true);m_graph.append_edge_attr(graph,subs_color_picking,subs_color_picking_xray,cp_slink_d)}}else var subs_color_picking=null;if((mat_params.refractions||refractions)&&!rtt){if(!msaa){var subs_refr=create_subs_copy();m_graph.append_node_attr(graph,subs_refr);var slink_refr_in=create_slink("COLOR","COPY",1,1,1,true);m_graph.append_edge_attr(graph,prev_level[0],
subs_refr,slink_refr_in)}else var subs_refr=subs_res_opaque;var slink_refr=create_slink("COLOR","u_refractmap",1,1,1,true)}else var subs_refr=null;if(depth_tex&&(refractions||shore_smoothing||soft_particles)){var cam_depth_pack=cam_copy(main_cam);cam_scene_data.cameras.push(cam_depth_pack);var subs_depth_pack=create_subs_depth_pack(cam_depth_pack);m_graph.append_node_attr(graph,subs_depth_pack);var slink_depth_pack_in=create_slink("DEPTH","u_depth",1,1,1,true);m_graph.append_edge_attr(graph,msaa?
subs_res_opaque:subs_main_opaque,subs_depth_pack,slink_depth_pack_in);var slink_depth_pack_out=create_slink("COLOR","u_scene_depth",1,1,1,true);slink_depth_pack_out.min_filter=m_tex.TF_NEAREST;slink_depth_pack_out.mag_filter=m_tex.TF_NEAREST}else var subs_depth_pack=null;var create_custom_sub_main=function(type){var cam=cam_copy(main_cam);cam_scene_data.cameras.push(cam);var subs_main=create_subs_main(type,cam,false,water_params,num_lights,wfs_params,wls_params,shadow_params,sc_render.sun_exist);
m_graph.append_node_attr(graph,subs_main);if(type=="XRAY"){var slink_color=create_slink("COLOR","COLOR",1,1,1,true);m_graph.append_edge_attr(graph,prev_level[0],subs_main,slink_color);var slink_depth=create_slink("DEPTH","DEPTH",1,1,1,true);subs_main.slinks_internal.push(slink_depth)}else{if(msaa&&prev_level[0].type=="RESOLVE")var subs_prev=subs_main_opaque;else var subs_prev=prev_level[0];m_graph.append_edge_attr(graph,subs_prev,subs_main,slink_depth_o);m_graph.append_edge_attr(graph,subs_prev,subs_main,
slink_color_o)}if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_main,slink_grass_map_c)}for(var i=0;i<shadow_subscenes.length;i++){var subs_shadow=shadow_subscenes[i];var slink_shadow=shadow_links[i];m_graph.append_edge_attr(graph,subs_shadow,subs_main,slink_shadow)}if(subs_depth_pack)m_graph.append_edge_attr(graph,subs_depth_pack,subs_main,slink_depth_pack_out);if(reflect_subscenes.length){var num_refl_subs=
reflect_subscenes.length;for(var i=0;i<num_refl_subs;i++)m_graph.append_edge_attr(graph,reflect_subscenes[i],subs_main,reflect_links[i])}if(cube_refl_subscenes.length)for(var i=0;i<cube_refl_subscenes.length;i++)m_graph.append_edge_attr(graph,cube_refl_subscenes[i],subs_main,cube_reflect_links[i]);if(subs_refr)m_graph.append_edge_attr(graph,subs_refr,subs_main,slink_refr);return subs_main};if(sc_render.glow_over_blend){var subs_main_blend=create_custom_sub_main("BLEND");curr_level.push(subs_main_blend);
prev_level=curr_level;curr_level=[]}if(sc_render.glow_materials){var cam_glow=cam_copy(main_cam);cam_scene_data.cameras.push(cam_glow);var subs_main_glow=create_subs_main("GLOW",cam_glow,false,water_params,num_lights,wfs_params,wls_params);m_graph.append_node_attr(graph,subs_main_glow);if(subs_depth_pack)m_graph.append_edge_attr(graph,subs_depth_pack,subs_main_glow,slink_depth_pack_out);if(subs_refr)m_graph.append_edge_attr(graph,subs_refr,subs_main_glow,slink_refr);m_graph.append_edge_attr(graph,
msaa?subs_res_opaque:subs_main_opaque,subs_main_glow,msaa?slink_depth_resolve_o:slink_depth_o);var blur_x=create_subs_postprocessing("X_GLOW_BLUR");blur_x.subtype="GLOW_MASK_SMALL";set_texel_size_mult(blur_x,sc_render.glow_params.small_glow_mask_width);var slink_blur_x=create_slink("COLOR","u_color",1,1,1,true);slink_blur_x.min_filter=m_tex.TF_LINEAR;slink_blur_x.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_x);m_graph.append_edge_attr(graph,subs_main_glow,blur_x,slink_blur_x);var blur_y=
create_subs_postprocessing("Y_GLOW_BLUR");blur_y.subtype="GLOW_MASK_SMALL";set_texel_size_mult(blur_y,sc_render.glow_params.small_glow_mask_width);var slink_blur_y=create_slink("COLOR","u_color",1,.5,.5,true);slink_blur_y.min_filter=m_tex.TF_LINEAR;slink_blur_y.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_y);m_graph.append_edge_attr(graph,blur_x,blur_y,slink_blur_y);var blur_x2=create_subs_postprocessing("X_GLOW_BLUR");blur_x2.subtype="GLOW_MASK_LARGE";set_texel_size_mult(blur_x2,
sc_render.glow_params.large_glow_mask_width);var slink_blur_x2=create_slink("COLOR","u_color",1,.5,.5,true);slink_blur_x2.min_filter=m_tex.TF_LINEAR;slink_blur_x2.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_x2);m_graph.append_edge_attr(graph,blur_y,blur_x2,slink_blur_x2);var blur_y2=create_subs_postprocessing("Y_GLOW_BLUR");blur_y2.subtype="GLOW_MASK_LARGE";set_texel_size_mult(blur_y2,sc_render.glow_params.large_glow_mask_width);var slink_blur_y2=create_slink("COLOR","u_color",
1,.25,.25,true);slink_blur_y2.min_filter=m_tex.TF_LINEAR;slink_blur_y2.mag_filter=m_tex.TF_LINEAR;m_graph.append_node_attr(graph,blur_y2);m_graph.append_edge_attr(graph,blur_x2,blur_y2,slink_blur_y2);var cam_glow_combine=cam_copy(main_cam);cam_scene_data.cameras.push(cam_glow_combine);var subs_glow_combine=create_subs_glow_combine(cam_glow_combine,sc_render);m_graph.append_node_attr(graph,subs_glow_combine);var slink_c_src=create_slink("COLOR","u_src_color",1,1,1,true);if(sc_render.glow_over_blend)if(msaa){var subs_res_blend=
create_subs_resolve();m_graph.append_node_attr(graph,subs_res_blend);m_graph.append_edge_attr(graph,subs_main_blend,subs_res_blend,slink_resolve_in_c);m_graph.append_edge_attr(graph,subs_main_blend,subs_res_blend,slink_resolve_in_d);m_graph.append_edge_attr(graph,subs_res_blend,subs_glow_combine,slink_c_src)}else m_graph.append_edge_attr(graph,subs_main_blend,subs_glow_combine,slink_c_src);else m_graph.append_edge_attr(graph,msaa?subs_res_opaque:subs_main_opaque,subs_glow_combine,slink_c_src);var subs_depth_in=
sc_render.glow_over_blend?subs_main_blend:subs_main_opaque;m_graph.append_edge_attr(graph,subs_depth_in,subs_glow_combine,slink_depth_o);var slink_c_y=create_slink("COLOR","u_glow_mask_small",1,.5,.5,true);slink_c_y.min_filter=m_tex.TF_LINEAR;slink_c_y.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,blur_y,subs_glow_combine,slink_c_y);var slink_c_y2=create_slink("COLOR","u_glow_mask_large",1,.25,.25,true);slink_c_y2.min_filter=m_tex.TF_LINEAR;slink_c_y2.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,
blur_y2,subs_glow_combine,slink_c_y2);prev_level=[subs_glow_combine];curr_level=[]}if(!sc_render.glow_over_blend){var subs_main_blend=create_custom_sub_main("BLEND");curr_level.push(subs_main_blend);prev_level=curr_level;curr_level=[]}if(cfg_def.debug_view){var cam=cam_copy(main_cam);cam_scene_data.cameras.push(cam);var subs_debug_view=create_subs_debug_view(cam);curr_level.push(subs_debug_view);m_graph.append_node_attr(graph,subs_debug_view);m_graph.append_edge_attr(graph,prev_level[0],subs_debug_view,
slink_color_o);m_graph.append_edge_attr(graph,prev_level[0],subs_debug_view,slink_depth_o);if(subs_grass_map){m_graph.append_edge_attr(graph,subs_grass_map,subs_debug_view,slink_grass_map_d);m_graph.append_edge_attr(graph,subs_grass_map,subs_debug_view,slink_grass_map_c)}prev_level=curr_level;curr_level=[]}if(msaa){var subs_res_geom=create_subs_resolve();m_graph.append_node_attr(graph,subs_res_geom);curr_level.push(subs_res_geom);m_graph.append_edge_attr(graph,prev_level[0],subs_res_geom,slink_resolve_in_c);
m_graph.append_edge_attr(graph,prev_level[0],subs_res_geom,slink_resolve_in_d);prev_level=curr_level;curr_level=[]}var last_geom_level=prev_level.slice(0);if(!rtt&&sc_render.anchor_visibility){var cam=cam_copy(main_cam);cam_scene_data.cameras.push(cam);var subs_anchor=create_subs_anchor_visibility(cam);m_graph.append_node_attr(graph,subs_anchor);m_graph.append_edge_attr(graph,prev_level[0],subs_anchor,msaa?slink_depth_resolve_o:slink_depth_o)}if(god_rays&&depth_tex&&!rtt){var max_ray_length=gr_params.max_ray_length;
var intensity=gr_params.intensity;var steps_per_pass=gr_params.steps_per_pass;var subs_prev=prev_level[0];var water=water_params?true:false;var slink_gr_d=create_slink("DEPTH","u_input",1,1,1,true);slink_gr_d.min_filter=m_tex.TF_LINEAR;slink_gr_d.mag_filter=m_tex.TF_LINEAR;var slink_gr_c=create_slink("COLOR","u_input",1,.25,.25,true);slink_gr_c.min_filter=m_tex.TF_LINEAR;slink_gr_c.mag_filter=m_tex.TF_LINEAR;var step=max_ray_length/steps_per_pass;var cam_god_rays=cam_copy(main_cam);cam_scene_data.cameras.push(cam_god_rays);
var subs_god_rays=create_subs_god_rays(cam_god_rays,water,max_ray_length,true,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_god_rays);m_graph.append_edge_attr(graph,subs_prev,subs_god_rays,slink_gr_d);step=max_ray_length/steps_per_pass*.5;var cam_blur1=cam_copy(main_cam);cam_scene_data.cameras.push(cam_blur1);var subs_gr_blur1=create_subs_god_rays(cam_blur1,water,max_ray_length,false,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_gr_blur1);m_graph.append_edge_attr(graph,
subs_god_rays,subs_gr_blur1,slink_gr_c);step=max_ray_length/steps_per_pass*.25;var cam_blur2=cam_copy(main_cam);cam_scene_data.cameras.push(cam_blur2);var subs_gr_blur2=create_subs_god_rays(cam_blur2,water,max_ray_length,false,step,num_lights,steps_per_pass);m_graph.append_node_attr(graph,subs_gr_blur2);m_graph.append_edge_attr(graph,subs_gr_blur1,subs_gr_blur2,slink_gr_c);var subs_god_rays_comb=create_subs_god_rays_comb(intensity,num_lights);curr_level.push(subs_god_rays_comb);m_graph.append_node_attr(graph,
subs_god_rays_comb);m_graph.append_edge_attr(graph,subs_prev,subs_god_rays_comb,create_slink("COLOR","u_main",1,1,1,true));m_graph.append_edge_attr(graph,subs_gr_blur2,subs_god_rays_comb,create_slink("COLOR","u_god_rays",1,1,1,true));prev_level=curr_level;curr_level=[]}if(bloom_params&&!rtt){var subs_prev=prev_level[0];var subs_luminance=create_subs_luminance();m_graph.append_node_attr(graph,subs_luminance);m_graph.append_edge_attr(graph,subs_prev,subs_luminance,create_slink("COLOR","u_input",1,1,
1,true));var subs_av_luminance=create_subs_av_luminance();m_graph.append_node_attr(graph,subs_av_luminance);subs_av_luminance.camera.width=cfg_def.edge_min_tex_size_hack?2:1;subs_av_luminance.camera.height=cfg_def.edge_min_tex_size_hack?2:1;var slink_luminance_av=create_slink("COLOR","u_input",1,.25,.25,true);slink_luminance_av.min_filter=m_tex.TF_LINEAR;slink_luminance_av.mag_filter=m_tex.TF_LINEAR;var slink_luminance_tr=create_slink("COLOR","u_luminance",1,.25,.25,true);slink_luminance_tr.min_filter=
m_tex.TF_LINEAR;slink_luminance_tr.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_luminance,subs_av_luminance,slink_luminance_av);var bloom_key=bloom_params.key;var edge_lum=bloom_params.edge_lum;var cam_luminance=cam_copy(main_cam);cam_scene_data.cameras.push(cam_luminance);var subs_lum_trunced=create_subs_luminance_trunced(bloom_key,edge_lum,num_lights,cam_luminance);m_graph.append_node_attr(graph,subs_lum_trunced);m_graph.append_edge_attr(graph,subs_prev,subs_lum_trunced,create_slink("COLOR",
"u_main",1,1,1,true));m_graph.append_edge_attr(graph,subs_luminance,subs_lum_trunced,slink_luminance_tr);m_graph.append_edge_attr(graph,subs_av_luminance,subs_lum_trunced,create_slink("COLOR","u_average_lum",1,1,1,false));var slink_blur_in=create_slink("COLOR","u_color",1,.25,.25,true);slink_blur_in.min_filter=m_tex.TF_LINEAR;slink_blur_in.mag_filter=m_tex.TF_LINEAR;var blur_x=create_subs_bloom_blur(graph,subs_luminance,"X_BLUR",true);m_graph.append_node_attr(graph,blur_x);m_graph.append_edge_attr(graph,
subs_lum_trunced,blur_x,slink_blur_in);var blur_y=create_subs_bloom_blur(graph,blur_x,"Y_BLUR",true);m_graph.append_node_attr(graph,blur_y);m_graph.append_edge_attr(graph,blur_x,blur_y,slink_blur_in);var bloom_blur=bloom_params.blur;var subs_bloom_combine=create_subs_bloom_combine(bloom_blur);m_graph.append_node_attr(graph,subs_bloom_combine);var slink_bloom=create_slink("COLOR","u_bloom",1,.25,.25,true);slink_bloom.min_filter=m_tex.TF_LINEAR;slink_bloom.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,
blur_y,subs_bloom_combine,slink_bloom);m_graph.append_edge_attr(graph,subs_prev,subs_bloom_combine,create_slink("COLOR","u_main",1,1,1,true));curr_level.push(subs_bloom_combine);prev_level=curr_level;curr_level=[]}if(dof&&depth_tex&&!rtt){var subs_prev=prev_level[0];var cam_dof=cam_copy(main_cam);cam_scene_data.cameras.push(cam_dof);var slink_blur_in=create_slink("COLOR","u_color",1,1,1,true);slink_blur_in.min_filter=m_tex.TF_LINEAR;slink_blur_in.mag_filter=m_tex.TF_LINEAR;var pp_x=create_subs_postprocessing("X_BLUR");
m_graph.append_node_attr(graph,pp_x);m_graph.append_edge_attr(graph,subs_prev,pp_x,slink_blur_in);var pp_y=create_subs_postprocessing("Y_BLUR");m_graph.append_node_attr(graph,pp_y);m_graph.append_edge_attr(graph,pp_x,pp_y,slink_blur_in);var subs_dof_in=last_geom_level[0];var subs_dof=create_subs_dof(cam_dof);cam_dof.dof_distance=cam_render.dof_distance;cam_dof.dof_object=cam_render.dof_object;cam_dof.dof_front=cam_render.dof_front;cam_dof.dof_rear=cam_render.dof_rear;cam_dof.dof_power=cam_render.dof_power;
cam_dof.dof_on=true;curr_level.push(subs_dof);m_graph.append_node_attr(graph,subs_dof);m_graph.append_edge_attr(graph,subs_prev,subs_dof,create_slink("COLOR","u_sharp",1,1,1,true));m_graph.append_edge_attr(graph,pp_y,subs_dof,create_slink("COLOR","u_blurred",1,1,1,true));m_graph.append_edge_attr(graph,subs_dof_in,subs_dof,create_slink("DEPTH","u_depth",1,1,1,true));prev_level=curr_level;curr_level=[]}if(sc_render.xray){var subs_main_xray=create_custom_sub_main("XRAY");curr_level.push(subs_main_xray);
prev_level=curr_level;curr_level=[]}if(motion_blur&&!rtt){var subs_to_blur=prev_level[0];var subs_mb=create_subs_motion_blur(mb_params.mb_decay_threshold,mb_params.mb_factor);curr_level.push(subs_mb);m_graph.append_node_attr(graph,subs_mb);var slink_mb_in=create_slink("COLOR","u_mb_tex_curr",1,1,1,true);m_graph.append_edge_attr(graph,subs_to_blur,subs_mb,slink_mb_in);var slink_mb_accum=create_slink("COLOR","u_mb_tex_accum",1,1,1,true);subs_mb.slinks_internal.push(slink_mb_accum);prev_level=curr_level;
curr_level=[]}if(!rtt&&sc_render.outline){var subs_prev=prev_level[0];var cam_outline=cam_copy(main_cam);cam_scene_data.cameras.push(cam_outline);var subs_outline_mask=create_subs_outline_mask(cam_outline,num_lights);m_graph.append_node_attr(graph,subs_outline_mask);var pp_x_ext=create_subs_postprocessing("X_EXTEND");var slink_mask_pp=create_slink("COLOR","u_color",1,1,1,true);var slink_mask_gl=create_slink("COLOR","u_outline_mask",1,1,1,true);pp_x_ext.is_for_outline=true;m_graph.append_node_attr(graph,
pp_x_ext);m_graph.append_edge_attr(graph,subs_outline_mask,pp_x_ext,slink_mask_pp);var slink_ext=create_slink("COLOR","u_color",1,.5,.5,true);slink_ext.min_filter=m_tex.TF_LINEAR;slink_ext.mag_filter=m_tex.TF_LINEAR;var pp_y_ext=create_subs_postprocessing("Y_EXTEND");pp_y_ext.is_for_outline=true;m_graph.append_node_attr(graph,pp_y_ext);m_graph.append_edge_attr(graph,pp_x_ext,pp_y_ext,slink_ext);var pp_x=create_subs_postprocessing("X_BLUR");pp_x.is_for_outline=true;m_graph.append_node_attr(graph,pp_x);
m_graph.append_edge_attr(graph,pp_y_ext,pp_x,slink_ext);var slink_blur_blur=create_slink("COLOR","u_color",1,.25,.25,true);slink_blur_blur.min_filter=m_tex.TF_LINEAR;slink_blur_blur.mag_filter=m_tex.TF_LINEAR;var slink_blur_outline=create_slink("COLOR","u_outline_mask_blurred",1,.25,.25,true);slink_blur_outline.min_filter=m_tex.TF_LINEAR;slink_blur_outline.mag_filter=m_tex.TF_LINEAR;var pp_y=create_subs_postprocessing("Y_BLUR");pp_y.is_for_outline=true;m_graph.append_node_attr(graph,pp_y);m_graph.append_edge_attr(graph,
pp_x,pp_y,slink_blur_blur);var subs_outline=create_subs_outline(outline_params);m_graph.append_node_attr(graph,subs_outline);m_graph.append_edge_attr(graph,subs_prev,subs_outline,create_slink("COLOR","u_outline_src",1,1,1,true));m_graph.append_edge_attr(graph,subs_outline_mask,subs_outline,slink_mask_gl);m_graph.append_edge_attr(graph,pp_y,subs_outline,slink_blur_outline);curr_level.push(subs_outline);prev_level=curr_level;curr_level=[]}if(compositing&&!rtt){var subs_prev=prev_level[0];var brightness=
cc_params.brightness;var contrast=cc_params.contrast;var exposure=cc_params.exposure;var saturation=cc_params.saturation;var subs_compositing=create_subs_compositing(brightness,contrast,exposure,saturation);m_graph.append_node_attr(graph,subs_compositing);m_graph.append_edge_attr(graph,subs_prev,subs_compositing,create_slink("COLOR","u_color",1,1,1,true));curr_level.push(subs_compositing);prev_level=curr_level;curr_level=[]}if(antialiasing){var subs_prev=prev_level[0];if(cfg_def.smaa){var slink_smaa_in=
create_slink("COLOR","u_color",1,1,1,true);slink_smaa_in.min_filter=m_tex.TF_LINEAR;slink_smaa_in.mag_filter=m_tex.TF_LINEAR;var subs_smaa_1=create_subs_smaa("SMAA_EDGE_DETECTION",sc_render);m_graph.append_node_attr(graph,subs_smaa_1);m_graph.append_edge_attr(graph,subs_prev,subs_smaa_1,slink_smaa_in);var subs_smaa_2=create_subs_smaa("SMAA_BLENDING_WEIGHT_CALCULATION",sc_render);m_graph.append_node_attr(graph,subs_smaa_2);m_graph.append_edge_attr(graph,subs_smaa_1,subs_smaa_2,slink_smaa_in);var slink_search_tex=
create_slink("COLOR","u_search_tex",1,1,1,false);var slink_area_tex=create_slink("COLOR","u_area_tex",1,1,1,false);slink_search_tex.min_filter=m_tex.TF_LINEAR;slink_search_tex.mag_filter=m_tex.TF_LINEAR;slink_area_tex.min_filter=m_tex.TF_LINEAR;slink_area_tex.mag_filter=m_tex.TF_LINEAR;subs_smaa_2.slinks_internal.push(slink_search_tex);subs_smaa_2.slinks_internal.push(slink_area_tex);var subs_smaa_3=create_subs_smaa("SMAA_NEIGHBORHOOD_BLENDING",sc_render);m_graph.append_node_attr(graph,subs_smaa_3);
m_graph.append_edge_attr(graph,subs_prev,subs_smaa_3,slink_smaa_in);var slink_smaa_blend=create_slink("COLOR","u_blend",1,1,1,true);slink_smaa_blend.min_filter=m_tex.TF_LINEAR;slink_smaa_blend.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_smaa_2,subs_smaa_3,slink_smaa_blend);curr_level.push(subs_smaa_3)}else{var subs_aa=create_subs_aa(sc_render);m_graph.append_node_attr(graph,subs_aa);var slink_aa_in=create_slink("COLOR","u_color",1,1,1,true);slink_aa_in.min_filter=m_tex.TF_LINEAR;
slink_aa_in.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,subs_prev,subs_aa,slink_aa_in);curr_level.push(subs_aa)}prev_level=curr_level;curr_level=[]}curr_level.push(prev_level[0]);var prev_id=m_graph.node_by_attr(graph,prev_level[0]);if(prev_level[0].type=="MOTION_BLUR"||prev_level[0].type=="RESOLVE")var need_subs_pp_copy=true;else{var need_subs_pp_copy=false;m_graph.traverse_inputs(graph,prev_id,function(id_in,attr_in,attr_edge){var slink_in=attr_edge;if(slink_in.from==slink_in.to){need_subs_pp_copy=
true;return true}})}if(need_subs_pp_copy){var subs_pp_copy=create_subs_postprocessing("NONE");m_graph.append_node_attr(graph,subs_pp_copy);m_graph.append_edge_attr(graph,prev_level[0],subs_pp_copy,create_slink("COLOR","u_color",1,1,1,true));prev_level=curr_level;curr_level=[];curr_level.push(subs_pp_copy)}if(subs_color_picking)if(subs_color_picking_xray)curr_level.push(subs_color_picking_xray);else curr_level.push(subs_color_picking);if(subs_anchor)curr_level.push(subs_anchor);if(!rtt&&sc_render.sky_params.procedural_skydome){var sky_params=
sc_render.sky_params;var subs_sky=create_subs_sky(num_lights,sky_params);m_graph.append_node_attr(graph,subs_sky);curr_level.push(subs_sky)}var subs_sink=create_subs_sink();m_graph.append_node_attr(graph,subs_sink);for(var i=0;i<curr_level.length;i++){var subs=curr_level[i];switch(subs.type){case "COLOR_PICKING":case "COLOR_PICKING_XRAY":m_graph.append_edge_attr(graph,subs,subs_sink,create_slink("COLOR","NONE",1,1,1,true));m_graph.append_edge_attr(graph,subs,subs_sink,create_slink("DEPTH","NONE",
1,1,1,true));break;case "SKY":var slink_sky=create_slink("CUBEMAP","u_sky",cfg_scs.cubemap_tex_size,1,1,false);m_graph.append_edge_attr(graph,subs,subs_sink,slink_sky);break;case "ANCHOR_VISIBILITY":var slink_anchor_color=create_slink("COLOR","NONE",1,1,1,true);m_graph.append_edge_attr(graph,subs,subs_sink,slink_anchor_color);break;default:if(rtt){var tex0=render_to_textures[0]._render;var slink_rtt=create_slink("COLOR","OFFSCREEN",1,1,1,true);slink_rtt.texture=tex0;m_graph.append_edge_attr(graph,
curr_level[i],subs_sink,slink_rtt);for(var j=1;j<render_to_textures.length;j++){var tex=render_to_textures[j]._render;var subs_scale=create_subs_postprocessing("NONE");m_graph.append_node_attr(graph,subs_scale);var slink_to_rtt=create_slink("COLOR","SCALE",1,1,1,true);m_graph.append_edge_attr(graph,curr_level[i],subs_scale,slink_to_rtt);var size_mult=tex.source_size/tex0.source_size;var slink_rtt=create_slink("COLOR","OFFSCREEN",1,size_mult,size_mult,true);slink_rtt.texture=tex;m_graph.append_edge_attr(graph,
subs_scale,subs_sink,slink_rtt)}}else m_graph.append_edge_attr(graph,curr_level[i],subs_sink,create_slink("SCREEN","NONE",1,1,1,true));break}}if(subs_res_opaque&&!get_outputs(graph,subs_res_opaque).length){m_graph.remove_node(graph,m_graph.node_by_attr(graph,subs_res_opaque));m_graph.cleanup_loose_edges(graph)}enforce_graph_consistency(graph,depth_tex);if((sc_render.anaglyph_use||sc_render.hmd_stereo_use)&&!rtt)make_stereo(graph,sc_render,cam_scene_data);if(cfg_dbg.enabled){var subs_from=find_debug_subs(graph);
if(subs_from)assign_debug_subscene(graph,subs_from)}process_subscene_links(graph);assign_render_targets(graph);if(shadow_params)m_graph.traverse(graph,function(nid,subs){if(subs.type=="SHADOW_RECEIVE"||subs.type=="MAIN_BLEND"||subs.type=="MAIN_XRAY")prepare_shadow_receive_subs(graph,subs)});return graph};function find_debug_subs(graph){var subs_dbg=null;var subs_num=0;m_graph.traverse(graph,function(id,attr){if(attr.type==cfg_dbg.subs_type)if(subs_num==cfg_dbg.subs_number){subs_dbg=attr;return true}else subs_num++});
return subs_dbg}function assign_debug_subscene(graph,subs_to_debug){var node_to_debug=m_graph.node_by_attr(graph,subs_to_debug);var subs_debug_view=create_subs_postprocessing("NONE");var node_debug_view=m_graph.append_node_attr(graph,subs_debug_view);var node_sink=m_graph.get_sink_nodes(graph)[0];m_graph.traverse_edges(graph,function(edge_from,edge_to,edge_attr){if(edge_to==node_sink)m_graph.reconnect_edges(graph,edge_from,node_sink,edge_from,node_debug_view)});m_graph.traverse_edges(graph,function(edge_from,
edge_to,edge_attr){if(edge_from==node_to_debug){m_graph.append_edge_attr(graph,subs_to_debug,subs_debug_view,create_slink(cfg_dbg.slink_type,"u_color",edge_attr.size,edge_attr.size_mult_x,edge_attr.size_mult_y,edge_attr.update_dim));return true}});m_graph.append_edge(graph,node_debug_view,node_sink,create_slink("SCREEN","NONE",.5,.5,.5,true))}function make_stereo(graph,sc_render,cam_scene_data){var cams=cam_scene_data.cameras;var antialiasing=sc_render.antialiasing;var hmd_stereo_use=sc_render.hmd_stereo_use;
var plane_refl_subs=sc_render.reflection_params.plane_refl_subs;var plane_refl_subs_blend=sc_render.reflection_params.plane_refl_subs_blend;var nid_sink;var nid_pre_sink;var subs_pre_sink;if(hmd_stereo_use&&antialiasing)m_graph.traverse(graph,function(id,subs){if(subs.type=="ANTIALIASING"){var compos_subs=find_upper_subs(graph,subs,"COMPOSITING");if(compos_subs)nid_sink=m_graph.get_node_id(graph,compos_subs);else nid_sink=id}else if(subs.type=="COMPOSITING")nid_sink=id});else nid_sink=m_graph.get_sink_nodes(graph)[0];
m_graph.traverse_inputs(graph,nid_sink,function(nid_in,subs_in,slink){if(has_upper_subs(graph,subs_in,"MAIN_OPAQUE")){nid_pre_sink=nid_in;subs_pre_sink=subs_in;return true}});var subgraph_right=m_graph.subgraph_node_conn(graph,nid_pre_sink,m_graph.BACKWARD_DIR);var left_only_edges=[];var removed_subscenes=[];var source_nodes_right=[];var subs_clone_cb=function(subs){var subs_new;if(LEFT_ONLY_SUBS_TYPES.indexOf(subs.type)>-1){removed_subscenes.push(subs);subs_new=subs}else{subs_new=clone_subs(subs);
if(subs_new.type=="MAIN_PLANE_REFLECT")for(var i=0;i<plane_refl_subs.length;i++)if(plane_refl_subs[i][0]==subs){plane_refl_subs[i]=[subs,subs_new];subs_new.camera.reflection_plane=subs.camera.reflection_plane;cam_scene_data.cameras.push(subs_new.camera);break}if(subs.type=="MAIN_PLANE_REFLECT_BLEND")for(var i=0;i<plane_refl_subs.length;i++){if(plane_refl_subs_blend[i][0]==subs){plane_refl_subs_blend[i]=[subs,subs_new];subs_new.camera=plane_refl_subs[i][1].camera;break}}else if(cams.indexOf(subs.camera)>
-1){if(hmd_stereo_use){m_cam.make_stereo(subs.camera,m_cam.TYPE_HMD_LEFT);m_cam.make_stereo(subs_new.camera,m_cam.TYPE_HMD_RIGHT)}else{m_cam.make_stereo(subs.camera,m_cam.TYPE_STEREO_LEFT);m_cam.make_stereo(subs_new.camera,m_cam.TYPE_STEREO_RIGHT)}cams.push(subs_new.camera)}var nid_subs=m_graph.node_by_attr(graph,subs);m_graph.traverse_inputs(graph,nid_subs,function(nid_in,subs_in,slink){if(LEFT_ONLY_SUBS_TYPES.indexOf(subs_in.type)>-1)left_only_edges.push([subs_in,subs_new,slink])});for(var i=0;i<
subs.slinks_internal.length;i++)subs_new.slinks_internal[i].parent_slink=subs.slinks_internal[i];var is_source_node=true;for(var i=0;i<m_graph.in_edge_count(graph,nid_subs);i++){var nid_upper_subs=m_graph.get_in_edge(graph,nid_subs,i);var upper_subs=m_graph.get_node_attr(graph,nid_upper_subs);if(LEFT_ONLY_SUBS_TYPES.indexOf(upper_subs.type)==-1)is_source_node=false}if(is_source_node)source_nodes_right.push(subs_new)}return subs_new};var slink_clone_cb=function(slink){var new_slink=clone_slink(slink,
true);new_slink.parent_slink=slink;return new_slink};subgraph_right=m_graph.clone(subgraph_right,subs_clone_cb,slink_clone_cb);for(var i=0;i<removed_subscenes.length;i++)m_graph.remove_node(subgraph_right,m_graph.node_by_attr(subgraph_right,removed_subscenes[i]));m_graph.cleanup_loose_edges(subgraph_right);var subs_stereo=create_subs_stereo(hmd_stereo_use);var nid_anaglyph=m_graph.append_node_attr(graph,subs_stereo);m_graph.reconnect_edges(graph,nid_pre_sink,nid_sink,nid_anaglyph,nid_sink);var left_clone=
create_subs_copy();m_graph.append_node_attr(graph,left_clone);var slink_copy=create_slink("COLOR","COPY",1,1,1,true);m_graph.append_edge_attr(graph,subs_pre_sink,left_clone,slink_copy);var slink_left=create_slink("COLOR","u_sampler_left",1,1,1,true);slink_left.unique_texture=true;slink_left.min_filter=m_tex.TF_LINEAR;slink_left.mag_filter=m_tex.TF_LINEAR;m_graph.append_edge_attr(graph,left_clone,subs_stereo,slink_left);var slink_right=create_slink("COLOR","u_sampler_right",1,1,1,true);slink_right.min_filter=
m_tex.TF_LINEAR;slink_right.mag_filter=m_tex.TF_LINEAR;slink_right.parent_slink=slink_copy;m_graph.append_subgraph(subgraph_right,graph,[m_graph.get_sink_nodes(subgraph_right)[0],nid_anaglyph,slink_right]);for(var i=0;i<left_only_edges.length;i++){var subs1=left_only_edges[i][0];var subs2=left_only_edges[i][1];var slink=left_only_edges[i][2];m_graph.append_edge_attr(graph,subs1,subs2,slink)}var slink_order=create_slink("SCREEN","NONE",0,0,0,false);for(var i=0;i<source_nodes_right.length;i++)m_graph.append_edge_attr(graph,
left_clone,source_nodes_right[i],slink_order);if(hmd_stereo_use)multiply_size_mult_by_graph(graph,.5,1)}exports.multiply_size_mult_by_graph=multiply_size_mult_by_graph;function multiply_size_mult_by_graph(graph,multiplier_x,multiplier_y){var slink_list=[];m_graph.traverse(graph,function(subs_id,subs){if(LEFT_ONLY_SUBS_TYPES.indexOf(subs.type)==-1&&subs.slinks_internal.length&&has_lower_subs(graph,subs,"STEREO"))for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];if(slink_list.indexOf(slink)==
-1)slink_list.push(slink)}});m_graph.traverse_edges(graph,function(node1,node2,slink){var subs1=m_graph.get_node_attr(graph,node1);var subs2=m_graph.get_node_attr(graph,node2);if(LEFT_ONLY_SUBS_TYPES.indexOf(subs1.type)==-1&&has_lower_subs(graph,subs2,"STEREO"))if(slink_list.indexOf(slink)==-1)slink_list.push(slink)});for(var i=0;i<slink_list.length;i++){slink_list[i].size_mult_x*=multiplier_x;slink_list[i].size_mult_y*=multiplier_y}}function add_light_attributes(subs,num_lights){subs.num_lights=
num_lights;subs.light_directions=new Float32Array(num_lights*3);subs.light_positions=new Float32Array(num_lights*3);subs.light_color_intensities=new Float32Array(num_lights*3);var num_lfac=num_lights%2==0?num_lights*2:num_lights*2+2;subs.light_factors=new Float32Array(num_lfac)}function create_subs_shadow_cast(csm_index,lamp_index,shadow_params,num_lights){var subs=init_subs("SHADOW_CAST");subs.csm_index=csm_index;subs.self_shadow_polygon_offset=shadow_params.self_shadow_polygon_offset;subs.shadow_lamp_index=
lamp_index;switch(shadow_params.lamp_types[lamp_index]){case "SPOT":case "POINT":subs.camera=m_cam.create_camera(m_cam.TYPE_PERSP);var fov=m_util.rad_to_deg(shadow_params.spot_sizes[lamp_index]);var near=.1;var far=2*shadow_params.distances[lamp_index];m_cam.set_frustum(subs.camera,fov,near,far);break;default:subs.camera=m_cam.create_camera(m_cam.TYPE_ORTHO_ASYMMETRIC)}add_light_attributes(subs,num_lights);return subs}exports.init_subs=init_subs;function init_subs(type){var subs={type:type,subtype:"",
do_render:false,enqueue:false,clear_color:false,clear_depth:false,depth_test:false,blend:false,pack:false,assign_texture:false,need_fog_update:false,need_perm_uniforms_update:false,debug_render_calls:0,debug_render_time:0,debug_render_time_queries:[],time:0,camera:null,cube_view_matrices:null,cube_cam_frustums:[],bundles:[],slinks_internal:[],textures_internal:[],wind:new Float32Array(3),grass_map_dim:new Float32Array(3),fog_color_density:new Float32Array(4),fog_params:new Float32Array(4),cube_fog:new Float32Array(16),
sky_tex_default_value:0,environment_energy:0,num_lights:0,light_directions:null,light_positions:null,light_color_intensities:null,light_factors:null,horizon_color:new Float32Array(3),zenith_color:new Float32Array(3),sky_tex_fac:new Float32Array(4),sun_intensity:new Float32Array([0,0,0]),sun_direction:new Float32Array(3),sun_quaternion:new Float32Array(4),sky_tex_color:new Float32Array(3),outline_factor:0,draw_outline_flag:0,is_for_outline:false,outline_color:new Float32Array(3),water:0,cam_water_depth:0,
water_fog_color_density:null,water_waves_height:0,water_waves_length:0,water_level:0,caustics:false,caust_scale:0,caust_speed:new Float32Array(2),caust_brightness:0,procedural_skydome:false,use_as_environment_lighting:false,mie_brightness:0,rayleigh_brightness:0,spot_brightness:0,mie_strength:0,rayleigh_strength:0,scatter_strength:0,mie_collection_power:0,rayleigh_collection_power:0,mie_distribution:0,sky_color:new Float32Array(3),ssao_hemisphere:0,ssao_blur_depth:0,ssao_blur_discard_value:0,ssao_radius_increase:0,
ssao_influence:0,ssao_dist_factor:0,ssao_samples:0,ssao_only:0,ssao_white:0,brightness:0,contrast:0,exposure:0,saturation:0,god_rays_intensity:0,max_ray_length:0,radial_blur_step:0,steps_per_pass:0,csm_index:0,self_shadow_polygon_offset:0,self_shadow_normal_offset:0,v_light_ts:null,v_light_r:null,v_light_tsr:null,p_light_matrix:null,bloom_key:0,bloom_blur:0,bloom_edge_lum:0,blur_texel_size_mult:0,ext_texel_size_mult:0,mb_decay_threshold:0,mb_factor:0,motion_blur_exp:0,pp_effect:"",jitter_projection_space:new Float32Array(2),
small_glow_mask_width:0,large_glow_mask_width:0,small_glow_mask_coeff:0,large_glow_mask_coeff:0,texel_size_multiplier:0,texel_size:new Float32Array(2),texel_mask:new Float32Array(2),distortion_params:new Float32Array(4),chromatic_aberration_coefs:new Float32Array(4),enable_hmd_stereo:false,shadow_lamp_index:0,debug_colors_seed:0};subs.do_render=true;subs.enqueue=true;subs.clear_color=true;subs.clear_depth=true;subs.depth_test=true;subs.need_perm_uniforms_update=true;subs.texel_size_multiplier=1;subs.texel_mask[0]=
1;subs.texel_mask[1]=1;subs.distortion_params[2]=.5;subs.distortion_params[3]=0;return subs}function clone_subs(subs){var cam=subs.camera;subs.camera=null;var subs_new=m_util.clone_object_r(subs);subs.camera=cam;subs_new.camera=cam_copy(cam);return subs_new}exports.set_texel_size=set_texel_size;function set_texel_size(subs,size_x,size_y){var mult=subs.texel_size_multiplier;subs.texel_size[0]=size_x*subs.texel_mask[0]*mult;subs.texel_size[1]=size_y*subs.texel_mask[1]*mult}exports.set_texel_size_mult=
set_texel_size_mult;function set_texel_size_mult(subs,mult){subs.texel_size_multiplier=mult}function create_slink(from,to,size,size_mult_x,size_mult_y,update_dim){var slink={from:from,to:to,size:size,size_mult_x:size_mult_x,size_mult_y:size_mult_y,update_dim:update_dim,active:true,texture:null,multisample:false,use_renderbuffer:false,min_filter:m_tex.TF_NEAREST,mag_filter:m_tex.TF_NEAREST,unique_texture:false};return slink}function clone_slink(slink,tex_by_link){if(tex_by_link){var tex=slink.texture;
slink.texture=null}if(slink.texture)m_util.panic("Failed to clone slink with attached texture");var slink_new=m_util.clone_object_json(slink);if(tex_by_link){slink.texture=tex;slink_new.texture=tex}return slink_new}function prepare_shadow_receive_subs(graph,subs){var csm_index=0;var subs_inputs=get_inputs(graph,subs);var v_light_tsr_num=0;for(var i=0;i<subs_inputs.length;i++){var input=subs_inputs[i];if(input.type=="SHADOW_CAST"){v_light_tsr_num++;subs.p_light_matrix=subs.p_light_matrix||new Array;
var index=input.shadow_lamp_index>0?input.shadow_lamp_index:csm_index;subs.p_light_matrix[index]=input.camera.proj_matrix;csm_index++}}if(!subs.v_light_ts||!subs.v_light_r)if(cfg_def.mac_os_shadow_hack)subs.v_light_tsr=new Float32Array(v_light_tsr_num*9);else{subs.v_light_ts=new Float32Array(v_light_tsr_num*4);subs.v_light_r=new Float32Array(v_light_tsr_num*4)}}function create_subs_grass_map(){var subs=init_subs("GRASS_MAP");subs.camera=m_cam.create_camera(m_cam.TYPE_ORTHO_ASPECT);return subs}function create_subs_postprocessing(pp_effect){var pp_subs=
init_subs("POSTPROCESSING");pp_subs.clear_color=false;pp_subs.clear_depth=false;pp_subs.depth_test=false;pp_subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);pp_subs.pp_effect=pp_effect;switch(pp_effect){case "NONE":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=1;break;case "GRAYSCALE":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=1;break;case "X_BLUR":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=0;break;case "Y_BLUR":pp_subs.texel_mask[0]=0;pp_subs.texel_mask[1]=1;break;case "X_GLOW_BLUR":pp_subs.texel_mask[0]=
1;pp_subs.texel_mask[1]=0;break;case "Y_GLOW_BLUR":pp_subs.texel_mask[0]=0;pp_subs.texel_mask[1]=1;break;case "X_EXTEND":pp_subs.texel_mask[0]=1;pp_subs.texel_mask[1]=0;break;case "Y_EXTEND":pp_subs.texel_mask[0]=0;pp_subs.texel_mask[1]=1;break;default:throw"Wrong postprocessing effect: "+pp_effect;break}return pp_subs}function create_subs_bloom_blur(graph,subs_input,pp_effect){var subs=init_subs("BLOOM_BLUR");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);
subs.pp_effect=pp_effect;switch(pp_effect){case "X_BLUR":subs.texel_mask[0]=1;subs.texel_mask[1]=0;break;case "Y_BLUR":subs.texel_mask[0]=0;subs.texel_mask[1]=1;break;default:throw"Wrong postprocessing effect for bloom blur: "+pp_effect;break}return subs}function create_subs_glow_combine(cam,sc_render){var subs=init_subs("GLOW_COMBINE");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.small_glow_mask_coeff=sc_render.glow_params.small_glow_mask_coeff;subs.large_glow_mask_coeff=
sc_render.glow_params.large_glow_mask_coeff;subs.small_glow_mask_width=sc_render.glow_params.small_glow_mask_width;subs.large_glow_mask_width=sc_render.glow_params.large_glow_mask_width;subs.camera=cam;return subs}function create_subs_main(main_type,cam,opaque_do_clear_depth,water_params,num_lights,wfs_params,wls_params,shadow_params,sun_exist){var subs=init_subs("MAIN_"+main_type);if(main_type==="OPAQUE"){subs.clear_color=true;subs.clear_depth=opaque_do_clear_depth;subs.blend=false}else if(main_type===
"BLEND"){subs.clear_color=false;subs.clear_depth=false;subs.blend=true}else if(main_type==="XRAY"){subs.clear_color=false;subs.clear_depth=true;subs.blend=true}else if(main_type==="PLANE_REFLECT"||main_type==="CUBE_REFLECT"){subs.clear_color=true;subs.clear_depth=true;subs.blend=false}else if(main_type==="PLANE_REFLECT_BLEND"||main_type==="CUBE_REFLECT_BLEND"){subs.clear_color=false;subs.clear_depth=false;subs.blend=true}else if(main_type==="GLOW"){subs.clear_color=true;subs.clear_depth=false;subs.blend=
true}else throw"wrong main subscene type";if(subs.blend&&shadow_params)subs.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;subs.camera=cam;var sts=wls_params.sky_texture_param;if(sts){subs.sky_tex_fac.set([sts.blend_factor,sts.horizon_factor,sts.zenith_up_factor,sts.zenith_down_factor]);subs.sky_tex_color.set(sts.color);subs.sky_tex_default_value=sts.default_value}subs.horizon_color.set(wls_params.horizon_color);subs.zenith_color.set(wls_params.zenith_color);subs.environment_energy=
wls_params.environment_energy;subs.fog_color_density=wfs_params.fog_color_density;subs.fog_params=wfs_params.fog_params;if(water_params)assign_water_params(subs,water_params,sun_exist);add_light_attributes(subs,num_lights);return subs}function assign_water_params(subs,water_params,sun_exist){subs.water_params=water_params;var wp=water_params;if(wp.fog_color_density)subs.water_fog_color_density=new Float32Array(wp.fog_color_density);subs.water_waves_height=wp.waves_height;subs.water_waves_length=wp.waves_length;
subs.water_level=wp.water_level;if(wp.caustics&&sun_exist){subs.caustics=true;subs.caust_scale=wp.caustic_scale;subs.caust_brightness=wp.caustic_brightness;subs.caust_speed.set(wp.caustic_speed)}}function create_subs_resolve(){var subs=init_subs("RESOLVE");subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function assign_inputs(graph,subs,inputs){for(var i=0;i<inputs.length;i++)m_graph.append_edge_attr(graph,inputs[i],subs)}function create_subs_color_picking(cam,xray,num_lights){var subs=
init_subs("COLOR_PICKING");if(xray){subs.type+="_XRAY";subs.clear_color=false;subs.clear_depth=true}subs.enqueue=false;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_debug_view(cam){var subs=init_subs("DEBUG_VIEW");subs.do_render=false;subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_anchor_visibility(cam){var subs=init_subs("ANCHOR_VISIBILITY");subs.clear_color=true;subs.clear_depth=false;subs.camera=cam;return subs}
function create_subs_shadow_receive(graph,cam,num_lights){var subs=init_subs("SHADOW_RECEIVE");subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_depth_pack(cam){var subs=init_subs("DEPTH_PACK");subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_ssao(cam,wfs_params,ssao_params){var subs=init_subs("SSAO");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;subs.fog_color_density=wfs_params.fog_color_density;
subs.water_fog_color_density=new Float32Array(wfs_params.fog_color_density);subs.ssao_radius_increase=ssao_params.radius_increase;subs.ssao_hemisphere=ssao_params.hemisphere;subs.ssao_influence=ssao_params.influence;subs.ssao_dist_factor=ssao_params.dist_factor;subs.ssao_samples=ssao_params.samples;return subs}function create_subs_ssao_blur(cam,ssao_params){var subs=init_subs("SSAO_BLUR");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;subs.ssao_blur_depth=ssao_params.blur_depth;
subs.ssao_blur_discard_value=ssao_params.blur_discard_value;return subs}function create_subs_aa(sc_render){var subs=init_subs("ANTIALIASING");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.texel_size_multiplier=1/sc_render.resolution_factor;subs.fxaa_quality=sc_render.aa_quality;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_smaa(pass,sc_render){var subs=init_subs(pass);if(pass=="SMAA_BLENDING_WEIGHT_CALCULATION"||pass=="SMAA_EDGE_DETECTION")subs.clear_color=
true;else subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.texel_size_multiplier=1/sc_render.resolution_factor;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);if(pass=="SMAA_BLENDING_WEIGHT_CALCULATION")subs.jitter_subsample_ind=new Float32Array(4);return subs}function create_subs_compositing(brightness,contrast,exposure,saturation){var subs=init_subs("COMPOSITING");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);
subs.brightness=brightness;subs.contrast=contrast;subs.exposure=exposure;subs.saturation=saturation;return subs}function create_subs_motion_blur(mb_decay_threshold,mb_factor){var mb_subs=init_subs("MOTION_BLUR");mb_subs.clear_color=false;mb_subs.clear_depth=false;mb_subs.depth_test=false;mb_subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);mb_subs.assign_texture=true;mb_subs.mb_decay_threshold=mb_decay_threshold;mb_subs.mb_factor=mb_factor;return mb_subs}function create_subs_dof(cam){var subs=init_subs("DOF");
subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=cam;subs.texel_size_multiplier=subs.camera.dof_power;return subs}function create_subs_outline_mask(cam,num_lights){var subs=init_subs("OUTLINE_MASK");subs.depth_test=false;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_outline(outline_params){var subs=init_subs("OUTLINE");if(cfg_out.outlining_overview_mode)subs.outline_color.set(cfg_out.outline_color);else subs.outline_color.set(outline_params.outline_color);
subs.outline_factor=outline_params.outline_factor;subs.ext_texel_size_mult=5;subs.blur_texel_size_mult=3;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_god_rays(cam,water,ray_length,pack,step,num_lights,steps_per_pass){var subs=init_subs("GOD_RAYS");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.horizon_color=new Float32Array([1,1,1]);subs.zenith_color=new Float32Array([1,1,1]);subs.environment_energy=1;subs.pack=pack;
subs.water=water;subs.radial_blur_step=step;subs.max_ray_length=ray_length;subs.steps_per_pass=steps_per_pass;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_god_rays_comb(intensity,num_lights){var subs=init_subs("GOD_RAYS_COMBINE");subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);subs.god_rays_intensity=intensity;add_light_attributes(subs,num_lights);return subs}function create_subs_sky(num_lights,
sky_params){var subs=init_subs("SKY");subs.enqueue=false;subs.clear_color=false;subs.clear_depth=false;subs.depth_test=false;var cam=m_cam.create_camera(m_cam.TYPE_NONE);cam.width=cfg_scs.cubemap_tex_size;cam.height=cfg_scs.cubemap_tex_size;subs.camera=cam;subs.cube_view_matrices=m_util.generate_cubemap_matrices();add_light_attributes(subs,num_lights);subs.horizon_color=new Float32Array([1,1,1]);subs.zenith_color=new Float32Array([1,1,1]);subs.environment_energy=1;subs.sky_color.set(sky_params.sky_color);
subs.procedural_skydome=sky_params.procedural_skydome;subs.use_as_environment_lighting=sky_params.use_as_environment_lighting;subs.rayleigh_brightness=sky_params.rayleigh_brightness;subs.mie_brightness=sky_params.mie_brightness;subs.spot_brightness=sky_params.spot_brightness;subs.scatter_strength=sky_params.scatter_strength;subs.rayleigh_strength=sky_params.rayleigh_strength;subs.mie_strength=sky_params.mie_strength;subs.rayleigh_collection_power=sky_params.rayleigh_collection_power;subs.mie_collection_power=
sky_params.mie_collection_power;subs.mie_distribution=sky_params.mie_distribution;return subs}function create_subs_copy(){var subs=init_subs("COPY");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_stereo(is_hmd_stereo){var subs=init_subs("STEREO");subs.clear_color=false;subs.clear_depth=false;subs.subtype=is_hmd_stereo?"HMD":"ANAGLYPH";subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_luminance(){var subs=
init_subs("LUMINANCE");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_av_luminance(){var subs=init_subs("AVERAGE_LUMINANCE");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);return subs}function create_subs_luminance_trunced(bloom_key,edge_lum,num_lights,cam){var subs=init_subs("LUMINANCE_TRUNCED");subs.clear_color=false;subs.clear_depth=false;subs.bloom_key=bloom_key;subs.bloom_edge_lum=
edge_lum;subs.camera=cam;add_light_attributes(subs,num_lights);return subs}function create_subs_bloom_combine(blur){var subs=init_subs("BLOOM");subs.clear_color=false;subs.clear_depth=false;subs.camera=m_cam.create_camera(m_cam.TYPE_NONE);subs.bloom_blur=blur;return subs}function create_subs_veloctity(cam){var subs=init_subs("VELOCITY");subs.clear_color=false;subs.clear_depth=false;subs.camera=cam;return subs}function create_subs_sink(){var subs_sink=init_subs("SINK");subs_sink.enqueue=false;return subs_sink}
exports.create_performance_graph=function(){var graph=m_graph.create();var subs_perf=create_subs_perf();var cam=m_cam.create_camera(m_cam.TYPE_NONE);var size=1024;cam.width=size;cam.height=size;subs_perf.camera=cam;m_graph.append_node_attr(graph,subs_perf);var subs_sink=create_subs_sink();m_graph.append_node_attr(graph,subs_sink);m_graph.append_edge_attr(graph,subs_perf,subs_sink,create_slink("COLOR","NONE",size,1,1,false));process_subscene_links(graph);assign_render_targets(graph);return graph};
function create_subs_perf(){var subs_sink=init_subs("PERFORMANCE");return subs_sink}exports.find_on_screen=function(graph){var subs=null;m_graph.traverse(graph,function(node,attr){if(attr.camera&&attr.camera.framebuffer===null){subs=attr;return true}return false});return subs};exports.find_input=function(graph,subs,type){var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++)if(inputs[i].type===type)return inputs[i];return null};exports.has_lower_subs=has_lower_subs;function has_lower_subs(graph,
subs,type){if(subs.type===type)return true;var outputs=get_outputs(graph,subs);for(var i=0;i<outputs.length;i++)if(has_lower_subs(graph,outputs[i],type))return true;return false}exports.has_upper_subs=has_upper_subs;function has_upper_subs(graph,subs,type){if(subs.type===type)return true;var inputs=get_inputs(graph,subs);for(var i=0;i<inputs.length;i++)if(has_upper_subs(graph,inputs[i],type))return true;return false}function find_upper_subs(graph,subs,type){if(subs.type===type)return subs;var inputs=
get_inputs(graph,subs);for(var i=0;i<inputs.length;i++){var upper=find_upper_subs(graph,inputs[i],type);if(upper)return upper}return null}exports.get_inputs=get_inputs;function get_inputs(graph,subs){var node=m_graph.node_by_attr(graph,subs);if(node==m_graph.NULL_NODE)throw"Subscene not in graph";var inputs=[];var in_edge_count=m_graph.in_edge_count(graph,node);for(var i=0;i<in_edge_count;i++){var node_input=m_graph.get_in_edge(graph,node,i);if(node_input!=node)inputs.push(m_graph.get_node_attr(graph,
node_input))}return inputs}exports.get_outputs=get_outputs;function get_outputs(graph,subs){var node=m_graph.node_by_attr(graph,subs);if(node==m_graph.NULL_NODE)throw"Subscene not in graph";var outputs=[];var out_edge_count=m_graph.out_edge_count(graph,node);for(var i=0;i<out_edge_count;i++){var node_output=m_graph.get_out_edge(graph,node,i);if(node_output!=node)outputs.push(m_graph.get_node_attr(graph,node_output))}return outputs}exports.find_subs=function(graph,type){var subs=null;m_graph.traverse(graph,
function(node,attr){if(attr.type==type){subs=attr;return true}return false});return subs};exports.debug_convert_to_dot=function(graph){var PAPER_SIZE="11.7,16.5";var dot_str="digraph scenegraph {\n";dot_str+="    ";dot_str+='size="'+PAPER_SIZE+'";\n';dot_str+="    ";dot_str+='ratio="fill";\n';dot_str+="    ";dot_str+='node [shape=box margin="0.25,0.055"];\n';var tex_ids=debug_calc_tex_ids(graph);m_graph.traverse(graph,function(node,attr){dot_str+="    ";dot_str+=dot_format_node(node,attr,tex_ids)});
m_graph.traverse_edges(graph,function(node1,node2,attr){dot_str+="    ";dot_str+=dot_format_edge(node1,node2,attr,tex_ids)});dot_str+="}";return dot_str};function debug_calc_tex_ids(graph){var index_buf=[];var ids=[];traverse_slinks(graph,function(slink,internal,subs1,subs2){if(slink.texture){var num=index_buf.indexOf(slink.texture);if(num==-1){index_buf.push(slink.texture);ids.push(slink.texture,index_buf.length-1)}}});return ids}function dot_format_node(node,subs,tex_ids){var cam=subs.camera;var label=
"";var label=subs.type.replace(/_/g," ");if(subs.type=="POSTPROCESSING")label+=" ("+subs.pp_effect.replace(/_/g," ")+")";if(subs.camera){label+="\\n";for(var i=0;i<tex_ids.length;i+=2){var c_att=subs.camera.color_attachment;if(tex_ids[i]==c_att)if(m_tex.is_renderbuffer(c_att))label+="CR"+tex_ids[i+1]+" ";else label+="C"+tex_ids[i+1]+" "}for(var i=0;i<tex_ids.length;i+=2){var d_att=subs.camera.depth_attachment;if(tex_ids[i]==d_att)if(m_tex.is_renderbuffer(d_att))label+="DR"+tex_ids[i+1];else label+=
"D"+tex_ids[i+1]}}if(subs.slinks_internal.length)label+="\\n-----\\n";for(var i=0;i<subs.slinks_internal.length;i++)label+=dot_format_edge_label(subs.slinks_internal[i],node,null,tex_ids);var color="black";if(subs.type=="SINK")var style="dotted";else if(subs.enqueue)var style="solid";else var style="dashed";style+=",bold";return String(node)+' [label="'+label+'" '+'color="'+color+'" '+'style="'+style+'"'+"];\n"}function dot_format_edge(node1,node2,slink,tex_ids){var label=dot_format_edge_label(slink,
node1,node2,tex_ids);if(slink.active)var style="solid";else var style="dotted";return String(node1)+" -> "+String(node2)+' [label="'+label+'" '+'style="'+style+'"];\n'}function dot_format_edge_label(slink,node1,node2,tex_ids){function filters_to_string(filters){var string="";if(filters.min==m_tex.TF_LINEAR)string+="L";else if(filters.min==m_tex.TF_NEAREST)string+="N";if(filters.mag==m_tex.TF_LINEAR)string+="L";else if(filters.mag==m_tex.TF_NEAREST)string+="N";return string}var label="";label+=slink.from+
"\\n";label+=slink.to!="NONE"?slink.to+"\\n":"";label+="(";if(slink.update_dim){var size_mult_x=slink.size_mult_x;var size_mult_y=slink.size_mult_y;if(Math.round(size_mult_x)!=size_mult_x)size_mult_x=size_mult_x.toFixed(2);if(Math.round(size_mult_y)!=size_mult_y)size_mult_y=size_mult_y.toFixed(2);var size_x=(size_mult_x==1?"":size_mult_x)+"S";var size_y=(size_mult_y==1?"":size_mult_y)+"S";label+=size_x+"x"+size_y}else{var size_mult_x=slink.size_mult_x;var size_mult_y=slink.size_mult_y;label+=slink.size*
size_mult_x+"x"+slink.size*size_mult_y}if(slink.from!="SCREEN"){label+=" ";if(slink.use_renderbuffer)label+="RR";else label+=filters_to_string({min:slink.min_filter,mag:slink.mag_filter});for(var i=0;i<tex_ids.length;i+=2)if(tex_ids[i]==slink.texture)label+=" "+tex_ids[i+1]}label+=")"+"\\n";return label}exports.create_rendering_queue=function(graph){var subscenes=m_graph.topsort_attr(graph);var queue=[];for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.enqueue)queue.push(subs)}return queue}};b4w.module["__textures"]=function(exports,require){var m_compat=require("__compat");var m_cfg=require("__config");var m_dds=require("__dds");var m_debug=require("__debug");var m_ext=require("__extensions");var m_print=require("__print");var m_time=require("__time");var m_util=require("__util");var m_ren=require("__renderer");var m_obj_util=require("__obj_util");var m_curve=require("__curve");var m_vec3=require("__vec3");var cfg_def=m_cfg.defaults;var cfg_sfx=m_cfg.sfx;var _tmpcanvas=null;var _w_texture_tmp=
null;var _w_framebuffer_tmp=null;exports.TF_NEAREST=0;exports.TF_LINEAR=0;exports.TF_NEAREST_MIPMAP_NEAREST=0;exports.TF_LINEAR_MIPMAP_NEAREST=0;exports.TF_NEAREST_MIPMAP_LINEAR=0;exports.TF_LINEAR_MIPMAP_LINEAR=0;exports.TT_RGBA_INT=10;exports.TT_RGB_INT=20;exports.TT_RGBA_FLOAT=30;exports.TT_RGB_FLOAT=40;exports.TT_DEPTH=50;exports.TT_RB_RGBA=60;exports.TT_RB_DEPTH=70;exports.TT_RB_RGBA_MS=80;exports.TT_RB_DEPTH_MS=90;exports.CURVE_NODES_TEXT_SIZE=128;exports.COLORRAMP_TEXT_SIZE=128;exports.PART_COLORRAMP_TEXT_SIZE=
128;var _canvas_textures_cache={};var _video_textures_cache={};var PLAYBACK_RATE=2;var _gl=null;var LEVELS;var BEZIER_ROOT_PRECISION=.001;var FLT_EPSILON=1E-8;exports.setup_context=function(gl){LEVELS=[gl.NEAREST_MIPMAP_NEAREST,gl.NEAREST_MIPMAP_LINEAR,gl.LINEAR_MIPMAP_NEAREST,gl.LINEAR_MIPMAP_LINEAR];exports.TF_NEAREST=gl.NEAREST;exports.TF_LINEAR=gl.LINEAR;exports.TF_NEAREST_MIPMAP_NEAREST=gl.NEAREST_MIPMAP_NEAREST;exports.TF_LINEAR_MIPMAP_NEAREST=gl.LINEAR_MIPMAP_NEAREST;exports.TF_NEAREST_MIPMAP_LINEAR=
gl.NEAREST_MIPMAP_LINEAR;exports.TF_LINEAR_MIPMAP_LINEAR=gl.LINEAR_MIPMAP_LINEAR;_gl=gl};exports.get_canvas_context=function(id,data_id){if(data_id in _canvas_textures_cache&&id in _canvas_textures_cache[data_id])return _canvas_textures_cache[data_id][id].canvas_context;else return null};exports.update_canvas_context=function(id,data_id){if(data_id in _canvas_textures_cache&&id in _canvas_textures_cache[data_id]){update_texture_canvas(_canvas_textures_cache[data_id][id]);return true}else return false};
function init_texture(){return{name:"",type:0,source:"",source_id:"",width:0,height:0,compress_ratio:1,allow_node_dds:true,source_size:1024,enable_canvas_mipmapping:false,canvas_context:null,w_target:0,w_texture:null,w_renderbuffer:null,is_movie:false,vtex_data_id:-1,video_file:null,movie_length:0,fps:0,frame_start:0,frame_offset:0,frame_duration:0,need_resize:false,scale_fac:1,seq_video:null,seq_movie_length:0,seq_fps:0,seq_cur_frame:-1,seq_video_played:false,seq_last_discrete_mark:-1,video_was_stopped:false,
use_auto_refresh:false,use_cyclic:false,use_nla:false,repeat:true}}exports.create_texture=function(name,type){var texture=init_texture();texture.name=name;texture.type=type;texture.source="NONE";if(type==exports.TT_RB_RGBA||type==exports.TT_RB_DEPTH||type==exports.TT_RB_RGBA_MS||type==exports.TT_RB_DEPTH_MS)texture.w_renderbuffer=_gl.createRenderbuffer();else{var w_target=_gl.TEXTURE_2D;var w_texture=_gl.createTexture();_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,
_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.bindTexture(w_target,null);texture.w_target=w_target;texture.w_texture=w_texture}return texture};exports.create_cubemap_texture=function(name,size){var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target,w_texture);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,
_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);var infos=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"];for(var i=0;i<6;i++){var info=infos[i];_gl.texImage2D(_gl[info],0,_gl.RGBA,size,size,0,_gl.RGBA,_gl.UNSIGNED_BYTE,
null)}_gl.bindTexture(w_target,null);var texture=init_texture();texture.name=name;texture.type=exports.TT_RGBA_INT;texture.source="NONE";texture.width=3*size;texture.height=2*size;texture.compress_ratio=1;texture.w_texture=w_texture;texture.w_target=_gl.TEXTURE_CUBE_MAP;return texture};exports.set_filters=function(texture,min_filter,mag_filter){if(is_renderbuffer(texture))return;var w_target=texture.w_target;var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);if(min_filter)_gl.texParameteri(w_target,
_gl.TEXTURE_MIN_FILTER,min_filter);if(mag_filter)_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,mag_filter);_gl.bindTexture(w_target,null)};exports.get_filters=function(texture){if(is_renderbuffer(texture))return{min:exports.TF_NEAREST,mag:exports.TF_NEAREST};var w_target=texture.w_target;var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);var min=_gl.getTexParameter(w_target,_gl.TEXTURE_MIN_FILTER);var mag=_gl.getTexParameter(w_target,_gl.TEXTURE_MAG_FILTER);_gl.bindTexture(w_target,
null);return{min:min,mag:mag}};exports.resize=function(texture,width,height){var width=Math.max(width,cfg_def.edge_min_tex_size_hack?2:1);var height=Math.max(height,cfg_def.edge_min_tex_size_hack?2:1);if(texture.width==width&&texture.height==height)return;switch(texture.type){case exports.TT_RB_RGBA:_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture.w_renderbuffer);_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.RGB565,width,height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);break;case exports.TT_RB_DEPTH:_gl.bindRenderbuffer(_gl.RENDERBUFFER,
texture.w_renderbuffer);_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,width,height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);break;case exports.TT_RB_RGBA_MS:_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture.w_renderbuffer);_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,cfg_def.msaa_samples,_gl.RGBA8,width,height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);break;case exports.TT_RB_DEPTH_MS:_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture.w_renderbuffer);_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,
cfg_def.msaa_samples,_gl.DEPTH_COMPONENT24,width,height);_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);break;default:var w_tex=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_tex);var format=get_image2d_format(texture);var iformat=get_image2d_iformat(texture);var type=get_image2d_type(texture);_gl.texImage2D(w_target,0,iformat,width,height,0,format,type,null);_gl.bindTexture(w_target,null);break}if(check_texture_size(width,height)){m_print.error('Slink texture "'+texture.name+
'" has unsupported size: '+width+"x"+height+". Max available: "+cfg_def.max_texture_size+"x"+cfg_def.max_texture_size+".");return}texture.width=width;texture.height=height};exports.create_texture_bpy=create_texture_bpy;function create_texture_bpy(bpy_texture,global_af,bpy_scenes,thread_id){var tex_type=bpy_texture["type"];var image_data=new Uint8Array([.8*255,.8*255,.8*255,1*255]);var texture=init_texture();switch(tex_type){case "DATA_TEX2D":case "IMAGE":var w_texture=_gl.createTexture();var w_target=
_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);if(bpy_texture["image"]&&bpy_texture["image"]["source"]=="MOVIE"){texture.is_movie=true;texture.frame_start=bpy_texture["frame_start"];texture.frame_offset=bpy_texture["frame_offset"];texture.frame_duration=bpy_texture["frame_duration"];texture.use_auto_refresh=bpy_texture["use_auto_refresh"];texture.use_cyclic=bpy_texture["use_cyclic"];texture.movie_length=bpy_texture["movie_length"];
texture.use_nla=bpy_texture["b4w_nla_video"];if(texture.frame_offset!=0)m_print.warn('Frame offset for texture "'+bpy_texture["name"]+'" has a nonzero value. Can lead to undefined behaviour'+" for mobile devices.")}break;case "NONE":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);if(bpy_texture["b4w_source_type"]=="NONE")return null;else if(bpy_texture["b4w_source_type"]=="SCENE"){if(!bpy_texture["b4w_source_id"])return null;var name=bpy_texture["b4w_source_id"];
var scene=m_util.keysearch("name",name,bpy_scenes);if(scene){texture.source_size=bpy_texture["b4w_source_size"];scene._render_to_textures=scene._render_to_textures||[];scene._render_to_textures.push(bpy_texture);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data)}else return null}break;case "ENVIRONMENT_MAP":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_CUBE_MAP;_gl.bindTexture(w_target,w_texture);var targets=["POSITIVE_X","NEGATIVE_X","POSITIVE_Y","NEGATIVE_Y",
"POSITIVE_Z","NEGATIVE_Z"];for(var i=0;i<6;i++)_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+targets[i]],0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);break;case "BLEND":return null;case "NODE_TEX":var w_texture=_gl.createTexture();var w_target=_gl.TEXTURE_2D;_gl.bindTexture(w_target,w_texture);_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);break;default:m_print.error('texture "'+bpy_texture["name"]+'" has unsupported type "'+tex_type+'"');return null}if(tex_type==
"NONE"&&!(bpy_texture["b4w_enable_canvas_mipmapping"]&&bpy_texture["b4w_source_type"]=="CANVAS")||tex_type=="DATA_TEX2D"||tex_type=="IMAGE"&&bpy_texture["image"]["source"]=="MOVIE"||tex_type=="NODE_TEX")_gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);else _gl.texParameteri(w_target,_gl.TEXTURE_MIN_FILTER,LEVELS[cfg_def.texture_min_filter]);_gl.texParameteri(w_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);setup_anisotropic_filtering(bpy_texture,global_af,w_target);var tex_extension=bpy_texture["extension"];
if(tex_extension=="REPEAT"&&!bpy_texture["b4w_shore_dist_map"]){_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.REPEAT);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.REPEAT)}else{texture.repeat=false;_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(w_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE)}texture.type=exports.TT_RGBA_INT;texture.width=1;texture.height=1;texture.w_texture=w_texture;texture.w_target=w_target;if(bpy_texture["b4w_source_type"]=="CANVAS"&&
tex_type=="NONE"){var id=bpy_texture["b4w_source_id"];var size=bpy_texture["b4w_source_size"];texture.enable_canvas_mipmapping=bpy_texture["b4w_enable_canvas_mipmapping"];texture.source_id=id;texture.source="CANVAS";update_canvas_props(id,size,texture);if(!(thread_id in _canvas_textures_cache))_canvas_textures_cache[thread_id]={};_canvas_textures_cache[thread_id][id]=texture;update_texture_canvas(texture)}else if(bpy_texture["b4w_source_type"]=="SCENE"&&tex_type=="NONE"){texture.source_id=bpy_texture["b4w_source_id"];
texture.source="SCENE"}else{texture.source=tex_type;_gl.generateMipmap(w_target);_gl.bindTexture(w_target,null)}texture.name=bpy_texture["name"];bpy_texture._render=texture;return texture}function setup_anisotropic_filtering(bpy_texture,global_af,w_target){var af=bpy_texture["b4w_anisotropic_filtering"];if(af==="DEFAULT")af=global_af;if(af!=="OFF"&&cfg_def.anisotropic_filtering){var ext_aniso=m_ext.get_aniso();if(ext_aniso){af=parseFloat(af.split("x")[0]);_gl.texParameterf(w_target,ext_aniso.TEXTURE_MAX_ANISOTROPY_EXT,
af)}}}function update_canvas_props(name,size,texture){var canvas=document.createElement("canvas");canvas.width=size;canvas.height=size;texture.canvas_context=canvas.getContext("2d")}function update_texture_canvas(texture){if(texture.source!="CANVAS")throw"Wrong texture";var w_texture=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);var w_format=get_image2d_format(texture);var w_iformat=get_image2d_iformat(texture);var w_type=get_image2d_type(texture);var canvas=
texture.canvas_context.canvas;_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);_gl.texImage2D(w_target,0,w_iformat,w_format,w_type,canvas);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,false);if(texture.enable_canvas_mipmapping)_gl.generateMipmap(w_target);_gl.bindTexture(w_target,null);texture.width=canvas.width;texture.height=canvas.height}exports.update_video_texture=update_video_texture;function update_video_texture(texture){var w_texture=texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,
w_texture);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);if(texture.video_file.length!=4)if(texture.need_resize)draw_resized_image(texture,texture.video_file,texture.width*texture.scale_fac,texture.height*texture.scale_fac,false);else _gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.video_file);else _gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.video_file);_gl.bindTexture(w_target,null)}exports.update_seq_video_texture=update_seq_video_texture;function update_seq_video_texture(texture){var w_texture=
texture.w_texture;var w_target=texture.w_target;_gl.bindTexture(w_target,w_texture);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);if(texture.need_resize)draw_resized_image(texture,texture.seq_video[texture.seq_cur_frame],texture.width*texture.scale_fac,texture.height*texture.scale_fac,false);else _gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,texture.seq_video[texture.seq_cur_frame]);_gl.bindTexture(w_target,null)}function get_tmp_canvas(){if(!_tmpcanvas)_tmpcanvas=document.createElement("canvas");
return _tmpcanvas}function draw_resized_image(texture,image_data,width,height,is_dds){if(!is_dds){setup_resized_tex_data(_gl.TEXTURE_2D);_gl.texImage2D(_gl.TEXTURE_2D,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data)}_gl.bindTexture(_gl.TEXTURE_2D,null);m_ren.draw_resized_texture(texture,width,height,_w_framebuffer_tmp,_w_texture_tmp,"NONE")}function resize_cube_map(texture,image_data,pot_dim,img_dim){setup_resized_tex_data(_gl.TEXTURE_2D);_gl.texImage2D(_gl.TEXTURE_2D,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,
image_data);_gl.bindTexture(_gl.TEXTURE_2D,null);for(var i=0;i<6;i++)_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_POSITIVE_X"]+i,0,_gl.RGBA,pot_dim,pot_dim,0,_gl.RGBA,_gl.UNSIGNED_BYTE,null);_gl.bindTexture(texture.w_target,null);_gl.bindFramebuffer(_gl.FRAMEBUFFER,_w_framebuffer_tmp);for(var i=0;i<6;i++)m_ren.draw_resized_cubemap_texture(texture,_gl["TEXTURE_CUBE_MAP_POSITIVE_X"]+i,pot_dim,img_dim,_w_texture_tmp,i);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null);_gl.bindTexture(texture.w_target,texture.w_texture);
_gl.texParameteri(texture.w_target,_gl.TEXTURE_MIN_FILTER,LEVELS[cfg_def.texture_min_filter]);_gl.texParameteri(texture.w_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR)}function resize_cube_map_canvas(texture,image_data,img_dim,pot_dim,infos){for(var i=0;i<6;i++){var info=infos[i];var tmpcanvas=get_tmp_canvas();tmpcanvas.width=pot_dim;tmpcanvas.height=pot_dim;var ctx=tmpcanvas.getContext("2d");if(info[0]=="POSITIVE_Y"||info[0]=="NEGATIVE_Y"){ctx.translate(0,pot_dim);ctx.scale(1,-1)}else{ctx.translate(pot_dim,
0);ctx.scale(-1,1)}ctx.drawImage(image_data,info[1]*img_dim,info[2]*img_dim,img_dim,img_dim,0,0,pot_dim,pot_dim);_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+info[0]],0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,tmpcanvas)}}function setup_resized_tex_data(w_target){if(!_w_framebuffer_tmp)_w_framebuffer_tmp=_gl.createFramebuffer();_gl.bindTexture(w_target,null);if(!_w_texture_tmp)_w_texture_tmp=_gl.createTexture();_gl.bindTexture(w_target,_w_texture_tmp);prepare_npot_texture(w_target)}exports.update_texture=update_texture;
function update_texture(texture,image_data,is_dds,filepath,thread_id){var tex_type=texture.source;var w_texture=texture.w_texture;var w_target=texture.w_target;var width=1;var height=1;_gl.bindTexture(w_target,w_texture);if(image_data.length==4){var update_color=true;var image_data=new Uint8Array([image_data[0]*255,image_data[1]*255,image_data[2]*255,image_data[3]*255])}if(tex_type=="IMAGE")if(update_color){_gl.texImage2D(w_target,0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data);texture.width=
1;texture.height=1}else if(is_dds){var dds_wh=m_dds.get_width_height(image_data);var is_npot=m_util.check_npot(dds_wh.width)||m_util.check_npot(dds_wh.height);if(check_texture_size(dds_wh.width,dds_wh.height)){m_print.error('Texture "'+filepath+'" has unsupported size: '+dds_wh.width+"x"+dds_wh.height+". Max available: "+cfg_def.max_texture_size+"x"+cfg_def.max_texture_size+".");return}var width=dds_wh.width;var height=dds_wh.height;if(is_npot){texture.need_resize=true;setup_resized_tex_data(w_target);
width=calc_pot_size(width*texture.scale_fac);height=calc_pot_size(height*texture.scale_fac)}m_dds.upload_dds_levels(_gl,m_ext.get_s3tc(),image_data,true);if(texture.need_resize){draw_resized_image(texture,null,width,height,true);_gl.bindTexture(w_target,w_texture);_gl.generateMipmap(w_target)}texture.width=width;texture.height=height;texture.compress_ratio=m_dds.get_compress_ratio(image_data)}else{_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,true);if(texture.is_movie)if(cfg_def.seq_video_fallback){width=
image_data[0].width;height=image_data[0].height}else{width=image_data.videoWidth;height=image_data.videoHeight}else{width=image_data.width;height=image_data.height}texture.width=width;texture.height=height;if(check_texture_size(width,width)){m_print.warn('Texture "'+filepath+'" has unsupported size: '+width+"x"+height+". Max available: "+cfg_def.max_texture_size+"x"+cfg_def.max_texture_size+". Reduced image size will be used.");texture.scale_fac=Math.min(cfg_def.max_texture_size/width,cfg_def.max_texture_size/
height);texture.need_resize=true}if(texture.is_movie)if(!cfg_def.seq_video_fallback){if(!(thread_id in _video_textures_cache))_video_textures_cache[thread_id]={};_video_textures_cache[thread_id][texture.name]=texture;texture.video_file=image_data;texture.video_file.loop=texture.use_cyclic;texture.fps=image_data.duration?texture.movie_length/image_data.duration:m_time.get_framerate();if(!cfg_sfx.disable_playback_rate_hack){image_data.playbackRate=m_time.get_framerate()/texture.fps;if(cfg_sfx.clamp_playback_rate_hack&&
image_data.playbackRate>PLAYBACK_RATE)image_data.playbackRate=PLAYBACK_RATE}var draw_data=image_data;create_oncanplay_handler(texture)}else{if(!(thread_id in _video_textures_cache))_video_textures_cache[thread_id]={};_video_textures_cache[thread_id][texture.name]=texture;texture.seq_video=image_data;texture.seq_movie_length=image_data.length;texture.fps=texture.seq_fps*texture.movie_length/image_data.length;var draw_data=image_data[0]}else var draw_data=image_data;var width=calc_pot_size(texture.width*
texture.scale_fac);var height=calc_pot_size(texture.height*texture.scale_fac);if(!texture.need_resize)if(m_util.check_npot(texture.width)||m_util.check_npot(texture.height)){draw_resized_image(texture,draw_data,width,height,false);texture.need_resize=true}else _gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,draw_data);else{var canvas=get_tmp_canvas();var ctx=canvas.getContext("2d");canvas.width=width;canvas.height=height;ctx.drawImage(draw_data,0,0,texture.width,texture.height,0,0,width,
height);_gl.texImage2D(w_target,0,_gl.RGBA,_gl.RGBA,_gl.UNSIGNED_BYTE,canvas)}var w_texture=texture.w_texture;_gl.bindTexture(w_target,w_texture);if(!texture.is_movie)_gl.generateMipmap(w_target);_gl.bindTexture(w_target,null);texture.width=width;texture.height=height}else if(tex_type=="ENVIRONMENT_MAP"){var infos=[["POSITIVE_X",2,0],["NEGATIVE_X",0,0],["POSITIVE_Y",1,1],["NEGATIVE_Y",0,1],["POSITIVE_Z",1,0],["NEGATIVE_Z",2,1]];if(update_color){for(var i=0;i<6;i++){var info=infos[i];_gl.texImage2D(_gl["TEXTURE_CUBE_MAP_"+
info[0]],0,_gl.RGBA,1,1,0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data)}texture.width=3;texture.height=2}else{_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,false);if(image_data.width%3||image_data.height%2){m_print.error('Cubemap texture "'+filepath+'" has unsupported size: '+image_data.width+"x"+image_data.height+". The width must be multiple"+" of three and the height - multiple of two.");return}var img_dim=image_data.width/3;if(check_cube_map_size(img_dim)){m_print.warn('Cubemap texture "'+filepath+'" has unsupported size: '+
image_data.width+"x"+image_data.height+". Max available: "+cfg_def.max_cube_map_size*3+"x"+cfg_def.max_cube_map_size*2+". "+"Reduced image size will be used.");var scale_fac=cfg_def.max_cube_map_size/img_dim;var tex_dim=calc_pot_size(img_dim*scale_fac);texture.need_resize=true}else{var tex_dim=calc_pot_size(img_dim);if(check_texture_size(3*tex_dim,2*tex_dim))texture.need_resize=true}if(texture.need_resize||cfg_def.resize_cubemap_canvas_hack)resize_cube_map_canvas(texture,image_data,img_dim,tex_dim,
infos);else resize_cube_map(texture,image_data,tex_dim,img_dim);if(m_debug.check_ff_cubemap_out_of_memory()){m_print.warn("Firefox detected, setting max cubemap size to 256, use canvas for resizing.");resize_cube_map_canvas(texture,image_data,img_dim,m_compat.NVIDIA_OLD_GPU_CUBEMAP_MAX_SIZE,infos)}texture.width=3*tex_dim;texture.height=2*tex_dim;_gl.generateMipmap(w_target)}}else if(tex_type=="DATA_TEX2D"||tex_type=="NODE_TEX"){_gl.texImage2D(w_target,0,_gl.RGBA,image_data.width,image_data.height,
0,_gl.RGBA,_gl.UNSIGNED_BYTE,image_data.data);texture.width=image_data.width;texture.height=image_data.height}_gl.bindTexture(w_target,null)}function create_oncanplay_handler(tex){tex.video_file.oncanplay=function(){update_video_texture(tex)}}function prepare_npot_texture(tex_target){_gl.texParameteri(tex_target,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(tex_target,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(tex_target,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.texParameteri(tex_target,
_gl.TEXTURE_MIN_FILTER,_gl.LINEAR)}function calc_pot_size(num){if(m_util.check_npot(num)){var size=Math.pow(2,parseInt(num).toString(2).length);return m_util.clamp(size,2,cfg_def.max_texture_size)}return num}function get_image2d_format(texture){var format;switch(texture.type){case exports.TT_RGBA_INT:format=_gl.RGBA;break;case exports.TT_RGB_INT:format=_gl.RGB;break;case exports.TT_RGBA_FLOAT:format=_gl.RGBA;break;case exports.TT_RGB_FLOAT:format=_gl.RGB;break;case exports.TT_DEPTH:format=_gl.DEPTH_COMPONENT;
break;default:throw"Wrong texture type";break}return format}function get_image2d_iformat(texture){var format;switch(texture.type){case exports.TT_RGBA_INT:format=cfg_def.webgl2?_gl.RGBA8:_gl.RGBA;break;case exports.TT_RGB_INT:format=cfg_def.webgl2?_gl.RGB8:_gl.RGB;break;case exports.TT_RGBA_FLOAT:format=cfg_def.webgl2?_gl.RGBA8:_gl.RGBA;break;case exports.TT_RGB_FLOAT:format=cfg_def.webgl2?_gl.RGB8:_gl.RGB;break;case exports.TT_DEPTH:format=cfg_def.webgl2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;
break;default:throw"Wrong texture type";break}return format}function get_image2d_type(texture){var type;switch(texture.type){case exports.TT_RGBA_INT:type=_gl.UNSIGNED_BYTE;break;case exports.TT_RGB_INT:type=_gl.UNSIGNED_BYTE;break;case exports.TT_RGBA_FLOAT:type=_gl.FLOAT;break;case exports.TT_RGB_FLOAT:type=_gl.FLOAT;break;case exports.TT_DEPTH:type=_gl.UNSIGNED_INT;break;default:throw"Wrong texture type";break}return type}exports.delete_texture=function(texture){_gl.deleteTexture(texture)};exports.is_texture=
function(tex){if(tex&&tex.name&&(tex.w_texture||tex.w_renderbuffer))return true;else return false};exports.is_renderbuffer=is_renderbuffer;function is_renderbuffer(tex){if(tex&&tex.name&&tex.w_renderbuffer)return true;else return false}exports.is_float=function(tex){if(tex.type==exports.TT_RGBA_FLOAT||tex.type==exports.TT_RGB_FLOAT)return true;else return false};exports.get_texture_texel_size=function(tex){var size=0;switch(tex.type){case exports.TT_RGBA_INT:case exports.TT_RGB_INT:size=4;break;case exports.TT_RGBA_FLOAT:case exports.TT_RGB_FLOAT:size=
16;break;case exports.TT_DEPTH:size=3;break;case exports.TT_RB_RGBA:case exports.TT_RB_DEPTH:size=2;break;case exports.TT_RB_RGBA_MS:size=4*cfg_def.msaa_samples;break;case exports.TT_RB_DEPTH_MS:size=3*cfg_def.msaa_samples;break}return size};function check_texture_size(width,height){return width>cfg_def.max_texture_size||height>cfg_def.max_texture_size}function check_cube_map_size(size){return size>cfg_def.max_cube_map_size}exports.generate_texture=generate_texture;function generate_texture(type,
subs,name){var texture=null;switch(type){case "SSAO_TEXTURE":texture={"name":"special_ssao_texture","type":"DATA_TEX2D","extension":"REPEAT","b4w_anisotropic_filtering":"OFF"};create_texture_bpy(texture,null,subs,0);texture["image"]={"filepath":null};break;case "NODE_TEX":texture={"name":name,"type":"NODE_TEX","extension":"CLIP","b4w_anisotropic_filtering":"OFF"};create_texture_bpy(texture,null,subs,0);texture["image"]={"filepath":null};break;default:break}return texture}exports.cleanup=function(){if(!cfg_def.seq_video_fallback)for(var data_id in _video_textures_cache)for(var tex in _video_textures_cache[data_id]){_video_textures_cache[data_id][tex].video_file.pause();
_video_textures_cache[data_id][tex].video_file.src="";_video_textures_cache[data_id][tex].video_file.load()}_canvas_textures_cache={};_video_textures_cache={}};exports.pause=function(){for(var data_id in _video_textures_cache)for(var vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(!video_is_played(vtex))continue;pause_video(vtex_name,data_id);vtex.video_was_stopped=true}};exports.reset=function(){for(var data_id in _video_textures_cache)for(var vtex_name in _video_textures_cache[data_id]){reset_video(vtex_name,
data_id);_video_textures_cache[data_id][vtex_name].video_was_stopped=false}};exports.play=function(resume_stopped_only){for(var data_id in _video_textures_cache)for(var vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(resume_stopped_only&&!vtex.video_was_stopped)continue;play_video(vtex_name,data_id);vtex.video_was_stopped=false}};exports.video_allow_nla=video_allow_nla;function video_allow_nla(vtex_name,data_id){if(data_id in _video_textures_cache&&
vtex_name in _video_textures_cache[data_id])return _video_textures_cache[data_id][vtex_name].use_nla;return false}exports.play_video=play_video;function play_video(vtex_name,data_id){if(data_id in _video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.play();else if(vtex.seq_video)vtex.seq_video_played=true;return true}else return false}exports.pause_video=pause_video;function pause_video(vtex_name,
data_id){if(data_id in _video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.pause();else if(vtex.seq_video)vtex.seq_video_played=false;return true}else return false}exports.reset_video=reset_video;function reset_video(vtex_name,data_id){if(data_id in _video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.currentTime=
vtex.frame_offset/vtex.fps;else if(vtex.seq_video){vtex.seq_cur_frame=video_frame_to_seq_frame(vtex,vtex.frame_offset);update_seq_video_texture(vtex)}return true}else return false}exports.set_frame_video=function(vtex_name,frame,data_id){if(data_id in _video_textures_cache&&vtex_name in _video_textures_cache[data_id]){var vtex=_video_textures_cache[data_id][vtex_name];if(vtex.video_file)vtex.video_file.currentTime=frame/vtex.fps;else if(vtex.seq_video){vtex.seq_cur_frame=frame;update_seq_video_texture(vtex)}return true}else return false};
exports.video_is_played=video_is_played;function video_is_played(vtex){if(vtex.video_file)return!vtex.video_file.paused;else if(vtex.seq_video)return vtex.seq_video_played;else return false}exports.video_update_is_available=function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;if(vtex.video_file)return vtex.video_file.readyState>=2;else return true};exports.video_get_current_frame=function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;if(vtex.video_file)return Math.round(vtex.video_file.currentTime*
vtex.fps);else return vtex.seq_cur_frame};exports.video_get_start_frame=function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;if(vtex.video_file)return vtex.frame_offset;else return video_frame_to_seq_frame(vtex,vtex.frame_offset)};exports.video_get_end_frame=function(vtex){if(!vtex.video_file&&!vtex.seq_video)return 0;var duration=Math.min(vtex.frame_duration,vtex.movie_length-vtex.frame_offset);if(vtex.video_file)return vtex.frame_offset+duration;else return video_frame_to_seq_frame(vtex,
vtex.frame_offset+duration)};exports.seq_video_get_discrete_timemark=function(vtex,time){return Math.round(time*vtex.seq_fps*(m_time.get_framerate()/vtex.fps))};exports.video_get_duration=function(vtex){return Math.min(vtex.frame_duration,vtex.movie_length-vtex.frame_offset)};exports.video_frame_to_seq_frame=video_frame_to_seq_frame;function video_frame_to_seq_frame(vtex,frame){return Math.round(frame*vtex.seq_movie_length/vtex.movie_length)}exports.get_canvas_context_by_object=function(object,texture_name){var texture=
get_texture_by_name(object,texture_name);if(texture&&texture.source=="CANVAS")return texture.canvas_context;else return null};exports.update_canvas_context_by_object=function(object,texture_name){var texture=get_texture_by_name(object,texture_name);if(texture&&texture.source=="CANVAS"){update_texture_canvas(texture);return true}else return false};function get_texture_by_name(object,texture_name){if(m_obj_util.is_dynamic(object))return find_texture_by_name(object,texture_name);else{var objects=object.meta_objects;
for(var i=0;i<objects.length;i++){var texture=find_texture_by_name(objects[i],texture_name);if(texture)return texture}}return null}function find_texture_by_name(obj,texture_name){var texture=null;var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var scene_data=scenes_data[j];var batches=scene_data.batches;for(var k=0;k<batches.length;k++){var batch=batches[k];for(var p=0;p<batch.textures.length;p++)if(batch.textures[p].name==texture_name){texture=batch.textures[p];break}}}return texture}
function copy_canvas_texture(texture){var new_texture=init_texture();new_texture.name=texture.name;new_texture.source="CANVAS";new_texture.width=texture.width;new_texture.height=texture.height;new_texture.enable_canvas_mipmapping=texture.enable_canvas_mipmapping;new_texture.type=texture.type;var canvas=document.createElement("canvas");canvas.width=new_texture.width;canvas.height=new_texture.height;new_texture.canvas_context=canvas.getContext("2d");new_texture.w_target=_gl.TEXTURE_2D;new_texture.w_texture=
_gl.createTexture();_gl.bindTexture(_gl.TEXTURE_2D,new_texture.w_texture);if(new_texture.enable_canvas_mipmapping)_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,LEVELS[cfg_def.texture_min_filter]);else _gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,_gl.LINEAR);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,_gl.LINEAR);_gl.bindTexture(_gl.TEXTURE_2D,null);return new_texture}exports.share_batch_canvas_textures=function(batches){var canvas_textures={};for(var i=0;i<batches.length;i++){var textures=
batches[i].textures;var batch_textures=[];for(var j=0;j<textures.length;j++){var texture=textures[j];if(texture.source=="CANVAS")if(texture.name in canvas_textures)texture=canvas_textures[texture.name];else{texture=copy_canvas_texture(textures[j]);draw_canvas_to_canvas(texture,textures[j]);canvas_textures[texture.name]=texture}batch_textures.push(texture)}batches[i].textures=batch_textures}};function draw_canvas_to_canvas(new_tex,old_tex){var old_ctx=old_tex.canvas_context;var new_ctx=new_tex.canvas_context;
new_ctx.drawImage(old_ctx.canvas,0,0);update_texture_canvas(new_tex)}exports.create_color_ramp_texture=function(nodes,points_num){var texture=[];for(var j=0;j<nodes.length;j++){var bpy_node=nodes[j].data.value;calc_color_ramp_data(bpy_node["color_ramp"],points_num,texture)}return new Uint8Array(texture.map(function(val){return m_util.clamp(val*255,0,255)}))};exports.calc_color_ramp_data=calc_color_ramp_data;function calc_color_ramp_data(color_ramp,points_num,texture){var elements=color_ramp["elements"];
var type=color_ramp["interpolation"];for(var i=0;i<points_num;i++){var curr_position=i/(points_num-1);var left_elem=find_left_elem(elements,curr_position,true);var right_elem=find_right_elem(elements,curr_position,true);if(left_elem&&right_elem)if(type=="CONSTANT")texture.push.apply(texture,left_elem.color);else create_linear_middle(texture,left_elem,right_elem,curr_position);if(right_elem&&!left_elem)texture.push.apply(texture,right_elem.color);if(left_elem&&!right_elem)texture.push.apply(texture,
left_elem.color)}}function create_linear_middle(texture,left_elem,right_elem,curr_position){if(left_elem==right_elem)texture.push.apply(texture,left_elem["color"]);else{var r=m_curve.linear_interpolation(right_elem["color"][0],right_elem["position"],left_elem["color"][0],left_elem["position"],curr_position);texture.push(r);var g=m_curve.linear_interpolation(right_elem["color"][1],right_elem["position"],left_elem["color"][1],left_elem["position"],curr_position);texture.push(g);var b=m_curve.linear_interpolation(right_elem["color"][2],
right_elem["position"],left_elem["color"][2],left_elem["position"],curr_position);texture.push(b);var a=m_curve.linear_interpolation(right_elem["color"][3],right_elem["position"],left_elem["color"][3],left_elem["position"],curr_position);texture.push(a)}}function find_left_elem(elements,curr_pos,is_color_ramp){var left_elem=null;for(var i=0;i<elements.length;i++){if(is_color_ramp)var dist=curr_pos-elements[i]["position"];else var dist=curr_pos-elements[i][1][0];if(dist>=0)if(left_elem){if(is_color_ramp)var cur_dist=
curr_pos-left_elem["position"];else var cur_dist=curr_pos-elements[i][1][0];if(dist<=cur_dist)left_elem=elements[i]}else left_elem=elements[i]}return left_elem}function find_right_elem(elements,curr_pos,is_color_ramp){var right_elem=null;for(var i=0;i<elements.length;i++){if(is_color_ramp)var dist=elements[i]["position"]-curr_pos;else var dist=elements[i][1][0]-curr_pos;if(dist>=0)if(right_elem){if(is_color_ramp)var cur_dist=right_elem["position"]-curr_pos;else var cur_dist=right_elem[1][0]-curr_pos;
if(dist<=cur_dist)right_elem=elements[i]}else right_elem=elements[i]}return right_elem}exports.create_vec_curve_texture=function(nodes,points_num){var _vec3_tmp=new Float32Array(3);var vec=new Float32Array(3);var textures=[];for(var q=0;q<nodes.length;q++){var bpy_node=nodes[q].data.value;var channels=[];var curves=bpy_node["curve_mapping"]["curves_data"];var points_ext_types=bpy_node["curve_mapping"]["curve_extend"];var curves_handle_types=bpy_node["curve_mapping"]["curves_handle_types"];for(var i=
0;i<curves.length;i++){var type=points_ext_types[i];var curve=curves[i];var bezts=[];var curve_handle_types=curves_handle_types[i];for(var j=0;j<curve.length;j++)bezts.push([new Float32Array(3),new Float32Array(curve[j].concat(0)),new Float32Array(3)]);m_curve.calchandle_curvemap(bezts[0],null,bezts[1],curve_handle_types[0],curve_handle_types[0]);for(var j=1;j<bezts.length-1;j++)m_curve.calchandle_curvemap(bezts[j],bezts[j-1],bezts[j+1],curve_handle_types[j],curve_handle_types[j]);m_curve.calchandle_curvemap(bezts[bezts.length-
1],bezts[bezts.length-2],null,curve_handle_types[bezts.length-1],curve_handle_types[bezts.length-1]);if(bezts.length>2){if(curve_handle_types[0]=="AUTO"){m_vec3.subtract(bezts[0][2],bezts[0][1],_vec3_tmp);var hlen=m_vec3.length(_vec3_tmp);m_vec3.copy(bezts[1][0],vec);if(vec[0]<bezts[0][1][0])vec[0]=bezts[0][1][0];m_vec3.subtract(vec,bezts[0][1],vec);var nlen=m_vec3.length(vec);if(nlen>FLT_EPSILON){m_vec3.scale(vec,hlen/nlen,vec);m_vec3.add(bezts[0][1],vec,bezts[0][2]);m_vec3.subtract(bezts[0][1],
vec,bezts[0][0])}}var a=bezts.length-1;if(curve_handle_types[0]=="AUTO"){m_vec3.subtract(bezts[a][0],bezts[a][1],_vec3_tmp);var hlen=m_vec3.length(_vec3_tmp);m_vec3.copy(bezts[a-1][2],vec);if(vec[0]>bezts[a][1][0])vec[0]=bezts[a][1][0];m_vec3.subtract(vec,bezts[a][1],vec);var nlen=m_vec3.length(vec);if(nlen>FLT_EPSILON){m_vec3.scale(vec,hlen/nlen,vec);m_vec3.add(bezts[a][1],vec,bezts[a][0]);m_vec3.subtract(bezts[a][1],vec,bezts[a][2])}}}for(var a=0;a<bezts.length-1;a++)m_curve.correct_bezpart(bezts[a][1],
bezts[a][2],bezts[a+1][0],bezts[a+1][1]);var texture=[];if(curves.length<=3){var start=Math.round(-points_num/2);var end=Math.round(points_num/2)}else{var start=0;var end=points_num}for(var j=start;j<end;j++){var curr_position=j/(end-1);var left_elem=find_left_elem(bezts,curr_position,false);var right_elem=find_right_elem(bezts,curr_position,false);if(left_elem&&right_elem)texture.push(m_curve.bezier(curr_position,left_elem[1],left_elem[2],right_elem[0],right_elem[1],BEZIER_ROOT_PRECISION));else if(right_elem&&
!left_elem)if(type=="EXTRAPOLATED")texture.push(m_curve.linear(curr_position,right_elem[1],right_elem[2]));else texture.push(right_elem[1][1]);else if(left_elem&&!right_elem)if(type=="EXTRAPOLATED")texture.push(m_curve.linear(curr_position,left_elem[0],left_elem[1]));else texture.push(left_elem[1][1])}channels.push(texture)}textures.push(channels)}var tex=[];for(var j=0;j<textures.length;j++){var channels=textures[j];for(var i=0;i<channels[0].length;i++){if(channels.length<=3){var r=m_util.clamp((channels[0][i]+
1)*127.5,0,255);var g=m_util.clamp((channels[1][i]+1)*127.5,0,255);var b=m_util.clamp((channels[2][i]+1)*127.5,0,255);var a=255}else{var r=m_util.clamp(channels[0][i]*255,0,255);var g=m_util.clamp(channels[1][i]*255,0,255);var b=m_util.clamp(channels[2][i]*255,0,255);var a=m_util.clamp(channels[3][i]*255,0,255)}tex.push(r,g,b,a)}}return new Uint8Array(tex)};exports.change_image=function(object,texture_name,image){var texture=get_texture_by_name(object,texture_name);if(texture){update_texture(texture,
image,false,image.src,0);return true}else return false};exports.get_batch_texture=get_batch_texture;function get_batch_texture(texture_slot,color){var bpy_texture=texture_slot["texture"];var render=bpy_texture._render;var image=bpy_texture["image"];if(render&&color&&image)update_texture(render,color,image._is_dds,image["filepath"]);return render}exports.generate_batch_texure=function(image_data,size){var texture=generate_texture("NODE_TEX",null);var texture_slot={"texture":texture};var tex_data={width:size,
height:image_data.length/(size*4),data:image_data};return get_batch_texture(texture_slot,tex_data)}};b4w.module["__assets"]=function(exports,require){var m_cfg=require("__config");var m_compat=require("__compat");var m_print=require("__print");var m_sfg=require("__sfx");var m_util=require("__util");var m_version=require("__version");var cfg_def=m_cfg.defaults;var cfg_ldr=m_cfg.assets;exports.AT_ARRAYBUFFER=10;exports.AT_JSON=20;exports.AT_TEXT=30;exports.AT_AUDIOBUFFER=40;exports.AT_IMAGE_ELEMENT=50;exports.AT_AUDIO_ELEMENT=60;exports.AT_VIDEO_ELEMENT=70;exports.AT_SEQ_VIDEO_ELEMENT=80;exports.APT_JSON=
exports.AT_JSON;exports.APT_TEXT=exports.AT_TEXT;var ASTATE_ENQUEUED=10;var ASTATE_REQUESTED=20;var ASTATE_RECEIVED=30;var ASTATE_HALTED=40;var _assets_queue=[];var _assets_pack_index=0;var _loaded_assets={};function get_built_in_data(){if(m_cfg.is_built_in_data())return require(m_cfg.paths.built_in_data_module)["data"];else return null}function FakeHttpRequest(){var req={_source_url:null,_parse_response:function(source){switch(req.responseType){case "json":case "text":return source;case "arraybuffer":var bin_str=
atob(source);var len=bin_str.length;var arr_buffer=new Int8Array(len);for(var i=0;i<len;i++)arr_buffer[i]=bin_str.charCodeAt(i);return arr_buffer.buffer;default:return source}},status:0,readyState:0,response:"",responseType:"",onreadystatechange:null,overrideMimeType:function(){},addEventListener:function(){},open:function(method,url,async){req._source_url=url;req.readyState=1},send:function(){req.status=404;req.readyState=4;var bd=get_built_in_data();if(bd&&req._source_url in bd){req.status=200;
if(bd[req._source_url])req.response=req._parse_response(bd[req._source_url])}var get_type={};if(get_type.toString.call(req.onreadystatechange)==="[object Function]")req.onreadystatechange()}};return req}exports.split_extension=function(path){var dot_split=path.split(".");var head_ext=Array(2);head_ext[0]=dot_split.slice(0,-1).join(".");head_ext[1]=String(dot_split.slice(-1));return head_ext};exports.get_text_sync=function(asset_uri){if(_loaded_assets[asset_uri])return _loaded_assets[asset_uri];if(cfg_ldr.prevent_caching)var filepath=
asset_uri+m_version.timestamp();else var filepath=asset_uri;var req=new XMLHttpRequest;req.overrideMimeType("text/plain");req.open("GET",filepath,false);req.send(null);if(req.status==200||req.status==0){var resp_text=req.responseText;if(resp_text.length){_loaded_assets[asset_uri]=resp_text;return resp_text}else m_util.panic("Error XHR: responce is empty, GET "+asset_uri)}else m_util.panic("Error XHR: "+req.status+", GET "+asset_uri)};exports.cleanup=function(){for(var i=0;i<_assets_queue.length;i++)_assets_queue[i].state=
ASTATE_HALTED;_assets_queue=[];_assets_pack_index=0;_loaded_assets={}};exports.enqueue=function(assets_pack,asset_cb,pack_cb,progress_cb,json_reviver){for(var i=0;i<assets_pack.length;i++){var elem=assets_pack[i];var asset={id:elem.id,type:elem.type,url:elem.url,request:elem.request?elem.request:"GET",post_type:elem.post_type?elem.post_type:null,overwrite_header:elem.overwrite_header?elem.overwrite_header:null,post_data:elem.post_data?elem.post_data:null,param:elem.param?elem.param:null,state:ASTATE_ENQUEUED,
asset_cb:asset_cb||function(){},pack_cb:pack_cb||function(){},progress_cb:progress_cb||function(){},json_reviver:json_reviver||null,pack_index:_assets_pack_index};if(cfg_ldr.prevent_caching){var bd=get_built_in_data();if(!(bd&&asset.url in bd))asset.url+=m_version.timestamp()}_assets_queue.push(asset)}request_assets(_assets_queue);_assets_pack_index++};exports.update=function(){request_assets(_assets_queue);handle_packs(_assets_queue)};function request_assets(queue){var req_cnt=0;for(var i=0;i<queue.length;i++){var asset=
queue[i];if(asset.state===ASTATE_REQUESTED)req_cnt++;if(req_cnt>=cfg_ldr.max_requests)break;if(asset.state!==ASTATE_ENQUEUED)continue;asset.state=ASTATE_REQUESTED;req_cnt++;switch(asset.type){case exports.AT_ARRAYBUFFER:request_arraybuffer(asset,"arraybuffer");break;case exports.AT_JSON:request_arraybuffer(asset,"json");break;case exports.AT_TEXT:request_arraybuffer(asset,"text");break;case exports.AT_AUDIOBUFFER:request_audiobuffer(asset);break;case exports.AT_IMAGE_ELEMENT:request_image(asset);
break;case exports.AT_AUDIO_ELEMENT:request_audio(asset);break;case exports.AT_VIDEO_ELEMENT:request_video(asset);break;case exports.AT_SEQ_VIDEO_ELEMENT:request_seq_video(asset);break;default:m_util.panic("Wrong asset type: "+asset.type);break}}}function request_arraybuffer(asset,response_type){var bd=get_built_in_data();if(bd&&asset.url in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;var content_type=null;if(asset.request=="GET")req.open("GET",asset.url,true);else if(asset.request==
"POST"){req.open("POST",asset.url,true);switch(asset.post_type){case exports.APT_TEXT:content_type="text/plain";break;case exports.APT_JSON:content_type="application/json";break}}if(asset.overwrite_header)for(var key in asset.overwrite_header)if(key=="Content-Type")content_type=asset.overwrite_header[key];else req.setRequestHeader(key,asset.overwrite_header[key]);if(content_type)req.setRequestHeader("Content-Type",content_type);if(response_type=="text"){req.overrideMimeType("text/plain");req.responseType=
"text"}else if(response_type=="json"){req.overrideMimeType("application/json");req.responseType="text"}else req.responseType=response_type;req.onreadystatechange=function(){if(asset.state!=ASTATE_HALTED)if(req.readyState==4){if(req.status==200||req.status==0){var response=req.response;if(response){if(response_type=="json"&&typeof response=="string")try{response=JSON.parse(response,asset.json_reviver)}catch(e){m_print.error(e+" (parsing JSON "+asset.url+")");asset.asset_cb(null,asset.id,asset.type,
asset.url,asset.param);return}asset.asset_cb(response,asset.id,asset.type,asset.url,asset.param)}else{m_print.error("empty responce when trying to get "+asset.url);asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param)}}else{m_print.error(req.status+" when trying to get "+asset.url);asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param)}asset.state=ASTATE_RECEIVED}};req.addEventListener("progress",function(e){if(e.lengthComputable)asset.progress_cb(e.loaded/e.total)},false);req.send(asset.post_data)}
function request_audiobuffer(asset){if(asset.request!="GET")m_util.panic("Unsupported request type for audio buffer");var bd=get_built_in_data();if(bd&&asset.url in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;req.open("GET",asset.url,true);req.responseType="arraybuffer";req.onreadystatechange=function(){if(asset.state!=ASTATE_HALTED)if(req.readyState==4)if(req.status==200||req.status==0){var response=req.response;if(response){var decode_cb=function(audio_buffer){asset.asset_cb(audio_buffer,
asset.id,asset.type,asset.url,asset.param);asset.state=ASTATE_RECEIVED};var fail_cb=function(){asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);m_print.error("failed to decode "+asset.url);asset.state=ASTATE_RECEIVED};m_sfg.decode_audio_data(response,decode_cb,fail_cb)}else{asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);m_print.error("empty responce when trying to get "+asset.url);asset.state=ASTATE_RECEIVED}}else{asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);
m_print.error(req.status+" when trying to get "+asset.url);asset.state=ASTATE_RECEIVED}};req.send(asset.post_data)}function request_image(asset){if(asset.request!="GET")m_util.panic("Unsupported request type for image element");var image=document.createElement("img");if(cfg_def.allow_cors)image.crossOrigin="Anonymous";image.onload=function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(image,asset.id,asset.type,asset.url,asset.param);asset.state=ASTATE_RECEIVED}};image.addEventListener("error",function(){if(asset.state!=
ASTATE_HALTED){asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);m_print.error("could not load image: "+asset.url);asset.state=ASTATE_RECEIVED}},false);var bd=get_built_in_data();if(bd&&asset.url in bd)if(bd[asset.url]){var img_mime_type=get_image_mime_type(asset.url);image.src="data:"+img_mime_type+";base64,"+bd[asset.url]}else{if(m_compat.is_ie11()){var e=document.createEvent("CustomEvent");e.initCustomEvent("error",false,false,null)}else var e=new CustomEvent("error");image.dispatchEvent(e)}else image.src=
asset.url}function request_audio(asset){if(asset.request!="GET")m_util.panic("Unsupported request type for audio element");var audio=document.createElement("audio");if(cfg_def.allow_cors)audio.crossOrigin="Anonymous";audio.addEventListener("loadeddata",function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(audio,asset.id,asset.type,asset.url,asset.param);asset.state=ASTATE_RECEIVED}},false);audio.addEventListener("error",function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(null,asset.id,asset.type,
asset.url,asset.param);m_print.error("could not load sound: "+asset.url);asset.state=ASTATE_RECEIVED}},false);audio.addEventListener("stalled",function(){if(asset.state!=ASTATE_HALTED){asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);m_print.error("could not load sound: "+asset.url);asset.state=ASTATE_RECEIVED}},false);var bd=get_built_in_data();if(bd&&asset.url in bd)if(bd[asset.url]){var snd_mime_type=get_sound_mime_type(asset.url);audio.src="data:"+snd_mime_type+";base64,"+bd[asset.url];
if(asset.state!=ASTATE_HALTED){asset.asset_cb(audio,asset.id,asset.type,asset.url,asset.param);asset.state=ASTATE_RECEIVED}}else{if(m_compat.is_ie11()){var e=document.createEvent("CustomEvent");e.initCustomEvent("error",false,false,null)}else var e=new CustomEvent("error");audio.dispatchEvent(e)}else{audio.src=asset.url;if(cfg_def.is_mobile_device)audio.load()}if(cfg_def.mobile_firefox_media_hack){audio.autoplay=true;audio.pause()}setTimeout(function(){audio.some_prop_to_prevent_gc=1},5E3)}function request_video(asset){if(asset.request!=
"GET")m_util.panic("Unsupported request type for video element");var video=document.createElement("video");video.muted=true;if(cfg_def.allow_cors||cfg_def.is_mobile_device)video.crossOrigin="Anonymous";video.addEventListener("loadeddata",function(){video.removeEventListener("error",video_error_event,false);if(asset.state!=ASTATE_HALTED){asset.asset_cb(video,asset.id,asset.type,asset.url,asset.param);asset.state=ASTATE_RECEIVED}},false);function video_error_event(e){if(asset.state!=ASTATE_HALTED){asset.asset_cb(null,
asset.id,asset.type,asset.url);m_print.error("could not load video: "+asset.url,asset.param);asset.state=ASTATE_RECEIVED}}video.addEventListener("error",video_error_event,false);var bd=get_built_in_data();if(bd&&asset.url in bd)if(bd[asset.url]){var vid_mime_type=get_video_mime_type(asset.url);video.src="data:"+vid_mime_type+";base64,"+bd[asset.url];if(asset.state!=ASTATE_HALTED)video.addEventListener("loadeddata",function(){asset.asset_cb(video,asset.id,asset.type,asset.url,asset.param);asset.state=
ASTATE_RECEIVED},false)}else{if(m_compat.is_ie11()){var e=document.createEvent("CustomEvent");e.initCustomEvent("error",false,false,null)}else var e=new CustomEvent("error");video.dispatchEvent(e)}else{video.src=asset.url;if(cfg_def.is_mobile_device)video.load()}if(cfg_def.mobile_firefox_media_hack){video.autoplay=true;video.pause()}setTimeout(function(){video.some_prop_to_prevent_gc=1},1E4)}function request_seq_video(asset){if(asset.request!="GET")m_util.panic("Unsupported request type for seq video element");
var bd=get_built_in_data();if(bd&&asset.url in bd)var req=new FakeHttpRequest;else var req=new XMLHttpRequest;if(asset.post_type==null&&asset.post_data==null)req.open("GET",asset.url,true);else{req.open("POST",asset.url,true);switch(asset.post_type){case exports.APT_TEXT:req.setRequestHeader("Content-type","text/plain");break;case exports.APT_JSON:req.setRequestHeader("Content-type","application/json");break}}req.responseType="arraybuffer";function load_cb(images){asset.asset_cb(images,asset.id,asset.type,
asset.url,asset.param);asset.state=ASTATE_RECEIVED}req.onreadystatechange=function(){if(asset.state!=ASTATE_HALTED)if(req.readyState==4)if(req.status==200||req.status==0){var response=req.response;if(response)parse_seq_video_file(response,load_cb);else{asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);m_print.error("empty responce when trying to get "+asset.url);asset.state=ASTATE_RECEIVED}}else{asset.asset_cb(null,asset.id,asset.type,asset.url,asset.param);m_print.error(req.status+" when trying to get "+
asset.url);asset.state=ASTATE_RECEIVED}};req.addEventListener("progress",function(e){if(e.lengthComputable)asset.progress_cb(e.loaded/e.total)},false);req.send(asset.post_data)}function parse_seq_video_file(response,callback){var buffer=new Int32Array(response);var seq_image_data=new Int8Array(response);var number=buffer[3];var data={images:[],blobs:[],fps:buffer[4]};var offset=20;for(var j=0;j<number;j++){var size=buffer[offset/4];var frame=seq_image_data.subarray(offset+4,offset+4+size);var blob=
new Blob([frame],{type:"image/jpg"});var image=document.createElement("img");image.src=window.URL.createObjectURL(blob);data.images.push(image);data.blobs.push(blob);offset+=size+8-size%4}image.onload=function(){for(var i=0;i<data.images.length;i++)window.URL.revokeObjectURL(data.images[i].src);delete data.blobs;callback(data)}}function get_image_mime_type(file_path){var ext=m_util.get_file_extension(file_path);var mime_type="image";switch(ext.toLowerCase()){case "jpeg":case "jpg":mime_type+="/jpeg";
break;case "png":mime_type+="/png";break}return mime_type}function get_sound_mime_type(file_path){var ext=m_util.get_file_extension(file_path);var mime_type="audio";switch(ext.toLowerCase()){case "ogv":case "ogg":mime_type+="/ogg";break;case "mp3":mime_type+="/mpeg";break;case "m4v":case "mp4":mime_type+="/mp4";break;case "webm":mime_type+="/webm";break}return mime_type}function get_video_mime_type(file_path){var ext=m_util.get_file_extension(file_path);var mime_type="video";switch(ext.toLowerCase()){case "ogv":mime_type+=
"/ogg";break;case "webm":mime_type+="/webm";break;case "m4v":mime_type+="/mp4";break}return mime_type}function handle_packs(queue){var pack_first_index=0;var pack_cb_exec=true;for(var i=0;i<queue.length;i++){var asset=queue[i];var asset_pack_first=queue[pack_first_index];if(asset.pack_index===asset_pack_first.pack_index){if(asset.state!==ASTATE_RECEIVED)pack_cb_exec=false}else{if(pack_cb_exec){queue[i-1].pack_cb();var spliced_count=i-pack_first_index;queue.splice(pack_first_index,spliced_count);i-=
spliced_count}pack_first_index=i;pack_cb_exec=queue[i].state===ASTATE_RECEIVED?true:false}if(i===queue.length-1&&pack_cb_exec){queue[i].pack_cb();queue.splice(pack_first_index)}}}function debug_queue(queue,opt_log_prefix){var state_str="[";for(var i=0;i<queue.length;i++)state_str+=String(queue[i].state/10);state_str+="]";if(opt_log_prefix||opt_log_prefix===0)m_print.log(opt_log_prefix,state_str);else m_print.log(state_str)}};b4w.module["__loader"]=function(exports,require){var m_graph=require("__graph");var m_print=require("__print");var m_util=require("__util");var THREAD_IDLE=0;var THREAD_LOADING=1;var THREAD_FINISHED_NO_RESOURCES=2;var THREAD_FINISHED=3;var THREAD_ABORTED=4;var THREAD_STAGE_BEFORE=0;var THREAD_STAGE_LOOP=1;var THREAD_STAGE_AFTER=2;var THREAD_STAGE_IDLE=3;var DEBUG_MODE=false;var DEBUG_COLOR="color: #f0f;";var MAX_LOAD_TIME_MS=16;exports.SYNC_PRIORITY=0;exports.ASYNC_PRIORITY=1;exports.FINISH_PRIORITY=
2;var _scheduler=null;exports.get_scheduler=get_scheduler;function get_scheduler(){return _scheduler}function set_scheduler(scheduler){_scheduler=scheduler}exports.create_scheduler=function(){var scheduler={threads:[],current_thread_index:0,active_threads:0,start_secondary_threads:false,make_idle_iteration:false};set_scheduler(scheduler);return scheduler};exports.create_thread=function(stages,path,loaded_callback,stageload_cb,complete_load_cb,wait_complete_loading,do_not_load_resources,load_hidden){var scheduler=
get_scheduler();var id=scheduler.threads.length;var thread={id:id,is_primary:id==0,status:THREAD_IDLE,filepath:path,binary_name:"",loaded_cb:loaded_callback||function(){},load_hidden:load_hidden||false,wait_complete_loading:wait_complete_loading,time_load_start:0,curr_percents:0,stages_size_total:0,reset_time_cycle:false,stageload_cb:stageload_cb||function(){},complete_load_cb:complete_load_cb||function(){},stage_graph:null,stages_queue:null,has_video_textures:false,has_background_music:false,init_wa_context:false};
var graph=create_loading_graph(thread.is_primary,stages,wait_complete_loading,do_not_load_resources);thread.stage_graph=graph;var stages_queue=[];var init_nodes=m_graph.get_source_nodes(graph);for(var i=0;i<init_nodes.length;i++)stages_queue.push(init_nodes[i]);thread.stages_queue=stages_queue;m_graph.traverse(graph,function(id,attr){if(attr.cb_before||attr.cb_loop||attr.cb_after)if(stage_need_calc(thread,attr))thread.stages_size_total+=attr.relative_size});scheduler.threads.push(thread);scheduler.active_threads++;
return thread.id};function create_loading_graph(is_primary,stages,wait_complete_loading,do_not_load_resources){var scheduler=get_scheduler();var graph=m_graph.create();for(var stage_name in stages){var stage=init_stage(stages[stage_name]);if(do_not_load_resources&&stage.is_resource||!is_primary&&stage.primary_only)skip_stage(stage);m_graph.append_node_attr(graph,stage)}for(var stage_name in stages){var stage=stages[stage_name];stage.name=stage_name;for(var i=0;i<stage.inputs.length;i++)m_graph.append_edge_attr(graph,
stages[stage.inputs[i]],stage,null)}var loaded_cb_wrapper=function(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(thread.is_primary)scheduler.start_secondary_threads=true;if(!thread_is_finished(thread))thread.status=THREAD_FINISHED_NO_RESOURCES;thread.loaded_cb(thread.id,true);cb_finish(thread,stage);m_print.log("%cTHREAD "+thread.id+": LOADED CALLBACK",DEBUG_COLOR)};var finish_node=init_stage({name:"out",priority:exports.FINISH_PRIORITY,cb_before:loaded_cb_wrapper,relative_size:5});if(wait_complete_loading)var sink_ids=
m_graph.get_sink_nodes(graph);else{var tmp_graph=m_graph.clone(graph);var sink_ids;var bkg_sink_ids;do{sink_ids=m_graph.get_sink_nodes(tmp_graph);bkg_sink_ids=[];for(var i=0;i<sink_ids.length;i++){var id=sink_ids[i];var sink_node=m_graph.get_node_attr(tmp_graph,id);if(sink_node.background_loading)bkg_sink_ids.push(id)}for(var i=0;i<bkg_sink_ids.length;i++)m_graph.remove_node(tmp_graph,bkg_sink_ids[i]);if(bkg_sink_ids.length)m_graph.cleanup_loose_edges(tmp_graph)}while(bkg_sink_ids.length)}m_graph.append_node_attr(graph,
finish_node);for(var i=0;i<sink_ids.length;i++){var id=sink_ids[i];var sink_node=m_graph.get_node_attr(graph,id);finish_node.inputs.push(sink_node.name);m_graph.append_edge_attr(graph,sink_node,finish_node,null)}return graph}function init_stage(stage){stage.background_loading=stage.background_loading||false;if(!(stage.priority||stage.priority===0))stage.priority=stage.SYNC_PRIORITY;stage.inputs=stage.inputs||[];stage.is_finished=stage.is_finished||false;stage.skip=stage.skip||false;stage.relative_size=
stage.relative_size||0;stage.is_resource=stage.is_resource||false;stage.primary_only=stage.primary_only||false;stage.status=THREAD_STAGE_BEFORE;stage.loop_index=0;stage.load_rate=0;stage.cb_param=stage.cb_param||null;return stage}exports.update_scheduler=function(bpy_data_array){var scheduler=get_scheduler();if(!scheduler||is_finished(scheduler))return;if(scheduler.make_idle_iteration){scheduler.make_idle_iteration=false;return}var time_start=performance.now();do{var thread=scheduler.threads[scheduler.current_thread_index];
var bpy_data=bpy_data_array[thread.id];if(!thread_is_finished(thread)){if(thread.status==THREAD_IDLE){thread.status=THREAD_LOADING;thread.time_load_start=performance.now();thread.stageload_cb(0,0);if(DEBUG_MODE)m_print.log("%cTHREAD "+thread.id+": 0% LOADING START 0ms",DEBUG_COLOR)}if(update_stages_queue(thread))process_stages_queue(thread,bpy_data);else finish_thread(scheduler,thread,bpy_data)}if(scheduler.start_secondary_threads)scheduler.current_thread_index=(scheduler.current_thread_index+1)%
scheduler.threads.length;if(thread.reset_time_cycle){thread.reset_time_cycle=false;return}}while(performance.now()-time_start<MAX_LOAD_TIME_MS)};exports.abort_thread=function(thread){var scheduler=get_scheduler();finish_thread(scheduler,thread,null);thread.status=THREAD_ABORTED;if(thread.is_primary)scheduler.start_secondary_threads=true;thread.loaded_cb(thread.id,false)};function finish_thread(scheduler,thread,bpy_data){thread.complete_load_cb(bpy_data,thread);thread.status=THREAD_FINISHED;scheduler.active_threads--;
if(DEBUG_MODE){var ms=Math.round(performance.now()-thread.time_load_start);m_print.log("%cTHREAD "+thread.id+": 100% LOADING END "+ms+"ms",DEBUG_COLOR)}release_thread(thread)}function process_stages_queue(thread,bpy_data){var iter_counter=thread.stages_queue.length;do{var stage_index=thread.stages_queue[0];var stage=m_graph.get_node_attr(thread.stage_graph,stage_index);var is_processed=process_stage(thread,stage,bpy_data);if(stage.priority==exports.ASYNC_PRIORITY)thread.reset_time_cycle=true;var first=
thread.stages_queue.shift();thread.stages_queue.push(first);iter_counter--}while(!(is_processed||iter_counter==0))}function propagate_stages(thread,stage_indices){var next_indices=[];var stages_to_remove=[];for(var i=0;i<stage_indices.length;i++){var stage_index=stage_indices[i];var stage=m_graph.get_node_attr(thread.stage_graph,stage_index);if(stage.is_finished){m_graph.traverse_outputs(thread.stage_graph,stage_index,function(id_out,attr_out,edge_attr_out){var can_execute=true;m_graph.traverse_inputs(thread.stage_graph,
id_out,function(id_in,attr_in,edge_attr_in){if(!attr_in.is_finished){can_execute=false;return 1}});if(can_execute&&next_indices.indexOf(id_out)==-1&&stage_indices.indexOf(id_out)==-1)next_indices.push(id_out)});stages_to_remove.push(i)}}for(var i=stages_to_remove.length-1;i>=0;i--)stage_indices.splice(stages_to_remove[i],1);return next_indices}function update_stages_queue(thread){var result_indices=[];var prev_indices=thread.stages_queue;var new_added=false;do{var next_indices=propagate_stages(thread,
prev_indices);result_indices.push.apply(result_indices,prev_indices);if(next_indices.length>0)new_added=true;prev_indices=next_indices}while(next_indices.length>0);var priority_stage_sort=function(a,b){var stage_a=m_graph.get_node_attr(thread.stage_graph,a);var stage_b=m_graph.get_node_attr(thread.stage_graph,b);var result=stage_b.priority-stage_a.priority;if(result==0)result=stage_a.background_loading-stage_b.background_loading;return result};if(new_added)result_indices.sort(priority_stage_sort);
thread.stages_queue=result_indices;return thread.stages_queue.length}function process_stage(thread,stage,bpy_data){if(stage.skip){stage.is_finished=true;if(DEBUG_MODE)m_print.log("%cTHREAD "+thread.id+": SKIP STAGE "+stage.name,DEBUG_COLOR);stage_finish_cb(thread,stage);return false}if(DEBUG_MODE&&stage.status==THREAD_STAGE_BEFORE){var percents=get_load_percents(thread);var message="LOADING START "+stage.name;var ms=Math.round(performance.now()-thread.time_load_start);m_print.log("%cTHREAD "+thread.id+
": "+percents+"% "+message+" "+ms+"ms ",DEBUG_COLOR)}if(!stage.cb_before&&!stage.cb_loop&&!stage.cb_after){stage_finish_cb(thread,stage);return false}if(stage.status==THREAD_STAGE_BEFORE){stage.status++;if(stage.cb_before){stage.cb_before(bpy_data,thread,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}}if(stage.status==THREAD_STAGE_LOOP)if(stage.cb_loop){stage.cb_loop(bpy_data,thread,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}else stage.status++;
if(stage.status==THREAD_STAGE_AFTER){stage.status++;if(stage.cb_after){stage.cb_after(bpy_data,thread,stage,stage.cb_param,stage_finish_cb,stage_part_finish_cb);return true}}return false}function get_load_percents(thread){if(thread.stages_size_total==0)return 100;var loaded=0;m_graph.traverse(thread.stage_graph,function(id,attr){if(stage_need_calc(thread,attr))loaded+=attr.load_rate*attr.relative_size});return m_util.trunc(loaded*100/thread.stages_size_total)}function stage_need_calc(thread,stage){return!(thread.do_not_load_resources&&
stage.is_resource)}function stage_finish_cb(thread,stage){stage.is_finished=true;stage.status=THREAD_STAGE_IDLE;stage_loading_action(thread,stage,1);if(DEBUG_MODE){var percents=get_load_percents(thread);var message="LOADING END "+stage.name;var ms=Math.round(performance.now()-thread.time_load_start);m_print.log("%cTHREAD "+thread.id+": "+percents+"% "+message+" "+ms+"ms ",DEBUG_COLOR)}}exports.stage_part_finish_cb=stage_part_finish_cb;function stage_part_finish_cb(thread,stage,rate){if(rate<1)stage_loading_action(thread,
stage,rate);else stage.status++}function stage_loading_action(thread,stage,rate){var scheduler=get_scheduler();if(stage.cb_before||stage.cb_loop||stage.cb_after){stage.load_rate=rate;var percents=get_load_percents(thread);if(thread.curr_percents!=percents||rate==1){thread.stageload_cb(percents,performance.now()-thread.time_load_start);thread.curr_percents=percents;scheduler.make_idle_iteration=true}}}exports.skip_stage_by_name=function(thread,name){var stage=get_stage_by_name(thread,name);if(stage!==
null)skip_stage(stage)};function get_stage_by_name(thread,name){var stage=null;m_graph.traverse(thread.stage_graph,function(id,attr){if(attr.name==name){stage=attr;return 1}});return stage}function skip_stage(stage){stage.skip=true;stage.load_rate=1}function release_thread(thread){thread.stageload_cb=null;thread.complete_load_cb=null;if(!DEBUG_MODE)thread.stage_graph=null;thread.stages_queue=null}exports.is_finished=is_finished;function is_finished(){var scheduler=get_scheduler();return scheduler.active_threads==
0}exports.thread_is_finished=thread_is_finished;function thread_is_finished(thread){return thread&&(thread.status==THREAD_FINISHED||thread.status==THREAD_ABORTED)}exports.is_primary_loaded=function(data_id){var scheduler=get_scheduler();if(!scheduler)return false;data_id=data_id|0;return scheduler.threads[data_id]&&(scheduler.threads[data_id].status==THREAD_FINISHED||scheduler.threads[data_id].status==THREAD_FINISHED_NO_RESOURCES)};exports.graph_to_dot=function(data_id){if(!DEBUG_MODE){m_print.error("Debug mode isn't enabled. Can not retrieve the graph.");
return}var scheduler=get_scheduler();if(scheduler&&scheduler.threads[data_id]&&scheduler.threads[data_id].stage_graph)return m_graph.debug_dot(scheduler.threads[data_id].stage_graph,function(node,attr){if(attr.skip)return"SKIPPED\n("+attr.name+")";else{var node_label=attr.name+"\n";var props=[];props.push(attr.priority==exports.ASYNC_PRIORITY?"ASYNC":"SYNC");if(attr.background_loading)props.push("BKG");if(attr.is_resource)props.push("RES");return node_label+props.join(" | ")}},null);else return null};
exports.cleanup=function(){set_scheduler(null)}};b4w.module["__logic_nodes"]=function(exports,require){var m_obj=require("__objects");var m_scs=require("__scenes");var m_print=require("__print");var m_nla=require("__nla");var m_cfg=require("__config");var m_ctl=require("__controls");var m_util=require("__util");var m_anim=require("__animation");var m_assets=require("__assets");var m_batch=require("__batch");var m_geom=require("__geometry");var m_time=require("__time");var m_cam=require("__camera");var m_vec3=require("__vec3");var m_phy=require("__physics");
var m_trans=require("__transform");var m_sfx=require("__sfx");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_tsr=require("__tsr");var m_quat=require("__quat");var _logic_arr=[];var _logic_custom_cb_arr={};var UNINITIALIZED=0;var INITIALIZATION=1;var RUNNING=2;var STOPPED=3;var PAUSED=4;var _vec4_tmp=new Float32Array(4);var _vec4_tmp1=new Float32Array(4);var _vec3_tmp=new Float32Array(3);var _vec3_tmp1=new Float32Array(3);var _vec2_tmp=new Float32Array(2);var _mat3_tmp=new Float32Array(9);
var _mat4_tmp=new Float32Array(16);var NT_NUMBER=0;var NT_STRING=1;exports.NT_NUMBER=NT_NUMBER;exports.NT_STRING=NT_STRING;var NSO_JOIN=0;var NSO_FIND=1;var NSO_REPLACE=2;var NSO_SPLIT=3;var NSO_COMPARE=4;var NJO_PARSE=0;var NJO_ENCODE=1;var NC_GEQUAL=0;var NC_LEQUAL=1;var NC_GREATER=2;var NC_LESS=3;var NC_NOTEQUAL=4;var NC_EQUAL=5;exports.NC_GEQUAL=NC_GEQUAL;exports.NC_LEQUAL=NC_LEQUAL;exports.NC_GREATER=NC_GREATER;exports.NC_LESS=NC_LESS;exports.NC_NOTEQUAL=NC_NOTEQUAL;exports.NC_EQUAL=NC_EQUAL;
var NST_WORLD=0;var NST_PARENT=1;var NST_LOCAL=2;var NCPT_OBJECT=0;var NCPT_VARIABLE=1;exports.NCPT_OBJECT=NCPT_OBJECT;exports.NCPT_VARIABLE=NCPT_VARIABLE;var _nodes_handlers={"ENTRYPOINT":entrypoint_handler,"HIDE":hide_object_handler,"SHOW":show_object_handler,"PAGEPARAM":pageparam_handler,"SWITCH_SELECT":switch_select_handler,"SELECT":select_handler,"PLAY":play_timeline_handler,"REDIRECT":redirect_handler,"MATH":math_handler,"CONDJUMP":conditional_jump_handler,"REGSTORE":regstore_handler,"PLAY_ANIM":play_anim_handler,
"SELECT_PLAY":do_nothing_handler,"SEND_REQ":send_req_handler,"INHERIT_MAT":inherit_mat_handler,"SET_SHADER_NODE_PARAM":set_shader_node_param_handler,"DELAY":delay_handler,"APPLY_SHAPE_KEY":apply_shape_key_handler,"OUTLINE":outline_handler,"MOVE_CAMERA":move_camera_handler,"SET_CAMERA_MOVE_STYLE":set_camera_move_style_handler,"MOVE_TO":move_to_handler,"TRANSFORM_OBJECT":transform_object_handler,"SPEAKER_PLAY":speaker_play_handler,"SPEAKER_STOP":speaker_stop_handler,"STOP_ANIM":stop_anim_handler,"STOP_TIMELINE":stop_timeline_handler,
"CONSOLE_PRINT":console_print_handler,"STRING":string_handler,"GET_TIMELINE":get_timeline_handler,"JSON":json_handler,"JS_CALLBACK":js_callback_handler,"EMPTY":do_nothing_handler};function get_var(var_desc,global_vars,local_vars){return var_desc[0]?global_vars[var_desc[1]]:local_vars[var_desc[1]]}function set_var(var_desc,global_vars,local_vars,value){if(var_desc[0])global_vars[var_desc[1]]=value;else local_vars[var_desc[1]]=value}function do_nothing_handler(node,logic,thread_state,timeline,elapsed,
start_time){switch(logic.state){case INITIALIZATION:break;case RUNNING:thread_state.curr_node=node.slot_idx_order;break}}function unknown_node_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:m_print.error("Unknown node type: "+node.type);break;case RUNNING:thread_state.curr_node=node.slot_idx_order;break}}exports.init_logic=function(scene,data_id){var logic={data_id:data_id,scene_name:scene["name"],state:UNINITIALIZED,nla_thread:null,scene:scene,
curr_thread:null,logic_threads:[],sorted_markers_values:[],variables:{}};scene._logic=logic;prepare_logic(scene,logic)};exports.update=function(timeline,elapsed){var start_time=m_nla.get_start_time();if(start_time<=0)return;for(var i=0;i<_logic_arr.length;i++)process_logic(i,timeline,elapsed,start_time)};exports.append_custom_cb=function(cb_id,cb){_logic_custom_cb_arr[cb_id]=cb};exports.remove_custom_cb=function(cb_id){delete _logic_custom_cb_arr[cb_id]};exports.run_ep=function(scene_name,ep_name){for(var i=
0;i<_logic_arr.length;i++)if(_logic_arr[i].scene_name==scene_name){var logic=_logic_arr[i];for(var j=0;j<logic.logic_threads.length;j++){var ep=logic.logic_threads[j].nodes[0];if(ep.name==ep_name){if(ep.bools["js"])ep.mute=false;logic.logic_threads[j].thread_state.curr_node=0;break}}break}};function reset_play(thread){var script=thread.nodes;for(var i=0;i<script.length;i++){var node=script[i];if(node.type=="PLAY")node.state=-1}}function reset_selections(thread){var script=thread.nodes;for(var i=0;i<
script.length;i++){var node=script[i];if(node.type=="SWITCH_SELECT")node.state=-1}}function process_logic(index,timeline,elapsed,start_time){var logic=_logic_arr[index];for(var k=0;k<_logic_arr[index].logic_threads.length;k++){logic.curr_thread=_logic_arr[index].logic_threads[k];process_logic_thread(_logic_arr[index].logic_threads[k],logic,timeline,elapsed,start_time)}}function get_url_param(name,param_type,is_hash_param){var cfg_url_params=m_cfg.get("url_params");if(cfg_url_params&&name in cfg_url_params)return Number(cfg_url_params[name]);
var url_params=is_hash_param?location.hash:location.search;if(!url_params)return 0;var params=url_params.slice(1).split("&");for(var i=0;i<params.length;i++){var param=params[i].split("=");if(param.length>1&&param[0]==name)return convert_variable(param[1],param_type)}return 0}function get_object(node){return m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.dupli_name_list||[],0)}function get_world(node){return m_obj.get_world_by_name(node.dupli_name_list[0],0)}function entrypoint_handler(node,
logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:thread_state.curr_node=node.slot_idx_order;break}}function hide_object_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=get_object(node);break;case RUNNING:m_scs.change_visibility(node.obj,true);thread_state.curr_node=node.slot_idx_order;break}}function show_object_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=
get_object(node);break;case RUNNING:m_scs.change_visibility(node.obj,false);thread_state.curr_node=node.slot_idx_order;break}}function pageparam_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:set_var(node.vars["vd"],logic.variables,thread_state.variables,get_url_param(node.param_name,node.floats["ptp"],node.bools["hsh"]));thread_state.curr_node=node.slot_idx_order;break}}var gen_cb=function(){return function(obj,id,pulse,param){var node=param[0];var logic=
param[1];var thread=param[2];for(var i=0;i<node.sel_objs_len;i++)if(m_ctl.get_sensor_value(obj,id,i)&&i==node.sel_obj_idx){if(m_nla.is_play(logic._nla)&&logic.nla_thread==node.thread)node.state=-1;else if(!(thread.thread_state.in_progress&&!node.bools["no_wait"]))node.state=1;return}node.state=0}};function create_select_sensor(node,logic,thread){var obj=get_object(node);var sel_objs=m_obj.get_selectable_objects();var obj_idx=sel_objs.indexOf(obj);if(obj_idx==-1){m_print.error("logic script error: non-selectable object:",
node.dupli_name_list[node.dupli_name_list.length-1]);return-1}node.state=-1;node.sel_objs_len=sel_objs.length;node.sel_obj_idx=obj_idx;var sel_sensors=[];for(var j=0;j<sel_objs.length;j++)sel_sensors.push(m_ctl.create_selection_sensor(sel_objs[j],true));var select_cb=gen_cb();m_ctl.create_sensor_manifold(obj,"LOGIC_NODES_SELECT_"+node.label,m_ctl.CT_SHOT,sel_sensors,m_ctl.default_OR_logic_fun,select_cb,[node,logic,thread])}function select_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:create_select_sensor(node,
logic,logic.logic_threads[thread_state.thread_index]);break;case RUNNING:if(node.state>-1){thread_state.curr_node=node.state?node.slot_idx_jump:node.slot_idx_order;node.state=-1;break}if(node.bools["not_wait"]){thread_state.curr_node=node.slot_idx_order;break}break}}var gen_switch_select_cb=function(){return function(obj,id,pulse,param){var node=param[0];var logic=param[1];var thread=param[2];if(node.state!=-2)return;for(var i=0;i<node.sel_objs_len;i++){var val=m_ctl.get_sensor_value(obj,id,i);if(val)for(var j=
0;j<node.sel_obj_idxs.length;j++)if(node.sel_obj_idxs[j]==i){if(logic.nla_thread==node.thread){if(m_nla.is_play(logic._nla))node.state=-1;if(!thread.thread_state.in_progress){node.state=1;node.slot_idx_jump=node.links_idxs[j]}}else{node.state=1;node.slot_idx_jump=node.links_idxs[j]}return}}node.state=0}};function create_switch_select_sensor(node,logic,thread){var sel_objs=m_obj.get_selectable_objects();node.sel_obj_idxs=[];node.links_idxs=[];for(var key in node.objects_paths){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,
node.objects_paths[key],0);var obj_idx=sel_objs.indexOf(obj);if(obj_idx==-1){m_print.error("logic script error: non-selectable object:",node.objects_paths[key][node.objects_paths[key].length-1]);return-1}node.sel_obj_idxs.push(obj_idx);node.links_idxs.push(node.links_dict[key])}node.state=-1;node.sel_objs_len=sel_objs.length;var sel_sensors=[];for(var j=0;j<sel_objs.length;j++)sel_sensors.push(m_ctl.create_selection_sensor(sel_objs[j],true));var select_cb=gen_switch_select_cb();m_ctl.create_sensor_manifold(obj,
"LOGIC_NODES_SWITCH_SELECT_"+node.label,m_ctl.CT_SHOT,sel_sensors,m_ctl.default_OR_logic_fun,select_cb,[node,logic,thread])}function switch_select_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:create_switch_select_sensor(node,logic,logic.logic_threads[thread_state.thread_index]);break;case RUNNING:if(node.state==-1){reset_selections(logic.logic_threads[thread_state.thread_index]);node.state=-2}if(node.state>-1){thread_state.curr_node=node.state?
node.slot_idx_jump:node.slot_idx_order;node.state=-1;break}break}}function play_timeline_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:m_nla.stop_nla();node.state=-1;if(!node.bools["not_wait"])node.bools["not_wait"]=false;break;case RUNNING:switch(node.state){case -1:if(m_nla.is_play(logic._nla))if(logic.curr_thread==logic.nla_thread&&thread_state.in_progress)break;else{var thread=logic.nla_thread;if(thread){var nla_nd=thread.nodes[thread.thread_state.curr_node];
thread.thread_state.curr_node=nla_nd.slot_idx_order;thread.nodes[thread.thread_state.curr_node].state=-1;reset_play(logic.nla_thread)}}thread_state.in_progress=!node.bools["not_wait"];logic.nla_thread=logic.curr_thread;node.state=0;if(node.frame_start_mask){m_nla.set_range_start(node.frame_start);m_nla.set_offset_from_range_start(timeline)}if(node.frame_end_mask)m_nla.set_range_end(node.frame_end);else{var cur_frame=m_nla.get_frame(timeline);var end=-1;for(var v in logic.sorted_markers_values)if(cur_frame<
logic.sorted_markers_values[v]){end=v;break}if(end>=0)m_nla.set_range_end(logic.sorted_markers_values[end]);else m_nla.set_range_end(m_nla.get_frame_end())}m_nla.play_nla(null);if(node.bools["not_wait"]){thread_state.curr_node=node.slot_idx_order;node.state=-1;thread_state.in_progress=false}break;case 0:if(!m_nla.is_play()){thread_state.curr_node=node.slot_idx_order;node.state=-1;thread_state.in_progress=false}break;case 1:thread_state.curr_node=node.slot_idx_order;node.state=-1;logic.nla_thread=
null;thread_state.in_progress=false;break;default:m_util.panic("Unknown state of "+node.name);node.state=-1;break}break}}function console_print_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var vars={};for(var i in node.vars){var key=node.vars[i][1];vars[key]=get_var(node.vars[i],logic.variables,thread_state.variables)}m_print.log(node.common_usage_names["msg"],JSON.stringify(vars));thread_state.curr_node=node.slot_idx_order;break}}function stop_timeline_handler(node,
logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:if(node.bools["rst"])m_nla.set_offset_from_range_start(timeline);m_nla.stop_nla();thread_state.curr_node=node.slot_idx_order;break}}function redirect_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var url=node.bools["url"]?convert_variable(get_var(node.vars["url"],logic.variables,thread_state.variables),NT_STRING):node.strings["url"];window.location.href=url;logic.state=
STOPPED;break}}function send_req_handler(node,logic,thread_state,timeline,elapsed,start_time){function asset_cb(loaded_data,uri,type,path,param){var resp_string=JSON.stringify(loaded_data);set_var(param[0].vars["dst"],logic.variables,thread_state.variables,resp_string);param[0].state=1}switch(logic.state){case RUNNING:switch(node.state){case -1:node.state=0;var url=node.bools["url"]?convert_variable(get_var(node.vars["url"],logic.variables,thread_state.variables),NT_STRING):node.strings["url"];var header=
{};if(node.bools["ct"])header["Content-Type"]=node.strings["ct"];if(node.common_usage_names["request_type"]=="GET")m_assets.enqueue([{id:url,type:m_assets.AT_JSON,url:url,overwrite_header:header,param:[node,thread_state.variables]}],asset_cb,null,null,null);else if(node.common_usage_names["request_type"]=="POST"){var req=convert_variable(get_var(node.vars["dst1"],logic.variables,thread_state.variables),NT_STRING);m_assets.enqueue([{id:url,type:m_assets.AT_JSON,url:url,overwrite_header:header,request:"POST",
post_type:m_assets.AT_JSON,post_data:req,param:[node,thread_state.variables]}],asset_cb,null,null,null)}break;case 0:break;case 1:node.state=-1;thread_state.curr_node=node.slot_idx_order;break}break}}function inherit_mat_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:for(var i=0;i<2;i++)node.objects["id"+i]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id"+i],0);break;case RUNNING:m_batch.inherit_material(node.objects["id0"],
node.materials_names["id0"],node.objects["id1"],node.materials_names["id1"]);thread_state.curr_node=node.slot_idx_order;break}}function delay_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:break;case RUNNING:if(node.state==-1){node.state=0;node.timer=0;thread_state.in_progress=true;return}else if(node.state==0){node.timer+=elapsed;var dl=node.bools["dl"]?convert_variable(get_var(node.vars["dl"],logic.variables,thread_state.variables),NT_NUMBER):
node.floats["dl"];if(dl<node.timer){node.state=-1;thread_state.curr_node=node.slot_idx_order;thread_state.in_progress=false}}break}}function apply_shape_key_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:var obj=node.objects["id0"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);var key=node.common_usage_names["sk"];if(!m_geom.check_shape_keys(obj)){m_print.error("No shape keys in object:",obj.name);node.mute=
true}else if(!m_geom.has_shape_key(obj,key)){m_print.error("Wrong key name:",key);node.mute=true}break;case RUNNING:m_geom.apply_shape_key(node.objects["id0"],node.common_usage_names["sk"],node.bools["skv"]?convert_variable(get_var(node.vars["skv"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["skv"]);thread_state.curr_node=node.slot_idx_order;break}}function outline_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:var obj=node.objects["id0"]=
m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);if(!(obj&&obj.render&&obj.render.outlining)){m_print.error("Can't evaluate 'Outline' logic node: wrong object");node.mute=true}break;case RUNNING:var obj=node.objects["id0"];switch(node.common_usage_names["outline_operation"]){case "PLAY":var oa_set=obj.render.outline_anim_settings_default;m_obj.apply_outline_anim(obj,oa_set.outline_duration,oa_set.outline_period,oa_set.outline_relapses);break;case "STOP":m_obj.clear_outline_anim(obj);
break;case "INTENSITY":obj.render.outline_intensity=node.bools["in"]?convert_variable(get_var(node.vars["in"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["in"];break}thread_state.curr_node=node.slot_idx_order;break}}function move_camera_handler(node,logic,thread_state,timeline,elapsed,start_time){function move_cam(cam,trans,target,tsr){switch(m_cam.get_move_style(cam)){case m_cam.MS_TARGET_CONTROLS:m_cam.set_trans_pivot(cam,trans,target);break;case m_cam.MS_EYE_CONTROLS:case m_cam.MS_STATIC:m_trans.set_tsr(cam,
tsr);break;case m_cam.MS_HOVER_CONTROLS:m_vec3.sub(target,trans,_vec3_tmp);m_vec3.normalize(_vec3_tmp,_vec3_tmp);m_cam.set_hover_pivot(cam,target);var phi=0;var theta=0;_vec3_tmp1[0]=_vec3_tmp[0];_vec3_tmp1[1]=0;_vec3_tmp1[2]=_vec3_tmp[2];var dot=m_vec3.dot(_vec3_tmp1,_vec3_tmp);theta=Math.acos(dot/(m_vec3.length(_vec3_tmp1)*m_vec3.length(_vec3_tmp)));if(_vec3_tmp[2])phi=Math.atan(_vec3_tmp[0]/_vec3_tmp[2]);else if(_vec3_tmp[0]>0)phi=0;else phi=Math.PI;if(_vec3_tmp[2]>0&&_vec3_tmp[0]>0)_vec2_tmp[1]=
-(Math.PI+_vec2_tmp[1]);else if(_vec3_tmp[2]>0&&_vec3_tmp[0]<0)_vec2_tmp[1]=-(Math.PI+_vec2_tmp[1]);else if(_vec3_tmp[2]<0&&_vec3_tmp[0]<0){_vec2_tmp[0]+=Math.PI;phi=-(Math.PI-phi)}else if(_vec3_tmp[2]<0&&_vec3_tmp[0]>0){_vec2_tmp[0]+=Math.PI;phi-=Math.PI}m_cam.rotate_hover_camera(cam,phi+Math.PI,-theta,true,true);break}m_trans.update_transform(cam);m_phy.sync_transform(cam)}function set_tsr(cam,trans,target,tsr_out){m_mat4.lookAt(trans,target,m_util.AXIS_Y,_mat4_tmp);m_mat4.invert(_mat4_tmp,_mat4_tmp);
m_mat4.rotateX(_mat4_tmp,Math.PI/2,_mat4_tmp);var rot_matrix=_mat3_tmp;m_mat3.fromMat4(_mat4_tmp,rot_matrix);m_quat.fromMat3(rot_matrix,_vec4_tmp);m_quat.normalize(_vec4_tmp,_vec4_tmp);var scale=m_tsr.get_scale(cam.render.world_tsr);m_tsr.set_sep(trans,scale,_vec4_tmp,tsr_out)}switch(logic.state){case INITIALIZATION:var o=null;o=node.objects["ca"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);node.objects["tr"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,
node.objects_paths["id1"],0);node.objects["ta"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id2"],0);node.state=-1;node.camera_state={trans_start:new Float32Array(3),trans_end:new Float32Array(3),interp_trans:new Float32Array(3),target_start:new Float32Array(3),target_end:new Float32Array(3),interp_target:new Float32Array(3),tsr_start:new Float32Array(8),tsr_end:new Float32Array(8),interp_tsr:new Float32Array(8)};break;case RUNNING:var cam=node.objects["ca"];var trans=
m_tsr.get_trans_view(node.objects["tr"].render.world_tsr);var target=m_tsr.get_trans_view(node.objects["ta"].render.world_tsr);switch(node.state){case -1:var dur=node.bools["dur"]?convert_variable(get_var(node.vars["dur"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["dur"];if(dur==0){set_tsr(cam,trans,target,node.camera_state.tsr_end);move_cam(cam,trans,target,node.camera_state.tsr_end);thread_state.curr_node=node.slot_idx_order;return}var cam_trans=m_tsr.get_trans_view(cam.render.world_tsr);
m_vec3.copy(cam_trans,node.camera_state.trans_start);var move_style=m_cam.get_move_style(cam);if(move_style==m_cam.MS_HOVER_CONTROLS)m_vec3.copy(cam.render.hover_pivot,node.camera_state.target_start);else if(move_style==m_cam.MS_STATIC||move_style==m_cam.MS_EYE_CONTROLS){m_tsr.copy(cam.render.world_tsr,node.camera_state.tsr_start);set_tsr(cam,trans,target,node.camera_state.tsr_end)}else m_vec3.copy(cam.render.pivot,node.camera_state.target_start);m_vec3.copy(trans,node.camera_state.trans_end);m_vec3.copy(target,
node.camera_state.target_end);node.state=0;var trans_animator=m_time.animate(0,1,dur*1E3,function(e){if(m_scs.check_active()){if(move_style==m_cam.MS_STATIC||move_style==m_cam.MS_EYE_CONTROLS)m_tsr.interpolate(node.camera_state.tsr_start,node.camera_state.tsr_end,m_util.smooth_step(e),node.camera_state.interp_tsr);else{node.camera_state.interp_target=m_vec3.lerp(node.camera_state.target_start,node.camera_state.target_end,m_util.smooth_step(e),node.camera_state.interp_target);node.camera_state.interp_trans=
m_vec3.lerp(node.camera_state.trans_start,node.camera_state.trans_end,m_util.smooth_step(e),node.camera_state.interp_trans)}move_cam(cam,node.camera_state.interp_trans,node.camera_state.interp_target,node.camera_state.interp_tsr);if(e==1)node.state=1}});break;case 0:break;case 1:m_time.clear_animation(trans_animator);node.state=-1;thread_state.curr_node=node.slot_idx_order;break}break}}function set_camera_move_style_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.tmp1=
m_cam.move_style_bpy_to_b4w(node.common_usage_names["camera_move_style"]);break;case RUNNING:var cam=m_scs.get_camera(thread_state.scene);m_trans.update_transform(cam);m_phy.sync_transform(cam);thread_state.curr_node=node.slot_idx_order;break}}function move_to_handler(node,logic,thread_state,timeline,elapsed,start_time){function move_to(obj,dest){m_trans.set_tsr(obj,dest);m_trans.update_transform(obj);m_phy.sync_transform(obj)}switch(logic.state){case INITIALIZATION:node.objects["ob"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,
node.objects_paths["id0"],0);node.objects["de"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id1"],0);node.state=-1;node.obj_state={dest_tsr_start:new Float32Array(8),dest_tsr_end:new Float32Array(8),interp_tsr_dest:new Float32Array(8)};break;case RUNNING:var obj=node.objects["ob"];m_tsr.copy(node.objects["ob"].render.world_tsr,node.obj_state.dest_tsr_start);m_tsr.copy(node.objects["de"].render.world_tsr,node.obj_state.dest_tsr_end);switch(node.state){case -1:var dur=node.bools["dur"]?
convert_variable(get_var(node.vars["dur"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["dur"];if(dur==0){move_to(obj,node.obj_state.dest_tsr_end);thread_state.curr_node=node.slot_idx_order;return}node.state=0;var trans_animator=m_time.animate(0,1,dur*1E3,function(e){if(m_scs.check_active()){node.obj_state.interp_dest=m_tsr.interpolate(node.obj_state.dest_tsr_start,node.obj_state.dest_tsr_end,m_util.smooth_step(e),node.obj_state.interp_tsr_dest);move_to(obj,node.obj_state.interp_tsr_dest);
if(e==1)node.state=1}});break;case 0:break;case 1:m_time.clear_animation(trans_animator);node.state=-1;thread_state.curr_node=node.slot_idx_order;break}break}}function transform_object_handler(node,logic,thread_state,timeline,elapsed,start_time){function transform_obj(obj,tsr,space){if(space==NST_WORLD)m_trans.set_tsr(obj,tsr);else m_trans.set_tsr_rel(obj,tsr);m_trans.update_transform(obj);m_phy.sync_transform(obj)}switch(logic.state){case INITIALIZATION:node.objects["ob"]=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,
node.objects_paths["id0"],0);node.state=-1;node.obj_state={space:NST_WORLD,tsr_start:new Float32Array(8),tsr_end:new Float32Array(8),interp_tsr:new Float32Array(8)};break;case RUNNING:var obj=node.objects["ob"];switch(node.state){case -1:var tr=_vec3_tmp1;tr[0]=node.bools["trx"]?convert_variable(get_var(node.vars["trx"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["trx"];tr[1]=node.bools["try"]?convert_variable(get_var(node.vars["try"],logic.variables,thread_state.variables),NT_NUMBER):
node.floats["try"];tr[2]=node.bools["trz"]?convert_variable(get_var(node.vars["trz"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["trz"];var eul_rot=_vec3_tmp;eul_rot[0]=node.bools["rox"]?convert_variable(get_var(node.vars["rox"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["rox"];eul_rot[1]=node.bools["roy"]?convert_variable(get_var(node.vars["roy"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["roy"];eul_rot[2]=node.bools["roz"]?convert_variable(get_var(node.vars["roz"],
logic.variables,thread_state.variables),NT_NUMBER):node.floats["roz"];var sc=node.bools["sc"]?get_var(node.vars["sc"],logic.variables,thread_state.variables):node.floats["sc"];if(node.bools["try"]||node.bools["trz"]){_vec2_tmp[1]=-tr[1];tr[1]=tr[2];tr[2]=_vec2_tmp[1]}if(node.bools["roy"]||node.bools["roz"]){_vec2_tmp[1]=-eul_rot[1];eul_rot[1]=eul_rot[2];eul_rot[2]=_vec2_tmp[1]}m_util.euler_to_quat(eul_rot,_vec4_tmp);m_tsr.set_sep(tr,sc,_vec4_tmp,node.obj_state.tsr_end);node.obj_state.space=node.common_usage_names["space_type"];
switch(node.obj_state.space){case NST_WORLD:m_trans.get_tsr(obj,node.obj_state.tsr_start);break;case NST_PARENT:m_trans.get_tsr_rel(obj,node.obj_state.tsr_start);break;case NST_LOCAL:m_trans.get_tsr_rel(obj,node.obj_state.tsr_start);m_tsr.multiply(node.obj_state.tsr_start,node.obj_state.tsr_end,node.obj_state.tsr_end);break}var dur=node.bools["dur"]?convert_variable(get_var(node.vars["dur"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["dur"];if(dur==0){transform_obj(obj,node.obj_state.tsr_end,
node.obj_state.space);thread_state.curr_node=node.slot_idx_order;return}node.state=0;var trans_animator=m_time.animate(0,1,dur*1E3,function(e){if(m_scs.check_active()){m_tsr.interpolate(node.obj_state.tsr_start,node.obj_state.tsr_end,m_util.smooth_step(e),node.obj_state.interp_tsr);transform_obj(obj,node.obj_state.interp_tsr,node.obj_state.space);if(e==1)node.state=1}});break;case 0:break;case 1:m_time.clear_animation(trans_animator);node.state=-1;thread_state.curr_node=node.slot_idx_order;break}break}}
function speaker_play_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);if(node.bools["not_wait"]==undefined)node.bools["not_wait"]=true;break;case RUNNING:if(!m_sfx.is_playing(node.obj))if(node.state==0)node.state=1;switch(node.state){case -1:for(var k in logic.logic_threads){var curr_node=logic.logic_threads[k].thread_state.curr_node;if(curr_node!=-1){var node2=
logic.logic_threads[k].nodes[curr_node];if(node2.type=="SPEAKER_PLAY"&&node2!=node&&node2.state==0&&node2.obj==node.obj)node2.state=1}}if(!node.bools["not_wait"])thread_state.in_progress=true;m_sfx.play_def(node.obj);node.state=0;break;case 0:if(node.bools["not_wait"]){thread_state.curr_node=node.slot_idx_order;node.state=-1}break;case 1:if(!node.bools["not_wait"])thread_state.in_progress=false;thread_state.curr_node=node.slot_idx_order;node.state=-1;break;default:m_util.panic("Unknown state of "+
node.name);node.state=-1;break}}}function speaker_stop_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);break;case RUNNING:m_sfx.stop(node.obj);thread_state.curr_node=node.slot_idx_order;break}}function set_shader_node_param_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:if(node.objects_paths["id0"]){node.objects["id0"]=
m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths["id0"],0);node.nodes_paths["id0"].unshift(node.materials_names["id0"])}break;case RUNNING:if(node.shader_nd_type=="ShaderNodeRGB")m_batch.set_nodemat_rgb(node.objects["id0"],node.nodes_paths["id0"],node.bools["id0"]?convert_variable(get_var(node.vars["id0"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["id0"],node.bools["id1"]?convert_variable(get_var(node.vars["id1"],logic.variables,thread_state.variables),NT_NUMBER):
node.floats["id1"],node.bools["id2"]?convert_variable(get_var(node.vars["id2"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["id2"]);if(node.shader_nd_type=="ShaderNodeValue")m_batch.set_nodemat_value(node.objects["id0"],node.nodes_paths["id0"],node.bools["id0"]?convert_variable(get_var(node.vars["id0"],logic.variables,thread_state.variables),NT_NUMBER):node.floats["id0"]);thread_state.curr_node=node.slot_idx_order;break}}function math_handler(node,logic,thread_state,timeline,elapsed,
start_time){switch(logic.state){case RUNNING:var val1=node.vars["v1"][1]==-1?node.floats["inp1"]:convert_variable(get_var(node.vars["v1"],logic.variables,thread_state.variables),NT_NUMBER);var val2=node.vars["v2"][1]==-1?node.floats["inp2"]:convert_variable(get_var(node.vars["v2"],logic.variables,thread_state.variables),NT_NUMBER);var result=0;switch(node.op){case "ADD":result=val1+val2;break;case "MUL":result=val1*val2;break;case "SUB":result=val1-val2;break;case "DIV":if(val2==0)m_util.panic("Division by zero in Logic script");
result=val1/val2;break;case "RAND":result=Math.random()*(val2-val1)+val1;break}set_var(node.vars["vd"],logic.variables,thread_state.variables,result);thread_state.curr_node=node.slot_idx_order;break}}function conditional_jump_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var arg_type=node.bools["str"]?NT_STRING:NT_NUMBER;var arg_arr=node.bools["str"]?node.strings:node.floats;var val1=node.vars["v1"][1]==-1?arg_arr["inp1"]:convert_variable(get_var(node.vars["v1"],
logic.variables,thread_state.variables),arg_type);var val2=node.vars["v2"][1]==-1?arg_arr["inp2"]:convert_variable(get_var(node.vars["v2"],logic.variables,thread_state.variables),arg_type);var cond_result=false;switch(node.common_usage_names["condition"]){case NC_EQUAL:if(val1==val2)cond_result=true;break;case NC_NOTEQUAL:if(val1!=val2)cond_result=true;break;case NC_LESS:if(val1<val2)cond_result=true;break;case NC_GREATER:if(val1>val2)cond_result=true;break;case NC_LEQUAL:if(val1<=val2)cond_result=
true;break;case NC_GEQUAL:if(val1>=val2)cond_result=true;break}if(cond_result)thread_state.curr_node=node.slot_idx_jump;else thread_state.curr_node=node.slot_idx_order;break}}function regstore_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var arg_arr=node.common_usage_names["variable_type"]==NT_STRING?node.strings:node.floats;set_var([node.bools["gl"]||node.vars["vd"][0],node.vars["vd"][1]],logic.variables,thread_state.variables,arg_arr["inp1"]);thread_state.curr_node=
node.slot_idx_order;break}}function play_anim_handler(node,logic,thread_state,timeline,elapsed,start_time){function check_anim(obj,anim_name){var status=0;for(var i=0;i<8;i++){var anim_slot=obj.anim_slots[i];if(anim_slot&&anim_slot.animation_name)if(anim_slot.animation_name==anim_name)if(status==0)status=1;else return false}if(status==1)return true;else return false}var slot=m_anim.SLOT_ALL;if(!node.anim_name=="")slot=m_anim.SLOT_0;switch(logic.state){case INITIALIZATION:node.obj=node.bools["env"]?
get_world(node):get_object(node);var behavior=node.common_usage_names["param_anim_behavior"];if(!behavior)behavior="FINISH_STOP";node.tmp1=m_anim.anim_behavior_bpy_b4w(behavior);break;case RUNNING:if(!m_anim.is_play(node.obj,slot))if(node.state==0)node.state=1;switch(node.state){case -1:for(var k in logic.logic_threads){var curr_node=logic.logic_threads[k].thread_state.curr_node;if(curr_node!=-1){var node2=logic.logic_threads[k].nodes[curr_node];if(node2.type=="PLAY_ANIM"&&node2!=node&&node2.state==
0&&node2.obj==node.obj)node2.state=1}}if(node.anim_name==""){m_anim.apply_def(node.obj);m_anim.set_behavior(node.obj,node.tmp1,slot)}else if(!check_anim(node.obj,node.anim_name)){m_anim.apply(node.obj,node.anim_name,slot);m_anim.set_behavior(node.obj,node.tmp1,slot)}if(!node.bools["not_wait"])thread_state.in_progress=true;m_anim.play(node.obj,null,slot);node.state=0;if(node.bools["not_wait"]){thread_state.curr_node=node.slot_idx_order;node.state=-1}break;case 0:break;case 1:if(!node.bools["not_wait"])thread_state.in_progress=
false;thread_state.curr_node=node.slot_idx_order;node.state=-1;break;default:m_util.panic("Unknown state of "+node.name);node.state=-1;break}break}}function stop_anim_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case INITIALIZATION:node.obj=node.bools["env"]?get_world(node):get_object(node);break;case RUNNING:m_anim.stop(node.obj,m_anim.SLOT_ALL);if(node.bools["rst"])m_anim.set_first_frame(node.obj,m_anim.SLOT_ALL);thread_state.curr_node=node.slot_idx_order;break}}
function string_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var op1=node.bools["id0"]?convert_variable(get_var(node.vars["id0"],logic.variables,thread_state.variables),NT_STRING):node.strings["id0"];var op2=node.bools["id1"]?convert_variable(get_var(node.vars["id1"],logic.variables,thread_state.variables),NT_STRING):node.strings["id1"];var result=0;switch(node.floats["sop"]){case NSO_JOIN:result=op1+op2;break;case NSO_FIND:result=op1.indexOf(op2);
break;case NSO_REPLACE:var op3=node.bools["id2"]?convert_variable(get_var(node.vars["id2"],logic.variables,thread_state.variables),NT_STRING):node.strings["id2"];result=op1.replace(op2,op3);break;case NSO_SPLIT:result=op1.substring(0,op1.indexOf(op2));set_var(node.vars["dst1"],logic.variables,thread_state.variables,op1.substring(op1.indexOf(op2)+1,op1.length));if(get_var(vars["dst"],logic.variables,thread_state.variables)==""){result=get_var(vars["dst1"],logic.variables,thread_state.variables);set_var(vars["dst1"],
logic.variables,thread_state.variables,"")}break;case NSO_COMPARE:switch(node.common_usage_names["condition"]){case NC_EQUAL:result=op1==op2?1:0;break;case NC_NOTEQUAL:result=op1!=op2?1:0;break;case NC_LESS:result=op1<op2?1:0;break;case NC_GREATER:result=op1>op2?1:0;break;case NC_LEQUAL:result=op1<=op2?1:0;break;case NC_GEQUAL:result=op1>=op2?1:0;break}break}set_var(node.vars["dst"],logic.variables,thread_state.variables,result);thread_state.curr_node=node.slot_idx_order;break}}function get_timeline_handler(node,
logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var curr_frame=node.bools["nla"]?convert_variable(m_nla.get_frame(timeline),NT_NUMBER):convert_variable(m_time.get_frame(timeline),NT_NUMBER);set_var(node.vars["vd"],logic.variables,thread_state.variables,curr_frame);thread_state.curr_node=node.slot_idx_order;break}}function json_handler(node,logic,thread_state,timeline,elapsed,start_time){function get_json_deep_values(src_json,parse_paths,parse_vars,dest_vars){for(var i=
0;i<parse_paths.length;i++){var full_path=parse_paths[i];var path_steps=full_path.split(".");var deep_value=src_json;var dest_name=parse_vars[i];for(var j=0;j<path_steps.length;j++){deep_value=deep_value[path_steps[j]];if(deep_value===undefined||deep_value===null)break}deep_value=convert_b4w_type(deep_value);dest_vars[dest_name]=deep_value}}function encode_json_deep_values(src_vars,encode_paths,encode_vars,dest_json){if(!dest_json)dest_json={};for(var i=0;i<encode_paths.length;i++){var full_path=
encode_paths[i];var path_steps=full_path.split(".");var deep_value=dest_json;var src_name=encode_vars[i];if(!src_name in src_vars)continue;for(var j=0;j<path_steps.length-1;j++){if(deep_value[path_steps[j]]===undefined)if(isNaN(path_steps[j+1]))deep_value[path_steps[j]]={};else deep_value[path_steps[j]]=[];deep_value=deep_value[path_steps[j]]}var last_path_step=path_steps[path_steps.length-1];deep_value[last_path_step]=convert_b4w_type(src_vars[src_name])}}switch(logic.state){case RUNNING:switch(node.common_usage_names["json_operation"]){case "PARSE":try{var src_json_string=
convert_variable(get_var(node.vars["jsn"],logic.variables,thread_state.variables),NT_STRING);var src_json=JSON.parse(src_json_string);get_json_deep_values(src_json,node.parse_json_paths,node.parse_json_vars,thread_state.variables)}catch(e){m_print.error("logic script error: non valid JSON string")}break;case "ENCODE":var dest_json={};encode_json_deep_values(thread_state.variables,node.encode_json_paths,node.encode_json_vars,dest_json);var dest_json_string=convert_variable(JSON.stringify(dest_json),
NT_STRING);set_var(node.vars["jsn"],logic.variables,thread_state.variables,dest_json_string);break}thread_state.curr_node=node.slot_idx_order;break}}function js_callback_handler(node,logic,thread_state,timeline,elapsed,start_time){switch(logic.state){case RUNNING:var cb_id=node.bools["cb"]?convert_variable(get_var(node.vars["cb"],logic.variables,thread_state.variables),NT_STRING):node.strings["cb"];var in_params=[];var index=0;var key="id"+index;var param;var in_types_dict=node.common_usage_names["js_cb_params"];
while(key in in_types_dict){if(in_types_dict[key]==NCPT_OBJECT)param=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,node.objects_paths[key],0);else param=get_var(node.vars[key],logic.variables,thread_state.variables);in_params.push(param);index++;key="id"+index}var out_params=[];index=0;key="out"+index;while(key in node.vars){param=get_var(node.vars[key],logic.variables,thread_state.variables);out_params.push(param);index++;key="out"+index}_logic_custom_cb_arr[cb_id](in_params,out_params);for(var i=
0;i<out_params.length;i++){key="out"+i;if(key in node.vars)set_var(node.vars[key],logic.variables,thread_state.variables,convert_b4w_type(out_params[i]))}thread_state.curr_node=node.slot_idx_order;break}}function process_logic_thread(thread,logic,timeline,elapsed,start_time){var script=thread.nodes;if(!script.length)return;for(var i=0;i<script.length;i++)script[i].processed=false;for(var i=0;i<script.length;i++){if(thread.thread_state.curr_node>=0)var node=script[thread.thread_state.curr_node];else return;
if(node.processed)return;if(!node.mute){node.process_node(node,logic,thread.thread_state,timeline,elapsed,start_time);node.processed=true}else if(node.type=="ENTRYPOINT")return;else{thread.thread_state.curr_node=node.slot_idx_order;node.processed=true;continue}}}function prepare_logic(scene,logic){var bpy_logic_threads=scene["b4w_logic_nodes"];var logic_threads=logic.logic_threads;logic.state=INITIALIZATION;for(var k=0;k<bpy_logic_threads.length;k++){var thread={nodes:[],thread_state:{scene:scene,
curr_node:0,in_progress:false,thread_index:k,variables:{"R1":0,"R2":0,"R3":0,"R4":0,"R5":0,"R6":0,"R7":0,"R8":0}}};logic_threads.push(thread);var logic_script=logic_threads[logic_threads.length-1];var subtree=bpy_logic_threads[k];for(var i=0;i<subtree.length;i++){var snode=subtree[i];var node={name:snode["name"],type:snode["type"],label:snode["label"],slot_idx_order:snode["slot_idx_order"],slot_idx_jump:snode["slot_idx_jump"],frame_start:snode["frame_range"][0],frame_end:snode["frame_range"][1],frame_start_mask:snode["frame_range_mask"]?
snode["frame_range_mask"][0]:true,frame_end_mask:snode["frame_range_mask"]?snode["frame_range_mask"][1]:true,state:-1,sel_objs_len:-1,sel_obj_idx:-1,param_name:snode["param_name"],op:snode["operation"],mute:snode["mute"],dupli_name_list:snode["object"],obj:null,objects:{},anim_name:snode["anim_name"],parse_json_vars:snode["parse_json_vars"],parse_json_paths:snode["parse_json_paths"],objects_paths:snode["objects_paths"],nodes_paths:snode["nodes_paths"],floats:snode["floats"],bools:snode["bools"],vars:snode["variables"],
strings:snode["strings"],materials_names:snode["materials_names"],shader_nd_type:snode["shader_nd_type"],common_usage_names:snode["common_usage_names"],encode_json_vars:snode["encode_json_vars"],encode_json_paths:snode["encode_json_paths"],thread:logic_script,process_node:_nodes_handlers[snode["type"]]?_nodes_handlers[snode["type"]]:unknown_node_handler,processed:false,timer:0,tmp1:0,camera_state:null,sel_obj_idxs:null,links_dict:snode["links"],links_idxs:[]};logic_script.nodes.push(node)}for(var l=
0;l<logic_script.nodes.length;l++){node=logic_script.nodes[l];node.process_node(node,logic,thread.thread_state,0,0)}}var markers=scene["timeline_markers"];for(var key in markers)logic.sorted_markers_values.push(markers[key]);function sortNumber(a,b){return a-b}logic.sorted_markers_values.sort(sortNumber);logic.state=RUNNING;_logic_arr.push(logic)}function convert_variable(variable,type){switch(type){case NT_NUMBER:return Boolean(Number(variable))?Number(variable):0;case NT_STRING:return String(variable);
default:return null}}function convert_b4w_type(variable){switch(typeof variable){case "string":return convert_variable(variable,NT_STRING);case "number":return convert_variable(variable,NT_NUMBER);default:return convert_variable(variable,NT_STRING)}}exports.cleanup=function(){_logic_arr.length=0;_logic_custom_cb_arr={}}};b4w.module["__math"]=function(exports,require){var m_vec3=require("__vec3");var m_mat3=require("__mat3");var _vec3_tmp=new Float32Array(3);var _mat3_tmp=new Float32Array(9);var _mat3_tmp2=new Float32Array(9);var _mat3_tmp3=new Float32Array(9);var _mat3_tmp4=new Float32Array(9);var MAX_ITER_NUM=100;exports.get_pline_directional_vec=function(pline,dest){dest=dest||new Float32Array(3);dest[0]=pline[3];dest[1]=pline[4];dest[2]=pline[5];return dest};exports.get_pline_initial_point=function(pline,dest){dest=
dest||new Float32Array(3);return m_vec3.copy(pline,dest)};exports.set_pline_initial_point=function(pline,point){m_vec3.copy(point,pline)};exports.set_pline_directional_vec=function(pline,vec){m_vec3.normalize(vec,_vec3_tmp);pline[3]=_vec3_tmp[0];pline[4]=_vec3_tmp[1];pline[5]=_vec3_tmp[2]};exports.calc_pline_point=function(pline,t,dest){dest=dest||new Float32Array(3);dest[0]=pline[0]+pline[3]*t;dest[1]=pline[1]+pline[4]*t;dest[2]=pline[2]+pline[5]*t};exports.calk_average_position=function(points,
dest){for(var i=0;i<points.length;i=i+3){dest[0]+=points[i];dest[1]+=points[i+1];dest[2]+=points[i+2]}return m_vec3.scale(dest,3/points.length,dest)};exports.calc_covariance_matrix=function(points,average_pos,dest){for(var i=0;i<dest.length;i++)dest[i]=0;for(var i=0;i<points.length;i=i+3){var xm=points[i]-average_pos[0];var ym=points[i+1]-average_pos[1];var zm=points[i+2]-average_pos[2];dest[0]+=xm*xm;dest[1]+=xm*ym;dest[2]+=xm*zm;dest[4]+=ym*ym;dest[5]+=ym*zm;dest[8]+=zm*zm}dest[3]=dest[1];dest[6]=
dest[2];dest[7]=dest[5];for(var i=0;i<dest.length;i++)dest[i]*=3/points.length;return dest};exports.find_eigenvectors=function(m,err,dest){var matrix=m_mat3.copy(m,_mat3_tmp);if(calc_canonical_mat_error(matrix)<err)return m_mat3.identity(dest);var rot_matrix=find_elem_rotation_matrix(matrix,_mat3_tmp2);var rot_matrix_t=m_mat3.transpose(rot_matrix,_mat3_tmp3);m_mat3.multiply(matrix,rot_matrix_t,_mat3_tmp4);m_mat3.multiply(rot_matrix,_mat3_tmp4,matrix);var eigenvectors=m_mat3.copy(rot_matrix,dest);
var count=1;while(err<=calc_canonical_mat_error(matrix)&&count<MAX_ITER_NUM){var rot_matrix=find_elem_rotation_matrix(matrix,_mat3_tmp2);var rot_matrix_t=m_mat3.transpose(rot_matrix,_mat3_tmp3);m_mat3.multiply(matrix,rot_matrix_t,_mat3_tmp4);m_mat3.multiply(rot_matrix,_mat3_tmp4,matrix);m_mat3.multiply(rot_matrix,eigenvectors,eigenvectors);count++}return eigenvectors};function find_elem_rotation_matrix(m,dest){var max=m[1];var ind=1;for(var i=2;i<m.length;i++)if(i!=4&&i!=8&&Math.abs(m[i])>Math.abs(max)){max=
m[i];ind=i}var ii=Math.floor(ind/3);var jj=ind%3;var fi=.5*Math.atan(2*max/(m[ii*3+ii]-m[jj*3+jj]));for(var i=0;i<dest.length;i++)if(i==0||i==4||i==8)dest[i]=1;else dest[i]=0;dest[jj+ii*3]=-Math.sin(fi);dest[ii+jj*3]=Math.sin(fi);dest[ii+ii*3]=Math.cos(fi);dest[jj+jj*3]=Math.cos(fi);return dest}function calc_canonical_mat_error(m){return Math.sqrt(m[1]*m[1]+m[2]*m[2]+m[5]*m[5])}exports.point_plane_dist=function(pt,plane){return plane[0]*pt[0]+plane[1]*pt[1]+plane[2]*pt[2]+plane[3]}};b4w.module["__nla"]=function(exports,require){var m_anim=require("__animation");var m_cfg=require("__config");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_tex=require("__textures");var m_time=require("__time");var m_util=require("__util");var cfg_def=m_cfg.defaults;var _nla_arr=[];var _start_time=-1;var CF_FREEZE_EPSILON=1E-6;exports.update_object=function(bpy_source,obj){var sd=find_scene_data_for_nla(obj);
if(sd){sd.obj_has_nla_on_scene=true;var slot_num=0;var adata=bpy_source["animation_data"];if(adata&&adata["nla_tracks"].length){var nla_tracks=adata["nla_tracks"];if(m_obj_util.is_armature(obj)||m_obj_util.is_camera(obj)||m_obj_util.is_mesh(obj)||m_obj_util.is_empty(obj)||m_obj_util.is_lamp(obj)||m_obj_util.is_speaker(obj)||m_obj_util.is_world(obj)){var nla_events=get_nla_events(nla_tracks,slot_num);if(nla_events.length){obj.nla_events=obj.nla_events.concat(nla_events);slot_num++}}}if(bpy_obj_has_data_param_nla(bpy_source)){var nla_tracks=
bpy_source["data"]["animation_data"]["nla_tracks"];var nla_events=get_nla_events(nla_tracks,slot_num);if(nla_events.length){obj.nla_events=obj.nla_events.concat(nla_events);slot_num++}}if(m_obj_util.is_mesh(obj)){var materials=bpy_source["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];if(mat["use_nodes"]&&mat["node_tree"]){var nla_tracks=[];get_nodetree_nla_tracks_r(mat["node_tree"],nla_tracks);var nla_events=get_nla_events(nla_tracks,slot_num);if(nla_events.length){slot_num+=
assign_anim_slots(nla_events,slot_num);obj.nla_events=obj.nla_events.concat(nla_events)}}}}if(!m_obj_util.is_world(obj)){for(var j=0;j<bpy_source["particle_systems"].length;j++){var psys=bpy_source["particle_systems"][j];var pset=psys["settings"];if(pset["type"]=="EMITTER"&&pset["b4w_allow_nla"]){var ev=init_event();ev.type="CLIP";ev.frame_start=sd.scene["frame_start"];ev.frame_end=sd.scene["frame_end"]+1;ev.anim_name=psys["name"];ev.anim_slot=slot_num;ev.action_frame_start=ev.frame_start;ev.action_frame_end=
ev.frame_end;obj.nla_events.push(ev);slot_num++}}var slot_num_va=slot_num+1;for(var j=0;j<obj.vertex_anim.length;j++){var va=obj.vertex_anim[j];if(va.allow_nla){slot_num=slot_num_va;var ev=init_event();ev.type="CLIP";ev.frame_start=sd.scene["frame_start"];ev.frame_end=sd.scene["frame_end"]+1;ev.anim_name=va.name;ev.anim_slot=slot_num;ev.action_frame_start=ev.frame_start;ev.action_frame_end=ev.frame_end;obj.nla_events.push(ev)}}}}};function find_scene_data_for_nla(obj){var scene_data=null;for(var i=
obj.scenes_data.length-1;i>=0;i--){var sd=obj.scenes_data[i];if(sd.scene["b4w_use_nla"]){scene_data=sd;if(sd.scene._is_main)break}}return scene_data}exports.update_scene=function(scene,is_cyclic,data_id){if(!scene._nla){scene._nla={frame_start:scene["frame_start"],frame_end:scene["frame_end"],frame_offset:0,last_frame:-1,range_end:scene["frame_end"],range_start:scene["frame_start"],user_callback:null,cyclic:is_cyclic,objects:[],textures:[],scene_name:scene["name"],is_stopped:false,force_update:false,
rewinded_to_start:true};_nla_arr.push(scene._nla)}var nla=scene._nla;var objs=m_obj.get_scene_objs_derived(scene,"ALL",data_id);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.nla_events.length){for(var j=0;j<obj.scenes_data.length;j++){var sd=obj.scenes_data[j];if(sd.scene==scene&&sd.obj_has_nla_on_scene)nla.objects.push(obj)}remove_inconsistent_nla(obj.nla_events,nla,obj.name);calc_nla_extents(obj.nla_events,nla)}}var textures=scene._render.video_textures;for(var i=0;i<textures.length;i++){var texture=
textures[i]._render;if(texture.use_nla&&(texture.video_file||texture.seq_video)&&texture.vtex_data_id==data_id){var ev=init_event();ev.type="VIDEO";if(texture.use_cyclic){ev.frame_start=0;ev.frame_end=nla.frame_end}else{ev.frame_start=m_util.clamp(texture.frame_start,0,nla.frame_end);ev.frame_end=m_util.clamp(texture.frame_start+texture.frame_duration,0,nla.frame_end)}ev.anim_name=textures[i].name;nla.textures.push(texture)}}};function remove_inconsistent_nla(nla_events,nla,name){for(var i=0;i<nla_events.length;i++){var ev=
nla_events[i];if(nla.frame_start>ev.frame_end||nla.frame_end<ev.frame_start){var strip_str=name+" ["+ev.frame_start+":"+ev.frame_end+"]";m_print.warn("NLA: Strip is out of scene range: "+strip_str);nla_events.splice(i,1);i--;continue}if(!ev.anim_name&&ev.type=="CLIP"){m_print.warn('NLA: no action in strip for object "'+name+'".');nla_events.splice(i,1);i--}}}function calc_nla_extents(nla_events,nla){for(var i=0;i<nla_events.length;i++){var ev=nla_events[i];var ext_frame_start=nla.frame_start;var ext_frame_end=
nla.frame_end+1;for(var k=0;k<nla_events.length;k++){var ev_k=nla_events[k];if(ev.anim_slot!=ev_k.anim_slot)continue;if(ev_k.frame_end<=ev.frame_start)ext_frame_start=ev.frame_start;if(ev_k.frame_start>=ev.frame_end)ext_frame_end=Math.min(ext_frame_end,ev_k.frame_start)}ev.ext_frame_start=ext_frame_start;ev.ext_frame_end=ext_frame_end;calc_clip_event_action_frame_final(ev)}}function calc_clip_event_action_frame_final(ev){if(ev.repeat%1===0)ev.action_frame_final=ev.action_frame_end;else ev.action_frame_final=
ev.action_frame_start+(ev.action_frame_end-ev.action_frame_start)*(ev.repeat%1)}function assign_anim_slots(nla_events,start_slot){var actions=m_anim.get_all_actions();var fc_usage=[];var num_assigned_slots=0;for(var i=0;i<nla_events.length;i++){var ev=nla_events[i];if(ev.anim_uuid!="")var action=m_util.keysearch("uuid",ev.anim_uuid,actions);else{var name=ev.anim_name;var action=m_util.keysearch("name",name,actions)||m_util.keysearch("name",name+"_B4W_BAKED",actions)}if(!action)continue;var fcurves=
action["fcurves"];var cur_fcurves_names=[];for(var fcurve in fcurves)cur_fcurves_names.push(fcurve);fc_usage.push(cur_fcurves_names)}for(var i=0;i<fc_usage.length;i++){var have_common_fc=false;for(var k=0;k<i;k++)if(m_util.arrays_have_common(fc_usage[i],fc_usage[k])){nla_events[i].anim_slot=nla_events[k].anim_slot;have_common_fc=true;break}if(!have_common_fc)nla_events[i].anim_slot=start_slot+num_assigned_slots++}return num_assigned_slots}function init_event(){var ev={type:"CLIP",frame_start:0,frame_end:0,
scheduled:false,paused:false,anim_name:"",anim_uuid:"",anim_slot:0,action_frame_start:0,action_frame_end:0,ext_frame_start:0,ext_frame_end:0,use_reverse:false,scale:1,repeat:1,action_frame_final:0};return ev}function get_nodetree_nla_tracks_r(node_tree,container){if(node_tree["animation_data"]){var anim_data=node_tree["animation_data"];var nla_tracks=anim_data["nla_tracks"];if(nla_tracks)for(var i=0;i<nla_tracks.length;i++)container.push(nla_tracks[i])}var nodes=node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=
nodes[i];if(node["node_group"]){var g_node_tree=node["node_group"]["node_tree"];if(g_node_tree)get_nodetree_nla_tracks_r(g_node_tree,container)}}}exports.start=function(){_start_time=0};exports.get_start_time=function(){return _start_time};exports.get_frame_offset=function(scene){if(scene._nla)return scene._nla.frame_offset;return null};exports.set_frame_offset=function(scene,frame_offset){if(scene._nla){scene._nla.frame_offset=frame_offset;return true}return false};exports.update=function(timeline,
elapsed){if(_start_time<0)return;else if(_start_time==0)_start_time=timeline;for(var i=0;i<_nla_arr.length;i++){var nla=_nla_arr[i];if(nla.is_stopped)nla.frame_offset-=m_time.get_framerate()*elapsed;var cf=calc_curr_frame_scene(nla,timeline);if((!nla.is_stopped||nla.force_update)&&cf>=nla.range_end)if(nla.cyclic)cf=nla_range_end_rewind(nla,timeline);else nla_range_end_stop(nla,cf);if(!nla.is_stopped||nla.force_update){process_nla_objects(nla,cf,elapsed);process_nla_video_textures(timeline,nla,cf);
nla.last_frame=cf}nla.force_update=false;nla.rewinded_to_start=false}};function nla_range_end_stop(nla,curr_frame){nla.is_stopped=true;nla.frame_offset-=curr_frame-nla.range_end;if(nla.user_callback)nla.user_callback()}function nla_range_end_rewind(nla,timeline){if(nla.user_callback)nla.user_callback();set_frame(nla.range_start,timeline);nla.rewinded_to_start=true;return calc_curr_frame_scene(nla,timeline)}function process_nla_objects(nla,curr_frame,elapsed){for(var i=0;i<nla.objects.length;i++){var obj=
nla.objects[i];var nla_events=obj.nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];if(ev.type=="SOUND"&&curr_frame<nla.last_frame-CF_FREEZE_EPSILON)ev.scheduled=false}for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];switch(ev.type){case "CLIP":if(ev.ext_frame_start<=curr_frame&&curr_frame<ev.ext_frame_end)if(!ev.scheduled){process_clip_event_start(obj,ev,curr_frame,elapsed);for(var k=0;k<nla_events.length;k++)if(nla_events[k]!=ev&&nla_events[k].anim_slot==ev.anim_slot)nla_events[k].scheduled=
false;ev.scheduled=true}if(ev.scheduled)process_clip_event(obj,ev,curr_frame,elapsed);break;case "SOUND":if((curr_frame<nla.last_frame-CF_FREEZE_EPSILON||nla.last_frame<ev.frame_start)&&ev.frame_start<=curr_frame&&curr_frame<ev.frame_end)if(!ev.scheduled){process_sound_event(obj,ev,curr_frame);ev.scheduled=true}if(nla.last_frame<ev.frame_end&&ev.frame_end<=curr_frame)if(ev.scheduled)ev.scheduled=false;break;default:break}}}}function process_nla_video_textures(timeline,nla,nla_frame){for(var i=0;i<
nla.textures.length;i++){var tex=nla.textures[i];if(!tex.video_file&&!tex.seq_video)continue;var video_frame_native=m_tex.video_get_current_frame(tex);var video_frame_clamped=get_video_frame_clamped(nla_frame,tex);var frame_start=m_tex.video_get_start_frame(tex);var need_update=false;var need_set_frame=false;if(nla.force_update||nla.rewinded_to_start)need_set_frame=true;if(!nla.is_stopped){var need_play=frame_need_play_video(nla_frame,tex);var is_played=m_tex.video_is_played(tex);if(tex.use_cyclic&&
video_frame_clamped==frame_start)need_set_frame=true;if(!is_played&&video_frame_native!=video_frame_clamped)need_set_frame=true;if(need_play&&!is_played)m_tex.play_video(tex.name,tex.vtex_data_id);else if(need_play&&is_played)need_update=true;else if(!need_play&&is_played)if(tex.video_file&&video_frame_native<video_frame_clamped)need_update=true;else m_tex.pause_video(tex.name,tex.vtex_data_id)}if(need_set_frame){m_tex.set_frame_video(tex.name,video_frame_clamped,tex.vtex_data_id);if(tex.seq_video)tex.seq_last_discrete_mark=
m_tex.seq_video_get_discrete_timemark(tex,timeline)}else if(need_update&&m_tex.video_update_is_available(tex))if(tex.video_file)m_tex.update_video_texture(tex);else{var mark=m_tex.seq_video_get_discrete_timemark(tex,timeline);if(mark!=tex.seq_last_discrete_mark){tex.seq_cur_frame=video_frame_clamped;m_tex.update_seq_video_texture(tex)}tex.seq_last_discrete_mark=mark}}}function nla_frame_to_video_frame(nla_frame,vtex){var frame_delta=Math.round(nla_frame)-vtex.frame_start;if(vtex.use_cyclic){frame_delta=
frame_delta%vtex.frame_duration;if(frame_delta<0)frame_delta+=vtex.frame_duration}return vtex.frame_offset+frame_delta}function get_video_frame_clamped(nla_frame,vtex){var video_frame=nla_frame_to_video_frame(nla_frame,vtex);var frame_clamped=m_util.clamp(video_frame,vtex.frame_offset,vtex.frame_offset+m_tex.video_get_duration(vtex)-1);if(vtex.seq_video){frame_clamped=m_tex.video_frame_to_seq_frame(vtex,frame_clamped);if(frame_clamped==vtex.seq_movie_length)frame_clamped--}return frame_clamped}function frame_need_play_video(cf,
vtex){var frame=nla_frame_to_video_frame(cf,vtex);return vtex.frame_offset<=frame&&frame<=vtex.frame_offset+m_tex.video_get_duration(vtex)}function pause_scheduled_objects(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];var nla_events=obj.nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];if(ev.scheduled&&!ev.paused){process_event_pause(obj);ev.paused=true}}}}function resume_scheduled_objects(objects){for(var i=0;i<objects.length;i++){var obj=objects[i];var nla_events=
obj.nla_events;for(var j=0;j<nla_events.length;j++){var ev=nla_events[j];if(ev.paused){process_event_resume(obj);ev.paused=false}}}}function calc_curr_frame_scene(nla,timeline){var cf=(timeline-_start_time)*m_time.get_framerate()+nla.frame_offset;if(cf>nla.frame_start){cf-=nla.frame_start;if(nla.cyclic){var stride=nla.frame_end-nla.frame_start+1;cf%=stride}cf+=nla.frame_start}else cf=nla.frame_start;return cf}function process_clip_event_start(obj,ev,frame,elapsed){if(ev.anim_uuid!="")m_anim.apply_by_uuid(obj,
ev.anim_uuid,ev.anim_slot);else m_anim.apply(obj,ev.anim_name,ev.anim_slot);m_anim.set_behavior(obj,m_anim.AB_FINISH_STOP,ev.anim_slot);var action_frame=get_curr_action_frame(ev.frame_start,ev);m_anim.set_frame(obj,action_frame,ev.anim_slot)}function process_clip_event(obj,ev,frame,elapsed){var new_anim_frame=get_curr_action_frame(frame,ev);var curr_anim_frame=m_anim.get_current_frame_float(obj,ev.anim_slot);if(Math.abs(new_anim_frame-curr_anim_frame)>CF_FREEZE_EPSILON)m_anim.set_frame(obj,new_anim_frame,
ev.anim_slot)}function get_curr_action_frame(frame,ev){frame=m_util.clamp(frame,ev.frame_start,ev.frame_end);if(frame==ev.frame_end)var action_frame=ev.action_frame_final;else{var track_frame=(frame-ev.frame_start)/ev.scale;var track_len=ev.action_frame_end-ev.action_frame_start;var action_frame_offset=track_frame%track_len;var action_frame=ev.action_frame_start+action_frame_offset}if(ev.use_reverse)action_frame=ev.action_frame_end-action_frame+ev.action_frame_start;return action_frame}function process_sound_event(obj,
ev,frame){var when=(ev.frame_start-frame)/m_time.get_framerate();var duration=(ev.frame_end-ev.frame_start)/m_time.get_framerate();m_sfx.play(obj,when,duration)}exports.cleanup=function(){_nla_arr.length=0;_start_time=-1};function get_nla_events(nla_tracks,anim_slot_num){var nla_events=[];for(var i=0;i<nla_tracks.length;i++){var track=nla_tracks[i];var strips=track["strips"];if(!strips)continue;for(var j=0;j<strips.length;j++){var strip=strips[j];var ev=init_event();ev.type=strip["type"];ev.frame_start=
strip["frame_start"];ev.frame_end=strip["frame_end"];ev.anim_slot=anim_slot_num;ev.action_frame_start=strip["action_frame_start"];ev.action_frame_end=strip["action_frame_end"];ev.use_reverse=strip["use_reverse"];ev.scale=strip["scale"];ev.repeat=strip["repeat"];if(strip["action"]){ev.anim_name=strip["action"]["name"];ev.anim_uuid=strip["action"]["uuid"]}nla_events.push(ev)}}return nla_events}exports.bpy_obj_has_nla=function(bpy_obj){var adata=bpy_obj["animation_data"];if(adata&&adata["nla_tracks"].length||
bpy_obj_has_data_param_nla(bpy_obj)||bpy_obj_has_nodemats_nla(bpy_obj))return true;else return false};function bpy_obj_has_data_param_nla(bpy_obj){if((bpy_obj["type"]=="SPEAKER"||bpy_obj["type"]=="LAMP")&&bpy_obj["data"]["animation_data"]&&bpy_obj["data"]["animation_data"]["nla_tracks"].length)return true;else return false}function bpy_obj_has_nodemats_nla(bpy_obj){if(bpy_obj["type"]!="MESH"||!bpy_obj["data"])return false;var materials=bpy_obj["data"]["materials"];if(!materials)return false;for(var j=
0;j<materials.length;j++){var mat=materials[j];var node_tree=mat["node_tree"];if(mat["use_nodes"]&&node_tree)if(check_nodetree_nla_tracks_r(node_tree))return true}return false}function check_nodetree_nla_tracks_r(node_tree,container){if(node_tree["animation_data"]){var anim_data=node_tree["animation_data"];var nla_tracks=anim_data["nla_tracks"];if(nla_tracks&&nla_tracks.length)return true}var nodes=node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node["node_group"]){var g_node_tree=
node["node_group"]["node_tree"];if(g_node_tree)check_nodetree_nla_tracks_r(g_node_tree,container)}}return false}exports.set_frame=set_frame;function set_frame(frame,timeline){var active_scene=m_scs.get_active();if(active_scene._nla){var cf=calc_curr_frame_scene(active_scene._nla,timeline);active_scene._nla.frame_offset-=cf-frame;active_scene._nla.force_update=true}}exports.get_frame=get_frame;function get_frame(timeline){var active_scene=m_scs.get_active();if(active_scene._nla)return calc_curr_frame_scene(active_scene._nla,
timeline);else return-1}exports.stop_nla=stop_nla;function stop_nla(){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.is_stopped=true;var vtexs=active_scene._nla.textures;for(var i=0;i<vtexs.length;i++){var vtex=vtexs[i];m_tex.pause_video(vtex.name,vtex.vtex_data_id)}}exports.play_nla=play_nla;function play_nla(callback){var active_scene=m_scs.get_active();if(active_scene._nla){active_scene._nla.is_stopped=false;if(callback)active_scene._nla.user_callback=callback;else active_scene._nla.user_callback=
null}}exports.get_frame_start=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene._nla.frame_start;else return-1};exports.get_frame_end=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene._nla.frame_end;else return-1};exports.is_play=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return!active_scene._nla.is_stopped;else return false};exports.check_nla=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene["b4w_use_nla"];
else return false};exports.check_logic_nodes=function(){var active_scene=m_scs.get_active();if(active_scene._nla)return active_scene["b4w_logic_nodes"].length>0;else return false};exports.set_range=function(start_frame,end_frame){var active_scene=m_scs.get_active();if(active_scene._nla){active_scene._nla.range_start=start_frame;active_scene._nla.range_end=end_frame}else return false};exports.set_range_end=function(end_frame){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.range_end=
end_frame;else return false};exports.set_range_start=function(start_frame){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.range_start=start_frame;else return false};exports.reset_range=reset_range;function reset_range(){var active_scene=m_scs.get_active();if(active_scene._nla){var nla=active_scene._nla;nla.range_start=nla.frame_start;nla.range_end=nla.frame_end}else return false}exports.set_cyclic=function(is_cyclic){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.cyclic=
is_cyclic;else return false};exports.clear_callback=function(){var active_scene=m_scs.get_active();if(active_scene._nla)active_scene._nla.user_callback=null};exports.set_offset_from_range_start=function(timeline){var active_scene=m_scs.get_active();var nla=active_scene._nla;if(nla){nla.frame_offset=-(timeline-_start_time)*m_time.get_framerate()+nla.range_start;nla.force_update=true}};exports.get_frame_end=function(){var active_scene=m_scs.get_active();var nla=active_scene._nla;if(nla)return nla.frame_end;
else return null}};b4w.module["__camera"]=function(exports,require){var m_bounds=require("__boundings");var m_cfg=require("__config");var m_cons=require("__constraints");var m_cont=require("__container");var m_mat4=require("__mat4");var m_math=require("__math");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_quat=require("__quat");var m_scenes=require("__scenes");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=
require("__vec4");var cfg_ctl=m_cfg.controls;var cfg_def=m_cfg.defaults;var TYPE_STEREO_LEFT=70;var TYPE_STEREO_RIGHT=80;var TYPE_HMD_LEFT=90;var TYPE_HMD_RIGHT=100;exports.TYPE_NONE=10;exports.TYPE_PERSP=20;exports.TYPE_ORTHO=30;exports.TYPE_PERSP_ASPECT=40;exports.TYPE_ORTHO_ASPECT=50;exports.TYPE_ORTHO_ASYMMETRIC=60;exports.TYPE_STEREO_LEFT=TYPE_STEREO_LEFT;exports.TYPE_STEREO_RIGHT=TYPE_STEREO_RIGHT;exports.TYPE_HMD_LEFT=TYPE_HMD_LEFT;exports.TYPE_HMD_RIGHT=TYPE_HMD_RIGHT;exports.MS_STATIC=0;
exports.MS_TARGET_CONTROLS=2;exports.MS_EYE_CONTROLS=3;exports.MS_HOVER_CONTROLS=4;var PIVOT_DEFAULT_DIST=10;var STEREO_CONV_DIST=6;var STEREO_EYE_DIST=.065;var DEF_WATER_PLANE_Y=-.05;var DEF_ORTHO_SCALE=2.5;var DEF_PERSP_FOV=40;var DEF_PERSP_NEAR=.1;var DEF_PERSP_FAR=1E3;var MAX_HOVER_INIT_ANGLE=m_util.deg_to_rad(.5);var _vec2_tmp=new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _quat4_tmp=
new Float32Array(4);var _quat4_tmp2=new Float32Array(4);var _vec4_tmp=new Float32Array(4);var _vec4_tmp2=new Float32Array(4);var _mat4_tmp=new Float32Array(16);var _frustum_corners_tmp=new Float32Array(24);var _pline_tmp=new Float32Array(6);exports.camera_object_to_camera=function(bpy_camobj,camobj){var render=camobj.render;var camobj_data=bpy_camobj["data"];switch(camobj_data["type"]){case "PERSP":var cam=create_camera(exports.TYPE_PERSP);if(camobj_data["angle_y"])var fov=m_util.rad_to_deg(camobj_data["angle_y"]);
set_frustum(cam,fov,camobj_data["clip_start"],camobj_data["clip_end"]);break;case "ORTHO":var cam=create_camera(exports.TYPE_ORTHO);var top_bound=camobj_data["ortho_scale"]/2;set_frustum(cam,top_bound,camobj_data["clip_start"],camobj_data["clip_end"]);break}cam.name=camobj.name;var cam_scenes_data=camobj.scenes_data;cam_scenes_data[0].cameras.push(cam);for(var i=1;i<cam_scenes_data.length;i++){var new_cam=m_util.clone_object_r(cam);cam_scenes_data[i].cameras.push(new_cam)}render.underwater=false;
render.move_style=move_style_bpy_to_b4w(camobj_data["b4w_move_style"]);render.dof_distance=camobj_data["dof_distance"];var dof_obj=camobj_data["dof_object"];render.dof_object=dof_obj?dof_obj._object:null;render.dof_front=camobj_data["b4w_dof_front"];render.dof_rear=camobj_data["b4w_dof_rear"];render.dof_power=camobj_data["b4w_dof_power"];render.velocity_trans=camobj_data["b4w_trans_velocity"];render.velocity_rot=camobj_data["b4w_rot_velocity"];render.velocity_zoom=camobj_data["b4w_zoom_velocity"];
var hor_rot_limits=hor_rot_limits_bpy_to_b4w(bpy_camobj,camobj);var vert_rot_limits=vert_rot_limits_bpy_to_b4w(bpy_camobj,camobj);var dist_limits=dist_limits_bpy_to_b4w(bpy_camobj,camobj);var hor_trans_limits=hor_trans_limits_bpy_to_b4w(bpy_camobj,camobj);var vert_trans_limits=vert_trans_limits_bpy_to_b4w(bpy_camobj,camobj);var pivot_limits=pivot_limits_bpy_to_b4w(bpy_camobj,camobj);switch(render.move_style){case exports.MS_STATIC:break;case exports.MS_EYE_CONTROLS:var pos=m_tsr.get_trans_view(camobj.render.world_tsr);
setup_eye_model(camobj,pos,null,hor_rot_limits,vert_rot_limits);break;case exports.MS_TARGET_CONTROLS:var pos=m_tsr.get_trans_view(camobj.render.world_tsr);setup_target_model(camobj,pos,camobj_data["b4w_target"],hor_rot_limits,vert_rot_limits,dist_limits,pivot_limits,camobj_data["b4w_use_panning"]);break;case exports.MS_HOVER_CONTROLS:var pos=m_tsr.get_trans_view(camobj.render.world_tsr);var pivot=init_hover_pivot(camobj,bpy_camobj["data"]["b4w_hover_zero_level"],_vec3_tmp2);setup_hover_model(camobj,
pos,pivot,dist_limits,vert_rot_limits,hor_trans_limits,vert_trans_limits,camobj_data["b4w_enable_hover_hor_rotation"]);break}clamp_limits(camobj);init_ortho_props(camobj)};function hor_rot_limits_bpy_to_b4w(bpy_camobj,camobj){var ms=camobj.render.move_style;var data=bpy_camobj["data"];var hor_rot_limits=null;if((ms==exports.MS_TARGET_CONTROLS||ms==exports.MS_EYE_CONTROLS)&&data["b4w_use_horizontal_clamping"]){hor_rot_limits={left:data["b4w_rotation_left_limit"],right:data["b4w_rotation_right_limit"],
camera_space:data["b4w_horizontal_clamping_type"]=="LOCAL"};if(ms==exports.MS_EYE_CONTROLS){hor_rot_limits.left*=-1;hor_rot_limits.right*=-1}}return hor_rot_limits}function vert_rot_limits_bpy_to_b4w(bpy_camobj,camobj){var ms=camobj.render.move_style;var data=bpy_camobj["data"];var vert_rot_limits=null;if((ms==exports.MS_TARGET_CONTROLS||ms==exports.MS_EYE_CONTROLS)&&data["b4w_use_vertical_clamping"]){vert_rot_limits={down:data["b4w_rotation_down_limit"],up:data["b4w_rotation_up_limit"],camera_space:data["b4w_vertical_clamping_type"]==
"LOCAL"};if(ms==exports.MS_TARGET_CONTROLS){vert_rot_limits.down*=-1;vert_rot_limits.up*=-1}}else if(ms==exports.MS_HOVER_CONTROLS&&data["b4w_use_zooming"])if(data["b4w_hover_angle_min"]<=data["b4w_hover_angle_max"]){vert_rot_limits={down:data["b4w_hover_angle_min"],up:data["b4w_hover_angle_max"]};vert_rot_limits.down*=-1;vert_rot_limits.up*=-1}else m_print.error("Wrong angle limits for the HOVER camera. Disabling angle limits.");return vert_rot_limits}function dist_limits_bpy_to_b4w(bpy_camobj,camobj){var ms=
camobj.render.move_style;var data=bpy_camobj["data"];var dist_limits=null;if(ms==exports.MS_TARGET_CONTROLS&&data["b4w_use_target_distance_limits"]&&data["b4w_distance_min"]<=data["b4w_distance_max"])dist_limits={min:data["b4w_distance_min"],max:data["b4w_distance_max"]};else if(ms===exports.MS_HOVER_CONTROLS&&data["b4w_use_zooming"])if(data["b4w_distance_min"]<=data["b4w_distance_max"])dist_limits={min:data["b4w_distance_min"],max:data["b4w_distance_max"]};else m_print.error("Wrong distance limits for the HOVER camera. Disabling distance limits.");
return dist_limits}function hor_trans_limits_bpy_to_b4w(bpy_camobj,camobj){var ms=camobj.render.move_style;var data=bpy_camobj["data"];var hor_trans_limits=null;if(ms==exports.MS_HOVER_CONTROLS&&data["b4w_use_horizontal_clamping"]&&data["b4w_horizontal_translation_min"]<=data["b4w_horizontal_translation_max"])hor_trans_limits={min:data["b4w_horizontal_translation_min"],max:data["b4w_horizontal_translation_max"]};return hor_trans_limits}function vert_trans_limits_bpy_to_b4w(bpy_camobj,camobj){var ms=
camobj.render.move_style;var data=bpy_camobj["data"];var vert_trans_limits=null;if(ms==exports.MS_HOVER_CONTROLS&&data["b4w_use_vertical_clamping"]&&data["b4w_vertical_translation_min"]<=data["b4w_vertical_translation_max"]){vert_trans_limits={min:data["b4w_vertical_translation_min"],max:data["b4w_vertical_translation_max"]};var max_z=-vert_trans_limits.min;var min_z=-vert_trans_limits.max;vert_trans_limits.min=min_z;vert_trans_limits.max=max_z}return vert_trans_limits}function pivot_limits_bpy_to_b4w(bpy_camobj,
camobj){var ms=camobj.render.move_style;var data=bpy_camobj["data"];var pivot_limits=null;if(ms==exports.MS_TARGET_CONTROLS&&data["b4w_use_pivot_limits"])pivot_limits={min_y:data["b4w_pivot_z_min"],max_y:data["b4w_pivot_z_max"]};return pivot_limits}exports.setup_eye_model=setup_eye_model;function setup_eye_model(camobj,pos,look_at,hor_rot_lim,vert_rot_lim){var render=camobj.render;m_trans.set_translation(camobj,pos);if(look_at)set_look_at_corrected(camobj,pos,look_at);set_horizontal_rot_limits(camobj,
hor_rot_lim);set_vertical_rot_limits(camobj,vert_rot_lim)}exports.setup_target_model=setup_target_model;function setup_target_model(camobj,pos,pivot,hor_rot_lim,vert_rot_lim,dist_lim,pivot_lim,use_panning){var render=camobj.render;m_trans.set_translation(camobj,pos);render.pivot.set(pivot);set_look_at_corrected(camobj,pos,pivot);set_horizontal_rot_limits(camobj,hor_rot_lim);set_vertical_rot_limits(camobj,vert_rot_lim);set_distance_limits(camobj,dist_lim);set_pivot_limits(camobj,pivot_lim);render.use_panning=
use_panning}exports.setup_hover_model=setup_hover_model;function setup_hover_model(camobj,pos,pivot,dist_lim,angle_lim,hor_trans_lim,vert_trans_lim,hor_rotation){var render=camobj.render;m_trans.set_translation(camobj,pos);render.hover_pivot.set(pivot);set_look_at_corrected(camobj,pos,pivot);hover_set_distance_limits(camobj,dist_lim);hover_set_vertical_limits(camobj,angle_lim);set_hor_trans_limits(camobj,hor_trans_lim);set_vert_trans_limits(camobj,vert_trans_lim);render.enable_hover_hor_rotation=
hor_rotation}function init_hover_pivot(camobj,zero_level,dest){var render=camobj.render;var trans=m_tsr.get_trans_view(render.world_tsr);var quat=m_tsr.get_quat_view(render.world_tsr);var normal_plane_oxy=_vec4_tmp;normal_plane_oxy.set(m_util.AXIS_Y);normal_plane_oxy[3]=0;var theta=get_camera_angles(camobj,_vec2_tmp)[1];var view_vector=m_util.quat_to_dir(quat,m_util.AXIS_MY,_vec3_tmp);m_math.set_pline_initial_point(_pline_tmp,trans);m_math.set_pline_directional_vec(_pline_tmp,view_vector);var res=
m_util.line_plane_intersect(normal_plane_oxy,-zero_level,_pline_tmp,dest);if(!res||Math.abs(theta)<MAX_HOVER_INIT_ANGLE){m_print.warn("Active hover camera view vector and the supporting plane "+"are parallel to each other. Hover pivot will be set based on the "+"camera position.");dest[0]=trans[0];dest[1]=0;dest[2]=trans[2]}return dest}exports.init_ortho_props=init_ortho_props;function init_ortho_props(camobj){var render=camobj.render;for(var i=0;i<camobj.scenes_data.length;i++){var main_cam=camobj.scenes_data[i].cameras[0];
if(main_cam.type==exports.TYPE_ORTHO)switch(render.move_style){case exports.MS_TARGET_CONTROLS:var trans=m_tsr.get_trans_view(render.world_tsr);render.init_dist=m_vec3.dist(trans,render.pivot);render.init_top=main_cam.top;break;case exports.MS_HOVER_CONTROLS:var trans=m_tsr.get_trans_view(render.world_tsr);render.init_dist=m_vec3.dist(trans,render.hover_pivot);render.init_top=main_cam.top;break}}}function init_camera(type){var cam={type:type,name:"",size_mult:1,width:0,height:0,framebuffer:null,framebuffer_prev:null,
color_attachment:null,depth_attachment:null,aspect:0,fov:0,near:0,far:0,left:0,right:0,top:0,bottom:0,hmd_fov:m_vec4.create(),world_tsr:new Float32Array(9),view_matrix:new Float32Array(16),proj_matrix:new Float32Array(16),view_proj_matrix:new Float32Array(16),view_proj_inv_matrix:new Float32Array(16),prev_view_proj_matrix:new Float32Array(16),sky_vp_inv_matrix:new Float32Array(16),view_tsr:m_tsr.create_ext(),view_zup_tsr:m_tsr.create_ext(),view_inv_zup_tsr:m_tsr.create_ext(),real_view_tsr:m_tsr.create_ext(),
real_view_zup_tsr:m_tsr.create_ext(),real_view_inv_zup_tsr:m_tsr.create_ext(),shadow_cast_billboard_view_tsr:m_tsr.create_ext(),dof_distance:0,dof_front:0,dof_rear:0,dof_power:0,dof_object:null,dof_on:false,lod_eye:new Float32Array(3),frustum_planes:create_frustum_planes(),stereo_conv_dist:0,stereo_eye_dist:0,reflection_plane:null,csm_centers:null,csm_radii:null,csm_center_dists:new Float32Array(4),pcf_blur_radii:new Float32Array(4)};cam.hmd_fov[0]=cam.hmd_fov[2]=45;cam.hmd_fov[1]=cam.hmd_fov[3]=
55;return cam}exports.create_frustum_planes=create_frustum_planes;function create_frustum_planes(){var frustum_planes={left:new Float32Array([0,0,0,0]),right:new Float32Array([0,0,0,0]),top:new Float32Array([0,0,0,0]),bottom:new Float32Array([0,0,0,0]),near:new Float32Array([0,0,0,0]),far:new Float32Array([0,0,0,0])};return frustum_planes}exports.move_style_bpy_to_b4w=move_style_bpy_to_b4w;function move_style_bpy_to_b4w(bpy_move_style){switch(bpy_move_style){case "STATIC":return exports.MS_STATIC;
break;case "TARGET":return exports.MS_TARGET_CONTROLS;break;case "EYE":return exports.MS_EYE_CONTROLS;break;case "HOVER":return exports.MS_HOVER_CONTROLS;break;default:throw"Unknown move style";}}exports.create_camera=create_camera;function create_camera(type){var cam=init_camera(type);if(type==exports.TYPE_NONE)return cam;switch(type){case exports.TYPE_PERSP:set_frustum(cam,DEF_PERSP_FOV,DEF_PERSP_NEAR,DEF_PERSP_FAR);break;case exports.TYPE_ORTHO:set_frustum(cam,DEF_ORTHO_SCALE,DEF_PERSP_NEAR,DEF_PERSP_FAR);
break;case exports.TYPE_PERSP_ASPECT:break;case exports.TYPE_ORTHO_ASPECT:break;case exports.TYPE_ORTHO_ASYMMETRIC:break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:case exports.TYPE_HMD_LEFT:case exports.TYPE_HMD_RIGHT:throw"Stereo camera may only be created from perspective one";break;default:throw"Unknown camera type";break}return cam}exports.check_attachment=function(cam,type){switch(type){case "COLOR":case "CUBEMAP":return Boolean(cam.color_attachment);case "DEPTH":return Boolean(cam.depth_attachment);
case "SCREEN":return!Boolean(cam.color_attachment)&&!Boolean(cam.depth_attachment);default:throw"Wrong attachment type: "+type;break}};exports.set_attachment=function(cam,type,tex){switch(type){case "COLOR":case "CUBEMAP":cam.color_attachment=tex;break;case "DEPTH":cam.depth_attachment=tex;break;case "SCREEN":cam.color_attachment=null;cam.depth_attachment=null;break;default:throw"Wrong attachment type: "+type;break}};exports.get_attachment=function(cam,type){switch(type){case "COLOR":case "CUBEMAP":return cam.color_attachment;
case "DEPTH":return cam.depth_attachment;case "SCREEN":return null;default:throw"Wrong attachment type: "+type;break}};exports.make_stereo=function(cam,type){if(!(cam.type==exports.TYPE_PERSP&&(type==exports.TYPE_STEREO_LEFT||type==exports.TYPE_STEREO_RIGHT||type==exports.TYPE_HMD_LEFT||type==exports.TYPE_HMD_RIGHT)))throw"make_stereo(): wrong camera type";cam.type=type;set_stereo_params(cam,STEREO_CONV_DIST,STEREO_EYE_DIST)};exports.set_stereo_params=set_stereo_params;function set_stereo_params(cam,
conv_dist,eye_dist){if(!(cam.type==exports.TYPE_STEREO_LEFT||cam.type==exports.TYPE_STEREO_RIGHT||cam.type==exports.TYPE_HMD_LEFT||cam.type==exports.TYPE_HMD_RIGHT))throw"set_stereo_params(): wrong camera type";if(cam.type==exports.TYPE_STEREO_LEFT||cam.type==exports.TYPE_STEREO_RIGHT)cam.stereo_conv_dist=conv_dist;cam.stereo_eye_dist=eye_dist;set_projection(cam,cam.aspect);if(m_scenes.check_active()){var active_scene=m_scenes.get_active();var sh_params=active_scene._render.shadow_params;if(sh_params){var cam_scene_data=
m_obj_util.get_scene_data(m_scenes.get_camera(active_scene),active_scene);var upd_cameras=cam_scene_data.cameras;for(var i=0;i<upd_cameras.length;i++)update_camera_shadows(upd_cameras[i],sh_params)}}}exports.get_camera_angles=get_camera_angles;function get_camera_angles(cam,dest){var quat=m_tsr.get_quat_view(cam.render.world_tsr);return get_camera_angles_from_quat(quat,dest)}exports.get_camera_angles_from_quat=get_camera_angles_from_quat;function get_camera_angles_from_quat(quat,dest){var y_world_cam=
m_util.quat_to_dir(quat,m_util.AXIS_Y,_vec3_tmp);var z_world_cam=m_util.quat_to_dir(quat,m_util.AXIS_Z,_vec3_tmp2);var base_theta=-Math.asin(y_world_cam[1]/m_vec3.length(y_world_cam));if(Math.abs(base_theta)>Math.PI/4)var phi_dir=m_vec3.scale(z_world_cam,-m_util.sign(base_theta),_vec3_tmp3);else var phi_dir=m_vec3.scale(y_world_cam,-m_util.sign(z_world_cam[1]),_vec3_tmp3);var base_phi=Math.atan(Math.abs(phi_dir[0]/phi_dir[2]));var theta=base_theta;if(z_world_cam[1]>0)theta=m_util.sign(theta)*Math.PI-
theta;var phi=base_phi;if(phi_dir[2]<0)phi=Math.PI-phi;if(phi_dir[0]<0)phi=2*Math.PI-phi;dest[0]=phi;dest[1]=theta;return dest}exports.get_camera_angles_char=function(cam,dest){get_camera_angles(cam,dest);dest[0]=m_util.angle_wrap_0_2pi(dest[0]+Math.PI);dest[1]*=-1;return dest};exports.set_frustum=set_frustum;function set_frustum(cam,v_fov_or_top,near,far,h_fov_or_right){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:cam.fov=v_fov_or_top;cam.aspect=
1;break;case exports.TYPE_ORTHO:cam.top=v_fov_or_top;cam.aspect=1;break;case exports.TYPE_PERSP_ASPECT:delete cam.fov;cam.fov=v_fov_or_top;cam.aspect=h_fov_or_right/v_fov_or_top;break;case exports.TYPE_ORTHO_ASPECT:cam.top=v_fov_or_top;cam.aspect=h_fov_or_right/v_fov_or_top;break;case exports.TYPE_HMD_LEFT:case exports.TYPE_HMD_RIGHT:break;default:m_print.error("set_frustum(): Unsupported camera type: "+cam.type);break}cam.near=near;cam.far=far}exports.set_frustum_asymmetric=set_frustum_asymmetric;
function set_frustum_asymmetric(cam,left,right,bottom,top,near,far){switch(cam.type){case exports.TYPE_ORTHO_ASYMMETRIC:cam.left=left;cam.right=right;cam.bottom=bottom;cam.top=top;cam.near=near;cam.far=far;break;default:m_print.error("set_frustum_asymmetric(): "+"Unsupported camera type: "+cam.type);break}}exports.get_move_style=get_move_style;function get_move_style(camobj){return camobj.render.move_style}exports.set_view=set_view;function set_view(cam,camobj){var trans=m_tsr.get_trans_view(camobj.render.world_tsr);
var quat=m_tsr.get_quat_view(camobj.render.world_tsr);var wm=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_mat4.rotateX(wm,-Math.PI/2,wm);m_mat4.invert(wm,cam.view_matrix);var x=cam.view_matrix[12];var y=cam.view_matrix[13];var z=cam.view_matrix[14];if(m_scenes.check_active()){var active_scene=m_scenes.get_active();var subs_stereo=m_scenes.get_subs(active_scene,"STEREO")}if(cam.type==exports.TYPE_STEREO_LEFT||subs_stereo&&subs_stereo.enable_hmd_stereo&&cam.type==exports.TYPE_HMD_LEFT)cam.view_matrix[12]+=
cam.stereo_eye_dist/2;else if(cam.type==exports.TYPE_STEREO_RIGHT||subs_stereo&&subs_stereo.enable_hmd_stereo&&cam.type==exports.TYPE_HMD_RIGHT)cam.view_matrix[12]-=cam.stereo_eye_dist/2;if(cam.reflection_plane){m_tsr.from_mat4(cam.view_matrix,cam.real_view_tsr);m_tsr.to_zup_view(cam.real_view_tsr,cam.real_view_zup_tsr);m_tsr.invert(cam.real_view_zup_tsr,cam.real_view_inv_zup_tsr);reflect_view_matrix(cam);reflect_proj_matrix(cam)}m_tsr.from_mat4(cam.view_matrix,cam.view_tsr);m_tsr.to_zup_view(cam.view_tsr,
cam.view_zup_tsr);m_tsr.invert(cam.view_zup_tsr,cam.view_inv_zup_tsr);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam);m_tsr.copy(camobj.render.world_tsr,cam.world_tsr)}function reflect_view_matrix(cam){var Nx=cam.reflection_plane[0];var Ny=cam.reflection_plane[1];var Nz=cam.reflection_plane[2];var D=cam.reflection_plane[3];var refl_mat=_mat4_tmp;refl_mat[0]=1-2*Nx*Nx;refl_mat[1]=-2*Nx*Ny;refl_mat[2]=-2*Nx*Nz;refl_mat[3]=0;refl_mat[4]=-2*Nx*Ny;refl_mat[5]=1-2*Ny*Ny;refl_mat[6]=-2*Ny*Nz;refl_mat[7]=
0;refl_mat[8]=-2*Nx*Nz;refl_mat[9]=-2*Ny*Nz;refl_mat[10]=1-2*Nz*Nz;refl_mat[11]=0;refl_mat[12]=-2*Nx*D;refl_mat[13]=-2*Ny*D;refl_mat[14]=-2*Nz*D;refl_mat[15]=1;m_mat4.multiply(cam.view_matrix,refl_mat,cam.view_matrix)}function reflect_proj_matrix(cam){set_projection(cam,cam.aspect,true);var plane=_vec4_tmp;var view_inv_transp_matrix=_mat4_tmp;m_mat4.invert(cam.view_matrix,view_inv_transp_matrix);m_mat4.transpose(view_inv_transp_matrix,view_inv_transp_matrix);m_vec4.transformMat4(cam.reflection_plane,
view_inv_transp_matrix,plane);var corner_point=_vec4_tmp2;corner_point[0]=(m_util.sign(plane[0])+cam.proj_matrix[8])/cam.proj_matrix[0];corner_point[1]=(m_util.sign(plane[1])+cam.proj_matrix[9])/cam.proj_matrix[5];corner_point[2]=-1;corner_point[3]=(1+cam.proj_matrix[10])/cam.proj_matrix[14];var dot=plane[0]*corner_point[0]+plane[1]*corner_point[1]+plane[2]*corner_point[2]+plane[3]*corner_point[3];m_vec4.scale(plane,2/dot,plane);cam.proj_matrix[2]=plane[0];cam.proj_matrix[6]=plane[1];cam.proj_matrix[10]=
plane[2]+1;cam.proj_matrix[14]=plane[3]}exports.set_view_eye_target_up=set_view_eye_target_up;function set_view_eye_target_up(cam,eye,target,up){m_mat4.lookAt(eye,target,up,cam.view_matrix);var active_scene=m_scenes.get_active();var subs_stereo=m_scenes.get_subs(active_scene,"STEREO");if(m_scenes.check_active()){var active_scene=m_scenes.get_active();var subs_stereo=m_scenes.get_subs(active_scene,"STEREO")}if(cam.type==exports.TYPE_STEREO_LEFT||subs_stereo&&subs_stereo.enable_hmd_stereo&&cam.type==
exports.TYPE_HMD_LEFT)cam.view_matrix[12]+=cam.stereo_eye_dist/2;else if(cam.type==exports.TYPE_STEREO_RIGHT||subs_stereo&&subs_stereo.enable_hmd_stereo&&cam.type==exports.TYPE_HMD_RIGHT)cam.view_matrix[12]-=cam.stereo_eye_dist/2;m_tsr.from_mat4(cam.view_matrix,cam.view_tsr);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam);m_tsr.set_trans(eye,cam.world_tsr)}exports.set_view_trans_quat=function(cam,trans,quat){var target=_vec3_tmp;target[0]=0;target[1]=-1;target[2]=0;m_vec3.transformQuat(target,
quat,target);target[0]+=trans[0];target[1]+=trans[1];target[2]+=trans[2];var up=_vec3_tmp2;up[0]=0;up[1]=0;up[2]=-1;m_vec3.transformQuat(up,quat,up);set_view_eye_target_up(cam,trans,target,up)};exports.set_look_at=set_look_at;function set_look_at(camobj,trans,look_at){var dest_vect=m_vec3.subtract(look_at,trans,_vec3_tmp);if(m_vec3.length(dest_vect)){m_vec3.normalize(dest_vect,dest_vect);var quat=m_util.rotation_to_stable(m_util.AXIS_MY,dest_vect,_quat4_tmp);m_trans.set_rotation(camobj,quat)}m_trans.set_translation(camobj,
trans)}exports.set_look_at_corrected=set_look_at_corrected;function set_look_at_corrected(camobj,trans,look_at){var render=camobj.render;var ups_down=is_upside_down(camobj);set_look_at(camobj,trans,look_at);if(ups_down){var inv_axis=m_vec3.copy(render.vertical_axis,_vec3_tmp);m_vec3.negate(inv_axis,inv_axis);m_cons.correct_up(camobj,inv_axis,true)}else m_cons.correct_up(camobj,render.vertical_axis,true)}exports.update_camera_transform=update_camera_transform;function update_camera_transform(obj,cam_scene_data){var render=
obj.render;var cameras=cam_scene_data.cameras;if(!cameras)throw"Wrong object";var shadow_cameras=cam_scene_data.shadow_cameras;for(var i=0;i<shadow_cameras.length;i++){var cam=shadow_cameras[i];m_vec3.copy(m_tsr.get_trans_view(render.world_tsr),cam.lod_eye)}for(var i=0;i<cameras.length;i++){var cam=cameras[i];set_view(cam,obj);m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes);if(cam.dof_object)if(cam.dof_on){var cam_loc=m_tsr.get_trans_view(render.world_tsr);var obj_loc=m_trans.get_translation(cam.dof_object,
_vec3_tmp);var dof_dist=m_vec3.dist(cam_loc,obj_loc);cam.dof_distance=dof_dist}}}exports.update_camera=function(obj){var render=obj.render;clamp_limits(obj);update_ortho_scale(obj);switch(render.move_style){case exports.MS_TARGET_CONTROLS:var trans=m_tsr.get_trans_view(render.world_tsr);var quat=m_tsr.get_quat_view(render.world_tsr);m_cons.rotate_to(trans,quat,render.pivot);for(var j=0;j<obj.scenes_data.length;j++){var cams=obj.scenes_data[j].cameras;for(var i=0;i<cams.length;i++){var cam=cams[i];
if(cam.type==exports.TYPE_STEREO_LEFT||cam.type==exports.TYPE_STEREO_RIGHT)set_stereo_params(cam,m_vec3.dist(trans,render.pivot),cam.stereo_eye_dist)}}m_cons.correct_up(obj,render.vertical_axis);break;case exports.MS_EYE_CONTROLS:if(!obj.constraint)m_cons.correct_up(obj,render.vertical_axis);break}update_camera_upside_down(obj)};exports.update_camera_upside_down=update_camera_upside_down;function update_camera_upside_down(camobj){var render=camobj.render;if(render.move_style==exports.MS_TARGET_CONTROLS)render.target_cam_upside_down=
is_upside_down(camobj)}function is_upside_down(camobj){var quat=m_tsr.get_quat_view(camobj.render.world_tsr);var z_world_cam=m_util.quat_to_dir(quat,m_util.AXIS_Z,_vec3_tmp);return z_world_cam[1]>0}exports.set_horizontal_rot_limits=set_horizontal_rot_limits;function set_horizontal_rot_limits(camobj,limits){var render=camobj.render;if(limits){render.horizontal_limits=render.horizontal_limits||{};render.horizontal_limits.left=limits.left;render.horizontal_limits.right=limits.right;render.horizontal_limits.left_local=
limits.left;render.horizontal_limits.right_local=limits.right;render.horizontal_limits.camera_space=Boolean(limits.camera_space);prepare_horizontal_limits(camobj)}else render.horizontal_limits=null}function prepare_horizontal_limits(camobj){var render=camobj.render;var limits=render.horizontal_limits;if(limits&&(render.move_style==exports.MS_EYE_CONTROLS||render.move_style==exports.MS_TARGET_CONTROLS)){var angles=get_camera_angles(camobj,_vec2_tmp);if(limits.camera_space){limits.left+=angles[0];limits.right+=
angles[0]}else{limits.left_local-=angles[0];limits.right_local-=angles[0]}limits.left=m_util.angle_wrap_0_2pi(limits.left);limits.right=m_util.angle_wrap_0_2pi(limits.right);limits.left_local=m_util.angle_wrap_0_2pi(limits.left_local);limits.right_local=m_util.angle_wrap_0_2pi(limits.right_local)}}exports.set_vertical_rot_limits=set_vertical_rot_limits;function set_vertical_rot_limits(camobj,limits){var render=camobj.render;if(limits){render.vertical_limits=render.vertical_limits||{};render.vertical_limits.down=
limits.down;render.vertical_limits.up=limits.up;render.vertical_limits.down_local=limits.down;render.vertical_limits.up_local=limits.up;render.vertical_limits.camera_space=Boolean(limits.camera_space);prepare_vertical_limits(camobj)}else render.vertical_limits=null}exports.hover_set_vertical_limits=hover_set_vertical_limits;function hover_set_vertical_limits(camobj,limits){var render=camobj.render;if(!limits){var angles=get_camera_angles(camobj,_vec2_tmp);limits={down:angles[1],up:angles[1]}}render.vertical_limits=
render.vertical_limits||{};render.vertical_limits.down=limits.down;render.vertical_limits.up=limits.up;prepare_vertical_limits(camobj);if(render.distance_limits&&render.vertical_limits)hover_camera_update_distance(camobj)}function prepare_vertical_limits(camobj){var render=camobj.render;var limits=render.vertical_limits;if(limits)switch(render.move_style){case exports.MS_EYE_CONTROLS:case exports.MS_TARGET_CONTROLS:var angles=get_camera_angles(camobj,_vec2_tmp);if(limits.camera_space){limits.up+=
angles[1];limits.down+=angles[1]}else{limits.up_local-=angles[1];limits.down_local-=angles[1]}limits.up=m_util.angle_wrap_periodic(limits.up,-Math.PI,Math.PI);limits.down=m_util.angle_wrap_periodic(limits.down,-Math.PI,Math.PI);limits.up_local=m_util.angle_wrap_periodic(limits.up_local,-Math.PI,Math.PI);limits.down_local=m_util.angle_wrap_periodic(limits.down_local,-Math.PI,Math.PI);break;case exports.MS_HOVER_CONTROLS:limits.up=m_util.angle_wrap_periodic(limits.up,-Math.PI,Math.PI);limits.down=m_util.angle_wrap_periodic(limits.down,
-Math.PI,Math.PI);limits.up=m_util.clamp(limits.up,-Math.PI/2,0);limits.down=m_util.clamp(limits.down,-Math.PI/2,0);break}}exports.hover_set_distance_limits=hover_set_distance_limits;function hover_set_distance_limits(camobj,limits){var render=camobj.render;if(!limits){var dist=m_trans.obj_point_distance(camobj,render.hover_pivot);limits={min:dist,max:dist}}render.distance_limits=render.distance_limits||{};render.distance_limits.min=limits.min;render.distance_limits.max=limits.max;if(render.distance_limits&&
render.vertical_limits)hover_camera_update_distance(camobj)}exports.set_distance_limits=set_distance_limits;function set_distance_limits(camobj,limits){var render=camobj.render;if(limits){render.distance_limits=render.distance_limits||{};render.distance_limits.min=limits.min;render.distance_limits.max=limits.max}else render.distance_limits=null}exports.set_pivot_limits=set_pivot_limits;function set_pivot_limits(camobj,limits){var render=camobj.render;if(limits){render.pivot_limits=render.pivot_limits||
{};render.pivot_limits.min_y=limits.min_y;render.pivot_limits.max_y=limits.max_y}else render.pivot_limits=null}exports.set_hor_trans_limits=set_hor_trans_limits;function set_hor_trans_limits(camobj,limits){var render=camobj.render;if(limits){render.hover_horiz_trans_limits=render.hover_horiz_trans_limits||{};render.hover_horiz_trans_limits.min=limits.min;render.hover_horiz_trans_limits.max=limits.max}else render.hover_horiz_trans_limits=null}exports.set_vert_trans_limits=set_vert_trans_limits;function set_vert_trans_limits(camobj,
limits){var render=camobj.render;if(limits){render.hover_vert_trans_limits=render.hover_vert_trans_limits||{};render.hover_vert_trans_limits.min=limits.min;render.hover_vert_trans_limits.max=limits.max}else render.hover_vert_trans_limits=null}exports.update_ortho_scale=update_ortho_scale;function update_ortho_scale(obj){var render=obj.render;if(!m_obj_util.is_camera(obj))return;var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var cams=scenes_data[j].cameras;if(cams[0].type===
exports.TYPE_ORTHO){switch(render.move_style){case exports.MS_TARGET_CONTROLS:var trans=m_tsr.get_trans_view(render.world_tsr);var dir_dist=m_vec3.dist(trans,render.pivot);var new_scale=dir_dist/render.init_dist*render.init_top;break;case exports.MS_HOVER_CONTROLS:var trans=m_tsr.get_trans_view(render.world_tsr);var dir_dist=m_vec3.distance(trans,render.hover_pivot);var new_scale=dir_dist/render.init_dist*render.init_top;break;default:var new_scale=cams[0].top;break}for(var i=0;i<cams.length;i++){var cam=
cams[i];cam.top=new_scale;set_projection(cam,cam.aspect)}update_camera_transform(obj,scenes_data[j])}}}function clamp_limits(obj){var render=obj.render;var ms=render.move_style;if(ms===exports.MS_TARGET_CONTROLS||ms===exports.MS_EYE_CONTROLS){if(render.horizontal_limits){var left=render.horizontal_limits.left;var right=render.horizontal_limits.right;var angles=get_camera_angles(obj,_vec2_tmp);if(ms==exports.MS_TARGET_CONTROLS)var ret_angle=m_util.calc_returning_angle(angles[0],left,right);else var ret_angle=
m_util.calc_returning_angle(angles[0],right,left);if(ret_angle)if(ms==exports.MS_TARGET_CONTROLS)rotate_target_camera(obj,ret_angle,0);else rotate_eye_camera(obj,ret_angle,0)}if(render.vertical_limits){var down=render.vertical_limits.down;var up=render.vertical_limits.up;var angles=get_camera_angles(obj,_vec2_tmp);if(ms==exports.MS_TARGET_CONTROLS)var ret_angle=m_util.calc_returning_angle(angles[1],up,down);else var ret_angle=m_util.calc_returning_angle(angles[1],down,up);if(ret_angle)if(ms==exports.MS_TARGET_CONTROLS)rotate_target_camera(obj,
0,ret_angle);else rotate_eye_camera(obj,0,ret_angle)}if(ms===exports.MS_TARGET_CONTROLS&&render.distance_limits)target_cam_clamp_distance(obj)}if(ms===exports.MS_TARGET_CONTROLS&&render.pivot_limits)target_clamp_pivot_limits(obj);if(ms===exports.MS_HOVER_CONTROLS){hover_cam_clamp_axis_limits(obj);hover_cam_clamp_rotation(obj)}}exports.rotate_eye_camera=rotate_eye_camera;function rotate_eye_camera(obj,phi,theta,phi_is_abs,theta_is_abs){var render=obj.render;var d_phi=phi;var d_theta=theta;if(phi_is_abs||
theta_is_abs){var curr_angles=get_camera_angles(obj,_vec2_tmp2);if(phi_is_abs)d_phi=phi-curr_angles[0];if(theta_is_abs)d_theta=theta-curr_angles[1]}if(d_phi||d_theta){var rot_quat=m_quat.identity(_quat4_tmp);if(d_phi){var quat_phi=m_quat.setAxisAngle(render.vertical_axis,d_phi,_quat4_tmp2);m_quat.multiply(rot_quat,quat_phi,rot_quat)}var cam_quat=m_tsr.get_quat_view(render.world_tsr);if(d_theta){var x_world_cam=m_util.quat_to_dir(cam_quat,m_util.AXIS_X,_vec3_tmp);var quat_theta=m_quat.setAxisAngle(x_world_cam,
d_theta,_quat4_tmp2);m_quat.normalize(quat_theta,quat_theta);m_quat.multiply(rot_quat,quat_theta,rot_quat)}m_quat.multiply(rot_quat,cam_quat,cam_quat)}}exports.rotate_target_camera=rotate_target_camera;function rotate_target_camera(obj,phi,theta,phi_is_abs,theta_is_abs){var render=obj.render;var d_phi=phi;var d_theta=theta;if(phi_is_abs||theta_is_abs){var curr_angles=get_camera_angles(obj,_vec2_tmp2);if(phi_is_abs)d_phi=phi-curr_angles[0];if(theta_is_abs)d_theta=theta-curr_angles[1]}camera_rotate_point_pivot(obj,
obj.render.pivot,d_phi,d_theta);var angles=get_camera_angles(obj,_vec2_tmp2);var dest_theta=m_util.angle_wrap_periodic(angles[1],-Math.PI,Math.PI);render.target_cam_upside_down=Math.abs(dest_theta)>Math.PI/2}exports.rotate_hover_camera=rotate_hover_camera;function rotate_hover_camera(obj,phi,theta,phi_is_abs,theta_is_abs){var render=obj.render;var d_phi=phi;var d_theta=theta;if(phi_is_abs||theta_is_abs){var curr_angles=get_camera_angles(obj,_vec2_tmp2);if(phi_is_abs)d_phi=phi-curr_angles[0];if(theta_is_abs)d_theta=
theta-curr_angles[1]}if(!render.enable_hover_hor_rotation)d_phi=0;camera_rotate_point_pivot(obj,render.hover_pivot,d_phi,d_theta);if(d_theta)hover_camera_update_distance(obj)}function camera_rotate_point_pivot(obj,pivot,d_phi,d_theta){var render=obj.render;if(d_phi||d_theta){var rot_quat=m_quat.identity(_quat4_tmp);if(d_phi){var quat_phi=m_quat.setAxisAngle(m_util.AXIS_Y,d_phi,_quat4_tmp2);m_quat.multiply(rot_quat,quat_phi,rot_quat)}var is_hover=is_hover_camera(obj);var cam_quat=m_tsr.get_quat_view(render.world_tsr);
if(d_theta){var x_world_cam=m_util.quat_to_dir(cam_quat,m_util.AXIS_X,_vec3_tmp);var quat_theta=m_quat.setAxisAngle(x_world_cam,d_theta,_quat4_tmp2);m_quat.normalize(quat_theta,quat_theta);m_quat.multiply(rot_quat,quat_theta,rot_quat)}var trans=m_tsr.get_trans_view(render.world_tsr);m_util.rotate_point_pivot(trans,pivot,rot_quat,trans);m_quat.multiply(rot_quat,cam_quat,cam_quat)}}function hover_camera_update_distance(obj){var render=obj.render;var elevation_angle=get_camera_angles(obj,_vec2_tmp)[1];
var dist=hover_cam_calc_distance_for_angle(obj,elevation_angle);var trans=m_tsr.get_trans_view(render.world_tsr);var quat=m_tsr.get_quat_view(render.world_tsr);var view_vector=m_util.quat_to_dir(quat,m_util.AXIS_MY,_vec3_tmp);m_vec3.normalize(view_vector,view_vector);m_vec3.scale(view_vector,dist,view_vector);m_vec3.subtract(render.hover_pivot,view_vector,trans)}function hover_cam_calc_distance_for_angle(obj,elevation_angle){var render=obj.render;var v_lims=render.vertical_limits;var d_lims=render.distance_limits;
if(v_lims.down-v_lims.up){var rot_factor=(v_lims.down-elevation_angle)/(v_lims.down-v_lims.up);rot_factor=Math.max(rot_factor,0)}else var rot_factor=0;return rot_factor*(d_lims.max-d_lims.min)+d_lims.min}function target_cam_clamp_distance(obj){var render=obj.render;var trans=m_tsr.get_trans_view(render.world_tsr);var dist_vector=m_vec3.subtract(trans,render.pivot,_vec3_tmp);var len=m_vec3.length(dist_vector);if(len>render.distance_limits.max){var scale=render.distance_limits.max/len;m_vec3.scale(dist_vector,
scale,dist_vector);m_vec3.add(render.pivot,dist_vector,trans)}else if(len<render.distance_limits.min){var quat=m_tsr.get_quat_view(render.world_tsr);var cam_view=m_util.quat_to_dir(quat,m_util.AXIS_MY,_vec3_tmp2);m_vec3.scale(cam_view,100*render.distance_limits.min,cam_view);m_vec3.add(dist_vector,cam_view,dist_vector);m_vec3.scale(dist_vector,-render.distance_limits.min/m_vec3.length(dist_vector),dist_vector);m_vec3.add(render.pivot,dist_vector,trans)}}function target_clamp_pivot_limits(obj){var render=
obj.render;var y_old=render.pivot[1];var y_new=m_util.clamp(render.pivot[1],render.pivot_limits.min_y,render.pivot_limits.max_y);if(y_new!=y_old){var correction_vec=m_vec3.set(0,y_new-y_old,0,_vec3_tmp);m_vec3.add(render.pivot,correction_vec,render.pivot);var trans=m_tsr.get_trans_view(render.world_tsr);m_vec3.add(trans,correction_vec,trans)}}function hover_cam_clamp_axis_limits(obj){var render=obj.render;if(render.hover_horiz_trans_limits){var horiz_delta=m_util.clamp(render.hover_pivot[0],render.hover_horiz_trans_limits.min,
render.hover_horiz_trans_limits.max)-render.hover_pivot[0];render.hover_pivot[0]+=horiz_delta;var trans=m_tsr.get_trans_view(render.world_tsr);trans[0]+=horiz_delta}if(render.hover_vert_trans_limits){var vert_delta=m_util.clamp(render.hover_pivot[2],render.hover_vert_trans_limits.min,render.hover_vert_trans_limits.max)-render.hover_pivot[2];render.hover_pivot[2]+=vert_delta;var trans=m_tsr.get_trans_view(render.world_tsr);trans[2]+=vert_delta}}function hover_cam_clamp_rotation(obj){var render=obj.render;
var curr_angle=get_camera_angles(obj,_vec2_tmp)[1];var ret_angle=m_util.calc_returning_angle(curr_angle,render.vertical_limits.up,render.vertical_limits.down);if(ret_angle)rotate_hover_camera(obj,0,ret_angle)}exports.is_float_aspect=function(cam){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_ORTHO:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:return true;default:return false}};exports.get_angular_diameter=function(cam){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:return m_util.deg_to_rad(cam.fov);
default:m_print.error("get_angular_diameter(): Unsupported camera type: "+cam.type);return 0}};exports.set_projection=set_projection;function set_projection(cam,aspect,keep_proj_view){switch(cam.type){case exports.TYPE_PERSP:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;case exports.TYPE_PERSP_ASPECT:m_mat4.perspective(m_util.deg_to_rad(cam.fov),cam.aspect,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_ORTHO:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;case exports.TYPE_ORTHO_ASPECT:var right=
cam.top*cam.aspect;m_mat4.ortho(-right,right,-cam.top,cam.top,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_ORTHO_ASYMMETRIC:m_mat4.ortho(cam.left,cam.right,cam.bottom,cam.top,cam.near,cam.far,cam.proj_matrix);break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:if(!aspect)throw"No aspect ratio";cam.aspect=aspect;set_projection_stereo(cam);break;case exports.TYPE_HMD_LEFT:case exports.TYPE_HMD_RIGHT:set_projection_hmd(cam,aspect);break;case exports.TYPE_NONE:return;default:throw"Wrong camera type: "+
cam.type;}if(!keep_proj_view){calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam)}}function set_projection_stereo(cam){var fov_tan=Math.tan(cam.fov*Math.PI/360);var top=cam.near*fov_tan;var bottom=-top;var a=cam.aspect*cam.stereo_conv_dist*fov_tan;if(cam.type==exports.TYPE_STEREO_LEFT){var b=a-cam.stereo_eye_dist/2;var c=a+cam.stereo_eye_dist/2}else{var b=a+cam.stereo_eye_dist/2;var c=a-cam.stereo_eye_dist/2}var left=-(cam.near/cam.stereo_conv_dist*b);var right=cam.near/cam.stereo_conv_dist*c;m_mat4.frustum(left,
right,bottom,top,cam.near,cam.far,cam.proj_matrix);cam.left=left;cam.right=right}function set_projection_hmd(cam,aspect){if(!m_scenes.check_active())return;var active_scene=m_scenes.get_active();var subs_stereo=m_scenes.get_subs(active_scene,"STEREO");if(subs_stereo&&subs_stereo.enable_hmd_stereo){var up_fov_tan=Math.tan(m_util.deg_to_rad(cam.hmd_fov[0])/2);var right_fov_tan=Math.tan(m_util.deg_to_rad(cam.hmd_fov[1])/2);var down_fov_tan=Math.tan(m_util.deg_to_rad(cam.hmd_fov[2])/2);var left_fov_tan=
Math.tan(m_util.deg_to_rad(cam.hmd_fov[3])/2);cam.top=cam.near*up_fov_tan;cam.right=cam.near*right_fov_tan;cam.bottom=-cam.near*down_fov_tan;cam.left=-cam.near*left_fov_tan;m_mat4.frustum(cam.left,cam.right,cam.bottom,cam.top,cam.near,cam.far,cam.proj_matrix)}else{if(!aspect)aspect=cam.aspect;m_mat4.perspective(m_util.deg_to_rad(cam.fov),aspect,cam.near,cam.far,cam.proj_matrix)}}exports.calc_sky_vp_inverse=calc_sky_vp_inverse;function calc_sky_vp_inverse(cam){m_mat4.copy(cam.view_matrix,cam.sky_vp_inv_matrix);
cam.sky_vp_inv_matrix[12]=0;cam.sky_vp_inv_matrix[13]=0;cam.sky_vp_inv_matrix[14]=0;cam.sky_vp_inv_matrix[15]=1;m_mat4.multiply(cam.proj_matrix,cam.sky_vp_inv_matrix,cam.sky_vp_inv_matrix);m_mat4.invert(cam.sky_vp_inv_matrix,cam.sky_vp_inv_matrix)}exports.calc_view_proj_inverse=calc_view_proj_inverse;function calc_view_proj_inverse(cam){m_mat4.copy(cam.view_matrix,cam.view_proj_matrix);m_mat4.multiply(cam.proj_matrix,cam.view_proj_matrix,cam.view_proj_matrix);m_mat4.invert(cam.view_proj_matrix,cam.view_proj_inv_matrix)}
exports.extract_frustum_corners=extract_frustum_corners;function extract_frustum_corners(cam,near,far,corners,is_world_space){if(!corners)var corners=new Float32Array(24);if(!near)var near=cam.near;if(!far)var far=cam.far;var top_near,right_near,left_near,bottom_near;var top_far,right_far,left_far,bottom_far;switch(cam.type){case exports.TYPE_NONE:throw"Extraction from NONE camera is not possible";break;case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:top_near=near*Math.tan(cam.fov*Math.PI/
360);bottom_near=-top_near;right_near=top_near*cam.aspect;left_near=-right_near;var coeff=far/near;top_far=top_near*coeff;bottom_far=-top_far;right_far=top_far*cam.aspect;left_far=-right_far;break;case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:var right=cam.top*cam.aspect;top_near=top_far=cam.top;right_near=right_far=right;bottom_near=bottom_far=-cam.top;left_near=left_far=-right;break;case exports.TYPE_ORTHO_ASYMMETRIC:top_near=top_far=cam.top;right_near=right_far=cam.right;bottom_near=bottom_far=
cam.bottom;left_near=left_far=cam.left;break;case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var coeff_near=near/cam.near;top_near=near*Math.tan(cam.fov*Math.PI/360);bottom_near=-top_near;right_near=cam.right*coeff_near;left_near=cam.left*coeff_near;var coeff_far=far/near;top_far=top_near*coeff_far;bottom_far=-top_far;right_far=right_near*coeff_far;left_far=left_near*coeff_far;break;case exports.TYPE_HMD_LEFT:case exports.TYPE_HMD_RIGHT:var coeff_near=near/cam.near;top_near=cam.top*coeff_near;
bottom_near=cam.bottom*coeff_near;right_near=cam.right*coeff_near;left_near=cam.left*coeff_near;var coeff_far=far/near;top_far=top_near*coeff_far;bottom_far=bottom_near*coeff_far;right_far=right_near*coeff_far;left_far=left_near*coeff_far;break;default:throw"Wrong camera type: "+cam.type;}corners[0]=left_near;corners[1]=bottom_near;corners[2]=-near;corners[3]=right_near;corners[4]=bottom_near;corners[5]=-near;corners[6]=right_near;corners[7]=top_near;corners[8]=-near;corners[9]=left_near;corners[10]=
top_near;corners[11]=-near;corners[12]=left_far;corners[13]=bottom_far;corners[14]=-far;corners[15]=left_far;corners[16]=top_far;corners[17]=-far;corners[18]=right_far;corners[19]=top_far;corners[20]=-far;corners[21]=right_far;corners[22]=bottom_far;corners[23]=-far;if(is_world_space){var view_inv=_mat4_tmp;m_mat4.invert(cam.view_matrix,view_inv);m_util.positions_multiply_matrix(corners,view_inv,corners,0)}return corners}exports.assign_boundings=function(camobj){var render=camobj.render;var bb=m_bounds.zero_bounding_box();
bb.min_x=-1;bb.max_x=1;bb.min_y=-1;bb.max_y=1;bb.min_z=-1;bb.max_z=1;render.bb_local=bb;var bs=m_bounds.create_bounding_sphere(1,[0,0,0]);render.bs_local=bs;render.bcap_local=m_bounds.create_bounding_capsule(1,bb);render.bcyl_local=m_bounds.create_bounding_cylinder(1,bb);render.bcon_local=m_bounds.create_bounding_cone(1,bb)};exports.is_static_camera=is_static_camera;function is_static_camera(obj){return m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_STATIC}exports.is_target_camera=
is_target_camera;function is_target_camera(obj){return m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_TARGET_CONTROLS}exports.is_eye_camera=function(obj){return m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_EYE_CONTROLS};exports.is_hover_camera=is_hover_camera;function is_hover_camera(obj){return m_obj_util.is_camera(obj)&&obj.render&&obj.render.move_style==exports.MS_HOVER_CONTROLS}exports.is_ortho_camera=function(obj){return m_obj_util.is_camera(obj)&&
obj.render&&obj.scenes_data[0].cameras[0].type==exports.TYPE_ORTHO};exports.update_camera_shadows=update_camera_shadows;function update_camera_shadows(cam,shadow_params){if(shadow_params.enable_csm)update_camera_csm(cam,shadow_params);else cam.pcf_blur_radii[0]=shadow_params.first_cascade_blur_radius}function update_camera_csm(cam,shadow_params){var N=shadow_params.csm_num;if(!cam.csm_centers)init_camera_csm(cam,shadow_params);for(var i=0;i<N;i++){var near=i==0?cam.near:csm_far_plane(shadow_params,
cam,i-1);var far=csm_far_plane(shadow_params,cam,i);var corners=extract_frustum_corners(cam,near,far,_frustum_corners_tmp);var mec=m_bounds.get_frustum_mec(corners);cam.csm_centers[i].set(mec.center);cam.csm_radii[i]=mec.radius;cam.csm_center_dists[i]=m_vec3.length(mec.center);var blur_rad_first=shadow_params.first_cascade_blur_radius;var blur_rad_last=shadow_params.last_cascade_blur_radius;cam.pcf_blur_radii[i]=get_cascade_interpolation(blur_rad_first,blur_rad_last,N,i)}}function init_camera_csm(cam,
shadow_params){var csm_num=shadow_params.csm_num;cam.csm_centers=new Array(csm_num);for(var i=0;i<csm_num;i++)cam.csm_centers[i]=new Float32Array(3);cam.csm_radii=new Float32Array(csm_num)}exports.csm_far_plane=csm_far_plane;function csm_far_plane(shadow_params,cam,csm_index){var N=shadow_params.csm_num;var border_first=m_util.clamp(shadow_params.csm_first_cascade_border,cam.near,cam.far);var border_last=m_util.clamp(shadow_params.csm_last_cascade_border,cam.near,cam.far);var far=get_cascade_interpolation(border_first,
border_last,N,csm_index);return m_util.clamp(far,cam.near,cam.far)}function get_cascade_interpolation(val_first,val_last,casc_count,casc_index){switch(casc_index){case 0:var val=val_first;break;case casc_count-1:var val=val_last;break;default:var val=val_first==0?0:val_first*Math.pow(val_last/val_first,casc_index/(casc_count-1));break}return val}exports.project_point=function(camobj,point,dest){var cam=camobj.scenes_data[0].cameras[0];switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:case exports.TYPE_HMD_LEFT:case exports.TYPE_HMD_RIGHT:var dir=
_vec4_tmp;dir.set(point);dir[3]=1;var vp=cam.view_proj_matrix;m_vec4.transformMat4(dir,vp,dir);var x=dir[0]/dir[3];var y=-dir[1]/dir[3];dest[0]=(x+1)/2*cam.width;dest[1]=(y+1)/2*cam.height;m_cont.viewport_to_canvas_coords(dest[0],dest[1],dest,cam);if(dest.length>2)dest[2]=(dir[2]/Math.abs(dir[3])+1)/2;return dest;default:m_print.error("Non-compatible camera");return dest}};exports.get_first_cam=function(camobj){return camobj.scenes_data[0].cameras[0]};exports.get_edge=function(cam,edge_type){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var top_1m=
Math.tan(m_util.deg_to_rad(cam.fov)/2);switch(edge_type){case "LEFT":return-top_1m*cam.aspect;case "RIGHT":return top_1m*cam.aspect;case "TOP":return top_1m;case "BOTTOM":return-top_1m}break;case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:switch(edge_type){case "LEFT":return-cam.top*cam.aspect;case "RIGHT":return cam.top*cam.aspect;case "TOP":return cam.top;case "BOTTOM":return-cam.top}break;case exports.TYPE_ORTHO_ASYMMETRIC:switch(edge_type){case "LEFT":return cam.left;case "RIGHT":return cam.right;
case "TOP":return cam.top;case "BOTTOM":return cam.bottom}break;case exports.TYPE_HMD_LEFT:case exports.TYPE_HMD_RIGHT:switch(edge_type){case "LEFT":return Math.tan(m_util.deg_to_rad(cam.hmd_fov[3])/2);case "RIGHT":return Math.tan(m_util.deg_to_rad(cam.hmd_fov[1])/2);case "TOP":return Math.tan(m_util.deg_to_rad(cam.hmd_fov[0])/2);case "BOTTOM":return Math.tan(m_util.deg_to_rad(cam.hmd_fov[2])/2)}break;default:m_util.panic("Unknown camera type");break}};exports.is_ortho=function(cam){switch(cam.type){case exports.TYPE_ORTHO:case exports.TYPE_ORTHO_ASPECT:case exports.TYPE_ORTHO_ASYMMETRIC:return true;
default:return false}};exports.get_fov=function(cam,is_horizontal){switch(cam.type){case exports.TYPE_PERSP:case exports.TYPE_PERSP_ASPECT:case exports.TYPE_STEREO_LEFT:case exports.TYPE_STEREO_RIGHT:var vfov=m_util.deg_to_rad(cam.fov);if(is_horizontal)return vfov*cam.aspect;else return vfov;default:return 0}};exports.set_trans_pivot=function(camobj,trans,pivot){var render=camobj.render;m_tsr.set_trans(trans,render.world_tsr);m_vec3.copy(pivot,render.pivot)};exports.set_hover_pivot=function(camobj,
coords){var render=camobj.render;var pivot_delta=m_vec3.subtract(coords,render.hover_pivot,_vec3_tmp);var old_trans=m_tsr.get_trans_view(render.world_tsr);var trans=m_vec3.add(pivot_delta,old_trans,pivot_delta);m_trans.set_translation(camobj,trans);m_vec3.copy(coords,render.hover_pivot)};exports.set_target_pivot=function(camobj,coords){var render=camobj.render;var pivot_delta=m_vec3.subtract(coords,render.pivot,_vec3_tmp);var old_trans=m_tsr.get_trans_view(render.world_tsr);var trans=m_vec3.add(pivot_delta,
old_trans,pivot_delta);m_trans.set_translation(camobj,trans);m_vec3.copy(coords,render.pivot)};exports.get_eye=get_eye;function get_eye(camobj,dest){if(!dest)var dest=new Float32Array(3);var trans=m_tsr.get_trans_view(camobj.render.world_tsr);m_vec3.copy(trans,dest);return dest}exports.set_move_style=function(camobj,move_style){camobj.render.move_style=move_style;camobj.render.horizontal_limits=null;camobj.render.vertical_limits=null;camobj.render.distance_limits=null;camobj.render.hover_horiz_trans_limits=
null;camobj.render.hover_vert_trans_limits=null;init_ortho_props(camobj);switch(move_style){case exports.MS_STATIC:case exports.MS_EYE_CONTROLS:break;case exports.MS_HOVER_CONTROLS:var pos=m_tsr.get_trans_view(camobj.render.world_tsr);var pivot=init_hover_pivot(camobj,0,_vec3_tmp2);setup_hover_model(camobj,pos,pivot,null,null,null,null,camobj.render.enable_hover_hor_rotation);break;case exports.MS_TARGET_CONTROLS:var cam_eye=get_eye(camobj,_vec3_tmp);var quat=m_tsr.get_quat_view(camobj.render.world_tsr);
var view_vector=m_util.quat_to_dir(quat,m_util.AXIS_MY,_vec3_tmp2);var pivot=m_vec3.scaleAndAdd(cam_eye,view_vector,PIVOT_DEFAULT_DIST,view_vector);m_vec3.copy(pivot,camobj.render.pivot);break}};exports.wipe_move_style=function(camobj){var render=camobj.render;render.move_style=0;m_vec3.set(0,0,0,render.pivot);m_vec3.set(0,0,0,render.hover_pivot);render.target_cam_upside_down=false;render.use_panning=false;render.horizontal_limits=null;render.vertical_limits=null;render.distance_limits=null;render.hover_horiz_trans_limits=
null;render.hover_vert_trans_limits=null;render.pivot_limits=null;render.enable_hover_hor_rotation=true};exports.set_eye_distance=function(cameras,eye_dist){for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==TYPE_STEREO_LEFT||cam.type==TYPE_STEREO_RIGHT||cam.type==TYPE_HMD_LEFT||cam.type==TYPE_HMD_RIGHT)set_stereo_params(cam,cam.stereo_conv_dist,eye_dist)}};exports.set_hmd_fov=function(camobj,hmd_left_fov,hmd_right_fov){var active_scene=m_scenes.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,
active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==TYPE_HMD_LEFT||cam.type==TYPE_HMD_RIGHT){if(cam.type==TYPE_HMD_LEFT)m_vec4.copy(hmd_left_fov,cam.hmd_fov);if(cam.type==TYPE_HMD_RIGHT)m_vec4.copy(hmd_right_fov,cam.hmd_fov);if(!cam.reflection_plane)set_projection(cam);calc_view_proj_inverse(cam);calc_sky_vp_inverse(cam)}}}};b4w.module["__lights"]=function(exports,require){var m_print=require("__print");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var _vec3_tmp=new Float32Array(3);var _vec3_empty=new Float32Array(3);function init_light(type){var light={name:"",type:type,use_diffuse:false,use_specular:false,prev_direction:new Float32Array(3),direction:new Float32Array(3),color:new Float32Array(3),color_intensity:new Float32Array(3),energy:0,default_energy:0,distance:0,spot_size:0,
spot_blend:0,falloff_type:"",generate_shadows:false,need_sun_fog_update:false,dynamic_intensity:false};light.use_diffuse=true;light.use_specular=true;light.energy=1;light.distance=25;light.falloff_type="INVERSE_SQUARE";return light}exports.lamp_to_light=function(bpy_obj,obj){var data=bpy_obj["data"];var light=obj.light=init_light(data["type"]);light.name=obj.name;light.use_diffuse=data["use_diffuse"];light.use_specular=data["use_specular"];var quat=m_tsr.get_quat_view(obj.render.world_tsr);var dir=
m_util.quat_to_dir(quat,m_util.AXIS_Y,_vec3_tmp);m_vec3.normalize(dir,dir);light.direction.set(dir);light.color[0]=data["color"][0];light.color[1]=data["color"][1];light.color[2]=data["color"][2];light.energy=light.default_energy=data["energy"];update_color_intensity(light);light.distance=data["distance"];if(light.type==="POINT"||light.type==="SPOT")light.distance=data["distance"];if(light.type==="SPOT"){light.spot_blend=data["spot_blend"];light.spot_size=data["spot_size"]}else if(light.type==="POINT")light.spot_size=
Math.PI/2;light.generate_shadows=data["b4w_generate_shadows"];light.dynamic_intensity=data["b4w_dynamic_intensity"]};exports.set_light_color=function(light,color){light.color[0]=color[0];light.color[1]=color[1];light.color[2]=color[2];update_color_intensity(light)};exports.set_light_spot_blend=function(light,spot_blend){light.spot_blend=spot_blend};exports.set_light_distance=function(light,distance){light.distance=distance};exports.set_light_spot_size=function(light,spot_size){light.spot_size=spot_size};
exports.set_light_energy=function(light,energy){light.energy=energy;update_color_intensity(light)};function update_color_intensity(light){m_vec3.scale(light.color,light.energy,light.color_intensity)}exports.update_light_transform=update_light_transform;function update_light_transform(obj){if(obj.type!="LAMP")throw"Wrong light object";var light=obj.light;if(!light)return;var quat=m_tsr.get_quat_view(obj.render.world_tsr);m_util.quat_to_dir(quat,m_util.AXIS_Y,light.direction);m_vec3.normalize(light.direction,
light.direction);if(light.type=="SUN"){var prev_angle=Math.acos(m_vec3.dot(light.prev_direction,m_util.VEC3_UNIT));var new_angle=Math.acos(m_vec3.dot(light.direction,m_util.VEC3_UNIT));var floor_prev=Math.floor(prev_angle/.025);var floor_new=Math.floor(new_angle/.025);if(floor_prev!=floor_new)light.need_sun_fog_update=true;else light.need_sun_fog_update=false}m_vec3.copy(light.direction,light.prev_direction)}};b4w.module["__scenes"]=function(exports,require){var m_batch=require("__batch");var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cfg=require("__config");var m_cont=require("__container");var m_debug=require("__debug");var m_geom=require("__geometry");var m_graph=require("__graph");var m_hud=require("__hud");var m_lights=require("__lights");var m_mat4=require("__mat4");var m_nodemat=require("__nodemat");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=
require("__physics");var m_prerender=require("__prerender");var m_primitives=require("__primitives");var m_print=require("__print");var m_render=require("__renderer");var m_scgraph=require("__scenegraph");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_tex=require("__textures");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var cfg_ani=m_cfg.animation;var cfg_ctx=m_cfg.context;var cfg_def=m_cfg.defaults;var cfg_out=
m_cfg.outlining;var cfg_scs=m_cfg.scenes;var FRAME_EPS=5;var VALID_OBJ_TYPES=["ARMATURE","CAMERA","EMPTY","LAMP","MESH","SPEAKER"];var VALID_OBJ_TYPES_SECONDARY=["ARMATURE","EMPTY","MESH","SPEAKER"];var OBJECT_SUBSCENE_TYPES=["GRASS_MAP","SHADOW_CAST","MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT_BLEND","COLOR_PICKING","COLOR_PICKING_XRAY","SHADOW_RECEIVE","OUTLINE_MASK","DEBUG_VIEW"];exports.OBJECT_SUBSCENE_TYPES=
OBJECT_SUBSCENE_TYPES;var LIGHT_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","GOD_RAYS","GOD_RAYS_COMBINE","SKY","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT_BLEND","LUMINANCE_TRUNCED","SHADOW_RECEIVE","SHADOW_CAST","COLOR_PICKING","COLOR_PICKING_XRAY","OUTLINE_MASK"];var FOG_SUBSCENE_TYPES=["MAIN_OPAQUE","SSAO","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT_BLEND"];
var TIME_SUBSCENE_TYPES=["SHADOW_CAST","MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT_BLEND","COLOR_PICKING","COLOR_PICKING_XRAY","SHADOW_RECEIVE","GOD_RAYS","OUTLINE_MASK","DEBUG_VIEW"];var MAIN_SUBSCENE_TYPES=["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_GLOW","MAIN_PLANE_REFLECT","MAIN_CUBE_REFLECT","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT_BLEND"];var SHORE_DIST_COMPAT=100;var MAX_BATCH_TEXTURES=8;var _main_scene=
null;var _active_scene=null;var _scenes=[];var _scenes_graph=null;var MAX_SHADER_VARYING_COUNT=10;var GRASS_MAP_MARGIN=1E-4;var MAX_SHADOW_CAST_BB_PROPORTION=2;var MAX_OPTIMAL_BB_ANGLE=Math.PI/2;var OPTIMAL_BB_COUNT=10;var SHADOW_MAP_EPSILON_XY=.005;var SHADOW_MAP_EPSILON_Z=.005;var _vec2_tmp=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _vec4_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);var _corners_cache=new Float32Array(24);var _corners_cache2=
new Float32Array(24);var _bb_tmp=m_bounds.zero_bounding_box();var _bb_tmp2=m_bounds.zero_bounding_box();var _shadow_cast_min_z=0;var _shadow_cast_max_z=-Infinity;exports.create_scene_render=function(){var render={};return render};exports.set_active=function(scene){_active_scene=scene;m_sfx.set_active_scene(scene)};exports.prepare_rendering=function(scene,scene_main){var render=scene._render;var queue=m_scgraph.create_rendering_queue(render.graph);if(scene==scene_main){setup_scene_dim(scene,m_cont.get_viewport_width(),
m_cont.get_viewport_height());for(var i=0;i<queue.length;i++)scene._render.queue.push(queue[i])}else{var tex0=scene._render_to_textures[0];var width=tex0._render.source_size;var height=tex0._render.source_size;setup_scene_dim(scene,width,height);for(var i=0;i<queue.length;i++)scene_main._render.queue.push(queue[i])}var subs_arr=subs_array(scene,TIME_SUBSCENE_TYPES);for(var j=0;j<subs_arr.length;j++)subs_arr[j].wind.set(render.wind);for(var i=0;i<render.queue.length;i++)if(render.queue[i].type=="SHADOW_CAST")m_render.draw(render.queue[i])};
exports.get_main=get_main;function get_main(){if(!_main_scene)_main_scene=find_main_scene(_scenes);return _main_scene}exports.find_main_scene=find_main_scene;function find_main_scene(scenes){for(var i=0;i<scenes.length;i++){var scene=scenes[i];if(!scene._render_to_textures||!scene._render_to_textures.length)return scene}return null}exports.get_active=get_active;function get_active(){if(!_active_scene)throw"No active scene available";return _active_scene}exports.check_active=check_active;function check_active(){if(_active_scene)return true;
else return false}exports.get_camera=function(scene){return scene._camera};exports.get_all_scenes=get_all_scenes;function get_all_scenes(){return _scenes}exports.get_rendered_scenes=function(){if(_scenes.length==1)return _scenes;for(var i=0;i<_scenes.length;i++){var graph=_scenes[i]._render.graph;m_graph.traverse(graph,function(node,attr){var subs=attr;for(var j=0;j<subs.bundles.length;j++){var textures=subs.bundles[j].batch.textures;var batch=null;for(var k=0;k<textures.length;k++)if(textures[k].source==
"SCENE"&&textures[k].source_id==_scenes[i]["name"]&&subs.type!="COPY"){m_print.error("Texture-scene loop detected. A scene is "+'rendered to texture "'+textures[k].name+'" yet this texture belongs '+"to the same scene.");var scene_node=m_graph.node_by_attr(_scenes_graph,_scenes[i]);batch=subs.bundles[j].batch;break}if(batch){batch.textures=[];batch.texture_names=[];m_batch.update_batch_material_error(batch,null);m_batch.update_shader(batch)}}})}var scenes=[];for(var i=0;i<_scenes.length;i++){var scene=
_scenes[i];if(scene._render_to_textures.length)continue;var node=m_graph.node_by_attr(_scenes_graph,scene);m_graph.enforce_acyclic(_scenes_graph,node);var graph=m_graph.subgraph_node_conn(_scenes_graph,node,m_graph.BACKWARD_DIR);graph=m_graph.topsort(graph);m_graph.traverse(graph,function(node,attr){scenes.push(attr)});break}return scenes};exports.append_scene=append_scene;function append_scene(bpy_scene,scene_objects,lamps,bpy_mesh_objs,bpy_empty_objs){bpy_scene._render_to_textures=bpy_scene._render_to_textures||
[];bpy_scene._nla=null;var render=bpy_scene._render;var cam_scene_data=m_obj_util.get_scene_data(bpy_scene._camera,bpy_scene);var cam_render=bpy_scene._camera.render;render.video_textures=[];var world=bpy_scene["world"];render.lamps_number=lamps.length;render.sun_exist=check_scenes_sun(lamps);render.sky_params=extract_sky_params(world,render.sun_exist);render.world_light_set=get_world_light_set(world,render.sky_params);render.world_fog_set=get_world_fog_set(world);render.anchor_visibility=check_anchor_visibility_objects(bpy_scene,
bpy_empty_objs);render.hmd_stereo_use=!bpy_scene._render_to_textures.length&&check_hmd_stereo_use(cam_scene_data);render.anaglyph_use=!bpy_scene._render_to_textures.length&&check_anaglyph_use(cam_scene_data);render.reflection_params=extract_reflections_params(bpy_scene,scene_objects,bpy_mesh_objs);render.bloom_params=extract_bloom_params(bpy_scene);render.mb_params=extract_mb_params(bpy_scene);render.cc_params=extract_cc_params(bpy_scene);render.god_rays_params=extract_god_rays_params(bpy_scene);
render.outline_params=extract_outline_params(bpy_scene);render.glow_params=extract_glow_params(bpy_scene);render.dof=cfg_def.dof&&(cam_render.dof_distance>0||cam_render.dof_object);render.motion_blur=cfg_def.motion_blur&&bpy_scene["b4w_enable_motion_blur"];render.compositing=cfg_def.compositing&&bpy_scene["b4w_enable_color_correction"];render.antialiasing=cfg_def.antialiasing&&cfg_def.msaa_samples==1&&bpy_scene["b4w_antialiasing_quality"]!="NONE";render.ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];
render.god_rays=cfg_def.god_rays&&bpy_scene["b4w_enable_god_rays"]&&render.sun_exist;render.depth_tex=cfg_def.depth_tex_available;render.glow_over_blend=bpy_scene["b4w_glow_settings"]["render_glow_over_blend"];render.ssao_params=extract_ssao_params(bpy_scene);var materials_params=get_material_params(bpy_mesh_objs);render.materials_params=materials_params;render.refractions=check_refraction(bpy_scene,materials_params);render.shadow_params=extract_shadow_params(bpy_scene,lamps,bpy_mesh_objs);render.water_params=
get_water_params(bpy_mesh_objs);render.xray=check_xray_materials(bpy_mesh_objs);render.soft_particles=check_soft_particles(bpy_mesh_objs);render.shore_smoothing=check_shore_smoothing(bpy_mesh_objs);render.dynamic_grass=check_dynamic_grass(bpy_scene,bpy_mesh_objs);render.color_picking=check_selectable_objects(bpy_scene,bpy_mesh_objs);render.outline=check_outlining_objects(bpy_scene,bpy_mesh_objs);render.glow_materials=check_glow_materials(bpy_scene,bpy_mesh_objs);switch(bpy_scene["b4w_reflection_quality"]){case "LOW":render.cubemap_refl_size=
cfg_scs.cube_reflect_low;render.plane_refl_size=cfg_scs.plane_reflect_low;break;case "MEDIUM":render.cubemap_refl_size=cfg_scs.cube_reflect_medium;render.plane_refl_size=cfg_scs.plane_reflect_medium;break;case "HIGH":render.cubemap_refl_size=cfg_scs.cube_reflect_high;render.plane_refl_size=cfg_scs.plane_reflect_high;break;default:render.cubemap_refl_size=cfg_scs.cube_reflect_low;render.plane_refl_size=cfg_scs.plane_reflect_low;break}if(m_cont.is_hidpi()){m_print.log("%cENABLE HIDPI MODE","color: #00a");
render.aa_quality="AA_QUALITY_LOW";render.resolution_factor=1;cfg_def.msaa_samples=1}else if(cfg_def.msaa_samples>1){m_print.log("%cENABLE MSAA RENDERING: "+cfg_def.msaa_samples+"x","color: #00a");render.resolution_factor=1}else{render.aa_quality="AA_QUALITY_"+bpy_scene["b4w_antialiasing_quality"];switch(bpy_scene["b4w_antialiasing_quality"]){case "LOW":if(render.antialiasing)render.resolution_factor=1;break;case "MEDIUM":if(cfg_def.quality==m_cfg.P_LOW||cfg_def.quality==m_cfg.P_HIGH)render.resolution_factor=
1;else if(cfg_def.quality==m_cfg.P_ULTRA)render.resolution_factor=1.33;break;case "HIGH":if(cfg_def.quality==m_cfg.P_LOW)render.resolution_factor=1;else if(cfg_def.quality==m_cfg.P_HIGH)render.resolution_factor=1.33;else if(cfg_def.quality==m_cfg.P_ULTRA)render.resolution_factor=2;break;case "NONE":if(cfg_def.quality==m_cfg.P_LOW||cfg_def.quality==m_cfg.P_HIGH)render.resolution_factor=1;else if(cfg_def.quality==m_cfg.P_ULTRA)render.resolution_factor=2;break}if(cfg_def.quality==m_cfg.P_CUSTOM)render.resolution_factor=
1}var rtt_sort_fun=function(bpy_tex1,bpy_tex2){return bpy_tex2._render.source_size-bpy_tex1._render.source_size};var rtt_sorted=bpy_scene._render_to_textures.sort(rtt_sort_fun);render.graph=m_scgraph.create_rendering_graph(render,cam_scene_data,cam_render,rtt_sorted);render.queue=[];render.need_shadow_update=false;render.need_grass_map_update=false;render.need_outline=false;render.wind=new Float32Array(3);_scenes.push(bpy_scene);if(!_scenes_graph)_scenes_graph=m_graph.create();m_graph.append_node_attr(_scenes_graph,
bpy_scene);for(var i=0;i<scene_objects.length;i++)m_obj_util.scene_data_set_active(scene_objects[i],true,bpy_scene);var canvas_container_elem=m_cont.get_container();m_cont.resize(canvas_container_elem.clientWidth,canvas_container_elem.clientHeight,true)}exports.append_scene_vtex=function(scene,textures,data_id){for(var i=0;i<textures.length;i++)if(textures[i]._render&&textures[i]._render.is_movie){textures[i]._render.vtex_data_id=data_id;scene._render.video_textures.push(textures[i])}};function extract_shadow_params(bpy_scene,
lamps,bpy_mesh_objs){if(!(cfg_def.depth_tex_available&&check_render_shadows(bpy_scene,lamps,bpy_mesh_objs)))return null;var shs=bpy_scene["b4w_shadow_settings"];var rshs={};if(shs["csm_resolution"]>cfg_def.max_texture_size){rshs.csm_resolution=cfg_def.max_texture_size;m_print.error("Shadow map texture has unsupported size. Changed to "+cfg_def.max_texture_size+".")}else rshs.csm_resolution=shs["csm_resolution"];var use_ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];var shadow_lamps=m_obj_util.get_shadow_lamps(lamps,
use_ssao);rshs.self_shadow_polygon_offset=shs["self_shadow_polygon_offset"];rshs.self_shadow_normal_offset=shs["self_shadow_normal_offset"];rshs.enable_csm=shs["b4w_enable_csm"]&&shadow_lamps.length==1;rshs.lamp_types=[];rshs.spot_sizes=[];rshs.distances=[];for(var i=0;i<shadow_lamps.length;i++){rshs.lamp_types.push(shadow_lamps[i].light.type);rshs.spot_sizes.push(shadow_lamps[i].light.spot_size);rshs.distances.push(shadow_lamps[i].light.distance);if((rshs.lamp_types[i]=="SPOT"||rshs.lamp_types[i]==
"POINT")&&rshs.enable_csm){m_print.warn("Generating shadows for SPOT "+"or POINT light. Disabling Cascaded Shadow Maps");rshs.enable_csm=false}}if(rshs.enable_csm){rshs.csm_num=shs["csm_num"];rshs.csm_first_cascade_border=shs["csm_first_cascade_border"];rshs.first_cascade_blur_radius=shs["first_cascade_blur_radius"];rshs.csm_last_cascade_border=shs["csm_last_cascade_border"];rshs.last_cascade_blur_radius=shs["last_cascade_blur_radius"];rshs.fade_last_cascade=shs["fade_last_cascade"];rshs.blend_between_cascades=
shs["blend_between_cascades"]}else{rshs.csm_num=1;rshs.csm_first_cascade_border=shs["csm_first_cascade_border"];rshs.first_cascade_blur_radius=shs["first_cascade_blur_radius"];rshs.csm_last_cascade_border=shs["csm_last_cascade_border"];rshs.last_cascade_blur_radius=shs["last_cascade_blur_radius"];rshs.fade_last_cascade=false;rshs.blend_between_cascades=false}return rshs}function check_render_shadows(bpy_scene,lamps,bpy_mesh_objs){if(lamps.length==0)return false;if(cfg_def.shadows)switch(bpy_scene["b4w_render_shadows"]){case "OFF":return false;
case "ON":return true;case "AUTO":}else return false;var has_casters=false;var has_receivers=false;var use_ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];if(lamps.length==0&&!use_ssao)return false;for(var i=0;i<bpy_mesh_objs.length;i++){var bpy_obj=bpy_mesh_objs[i];if(bpy_obj["b4w_shadow_cast"])has_casters=true;if(bpy_obj["b4w_shadow_receive"])has_receivers=true;if((use_ssao||has_casters)&&has_receivers)return true}return false}function check_scenes_sun(lamps){for(var i=0;i<lamps.length;i++)if(lamps[i].light.type==
"SUN")return true;return false}function check_shore_smoothing(bpy_objects){if(!cfg_def.shore_smoothing)return false;var mats=get_objs_materials(bpy_objects);for(var i=0;i<mats.length;i++){var mat=mats[i];if(mat["b4w_water"]&&mat["b4w_water_shore_smoothing"])return true}return false}function check_soft_particles(bpy_objects){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=psystems[j]["settings"];if(m_obj_util.check_obj_soft_particles_accessibility(bpy_objects[i],
pset))return true}}return false}function get_water_params(bpy_objects){var mats=get_objs_materials(bpy_objects);var water_params=[];for(var i=0;i<mats.length;i++){var mat=mats[i];if(mat["b4w_water"]){var wp={};for(var j=0;j<bpy_objects.length;j++){var bpy_obj=bpy_objects[j];var mesh=bpy_obj["data"];var mesh_mats=mesh["materials"];for(var k=0;k<mesh_mats.length;k++){var mesh_mat=mesh_mats[k];if(mesh_mat==mat)wp.water_level=bpy_obj["location"][1]}}wp.fog_color_density=mat["b4w_water_fog_color"].slice(0);
wp.fog_color_density.push(mat["b4w_water_fog_density"]);if(mat["b4w_water_dynamic"]){wp.dynamic=true;wp.waves_height=mat["b4w_waves_height"];wp.waves_length=mat["b4w_waves_length"];wp.dst_noise_scale0=mat["b4w_water_dst_noise_scale0"];wp.dst_noise_scale1=mat["b4w_water_dst_noise_scale1"];wp.dst_noise_freq0=mat["b4w_water_dst_noise_freq0"];wp.dst_noise_freq1=mat["b4w_water_dst_noise_freq1"];wp.dir_min_shore_fac=mat["b4w_water_dir_min_shore_fac"];wp.dir_freq=mat["b4w_water_dir_freq"];wp.dir_noise_scale=
mat["b4w_water_dir_noise_scale"];wp.dir_noise_freq=mat["b4w_water_dir_noise_freq"];wp.dir_min_noise_fac=mat["b4w_water_dir_min_noise_fac"];wp.dst_min_fac=mat["b4w_water_dst_min_fac"];wp.waves_hor_fac=mat["b4w_water_waves_hor_fac"]}else{wp.dynamic=false;wp.waves_height=0;wp.waves_length=0}wp.caustics=mat["b4w_water_enable_caust"];wp.caustic_scale=mat["b4w_water_caust_scale"];wp.caustic_brightness=mat["b4w_water_caust_brightness"];wp.caustic_speed=new Float32Array([.3,.7]);wp.shoremap_image=null;var texture_slots=
mat["texture_slots"];for(var j=0;j<texture_slots.length;j++){var texture=texture_slots[j]["texture"];if(texture["b4w_shore_dist_map"]===true&&texture["image"]["source"]=="FILE"){wp.shoremap_image=texture["image"];wp.shoremap_tex_size=texture["image"]["size"][0];wp.max_shore_dist=texture["b4w_max_shore_dist"];var shore_boundings=texture["b4w_shore_boundings"];wp.shoremap_center=[(shore_boundings[0]+shore_boundings[1])/2,(shore_boundings[2]+shore_boundings[3])/2];wp.shoremap_size=[shore_boundings[0]-
shore_boundings[1],shore_boundings[2]-shore_boundings[3]]}}water_params.push(wp)}}if(water_params.length>0){var wp=water_params[0];if(!wp.dynamic)for(var i=0;i<water_params.length;i++)if(water_params[i].dynamic)wp=water_params[i];return wp}else return null}function get_material_params(bpy_objects){var materials_properties_existance={refractions:false};var materials=get_objs_materials(bpy_objects);var get_nodes_properties=function(node_tree){if(!node_tree)return;var nodes=node_tree["nodes"];for(var j=
0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="GROUP"&&node["node_group"])get_nodes_properties(node["node_group"]["node_tree"]);if(node["type"]=="GROUP"&&node["node_tree_name"]=="B4W_REFRACTION")materials_properties_existance.refractions=true}};for(var i=0;i<materials.length;i++){var material=materials[i];if(material["b4w_refractive"])materials_properties_existance.refractions=true;if(material["node_tree"])get_nodes_properties(material["node_tree"])}return materials_properties_existance}
function check_anaglyph_use(cam_scene_data){if(cam_scene_data.cameras[0].type!=m_cam.TYPE_PERSP&&cfg_def.stereo=="ANAGLYPH"){m_print.warn("Anaglyph stereo is disabled for the non-perspective camera");return false}else return cfg_def.stereo=="ANAGLYPH"}function check_hmd_stereo_use(cam_scene_data){if(cam_scene_data.cameras[0].type!=m_cam.TYPE_PERSP&&cfg_def.stereo=="HMD"){m_print.warn("Head-mounted display stereo is disabled for the non-perspective camera");return false}else return cfg_def.stereo==
"HMD"}function extract_reflections_params(bpy_scene,scene_objects,bpy_mesh_objs){if(cfg_def.reflections)switch(bpy_scene["b4w_render_reflections"]){case "OFF":return false;case "ON":}else return false;var refl_plane_objs=[];var num_cube_refl=0;var has_blend_reflexible=false;for(var i=0;i<scene_objects.length;i++){var obj=scene_objects[i];if(obj.render.reflective&&obj.render.reflection_type=="CUBE")num_cube_refl++;if(obj.reflective_objs.length){var refl_plane_id=null;for(var j=0;j<refl_plane_objs.length;j++){var rp=
refl_plane_objs[j];if(rp==obj){refl_plane_id=j;break}}if(refl_plane_id==null)refl_plane_objs.push(obj)}}for(var i=0;i<bpy_mesh_objs.length;i++)if(check_blend_reflexible(bpy_mesh_objs[i]))has_blend_reflexible=true;return{refl_plane_objs:refl_plane_objs,num_cube_refl:num_cube_refl,cube_refl_subs:[],cube_refl_subs_blend:[],plane_refl_subs:[],plane_refl_subs_blend:[],has_blend_reflexible:has_blend_reflexible}}function check_blend_reflexible(obj){if(!obj["b4w_reflexible"])return;var mesh=obj["data"];var materials=
mesh["materials"];for(var i=0;i<materials.length;i++){var mat=materials[i];var gs=mat["game_settings"];var alpha_blend=gs["alpha_blend"];if(alpha_blend!="OPAQUE"&&alpha_blend!="CLIP")return true}return false}function extract_sky_params(world,sun_exist){var sky_settings=world["b4w_sky_settings"];var sky_params={};sky_params.render_sky=sky_settings["render_sky"];sky_params.procedural_skydome=sky_settings["procedural_skydome"]&&sun_exist;sky_params.use_as_environment_lighting=sky_settings["use_as_environment_lighting"];
sky_params.sky_color=sky_settings["color"];sky_params.rayleigh_brightness=sky_settings["rayleigh_brightness"];sky_params.mie_brightness=sky_settings["mie_brightness"];sky_params.spot_brightness=sky_settings["spot_brightness"];sky_params.scatter_strength=sky_settings["scatter_strength"];sky_params.rayleigh_strength=sky_settings["rayleigh_strength"];sky_params.mie_strength=sky_settings["mie_strength"];sky_params.rayleigh_collection_power=sky_settings["rayleigh_collection_power"];sky_params.mie_collection_power=
sky_settings["mie_collection_power"];sky_params.mie_distribution=sky_settings["mie_distribution"];sky_params.reflexible=sky_settings["reflexible"];sky_params.reflexible_only=sky_settings["reflexible_only"];if(!sun_exist&&sky_settings["procedural_skydome"])m_print.warn("There is no sun on the scene. "+"Procedural sky won't be rendered");return sky_params}function extract_ssao_params(bpy_scene){var ssao_params={};var ssao_settings=bpy_scene["b4w_ssao_settings"];ssao_params.radius_increase=ssao_settings["radius_increase"];
ssao_params.hemisphere=ssao_settings["hemisphere"];ssao_params.blur_depth=ssao_settings["blur_depth"];ssao_params.blur_discard_value=ssao_settings["blur_discard_value"];ssao_params.influence=ssao_settings["influence"];ssao_params.dist_factor=ssao_settings["dist_factor"];ssao_params.samples=ssao_settings["samples"];return ssao_params}function extract_bloom_params(bpy_scene){if(!(cfg_def.bloom&&bpy_scene["b4w_enable_bloom"]&&bpy_scene._render.sun_exist))return null;var bloom_params={};var bloom_settings=
bpy_scene["b4w_bloom_settings"];bloom_params.blur=bloom_settings["blur"];bloom_params.edge_lum=bloom_settings["edge_lum"];bloom_params.key=bloom_settings["key"];return bloom_params}function extract_mb_params(bpy_scene){var mb_params={};var mb_settings=bpy_scene["b4w_motion_blur_settings"];mb_params.mb_decay_threshold=mb_settings["motion_blur_decay_threshold"];mb_params.mb_factor=mb_settings["motion_blur_factor"];return mb_params}function extract_cc_params(bpy_scene){var cc_params={};var cc_settings=
bpy_scene["b4w_color_correction_settings"];cc_params.brightness=cc_settings["brightness"];cc_params.contrast=cc_settings["contrast"];cc_params.exposure=cc_settings["exposure"];cc_params.saturation=cc_settings["saturation"];return cc_params}function extract_god_rays_params(bpy_scene){var god_rays_params={};var god_rays_settings=bpy_scene["b4w_god_rays_settings"];god_rays_params.intensity=god_rays_settings["intensity"];god_rays_params.max_ray_length=god_rays_settings["max_ray_length"];god_rays_params.steps_per_pass=
god_rays_settings["steps_per_pass"];return god_rays_params}function extract_outline_params(bpy_scene){var outline_params={};outline_params.outline_color=bpy_scene["b4w_outline_color"];outline_params.outline_factor=bpy_scene["b4w_outline_factor"];return outline_params}function extract_glow_params(bpy_scene){var glow_params={};var glow_settings=bpy_scene["b4w_glow_settings"];glow_params.small_glow_mask_coeff=glow_settings["small_glow_mask_coeff"];glow_params.large_glow_mask_coeff=glow_settings["large_glow_mask_coeff"];
glow_params.small_glow_mask_width=glow_settings["small_glow_mask_width"];glow_params.large_glow_mask_width=glow_settings["large_glow_mask_width"];return glow_params}function get_world_light_set(world,sky_params){var wls=world["light_settings"];var wls_params={};wls_params.environment_energy=wls["environment_energy"];wls_params.use_environment_light=wls["use_environment_light"];wls_params.environment_color=wls["environment_color"];wls_params.horizon_color=world["horizon_color"].slice(0);wls_params.zenith_color=
world["zenith_color"].slice(0);wls_params.use_sky_paper=world["use_sky_paper"];wls_params.use_sky_blend=world["use_sky_blend"];wls_params.use_sky_real=world["use_sky_real"];wls_params.sky_texture_slot=null;wls_params.sky_texture_param=null;wls_params.environment_texture_slot=null;if(wls_params.use_environment_light&&wls_params.environment_color=="SKY_TEXTURE"&&!(sky_params.procedural_skydome&&sky_params.use_as_environment_lighting)){var tex_slot=null;for(var i=0;i<world["texture_slots"].length;i++)if(world["texture_slots"][i]["texture"]["b4w_use_as_environment_lighting"]){tex_slot=
world["texture_slots"][i];break}if(!tex_slot){m_print.warn("environment lighting is set to 'Sky Texture'"+", but there is no world texture with 'Sky Texture Usage' property set to 'ENVIRONMENT_LIGHTING'");wls_params.use_environment_light=false}else wls_params.environment_texture_slot=tex_slot}for(var i=0;i<world["texture_slots"].length;i++)if(world["texture_slots"][i]["texture"]["b4w_use_as_skydome"]){var sts=world["texture_slots"][i];wls_params.sky_texture_slot=sts;wls_params.sky_texture_param={blend_factor:sts["blend_factor"],
horizon_factor:sts["horizon_factor"],zenith_up_factor:sts["zenith_up_factor"],zenith_down_factor:sts["zenith_down_factor"],color:sts["color"],default_value:sts["default_value"],invert:sts["invert"],use_rgb_to_intensity:sts["use_rgb_to_intensity"],blend_type:sts["blend_type"],use_map_blend:sts["use_map_blend"],use_map_horizon:sts["use_map_horizon"],use_map_zenith_up:sts["use_map_zenith_up"],use_map_zenith_down:sts["use_map_zenith_down"]};break}return wls_params}function get_world_fog_set(world){var wfs=
world["fog_settings"];var wfs_params={};wfs_params.use_fog=wfs["use_fog"];wfs_params.intensity=wfs["intensity"];wfs_params.depth=wfs["depth"];wfs_params.start=wfs["start"];wfs_params.height=wfs["height"];wfs_params.falloff=wfs["falloff"];if(wfs["use_custom_color"])wfs_params.color=wfs["color"].slice(0);else wfs_params.color=world["horizon_color"].slice(0);var fog_color=wfs_params.color;var fog_dens=1/wfs_params.depth;wfs_params.fog_color_density=new Float32Array([fog_color[0],fog_color[1],fog_color[2],
fog_dens]);wfs_params.fog_params=new Float32Array([wfs_params.intensity,wfs_params.depth,wfs_params.start,wfs_params.height]);return wfs_params}function check_dynamic_grass(bpy_scene,bpy_objects){if(!cfg_def.dynamic_grass)return false;switch(bpy_scene["b4w_render_dynamic_grass"]){case "OFF":return false;case "ON":return true;case "AUTO":}var has_terrain=false;var has_dyn_grass=false;for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var materials=bpy_obj["data"]["materials"];for(var j=
0;j<materials.length;j++){var mat=materials[j];if(mat["b4w_terrain"])has_terrain=true}var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=psystems[j]["settings"];if(pset["type"]=="HAIR"&&pset["b4w_dynamic_grass"])has_dyn_grass=true}if(has_terrain&&has_dyn_grass)return true}return false}function check_selectable_objects(bpy_scene,bpy_objects){if(cfg_out.outlining_overview_mode)return true;if(cfg_def.enable_selectable)switch(bpy_scene["b4w_enable_object_selection"]){case "OFF":return false;
case "ON":return true;case "AUTO":for(var i=0;i<bpy_objects.length;i++)if(bpy_objects[i]._object.render.selectable)return true;return false}else return false}function check_outlining_objects(bpy_scene,bpy_objects){if(cfg_out.outlining_overview_mode)return true;if(cfg_def.enable_outlining)switch(bpy_scene["b4w_enable_outlining"]){case "OFF":return false;case "ON":return true;case "AUTO":for(var i=0;i<bpy_objects.length;i++)if(bpy_objects[i]._object.render.outlining)return true;return false}else return false}
function check_glow_materials(bpy_scene,bpy_objects){if(cfg_def.glow_materials)switch(bpy_scene["b4w_enable_glow_materials"]){case "OFF":return false;case "ON":return true;case "AUTO":for(var i=0;i<bpy_objects.length;i++){var materials=bpy_objects[i]["data"]["materials"];for(var j=0;j<materials.length;j++)if(m_nodemat.check_material_glow_output(materials[j]))return true}return false}else return false}function check_refraction(bpy_scene,mat_params){if(cfg_def.refractions)switch(bpy_scene["b4w_render_refractions"]){case "OFF":return false;
case "ON":return true;case "AUTO":return mat_params.refractions}else return false}function check_xray_materials(bpy_objects){for(var i=0;i<bpy_objects.length;i++){var materials=bpy_objects[i]["data"]["materials"];for(var j=0;j<materials.length;j++){var mat=materials[j];var gs=mat["game_settings"];var alpha_blend=gs["alpha_blend"];if(mat["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP")return true}}return false}function check_anchor_visibility_objects(bpy_scene,bpy_empty_objs){switch(bpy_scene["b4w_enable_anchors_visibility"]){case "OFF":return false;
case "ON":return true;case "AUTO":for(var i=0;i<bpy_empty_objs.length;i++){var obj=bpy_empty_objs[i]._object;if(obj.anchor&&obj.anchor.detect_visibility)return true}return false}}exports.get_graph=function(scene){return scene._render.graph};exports.generate_auxiliary_batches=function(graph){m_graph.traverse(graph,function(node,attr){var subs=attr;var batch=null;switch(subs.type){case "POSTPROCESSING":batch=m_batch.create_postprocessing_batch(subs.pp_effect);break;case "SSAO":batch=m_batch.create_ssao_batch(subs);
break;case "SSAO_BLUR":batch=m_batch.create_ssao_blur_batch(subs);break;case "DEPTH_PACK":batch=m_batch.create_depth_pack_batch();break;case "GOD_RAYS":var subs_input=m_scgraph.find_input(graph,subs,"RESOLVE")||m_scgraph.find_input(graph,subs,"DEBUG_VIEW")||m_scgraph.find_input(graph,subs,"MAIN_BLEND")||m_scgraph.find_input(graph,subs,"GOD_RAYS");var tex_input=subs_input.camera.color_attachment;var water=subs.water;var steps=subs.steps_per_pass;batch=m_batch.create_god_rays_batch(tex_input,subs.pack,
water,steps);break;case "GOD_RAYS_COMBINE":var subs_input=m_scgraph.find_input(graph,subs,"RESOLVE")||m_scgraph.find_input(graph,subs,"DEBUG_VIEW")||m_scgraph.find_input(graph,subs,"MAIN_BLEND");var subs_god_rays=m_scgraph.find_input(graph,subs,"GOD_RAYS");var tex_main=subs_input.camera.color_attachment;var tex_god_rays=subs_god_rays.camera.color_attachment;batch=m_batch.create_god_rays_combine_batch(tex_main,tex_god_rays);break;case "MOTION_BLUR":batch=m_batch.create_motion_blur_batch(subs.mb_decay_threshold);
break;case "DOF":batch=m_batch.create_dof_batch();var subs_pp1=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_pp2=m_scgraph.find_input(graph,subs_pp1,"POSTPROCESSING");m_scgraph.set_texel_size_mult(subs_pp1,subs.camera.dof_power);m_scgraph.set_texel_size_mult(subs_pp2,subs.camera.dof_power);break;case "OUTLINE":batch=m_batch.create_outline_batch();var subs_outline_blur_y=m_scgraph.find_input(graph,subs,"POSTPROCESSING");var subs_outline_blur_x=m_scgraph.find_input(graph,subs_outline_blur_y,
"POSTPROCESSING");var subs_outline_extend_y=m_scgraph.find_input(graph,subs_outline_blur_x,"POSTPROCESSING");var subs_outline_extend_x=m_scgraph.find_input(graph,subs_outline_extend_y,"POSTPROCESSING");m_scgraph.set_texel_size_mult(subs_outline_blur_x,subs.blur_texel_size_mult);m_scgraph.set_texel_size_mult(subs_outline_blur_y,subs.blur_texel_size_mult);m_scgraph.set_texel_size_mult(subs_outline_extend_x,subs.ext_texel_size_mult*subs.outline_factor);m_scgraph.set_texel_size_mult(subs_outline_extend_y,
subs.ext_texel_size_mult*subs.outline_factor);break;case "GLOW_COMBINE":batch=m_batch.create_glow_combine_batch();break;case "COMPOSITING":batch=m_batch.create_compositing_batch();break;case "ANTIALIASING":batch=m_batch.create_antialiasing_batch(subs);break;case "SMAA_RESOLVE":case "SMAA_EDGE_DETECTION":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_NEIGHBORHOOD_BLENDING":batch=m_batch.create_smaa_batch(subs.type);break;case "STEREO":batch=m_batch.create_stereo_batch(subs.subtype);break;case "SKY":batch=
m_batch.create_procedural_sky_batch();break;case "LUMINANCE":batch=m_batch.create_luminance_batch();break;case "AVERAGE_LUMINANCE":batch=m_batch.create_average_luminance_batch();break;case "LUMINANCE_TRUNCED":batch=m_batch.create_luminance_trunced_batch();break;case "BLOOM_BLUR":batch=m_batch.create_bloom_blur_batch();break;case "BLOOM":var subs_blur_y=m_scgraph.find_input(graph,subs,"BLOOM_BLUR");var subs_blur_x=m_scgraph.find_input(graph,subs_blur_y,"BLOOM_BLUR");m_scgraph.set_texel_size_mult(subs_blur_y,
subs.bloom_blur);m_scgraph.set_texel_size_mult(subs_blur_x,subs.bloom_blur);batch=m_batch.create_bloom_combine_batch();break;case "VELOCITY":batch=m_batch.create_velocity_batch();break;case "ANCHOR_VISIBILITY":batch=m_batch.create_anchor_visibility_batch();break;case "PERFORMANCE":batch=m_batch.create_performance_batch();break}if(batch){var rb=init_bundle(m_obj_util.create_render("NONE"),batch);validate_batch(batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}})};
function connect_textures(graph,subs,batch){var id=m_graph.node_by_attr(graph,subs);m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;var subs_in=attr_in;if(!slink.active)return;switch(slink.from){case "COLOR":case "CUBEMAP":var tex=subs_in.camera.color_attachment;break;case "DEPTH":var tex=subs_in.camera.depth_attachment;break;case "SCREEN":var tex=null;break;case "MAIN_CUBE_REFLECT":return;default:throw"Wrong slink";}switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":case "OFFSCREEN":case "RESOLVE":case "COPY":case "u_cube_reflection":case "u_plane_reflection":break;
default:if(!tex)throw"Connection of SCREEN is forbidden";if(tex.w_renderbuffer)throw"Batch texture can't use renderbuffer";if(m_shaders.check_uniform(batch.shader,slink.to))m_batch.append_texture(batch,tex,slink.to);break}});for(var i=0;i<subs.slinks_internal.length;i++){var slink=subs.slinks_internal[i];var tex=subs.textures_internal[i];switch(slink.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":case "OFFSCREEN":case "RESOLVE":case "COPY":break;default:if(tex.w_renderbuffer)throw"Batch texture can't use renderbuffer";
if(m_shaders.check_uniform(batch.shader,slink.to))m_batch.append_texture(batch,tex,slink.to);break}}}exports.append_object=function(scene,obj,copy){var type=obj.type;switch(type){case "MESH":case "LINE":case "WORLD":var graph=scene._render.graph;var obj_render=obj.render;if(!m_scgraph.find_subs(graph,"SHADOW_CAST")&&obj_render.shadow_receive)obj_render.shadow_receive=false;var subs_arr=subs_array(scene,OBJECT_SUBSCENE_TYPES);if(copy&&obj.use_obj_physics)m_phy.append_object(obj,scene);for(var i=0;i<
subs_arr.length;i++){var subs=subs_arr[i];add_object_sub(subs,obj,graph,scene,copy)}break;case "LAMP":update_lamp_scene(obj,scene);m_obj.sort_lamps(scene);break;default:break}m_obj_util.scene_data_set_active(obj,true,scene)};function init_bundle(render,batch){return{do_render:true,do_render_cube:[true,true,true,true,true,true],obj_render:render,batch:batch}}function add_object_sub(subs,obj,graph,bpy_scene,copy){switch(subs.type){case "MAIN_OPAQUE":add_object_subs_main(subs,obj,graph,"OPAQUE",bpy_scene,
copy);break;case "MAIN_BLEND":add_object_subs_main(subs,obj,graph,"BLEND",bpy_scene,copy);break;case "MAIN_XRAY":add_object_subs_main(subs,obj,graph,"XRAY",bpy_scene,copy);break;case "MAIN_GLOW":add_object_subs_main(subs,obj,graph,"GLOW",bpy_scene,copy);break;case "MAIN_PLANE_REFLECT":case "MAIN_CUBE_REFLECT":add_object_subs_reflect(subs,obj,graph,false,bpy_scene,copy);break;case "MAIN_PLANE_REFLECT_BLEND":case "MAIN_CUBE_REFLECT_BLEND":add_object_subs_reflect(subs,obj,graph,true,bpy_scene,copy);
break;case "SHADOW_RECEIVE":add_object_subs_shadow_receive(subs,obj,graph,bpy_scene,copy);break;case "SHADOW_CAST":add_object_subs_shadow(subs,obj,graph,bpy_scene,copy);break;case "COLOR_PICKING":add_object_subs_color_picking(subs,obj,graph,bpy_scene,copy);break;case "COLOR_PICKING_XRAY":add_object_subs_color_picking(subs,obj,graph,bpy_scene,copy);break;case "OUTLINE_MASK":add_object_subs_outline_mask(subs,obj,graph,bpy_scene,copy);break;case "GRASS_MAP":add_object_subs_grass_map(subs,obj,bpy_scene,
copy);break;case "DEBUG_VIEW":add_object_subs_debug_view(subs,obj,graph,bpy_scene,copy);break;default:break}}function add_object_subs_main(subs,obj,graph,main_type,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.shadow_cast_only||batch.reflexible_only)continue;if(batch.type!="MAIN"&&batch.type!="NODES_GLOW"&&batch.type!="PARTICLES"&&batch.type!="LINE")continue;if(!(batch.subtype==
"OPAQUE"&&main_type=="OPAQUE"||batch.subtype=="BLEND"&&main_type=="BLEND"||batch.subtype=="XRAY"&&main_type=="XRAY"||batch.type=="NODES_GLOW"&&main_type=="GLOW"))continue;if(!copy){update_batch_subs(batch,subs,obj,graph,main_type,scene);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}var sort_fun=function(a,b){if(a==b)return 0;return a>b?1:-1};var sort_fun_double=function(a,
b){if(a.batch&&b.batch)return-sort_fun(a.batch.blend,b.batch.blend)||-sort_fun(a.batch.alpha_clip,b.batch.alpha_clip)||sort_fun(a.batch.offset_z,b.batch.offset_z);else return 0};subs.bundles.sort(sort_fun_double)}function update_batch_subs(batch,subs,obj,graph,main_type,bpy_scene){var obj_render=obj.render;var sc_render=bpy_scene._render;var scene_data=m_obj_util.get_scene_data(obj,bpy_scene);var shadow_usage="NO_SHADOWS";var subs_cast_arr=subs_array(bpy_scene,["SHADOW_CAST"]);if(subs_cast_arr.length&&
batch.shadow_receive){switch(main_type){case "OPAQUE":shadow_usage="SHADOW_MAPPING_OPAQUE";break;case "BLEND":case "XRAY":shadow_usage="SHADOW_MAPPING_BLEND";break;case "COLOR_ID":case "REFLECT":case "GLOW":shadow_usage="NO_SHADOWS";break;case "SHADOW":shadow_usage="SHADOW_MASK_GENERATION";break;default:throw"Wrong subscene type";}for(var i=0;i<subs_cast_arr.length;i++)m_batch.assign_shadow_receive_dirs(batch,bpy_scene._render.shadow_params,subs_cast_arr[i])}var shaders_info=batch.shaders_info;m_shaders.set_directive(shaders_info,
"SHADOW_USAGE",shadow_usage);if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}if((batch.type=="SHADOW"||main_type=="COLOR_ID")&&!batch.has_nodes)return;var num_lights=subs.num_lights;m_shaders.set_directive(shaders_info,"NUM_LIGHTS",num_lights);var num_lfac=num_lights%2==0?num_lights/2:Math.floor(num_lights/2)+1;m_shaders.set_directive(shaders_info,"NUM_LFACTORS",num_lfac);m_shaders.set_directive(shaders_info,
"REFLECTION_PASS",0);m_shaders.set_directive(shaders_info,"SSAO_ONLY",0);m_shaders.set_directive(shaders_info,"INVERT_FRONTFACING",0);var wp=sc_render.water_params;if(wp&&subs.water_fog_color_density)m_shaders.set_directive(shaders_info,"WATER_EFFECTS",1);else m_shaders.set_directive(shaders_info,"WATER_EFFECTS",0);if(wp&&subs.caustics&&obj_render.caustics){m_shaders.set_directive(shaders_info,"CAUSTICS",1);var sh_params=bpy_scene._render.shadow_params;if(sh_params){var ltypes=sh_params.lamp_types;
var sun_num=0;for(var i=0;i<ltypes.length;i++)if(ltypes[i]=="SUN")sun_num=i;m_shaders.set_directive(shaders_info,"SUN_NUM",sun_num)}m_shaders.set_directive(shaders_info,"CAUST_SCALE",m_shaders.glsl_value(subs.caust_scale));m_shaders.set_directive(shaders_info,"CAUST_SPEED",m_shaders.glsl_value(subs.caust_speed,2));m_shaders.set_directive(shaders_info,"CAUST_BRIGHT",m_shaders.glsl_value(subs.caust_brightness))}else m_shaders.set_directive(shaders_info,"CAUSTICS",0);if(wp){m_shaders.set_directive(shaders_info,
"WAVES_HEIGHT",m_shaders.glsl_value(wp.waves_height));m_shaders.set_directive(shaders_info,"WAVES_LENGTH",m_shaders.glsl_value(wp.waves_length));m_shaders.set_directive(shaders_info,"WATER_LEVEL",m_shaders.glsl_value(wp.water_level))}var subs_cube_refl=scene_data.cube_refl_subs;var subs_plane_refl=scene_data.plane_refl_subs;if(batch.texture_names.indexOf("u_mirrormap")!==-1)m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_MIRRORMAP");else if(batch.reflective&&subs_cube_refl){var tex=subs_cube_refl.camera.color_attachment;
m_batch.append_texture(batch,tex,"u_cube_reflection");m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_CUBE")}else if(batch.reflective&&subs_plane_refl)for(var i=0;i<subs_plane_refl.length;i++){var tex=subs_plane_refl[i].camera.color_attachment;m_batch.append_texture(batch,tex,"u_plane_reflection");m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_PLANE")}else m_shaders.set_directive(shaders_info,"REFLECTION_TYPE","REFL_NONE");var subs_sky=m_scgraph.find_subs(graph,"SKY");if(subs_sky)if(batch.procedural_sky){var tex=
subs_sky.camera.color_attachment;m_batch.append_texture(batch,tex,"u_sky")}else if(cfg_def.procedural_fog){batch.cube_fog=subs_sky.cube_fog;m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",1)}else m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",0);else m_shaders.set_directive(shaders_info,"PROCEDURAL_FOG",0);var wls=bpy_scene._render.world_light_set;if(wls.use_environment_light){m_shaders.set_directive(shaders_info,"USE_ENVIRONMENT_LIGHT",1);if(wls.environment_color=="SKY_TEXTURE"){var tex=
null;if(wls.environment_texture_slot)tex=m_tex.get_batch_texture(wls.environment_texture_slot,false);else tex=subs_sky.camera.color_attachment;m_shaders.set_directive(shaders_info,"SKY_TEXTURE",1);m_batch.append_texture(batch,tex,"u_sky_texture")}else if(wls.environment_color=="SKY_COLOR")m_shaders.set_directive(shaders_info,"SKY_COLOR",1)}var wfs=bpy_scene._render.world_fog_set;if(wfs.use_fog){m_shaders.set_directive(shaders_info,"USE_FOG",1);m_shaders.set_directive(shaders_info,"FOG_TYPE",wfs.falloff)}if(batch.refractive&&
batch.blend){if(cfg_def.depth_tex_available)m_shaders.set_directive(shaders_info,"USE_REFRACTION_CORRECTION",1);if(batch.type=="MAIN"&&batch.has_nodes||batch.type=="NODES_GLOW"){m_shaders.set_directive(shaders_info,"REFRACTIVE",1);if(bpy_scene._render.refractions)m_shaders.set_directive(shaders_info,"USE_REFRACTION",1);else m_shaders.set_directive(shaders_info,"USE_REFRACTION",0)}else if(bpy_scene._render.refractions)m_shaders.set_directive(shaders_info,"REFRACTIVE",1);else m_shaders.set_directive(shaders_info,
"REFRACTIVE",0)}else{m_shaders.set_directive(shaders_info,"REFRACTIVE",0);m_shaders.set_directive(shaders_info,"USE_REFRACTION",0);m_shaders.set_directive(shaders_info,"USE_REFRACTION_CORRECTION",0)}if(batch.water){if(cfg_def.shore_smoothing&&batch.water_shore_smoothing&&m_scgraph.find_subs(graph,"DEPTH_PACK"))m_shaders.set_directive(shaders_info,"SHORE_SMOOTHING",1);else m_shaders.set_directive(shaders_info,"SHORE_SMOOTHING",0);if(batch.water_dynamic&&wp&&wp.waves_height)m_shaders.set_directive(shaders_info,
"DYNAMIC",1);else m_shaders.set_directive(shaders_info,"DYNAMIC",0)}if(batch.type=="PARTICLES"){m_shaders.set_directive(shaders_info,"SIZE_RAMP_LENGTH",batch.particles_data.size_ramp_length);m_shaders.set_directive(shaders_info,"COLOR_RAMP_LENGTH",batch.particles_data.color_ramp_length)}if(!batch.forked_batch){var textures=batch.textures;for(var j=0;j<textures.length;j++){var tex=textures[j];if(tex.source=="SCENE")for(var k=0;k<_scenes.length;k++){var scene_k=_scenes[k];var rtt=_scenes[k]._render_to_textures;
for(var l=0;l<rtt.length;l++)if(rtt[l]._render==tex)m_graph.append_edge_attr(_scenes_graph,scene_k,bpy_scene,null)}}}}function validate_batch(batch){var shader=batch.shader;var attributes=shader.attributes;var pointers=batch.bufs_data.pointers;for(var attr in attributes){var p=pointers[attr];if(!p)m_util.panic('missing data for "'+attr+'" attribute')}validate_batch_varyings(batch)}function validate_batch_varyings(batch){if(batch.type=="MAIN"||batch.type=="NODES_GLOW"){var vcount=m_shaders.get_varyings_count(batch.shader.vshader);
if(vcount>MAX_SHADER_VARYING_COUNT){if(batch.type=="MAIN")m_print.warn("Varying limit exceeded for main shader - "+vcount+', materials: "'+batch.material_names.join(", ")+'"');if(batch.type=="MAIN"&&batch.has_nodes||batch.type=="NODES_GLOW"){var used_uv=0;var used_vc=0;if(batch.uv_maps_usage)used_uv=m_util.get_dict_length(batch.uv_maps_usage);if(batch.vertex_colors_usage)used_vc=m_util.get_dict_length(batch.vertex_colors_usage);m_print.warn("Varying limit exceeded for node shader - "+vcount+", uv: "+
used_uv+", vc: "+used_vc+', materials: "'+batch.material_names.join(", ")+'"')}}}}function check_batch_textures_number(batch){if(batch.textures.length>MAX_BATCH_TEXTURES)m_print.warn(batch.type,"too many textures used - "+batch.textures.length+" (max "+MAX_BATCH_TEXTURES+'), materials "'+batch.material_names.join(", ")+'"')}function prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render){batch.grass_map_dim=subs_grass_map.grass_map_dim;var low=subs_grass_map.grass_map_dim[0];var high=subs_grass_map.grass_map_dim[1];
var size=subs_grass_map.grass_map_dim[2];var bb=obj_render.bb_local;var bb_max_size=Math.max(bb.max_x-bb.min_x,bb.max_z-bb.min_z);if(size==0)size=bb_max_size;else size=Math.max(size,bb_max_size);subs_grass_map.grass_map_dim[2]=size;var cam=subs_grass_map.camera;m_cam.set_frustum(cam,size/2,-high,-low,size/2);m_cam.set_projection(cam);var bsize=batch.grass_size||0;if(bsize==0)bsize=bb_max_size;else bsize=Math.max(bsize,bb_max_size);batch.grass_size=bsize}function has_batch(subscene,batch){var sbundles=
subscene.bundles;for(var i=0;i<sbundles.length;i++){var sbundle=sbundles[i];var sbatch=sbundle.batch;if(sbatch&&sbatch.id==batch.id)return true}return false}function debug_report_order(bundles){var names=[];for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch)names.push(batch.name.split("*")[2]);else names.push("NULL")}m_print.log(names)}function add_object_subs_shadow_receive(subs,obj,graph,scene,copy){var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;
for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="SHADOW"||batch.subtype!="RECEIVE")continue;if(!copy){update_batch_subs(batch,subs,obj,graph,"SHADOW",scene);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj.render,batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}}function add_object_subs_shadow(subs,obj,graph,scene,copy){var update_needed=false;var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,
scene);var batches=sc_data.batches;var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="SHADOW")continue;if(batch.subtype!="CAST")continue;update_needed=true;if(!copy){var num_lights=subs.num_lights;m_batch.set_batch_directive(batch,"NUM_LIGHTS",num_lights);var num_lfac=num_lights%2==0?num_lights/2:Math.floor(num_lights/2)+1;m_batch.set_batch_directive(batch,"NUM_LFACTORS",num_lfac);m_shaders.set_directive(batch.shaders_info,
"SHADOW_USAGE","SHADOW_CASTING");if(batch.dynamic_grass&&subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render);m_batch.set_batch_directive(batch,"SHADOW_TEX_RES",m_shaders.glsl_value(scene._render.shadow_params.csm_resolution));m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}if(update_needed){var sh_params=scene._render.shadow_params;var subs_main=m_scgraph.find_subs(graph,"MAIN_OPAQUE");update_subs_shadow(subs,scene,
subs_main.camera,subs.bundles,sh_params,true)}}function add_object_subs_reflect(subs,obj,graph,is_blend_subs,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="MAIN"&&batch.type!="PARTICLES"&&batch.type!="LINE")continue;if(batch.subtype!="REFLECT")continue;if(batch.blend!=is_blend_subs)continue;if(subs.type=="MAIN_PLANE_REFLECT"||subs.type=="MAIN_PLANE_REFLECT_BLEND"){var refl_id=
get_plane_refl_id_by_subs(scene,subs);if(refl_id==obj_render.plane_reflection_id)continue}else{var refl_id=get_cube_refl_id_by_subs(scene,subs);if(refl_id==obj_render.cube_reflection_id)continue}if(!copy){update_batch_subs(batch,subs,obj,graph,"REFLECT",scene);var shaders_info=batch.shaders_info;m_shaders.set_directive(shaders_info,"WATER_EFFECTS",0);m_shaders.set_directive(shaders_info,"REFLECTION_PASS",1);m_shaders.set_directive(shaders_info,"TEXTURE_NORM",0);if(subs.type=="MAIN_PLANE_REFLECT")m_shaders.set_directive(shaders_info,
"INVERT_FRONTFACING",1);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}}exports.schedule_shadow_update=schedule_shadow_update;function schedule_shadow_update(bpy_scene){bpy_scene._render.need_shadow_update=true}function update_shadow_subscenes(bpy_scene){reset_shadow_cam_vm(bpy_scene);var subs_main=get_subs(bpy_scene,"MAIN_OPAQUE");var graph=bpy_scene._render.graph;var recalc_z_bounds=true;var sh_params=bpy_scene._render.shadow_params;
m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type==="SHADOW_CAST"){update_subs_shadow(subs,bpy_scene,subs_main.camera,subs.bundles,sh_params,recalc_z_bounds);recalc_z_bounds=false}})}function enable_outline_draw(scene){var graph=scene._render.graph;m_graph.traverse(graph,function(node,subs){if(subs.type==="OUTLINE")subs.draw_outline_flag=1})}exports.update_shadow_billboard_view=function(cam_main,graph){m_graph.traverse(graph,function(node,attr){var subs=attr;if(subs.type==="SHADOW_CAST"){var eye=
m_tsr.get_trans_view(cam_main.world_tsr);m_tsr.set_trans(eye,subs.camera.world_tsr);m_tsr.copy(cam_main.view_tsr,subs.camera.shadow_cast_billboard_view_tsr)}})};function update_subs_shadow(subs,scene,cam_main,cast_bundles,sh_params,recalc_z_bounds){if(cast_bundles.length==0)return;var cam=subs.camera;var eye=m_tsr.get_trans_value(cam_main.world_tsr,_vec3_tmp);m_tsr.set_trans(eye,cam.world_tsr);m_tsr.copy(cam_main.view_tsr,cam.shadow_cast_billboard_view_tsr);if(sh_params.lamp_types[subs.shadow_lamp_index]===
"SUN"||sh_params.lamp_types[subs.shadow_lamp_index]==="HEMI"){var bb_world=get_shadow_casters_bb(cast_bundles,_bb_tmp);var bb_corners=m_bounds.extract_bb_corners(bb_world,_corners_cache);m_util.positions_multiply_matrix(bb_corners,cam.view_matrix,bb_corners);if(sh_params.enable_csm){var center=m_vec3.copy(cam_main.csm_centers[subs.csm_index],_vec3_tmp);var main_view_inv=m_mat4.invert(cam_main.view_matrix,_mat4_tmp);m_util.positions_multiply_matrix(center,main_view_inv,center);m_util.positions_multiply_matrix(center,
cam.view_matrix,center);var radius=cam_main.csm_radii[subs.csm_index];if(recalc_z_bounds){_shadow_cast_min_z=0;_shadow_cast_max_z=-Infinity;for(var i=2;i<bb_corners.length;i+=3){_shadow_cast_min_z=Math.min(_shadow_cast_min_z,bb_corners[i]);_shadow_cast_max_z=Math.max(_shadow_cast_max_z,bb_corners[i])}}var bb_view=_bb_tmp;bb_view.max_x=center[0]+radius;bb_view.max_y=center[1]+radius;bb_view.max_z=_shadow_cast_max_z;bb_view.min_x=center[0]-radius;bb_view.min_y=center[1]-radius;bb_view.min_z=_shadow_cast_min_z}else{var bb_view=
_bb_tmp;var optimal_angle=get_optimal_bb_and_angle(bb_corners,bb_view);if(optimal_angle>0){var rot_mat=m_mat4.identity(_mat4_tmp);m_mat4.rotate(rot_mat,optimal_angle,m_util.AXIS_MZ,rot_mat);m_mat4.multiply(rot_mat,cam.view_matrix,cam.view_matrix);m_tsr.from_mat4(cam.view_matrix,cam.view_tsr)}bb_view=correct_bb_proportions(bb_view);update_shadow_receive_subs(subs,scene._render.graph)}m_cam.set_frustum_asymmetric(cam,bb_view.min_x,bb_view.max_x,bb_view.min_y,bb_view.max_y,-bb_view.max_z,-bb_view.min_z);
m_cam.set_projection(cam);m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes)}else if(sh_params.lamp_types[subs.shadow_lamp_index]==="SPOT"||sh_params.lamp_types[subs.shadow_lamp_index]==="POINT")m_cam.set_projection(cam,cam.aspect)}exports.update_shadow_receive_subs=update_shadow_receive_subs;function update_shadow_receive_subs(subs,graph){var cam_cast=subs.camera;var outputs=m_scgraph.get_outputs(graph,subs);for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output.type!=
"MAIN_OPAQUE"&&output.type!="SHADOW_RECEIVE"&&output.type!="MAIN_BLEND"&&output.type!="MAIN_XRAY")continue;if(cfg_def.mac_os_shadow_hack)output.v_light_tsr.set(cam_cast.view_tsr,subs.shadow_lamp_index*9);else{var view_trans=m_tsr.get_trans_view(cam_cast.view_tsr);var scale=m_tsr.get_scale(cam_cast.view_tsr);var quat=m_tsr.get_quat_view(cam_cast.view_tsr);m_vec4.set(view_trans[0],view_trans[1],view_trans[2],scale,_vec4_tmp);output.v_light_ts.set(_vec4_tmp,subs.shadow_lamp_index*4);output.v_light_r.set(quat,
subs.shadow_lamp_index*4)}}}function get_optimal_bb_and_angle(bb_corners,bb_dest){var rot_corners=_corners_cache2;rot_corners.set(bb_corners);var angle_delta=MAX_OPTIMAL_BB_ANGLE/(OPTIMAL_BB_COUNT-1);var rot_mat=m_mat4.identity(_mat4_tmp);m_mat4.rotate(rot_mat,angle_delta,m_util.AXIS_MZ,rot_mat);var min=-1;var min_index=-1;for(var i=0;i<OPTIMAL_BB_COUNT;i++){var bb_all=m_bounds.bb_from_coords(rot_corners,_bb_tmp2);var S=(bb_all.max_x-bb_all.min_x)*(bb_all.max_y-bb_all.min_y);if(min==-1||S<min){min=
S;min_index=i;m_bounds.copy_bb(bb_all,bb_dest)}m_util.positions_multiply_matrix(rot_corners,rot_mat,rot_corners)}return min_index*angle_delta}function correct_bb_proportions(bb){var x=bb.max_x-bb.min_x;var y=bb.max_y-bb.min_y;if(x&&y){var diff=Math.abs(x-y)/2;if(x/y>MAX_SHADOW_CAST_BB_PROPORTION){bb.max_y+=diff;bb.min_y-=diff}else if(y/x>MAX_SHADOW_CAST_BB_PROPORTION){bb.max_x+=diff;bb.min_x-=diff}}bb.max_x+=SHADOW_MAP_EPSILON_XY;bb.max_y+=SHADOW_MAP_EPSILON_XY;bb.max_z+=SHADOW_MAP_EPSILON_Z;bb.min_x-=
SHADOW_MAP_EPSILON_XY;bb.min_y-=SHADOW_MAP_EPSILON_XY;bb.min_z-=SHADOW_MAP_EPSILON_Z;return bb}function get_shadow_casters_bb(cast_bundles,dest){m_bounds.zero_bounding_box(dest);for(var i=0;i<cast_bundles.length;i++){var render=cast_bundles[i].obj_render;if(i==0)m_bounds.copy_bb(render.bb_world,dest);else m_bounds.expand_bounding_box(dest,render.bb_world)}return dest}exports.get_csm_borders=get_csm_borders;function get_csm_borders(scene,cam){var shs=scene._render.shadow_params;var rslt=new Float32Array(shs.csm_num);
for(var i=0;i<shs.csm_num;i++)rslt[i]=m_cam.csm_far_plane(shs,cam,i);return rslt}function add_object_subs_color_picking(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="COLOR_ID")continue;if(!copy){update_batch_subs(batch,subs,obj,graph,"COLOR_ID",scene);m_batch.update_shader(batch);validate_batch(batch)}if(!(subs.type=="COLOR_PICKING"&&batch.subtype==
"COLOR_ID"||subs.type=="COLOR_PICKING_XRAY"&&batch.subtype=="COLOR_ID_XRAY"))continue;if(!copy){m_batch.set_batch_directive(batch,"USE_OUTLINE",0);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}}function add_object_subs_debug_view(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="DEBUG_VIEW")continue;
append_debug_view_batch(subs,obj_render,graph,copy,batch)}}exports.append_debug_view_batch=append_debug_view_batch;function append_debug_view_batch(subs,obj_render,graph,copy,batch){if(!copy){if(batch.dynamic_grass){var subs_grass_map=m_scgraph.find_subs(graph,"GRASS_MAP");if(subs_grass_map)prepare_dynamic_grass_batch(batch,subs_grass_map,obj_render)}m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb);connect_textures(graph,subs,batch);check_batch_textures_number(batch)}
function add_object_subs_grass_map(subs,obj,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="GRASS_MAP")continue;if(!copy){m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb);var cam=subs.camera;var bb=obj_render.bb_world;var low=subs.grass_map_dim[0];var high=subs.grass_map_dim[1];var size=subs.grass_map_dim[2];
if(low==0&&high==0){low=bb.min_y;high=bb.max_y}else{low=Math.min(low,bb.min_y);high=Math.max(high,bb.max_y)}var map_margin=(high-low)*GRASS_MAP_MARGIN;low=low-map_margin;high=high+map_margin;subs.grass_map_dim[0]=low;subs.grass_map_dim[1]=high;m_cam.set_frustum(cam,size/2,-high,-low,size/2);m_cam.set_projection(cam)}}function add_object_subs_outline_mask(subs,obj,graph,scene,copy){var obj_render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<
batches.length;i++){var batch=batches[i];if(batch.type!="COLOR_ID")continue;if(batch.subtype!="OUTLINE")continue;if(!copy){m_batch.set_batch_directive(batch,"USE_OUTLINE",1);m_batch.update_shader(batch);validate_batch(batch)}var rb=init_bundle(obj_render,batch);subs.bundles.push(rb)}}exports.change_visibility_rec=change_visibility_rec;function change_visibility_rec(obj,hide){change_visibility(obj,hide);for(var i=0;i<obj.cons_descends.length;i++)if(obj.cons_descends[i].parent==obj)change_visibility_rec(obj.cons_descends[i],
hide)}exports.change_visibility=change_visibility;function change_visibility(obj,hide){obj.render.hide=hide;if(m_obj_util.is_lamp(obj))for(var i=0;i<obj.scenes_data.length;i++){var scene_data=obj.scenes_data[i];var scene=scene_data.scene;var subs_arr=subs_array(scene,LIGHT_SUBSCENE_TYPES);for(var j=0;j<subs_arr.length;j++)update_subs_light_factors(obj,scene_data,subs_arr[j])}}exports.is_hidden=function(obj){return obj.render.hide};exports.remove_object_bundles=function(scene,obj,clean_buffs){var render=
obj.render;var subscenes=subs_array(scene,OBJECT_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var bundles=subscenes[i].bundles;for(var j=bundles.length-1;j>=0;j--){var bundle=bundles[j];if(bundle.obj_render==render){if(bundle.batch&&clean_buffs)m_geom.cleanup_bufs_data(bundle.batch.bufs_data);bundles.splice(j,1)}}}};function add_bundle(subscene,render,batch){var rb=init_bundle(render,batch);subscene.bundles.push(rb)}function remove_bundle(subscene,render){var bundles=subscene.bundles;for(var i=
0;i<bundles.length;i++){var bundle=bundles[i];if(bundle.obj_render==render){bundles.splice(i,1);i--}}}exports.update_lamp_scene_color_intensity=update_lamp_scene_color_intensity;function update_lamp_scene_color_intensity(lamp,scene){var light=lamp.light;var sc_data=m_obj_util.get_scene_data(lamp,scene);var ind=sc_data.light_index;var subs_arr=subs_array(scene,LIGHT_SUBSCENE_TYPES);for(var i=0;i<subs_arr.length;i++){var subs=subs_arr[i];subs.light_color_intensities.set(light.color_intensity,ind*3);
subs.need_perm_uniforms_update=true}}exports.update_lamp_scene=update_lamp_scene;function update_lamp_scene(lamp,scene){var subs_arr=subs_array(scene,LIGHT_SUBSCENE_TYPES);var light=lamp.light;var lamp_render=lamp.render;var sc_data=m_obj_util.get_scene_data(lamp,scene);var ind=sc_data.light_index;var trans=m_tsr.get_trans_view(lamp_render.world_tsr);var quat=m_tsr.get_quat_view(lamp_render.world_tsr);for(var i=0;i<subs_arr.length;i++){var subs=subs_arr[i];subs.light_positions.set(trans,ind*3);subs.light_directions.set(light.direction,
ind*3);subs.light_color_intensities.set(light.color_intensity,ind*3);switch(light.type){case "SUN":subs.sun_quaternion.set(quat);subs.sun_intensity=light.color_intensity;if(subs.type==="SKY"){subs.need_fog_update=light.need_sun_fog_update;m_vec3.copy(light.direction,subs.sun_direction);update_sky(scene,subs)}else m_vec3.copy(light.direction,subs.sun_direction);break;case "HEMI":case "POINT":case "SPOT":break;default:m_print.error("Unknown light type: "+light.type+'".');break}update_subs_light_factors(lamp,
sc_data,subs);for(var j=0;j<subs.bundles.length;j++){var batch=subs.bundles[j].batch;if(batch.lamp_uuid_indexes)m_batch.set_lamp_data(batch,lamp)}}var subs_main=get_subs(scene,"MAIN_OPAQUE");var cam_main=subs_main.camera;var shadow_subscenes=sc_data.shadow_subscenes;var sh_params=scene._render.shadow_params;for(var i=0;i<shadow_subscenes.length;i++){var subs=shadow_subscenes[i];var cam=subs.camera;m_cam.set_view_trans_quat(cam,trans,quat);update_subs_shadow(subs,scene,cam_main,subs.bundles,sh_params,
true);update_shadow_receive_subs(subs,scene._render.graph)}}function update_subs_light_factors(lamp,sc_data,subs){var lamp_render=lamp.render;var light=lamp.light;var ind=sc_data.light_index;var light_factor=_vec2_tmp;light_factor[0]=light.use_diffuse&&!lamp_render.hide?1:0;light_factor[1]=light.use_specular&&!lamp_render.hide?1:0;subs.light_factors.set(light_factor,ind*2);subs.need_perm_uniforms_update=true}function reset_shadow_cam_vm(bpy_scene){var lamps=m_obj.get_scene_objs(bpy_scene,"LAMP",m_obj.DATA_ID_ALL);
var use_ssao=cfg_def.ssao&&bpy_scene["b4w_enable_ssao"];var shadow_lamps=m_obj_util.get_shadow_lamps(lamps,use_ssao);if(!shadow_lamps.length)return;for(var k=0;k<shadow_lamps.length;k++){var shadow_lamp=shadow_lamps[k];var lamp_render=shadow_lamp.render;var trans=m_tsr.get_trans_value(lamp_render.world_tsr,_vec3_tmp);var quat=m_tsr.get_quat_value(lamp_render.world_tsr,_quat4_tmp);for(var j=0;j<shadow_lamp.scenes_data.length;j++){var sc_data=shadow_lamp.scenes_data[j];var shadow_subscenes=sc_data.shadow_subscenes;
if(sc_data.scene==bpy_scene)for(var i=0;i<shadow_subscenes.length;i++){var subs=shadow_subscenes[i];var cam=subs.camera;m_cam.set_view_trans_quat(cam,trans,quat)}}}}function update_sky(scene,subs){m_prerender.prerender_subs(subs);m_render.draw(subs);if(subs.need_fog_update){var main_subs=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<main_subs.length;i++){var m_subs=main_subs[i];var bundles=m_subs.bundles;for(var j=0;j<bundles.length;j++){var bundle=bundles[j];if(bundle.do_render){var batch=bundle.batch;
if(m_batch.check_batch_perm_uniform(batch,"u_cube_fog"))m_render.update_batch_permanent_uniform(batch,"u_cube_fog")}}}}}exports.cleanup=function(){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var graph=scene._render.graph;m_graph.traverse(graph,function(node,attr){if(!(attr.type=="SINK"))clear_subscene(attr)});scene._render.graph=[];scene._render.queue=[]}_main_scene=null;_active_scene=null;_scenes.length=0;_scenes_graph=null};function clear_subscene(subs){var cam=subs.camera;m_render.render_target_cleanup(cam.framebuffer,
cam.color_attachment,cam.depth_attachment,cam.width,cam.height);var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;if(batch)m_batch.clear_batch(batch)}}exports.make_frustum_shot=function(cam,subscene,color){var corners=m_cam.extract_frustum_corners(cam,cam.near,cam.far,null,true);var submesh=m_primitives.generate_frustum(corners);var render=m_obj_util.create_render("DYNAMIC");render.bb_world=render.bb_local=m_bounds.big_bounding_box();render.bs_world=render.bs_local=
m_bounds.big_bounding_sphere();var radius=render.bs_world.radius;render.be_world=render.be_local=m_bounds.create_bounding_ellipsoid([radius,0,0],[0,radius,0],[0,0,radius],render.bs_world.center);var batch=m_batch.create_shadeless_batch(submesh,color,.5);add_bundle(subscene,render,batch)};function get_objs_materials(bpy_objects){var mats=[];for(var i=0;i<bpy_objects.length;i++){var mesh=bpy_objects[i]["data"];for(var j=0;j<mesh["materials"].length;j++){var mat=mesh["materials"][j];if(mats.indexOf(mat)==
-1)mats.push(mat)}}return mats}exports.get_scene_timeline=function(scene){var start=scene["frame_start"];var end=scene["frame_end"];return[start,end]};exports.setup_dim=setup_dim;function setup_dim(width,height,scale){m_cont.setup_viewport_dim(width,height,scale);if(_active_scene)setup_scene_dim(_active_scene,width,height)}exports.setup_scene_dim=setup_scene_dim;function setup_scene_dim(scene,width,height){var sc_render=scene._render;var cam_scene_data=m_obj_util.get_scene_data(scene._camera,scene);
var upd_cameras=cam_scene_data.cameras;for(var i=0;i<upd_cameras.length;i++){var cam=upd_cameras[i];m_cam.set_projection(cam,width/height);if(sc_render.shadow_params)m_cam.update_camera_shadows(cam,sc_render.shadow_params)}if(sc_render.shadow_params){sc_render.need_shadow_update=true;get_subs(scene,"SHADOW_RECEIVE").need_perm_uniforms_update=true;get_subs(scene,"MAIN_BLEND").need_perm_uniforms_update=true}var graph=sc_render.graph;m_scgraph.traverse_slinks(graph,function(slink,internal,subs1,subs2){if(!slink.update_dim)return;
var tex_width=slink.size_mult_x*width;var tex_height=slink.size_mult_y*height;if(internal)for(var i=0;i<subs1.slinks_internal.length;i++){var slink_i=subs1.slinks_internal[i];if(slink_i==slink){var tex=subs1.textures_internal[i];m_tex.resize(slink.texture,tex_width,tex_height)}}else{if(m_tex.is_texture(slink.texture))m_tex.resize(slink.texture,tex_width,tex_height);var cam=subs1.camera;cam.width=tex_width;cam.height=tex_height;switch(subs1.type){case "DOF":set_dof_params(scene,{"dof_power":subs1.camera.dof_power,
"dof_on":subs1.camera.dof_on});break;case "GLOW_COMBINE":set_glow_material_params(scene,{"small_glow_mask_width":subs1.small_glow_mask_width,"large_glow_mask_width":subs1.large_glow_mask_width});break;case "BLOOM":set_bloom_params(scene,{"bloom_blur":subs1.bloom_blur});break;case "OUTLINE":var subs_outline_blur_y=m_scgraph.find_input(graph,subs1,"POSTPROCESSING");var subs_outline_blur_x=m_scgraph.find_input(graph,subs_outline_blur_y,"POSTPROCESSING");var subs_outline_extend_y=m_scgraph.find_input(graph,
subs_outline_blur_x,"POSTPROCESSING");var subs_outline_extend_x=m_scgraph.find_input(graph,subs_outline_extend_y,"POSTPROCESSING");m_scgraph.set_texel_size(subs_outline_blur_y,1/width,1/height);m_scgraph.set_texel_size(subs_outline_blur_x,1/width,1/height);m_scgraph.set_texel_size(subs_outline_extend_y,1/width,1/height);m_scgraph.set_texel_size(subs_outline_extend_x,1/width,1/height);break;default:m_scgraph.set_texel_size(subs1,1/width,1/height);break}}})}exports.subs_array=subs_array;function subs_array(scene,
types){var subscenes=[];var scene_subscenes=scene._render.graph;for(var i=0;i<types.length;i++){var type=types[i];m_graph.traverse(scene._render.graph,function(node,attr){var subs=attr;if(subs.type==type)subscenes.push(subs)})}return subscenes}exports.get_subs=get_subs;function get_subs(scene,type){var graph=scene._render.graph;return m_scgraph.find_subs(graph,type)}exports.get_environment_colors=function(scene){var subs=get_subs(scene,"MAIN_OPAQUE");var hor=subs.horizon_color;var zen=subs.zenith_color;
var hor_dest=[];var zen_dest=[];hor_dest[0]=hor[0];hor_dest[1]=hor[1];hor_dest[2]=hor[2];zen_dest[0]=zen[0];zen_dest[1]=zen[1];zen_dest[2]=zen[2];return[subs.environment_energy,hor_dest,zen_dest]};exports.set_environment_colors=set_environment_colors;function set_environment_colors(scene,environment_energy,horizon_color,zenith_color){var subscenes=subs_array(scene,LIGHT_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];subs.horizon_color.set(horizon_color);subs.zenith_color.set(zenith_color);
subs.environment_energy=environment_energy;subs.need_perm_uniforms_update=true}}exports.get_sky_params=function(scene){var subs=get_subs(scene,"SKY");if(subs){var sky_params={};sky_params.color=new Array(3);m_vec3.copy(subs.sky_color,sky_params.color);sky_params.procedural_skydome=subs.procedural_skydome;sky_params.use_as_environment_lighting=subs.use_as_environment_lighting;sky_params.rayleigh_brightness=subs.rayleigh_brightness;sky_params.mie_brightness=subs.mie_brightness;sky_params.spot_brightness=
subs.spot_brightness;sky_params.scatter_strength=subs.scatter_strength;sky_params.rayleigh_strength=subs.rayleigh_strength;sky_params.mie_strength=subs.mie_strength;sky_params.rayleigh_collection_power=subs.rayleigh_collection_power;sky_params.mie_collection_power=subs.mie_collection_power;sky_params.mie_distribution=subs.mie_distribution;return sky_params}else return null};exports.set_sky_params=function(scene,sky_params){var subs=get_subs(scene,"SKY");if(subs){if(typeof sky_params.procedural_skydome==
"number")subs.procedural_skydome=sky_params.procedural_skydome;if(typeof sky_params.use_as_environment_lighting=="number")subs.use_as_environment_lighting=sky_params.use_as_environment_lighting;if(typeof sky_params.color=="object")subs.sky_color.set(sky_params.color);if(typeof sky_params.rayleigh_brightness=="number")subs.rayleigh_brightness=sky_params.rayleigh_brightness;if(typeof sky_params.mie_brightness=="number")subs.mie_brightness=sky_params.mie_brightness;if(typeof sky_params.spot_brightness==
"number")subs.spot_brightness=sky_params.spot_brightness;if(typeof sky_params.scatter_strength=="number")subs.scatter_strength=sky_params.scatter_strength;if(typeof sky_params.rayleigh_strength=="number")subs.rayleigh_strength=sky_params.rayleigh_strength;if(typeof sky_params.mie_strength=="number")subs.mie_strength=sky_params.mie_strength;if(typeof sky_params.rayleigh_collection_power=="number")subs.rayleigh_collection_power=sky_params.rayleigh_collection_power;if(typeof sky_params.mie_collection_power==
"number")subs.mie_collection_power=sky_params.mie_collection_power;if(typeof sky_params.mie_distribution=="number")subs.mie_distribution=sky_params.mie_distribution;subs.need_perm_uniforms_update=true;subs.need_fog_update=true;update_sky(scene,subs)}};exports.get_fog_intensity=function(scene){var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];return subs.fog_params[0]};exports.get_fog_depth=function(scene){var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];return subs.fog_params[1]};exports.get_fog_start=
function(scene){var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];return subs.fog_params[2]};exports.get_fog_height=function(scene){var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];return subs.fog_params[3]};exports.set_fog_intensity=function(scene,fog_intensity){var subscenes=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];subs.fog_params[0]=fog_intensity;subs.need_perm_uniforms_update=true}};exports.set_fog_depth=function(scene,fog_depth){var subscenes=
subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];subs.fog_params[1]=fog_depth;subs.need_perm_uniforms_update=true}};exports.set_fog_start=function(scene,fog_start){var subscenes=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];subs.fog_params[2]=fog_start;subs.need_perm_uniforms_update=true}};exports.set_fog_height=function(scene,fog_height){var subscenes=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<
subscenes.length;i++){var subs=subscenes[i];subs.fog_params[3]=fog_height;subs.need_perm_uniforms_update=true}};exports.get_fog_color_density=function(scene,opt_dest){var dest=opt_dest||[];var subs=subs_array(scene,FOG_SUBSCENE_TYPES)[0];var fcd=subs.fog_color_density;dest[0]=fcd[0];dest[1]=fcd[1];dest[2]=fcd[2];dest[3]=fcd[3];return dest};exports.set_fog_color_density=function(scene,val){var subscenes=subs_array(scene,FOG_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];
subs.fog_color_density.set(val);subs.need_perm_uniforms_update=true}};exports.get_ssao_params=function(scene){var subs=get_subs(scene,"SSAO");var subs_blur=get_subs(scene,"SSAO_BLUR");if(!subs)return null;var batch=subs.bundles[0].batch;var ssao_params={};ssao_params.ssao_quality=m_batch.get_batch_directive(batch,"SSAO_QUALITY")[1];ssao_params.ssao_hemisphere=subs.ssao_hemisphere;ssao_params.ssao_blur_depth=subs_blur.ssao_blur_depth;ssao_params.blur_discard_value=subs_blur.ssao_blur_discard_value;
ssao_params.radius_increase=subs.ssao_radius_increase;ssao_params.influence=subs.ssao_influence;ssao_params.dist_factor=subs.ssao_dist_factor;ssao_params.ssao_only=subs.ssao_only;ssao_params.ssao_white=m_batch.get_batch_directive(batch,"SSAO_WHITE")[1];return ssao_params};exports.set_ssao_params=function(scene,ssao_params){var subs=get_subs(scene,"SSAO");var subs_blur=get_subs(scene,"SSAO_BLUR");if(!subs){m_print.error("SSAO is not enabled on the scene");return 0}if(typeof ssao_params.ssao_quality==
"string"){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_QUALITY",ssao_params.ssao_quality);m_batch.update_shader(batch,true)}if(typeof ssao_params.ssao_hemisphere=="number"){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_HEMISPHERE",ssao_params.ssao_hemisphere);m_batch.update_shader(batch,true)}if(typeof ssao_params.ssao_blur_depth=="number"){var batch=subs_blur.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_BLUR_DEPTH",ssao_params.ssao_blur_depth);
m_batch.update_shader(batch,true)}if(typeof ssao_params.ssao_blur_discard_value=="number")subs_blur.ssao_blur_discard_value=ssao_params.ssao_blur_discard_value;if(typeof ssao_params.ssao_radius_increase=="number")subs.ssao_radius_increase=ssao_params.ssao_radius_increase;if(typeof ssao_params.ssao_influence=="number")subs.ssao_influence=ssao_params.ssao_influence;if(typeof ssao_params.ssao_dist_factor=="number")subs.ssao_dist_factor=ssao_params.ssao_dist_factor;if(typeof ssao_params.ssao_only=="number"){var subs=
get_subs(scene,"MAIN_OPAQUE");subs.ssao_only=ssao_params.ssao_only;for(var i=0;i<subs.bundles.length;i++){var batch=subs.bundles[i].batch;m_batch.set_batch_directive(batch,"SSAO_ONLY",ssao_params.ssao_only);m_batch.update_shader(batch,true)}}if(typeof ssao_params.ssao_white=="number"){var batch=subs.bundles[0].batch;m_batch.set_batch_directive(batch,"SSAO_WHITE",ssao_params.ssao_white);m_batch.update_shader(batch,true)}subs.need_perm_uniforms_update=true;subs_blur.need_perm_uniforms_update=true};
exports.get_dof_params=function(scene){var subs=get_subs(scene,"DOF");if(!subs)return null;var dof_params={};dof_params.dof_distance=subs.camera.dof_distance;dof_params.dof_front=subs.camera.dof_front;dof_params.dof_rear=subs.camera.dof_rear;dof_params.dof_power=subs.camera.dof_power;dof_params.dof_object=subs.camera.dof_object;return dof_params};exports.set_dof_params=set_dof_params;function set_dof_params(scene,dof_params){var subs=get_subs(scene,"DOF");if(!subs){m_print.error("DOF is not enabled on the scene. Check camera settings");
return 0}var graph=scene._render.graph;if(typeof dof_params.dof_on=="boolean")subs.camera.dof_on=dof_params.dof_on;if(typeof dof_params.dof_distance=="number")subs.camera.dof_distance=dof_params.dof_distance;if(typeof dof_params.dof_front=="number")subs.camera.dof_front=dof_params.dof_front;if(typeof dof_params.dof_rear=="number")subs.camera.dof_rear=dof_params.dof_rear;if(typeof dof_params.dof_power=="number"){subs.camera.dof_power=dof_params.dof_power;var subs_pp1=m_scgraph.find_input(graph,subs,
"POSTPROCESSING");var subs_pp2=m_scgraph.find_input(graph,subs_pp1,"POSTPROCESSING");m_scgraph.set_texel_size_mult(subs_pp1,subs.camera.dof_power);m_scgraph.set_texel_size(subs_pp1,1/subs.camera.width,1/subs.camera.height);m_scgraph.set_texel_size_mult(subs_pp2,subs.camera.dof_power);m_scgraph.set_texel_size(subs_pp2,1/subs.camera.width,1/subs.camera.height)}}exports.get_god_rays_params=function(scene){var gr_subs=subs_array(scene,["GOD_RAYS"]);var combo_subs=get_subs(scene,"GOD_RAYS_COMBINE");if(!gr_subs||
!combo_subs)return null;var god_rays_params={};god_rays_params.god_rays_max_ray_length=gr_subs[0].max_ray_length;god_rays_params.god_rays_intensity=combo_subs.god_rays_intensity;var batch=gr_subs[0].bundles[0].batch;god_rays_params.god_rays_steps=m_batch.get_batch_directive(batch,"STEPS_PER_PASS")[1];return god_rays_params};exports.set_god_rays_params=function(scene,god_rays_params){var gr_subs=subs_array(scene,["GOD_RAYS"]);var combo_subs=get_subs(scene,"GOD_RAYS_COMBINE");if(!gr_subs||!combo_subs){m_print.error("God Rays are not enabled on the scene");
return 0}if(typeof god_rays_params.god_rays_intensity=="number")combo_subs.god_rays_intensity=god_rays_params.god_rays_intensity;if(typeof god_rays_params.god_rays_max_ray_length=="number"){var r_length=god_rays_params.god_rays_max_ray_length;for(var i=0;i<gr_subs.length;i++){gr_subs[i].max_ray_length=r_length;gr_subs[i].radial_blur_step=r_length/gr_subs[i].steps_per_pass/(i+1);gr_subs[i].need_perm_uniforms_update=true}}if(typeof god_rays_params.god_rays_steps=="number"){var steps=m_shaders.glsl_value(god_rays_params.god_rays_steps,
1);var r_length=gr_subs[0].max_ray_length;for(var i=0;i<gr_subs.length;i++){gr_subs[i].steps_per_pass=steps;gr_subs[i].radial_blur_step=r_length/steps/(i+1);gr_subs[i].need_perm_uniforms_update=true;var batch=gr_subs[i].bundles[0].batch;m_batch.set_batch_directive(batch,"STEPS_PER_PASS",steps);m_batch.update_shader(batch,true)}}combo_subs.need_perm_uniforms_update=true};exports.get_bloom_params=function(scene){var lum_subs=get_subs(scene,"LUMINANCE_TRUNCED");var bloom_subs=get_subs(scene,"BLOOM");
if(!lum_subs||!bloom_subs)return null;var bloom_params={};bloom_params.bloom_key=lum_subs.bloom_key;bloom_params.bloom_edge_lum=lum_subs.bloom_edge_lum;bloom_params.bloom_blur=bloom_subs.bloom_blur;return bloom_params};exports.set_bloom_params=set_bloom_params;function set_bloom_params(scene,bloom_params){var lum_subs=get_subs(scene,"LUMINANCE_TRUNCED");var bloom_subs=get_subs(scene,"BLOOM");if(!lum_subs||!bloom_subs){m_print.error("Bloom is not enabled on the scene");return 0}if(typeof bloom_params.bloom_key==
"number"){lum_subs.bloom_key=bloom_params.bloom_key;lum_subs.need_perm_uniforms_update=true}if(typeof bloom_params.bloom_edge_lum=="number"){lum_subs.bloom_edge_lum=bloom_params.bloom_edge_lum;lum_subs.need_perm_uniforms_update=true}if(typeof bloom_params.bloom_blur=="number"){var graph=scene._render.graph;var subs_blur1=m_scgraph.find_input(graph,bloom_subs,"BLOOM_BLUR");var subs_blur2=m_scgraph.find_input(graph,subs_blur1,"BLOOM_BLUR");bloom_subs.bloom_blur=bloom_params.bloom_blur;m_scgraph.set_texel_size_mult(subs_blur1,
bloom_params.bloom_blur);m_scgraph.set_texel_size(subs_blur1,1/bloom_subs.camera.width,1/bloom_subs.camera.height);m_scgraph.set_texel_size_mult(subs_blur2,bloom_params.bloom_blur);m_scgraph.set_texel_size(subs_blur2,1/bloom_subs.camera.width,1/bloom_subs.camera.height)}}exports.get_glow_material_params=function(scene){var glow_combine_subs=get_subs(scene,"GLOW_COMBINE");if(!glow_combine_subs)return null;var glow_material_params={};glow_material_params.small_glow_mask_coeff=glow_combine_subs.small_glow_mask_coeff;
glow_material_params.large_glow_mask_coeff=glow_combine_subs.large_glow_mask_coeff;glow_material_params.small_glow_mask_width=glow_combine_subs.small_glow_mask_width;glow_material_params.large_glow_mask_width=glow_combine_subs.large_glow_mask_width;return glow_material_params};exports.set_glow_material_params=set_glow_material_params;function set_glow_material_params(scene,glow_material_params){var glow_combine_subs=get_subs(scene,"GLOW_COMBINE");if(!glow_combine_subs){m_print.error("Glow is not enabled on the scene");
return null}var graph=scene._render.graph;var subs=m_scgraph.get_inputs(graph,glow_combine_subs);for(var i=0;i<subs.length;++i){var subscene=subs[i];if(subscene.type==="POSTPROCESSING"&&subscene.subtype==="GLOW_MASK_LARGE")var postproc_y_blur_large_subs=subscene;if(subscene.type==="POSTPROCESSING"&&subscene.subtype==="GLOW_MASK_SMALL")var postproc_y_blur_small_subs=subscene}var postproc_x_blur_large_subs=m_scgraph.find_input(graph,postproc_y_blur_large_subs,"POSTPROCESSING");var postproc_x_blur_small_subs=
m_scgraph.find_input(graph,postproc_y_blur_small_subs,"POSTPROCESSING");if(typeof glow_material_params.small_glow_mask_coeff=="number"){glow_combine_subs.small_glow_mask_coeff=glow_material_params.small_glow_mask_coeff;glow_combine_subs.need_perm_uniforms_update=true}if(typeof glow_material_params.large_glow_mask_coeff=="number"){glow_combine_subs.large_glow_mask_coeff=glow_material_params.large_glow_mask_coeff;glow_combine_subs.need_perm_uniforms_update=true}if(typeof glow_material_params.small_glow_mask_width==
"number"){glow_combine_subs.small_glow_mask_width=glow_material_params.small_glow_mask_width;m_scgraph.set_texel_size_mult(postproc_y_blur_small_subs,glow_material_params.small_glow_mask_width);m_scgraph.set_texel_size(postproc_y_blur_small_subs,1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_y_blur_small_subs.need_perm_uniforms_update=true;m_scgraph.set_texel_size_mult(postproc_x_blur_small_subs,glow_material_params.small_glow_mask_width);m_scgraph.set_texel_size(postproc_x_blur_small_subs,
1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_x_blur_small_subs.need_perm_uniforms_update=true}if(typeof glow_material_params.large_glow_mask_width=="number"){glow_combine_subs.large_glow_mask_width=glow_material_params.large_glow_mask_width;m_scgraph.set_texel_size_mult(postproc_y_blur_large_subs,glow_material_params.large_glow_mask_width);m_scgraph.set_texel_size(postproc_y_blur_large_subs,1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_y_blur_large_subs.need_perm_uniforms_update=
true;m_scgraph.set_texel_size_mult(postproc_x_blur_large_subs,glow_material_params.large_glow_mask_width);m_scgraph.set_texel_size(postproc_x_blur_large_subs,1/glow_combine_subs.camera.width,1/glow_combine_subs.camera.height);postproc_x_blur_large_subs.need_perm_uniforms_update=true}}exports.get_wind_params=function(scene){var wind=get_wind(scene);var length=m_vec3.length(wind);if(length==0)return null;var angle=m_util.rad_to_deg(Math.atan2(wind[0],wind[2]));var wind_params={};wind_params.wind_dir=
angle;wind_params.wind_strength=length;return wind_params};exports.schedule_grass_map_update=schedule_grass_map_update;function schedule_grass_map_update(bpy_scene){bpy_scene._render.need_grass_map_update=true}exports.get_water_surface_level=get_water_surface_level;function get_water_surface_level(scene,pos_x,pos_z){var render=scene._render;var wp=render.water_params;if(!wp.dynamic)return wp.water_level;var waves_height=wp.waves_height;var waves_length=wp.waves_length;var water_level=wp.water_level;
var wind_str=m_vec3.length(render.wind);var subs=get_subs(scene,"MAIN_OPAQUE");var time=subs.time;if(wind_str)time*=wind_str;var cellular_coords=_vec2_tmp;cellular_coords[0]=20/waves_length*(pos_x-.25*time);cellular_coords[1]=20/waves_length*(pos_z-.25*time);var cellular1=m_util.cellular2x2(cellular_coords);cellular_coords[0]=17/waves_length*(pos_z+.1*time);cellular_coords[1]=17/waves_length*(pos_x+.1*time);var cellular2=m_util.cellular2x2(cellular_coords);var small_waves=cellular1+cellular2-1;var dst_noise_scale0=
wp.dst_noise_scale0;var dst_noise_scale1=wp.dst_noise_scale1;var dst_noise_freq0=wp.dst_noise_freq0;var dst_noise_freq1=wp.dst_noise_freq1;var noise_coords=_vec2_tmp;noise_coords[0]=dst_noise_scale0*(pos_x+dst_noise_freq0*time);noise_coords[1]=dst_noise_scale0*(pos_z+dst_noise_freq0*time);var noise1=m_util.snoise(noise_coords);noise_coords[0]=dst_noise_scale1*(pos_z-dst_noise_freq1*time);noise_coords[1]=dst_noise_scale1*(pos_x-dst_noise_freq1*time);var noise2=m_util.snoise(noise_coords);var dist_waves=
waves_height*noise1*noise2;if(wp.shoremap_image){var size_x=wp.shoremap_size[0];var size_z=wp.shoremap_size[1];var center_x=wp.shoremap_center[0];var center_z=wp.shoremap_center[1];var x=(pos_x-center_x)/size_x;var z=(center_z+pos_z)/size_z;x+=.5;z+=.5;if(x>1||x<0||z>1||z<0)var wave_height=dist_waves;else{var width=wp.shoremap_tex_size;var array=render.shore_distances;var shore_dist=m_util.get_array_smooth_value(array,width,x,z);var dir_min_shore_fac=wp.dir_min_shore_fac;var dir_freq=wp.dir_freq;
var dir_noise_scale=wp.dir_noise_scale;var dir_noise_freq=wp.dir_noise_freq;var dir_min_noise_fac=wp.dir_min_noise_fac;var dst_min_fac=wp.dst_min_fac;var waves_hor_fac=wp.waves_hor_fac;var max_shore_dist=wp.max_shore_dist;var shore_waves_length=waves_length/max_shore_dist/Math.PI;var waves_coords=[dir_noise_scale/waves_length*(pos_x+dir_noise_freq*time),dir_noise_scale/waves_length*(pos_z+dir_noise_freq*time)];var dist_fact=Math.sqrt(shore_dist);var shore_dir_waves=waves_height*Math.max(shore_dist,
dir_min_shore_fac)*Math.sin(dist_fact/shore_waves_length+dir_freq*time)*Math.max(m_util.snoise(waves_coords),dir_min_noise_fac);var mix_rate=Math.max(dist_fact,dst_min_fac);var wave_height=shore_dir_waves*(1-mix_rate)+dist_waves*mix_rate;small_waves*=shore_dist}}else var wave_height=dist_waves;wave_height+=.05*small_waves;var cur_water_level=water_level+wave_height;return cur_water_level}exports.get_water_mat_params=function(scene,water_params){var wp=scene._render.water_params;var subs=get_subs(scene,
"MAIN_OPAQUE");if(!subs||!wp)return;water_params.waves_height=wp.waves_height;water_params.waves_length=wp.waves_length;if(subs.water_fog_color_density){water_params.water_fog_density=subs.water_fog_color_density[3];var wfc=water_params.water_fog_color=[];wfc[0]=subs.water_fog_color_density[0];wfc[1]=subs.water_fog_color_density[1];wfc[2]=subs.water_fog_color_density[2]}};exports.set_water_params=function(scene,water_params){var wp=scene._render.water_params;if(!wp){m_print.error("set_water_params() - no water parameters on the scene");
return null}if(typeof water_params.dst_noise_scale0=="number")wp.dst_noise_scale0=water_params.dst_noise_scale0;if(typeof water_params.dst_noise_scale1=="number")wp.dst_noise_scale1=water_params.dst_noise_scale1;if(typeof water_params.dst_noise_freq0=="number")wp.dst_noise_freq0=water_params.dst_noise_freq0;if(typeof water_params.dst_noise_freq1=="number")wp.dst_noise_freq1=water_params.dst_noise_freq1;if(typeof water_params.dir_min_shore_fac=="number")wp.dir_min_shore_fac=water_params.dir_min_shore_fac;
if(typeof water_params.dir_freq=="number")wp.dir_freq=water_params.dir_freq;if(typeof water_params.dir_noise_scale=="number")wp.dir_noise_scale=water_params.dir_noise_scale;if(typeof water_params.dir_noise_freq=="number")wp.dir_noise_freq=water_params.dir_noise_freq;if(typeof water_params.dir_min_noise_fac=="number")wp.dir_min_noise_fac=water_params.dir_min_noise_fac;if(typeof water_params.dst_min_fac=="number")wp.dst_min_fac=water_params.dst_min_fac;if(typeof water_params.waves_hor_fac=="number")wp.waves_hor_fac=
water_params.waves_hor_fac;if(typeof water_params.water_dynamic=="number")wp.dynamic=water_params.water_dynamic;var subscenes=subs_array(scene,MAIN_SUBSCENE_TYPES);for(var i=0;i<subscenes.length;i++){var sub=subscenes[i];if(typeof water_params.water_fog_density=="number"&&wp.fog_color_density)sub.water_fog_color_density[3]=water_params.water_fog_density;if(typeof water_params.water_fog_color=="object"&&wp.fog_color_density)sub.water_fog_color_density.set(water_params.water_fog_color);if(typeof water_params.waves_height==
"number")sub.water_waves_height=water_params.waves_height;if(typeof water_params.waves_length=="number")sub.water_waves_length=water_params.waves_length;sub.need_perm_uniforms_update=true}};exports.get_shore_dist=function(scene,trans,v_dist_mult){var wp=scene._render.water_params;if(!wp.shoremap_image)return SHORE_DIST_COMPAT;var size_x=wp.shoremap_size[0];var size_z=wp.shoremap_size[1];var center_x=wp.shoremap_center[0];var center_z=wp.shoremap_center[1];var max_shore_dist=wp.max_shore_dist;var water_level=
wp.water_level;var x=(trans[0]-center_x)/size_x;var z=(center_z+trans[2])/size_z;x+=.5;z+=.5;if(x>1||x<0||z>1||z<0)var shore_dist=1;else{var width=wp.shoremap_tex_size;var array=_active_scene._render.shore_distances;var shore_dist_xz=max_shore_dist*m_util.get_array_smooth_value(array,width,x,z);var shore_dist_y=(water_level-trans[1])*v_dist_mult;var shore_dist=Math.sqrt(shore_dist_xz*shore_dist_xz+shore_dist_y*shore_dist_y);return shore_dist}};exports.update=function(timeline,elapsed){var active_cam_render=
get_active()._camera.render;for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var graph=scene._render.graph;var render=scene._render;if(render.water_params){var trans=m_tsr.get_trans_view(active_cam_render.world_tsr);var cam_water_depth=trans[1]-get_water_surface_level(scene,trans[0],trans[2])}for(var j=0;j<render.video_textures.length;j++){var vtex=render.video_textures[j]._render;var video=vtex.video_file;var seq_video=vtex.seq_video;if(scene["b4w_use_nla"]&&vtex.use_nla)continue;if(!video&&
!seq_video)continue;if(!m_tex.video_is_played(vtex))continue;var current_frame=m_tex.video_get_current_frame(vtex);var start_frame=m_tex.video_get_start_frame(vtex);if(video&&cfg_def.is_mobile_device)start_frame-=FRAME_EPS;var end_frame=m_tex.video_get_end_frame(vtex);if(current_frame>=end_frame&&vtex.use_cyclic||current_frame<start_frame){m_tex.reset_video(vtex.name,vtex.vtex_data_id);if(seq_video)vtex.seq_last_discrete_mark=m_tex.seq_video_get_discrete_timemark(vtex,timeline);continue}if(current_frame>=
end_frame&&!vtex.use_cyclic){m_tex.pause_video(vtex.name,vtex.vtex_data_id);continue}if(m_tex.video_update_is_available(vtex))if(video)m_tex.update_video_texture(vtex);else{var mark=m_tex.seq_video_get_discrete_timemark(vtex,timeline);if(mark!=vtex.seq_last_discrete_mark){m_tex.update_seq_video_texture(vtex);vtex.seq_cur_frame++}vtex.seq_last_discrete_mark=mark}}m_graph.traverse(graph,function(node,attr){var subs=attr;if(TIME_SUBSCENE_TYPES.indexOf(subs.type)>-1)subs.time=timeline;if(render.water_params)subs.cam_water_depth=
cam_water_depth})}for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var render=scene._render;var graph=render.graph;var queue=render.queue;if(!queue.length)continue;if(render.need_shadow_update){update_shadow_subscenes(scene);render.need_shadow_update=false}if(render.need_grass_map_update){update_subs_grass_map(scene);render.need_grass_map_update=false}if(render.need_outline){enable_outline_draw(scene);render.need_outline=false}if(render.motion_blur)update_motion_blur_subscenes(graph,elapsed);
var outline_mask_subs=m_scgraph.find_subs(graph,"OUTLINE_MASK");for(var j=0;j<queue.length;j++){var qsubs=queue[j];m_prerender.prerender_subs(qsubs);if(outline_mask_subs)optimize_outline_postprocessing(graph,qsubs,outline_mask_subs);m_render.draw(qsubs)}}if(cfg_def.show_hud_debug_info)m_hud.show_debug_info(_scenes,elapsed)};exports.request_outline=function(scene){scene._render.need_outline=true};function optimize_outline_postprocessing(graph,qsubs,outline_mask_subs){if(qsubs.is_for_outline&&qsubs.type==
"POSTPROCESSING")if(outline_mask_subs.do_render!=qsubs.do_render)qsubs.do_render=outline_mask_subs.do_render;if(!outline_mask_subs.do_render&&qsubs.type=="OUTLINE")qsubs.draw_outline_flag=0}function slink_switch_active(graph,id1,id2,slink,active){if(slink.active==active)return;if(slink.active){replace_attachment(graph,id1,slink.from,null);replace_texture(graph,id2,slink.to,null)}else{replace_attachment(graph,id1,slink.from,slink.texture);replace_texture(graph,id2,slink.to,slink.texture)}slink.active=
active}function replace_attachment(graph,id,type,tex){var subs=m_graph.get_node_attr(graph,id);m_cam.set_attachment(subs.camera,type,tex);subs.assign_texture=true;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==type&&m_scgraph.check_slink_tex_conn(slink))replace_texture(graph,id_out,slink.to,tex)});m_graph.traverse_inputs(graph,id,function(id_in,attr_in,attr_edge){var slink=attr_edge;if(slink.active&&slink.from==type&&slink.from==
slink.to)replace_attachment(graph,id_in,type,tex)})}function replace_texture(graph,id,name,tex){var subs=m_graph.get_node_attr(graph,id);var bundles=subs.bundles;for(var i=0;i<bundles.length;i++){var batch=bundles[i].batch;m_batch.replace_texture(batch,tex,name)}}function update_subs_grass_map(bpy_scene){var subs_grass_map=get_subs(bpy_scene,"GRASS_MAP");if(subs_grass_map){var cam=subs_grass_map.camera;var camera_render=bpy_scene._camera.render;var camera_trans=m_tsr.get_trans_view(camera_render.world_tsr);
var trans=_vec3_tmp;trans[0]=0;trans[1]=-subs_grass_map.grass_map_dim[2]/2;trans[2]=0;var quat=m_tsr.get_quat_view(camera_render.world_tsr);m_vec3.transformQuat(trans,quat,trans);trans[0]+=camera_trans[0];trans[1]=0;trans[2]+=camera_trans[2];var quat=_quat4_tmp;quat[0]=0;quat[1]=0;quat[2]=0;quat[3]=1;m_cam.set_view_trans_quat(cam,trans,quat)}}function update_motion_blur_subscenes(graph,elapsed){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type!="MOTION_BLUR")return;if(!subs.slinks_internal[0]||
!subs.textures_internal[0])throw"Wrong MOTION_BLUR subscene";var slink=subs.slinks_internal[0];var tex=subs.textures_internal[0];subs.textures_internal[0]=subs.camera.color_attachment;m_graph.traverse_outputs(graph,id,function(id_out,attr_out,attr_edge){var slink_out=attr_edge;if(slink_out.active)replace_texture(graph,id_out,slink_out.to,tex)});replace_attachment(graph,id,slink.from,tex);replace_texture(graph,id,slink.to,subs.textures_internal[0]);subs.motion_blur_exp=Math.exp(-elapsed/subs.mb_factor)})}
function update_smaa_resolve_subscene(graph){m_graph.traverse(graph,function(id,attr){var subs=attr;if(subs.type!="SMAA_RESOLVE")return;if(!subs.slinks_internal[0]||!subs.textures_internal[0])throw"Wrong SMAA RESOLVE subscene";var tex=subs.textures_internal[0];m_graph.traverse_inputs(graph,id,function(id_in,subs_in,attr_edge){if(subs_in.type!="VELOCITY"){subs.textures_internal[0]=subs_in.camera.color_attachment;replace_attachment(graph,id_in,attr_edge.from,tex)}});replace_texture(graph,id,"u_color",
tex);replace_texture(graph,id,"u_color_prev",subs.textures_internal[0])})}exports.get_all_subscenes=function(scene){var graph=scene._render.graph;var subscenes=[];m_graph.traverse(graph,function(node,attr){subscenes.push(attr)});return subscenes};exports.get_cam_water_depth=function(){var subs=get_subs(_active_scene,"MAIN_BLEND");var scene=_active_scene;if(!subs&&!scene._render.water_params)return null;return subs.cam_water_depth};exports.get_object_data_id=function(obj){return obj.render.data_id};
exports.update_scene_permanent_uniforms=update_scene_permanent_uniforms;function update_scene_permanent_uniforms(scene){var graph=scene._render.graph;m_graph.traverse(graph,function(node,subs){subs.need_perm_uniforms_update=true})}exports.set_debug_view_mode=function(subs_debug_view,mode){subs_debug_view.do_render=mode!=m_debug.DV_NONE;for(var i=0;i<subs_debug_view.bundles.length;i++){var batch=subs_debug_view.bundles[i].batch;batch.debug_view_mode=mode}subs_debug_view.blend=mode==m_debug.DV_TRANSPARENT_WIREFRAME;
subs_debug_view.need_perm_uniforms_update=true};exports.set_debug_colors_seed=function(subs_debug_view,seed){subs_debug_view.debug_colors_seed=seed;subs_debug_view.need_perm_uniforms_update=true};exports.set_wireframe_edge_color=function(subs_debug_view,color){for(var i=0;i<subs_debug_view.bundles.length;i++){var batch=subs_debug_view.bundles[i].batch;batch.wireframe_edge_color=color;subs_debug_view.need_perm_uniforms_update=true}};exports.update_force_scene=function(scene,obj){var field=obj.field;
var sc_wind=scene._render.wind;if(field&&field.type=="WIND"&&sc_wind){var render=obj.render;var quat=m_tsr.get_quat_view(render.world_tsr);m_util.quat_to_dir(quat,m_util.AXIS_Y,sc_wind);m_vec3.normalize(sc_wind,sc_wind);m_vec3.scale(sc_wind,field.strength,sc_wind);var subs_arr=subs_array(scene,TIME_SUBSCENE_TYPES);for(var j=0;j<subs_arr.length;j++)subs_arr[j].wind.set(sc_wind)}};exports.pick_color=function(scene,canvas_x,canvas_y){var subs_color_pick=get_subs(scene,"COLOR_PICKING");if(subs_color_pick){var viewport_xy=
m_cont.canvas_to_viewport_coords(canvas_x,canvas_y,_vec2_tmp,subs_color_pick.camera);m_prerender.prerender_subs(subs_color_pick,subs_color_pick.camera);m_render.draw(subs_color_pick,subs_color_pick.bundles);var subs_color_pick_xray=get_subs(scene,"COLOR_PICKING_XRAY");if(subs_color_pick_xray){m_prerender.prerender_subs(subs_color_pick_xray,subs_color_pick_xray.camera);m_render.draw(subs_color_pick_xray,subs_color_pick_xray.bundles);var cam=subs_color_pick_xray.camera}else var cam=subs_color_pick.camera;
viewport_xy[1]=cam.height-viewport_xy[1];var color=m_render.read_pixels(cam.framebuffer,viewport_xy[0],viewport_xy[1]);return color}else m_print.error("Object Selection is not available on the scene");return null};exports.set_outline_color=set_outline_color;function set_outline_color(color){var scene=get_active();var subs=get_subs(scene,"OUTLINE");if(subs){subs.outline_color.set(color);subs.need_perm_uniforms_update=true}}exports.get_wind=get_wind;function get_wind(scene){return scene._render.wind}
exports.get_meta_tags=function(scene){var tags={title:"",description:""};if(scene["b4w_tags"]){tags.title=scene["b4w_tags"]["title"];tags.description=scene["b4w_tags"]["description"]}return tags};exports.update_cube_reflect_subs=function(subs,trans){var vm_trans=_vec3_tmp;m_vec3.negate(trans,vm_trans);for(var i=0;i<6;i++){var vm=subs.cube_view_matrices[i];var frustum=subs.cube_cam_frustums[i];var cam=subs.camera;m_mat4.translate(m_util.INV_CUBE_VIEW_MATRS[i],vm_trans,vm);m_mat4.multiply(cam.proj_matrix,
vm,cam.view_proj_matrix);m_util.extract_frustum_planes(cam.view_proj_matrix,frustum)}};exports.update_plane_reflect_subs=function(subs,trans,quat){var cam=subs.camera;m_util.trans_quat_to_plane(trans,quat,m_util.AXIS_Y,cam.reflection_plane)};exports.assign_scene_data_subs=function(scene,scene_objs,lamps){var shadow_params=scene._render.shadow_params;var reflection_params=scene._render.reflection_params;var use_ssao=cfg_def.ssao&&scene["b4w_enable_ssao"];var shadow_lamps=m_obj_util.get_shadow_lamps(lamps,
use_ssao);if(reflection_params)for(var i=0;i<scene_objs.length;i++){var obj=scene_objs[i];var sc_data=m_obj_util.get_scene_data(obj,scene);if(obj.render.plane_reflection_id!=null){var plane_refl_subs=reflection_params.plane_refl_subs;var plane_refl_subs_blend=reflection_params.plane_refl_subs_blend;var refl_id=obj.render.plane_reflection_id;if(plane_refl_subs_blend.length)sc_data.plane_refl_subs=plane_refl_subs_blend[refl_id];else if(plane_refl_subs.length)sc_data.plane_refl_subs=plane_refl_subs[refl_id]}else if(obj.render.cube_reflection_id!=
null){var cube_refl_subs=reflection_params.cube_refl_subs;var cube_refl_subs_blend=reflection_params.cube_refl_subs_blend;var refl_id=obj.render.cube_reflection_id;if(cube_refl_subs_blend.length)sc_data.cube_refl_subs=cube_refl_subs_blend[refl_id];else if(cube_refl_subs.length)sc_data.cube_refl_subs=cube_refl_subs[refl_id]}}for(var i=0;i<shadow_lamps.length;i++){var sc_data=m_obj_util.get_scene_data(shadow_lamps[i],scene);if(shadow_params){var shadow_subscenes=subs_array(scene,["SHADOW_CAST"]);for(var j=
0;j<shadow_subscenes.length;j++)if(i==shadow_subscenes[j].shadow_lamp_index)sc_data.shadow_subscenes.push(shadow_subscenes[j])}}};function get_plane_refl_id_by_subs(scene,subs){var refl_subs=scene._render.reflection_params.plane_refl_subs;for(var i=0;i<refl_subs.length;i++)for(var j=0;j<refl_subs[i].length;j++)if(refl_subs[i][j]==subs)return i;var refl_subs_blend=scene._render.reflection_params.plane_refl_subs_blend;for(var i=0;i<refl_subs_blend.length;i++)for(var j=0;j<refl_subs_blend[i].length;j++)if(refl_subs_blend[i][j]==
subs)return i;return null}function get_cube_refl_id_by_subs(scene,subs){if(!scene._render.reflection_params)return null;var refl_subs=scene._render.reflection_params.cube_refl_subs;for(var i=0;i<refl_subs.length;i++)if(refl_subs[i]==subs)return i;var refl_subs_blend=scene._render.reflection_params.cube_refl_subs_blend;for(var i=0;i<refl_subs_blend.length;i++)if(refl_subs_blend[i]==subs)return i;return null}exports.marker_frame=function(scene,name){return scene["timeline_markers"][name]};exports.set_hmd_params=
function(hmd_params){var active_scene=get_active();var subs_stereo=get_subs(active_scene,"STEREO");if(!subs_stereo)return;if(hmd_params.distortion_coefs){subs_stereo.distortion_params[0]=hmd_params.distortion_coefs[0];subs_stereo.distortion_params[1]=hmd_params.distortion_coefs[1];subs_stereo.need_perm_uniforms_update=true}if(hmd_params.chromatic_aberration_coefs){subs_stereo.chromatic_aberration_coefs[0]=hmd_params.chromatic_aberration_coefs[0];subs_stereo.chromatic_aberration_coefs[1]=hmd_params.chromatic_aberration_coefs[1];
subs_stereo.chromatic_aberration_coefs[2]=hmd_params.chromatic_aberration_coefs[2];subs_stereo.chromatic_aberration_coefs[3]=hmd_params.chromatic_aberration_coefs[3];subs_stereo.need_perm_uniforms_update=true}if(hmd_params.base_line_factor){subs_stereo.distortion_params[2]=hmd_params.base_line_factor;subs_stereo.need_perm_uniforms_update=true}if(hmd_params.inter_lens_factor){subs_stereo.distortion_params[3]=hmd_params.inter_lens_factor;subs_stereo.need_perm_uniforms_update=true}if(hmd_params.enable_hmd_stereo){subs_stereo.enable_hmd_stereo=
hmd_params.enable_hmd_stereo;subs_stereo.need_perm_uniforms_update=true}};exports.multiply_size_mult=function(multiplier_x,multiplier_y){var scenes=get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];var graph=exports.get_graph(scene);m_scgraph.multiply_size_mult_by_graph(graph,multiplier_x,multiplier_y)}}};b4w.module["__physics"]=function(exports,require){var m_cfg=require("__config");var m_debug=require("__debug");var m_ipc=require("__ipc");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_quat=require("__quat");var m_scs=require("__scenes");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_version=require("__version");var cfg_phy=m_cfg.physics;var cfg_def=m_cfg.defaults;var cfg_ldr=m_cfg.assets;var RAY_CMP_PRECISION=
1E-7;var _phy_fps=0;var _workers=[];var _scenes=[];var _bounding_objects={};var _bounding_objects_arr=[];var _collision_ids=["ANY"];var _unique_counter={body:0,constraint:0,ray_test:0};var _vec3_tmp=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _quat4_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);var _tsr_tmp=m_tsr.create();var _tsr_tmp2=m_tsr.create();var VT_CHASSIS=10;var VT_HULL=20;exports.init_scene_physics=function(scene){scene._physics={worker_loaded:false,bundles:[],
ray_tests:{},ray_tests_arr:[]};var path=cfg_phy.uranium_path;if(cfg_ldr.prevent_caching)path+=m_version.timestamp();m_print.log("%cLOAD PHYSICS","color: #0a0",cfg_phy.use_workers?"Using Separate Worker Thread,":"Using Same Thread,","Max FPS: "+cfg_phy.max_fps);m_print.log("%cPHYSICS PATH","color: #0a0",path);var worker=m_ipc.create_worker(path,!cfg_phy.use_workers);m_ipc.attach_handler(worker,process_message);_workers.push(worker);_scenes.push(scene);if(cfg_phy.ping)setInterval(function(){m_ipc.post_msg(worker,
m_ipc.OUT_PING,performance.now())},1E3)};exports.check_worker_loaded=function(scene){if(scene._physics)return scene._physics.worker_loaded;else return true};exports.cleanup=function(){for(var i=0;i<_workers.length;i++)m_ipc.terminate(_workers[i]);_workers.length=0;_scenes.length=0;_bounding_objects={};_bounding_objects_arr.length=0;_collision_ids.length=0;for(var cnt in _unique_counter)_unique_counter[cnt]=0};function add_compound_children(parent,container){var children=parent.cons_descends;for(var i=
0;i<children.length;i++){if(children[i].physics_settings.use_collision_compound)container.push(children[i]);add_compound_children(children[i],container)}return null}exports.append_object=function(obj,scene){var render=obj.render;if(!render)throw"No object render: "+obj.name;var phy_set=obj.physics_settings;var worker=find_worker_by_scene(scene);var compound_children=[];if(phy_set.use_collision_compound)add_compound_children(obj,compound_children);var bundles=scene._physics.bundles;if(is_vehicle_chassis(obj)||
is_vehicle_hull(obj)||is_character(obj)||is_floater_main(obj)||obj.use_obj_physics){var phy=init_bounding_physics(obj,compound_children,worker);obj.physics=phy;var pb={batch:null,physics:phy};bundles.push(pb);recalc_collision_tests(scene,worker,phy.collision_id)}else{var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.type!="PHYSICS"||has_batch(scene,batch))continue;if(!batch.submesh.base_length){m_print.error("Object "+
obj.name+" has collision material with no assigned vertices");continue}if(batch.water&&scene._render.water_params){init_water_physics(batch,scene,worker);continue}if(batch.use_ghost)var phy=init_ghost_mesh_physics(obj,batch,worker);else var phy=init_static_mesh_physics(obj,batch,worker);obj.physics=phy;var pb={batch:batch,physics:phy};bundles.push(pb);recalc_collision_tests(scene,worker,phy.collision_id)}}if(is_vehicle_chassis(obj)||is_vehicle_hull(obj)){init_vehicle(obj,worker);update_vehicle_controls(obj,
obj.vehicle,worker)}else if(is_character(obj))init_character(obj,worker);else if(is_floater_main(obj))init_floater(obj,worker);for(var i=0;i<_bounding_objects_arr.length;i++){var obj=_bounding_objects_arr[i];if(obj.physics)process_rigid_body_joints(obj)}};function recalc_collision_tests(scene,worker,collision_id){var bundles=scene._physics.bundles;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];if(test.collision_id==
"ANY"||collision_id==test.collision_id)append_collision_pairs(test,scene,worker)}}}function has_batch(scene,batch){var pbundles=scene._physics.bundles;for(var i=0;i<pbundles.length;i++){var pbatch=pbundles[i].batch;if(pbatch&&pbatch.id==batch.id)return true}return false}function process_message(worker,msg_id,msg){if(!m_ipc.is_active(worker))return;switch(msg_id){case m_ipc.IN_LOADED:var scene=find_scene_by_worker(worker);scene._physics.worker_loaded=true;var fallback_init_time=Date.now()-performance.now();
m_ipc.post_msg(worker,m_ipc.OUT_INIT,fallback_init_time,cfg_phy.max_fps,cfg_phy.calc_fps?cfg_def.fps_measurement_interval:0);break;case m_ipc.IN_LOG:m_print.log_raw("URANIUM:",msg.slice(1));break;case m_ipc.IN_ERROR:m_print.error(msg);break;case m_ipc.IN_FBMSG:m_debug.fbmsg.apply(this,msg.slice(1));break;case m_ipc.IN_TRANSFORM:var obj=find_obj_by_body_id(msg.body_id);if(obj)update_interpolation_data(obj,msg.time,msg.trans,msg.quat,msg.linvel,msg.angvel);break;case m_ipc.IN_PROP_OFFSET:var obj_chassis_hull=
find_obj_by_body_id(msg.chassis_hull_body_id);if(obj_chassis_hull)update_prop_offset(obj_chassis_hull,msg.prop_ind,msg.trans,msg.quat);break;case m_ipc.IN_FLOATER_BOB_TRANSFORM:var obj_floater=find_obj_by_body_id(msg[1]);if(obj_floater)update_floater_bob_coords(obj_floater,msg[2],msg[3],msg[4]);break;case m_ipc.IN_VEHICLE_SPEED:var obj=find_obj_by_body_id(msg[1]);if(obj)obj.vehicle.speed=msg[2];break;case m_ipc.IN_COLLISION:var scene=find_scene_by_worker(worker);traverse_collision_tests(scene,msg.body_id_a,
msg.body_id_b,msg.result,null,null,0);break;case m_ipc.IN_COLLISION_POS_NORM:var scene=find_scene_by_worker(worker);traverse_collision_tests(scene,msg.body_id_a,msg.body_id_b,msg.result,msg.coll_point,msg.coll_norm,msg.coll_dist);break;case m_ipc.IN_COLLISION_IMPULSE:var obj=find_obj_by_body_id(msg[1]);if(obj){var phy=obj.physics;if(phy.col_imp_test_cb)phy.col_imp_test_cb(msg[2])}break;case m_ipc.IN_RAY_HIT:case m_ipc.IN_RAY_HIT_POS_NORM:var scene=find_scene_by_worker(worker);var sphy=scene._physics;
var test=sphy.ray_tests[msg.id];if(test){var body_id_hit=msg.body_id_hit;var obj_hit=find_obj_by_body_id(body_id_hit);if(msg_id==m_ipc.IN_RAY_HIT)exec_ray_test_cb(test,msg.hit_fract,obj_hit,msg.hit_time,null,null);else exec_ray_test_cb(test,msg.hit_fract,obj_hit,msg.hit_time,msg.hit_pos,msg.hit_norm)}break;case m_ipc.IN_REMOVE_RAY_TEST:remove_ray_test(id);break;case m_ipc.IN_PING:var idx=_workers.indexOf(worker);var out_time=(msg[2]-msg[1]).toFixed(3);var in_time=(performance.now()-msg[2]).toFixed(3);
var all_time=(performance.now()-msg[1]).toFixed(3);console.log("Physics #"+idx+" Ping: OUT "+out_time+" ms, IN "+in_time+" ms, ALL "+all_time+" ms");break;case m_ipc.IN_FPS:_phy_fps=msg[1];break;case m_ipc.IN_DEBUG_STATS:var idx=_workers.indexOf(worker);console.log("Worker: #"+String(idx));console.log(msg[1]);break;default:m_print.error("Wrong message: "+msg_id);break}}function find_scene_by_worker(worker){for(var i=0;i<_workers.length;i++)if(_workers[i]==worker)return _scenes[i]}function find_worker_by_scene(scene){for(var i=
0;i<_scenes.length;i++)if(_scenes[i]==scene)return _workers[i]}exports.find_obj_by_body_id=find_obj_by_body_id;function find_obj_by_body_id(body_id){return _bounding_objects[body_id]||null}function update_interpolation_data(obj,time,trans,quat,linvel,angvel){var phy=obj.physics;phy.curr_time=time;m_tsr.set_sep(trans,1,quat,phy.curr_tsr);m_vec3.copy(linvel,phy.linvel);m_vec3.copy(angvel,phy.angvel)}function update_prop_offset(obj_chassis_hull,prop_num,trans,quat){var prop_offset=obj_chassis_hull.vehicle.prop_offsets[prop_num];
m_tsr.set_sep(trans,1,quat,prop_offset)}function update_floater_bob_coords(obj_floater,bob_num,trans,quat){var obj_bob=obj_floater.floater.bobs[bob_num];m_trans.set_translation(obj_bob,trans);m_trans.set_rotation(obj_bob,quat);m_trans.update_transform(obj_bob)}function traverse_collision_tests(scene,body_id_a,body_id_b,pair_result,coll_pos,coll_norm,coll_dist){var bundles=scene._physics.bundles;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=
phy.collision_tests[j];var pairs=test.pairs;var results_changed=false;for(var k=0;k<pairs.length;k++){var pair=pairs[k];if(pair[0]===body_id_a&&pair[1]===body_id_b){test.pair_results[k]=pair_result;results_changed=true;break}}if(results_changed){var pair_results=test.pair_results;var result=calc_coll_result(test);if(coll_pos&&test.body_id_src!=body_id_a)correct_coll_pos_norm(coll_pos,coll_norm,coll_dist);if(!result)var coll_obj=null;else if(test.body_id_src==body_id_a)var coll_obj=find_obj_by_body_id(body_id_b);
else var coll_obj=find_obj_by_body_id(body_id_a);test.callback(result,coll_obj,coll_pos,coll_norm,coll_dist)}}}}function calc_coll_result(test){var pair_results=test.pair_results;var result=false;for(var i=0;i<pair_results.length;i++)result=result||pair_results[i];return result}function correct_coll_pos_norm(pos,norm,dist){pos[0]=pos[0]+norm[0]*dist;pos[1]=pos[1]+norm[1]*dist;pos[2]=pos[2]+norm[2]*dist;norm[0]*=-1;norm[1]*=-1;norm[2]*=-1}function exec_ray_test_cb(test,hit_fract,obj_hit,hit_time,hit_pos,
hit_norm){var collision_id=test.collision_id;var callback=test.callback;if(hit_pos)callback(test.id,hit_fract,obj_hit,hit_time,hit_pos,hit_norm);else callback(test.id,hit_fract,obj_hit,hit_time)}exports.update=function(timeline,delta){for(var i=0;i<_workers.length;i++){update_worker(_workers[i],timeline,delta);var scene=_scenes[i];var wp=scene._render.water_params;if(wp&&wp.waves_height>0){var subs=m_scs.get_subs(scene,"MAIN_OPAQUE");var wind=m_vec3.length(subs.wind);m_ipc.post_msg(_workers[i],m_ipc.OUT_SET_WATER_TIME,
subs.time*wind)}}};function update_worker(worker,timeline,delta){if(worker&&m_ipc.is_fallback(worker))m_ipc.post_msg(worker,m_ipc.OUT_UPDATE_WORLD,timeline,delta);for(var i=0;i<_bounding_objects_arr.length;i++){var obj=_bounding_objects_arr[i];var phy=obj.physics;if(phy.simulated&&phy.curr_time){if(m_ipc.is_fallback(worker))var d=timeline-phy.curr_time;else var d=performance.now()/1E3-phy.curr_time;d=Math.min(d,10*1/cfg_phy.max_fps);d-=1/cfg_phy.max_fps;if(cfg_def.no_phy_interp_hack)d=0;var tsr=_tsr_tmp;
m_tsr.integrate(phy.curr_tsr,d,phy.linvel,phy.angvel,_tsr_tmp);m_trans.set_tsr(obj,tsr);m_trans.update_transform(obj);sync_transform(obj);if(obj.vehicle)update_prop_transforms(obj);if(obj.vehicle&&obj.vehicle.steering_wheel)update_steering_wheel_coords(obj);if(obj.vehicle&&obj.vehicle.speedometer)update_speedometer(obj);if(obj.vehicle&&obj.vehicle.tachometer)update_tachometer(obj)}}m_ipc.post_msg_arr(worker)}function update_prop_transforms(obj_chassis_hull){var obj_props=obj_chassis_hull.vehicle.props;
var chass_hull_tsr=obj_chassis_hull.render.world_tsr;var prop_tsr=_tsr_tmp;for(var i=0;i<obj_props.length;i++){var obj_prop=obj_props[i];var prop_offset=obj_chassis_hull.vehicle.prop_offsets[i];m_tsr.multiply(chass_hull_tsr,prop_offset,prop_tsr);m_trans.set_tsr(obj_prop,prop_tsr);m_trans.update_transform(obj_prop)}}exports.get_active_scene=function(){return _scenes[0]};exports.pause=function(){for(var i=0;i<_workers.length;i++)m_ipc.post_msg(_workers[i],m_ipc.OUT_PAUSE)};exports.resume=function(){for(var i=
0;i<_workers.length;i++)m_ipc.post_msg(_workers[i],m_ipc.OUT_RESUME)};function get_unique_body_id(){_unique_counter.body++;return _unique_counter.body}function init_water_physics(batch,scene,worker){var wp=scene._render.water_params;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_WATER,wp.water_level);if(batch.water_dynamics){var water_dyn_info={};water_dyn_info["dst_noise_scale0"]=batch.dst_noise_scale0;water_dyn_info["dst_noise_scale1"]=batch.dst_noise_scale1;water_dyn_info["dst_noise_freq0"]=batch.dst_noise_freq0;
water_dyn_info["dst_noise_freq1"]=batch.dst_noise_freq1;water_dyn_info["dir_min_shore_fac"]=batch.dir_min_shore_fac;water_dyn_info["dir_freq"]=batch.dir_freq;water_dyn_info["dir_noise_scale"]=batch.dir_noise_scale;water_dyn_info["dir_noise_freq"]=batch.dir_noise_freq;water_dyn_info["dir_min_noise_fac"]=batch.dir_min_noise_fac;water_dyn_info["dst_min_fac"]=batch.dst_min_fac;water_dyn_info["waves_hor_fac"]=batch.waves_hor_fac;var waves_height=wp.waves_height;var waves_length=wp.waves_length;if(wp.shoremap_image){var size_x=
wp.shoremap_size[0];var size_y=wp.shoremap_size[1];var center_x=wp.shoremap_center[0];var center_y=wp.shoremap_center[1];var max_shore_dist=wp.max_shore_dist;var array_width=wp.shoremap_tex_size;m_ipc.post_msg(worker,m_ipc.OUT_ADD_WATER_WRAPPER,water_dyn_info,size_x,size_y,center_x,center_y,max_shore_dist,waves_height,waves_length,array_width,scene._render.shore_distances)}else m_ipc.post_msg(worker,m_ipc.OUT_ADD_WATER_WRAPPER,water_dyn_info,0,0,0,0,0,waves_height,waves_length,0,null)}}function init_static_mesh_physics(obj,
batch,worker){var body_id=get_unique_body_id();var submesh=batch.submesh;var positions=submesh.va_frames[0]["a_position"];var indices=submesh.indices||null;var trans=m_tsr.get_trans_view(obj.render.world_tsr);var friction=batch.friction;var restitution=batch.elasticity;var collision_id=batch.collision_id;var collision_id_num=col_id_num(collision_id);var collision_margin=batch.collision_margin;var collision_group=batch.collision_group;var collision_mask=batch.collision_mask;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_STATIC_MESH_BODY,
body_id,positions,indices,trans,friction,restitution,collision_id_num,collision_margin,collision_group,collision_mask);var phy=init_physics(body_id,"STATIC_MESH");phy.collision_id=collision_id;phy.collision_id_num=collision_id_num;return phy}function col_id_num(id){var num=_collision_ids.indexOf(id);if(num==-1){_collision_ids.push(id);return _collision_ids.length-1}else return num}function init_physics(body_id,type){var phy={body_id:body_id,type:type,mass:0,is_ghost:false,simulated:true,is_vehicle:false,
is_character:false,is_floater:false,cons_id:null,collision_id:"",collision_id_num:0,collision_callbacks:{},collision_tests:[],col_imp_test_cb:null,curr_time:0,curr_tsr:new Float32Array([0,0,0,1,0,0,0,1]),linvel:new Float32Array(3),angvel:new Float32Array(3),cached_trans:new Float32Array(3),cached_quat:new Float32Array(4)};return phy}function init_ghost_mesh_physics(obj,batch,worker){var body_id=get_unique_body_id();var submesh=batch.submesh;var positions=submesh.va_frames[0]["a_position"];var indices=
submesh.indices||null;var collision_id=batch.collision_id;var collision_id_num=col_id_num(collision_id);var collision_margin=batch.collision_margin;var collision_group=batch.collision_group;var collision_mask=batch.collision_mask;var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_GHOST_MESH_BODY,body_id,positions,indices,trans,collision_id_num,collision_margin,collision_group,collision_mask);var phy=init_physics(body_id,"STATIC_MESH");phy.is_ghost=true;phy.collision_id=
collision_id;phy.collision_id_num=collision_id_num;return phy}function init_bounding_physics(obj,compound_children,worker){var render=obj.render;var phy_set=obj.physics_settings;var physics_type=phy_set.physics_type;var bb=render.bb_local;var body_id=get_unique_body_id();if(obj.type=="CAMERA"){var bounding_type=phy_set.use_collision_bounds?phy_set.collision_bounds_type:"BOX";var bounding_object=find_bounding_type(bounding_type,render);var friction=render.friction;var restitution=render.elasticity;
var friction=.5;var restitution=0}else if(obj.type=="EMPTY"){var bounding_type="EMPTY";var bounding_object=null;var friction=0;var restitution=0}else{var bounding_type=phy_set.use_collision_bounds?phy_set.collision_bounds_type:"BOX";var bounding_object=find_bounding_type(bounding_type,render);var scale=m_tsr.get_scale(render.world_tsr);if(scale!=1)scale_bounding(bounding_object,bounding_type,scale);var friction=render.friction;var restitution=render.elasticity}var trans=m_tsr.get_trans_view(render.world_tsr);
var quat=m_tsr.get_quat_view(render.world_tsr);var is_ghost=phy_set.use_ghost;var disable_sleeping=phy_set.use_sleep;var mass=phy_set.mass;var velocity_min=phy_set.velocity_min;var velocity_max=phy_set.velocity_max;var damping=phy_set.damping;var rotation_damping=phy_set.rotation_damping;var collision_id=obj.collision_id;var collision_id_num=col_id_num(collision_id);var collision_margin=phy_set.collision_margin;var collision_group=phy_set.collision_group;var collision_mask=phy_set.collision_mask;
var size=render.bs_local.radius;var worker_bounding=create_worker_bounding(bounding_object);var correct_bound_offset=obj.correct_bounding_offset;var comp_children_params=get_children_params(render,compound_children,bounding_type,worker_bounding);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_BOUNDING_BODY,body_id,trans,quat,physics_type,is_ghost,disable_sleeping,mass,velocity_min,velocity_max,damping,rotation_damping,collision_id_num,collision_margin,collision_group,collision_mask,bounding_type,worker_bounding,
size,friction,restitution,comp_children_params,correct_bound_offset);_bounding_objects[body_id]=obj;_bounding_objects_arr.push(obj);var phy=init_physics(body_id,"BOUNDING");phy.type=physics_type;phy.mass=mass;phy.is_ghost=is_ghost;phy.collision_id=collision_id;phy.collision_id_num=collision_id_num;return phy}function get_children_params(render,children,bt,wb){if(!children.length)return[];var comp_children_params=[];var parent_params={};parent_params["quat"]=new Float32Array([0,0,0,1]);parent_params["trans"]=
new Float32Array(3);parent_params["worker_bounding"]=wb;parent_params["bounding_type"]=bt;comp_children_params.push(parent_params);var wtsr_inv=m_tsr.invert(render.world_tsr,_tsr_tmp);var quat_inv=_quat4_tmp;var quat=m_tsr.get_quat_view(render.world_tsr);m_quat.invert(quat,quat_inv);for(var i=0;i<children.length;i++){var child_params={};var child=children[i];var child_bt=child.physics_settings.collision_bounds_type;var loc_quat=new Float32Array(4);var loc_trans=new Float32Array(3);var ch_trans=m_tsr.get_trans_view(child.render.world_tsr);
var ch_quat=m_tsr.get_quat_view(child.render.world_tsr);m_tsr.transform_vec3(ch_trans,wtsr_inv,loc_trans);m_quat.multiply(quat_inv,ch_quat,loc_quat);child_params["trans"]=loc_trans;child_params["quat"]=loc_quat;child_params["bounding_type"]=child_bt;child_params["worker_bounding"]=create_worker_bounding(find_bounding_type(child_bt,child.render));comp_children_params.push(child_params)}return comp_children_params}function find_bounding_type(bounding_type,render){switch(bounding_type){case "BOX":var bounding_object=
render.bb_local;break;case "CYLINDER":var bounding_object=render.bcyl_local;break;case "CONE":var bounding_object=render.bcon_local;break;case "SPHERE":var bounding_object=render.bs_local;break;case "CAPSULE":var bounding_object=render.bcap_local;break}return bounding_object}function scale_bounding(bound,bounding_type,scale){switch(bounding_type){case "BOX":bound.min_x*=scale;bound.max_x*=scale;bound.min_y*=scale;bound.max_y*=scale;bound.min_z*=scale;bound.max_z*=scale;break;case "CYLINDER":case "CONE":case "CAPSULE":bound.height*=
scale;bound.radius*=scale;break;case "SPHERE":bound.radius*=scale;break}}function create_worker_bounding(bounding_object){if(!bounding_object)return null;var in_obj=bounding_object;var out_obj={};if(typeof in_obj.min_x==="number")out_obj["min_x"]=in_obj.min_x;if(typeof in_obj.min_y==="number")out_obj["min_y"]=in_obj.min_y;if(typeof in_obj.min_z==="number")out_obj["min_z"]=in_obj.min_z;if(typeof in_obj.max_x==="number")out_obj["max_x"]=in_obj.max_x;if(typeof in_obj.max_y==="number")out_obj["max_y"]=
in_obj.max_y;if(typeof in_obj.max_z==="number")out_obj["max_z"]=in_obj.max_z;if(typeof in_obj.center==="object")out_obj["center"]=in_obj.center;if(typeof in_obj.radius==="number")out_obj["radius"]=in_obj.radius;if(typeof in_obj.height==="number")out_obj["height"]=in_obj.height;return out_obj}function init_vehicle(obj,worker){var body_id=obj.physics.body_id;if(is_vehicle_chassis(obj)){obj.vehicle.type=VT_CHASSIS;var susp_compress=obj.vehicle.suspension_compression;var susp_stiffness=obj.vehicle.suspension_stiffness;
var susp_damping=obj.vehicle.suspension_damping;var wheel_friction=obj.vehicle.wheel_friction;var max_suspension_travel_cm=obj.vehicle.max_suspension_travel_cm;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_CAR,body_id,susp_compress,susp_stiffness,susp_damping,wheel_friction,max_suspension_travel_cm)}else if(is_vehicle_hull(obj)){obj.vehicle.type=VT_HULL;var floating_factor=obj.vehicle.floating_factor;var water_lin_damp=obj.vehicle.water_lin_damp;var water_rot_damp=obj.vehicle.water_rot_damp;m_ipc.post_msg(worker,
m_ipc.OUT_APPEND_BOAT,body_id,floating_factor,water_lin_damp,water_rot_damp)}if(obj.vehicle.props){var props=obj.vehicle.props;switch(obj.vehicle.type){case VT_CHASSIS:add_vehicle_prop(props[1],obj,body_id,true,worker);add_vehicle_prop(props[0],obj,body_id,true,worker);add_vehicle_prop(props[3],obj,body_id,false,worker);add_vehicle_prop(props[2],obj,body_id,false,worker);break;case VT_HULL:for(var i=0;i<props.length;i++)add_vehicle_prop(props[i],obj,body_id,false,worker);break}}}function add_vehicle_prop(obj_prop,
obj_chassis_hull,chassis_body_id,is_front,worker){var prop_trans=m_tsr.get_trans_view(obj_prop.render.world_tsr);var chassis_hull_tsr_inv=m_tsr.invert(obj_chassis_hull.render.world_tsr,_tsr_tmp);var conn_point=new Float32Array(3);m_tsr.transform_vec3(prop_trans,chassis_hull_tsr_inv,conn_point);switch(obj_chassis_hull.vehicle.type){case VT_CHASSIS:var v_set=obj_chassis_hull.vehicle_settings;var suspension_rest_length=v_set.suspension_rest_length;var roll_influence=v_set.roll_influence;var bb=obj_prop.render.bb_local;
var radius=(bb.max_y-bb.min_y)/2;m_ipc.post_msg(worker,m_ipc.OUT_ADD_CAR_WHEEL,chassis_body_id,conn_point,suspension_rest_length,roll_influence,radius,is_front);break;case VT_HULL:m_ipc.post_msg(worker,m_ipc.OUT_ADD_BOAT_BOB,chassis_body_id,conn_point,obj_prop.synchronize_pos);break}}function init_character(obj,worker){var render=obj.render;var phy=obj.physics;var height=render.bb_local.max_y-render.bb_local.min_y;var character_id=phy.body_id;var char_settings=obj.character_settings;var walk_speed=
char_settings.walk_speed;var run_speed=char_settings.run_speed;var step_height=char_settings.step_height;var jump_strength=char_settings.jump_strength;var waterline=char_settings.waterline;var rot_angle=m_util.dir_ground_proj_angle(obj);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_CHARACTER,character_id,rot_angle,height,walk_speed,run_speed,step_height,jump_strength,waterline);phy.is_character=true}function init_floater(obj,worker){var floating_factor=obj.floater.floating_factor;var water_lin_damp=obj.floater.water_lin_damp;
var water_rot_damp=obj.floater.water_rot_damp;var body_id=obj.physics.body_id;m_ipc.post_msg(worker,m_ipc.OUT_APPEND_FLOATER,body_id,floating_factor,water_lin_damp,water_rot_damp);if(obj.floater.bobs){var bob_objs=obj.floater.bobs;for(var i=0;i<bob_objs.length;i++){var obj_bob=bob_objs[i];var bob_trans=m_tsr.get_trans_view(obj_bob.render.world_tsr);var wtsr_inv=m_tsr.invert(obj.render.world_tsr,_tsr_tmp);var conn_point=new Float32Array(3);m_tsr.transform_vec3(bob_trans,wtsr_inv,conn_point);m_ipc.post_msg(worker,
m_ipc.OUT_ADD_FLOATER_BOB,body_id,conn_point,obj_bob.bob_synchronize_pos)}}obj.physics.is_floater=true}exports.enable_simulation=function(obj){var phy=obj.physics;if(!phy)throw"No object physics";if(phy.simulated)return;var body_id=phy.body_id;var worker=find_worker_by_body_id(body_id);phy.simulated=true;m_ipc.post_msg(worker,m_ipc.OUT_ENABLE_SIMULATION,body_id)};exports.disable_simulation=function(obj){var phy=obj.physics;if(!phy)throw"No object physics";if(!phy.simulated)return;var body_id=phy.body_id;
var worker=find_worker_by_body_id(body_id);phy.simulated=false;m_ipc.post_msg(worker,m_ipc.OUT_DISABLE_SIMULATION,body_id)};exports.scene_has_physics=scene_has_physics;function scene_has_physics(scene){return Boolean(scene._physics)}exports.obj_has_physics=obj_has_physics;function obj_has_physics(obj){return Boolean(obj.physics)}exports.has_dynamic_physics=function(obj){var phy=obj.physics;if(phy&&phy.simulated&&(phy.type=="RIGID_BODY"||phy.type=="DYNAMIC")&&phy.mass>0&&phy.is_ghost==false)return true;
else return false};exports.has_simulated_physics=function(obj){var phy=obj.physics;if(phy&&phy.simulated)return true;else return false};exports.set_gravity=function(obj,gravity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_GRAVITY,body_id,gravity)};function process_rigid_body_joints(obj){if(has_constraint(obj))return;for(var i=0;i<obj.physics_constraints.length;i++){var cons=obj.physics_constraints[i];var targ=cons.target;var pivot_type=
cons.pivot_type;if(!targ.physics)continue;var trans=get_rbj_trans(cons);var quat=get_rbj_quat(cons);var local=m_tsr.identity(_tsr_tmp);local=m_tsr.set_trans(trans,local);local=m_tsr.set_quat(quat,local);var world_a=m_tsr.multiply(obj.render.world_tsr,local,_tsr_tmp);var world_b_inv=m_tsr.invert(targ.render.world_tsr,_tsr_tmp2);var local_b=m_tsr.multiply(world_b_inv,world_a,world_b_inv);var local_b_tra=m_tsr.get_trans_view(local_b);var local_b_qua=m_tsr.get_quat_view(local_b);var limits=prepare_limits(cons);
apply_constraint(pivot_type,obj,trans,quat,targ,local_b_tra,local_b_qua,limits,null,null)}}exports.has_constraint=has_constraint;function has_constraint(obj){return obj.physics&&obj.physics.cons_id}function get_rbj_trans(cons){var trans=new Float32Array([cons.pivot_x,cons.pivot_y,cons.pivot_z]);return trans}function get_rbj_quat(cons){var euler=new Float32Array([cons.axis_x,cons.axis_y,cons.axis_z]);var quat=m_util.euler_to_quat(euler,new Float32Array(4));return quat}function prepare_limits(cons){var limits=
{};limits["use_limit_x"]=cons.use_limit_x;limits["use_limit_y"]=cons.use_limit_y;limits["use_limit_z"]=cons.use_limit_z;limits["use_angular_limit_x"]=cons.use_angular_limit_x;limits["use_angular_limit_y"]=cons.use_angular_limit_y;limits["use_angular_limit_z"]=cons.use_angular_limit_z;limits["limit_max_x"]=cons.limit_max_x;limits["limit_min_x"]=cons.limit_min_x;limits["limit_max_y"]=cons.limit_max_y;limits["limit_min_y"]=cons.limit_min_y;limits["limit_max_z"]=cons.limit_max_z;limits["limit_min_z"]=
cons.limit_min_z;limits["limit_angle_max_x"]=cons.limit_angle_max_x;limits["limit_angle_min_x"]=cons.limit_angle_min_x;limits["limit_angle_max_y"]=cons.limit_angle_max_y;limits["limit_angle_min_y"]=cons.limit_angle_min_y;limits["limit_angle_max_z"]=cons.limit_angle_max_z;limits["limit_angle_min_z"]=cons.limit_angle_min_z;return limits}exports.apply_constraint=apply_constraint;function apply_constraint(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping){var cons_id=get_unique_constraint_id();
var body_a=obj_a.physics.body_id;var body_b=obj_b.physics.body_id;var worker=find_worker_by_body_id(body_a);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_CONSTRAINT,cons_id,pivot_type,limits,body_a,trans_a,quat_a,body_b,trans_b,quat_b,stiffness,damping);var phy=obj_a.physics;phy.cons_id=cons_id}function find_worker_by_body_id(body_id){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var bundles=scene._physics.bundles;for(var j=0;j<bundles.length;j++){var phy=bundles[j].physics;if(phy.body_id==body_id)return _workers[i]}}return null}
function get_unique_constraint_id(){_unique_counter.constraint++;return _unique_counter.constraint.toString(16)}exports.clear_constraint=function(obj_a){var phy=obj_a.physics;var cons_id=phy.cons_id;var worker=find_worker_by_body_id(body_a);m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_CONSTRAINT,cons_id);phy.cons_id=null};exports.pull_to_constraint_pivot=function(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b){var tsr_a=m_tsr.set_sep(trans_a,1,quat_a,_tsr_tmp);var tsr_b=m_tsr.set_sep(trans_b,1,quat_b,_tsr_tmp2);
m_tsr.invert(tsr_a,tsr_a);m_tsr.multiply(tsr_b,tsr_a,tsr_a);m_trans.get_tsr(obj_b,tsr_b);m_tsr.multiply(tsr_b,tsr_a,tsr_a);m_trans.set_tsr(obj_a,tsr_a);m_trans.update_transform(obj_a);var trans=m_tsr.get_trans_view(obj_a.render.world_tsr);var quat=m_tsr.get_quat_view(obj_a.render.world_tsr);exports.set_transform(obj_a,trans,quat)};exports.set_transform=function(obj,trans,quat){var phy=obj.physics;var obj_trans=m_tsr.get_trans_view(obj.render.world_tsr);var obj_quat=m_tsr.get_quat_view(obj.render.world_tsr);
m_tsr.set_sep(obj_trans,1,obj_quat,phy.curr_tsr);var msg_cache=m_ipc.get_msg_cache(m_ipc.OUT_SET_TRANSFORM);msg_cache.body_id=phy.body_id;msg_cache.trans=trans;msg_cache.quat=quat;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_TRANSFORM)};exports.sync_transform=sync_transform;function sync_transform(obj){if(allows_transform(obj)&&transform_changed(obj)){var phy=obj.physics;var render=obj.render;var trans=m_tsr.get_trans_view(render.world_tsr);var quat=m_tsr.get_quat_view(render.world_tsr);
m_vec3.copy(trans,phy.cached_trans);m_quat.copy(quat,phy.cached_quat);var msg_cache=m_ipc.get_msg_cache(m_ipc.OUT_SET_TRANSFORM);msg_cache.body_id=phy.body_id;msg_cache.trans=trans;if(phy.type=="DYNAMIC")m_quat.identity(msg_cache.quat);else msg_cache.quat=quat;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_TRANSFORM)}var cons_descends=obj.cons_descends;for(var i=0;i<cons_descends.length;i++)sync_transform(cons_descends[i])}function allows_transform(obj){var phy=
obj.physics;if(!phy)return false;else if(phy.mass===0)return true;else if(phy.is_ghost===true)return true;else if(phy.simulated===false)return true;else if(phy.type!=="RIGID_BODY"&&phy.type!=="DYNAMIC")return true;else return false}function transform_changed(obj){var trans=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);return trans[0]!=obj.physics.cached_trans[0]||trans[1]!=obj.physics.cached_trans[1]||trans[2]!=obj.physics.cached_trans[2]||quat[0]!=
obj.physics.cached_quat[0]||quat[1]!=obj.physics.cached_quat[1]||quat[2]!=obj.physics.cached_quat[2]||quat[3]!=obj.physics.cached_quat[3]}exports.apply_velocity=function(obj,vx_local,vy_local,vz_local){var v_world=_vec3_tmp;vector_to_world(obj,vx_local,vy_local,vz_local,v_world);var body_id=obj.physics.body_id;var vx0=0;var vy0=0;var vz0=0;var vx0a=Math.abs(vx0);var vy0a=Math.abs(vy0);var vz0a=Math.abs(vz0);var vxa=Math.abs(v_world[0]);var vya=Math.abs(v_world[1]);var vza=Math.abs(v_world[2]);v_world[0]=
vxa?v_world[0]/vxa*Math.max(vxa,vx0a):vx0;v_world[1]=vya?v_world[1]/vya*Math.max(vya,vy0a):vy0;v_world[2]=vza?v_world[2]/vza*Math.max(vza,vz0a):vz0;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_LINEAR_VELOCITY,body_id,v_world[0],v_world[1],v_world[2])};exports.apply_velocity_world=function(obj,vx,vy,vz){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_LINEAR_VELOCITY,body_id,vx,vy,vz)};function vector_to_world(obj,
vx_local,vy_local,vz_local,dest){var v=dest||new Float32Array(3);var quat=m_tsr.get_quat_view(obj.render.world_tsr);v[0]=vx_local;v[1]=vy_local;v[2]=vz_local;var v_world=m_vec3.transformQuat(v,quat,v);return v_world}exports.apply_force=apply_force;function apply_force(obj,fx_local,fy_local,fz_local,use_world){var f_world=_vec3_tmp;if(use_world){f_world[0]=fx_local;f_world[1]=fy_local;f_world[2]=fz_local}else vector_to_world(obj,fx_local,fy_local,fz_local,f_world);var body_id=obj.physics.body_id;var worker=
find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_APPLY_CENTRAL_FORCE,body_id,f_world[0],f_world[1],f_world[2])}exports.apply_torque=apply_torque;function apply_torque(obj,tx_local,ty_local,tz_local){var t_world=_vec3_tmp;vector_to_world(obj,tx_local,ty_local,tz_local,t_world);var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_APPLY_TORQUE,body_id,t_world[0],t_world[1],t_world[2])}exports.set_character_move_dir=function(obj,forw,
side){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_MOVE_DIR,body_id,forw,side)};exports.set_character_move_type=function(obj,type){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_MOVE_TYPE,body_id,type)};exports.set_character_walk_velocity=function(obj,velocity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,
m_ipc.OUT_SET_CHARACTER_WALK_VELOCITY,body_id,velocity)};exports.set_character_run_velocity=function(obj,velocity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_RUN_VELOCITY,body_id,velocity)};exports.set_character_fly_velocity=function(obj,velocity){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_FLY_VELOCITY,body_id,velocity)};exports.character_jump=
function(obj){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_CHARACTER_JUMP,body_id)};exports.character_rotation_inc=function(obj,h_angle,v_angle){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_CHARACTER_ROTATION_INCREMENT,body_id,h_angle,v_angle)};exports.set_character_rotation=function(obj,angle_h,angle_v){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);
m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_ROTATION,body_id,angle_h,angle_v)};exports.set_character_rotation_h=function(obj,angle){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_HOR_ROTATION,body_id,angle)};exports.set_character_rotation_v=function(obj,angle){var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);m_ipc.post_msg(worker,m_ipc.OUT_SET_CHARACTER_VERT_ROTATION,body_id,angle)};exports.append_collision_test=
function(obj_src,collision_id,callback,calc_pos_norm){var phy=obj_src.physics;var body_id_src=phy.body_id;var collision_id=collision_id||"ANY";for(var i=0;i<phy.collision_tests.length;i++){var test=phy.collision_tests[i];if(test.collision_id==collision_id&&test.callback==callback)return}var test={body_id_src:body_id_src,calc_pos_norm:calc_pos_norm||false,collision_id:collision_id,callback:callback,pairs:[],pair_results:[]};phy.collision_tests.push(test);var worker=find_worker_by_body_id(body_id_src);
var scene=find_scene_by_worker(worker);append_collision_pairs(test,scene,worker)};function append_collision_pairs(test,scene,worker){var pairs=test.pairs;var pair_results=test.pair_results;var body_id_a=test.body_id_src;var body_id_b_arr=[];collision_id_to_body_ids(test.collision_id,scene,body_id_b_arr,null);for(var i=0;i<body_id_b_arr.length;i++){var body_id_b=body_id_b_arr[i];if(body_id_a<body_id_b&&!has_pair(pairs,body_id_a,body_id_b)){pairs.push([body_id_a,body_id_b]);pair_results.push(false)}else if(body_id_a>
body_id_b&&!has_pair(pairs,body_id_b,body_id_a)){pairs.push([body_id_b,body_id_a]);pair_results.push(false)}}m_ipc.post_msg(worker,m_ipc.OUT_ACTIVATE,body_id_a);m_ipc.post_msg(worker,m_ipc.OUT_APPEND_COLLISION_TEST,pairs,test.calc_pos_norm)}function has_pair(pairs,body_id_a,body_id_b){for(var i=0;i<pairs.length;i++)if(pairs[i][0]==body_id_a&&pairs[i][1]==body_id_b)return true;return false}function gen_collision_body_ids(callbacks,bpy_scene,dest_arr,dest_obj){if("ANY"in callbacks){for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=
bpy_scene._physics.bundles[i];var body_id=bundle.physics.body_id;dest_arr.push(body_id);dest_obj[body_id]=0}return}for(var collision_id in callbacks)for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];if(bundle.physics.collision_id==collision_id){var body_id=bundle.physics.body_id;if(dest_arr.indexOf(body_id)==-1)dest_arr.push(body_id);dest_obj[body_id]=0}}}exports.remove_collision_test=function(obj,collision_id,callback){var phy=obj.physics;var body_id=phy.body_id;
var worker=find_worker_by_body_id(body_id);var scene=find_scene_by_worker(worker);for(var i=0;i<phy.collision_tests.length;i++){var test=phy.collision_tests[i];if(test.collision_id==collision_id&&test.callback==callback){if(calc_coll_result(test)){var zero=m_vec3.set(0,0,0,_vec3_tmp);test.callback(false,null,zero,zero,0)}phy.collision_tests.splice(i,1);i--;remove_unused_collision_pairs(scene,worker,test.pairs)}}};function remove_unused_collision_pairs(scene,worker,pairs){var bundles=scene._physics.bundles;
var unused_pairs=pairs;for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];for(var k=0;k<test.pairs.length;k++){var pair=test.pairs[k];for(var l=0;l<unused_pairs.length;l++){var unused_pair=unused_pairs[l];if(pair[0]==unused_pair[0]&&pair[1]==unused_pair[1]){unused_pairs.splice(l,1);l--}}}}}if(unused_pairs.length)m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_COLLISION_TEST,unused_pairs)}function remove_collision_pairs_by_id(scene,
worker,body_id){var bundles=scene._physics.bundles;var removed_pairs=[];for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;for(var j=0;j<phy.collision_tests.length;j++){var test=phy.collision_tests[j];for(var k=0;k<test.pairs.length;k++){var pair=test.pairs[k];var pair_result=test.pair_results[k];if(pair[0]==body_id||pair[1]==body_id){test.pairs.splice(k,1);test.pair_results.splice(k,1);k--;if(pair_result&&!calc_coll_result(test)){var zero=m_vec3.set(0,0,0,_vec3_tmp);test.callback(false,
null,zero,zero,0)}removed_pairs.push(pair)}}}}if(removed_pairs.length)m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_COLLISION_TEST,removed_pairs)}exports.apply_collision_impulse_test=function(obj,callback){if(has_collision_impulse_test(obj))clear_collision_impulse_test(obj);var phy=obj.physics;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_APPLY_COLLISION_IMPULSE_TEST,phy.body_id);phy.col_imp_test_cb=callback};exports.clear_collision_impulse_test=clear_collision_impulse_test;
function clear_collision_impulse_test(obj){if(!has_collision_impulse_test(obj))return;var phy=obj.physics;var worker=find_worker_by_body_id(phy.body_id);m_ipc.post_msg(worker,m_ipc.OUT_CLEAR_COLLISION_IMPULSE_TEST,phy.body_id);phy.col_imp_test_cb=null}function has_collision_impulse_test(obj){if(obj.physics&&obj.physics.col_imp_test_cb)return true;else return false}exports.append_ray_test=function(obj,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot){var id=get_unique_ray_test_id();
var collision_id=collision_id||"ANY";var test={id:id,body_id:obj?obj.physics.body_id:0,from:new Float32Array(from),to:new Float32Array(to),collision_id:collision_id,collision_id_num:col_id_num(collision_id),autoremove:autoremove,calc_all_hits:calc_all_hits,calc_pos_norm:calc_pos_norm,ign_src_rot:ign_src_rot,callback:callback};var worker=find_worker_by_body_id(test.body_id)||_workers[0];var scene=find_scene_by_worker(worker);var sphy=scene._physics;var id=test.id;sphy.ray_tests[id]=test;sphy.ray_tests_arr.push(test);
m_ipc.post_msg(worker,m_ipc.OUT_APPEND_RAY_TEST,test.id,test.body_id,test.from,test.to,test.collision_id_num,test.autoremove,test.calc_all_hits,test.calc_pos_norm,test.ign_src_rot);return id};function get_unique_ray_test_id(){_unique_counter.ray_test++;return _unique_counter.ray_test}function collision_id_to_body_ids(collision_id,bpy_scene,dest_arr,dest_obj){if(!dest_arr&&!dest_obj)throw"At least one destination required";for(var i=0;i<bpy_scene._physics.bundles.length;i++){var bundle=bpy_scene._physics.bundles[i];
if(collision_id=="ANY"||bundle.physics.collision_id==collision_id){var body_id=bundle.physics.body_id;if(dest_arr&&dest_arr.indexOf(body_id)==-1)dest_arr.push(body_id);if(dest_obj)dest_obj[body_id]=0}}}exports.remove_ray_test=remove_ray_test;function remove_ray_test(id){var scene=find_scene_by_ray_test_id(id);var worker=find_worker_by_ray_test_id(id);var sphy=scene._physics;if(sphy.ray_tests[id]){delete sphy.ray_tests[id];sphy.ray_tests_arr.splice(sphy.ray_tests_arr.indexOf,1);m_ipc.post_msg(worker,
m_ipc.OUT_REMOVE_RAY_TEST,id)}}exports.change_ray_test_from_to=function(id,from,to){var scene=find_scene_by_ray_test_id(id);var worker=find_worker_by_ray_test_id(id);var sphy=scene._physics;var test=sphy.ray_tests[id];if(test&&!test.autoremove){test.from.set(from);test.to.set(to);m_ipc.post_msg(worker,m_ipc.OUT_CHANGE_RAY_TEST_FROM_TO,id,from,to)}};exports.is_ray_test=function(id){var scene=find_scene_by_ray_test_id(id);var sphy=scene._physics;if(sphy.ray_tests[id])return true;else return false};
function find_scene_by_ray_test_id(id){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var sphy=scene._physics;if(sphy.ray_tests[id])return scene}return null}function find_worker_by_ray_test_id(id){for(var i=0;i<_scenes.length;i++){var scene=_scenes[i];var sphy=scene._physics;if(sphy.ray_tests[id])return _workers[i]}return null}exports.vehicle_throttle=function(obj,engine_force){var vehicle=obj.vehicle;vehicle.engine_force=engine_force;var worker=find_worker_by_body_id(obj.physics.body_id);
update_vehicle_controls(obj,vehicle,worker)};function update_vehicle_controls(obj,vehicle,worker){if(!vehicle.steering_wheel)return;var body_id=obj.physics.body_id;var engine_force=vehicle.engine_force*vehicle.force_max;var brake_force=vehicle.brake_force*vehicle.brake_max;var steering=-vehicle.steering*vehicle.steering_max*2*Math.PI/vehicle.steering_ratio;if(vehicle.inverse_control)steering*=-1;switch(vehicle.type){case VT_CHASSIS:m_ipc.post_msg(worker,m_ipc.OUT_UPDATE_CAR_CONTROLS,body_id,engine_force,
brake_force,steering);break;case VT_HULL:m_ipc.post_msg(worker,m_ipc.OUT_UPDATE_BOAT_CONTROLS,body_id,engine_force,brake_force,steering);break}}exports.vehicle_steer=function(obj,steering_value){var vehicle=obj.vehicle;vehicle.steering=steering_value;var worker=find_worker_by_body_id(obj.physics.body_id);update_vehicle_controls(obj,vehicle,worker)};exports.vehicle_brake=function(obj,brake_force){var vehicle=obj.vehicle;vehicle.brake_force=brake_force;var worker=find_worker_by_body_id(obj.physics.body_id);
update_vehicle_controls(obj,vehicle,worker)};function update_steering_wheel_coords(obj_chassis){var vehicle=obj_chassis.vehicle;var stw_obj=vehicle.steering_wheel;if(!stw_obj)return;var stw_tsr=obj_chassis.vehicle.steering_wheel_tsr;var stw_axis=obj_chassis.vehicle.steering_wheel_axis;m_tsr.multiply(obj_chassis.render.world_tsr,stw_tsr,stw_obj.render.world_tsr);var stw_axis_world=_vec3_tmp;m_tsr.transform_dir_vec3(stw_axis,obj_chassis.render.world_tsr,stw_axis_world);var rotation=_quat4_tmp;m_quat.setAxisAngle(stw_axis_world,
-vehicle.steering*vehicle.steering_max*2*Math.PI,rotation);var stw_obj_quat=m_tsr.get_quat_view(stw_obj.render.world_tsr);m_quat.multiply(rotation,stw_obj_quat,stw_obj_quat);m_trans.update_transform(stw_obj)}function update_speedometer(obj_chassis){var vehicle=obj_chassis.vehicle;var sp_obj=vehicle.speedometer;if(!sp_obj)return;var sp_tsr=obj_chassis.vehicle.speedometer_tsr;var sp_axis=obj_chassis.vehicle.speedometer_axis;m_tsr.multiply(obj_chassis.render.world_tsr,sp_tsr,sp_obj.render.world_tsr);
var sp_axis_world=_vec3_tmp;m_tsr.transform_dir_vec3(sp_axis,obj_chassis.render.world_tsr,sp_axis_world);var rotation=_quat4_tmp;var angle=Math.abs(vehicle.speed)*vehicle.speed_ratio;if(angle>vehicle.max_speed_angle)angle=vehicle.max_speed_angle;m_quat.setAxisAngle(sp_axis_world,-angle,rotation);var sp_obj_quat=m_tsr.get_quat_view(sp_obj.render.world_tsr);m_quat.multiply(rotation,sp_obj_quat,sp_obj_quat);m_quat.normalize(sp_obj_quat,sp_obj_quat);m_trans.update_transform(sp_obj)}function update_tachometer(obj_chassis){var vehicle=
obj_chassis.vehicle;var tach_obj=vehicle.tachometer;if(!tach_obj)return;var tach_tsr=obj_chassis.vehicle.tachometer_tsr;var tach_axis=obj_chassis.vehicle.tachometer_axis;m_tsr.multiply(obj_chassis.render.world_tsr,tach_tsr,tach_obj.render.world_tsr);var tach_axis_world=_vec3_tmp;m_tsr.transform_dir_vec3(tach_axis,obj_chassis.render.world_tsr,tach_axis_world);var rotation=_quat4_tmp;m_quat.setAxisAngle(tach_axis_world,-Math.abs(vehicle.engine_force)*vehicle.delta_tach_angle,rotation);var tach_obj_quat=
m_tsr.get_quat_view(tach_obj.render.world_tsr);m_quat.multiply(rotation,tach_obj_quat,tach_obj_quat);m_quat.normalize(tach_obj_quat,tach_obj_quat);m_trans.update_transform(tach_obj)}exports.is_vehicle_chassis=is_vehicle_chassis;function is_vehicle_chassis(obj){return obj.is_vehicle&&obj.vehicle_settings.part=="CHASSIS"}exports.is_vehicle_hull=is_vehicle_hull;function is_vehicle_hull(obj){return obj.is_vehicle&&obj.vehicle_settings.part=="HULL"}exports.is_car_wheel=function(obj){if(!obj.is_vehicle)return false;
var part=obj.vehicle_settings.part;if(part=="WHEEL_FRONT_LEFT"||part=="WHEEL_FRONT_RIGHT"||part=="WHEEL_BACK_LEFT"||part=="WHEEL_BACK_RIGHT")return true;else return false};exports.is_boat_bob=function(obj){if(!obj.is_vehicle)return false;var part=obj.vehicle_settings.part;if(part=="BOB")return true;else return false};exports.is_floater_bob=function(obj){if(!obj.is_floating)return false;var part=obj.floating_settings.part;if(part=="BOB")return true;else return false};exports.is_vehicle_steering_wheel=
function(obj){if(obj.is_vehicle&&obj.vehicle_settings.part=="STEERING_WHEEL")return true;else return false};exports.is_vehicle_speedometer=function(obj){if(obj.is_vehicle&&obj.vehicle_settings.part=="SPEEDOMETER")return true;else return false};exports.is_vehicle_tachometer=function(obj){if(obj.is_vehicle&&obj.vehicle_settings.part=="TACHOMETER")return true;else return false};exports.get_vehicle_speed=function(obj){var vehicle=obj.vehicle;return vehicle.speed};exports.wheel_index=function(vehicle_part){switch(vehicle_part){case "WHEEL_FRONT_LEFT":return 0;
case "WHEEL_FRONT_RIGHT":return 1;case "WHEEL_BACK_LEFT":return 2;case "WHEEL_BACK_RIGHT":return 3}};exports.is_character=is_character;function is_character(obj){return obj.is_character}exports.is_floater_main=is_floater_main;function is_floater_main(obj){return obj.is_floating&&obj.floating_settings.part=="MAIN_BODY"}exports.get_fps=function(){return _phy_fps};exports.debug_workers=function(){for(var i=0;i<_workers.length;i++){var worker=_workers[i];m_ipc.post_msg(worker,m_ipc.OUT_DEBUG)}};exports.remove_object=
function(obj){if(obj.physics.type=="BOUNDING"){var ind=_bounding_objects_arr.indexOf(obj);if(ind==-1)m_print.error("Object "+obj.name+" doesn't have bounding physics");delete _bounding_objects[body_id];_bounding_objects_arr.splice(ind,1)}var body_id=obj.physics.body_id;var worker=find_worker_by_body_id(body_id);var scene=find_scene_by_worker(worker);remove_collision_pairs_by_id(scene,worker,body_id);if(has_collision_impulse_test(obj))clear_collision_impulse_test(obj);var bundles=scene._physics.bundles;
for(var i=0;i<bundles.length;i++){var phy=bundles[i].physics;if(phy.body_id==body_id){bundles.splice(i,1);i--}}m_ipc.post_msg(worker,m_ipc.OUT_REMOVE_BODY,body_id)}};b4w.module["__data"]=function(exports,require){var m_anchors=require("__anchors");var m_anim=require("__animation");var m_assets=require("__assets");var m_batch=require("__batch");var m_cfg=require("__config");var m_ctl=require("__controls");var m_dds=require("__dds");var m_ext=require("__extensions");var m_input=require("__input");var m_loader=require("__loader");var m_md5=require("__md5");var m_nla=require("__nla");var m_lnodes=require("__logic_nodes");var m_particles=require("__particles");var m_nodemat=
require("__nodemat");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_reformer=require("__reformer");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_tex=require("__textures");var m_time=require("__time");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_def=
m_cfg.defaults;var cfg_ldr=m_cfg.assets;var cfg_phy=m_cfg.physics;var cfg_anim=m_cfg.animation;var cfg_sfx=m_cfg.sfx;var DEBUG_BPYDATA=false;var DEBUG_LOD_DIST_NOT_SET=false;var DEFAULT_LOD_DIST_MAX=1E6;var BINARY_INT_SIZE=4;var BINARY_SHORT_SIZE=2;var BINARY_FLOAT_SIZE=4;var _bpy_data_array=null;var _all_objects_cache=null;var _debug_resources_root="";var _primary_scene=null;var _dupli_obj_id_overrides={};var _vec3_tmp=new Float32Array(3);var PLAY_MEDIA_IMAGE_MOBILE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAACwCAYAAACvt+ReAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAbrwAAG68BXhqRHAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAABVDSURBVHic7Z15kF1Vncc/v05Ys7JIQJZ0GLaAgCzCQARGFMIwZKTiqCPBAbTEEodBhYKALJKSVWYsCpTBcgCLAdQBHWZACCCyhCElIRiWEMOSBZAkCglJOoTQyW/++J3Xfe95971+273v3fvOp6qr+5573+vT3d8+93vP+Z3fTwjUhKoKsC0wLvKxDTA68rEVMNK9ZDiwpft6PdDvvl4LvA+sBt5zn1cCy4EVwDJgpYhouj9RMZB2d6ATUdWtgD2BXvcxARgPbJ5RFzYAS4BFwGL38YqIvJ/R988NQcCAqm4LHADsA+yLibannX1KYBMm6JeBBcA8EVnZ3i61n64UsKoOAyYCh7iPCeTvd6HA68BcYA6wQEQ2trdL2ZO3P1rDqGoPsD9wNHAkMKqBt1nNoFctfV7j2ldj/rbPXdsvIuvd994S88QAIzCfHPXOHyHurRvt21PALOAFEdnUwHvkjsILWFV7gcnAUcDYWl8GvAEsZNCDLhKR91rfw4RvrjoWuyv0us97ALtS+99rFfAEMFNElqTRx06hkAJ2I94ngRMwXzsUmzCxzsP85csisja9HtaPqo7CbM9EzK/vRW1/vwXATODJ0h2hSBRKwO5hbAom3KFuw2uAZzD/+JyIrEm5ey1FVUcDB2Ee/hPU9vM+ANwnIu+m3L3MKISAVXU3YCrwNwx6zSTWArOBJ7Gn+P4q1+YGVR0OfByzSX+N+exKfAg8DtwtIm9m0L1UybWAVfWjwJcw4Vb6WRT4A3YbnV0U0VZCVTfDRDwZOJDKv5dNwGPAXSLydja9az25FLCqbg9MA44FhlW4bDXwIPYgszyrvnUSqrojJuRqlqof+C1wp4i8k1XfWkWuBKyqmwN/D3wRW7ZN4m3gfzHhfpBV3zoZNyofBXwem81I4gPgHsxabMiqb82SGwGr6lHAV7A50yQWA3cCT4c4gmRcPMeRwCnY0ngSK4BbRGRWZh1rgo4XsJtZOAvzdUm8CfwSeKxbJu+bxQl5EnAqsEuFy+YAPxKRP2fWsQboWAG7X/JJwGkMRnVFWQXcDjwchNsYbnVyMibkMQmXvA/8DLi/U+9qHSlg95B2HvCxhNP9wG+AO0SkL+F8oE7cws9UzCNvlnDJAuA6EVmWacdqoOMErKpHA98keS7zReAGEXkr2151B6q6C3A2sF/C6bWYpXgy215Vp2MErKpbYMI9NuF0H3ArNrPQkbeyouCs2wnA6SQPIo8AN3XKDE9HCFhVdwK+iwWv+DwLXF+k5c88oKrbAecAByecfh24shMsRdsFrKqHYn53pHdqAzYtdk8YdduDG40nA18DtvBOrwP+TURmZ96xCG0VsKp+DrtV+f1YDFwrIkuz7lOgHBeSej6wm38KmzP+deadcrRFwG765kxsmszncexBrXChf3nGzVScg63o+cwEftyOHSGZC9htmLwAONQ71Y/9N/9P1n0K1I6qngycQXkMyjPANVkPPJkKWFVHApcDe3un1mIPBc9n2Z9AY6jqgcBFlM9SLAAuy3J+PjMBu20yM4DdvVPLge+JyBtZ9SXQPC4G+zJsD1+U14BLs9p+lYmAXTzDFZRHQi0EZojIqiz6EWgtqroNcCmWQyPKUuDiLKY+Uxewqo4BrqL8CfZF4PKQrCPfuIe7S7Dg+ShvARekPTilKmBVHYGNvHt4p54FrshT3GmgMm4V9SJsf16URcBFae43TE3Abrbh+5Q/sM0Gri761p5uwwXNTwcO904twOxEKrMTqaRPcvO851Eu3uewqZYg3oIhIh9iVnGOd2ofYLrLhtRy0sr/dSbl/4nzMdvwYUrfM9Bm3MB0JfCCd+pQbFNCy2m5gN3ysL/CthCbWgmrawXHPdfMAF7xTk12iyAtpaUCVtXDsNiGKMuxqbIg3i7BzSzNwPbXRfmqC95qGS0TsKqOA75N/MGwjzDP25W41K+XYausA83AeS58tiW0RMCRucBo7oF+zPMWOrlcoDJudfUqIBrkMxK40KVIaJpWjcBnUR6MfkuIbQiIyDzgNq95d+AbrXj/pgWsqpMo3wb0eIgqC5Rw8cL+Xrrj3P7HpmhKwKr6EeBfvOYlwA3NvG+gkFyPxUhEOcvtQG+YhgXstpucSzykbgO2kyLMOARiOE1ci2XHLDES+I7TUkM0MwJPoTxvw63hoS1QCRFZjCVKiXIAcGKj79mQgJ11+LLX/BxwX6MdCXQN92K7N6Kc1qiVaHQE/ibx7JB9wA/D7uHAUDiN3MhgMRyArWlwqbluAbsskf5qyq0hb0OgVlwe4tu85sPcjFZd1CVgN/l8htf8IrYrNRCohwexAK8oX3OxxTVT7wg8FdghctyPbYEP1iFQF04zNzBYQxpge+Cz9bxPzQJ2qYb+wWu+NyTaCzSKW2q+32v+gttDWRP1jMDTiOfpXYUllg4EmuFOrJ5JiS2xDPI1UZOAXTWgT3vNt4f8vIFmcRq63Wv+jCtQMyS1jsCnEM/E8haWZjO3qOrDqrp/u/sRAGwSIFqzbjjwj7W8cEgBuwQWftDFfxagMvpngLmqerNbmAm0CVci4ude87GquvNQr61lBP6cd90SrCJ6ERiO7d/7o6pe0KoY1UBDPI5lJS3Rg2mvKlUF7J4Gj/Ga7yjgtNk2wNXAC6r6+XZ3phtxmvqF1/wpl/2nIkONwFOI1x7+E/B0/d3LDXsBvwz+uG08hRWqLLEZySl4B6goYLdN6ASv+b8LOPomEfxxG3Be+F6v+cRqq3PVRuCjie9xWwM82nj3ckfwx+3hYeLzwqNITqoNVBfw8d7xg10aqB78cYa46kd+bM3kStcnCtjVRNgn2gQ81Gznck7wx9kxE9NciYluOreMSiOwr/g/iMjbiVd2H8Efp4wr3+XvaPcdAZAgYJeYz/ccIVwyTvDH6ePf8Y9x2oyRNALvD4yNHPdhKVED5QR/nB5PY7XoSmwD7OtflCRgf9n4/0I61CEJ/rjFuCSB/sBZNhsRE7DL4XqEd01Rlo2zIPjj1uJrb5JvI/wReCIwOnK8GpiXQseKTPDHrWMutv5QYix2txvAF7Bf42BOsA8NE/xxkzjtzfWaYxr1BezvNvbTxQfqJ/jj5njWO45pdEDALuqnN3JuE5asJNAagj9ujGeJL2rs4YpmAvER+EDiyakXplkeqUsJ/rhOXMXP16JNRFKaRQU80XtteHhLj+CP68PX4sB8cE9So+Pl1LoTKBH8cW34WowL2BUlHB+5QIE/pt+vgCP44+rMJ+6DJ7h49YEReE/io/Ebwf9mTvDHFRCR1dhO+BLDcOWLS6Lt9V7j1/gKZEfwx8ks9I4nwKCAd/dOLkq9O4GhCP44jp84vRcqj8BBwJ1D8MeGr8legB5Xn8CPdg9lAjqL4I/jOSMAxquq9ADbAtFfyJpQWbNj6Vp/7BKoR3PxbQmM7QHGedcuy6xXgUbpVn+83DselyRg/6JA59Jt/tjX5g5BwPmnm/xx4gjs5576S0adCbSWbvDHK7zj7XqI78AAy7weyC9F9serveNRSQIOS8jFoIj+2Bfw6CDgYlM0f+xrc3QPVnC52kWB/FMUf+yPwCN7sBysUT7IqDOB7Mm7P97gHW+eJOCwC7n45NUff+gdb5YkYP+iQDHJoz9OFPBwrzGMwN1FnvxxooADgRLvt7sD9dJD+Yjrj8iBYrMSmA7sLyL3tbszQ1Bmd4djw/Lm3kX+016gePQDtwAXi8if292ZGqko4ChhBC4+jwDfFpEX292ROqlJwBVLGgVyz0Lg3BxYhUr4MyUbeihfeRtFoGjkyedWoyzsYTgJ68sZdSaQPnn0udVIFHBZhE9GnQmkS159bjV8bb4XBFw88u5zq+Hb27XDMX8UZfuMOhNoLSuBa4AfugIpRWQH7/id4ZTvM9oxo84EWkPRfG41fG0uTxKwr/JA51JEn1sNX5uJAg4jcOdTZJ9bjbId9D3Au8SD2EdFaxAEOoqizOfWjapuC4yINL0PvNcjIgos9a7vzapjgZroB34C7C0i1xT4Ia0aE7zjJSIyUPUwMfNfoCN4BDhIRL7eBQ9p1ej1jhfBYODOYu+kr/ZA9nSrz63EeO94CQwK2B+B90y9O4FKdMN8biPs5R0vhkEBvwJsxGoPAOyqqqNCnYxM6ab53LpQ1dHAzpGmjcCr4DK0i8h64jZCgH0y6l8g+Nyh2Jd4Ec7XnWZjlYkq1uIKpMZCYIqIHNdFixGN4GvxpdIX1QScx8QXeaFr53Mb5EDveECr0e1Dz2PF5EpD9d6qOsbVqg20huBz60RVxxCvoqUkjcAishJ4PXKhAB9Pu4NdRPC5jXEIcf/7SrSGi58XYm7CiwPNEXxuc/ganBM98AU8xzs+TFXDLuXGCD63SZz2fAHHBllfwAuI79AYSbAR9RLiFlrHwcTT/67CKzkbE7CIbASe8t7kk6l0rZgEn9tajvaOZ4nIpmhDUm60Wd7xEarqJ5QIxAk+t8W4bJmHec2+NhMF/DwWI1xiBHB467pWKILPTY8jga0jx+8SmT4rUSZgFx/sK/2ElnYt/wSfmz7HecdPOG3GqJRedaZ3fKCq7tSSbuWf4HNTRlV3BA7wmh9KujZRwCKyBJuRGGgCjm9J7/JL8LnZMZn44sV8EfF3DQGVR2AoH4VPUNUtm+1ZDgk+N0NUdQvKLauvxQGqCfgJ4nnTRgHHNt613BF8bns4jngGnjUkzD6UqChgEfkA+I3XPFVVu6EsQfC5bcBp67Ne831Oi4kMJcb7iecP3hE4orHu5YLgc9vLJCA6WbAB02BFqgpYRN4FHveap6mqJF2fY4LPbTNu9D3Fa340GnmWRC124G4guny3G+VLfHkl+NzO4Rhg18jxRuBXQ71oSAGLyJvAY17zNFUdlnB5nngAOCD43PbjRt8ves2/E5E/DfXaWh/I7iJejuuj5HxeWEROFBF/G1WgPZwI7BI57gd+XssLaxKwiLwN/NZrPlVVRyRdHwjUiqqOBKZ5zQ+LyLJaXl/PlNidwPrI8RjgS3W8PhBIYhrxed/12B2/JmoWsIi8gz3QRTlJVXdJuj4QGApV3Q34W6/5F272qybqXZT4FfF8wsOBbxVwWi2QMk4z/0x8Z/wy4N563qcuAbtpplu95n0I4ZaB+jmR8oQlP613KrPuZWERmQX83ms+XVW3q/e9At2Jqm4PnOY1zxaR2fW+V6NxDTcCfZHjEQQrEaiBiHWI7rZYB/x7I+/XkICdyb7daz4ImNLI+wW6ipOBQ72220TkL428WTORZfcDL3htp6tqbxPvGSgwqro78E9e8zxsVbQhGhaw25/0r8DaSPPmwPldGvgeqIKqbgWcD0R3uK/BEnmX7XWrlaZie92wf4PXvBtwbvDDgRJOC+cQXy4G+HGj1qFE08HpIvIUFgAe5QjKA5MD3ctUyhPkzBSRJ5t941btrriJeGZLgDNU1c/rGugyVPUgyn3vq8DNrXj/lgjYbfn4PvG8asOA74aHuu7FLRVPZ7D2CpjvvapVsdct298mIiuAHxAPft8auERVt2nV9wnkA1dZ83vEq2sqcJ2I+OWNG6alGzRF5DnKl5rHAZe6p9BAF6CqWwOXUV6c+6ci8mwrv1fLdxiLyK8Bf1/ZnsCMML1WfFxeh0uBv/JOPSgidQXq1EJaW+R/Avjr2hOBi13WwUABcQmpLwQ+5p2agz3ot5xUBOxyuF5HPD0VWLLsC0K61uLh/qYXUb5MPB+42uWebjmpLja4LUdXAHt4p54HZpSK1QXyjbMNF2PxMFEWAReKyNryV7WG1FfLXJnQq7EVuigvAZeLyLq0+xBID/dccwnltdzeBKYPldehWVJPEyUiq7H/Tj+74H7AFWGKLb+4qbJrKBfvUuCitMULGYzAJdzu0xmUVx1/BxuJ/ZW8QAfjFim+R/lU2WvApVkVyMw04MZ54sspLyTeB1wpIvOy7E+gMdzy8HTiixRgD2yXi0hf+avSIfOIMeeZLgA+4Z3aiC2C3NtMeF0gPVxU2VQstsHPzPR74NqsH8zbEvLoUgmdCZyUcHo2FiOa2X9xYGjcwPMtksuuPQjclNZUWTXaGrOrqicDX03ox1Lsv3lx5p0KlOF2UpxPeTzvJuA/0lhhq5W2B52r6gHYL2esd+pD4A7gnmAp2oOzDFOAM4jvpACLKvuBiPj1tTOl7QIGUNVx2CqOv34OVhv3epcZKJARbuv7OZQvToDNNFzZyqiyRukIAcNAZcZvUF4fDGyW4mfAA2E0Thc36v4d9qC2dcIlM4GbOyWXcscIuISqTgLOJl7kucR84AYReSPbXnUHbm73bCzwymcNcKPbQtYxdJyAYeD29R3Ki92B5Y69D7grzFS0BrfIdAqW7ml4wiXzsJmhpjZgpkFHChhqupWtxpKrPNSO6Zsi4LLsnwCcSjzFaYl1wG10sHXrWAGXcOvtX8cq2CSxHPgvTMibKlwTiOAGh0nAl4GdK1z2DPCjThx1o3S8gEs4b/wVbItSEkuxxMizOnW0aDduAWkSZhd2rXDZMmxu9+nMOtYEuREwDET8n4jd8pJsBdiIfC82Iod4YwaCzY8CvkD5YkSJ9Vj+57s7ZYahFnIl4BLOVkwDPk3yQwfYU/ODmJDfzqpvnYSq7oQVzp5MsscFeyh+GHsorjkzeqeQSwGXUNUdsTodn6JybLNiO0BmYjloczO6NIKbTz8SqyK1P5X/xhuB32HCbfuCRKPkWsAlXJ2OqZiQq+23W4cFC80C5opIf5Vrc4OzCAdhNuFwKtsrsCX6R7El+iHrsHU6hRBwCbe74yTMJ1e6ZZbow56052JiTn33QCtR1bHAwcAh2EbKoUqercFS4t6Xt5+1GoUScAm3yfAo7Dbq12FIfAmWr+t5bLXvZbcVqmNQ1THYCtm+2Bae3ant7zcfeAh4slrV97xSSAFHccujx2P1nbet9WXAW1j1+iVY4sIlWT3kuHoj44EJQC+WGKaecmbvAk9gGSALvexeeAGXcJP3+2Ej8yTKwzdroQ+bJ12BTdetwFYE10Q+r8PiZPtL03guGHw49qC5NWZvRkc+74DNb5c+GqmAugrz9rOAl7plLrxrBBzFTejvhXnHQ7C8FXn7XSjwCvCs+1jYjSuRefujpYLzl/tj/nIi5i/9PV/tZiNmZV7Gcmq8mNXO304mCDgBd8vfA/OfvZgXHQ9klZxwPbAY89+L3NevhpXFcoKA68BN05V86g7Adgz62NGYd90KG72Hua8B3sdG0H5MnH2YZy755ncY9NTLijTNlTb/Dz+sKh/f1rAbAAAAAElFTkSuQmCC";
var _play_media_btn=null;var _play_media_bkg=null;var _canvas_container_z_index=0;var _media_data_init=false;var SECONDARY_LOAD_TYPES_DISABLED=["LAMP","CAMERA"];var ADD_PHY_TYPES=["MESH","CAMERA","EMPTY"];var B4W_INFO="B4WB";var MAJOR_VERSION_EMPTY=5;var MINOR_VERSION_EMPTY=4;var B4W_HEADER_OFFSET=12;var _canvas=null;exports.is_primary_loaded=function(data_id){return m_loader.is_primary_loaded(data_id)};exports.update=function(){m_loader.update_scheduler(_bpy_data_array)};function free_load_data(bpy_data,
thread){_bpy_data_array[thread.id]=null;_all_objects_cache[thread.id]=null}function print_image_info(image_data,image_path,show_path_warning){var w,h;if(image_data instanceof ArrayBuffer){var dds_wh=m_dds.get_width_height(image_data);w=dds_wh.width;h=dds_wh.height}else{w=image_data.width;h=image_data.height}var color;if(w>2048||h>2048)color="a00";else if(w>1024||h>1024)color="aa0";else color="0a0";m_print.log("%cLOAD IMAGE "+w+"x"+h,"color: #"+color,image_path);if(image_path.indexOf(_debug_resources_root)==
-1&&show_path_warning)m_print.warn("image",image_path,"is not from app root.")}function print_video_info(video,image_path,show_path_warning,type){if(type==m_assets.AT_VIDEO_ELEMENT){var w=video.videoWidth;var h=video.videoHeight}else{var w=video.images[0].width;var h=video.images[0].height}var color;if(w>2048||h>2048)color="a00";else if(w>1024||h>1024)color="aa0";else color="0a0";m_print.log("%cLOAD VIDEO "+w+"x"+h,"color: #"+color,image_path);if(image_path.indexOf(_debug_resources_root)==-1&&show_path_warning)m_print.warn("video",
image_path,"is not from app root.")}function load_main(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var main_path=thread.filepath;if(!main_path)throw"Nothing requested";var asset_cb=function(loaded_bpy_data,uri,type,path){if(!loaded_bpy_data){m_loader.abort_thread(thread);return}m_print.log("%cLOAD METADATA","color: #616",path);check_format_version(loaded_bpy_data);for(var prop in loaded_bpy_data)bpy_data[prop]=loaded_bpy_data[prop];prepare_thread_bpy(thread,bpy_data);show_export_errors(bpy_data,
thread);show_export_warnings(bpy_data,thread);cb_finish(thread,stage)};var progress_cb=function(rate){cb_set_rate(thread,stage,rate)};m_assets.enqueue([{id:main_path,type:m_assets.AT_JSON,url:main_path}],asset_cb,null,progress_cb)}function prepare_thread_bpy(thread,bpy_data){if(thread.is_primary)_primary_scene=m_scenes.find_main_scene(bpy_data["scenes"]);var bin_name=bpy_data["binaries"][0]["binfile"];if(bin_name)thread.binary_name=bin_name;else{m_loader.skip_stage_by_name(thread,"load_binaries");
m_loader.skip_stage_by_name(thread,"prepare_bindata")}if(!cfg_def.is_mobile_device)m_loader.skip_stage_by_name(thread,"mobile_media_start");if(!cfg_def.antialiasing||!cfg_def.smaa)m_loader.skip_stage_by_name(thread,"load_smaa_textures")}function show_export_warnings(bpy_data,thread){if(bpy_data["b4w_export_warnings"])for(var i=0;i<bpy_data["b4w_export_warnings"].length;i++){var warn_data=bpy_data["b4w_export_warnings"][i];if(thread.is_primary&&warn_data["type"]=="PRIMARY"||warn_data["type"]=="ALL")m_print.export_warn(warn_data["text"])}}
function show_export_errors(bpy_data,thread){if(bpy_data["b4w_export_errors"])for(var i=0;i<bpy_data["b4w_export_errors"].length;i++){var err_data=bpy_data["b4w_export_errors"][i];if(thread.is_primary&&err_data["type"]=="PRIMARY"||err_data["type"]=="ALL")m_print.export_error(err_data["text"])}}function load_binaries(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var binary_path=dirname(thread.filepath)+thread.binary_name;if(!binary_path)throw"Binary data is missing";var binary_cb=function(bin_data,
uri,type,path){if(!bin_data){m_loader.abort_thread(thread);return}m_print.log("%cLOAD BINARY","color: #616",path);bpy_data["bin_data"]=bin_data;check_bin_data_version(bin_data,bpy_data);cb_finish(thread,stage)};var progress_cb=function(rate){cb_set_rate(thread,stage,rate)};m_assets.enqueue([{id:binary_path,type:m_assets.AT_ARRAYBUFFER,url:binary_path}],binary_cb,null,progress_cb)}function wait_for_shaders(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(m_shaders.check_shaders_loaded())cb_finish(thread,
stage)}function check_format_version(loaded_bpy_data){var ver_loaded=m_util.str_to_version(loaded_bpy_data["b4w_format_version"]);var cmp=m_util.version_cmp(ver_loaded,cfg_def.min_format_version);switch(cmp){case -1:if(ver_loaded[0]<cfg_def.min_format_version[0])m_util.panic("JSON version is too old relative to B4W engine: "+m_util.version_to_str(ver_loaded)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". "+"Reexport scene with the latest B4W addon to fix it.");else m_print.warn("JSON version is a bit old relative to B4W engine: "+
+m_util.version_to_str(ver_loaded)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". Some compatibility issues can occur. "+"Reexport scene with the latest B4W addon to fix it.");break;case 1:if(ver_loaded[0]>cfg_def.min_format_version[0])m_util.panic("B4W engine version is too old relative to JSON. "+"Can't load the scene. Update your "+"engine version to fix it.");else m_print.warn("B4W engine version is a bit old relative to JSON. "+"Some compatibility issues can occur. Update "+
"your engine version to fix it.");break}cfg_def.loaded_data_version=ver_loaded}function prepare_bindata(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var bin_data=bpy_data["bin_data"];var bin_offsets=bpy_data["binaries"][0];var objects=bpy_data["objects"];var meshes=bpy_data["meshes"];var actions=bpy_data["actions"];var is_le=m_util.check_endians();var headers=get_header(bin_data);if(headers[0]>=MAJOR_VERSION_EMPTY&&headers[1]>MINOR_VERSION_EMPTY)var b4w_info_offset=B4W_HEADER_OFFSET;else var b4w_info_offset=
0;prepare_bindata_submeshes(bin_data,bin_offsets,meshes,is_le,b4w_info_offset);prepare_bindata_psystems(bin_data,bin_offsets,objects,is_le,b4w_info_offset);prepare_bindata_actions(bin_data,bin_offsets,actions,is_le,b4w_info_offset);cb_finish(thread,stage)}function check_bin_data_version(bin_data,bpy_data){var headers=get_header(bin_data);var ver_loaded=m_util.str_to_version(bpy_data["b4w_format_version"]);if(headers[0]!=ver_loaded[0])m_util.panic("BIN version does not match to JSON version: "+m_util.version_to_str(headers)+
", required: "+m_util.version_to_str(cfg_def.min_format_version)+". Couldn't load the scene. "+"Reexport scene to fix it.");if(headers[1]!=ver_loaded[1])m_print.warn("BIN version does not match to JSON version: "+ +m_util.version_to_str(headers)+", required: "+m_util.version_to_str(cfg_def.min_format_version)+". Some compatibility issues can occur. "+"Reexport scene to fix it.")}function get_header(bin_data){var has_data=new Uint8Array(bin_data,0,4);var major_version=(new Uint32Array(bin_data,4,1))[0];
var minor_version=(new Uint32Array(bin_data,8,1))[0];for(var i=0;i<has_data.length;i++)if(B4W_INFO[i]!=String.fromCharCode(has_data[i])){major_version=MAJOR_VERSION_EMPTY;minor_version=MINOR_VERSION_EMPTY;break}return[major_version,minor_version]}function prepare_bindata_submeshes(bin_data,bin_offsets,meshes,is_le,b4w_offset){var int_props=["indices"];var short_props=["normal","tangent"];var ushort_props=["color","group"];var float_props=["position","texcoord","texcoord2"];for(var i=0;i<meshes.length;i++){var submeshes=
meshes[i]["submeshes"];for(var j=0;j<submeshes.length;j++)for(var prop_name in submeshes[j]){var length=submeshes[j][prop_name][1];if(int_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_INT_SIZE+bin_offsets["int"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_uint(bin_data,offset,length,is_le)}else if(float_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_FLOAT_SIZE+bin_offsets["float"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_float(bin_data,
offset,length,is_le)}else if(short_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_SHORT_SIZE+bin_offsets["short"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_short(bin_data,offset,length)}else if(ushort_props.indexOf(prop_name)!=-1){var offset=submeshes[j][prop_name][0]*BINARY_SHORT_SIZE+bin_offsets["ushort"]+b4w_offset;submeshes[j][prop_name]=extract_bindata_ushort(bin_data,offset,length)}}}}function prepare_bindata_psystems(bin_data,bin_offsets,bpy_objects,is_le,
b4w_offset){for(var i=0;i<bpy_objects.length;i++){var psystems=bpy_objects[i]["particle_systems"];for(var j=0;j<psystems.length;j++){var psys=psystems[j];var offset=psys["transforms"][0]*BINARY_FLOAT_SIZE+bin_offsets["float"]+b4w_offset;var length=psys["transforms"][1];psys["transforms"]=extract_bindata_float(bin_data,offset,length,is_le)}}}function prepare_bindata_actions(bin_data,bin_offsets,actions,is_le,b4w_offset){for(var i=0;i<actions.length;i++){var action=actions[i];var fcurves=action["fcurves"];
var frame_range=action["frame_range"];var start=frame_range[0];var end=frame_range[1];var arr_length=m_anim.get_approx_curve_length(start,end);var bflags=null;if(arr_length<0)arr_length=0;var has_euler_rot=false;var has_quat_rot=false;for(var data_path in fcurves){has_euler_rot|=data_path.indexOf("rotation_euler")>-1;has_quat_rot|=data_path.indexOf("rotation_quaternion")>-1}var paths_to_rename=[];for(var data_path in fcurves){if(has_euler_rot&&has_quat_rot&&data_path.indexOf("rotation_euler")>-1){delete fcurves[data_path];
continue}var channels=fcurves[data_path];for(var array_index in channels){var fcurve=channels[array_index];var offset=bin_offsets["float"]+fcurve["bin_data_pos"][0]*BINARY_FLOAT_SIZE+b4w_offset;var fcurve_bin_data=extract_bindata_float(bin_data,offset,fcurve["bin_data_pos"][1],is_le);var points=new Float32Array(arr_length);if(bflags===null)bflags=new Int8Array(arr_length);m_anim.approximate_curve(fcurve,fcurve_bin_data,points,bflags,start,end);fcurve._pierced_points=points}if(data_path.indexOf("rotation_euler")>
-1){m_anim.fcurve_replace_euler_by_quat(fcurves[data_path]);paths_to_rename.push(data_path)}}for(var j=0;j<paths_to_rename.length;j++){var path_old=paths_to_rename[j];var path_new=path_old.replace("euler","quaternion");fcurves[path_new]=fcurves[path_old];delete fcurves[path_old]}action._bflags=bflags}}function extract_bindata_float(bin_data,offset,length,is_le){if(is_le)var arr=new Float32Array(bin_data,offset,length);else{var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=
0;i<length;i++)arr[i]=dataview.getFloat32(offset+i*BINARY_FLOAT_SIZE,true)}return arr}function extract_bindata_uint(bin_data,offset,length,is_le){if(is_le)var arr=new Uint32Array(bin_data,offset,length);else{var arr=new Uint32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr[i]=dataview.getUint32(offset+i*BINARY_INT_SIZE,true)}return arr}function extract_bindata_short(bin_data,offset,length){var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=
0;i<length;i++)arr[i]=dataview.getInt16(offset+i*BINARY_SHORT_SIZE,true)/32767;return arr}function extract_bindata_ushort(bin_data,offset,length){var arr=new Float32Array(length);var dataview=new DataView(bin_data);for(var i=0;i<length;i++)arr[i]=dataview.getUint16(offset+i*BINARY_SHORT_SIZE,true)/65535;return arr}function report_empty_submeshes(bpy_data){var already_reported={};var bpy_objects=bpy_data["objects"];for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(bpy_obj["type"]!==
"MESH")continue;if(bpy_obj["particle_systems"].length)continue;var mesh=bpy_obj["data"];var mesh_name=mesh["name"];var submeshes=mesh["submeshes"];var materials=mesh["materials"];for(var j=0;j<submeshes.length;j++)if(submeshes[j]["base_length"]===0&&!already_reported[mesh_name]){if(materials[j])m_print.warn('material "'+materials[j]["name"]+'" is not assigned to any face (object "'+bpy_obj["name"]+'").');already_reported[mesh_name]=true}}}function report_odd_uvs(meshes){for(var i=0;i<meshes.length;i++){var mesh=
meshes[i];var materials=mesh["materials"];var submeshes=mesh["submeshes"];if(!materials.length)if(mesh["uv_textures"].length)m_print.warn('mesh "'+mesh["name"]+'" has a UV map but has no exported material.')}}function prepare_bpy_data(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){make_bpy_links(bpy_data);m_reformer.check_bpy_data(bpy_data);create_bpy_textures(bpy_data,thread);report_empty_submeshes(bpy_data);report_odd_uvs(bpy_data["meshes"]);create_special_materials(bpy_data);assign_default_material(bpy_data);
prepare_bpy_actions(bpy_data["actions"],thread.id);prepare_bpy_lods(bpy_data);prepare_bpy_scenes(bpy_data,thread);prepare_bpy_objects(bpy_data,thread);prepare_bpy_worlds(bpy_data,thread);prepare_bpy_logic_nodes_objects_params(bpy_data);if(DEBUG_BPYDATA)m_print.log("%cDEBUG BPYDATA:","color: #a0a",bpy_data);cb_finish(thread,stage)}function create_bpy_textures(bpy_data,thread){var textures=bpy_data["textures"];var global_af=get_global_anisotropic_filtering(bpy_data,thread);for(var i=0;i<textures.length;i++){if(!thread.is_primary&&
textures[i]["b4w_source_type"]=="SCENE")textures[i]["b4w_source_id"]="";m_tex.create_texture_bpy(textures[i],global_af,bpy_data["scenes"],thread.id)}}function prepare_bpy_scenes(bpy_data,thread){if(!thread.is_primary&&bpy_data["scenes"].length>1){bpy_data["scenes"]=[m_scenes.find_main_scene(bpy_data["scenes"])];m_print.warn("loading data contains multiple scenes.","Only the first one will be loaded.")}if(thread.is_primary)var main_scene=_primary_scene;else var main_scene=m_scenes.find_main_scene(bpy_data["scenes"]);
m_time.set_framerate(_primary_scene["fps"]);if(bpy_data["scenes"].length>1){var index_of_main_scene=bpy_data["scenes"].indexOf(_primary_scene);bpy_data["scenes"].splice(index_of_main_scene,1);bpy_data["scenes"].unshift(_primary_scene)}for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];scene._render=m_scenes.create_scene_render();scene._is_main=scene==main_scene;scene._is_primary_thread=thread.is_primary;if(cfg_phy.enabled&&scene["b4w_enable_physics"]&&(thread.is_primary||
!m_phy.scene_has_physics(_primary_scene)&&scene==m_scenes.find_main_scene(bpy_data)))m_phy.init_scene_physics(scene);if(thread.is_primary){if(scene["b4w_enable_audio"])m_sfx.attach_scene_sfx(scene)}else if(scene["b4w_enable_audio"]&&!_primary_scene._sfx)m_sfx.attach_scene_sfx(_primary_scene)}}function prepare_bpy_objects(bpy_data,thread){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];var scene_objs=combine_scene_bpy_objects(bpy_scene,"ALL");for(var j=0;j<scene_objs.length;j++){var bpy_obj=
scene_objs[j];if(m_obj.check_bpy_obj_scene_compatibility(bpy_obj,bpy_scene,bpy_data)){if(!bpy_obj._scenes)bpy_obj._scenes=[];bpy_obj._scenes.push(thread.is_primary?bpy_scene:_primary_scene)}}prepare_hair_dupli_objects(scene_objs)}process_bpy_objects_hierarchy(bpy_data,thread);var bpy_objects=get_bpy_cache(thread.id);for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(!thread.is_primary&&bpy_obj["parent"]&&SECONDARY_LOAD_TYPES_DISABLED.indexOf(bpy_obj["parent"]["type"])>-1)bpy_obj["parent"]=
"";if(bpy_obj["type"]=="MESH"){var mesh=m_reformer.apply_mesh_modifiers(bpy_obj);if(mesh){bpy_data["meshes"].push(mesh);bpy_obj["data"]=mesh}}}}function prepare_bpy_worlds(bpy_data,thread){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];var bpy_world=bpy_scene["world"];if(!bpy_world._scenes)bpy_world._scenes=[];bpy_world._scenes.push(thread.is_primary?bpy_scene:_primary_scene)}}function combine_scene_bpy_objects(bpy_scene,type){if(!type)type="ALL";var scene_objs_arr=
[];combine_scene_bpy_objects_iter(bpy_scene["objects"],type,scene_objs_arr);return scene_objs_arr}function combine_scene_bpy_objects_iter(bpy_objects,type,dest){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(type=="ALL"||type==bpy_obj["type"])dest.push(bpy_obj);var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];combine_scene_bpy_objects_iter(dg_objects,type,dest)}}}function prepare_hair_dupli_objects(bpy_objects){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=
bpy_objects[i];if(bpy_obj._scenes&&bpy_obj.type!="WORLD"){var psystems=bpy_obj["particle_systems"];for(var j=0;j<psystems.length;j++){var pset=psystems[j]["settings"];if(pset["type"]!="HAIR")continue;if(pset["render_type"]=="OBJECT"){var dg_obj=pset["dupli_object"];if(!dg_obj._scenes)dg_obj._scenes=bpy_obj._scenes.slice()}else if(pset["render_type"]=="GROUP"){var dg=pset["dupli_group"];for(var k=0;k<dg["objects"].length;k++){var dg_obj=dg["objects"][k];if(!dg_obj._scenes)dg_obj._scenes=bpy_obj._scenes.slice()}}}}}}
function prepare_bpy_logic_nodes_objects_params(bpy_data){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];if(bpy_scene["b4w_use_logic_editor"]){var scene_objs=combine_scene_bpy_objects(bpy_scene,"ALL");var scene_world=bpy_scene["world"];m_reformer.assign_logic_nodes_object_params(scene_objs,scene_world,bpy_scene)}}}function process_bpy_objects_hierarchy(bpy_data,thread){var scenes=bpy_data["scenes"];var object_levels=[];for(var i=0;i<scenes.length;i++){var scene_objs=
scenes[i]["objects"];process_bpy_objects_hierarchy_iter(scene_objs,0,thread.is_primary,object_levels)}_all_objects_cache[thread.id]=[];for(var i=0;i<object_levels.length;i++){var grp_level=object_levels[i];for(var j=0;j<grp_level.length;j++){var par_level=grp_level[j];for(var k=0;k<par_level.length;k++)_all_objects_cache[thread.id].push(par_level[k])}}var particles=bpy_data["particles"];for(var i=0;i<particles.length;i++){var dg_obj=particles[i]["dupli_object"];if(dg_obj){dg_obj._is_hair_dupli=true;
_all_objects_cache[thread.id].push(dg_obj)}var dg_group=particles[i]["dupli_group"];if(dg_group){var objects=dg_group["objects"];for(var j=0;j<objects.length;j++){var dg_obj=objects[j];dg_obj._is_hair_dupli=true;_all_objects_cache[thread.id].push(dg_obj)}}}var cache=_all_objects_cache[thread.id];for(var i=cache.length-1;i>=0;i--)if(!cache[i]._scenes)cache.splice(i,1)}function process_bpy_objects_hierarchy_iter(bpy_objects,grp_num,is_primary,object_levels){object_levels[grp_num]=object_levels[grp_num]||
[];var group_level=object_levels[grp_num];for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var pnum=parent_num(bpy_obj);group_level[pnum]=group_level[pnum]||[];if(is_primary||SECONDARY_LOAD_TYPES_DISABLED.indexOf(bpy_obj["type"])==-1)if(group_level[pnum].indexOf(bpy_obj)==-1)group_level[pnum].push(bpy_obj);var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];process_bpy_objects_hierarchy_iter(dg_objects,grp_num+1,is_primary,object_levels)}}}
function get_bpy_cache(data_id){return _all_objects_cache[data_id]}function get_bpy_cache_scene(data_id,bpy_scene,obj_type){var bpy_scene_objs=[];var bpy_objects=get_bpy_cache(data_id);for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];if(bpy_obj["type"]==obj_type||obj_type=="ALL")for(var j=0;j<bpy_obj._scenes.length;j++)if(bpy_scene==bpy_obj._scenes[j])bpy_scene_objs.push(bpy_obj)}return bpy_scene_objs}function process_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var bpy_objects=
get_bpy_cache(thread.id);var bpy_worlds=bpy_data["worlds"];create_objects_from_bpy(bpy_data,bpy_objects,thread.id);create_world_objects_from_bpy(bpy_data,bpy_worlds,thread.id);var objects=m_obj.get_all_objects(thread.id);for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var obj=bpy_obj._object;m_nla.update_object(bpy_obj,obj)}for(var i=0;i<bpy_worlds.length;i++){var bpy_world=bpy_worlds[i];var world=bpy_world._object;m_nla.update_object(bpy_world,world)}if(thread.is_primary)calc_light_index(bpy_data,
thread.id);for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var obj=bpy_obj._object;if(!obj.is_hair_dupli){m_obj.update_object_relations(bpy_obj,obj);m_trans.update_transform(obj)}}prepare_lod_objects(bpy_objects);link_skinned_objs(objects);calc_max_bones(objects);prepare_vehicles(objects);prepare_floaters(objects);cb_finish(thread,stage)}function create_objects_from_bpy(bpy_data,bpy_objects,data_id){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];var obj=m_obj_util.create_object(bpy_obj["name"],
bpy_obj["type"],bpy_obj["origin_name"]);for(var j=0;j<bpy_obj._scenes.length;j++)m_obj_util.append_scene_data(obj,bpy_obj._scenes[j]);bpy_obj._object=obj;m_obj.update_object(bpy_obj,obj);obj.render.data_id=data_id;obj.is_hair_dupli=bpy_obj._is_hair_dupli||false}}function create_world_objects_from_bpy(bpy_data,bpy_worlds,data_id){for(var i=0;i<bpy_worlds.length;i++){var bpy_world=bpy_worlds[i];var meta_name="%meta_world%"+bpy_world["name"];var world=m_obj_util.create_object(meta_name,"WORLD",meta_name);
for(var j=0;j<bpy_world._scenes.length;j++)m_obj_util.append_scene_data(world,bpy_world._scenes[j]);bpy_world._object=world;m_obj.update_world(bpy_world,world)}}function calc_light_index(bpy_data,data_id){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];var lamps_counter=0;var scene_objs=m_obj.get_scene_objs(scene,"LAMP",data_id);for(var j=0;j<scene_objs.length;j++){var obj=scene_objs[j];var sc_data=m_obj_util.get_scene_data(obj,scene);sc_data.light_index=lamps_counter++}}}
function process_scenes(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){create_scene_props(bpy_data);for(var i=0;i<bpy_data["scenes"].length;i++){var scene_dst=thread.is_primary?bpy_data["scenes"][i]:_primary_scene;var lamps=thread.is_primary?m_obj.get_scene_objs(scene_dst,"LAMP",thread.id):m_obj.get_scene_objs(scene_dst,"LAMP",0);var scene_objs=m_obj.get_scene_objs(scene_dst,"ALL",thread.id);var bpy_mesh_objs=get_bpy_cache_scene(thread.id,scene_dst,"MESH");var bpy_empty_objs=get_bpy_cache_scene(thread.id,
scene_dst,"EMPTY");var bpy_world_objs=get_bpy_cache_scene(thread.id,scene_dst,"WORLD");if(thread.is_primary)m_scenes.append_scene(scene_dst,scene_objs,lamps,bpy_mesh_objs,bpy_empty_objs);for(var j=0;j<bpy_empty_objs.length;j++)m_obj.update_force(bpy_empty_objs[j]._object);var metaobjects=[];m_scenes.set_active(scene_dst);m_batch.generate_main_batches(scene_dst,bpy_mesh_objs,lamps,metaobjects);var bpy_line_objs=get_bpy_cache_scene(thread.id,scene_dst,"LINE");m_batch.generate_line_batches(scene_dst,
bpy_line_objs);var scene_graph=m_scenes.get_graph(scene_dst);if(thread.is_primary){var sky=scene_dst._render.sky_params;if(sky.render_sky||sky.procedural_skydome){var world=scene_dst["world"]._object;m_batch.append_sky_batch_to_world(scene_dst,sky,world);m_batch.create_forked_batches(world,scene_graph,scene_dst)}m_scenes.generate_auxiliary_batches(scene_graph)}for(var j=0;j<bpy_mesh_objs.length;j++)m_batch.create_forked_batches(bpy_mesh_objs[j]._object,scene_graph,scene_dst);for(var j=0;j<metaobjects.length;j++){m_batch.create_forked_batches(metaobjects[j],
scene_graph,scene_dst);m_obj.objects_storage_add(metaobjects[j])}var scene_objs=m_obj.get_scene_objs(scene_dst,"ALL",thread.id);m_scenes.assign_scene_data_subs(scene_dst,scene_objs,lamps);for(var j=0;j<scene_objs.length;j++){var obj=scene_objs[j];if(obj.render.use_shape_keys)m_obj.update_boundings(obj);if(m_obj_util.check_inv_zup_tsr_is_needed(obj))obj.need_inv_zup_tsr=true}}m_scenes.append_scene_vtex(_primary_scene,bpy_data["textures"],thread.id);if(thread.is_primary)if(_primary_scene._render.video_textures.length)thread.has_video_textures=
true;setup_dds_loading(bpy_data);cb_finish(thread,stage)}function create_scene_props(bpy_data){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];bpy_scene._camera=bpy_scene["camera"]._object}}function drop_bpy_data(bpy_data,thread){for(var i=0;i<bpy_data["scenes"].length;i++){var bpy_scene=bpy_data["scenes"][i];bpy_scene["camera"]=null}}function link_skinned_objs(objects){for(var i=0;i<objects.length;i++){var skinned_obj=objects[i];if(skinned_obj.type!="MESH")continue;
var armobj=skinned_obj.armobj;if(armobj){var render=armobj.render;var skinned_render=skinned_obj.render;var bone_skinning_info=skinned_render.bone_skinning_info;var mesh_bone_map=[];for(var bone_name in bone_skinning_info){var bi=bone_skinning_info[bone_name];var bone_index=bi.bone_index;var deform_bone_index=bi.deform_bone_index;var sk_ind=4*deform_bone_index;var ind=4*bone_index;mesh_bone_map.push(sk_ind,ind)}render.mesh_to_arm_bone_maps.push(mesh_bone_map);render.skinned_renders.push(skinned_obj.render)}}}
function setup_dds_loading(bpy_data){var materials=bpy_data["materials"];if(!cfg_ldr.dds_available||!cfg_def.use_dds){unset_images_dds(bpy_data["images"]);return}for(var i=0;i<materials.length;i++){var material=materials[i];var texture_slots=material["texture_slots"];for(var j=0;j<texture_slots.length;j++){var texture_slot=texture_slots[j];var texture=texture_slot["texture"];if(texture["type"]!="IMAGE"&&texture["type"]!="ENVIRONMENT_MAP")continue;var image=texture["image"];if(image._is_dds);else if(image["filepath"].indexOf(".dds")>
-1)image._is_dds=true;else{image._is_dds=!texture["b4w_disable_compression"]&&!texture_slot["use_map_normal"]&&texture["type"]!="ENVIRONMENT_MAP"&&!texture["b4w_shore_dist_map"]&&image["source"]!="MOVIE";if(image._is_dds)image["filepath"]+=".dds"}}var node_tree=material["node_tree"];if(node_tree){var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="TEXTURE"){var tex=node["texture"];if(tex){var image=tex["image"];if(image)if(image._is_dds);else{image._is_dds=
tex._render.allow_node_dds&&!tex["b4w_disable_compression"]&&image["source"]!="MOVIE"&&tex["type"]!="ENVIRONMENT_MAP";if(image._is_dds)image["filepath"]+=".dds"}}}}}}}function unset_images_dds(images){for(var i=0;i<images.length;i++){var image=images[i];var use_dds=Boolean(image["source"]=="FILE"&&image["filepath"].indexOf(".dds")>-1);image._is_dds=use_dds}}function get_global_anisotropic_filtering(bpy_data,thread){if(thread.is_primary)return bpy_data["scenes"][0]["b4w_anisotropic_filtering"];else return _primary_scene["b4w_anisotropic_filtering"]}
function duplicate_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var groups=bpy_data["groups"];var bpy_objects=bpy_data["objects"];var grp_ids_old={};var obj_ids_old={};var grp_ids={};var obj_ids={};for(var i=0;i<groups.length;i++){var group=groups[i];grp_ids_old[group["uuid"]]=group;grp_ids[group["uuid"]]=group}for(var i=0;i<bpy_objects.length;i++){var bpy_obj=bpy_objects[i];obj_ids_old[bpy_obj["uuid"]]=bpy_obj;obj_ids[bpy_obj["uuid"]]=bpy_obj}var scenes=bpy_data["scenes"];for(var i=
0;i<scenes.length;i++){var scene=scenes[i];duplicate_objects_iter(scene["objects"],null,obj_ids,grp_ids,null)}for(var id in grp_ids)if(!(id in grp_ids_old))groups.push(grp_ids[id]);for(var id in obj_ids)if(!(id in obj_ids_old))bpy_objects.push(obj_ids[id]);cb_finish(thread,stage)}function duplicate_objects_iter(obj_links,origin_obj,obj_ids,grp_ids,cluster_data){var proxy_source_ids=[];for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];var proxy_link=
bpy_obj["proxy"];if(proxy_link){if(origin_obj&&proxy_source_ids.indexOf(proxy_link["uuid"])==-1)proxy_source_ids.push(proxy_link["uuid"]);var proxy=obj_ids[proxy_link["uuid"]];var consts=proxy["constraints"];for(var j=0;j<consts.length;j++){var new_cons=m_util.clone_object_json(consts[j]);new_cons.name=new_cons.name+"_CLONE";bpy_obj["constraints"].push(new_cons)}if(!("b4w_proxy_inherit_anim"in bpy_obj)||bpy_obj["b4w_proxy_inherit_anim"]){var anim_data=bpy_obj["animation_data"];if(anim_data)proxy["animation_data"]=
m_util.clone_object_json(bpy_obj["animation_data"]);proxy["b4w_use_default_animation"]=bpy_obj["b4w_use_default_animation"];proxy["b4w_auto_skel_anim"]=bpy_obj["b4w_auto_skel_anim"];proxy["b4w_anim_behavior"]=bpy_obj["b4w_anim_behavior"];proxy["b4w_cyclic_animation"]=bpy_obj["b4w_cyclic_animation"]}}}for(var i=0;i<proxy_source_ids.length;i++){var proxy_src_id=proxy_source_ids[i];var obj_index=m_util.get_index_for_key_value(obj_links,"uuid",proxy_src_id);if(obj_index>-1)obj_links.splice(obj_index,
1)}var obj_id_overrides={};if(origin_obj)for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];var bpy_obj_new=m_util.clone_object_json(bpy_obj);var name="origin_name"in bpy_obj?bpy_obj["origin_name"]:bpy_obj["name"];bpy_obj_new["name"]=m_obj_util.gen_dupli_name(origin_obj["name"],name);bpy_obj_new["origin_name"]=name;bpy_obj_new["dg_parent"]={"uuid":origin_obj["uuid"]};assign_bpy_obj_id(bpy_obj_new);obj_ids[bpy_obj_new["uuid"]]=bpy_obj_new;obj_id_overrides[obj_link["uuid"]]=
bpy_obj_new["uuid"];obj_link["uuid"]=bpy_obj_new["uuid"];if(cluster_data&&cluster_data[bpy_obj["uuid"]])bpy_obj_new["b4w_cluster_data"]=cluster_data[bpy_obj["uuid"]]}for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];if(bpy_obj["dupli_group"]){var grp_link=bpy_obj["dupli_group"];var grp=grp_ids[grp_link["uuid"]];var grp_new=m_util.clone_object_json(grp);grp_new["name"]=m_util.unique_name(grp["name"]+"_CLONE");assign_grp_id(grp_new);grp_ids[grp_new["uuid"]]=
grp_new;grp_link["uuid"]=grp_new["uuid"];var dg_obj_links=grp_new["objects"];duplicate_objects_iter(dg_obj_links,bpy_obj,obj_ids,grp_ids,bpy_obj["b4w_cluster_data"])}}if(origin_obj)for(var i=0;i<obj_links.length;i++){var obj_link=obj_links[i];var bpy_obj=obj_ids[obj_link["uuid"]];if(bpy_obj["parent"]&&bpy_obj["parent"]["uuid"]in obj_id_overrides)bpy_obj["parent"]["uuid"]=obj_id_overrides[bpy_obj["parent"]["uuid"]];else if(bpy_obj["parent"]){m_print.warn("Object's \""+bpy_obj.name+'" parent is not in dupli group. Disabling parenting.');
bpy_obj["parent"]=null}var consts=bpy_obj["constraints"];for(var j=0;j<consts.length;j++){var cons=consts[j];if(cons["target"]&&cons["target"]["uuid"]in obj_id_overrides)cons["target"]["uuid"]=obj_id_overrides[cons["target"]["uuid"]]}var pose=bpy_obj["pose"];if(pose){var pose_bones=pose["bones"];for(var j=0;j<pose_bones.length;j++){var pose_bone=pose_bones[j];var constraints=pose_bone["constraints"];if(constraints)for(var k=0;k<constraints.length;k++){var cons=constraints[k];if(cons["target"]&&cons["target"]["uuid"]in
obj_id_overrides)cons["target"]["uuid"]=obj_id_overrides[cons["target"]["uuid"]]}}}var mods=bpy_obj["modifiers"];for(var j=0;j<mods.length;j++){var mod=mods[j];if(mod["object"]&&mod["object"]["uuid"]in obj_id_overrides)mod["object"]["uuid"]=obj_id_overrides[mod["object"]["uuid"]]}var lods=bpy_obj["lod_levels"];if(lods&&lods.length)for(var j=0;j<lods.length;j++){var lod=lods[j];if(lod["object"]&&lod["object"]["uuid"]in obj_id_overrides)lod["object"]["uuid"]=obj_id_overrides[lod["object"]["uuid"]]}}for(var key in obj_id_overrides)_dupli_obj_id_overrides[key]=
obj_id_overrides[key]}function assign_bpy_obj_id(bpy_obj){bpy_obj["uuid"]=m_md5.hexdigest("Object"+bpy_obj["name"])}function assign_grp_id(grp){grp["uuid"]=m_md5.hexdigest("Group"+grp["name"])}function make_bpy_links(bpy_data){var cameras=bpy_data["cameras"];var groups=bpy_data["groups"];var materials=bpy_data["materials"];var meshes=bpy_data["meshes"];var node_groups=bpy_data["node_groups"];var objects=bpy_data["objects"];var particles=bpy_data["particles"];var scenes=bpy_data["scenes"];var speakers=
bpy_data["speakers"];var lamps=bpy_data["lamps"];var textures=bpy_data["textures"];var worlds=bpy_data["worlds"];if(!node_groups){m_print.warn('"node_groups" datablock undefined. reexport main scene.');node_groups=bpy_data["node_groups"]=[]}var storage=gen_datablocks_storage(bpy_data);for(var i=0;i<scenes.length;i++){var scene=scenes[i];var scene_objects=scene["objects"];for(var j=0;j<scene_objects.length;j++)make_link_uuid(scene_objects,j,storage);if(scene["camera"])make_link_uuid(scene,"camera",
storage);if(scene["world"])make_link_uuid(scene,"world",storage)}for(var i=0;i<groups.length;i++){var group=groups[i];var group_objects=group["objects"];for(var j=0;j<group_objects.length;j++)make_link_uuid(group_objects,j,storage)}for(var i=0;i<objects.length;i++){var bpy_obj=objects[i];if(bpy_obj["dupli_group"])make_link_uuid(bpy_obj,"dupli_group",storage);if(bpy_obj["parent"])make_link_uuid(bpy_obj,"parent",storage);if(bpy_obj["dg_parent"])make_link_uuid(bpy_obj,"dg_parent",storage);if(bpy_obj["animation_data"]){var adata=
bpy_obj["animation_data"];if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}switch(bpy_obj["type"]){case "MESH":if(!bpy_obj["data"])throw"mesh not found for object "+bpy_obj["name"];make_link_uuid(bpy_obj,"data",storage);var found_armat_mod=false;var modifiers=bpy_obj["modifiers"];
for(var j=0;j<modifiers.length;j++){var modifier=modifiers[j];if(modifier["type"]=="ARMATURE"){if(found_armat_mod)m_print.warn('Object "'+bpy_obj["name"]+'" has more '+"than one armature modifiers. Only the first one will be used.");found_armat_mod=true;make_link_uuid(modifier,"object",storage)}else if(modifier["type"]=="CURVE")make_link_uuid(modifier,"object",storage)}var psystems=bpy_obj["particle_systems"];if(psystems)for(var j=0;j<psystems.length;j++){var psys=psystems[j];make_link_uuid(psys,
"settings",storage)}break;case "ARMATURE":make_link_uuid(bpy_obj,"data",storage);var pose=bpy_obj["pose"];var pose_bones=pose["bones"];var armature=bpy_obj["data"];var armature_bones=armature["bones"];for(var j=0;j<pose_bones.length;j++){var pose_bone=pose_bones[j];var bone_index=pose_bone["bone"];var armature_bone=armature_bones[bone_index];pose_bone["bone"]=armature_bone;var constraints=pose_bone["constraints"];if(constraints)for(var k=0;k<constraints.length;k++){var cons=constraints[k];if(cons["target"])make_link_uuid(cons,
"target",storage)}var parent_recursive=pose_bone["parent_recursive"];for(var k=0;k<parent_recursive.length;k++){var parent_index=parent_recursive[k];parent_recursive[k]=pose_bones[parent_index]}}break;case "LAMP":case "CAMERA":case "SPEAKER":case "CURVE":make_link_uuid(bpy_obj,"data",storage);break;case "EMPTY":default:break}var constraints=bpy_obj["constraints"];if(constraints)for(var j=0;j<constraints.length;j++){var cons=constraints[j];if(cons["target"])make_link_uuid(cons,"target",storage)}var lods=
bpy_obj["lod_levels"];if(lods)for(var j=0;j<lods.length;j++){var lod=lods[j];if(lod["object"])make_link_uuid(lod,"object",storage)}}for(var i=0;i<meshes.length;i++){var mesh=meshes[i];var mesh_materials=mesh["materials"];for(var j=0;j<mesh_materials.length;j++)make_link_uuid(mesh_materials,j,storage)}for(var i=0;i<materials.length;i++){var material=materials[i];var texture_slots=material["texture_slots"];for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage);var node_tree=
material["node_tree"];if(!node_tree)continue;process_node_tree(node_tree,storage)}for(var i=0;i<node_groups.length;i++){var node_group=node_groups[i];var node_tree=node_group["node_tree"];if(!node_tree)continue;process_node_tree(node_tree,storage)}for(var i=0;i<textures.length;i++){var texture=textures[i];var tex_type=texture["type"];if(tex_type=="IMAGE"||tex_type=="ENVIRONMENT_MAP")make_link_uuid(texture,"image",storage)}for(var i=0;i<cameras.length;i++){var camera=cameras[i];if(camera["dof_object"])make_link_uuid(camera,
"dof_object",storage)}for(var i=0;i<speakers.length;i++){var speaker=speakers[i];if(speaker["sound"])make_link_uuid(speaker,"sound",storage);if(speaker["animation_data"]){var adata=speaker["animation_data"];if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}}for(var i=
0;i<particles.length;i++){var part=particles[i];var texture_slots=part["texture_slots"];for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage);if(part["dupli_group"])make_link_uuid(part,"dupli_group",storage);if(part["dupli_object"])make_link_uuid(part,"dupli_object",storage)}for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(lamp["animation_data"]){var adata=lamp["animation_data"];if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=
0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}}for(var i=0;i<worlds.length;i++){var world=worlds[i];var texture_slots=world["texture_slots"];if(texture_slots)for(var j=0;j<texture_slots.length;j++)make_link_uuid(texture_slots[j],"texture",storage);if(world["animation_data"]){var adata=world["animation_data"];if(adata["action"])make_link_uuid(adata,"action",
storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}}}function process_node_tree(node_tree,storage){var nodes=node_tree["nodes"];for(var j=0;j<nodes.length;j++){var node=nodes[j];if(node["type"]=="TEXTURE"&&node["texture"])make_link_uuid(node,"texture",storage);if(node["type"]=="LAMP"&&node["lamp"]){if(node["lamp"]["uuid"]in
_dupli_obj_id_overrides)node["lamp"]["uuid"]=_dupli_obj_id_overrides[node["lamp"]["uuid"]];if(!storage[node["lamp"]["uuid"]])node["lamp"]=null}if(node["type"]=="GROUP"&&node["node_group"])make_link_uuid(node,"node_group",storage)}var links=node_tree["links"];for(var j=0;j<links.length;j++){var link=links[j];make_link_name(link,"from_node",nodes);make_link_name(link,"to_node",nodes);make_link_ident(link,"from_socket",link["from_node"]["outputs"]);make_link_ident(link,"to_socket",link["to_node"]["inputs"])}var adata=
node_tree["animation_data"];if(adata){if(adata["action"])make_link_uuid(adata,"action",storage);if(adata["nla_tracks"])for(var j=0;j<adata["nla_tracks"].length;j++){var track=adata["nla_tracks"][j];for(var k=0;k<track["strips"].length;k++)if(track["strips"][k]["action"])make_link_uuid(track["strips"][k],"action",storage)}}}function gen_datablocks_storage(bpy_data){var DB_NAMES=["actions","armatures","cameras","curves","groups","images","lamps","materials","meshes","node_groups","objects","particles",
"scenes","sounds","speakers","textures","worlds"];var storage={};for(var i=0;i<DB_NAMES.length;i++){var db_arr=bpy_data[DB_NAMES[i]];for(var j=0;j<db_arr.length;j++){var db=db_arr[j];storage[db["uuid"]]=db}}return storage}function make_link_uuid(storage,prop,uuid_storage){var entity_new=uuid_storage[storage[prop]["uuid"]];if(!entity_new)m_print.error("Dangling link found:",prop,storage);storage[prop]=entity_new}function make_link_name(storage,property,search_here){var entity_old=storage[property];
var entity_new=m_util.keysearch("name",entity_old["name"],search_here);storage[property]=entity_new}function make_link_ident(storage,property,search_here){var entity_old=storage[property];var entity_new=m_util.keysearch("identifier",entity_old["identifier"],search_here);storage[property]=entity_new}function copy_link(from,to){for(var prop in from)if(!(prop in to))to[prop]=from[prop]}function load_textures(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var dir_path=dirname(thread.filepath);
var images=bpy_data["images"];var img_by_uri={};var image_assets=[];for(var i=0;i<images.length;i++){var image=images[i];var uuid=image["uuid"];if(image["source"]==="FILE"||image["source"]==="MOVIE"){var tex_users=find_image_users(image,bpy_data["textures"]);if(!tex_users.length){m_print.warn("image ",image["name"]," has no users.");continue}if(tex_users[0]["b4w_shore_dist_map"])continue;var image_path=m_util.normpath_preserve_protocol(dir_path+image["filepath"]);if(image["source"]==="FILE"){if(image._is_dds)var asset_type=
m_assets.AT_ARRAYBUFFER;else var asset_type=m_assets.AT_IMAGE_ELEMENT;if(cfg_ldr.min50_available&&cfg_def.use_min50){var head_ext=m_assets.split_extension(image_path);if(head_ext[1]=="dds"){var head_ext_wo_dds=m_assets.split_extension(head_ext[0]);image_path=head_ext_wo_dds[0]+".min50."+head_ext_wo_dds[1]+".dds"}else image_path=head_ext[0]+".min50."+head_ext[1]}}else if(image["source"]==="MOVIE")if(!cfg_def.seq_video_fallback){var head_ext=m_assets.split_extension(image_path);var ext=m_sfx.detect_video_container(head_ext[1]);
if(ext!=head_ext[1])image_path=head_ext[0]+".altconv."+ext;else image_path=head_ext[0]+"."+ext;var asset_type=m_assets.AT_VIDEO_ELEMENT}else{var head_ext=m_assets.split_extension(image_path);image_path=head_ext[0]+".altconv.seq";var asset_type=m_assets.AT_SEQ_VIDEO_ELEMENT}image_assets.push({id:uuid,type:asset_type,url:image_path});img_by_uri[uuid]=image}}if(image_assets.length){var image_counter=0;var asset_cb=function(image_data,uri,type,path){if(image_data){var show_path_warning=true;if(type==
m_assets.AT_VIDEO_ELEMENT||type==m_assets.AT_SEQ_VIDEO_ELEMENT)print_video_info(image_data,path,show_path_warning,type);else print_image_info(image_data,path,show_path_warning);var image=img_by_uri[uri];var tex_users=find_image_users(image,bpy_data["textures"]);for(var i=0;i<tex_users.length;i++){var tex_user=tex_users[i];var filepath=tex_user["image"]["filepath"];if(type==m_assets.AT_SEQ_VIDEO_ELEMENT){tex_user._render.seq_fps=image_data.fps;m_tex.update_texture(tex_user._render,image_data.images,
image._is_dds,filepath,thread.id)}else m_tex.update_texture(tex_user._render,image_data,image._is_dds,filepath,thread.id)}}var rate=++image_counter/image_assets.length;cb_set_rate(thread,stage,rate)};var pack_cb=function(){m_print.log("%cLOADED ALL IMAGES","color: #0a0");cb_finish(thread,stage)};m_assets.enqueue(image_assets,asset_cb,pack_cb)}else cb_finish(thread,stage)}function update_scenes_nla(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var scenes=m_scenes.get_rendered_scenes();for(var i=
0;i<scenes.length;i++){var scene=scenes[i];if(scene["b4w_use_nla"]){var nla_cyclic=scene["b4w_nla_cyclic"];if(scene["b4w_use_logic_editor"])nla_cyclic=false;m_nla.update_scene(scene,nla_cyclic,thread.id)}}cb_finish(thread,stage)}function find_image_users(image,textures){var tex_image_users=[];for(var i=0;i<textures.length;i++){var tex=textures[i];if(tex["image"]===image)tex_image_users.push(tex)}return tex_image_users}function load_speakers(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var dir_path=
dirname(thread.filepath);var sound_assets=[];var spks_by_uuid={};var objects=m_obj.get_all_objects(thread.id);for(var i=0;i<objects.length;i++){var obj=objects[i];if(is_loaded_spk(obj)){var uuid=obj.sfx.uuid;if(m_sfx.get_spk_behavior(obj)=="BACKGROUND_MUSIC"){uuid=m_util.gen_uuid();thread.has_background_music=true}else if(m_sfx.get_spk_behavior(obj)!="NONE"&&cfg_def.init_wa_context_hack)thread.init_wa_context=true;if(!(uuid in spks_by_uuid)){spks_by_uuid[uuid]=[];var sound_path=m_util.normpath_preserve_protocol(dir_path+
obj.sfx.filepath);switch(m_sfx.source_type(obj)){case m_sfx.AST_ARRAY_BUFFER:var asset_type=m_assets.AT_AUDIOBUFFER;break;case m_sfx.AST_HTML_ELEMENT:var asset_type=m_assets.AT_AUDIO_ELEMENT;break}var head_ext=m_assets.split_extension(sound_path);var ext=m_sfx.detect_audio_container(head_ext[1]);if(ext!=head_ext[1])sound_path=head_ext[0]+".altconv."+ext;else sound_path=head_ext[0]+"."+ext;sound_assets.push({id:uuid,type:asset_type,url:sound_path})}spks_by_uuid[uuid].push(obj)}}if(sound_assets.length){var sound_counter=
0;var asset_cb=function(sound_data,uuid,type,path){if(sound_data){m_print.log("%cLOAD SOUND","color: #0aa",path);if(path.indexOf(_debug_resources_root)==-1)m_print.warn("sound",path,"is not from app root.");var spk_objs=spks_by_uuid[uuid];for(var i=0;i<spk_objs.length;i++)m_sfx.update_spkobj(spk_objs[i],sound_data)}var rate=++sound_counter/sound_assets.length;cb_set_rate(thread,stage,rate)};var pack_cb=function(){m_print.log("%cLOADED ALL SOUNDS","color: #0aa");cb_finish(thread,stage)};m_assets.enqueue(sound_assets,
asset_cb,pack_cb)}else cb_finish(thread,stage)}function is_loaded_spk(obj){return m_obj_util.is_speaker(obj)&&m_sfx.source_type(obj)!=m_sfx.AST_NONE}function speakers_play(scene,data_id,force_init){var spk_objs=m_obj.get_scene_objs(scene,"SPEAKER",data_id);for(var i=0;i<spk_objs.length;i++){var sobj=spk_objs[i];if(!m_obj_util.is_speaker(sobj))continue;if(m_sfx.is_cyclic(sobj)||force_init)m_sfx.play_def(sobj)}}function video_play(scene,data_id){var textures=scene._render.video_textures;for(var i=0;i<
textures.length;i++){var vtex=textures[i]._render;if(scene["b4w_use_nla"]&&textures[i]["b4w_nla_video"]||!textures[i]["use_auto_refresh"])continue;if(data_id!=vtex.vtex_data_id)continue;m_tex.reset_video(vtex.name,data_id);m_tex.play_video(vtex.name,data_id)}}function start_nla(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){m_nla.start();m_print.log("%cSTART NLA","color: #0a0");cb_finish(thread,stage)}function create_special_materials(bpy_data){var materials=bpy_data["materials"];var default_material=
m_reformer.create_material("DEFAULT");materials.push(default_material)}function assign_default_material(bpy_data){var meshes=bpy_data["meshes"];var def_mat=m_util.keysearch("name","DEFAULT",bpy_data["materials"]);for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(mesh["materials"].length==0)mesh["materials"].push(def_mat)}}function prepare_bpy_actions(actions,data_id){for(var i=0;i<actions.length;i++){var action=actions[i];action._data_id=data_id;m_anim.append_action(action)}}function prepare_bpy_lods(bpy_data){var scenes=
bpy_data["scenes"];for(var i=0;i<scenes.length;i++){var scene=scenes[i];var added_objs=[];var removed_objs=[];var scene_objs=scenes[i]["objects"];for(var j=0;j<scene_objs.length;j++){var bpy_obj=scene_objs[j];prepare_bpy_obj_lods(scene_objs,bpy_obj,null,added_objs,removed_objs);var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];for(var k=0;k<dg_objects.length;k++){var dg_obj=dg_objects[k];prepare_bpy_obj_lods(dg_objects,dg_obj,bpy_obj,added_objs,removed_objs)}}}for(var j=
0;j<removed_objs.length;j++)remove_bpy_object(removed_objs[j],[scene]);for(var j=0;j<added_objs.length;j++)m_util.append_unique(added_objs[j][0],added_objs[j][1])}}function prepare_bpy_obj_lods(container,lod_parent_bpy,dg_parent_bpy,added_objs,removed_objs){if(!(lod_parent_bpy["lod_levels"]&&lod_parent_bpy["lod_levels"].length))return;var lods_num=lod_parent_bpy["lod_levels"].length;for(var i=0;i<lods_num;i++){var lod=lod_parent_bpy["lod_levels"][i];var lod_obj=lod["object"];if(!lod_obj)continue;
var lod_obj_new=m_util.clone_object_nr(lod_obj);lod_obj_new["name"]=lod_parent_bpy["name"]+"_LOD_"+String(i+1);lod_obj_new["b4w_cluster_data"]=lod_parent_bpy["b4w_cluster_data"];assign_bpy_obj_id(lod_obj_new);lod_obj_new["lod_levels"]=[];if(dg_parent_bpy)lod_obj_new["dg_parent"]=dg_parent_bpy;added_objs.push([container,lod_obj_new]);removed_objs.push(lod_obj);lod["object"]=lod_obj_new}}function calc_max_bones(objects){var upper_max_bones=-1;var blending_max_bones=-1;var gl_max_bones=m_anim.get_max_bones();
for(var i=0;i<objects.length;i++){var obj=objects[i];var render=obj.render;if(!(m_obj_util.is_mesh(obj)&&render.is_skinning))continue;var max_bones=render.max_bones;if(max_bones>upper_max_bones)upper_max_bones=max_bones;if(gl_max_bones>=max_bones&&max_bones>blending_max_bones)blending_max_bones=max_bones}for(var i=0;i<objects.length;i++){var obj=objects[i];var render=obj.render;if(!(m_obj_util.is_mesh(obj)&&render.is_skinning))continue;render.frames_blending=true;if(upper_max_bones<gl_max_bones)render.max_bones=
upper_max_bones;else if(render.max_bones<=gl_max_bones)render.max_bones=blending_max_bones;else{m_print.warn('too many bones for "'+obj.name+'" / '+render.max_bones+" bones (max "+gl_max_bones+" with blending, "+2*gl_max_bones+" without blending)."+" Blending between frames will be disabled.");render.max_bones=upper_max_bones;render.frames_blending=false}render.frames_blending=render.frames_blending&&!cfg_anim.frames_blending_hack}}function prepare_lod_objects(bpy_objects){for(var i=0;i<bpy_objects.length;i++){var bpy_obj=
bpy_objects[i];var obj=bpy_obj._object;if(!m_obj_util.is_mesh(obj))continue;var lods_num=bpy_obj["lod_levels"].length;if(!lods_num)continue;var prev_lod_obj=obj;for(var j=0;j<lods_num;j++){var bpy_lod_obj=bpy_obj["lod_levels"][j]["object"];if(bpy_lod_obj){var lod_obj=bpy_lod_obj._object;lod_obj.render.lod_transition_ratio=obj.render.lod_transition_ratio;prev_lod_obj.render.lod_dist_max=bpy_obj["lod_levels"][j]["distance"];lod_obj.render.lod_dist_min=bpy_obj["lod_levels"][j]["distance"];if(bpy_obj["lod_levels"][j+
1])lod_obj.render.lod_dist_max=bpy_obj["lod_levels"][j+1]["distance"];else{lod_obj.render.last_lod=true;lod_obj.render.lod_dist_max=DEFAULT_LOD_DIST_MAX;break}prev_lod_obj.render.last_lod=false;prev_lod_obj=lod_obj}else{prev_lod_obj.render.last_lod=true;prev_lod_obj.render.lod_dist_max=bpy_obj["lod_levels"][j]["distance"];break}}if(DEBUG_LOD_DIST_NOT_SET&&bpy_obj["lod_levels"][lods_num-1]["distance"]===DEFAULT_LOD_DIST_MAX)m_print.warn('object "'+obj.name+'" has default LOD distance.')}}function prepare_vehicles(objects){for(var i=
0;i<objects.length;i++){var obj_i=objects[i];if(!obj_i.is_vehicle)continue;var vh_set_i=obj_i.vehicle_settings;if(vh_set_i.part=="CHASSIS"){obj_i.vehicle={};obj_i.vehicle.force_max=vh_set_i.force_max;obj_i.vehicle.brake_max=vh_set_i.brake_max;obj_i.vehicle.suspension_compression=vh_set_i.suspension_compression;obj_i.vehicle.suspension_stiffness=vh_set_i.suspension_stiffness;obj_i.vehicle.suspension_damping=vh_set_i.suspension_damping;obj_i.vehicle.wheel_friction=vh_set_i.wheel_friction;obj_i.vehicle.roll_influence=
vh_set_i.roll_influence;obj_i.vehicle.max_suspension_travel_cm=vh_set_i.max_suspension_travel_cm;obj_i.vehicle.engine_force=0;obj_i.vehicle.brake_force=1;obj_i.vehicle.steering=0;obj_i.vehicle.speed=0;obj_i.vehicle.props=[];obj_i.vehicle.prop_offsets=[];obj_i.vehicle.steering_wheel=null;var dg_parent=m_obj_util.get_dg_parent(obj_i);if(dg_parent)var car_objects=m_obj_util.get_dg_objects(dg_parent,objects);else var car_objects=objects;for(var j=0;j<car_objects.length;j++){var obj_j=car_objects[j];if(!obj_j.is_vehicle)continue;
var vh_set_j=obj_j.vehicle_settings;if(m_phy.is_car_wheel(obj_j)&&vh_set_i.name==vh_set_j.name){var w_index=m_phy.wheel_index(obj_j.vehicle_settings.part);obj_i.vehicle.props[w_index]=obj_j;obj_i.vehicle.prop_offsets[w_index]=new Float32Array(8)}else if(m_phy.is_vehicle_steering_wheel(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.steering_wheel=obj_j;obj_i.vehicle.steering_max=vh_set_j.steering_max;obj_i.vehicle.steering_ratio=vh_set_j.steering_ratio;obj_i.vehicle.inverse_control=vh_set_j.inverse_control;
var wtsr_inv=m_tsr.invert(obj_i.render.world_tsr,m_tsr.create());var steering_wheel_tsr=m_tsr.multiply(wtsr_inv,obj_j.render.world_tsr,wtsr_inv);obj_i.vehicle.steering_wheel_tsr=steering_wheel_tsr;var steering_wheel_axis=new Float32Array([1,0,0]);m_tsr.transform_dir_vec3(steering_wheel_axis,steering_wheel_tsr,steering_wheel_axis);obj_i.vehicle.steering_wheel_axis=steering_wheel_axis}else if(m_phy.is_vehicle_speedometer(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.speedometer=obj_j;obj_i.vehicle.speed_ratio=
vh_set_j.speed_ratio;obj_i.vehicle.max_speed_angle=vh_set_j.max_speed_angle;var wtsr_inv=m_tsr.invert(obj_i.render.world_tsr,m_tsr.create());var speedometer_tsr=m_tsr.multiply(wtsr_inv,obj_j.render.world_tsr,wtsr_inv);obj_i.vehicle.speedometer_tsr=speedometer_tsr;var speedometer_axis=new Float32Array([1,0,0]);m_tsr.transform_dir_vec3(speedometer_axis,speedometer_tsr,speedometer_axis);obj_i.vehicle.speedometer_axis=speedometer_axis}else if(m_phy.is_vehicle_tachometer(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.tachometer=
obj_j;obj_i.vehicle.delta_tach_angle=vh_set_j.delta_tach_angle;var wtsr_inv=m_tsr.invert(obj_i.render.world_tsr,m_tsr.create());var tachometer_tsr=m_tsr.multiply(wtsr_inv,obj_j.render.world_tsr,wtsr_inv);obj_i.vehicle.tachometer_tsr=tachometer_tsr;var tachometer_axis=new Float32Array([1,0,0]);m_tsr.transform_dir_vec3(tachometer_axis,tachometer_tsr,tachometer_axis);obj_i.vehicle.tachometer_axis=tachometer_axis}}if(obj_i.vehicle.props.length!=4)throw"Not enough wheels for chassis "+obj_i.name;}else if(vh_set_i.part==
"HULL"){obj_i.vehicle={};obj_i.vehicle.props=[];obj_i.vehicle.prop_offsets=[];obj_i.vehicle.force_max=vh_set_i.force_max;obj_i.vehicle.brake_max=vh_set_i.brake_max;obj_i.vehicle.floating_factor=vh_set_i.floating_factor;obj_i.vehicle.water_lin_damp=vh_set_i.water_lin_damp;obj_i.vehicle.water_rot_damp=vh_set_i.water_rot_damp;obj_i.vehicle.engine_force=0;obj_i.vehicle.brake_force=1;obj_i.vehicle.steering=0;obj_i.vehicle.speed=0;obj_i.vehicle.steering_wheel=null;var dg_parent=m_obj_util.get_dg_parent(obj_i);
if(dg_parent)var boat_objects=m_obj_util.get_dg_objects(dg_parent,objects);else var boat_objects=objects;for(var j=0;j<boat_objects.length;j++){var obj_j=boat_objects[j];if(!obj_j.is_vehicle)continue;var vh_set_j=obj_j.vehicle_settings;if(m_phy.is_boat_bob(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.props.push(obj_j);obj_i.vehicle.prop_offsets.push(new Float32Array(8))}else if(m_phy.is_vehicle_steering_wheel(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.steering_wheel=obj_j;obj_i.vehicle.steering_max=
vh_set_j.steering_max;obj_i.vehicle.steering_ratio=vh_set_j.steering_ratio;obj_i.vehicle.inverse_control=vh_set_j.inverse_control;var wtsr_inv=m_tsr.invert(obj_i.render.world_tsr,m_tsr.create());var steering_wheel_tsr=m_tsr.multiply(wtsr_inv,obj_j.render.world_tsr,wtsr_inv);obj_i.vehicle.steering_wheel_tsr=steering_wheel_tsr;var steering_wheel_axis=new Float32Array([1,0,0]);m_tsr.transform_dir_vec3(steering_wheel_axis,steering_wheel_tsr,steering_wheel_axis);obj_i.vehicle.steering_wheel_axis=steering_wheel_axis}else if(m_phy.is_vehicle_speedometer(obj_j)&&
vh_set_i.name==vh_set_j.name){obj_i.vehicle.speedometer=obj_j;obj_i.vehicle.speed_ratio=vh_set_j.speed_ratio;obj_i.vehicle.max_speed_angle=vh_set_j.max_speed_angle;var wtsr_inv=m_tsr.invert(obj_i.render.world_tsr,m_tsr.create());var speedometer_tsr=m_tsr.multiply(wtsr_inv,obj_j.render.world_tsr,wtsr_inv);obj_i.vehicle.speedometer_tsr=speedometer_tsr;var speedometer_axis=new Float32Array([1,0,0]);m_tsr.transform_dir_vec3(speedometer_axis,speedometer_tsr,speedometer_axis);obj_i.vehicle.speedometer_axis=
speedometer_axis}else if(m_phy.is_vehicle_tachometer(obj_j)&&vh_set_i.name==vh_set_j.name){obj_i.vehicle.tachometer=obj_j;obj_i.vehicle.delta_tach_angle=vh_set_j.delta_tach_angle;var wtsr_inv=m_tsr.invert(obj_i.render.world_tsr,m_tsr.create());var tachometer_tsr=m_tsr.multiply(wtsr_inv,obj_j.render.world_tsr,wtsr_inv);obj_i.vehicle.tachometer_tsr=tachometer_tsr;var tachometer_axis=new Float32Array([1,0,0]);m_tsr.transform_dir_vec3(tachometer_axis,tachometer_tsr,tachometer_axis);obj_i.vehicle.tachometer_axis=
tachometer_axis}}}}}function prepare_floaters(objects){for(var i=0;i<objects.length;i++){var obj_i=objects[i];if(!obj_i.is_floating)continue;var fl_set_i=obj_i.floating_settings;if(fl_set_i.part=="MAIN_BODY"){obj_i.floater={};obj_i.floater.floating_factor=fl_set_i.floating_factor;obj_i.floater.water_lin_damp=fl_set_i.water_lin_damp;obj_i.floater.water_rot_damp=fl_set_i.water_rot_damp;obj_i.floater.bobs=[];var dg_parent=m_obj_util.get_dg_parent(obj_i);if(dg_parent)var bob_objects=m_obj_util.get_dg_objects(dg_parent,
objects);else var bob_objects=objects;for(var j=0;j<bob_objects.length;j++){var obj_j=bob_objects[j];if(!obj_j.is_floating)continue;var fl_set_j=obj_j.floating_settings;if(m_phy.is_floater_bob(obj_j)&&fl_set_i.name==fl_set_j.name){obj_i.floater.bobs.push(obj_j);obj_j.bob_synchronize_pos=obj_j.floating_settings.synchronize_position}}}}}function remove_bpy_object(remobj,bpy_scenes){for(var i=0;i<bpy_scenes.length;i++){var bpy_objs=bpy_scenes[i]["objects"];for(var j=0;j<bpy_objs.length;j++){var bpy_obj=
bpy_objs[j];var dupli_group=bpy_obj["dupli_group"];if(dupli_group){var dg_objects=dupli_group["objects"];obj_index=dg_objects.indexOf(remobj);if(obj_index>-1)dg_objects.splice(obj_index,1)}}var obj_index=bpy_objs.indexOf(remobj);if(obj_index>-1)bpy_objs.splice(obj_index,1)}}function wait_physics_workers(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var loaded=true;for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];if(!m_phy.check_worker_loaded(scene)){loaded=false;
break}}if(loaded){cb_finish(thread,stage);m_print.log("%cPHYSICS READY","color: #0a0")}}function add_physics_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];if(thread.is_primary)var enable_physics=m_phy.scene_has_physics(scene);else{var enable_physics=m_phy.scene_has_physics(_primary_scene)||m_phy.scene_has_physics(scene);scene=_primary_scene}if(cfg_phy.enabled&&enable_physics)for(var j=0;j<ADD_PHY_TYPES.length;j++){var type=
ADD_PHY_TYPES[j];var sobjs=m_obj.get_scene_objs(scene,type,thread.id);for(var k=0;k<sobjs.length;k++){var obj=sobjs[k];if(obj.render.data_id==thread.id){m_phy.append_object(obj,scene);if(thread.load_hidden&&m_phy.obj_has_physics(obj))m_phy.disable_simulation(obj)}}}}cb_finish(thread,stage)}function load_shoremap(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var img_by_uri={};var image_assets=[];var bpy_scenes=bpy_data["scenes"];for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_scenes[i];
if(scene._render.water_params){var image=scene._render.water_params.shoremap_image;if(image&&image["source"]==="FILE"){var uuid=image["uuid"];var dir_path=dirname(thread.filepath);var image_path=m_util.normpath_preserve_protocol(dir_path+image["filepath"]);if(image._is_dds)var asset_type=m_assets.AT_ARRAYBUFFER;else var asset_type=m_assets.AT_IMAGE_ELEMENT;image_assets.push({id:uuid,type:asset_type,url:image_path});img_by_uri[uuid]=image}}}if(image_assets.length){var asset_cb=function(html_image,
uri,type,path){if(!html_image){var image=img_by_uri[uri];for(var i=0;i<bpy_scenes.length;i++){var scene=bpy_scenes[i];var shr_image=scene._render.water_params.shoremap_image;if(shr_image===image){scene._render.water_params.shoremap_image=null;m_print.warn("image",shr_image["filepath"]," was not found. Disabling water shore effects.")}}return}var show_path_warning=true;print_image_info(html_image,path,show_path_warning);var image=img_by_uri[uri];var tex_users=find_image_users(image,bpy_data["textures"]);
for(var i=0;i<tex_users.length;i++){var tex_user=tex_users[i];var filepath=tex_user["image"]["filepath"];m_tex.update_texture(tex_user._render,html_image,image._is_dds,filepath,thread.id)}for(var i=0;i<bpy_scenes.length;i++){var scene=bpy_scenes[i];if(scene._render.water_params){var shr_image=scene._render.water_params.shoremap_image;if(shr_image===image)update_scene_shore_distance(html_image,image,scene)}}};var pack_cb=function(){cb_finish(thread,stage)};m_assets.enqueue(image_assets,asset_cb,pack_cb)}else cb_finish(thread,
stage)}function update_scene_shore_distance(html_image,shoremap,scene){var tmpcanvas=document.createElement("canvas");var width=shoremap.size[0];var height=shoremap.size[1];tmpcanvas.width=width;tmpcanvas.height=height;var ctx=tmpcanvas.getContext("2d");ctx.drawImage(html_image,0,0);var image_data=ctx.getImageData(0,0,width,height);var dist_color=image_data.data;var bit_shift=new Float32Array(4);bit_shift[0]=1/(255*255*255);bit_shift[1]=1/(255*255);bit_shift[2]=1/255;bit_shift[3]=1;var arr_size=width*
height;var shore_distances=new Float32Array(arr_size);for(var j=0;j<arr_size;j++)shore_distances[j]=bit_shift[1]*dist_color[4*j+2]+bit_shift[2]*dist_color[4*j+3];scene._render.shore_distances=shore_distances}function load_smaa_textures(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var scene=bpy_data["scenes"][0];var subs_smaa_arr=[];var smaa_passes_names=["SMAA_EDGE_DETECTION","SMAA_BLENDING_WEIGHT_CALCULATION","SMAA_NEIGHBORHOOD_BLENDING","SMAA_RESOLVE"];for(var i=0;i<smaa_passes_names.length;i++){var smaa_sub=
m_scenes.get_subs(scene,smaa_passes_names[i]);if(smaa_sub)subs_smaa_arr.push(smaa_sub)}if(!subs_smaa_arr.length){cb_finish(thread,stage);return}var smaa_images=[];var dir_path=dirname(thread.filepath);var asset_type=m_assets.AT_IMAGE_ELEMENT;var search_texture_path=m_cfg.paths.smaa_search_texture_path;smaa_images.push({id:"SEARCH_TEXTURE",type:asset_type,filepath:search_texture_path});var area_texture_path=m_cfg.paths.smaa_area_texture_path;smaa_images.push({id:"AREA_TEXTURE",type:asset_type,url:area_texture_path});
for(var i=0;i<subs_smaa_arr.length;i++){var subs_smaa=subs_smaa_arr[i];if(subs_smaa.type=="SMAA_BLENDING_WEIGHT_CALCULATION"){var slinks_internal=subs_smaa.slinks_internal;for(var j=0;j<slinks_internal.length;j++){var slink=slinks_internal[j];if(slink.to=="u_search_tex")var search_texture=slink.texture;else if(slink.to=="u_area_tex")var area_texture=slink.texture}break}}if(smaa_images.length){var asset_cb=function(image_data,uri,type,path){if(!image_data)return;var show_path_warning=false;print_image_info(image_data,
path,show_path_warning);if(uri=="SEARCH_TEXTURE")var texture=search_texture;else var texture=area_texture;texture.source="IMAGE";texture.auxilary_texture=true;var is_dds=path.indexOf(".dds")!=-1?1:0;m_tex.update_texture(texture,image_data,is_dds,path,thread.id);m_tex.set_filters(texture,m_tex.TF_LINEAR,m_tex.TF_LINEAR)};var pack_cb=function(){cb_finish(thread,stage)};m_assets.enqueue(smaa_images,asset_cb,pack_cb)}else cb_finish(thread,stage)}function prepare_objects_adding(bpy_data,thread,stage,cb_param,
cb_finish,cb_set_rate){for(var i=0;i<bpy_data["scenes"].length;i++){var scene=bpy_data["scenes"][i];if(!thread.is_primary)scene=_primary_scene;var lamps=m_obj.get_scene_objs(scene,"LAMP",thread.id);for(var j=0;j<lamps.length;j++){var lamp=lamps[j];if(lamp.render.data_id==thread.id)cb_param.added_objects.push({scene:scene,obj:lamp})}var objs=m_obj.get_scene_objs(scene,"ALL",thread.id);for(var j=0;j<objs.length;j++){var obj=objs[j];if(obj.type=="LAMP")continue;if(obj.render.data_id==thread.id){if(thread.load_hidden&&
m_obj_util.is_mesh(obj))m_scenes.change_visibility(obj,true);cb_param.added_objects.push({scene:scene,obj:obj})}}}}function add_objects(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){var obj_data=cb_param.added_objects;var obj_counter=cb_param.obj_counter;if(obj_data.length){var obj=obj_data[obj_counter].obj;var scene=obj_data[obj_counter].scene;var sc_data=m_obj_util.get_scene_data(obj,scene);m_scenes.append_object(scene,obj,false);if(obj.anchor)m_anchors.append(obj);var rate=++cb_param.obj_counter/
obj_data.length;var cube_refl_subs=sc_data.cube_refl_subs;if(obj.render.cube_reflection_id!=null&&cube_refl_subs){var center=m_vec3.copy(obj.render.bs_world.center,_vec3_tmp);m_scenes.update_cube_reflect_subs(cube_refl_subs,center)}var refl_objs=obj.reflective_objs;if(refl_objs.length&&scene._render.reflection_params){var rp_trans=m_tsr.get_trans_view(obj.render.world_tsr);var rp_quat=m_tsr.get_quat_view(obj.render.world_tsr);var refl_subs=sc_data.plane_refl_subs;for(var i=0;i<refl_subs.length;i++){m_scenes.update_plane_reflect_subs(refl_subs[i],
rp_trans,rp_quat);m_obj_util.update_refl_objects(refl_objs,refl_subs[i].camera.reflection_plane)}}}else var rate=1;cb_set_rate(thread,stage,rate)}function end_objects_adding(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(thread.is_primary){var scene_main=m_scenes.get_main();var scenes=m_scenes.get_rendered_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];m_scenes.prepare_rendering(scene,scene_main);if(scene["b4w_use_logic_editor"])m_lnodes.init_logic(scene,thread.id)}m_scenes.set_active(scene_main)}else m_scenes.update_scene_permanent_uniforms(_primary_scene);
var objects=m_obj.get_all_objects(thread.id);m_obj.update_objects_dynamics(objects);for(var k=0;k<objects.length;k++){var obj=objects[k];for(var i=0;i<obj.scenes_data.length;i++){var batches=obj.scenes_data[i].batches;for(var j=0;j<batches.length;j++)if(batches[j].shader==null)batches.splice(j--,1)}}cb_finish(thread,stage)}function synchronize_media(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){if(thread.is_primary)for(var i=0;i<bpy_data["scenes"].length;i++){video_play(bpy_data["scenes"][i],
thread.id);speakers_play(bpy_data["scenes"][i],thread.id)}else{video_play(_primary_scene,thread.id);speakers_play(_primary_scene,thread.id)}cb_finish(thread,stage)}exports.setup_canvas=function(canvas){_canvas=canvas};function mobile_media_start(bpy_data,thread,stage,cb_param,cb_finish,cb_set_rate){drop_bpy_data(bpy_data,thread);if(cfg_def.media_auto_activation&&(thread.has_video_textures||thread.has_background_music||thread.init_wa_context)){if(!_play_media_btn)create_media_controls(bpy_data,cb_finish,
thread,stage)}else cb_finish(thread,stage)}function create_media_controls(bpy_data,cb_finish,thread,stage){var canvas_container=_canvas.parentElement;_canvas_container_z_index=canvas_container.style.zIndex;canvas_container.style.zIndex="999";_play_media_btn=document.createElement("div");_play_media_btn.style.position="relative";_play_media_btn.style.height="88px";_play_media_btn.style.width="88px";var h=Math.round(_canvas.offsetHeight/2-44);var w=Math.round(_canvas.offsetWidth/2-44);_play_media_btn.style.top=
h.toString()+"px";_play_media_btn.style.left=w.toString()+"px";_play_media_btn.style.backgroundImage="url('"+PLAY_MEDIA_IMAGE_MOBILE+"')";_play_media_btn.style.backgroundSize="88px";_play_media_bkg=document.createElement("div");_play_media_bkg.style.position="relative";_play_media_bkg.style.height=_canvas.offsetHeight.toString()+"px";_play_media_bkg.style.width=_canvas.offsetWidth.toString()+"px";_play_media_bkg.style.background="rgba(0, 0, 0, 0.5)";_play_media_bkg.style.zIndex="999";canvas_container.appendChild(_play_media_bkg);
_play_media_bkg.appendChild(_play_media_btn);_play_media_btn.addEventListener("touchstart",init_media,false);_play_media_btn.addEventListener("click",init_media,false);var semaphore=false;function init_media(){if(semaphore)return;semaphore=true;if(thread.has_video_textures){m_tex.play();m_tex.pause();m_tex.reset()}if(thread.has_background_music){if(thread.is_primary)for(var i=0;i<bpy_data["scenes"].length;i++)speakers_play(bpy_data["scenes"][i],thread.id,true);else speakers_play(_primary_scene,thread.id,
true);m_sfx.pause()}if(thread.init_wa_context)m_sfx.play_empty_sound();remove_media_controls();cb_finish(thread,stage)}}function remove_media_controls(){if(_play_media_btn){var canvas_container=_canvas.parentElement;canvas_container.style.zIndex=_canvas_container_z_index;_play_media_bkg.removeChild(_play_media_btn);canvas_container.removeChild(_play_media_bkg);_play_media_bkg=null;_play_media_btn=null;_canvas_container_z_index=0}}exports.update_media_controls=function(width,height){if(_play_media_btn){_play_media_bkg.style.height=
height.toString()+"px";_play_media_bkg.style.width=width.toString()+"px";var h=Math.round(height/2-44);var w=Math.round(width/2-44);_play_media_btn.style.top=h.toString()+"px";_play_media_btn.style.left=w.toString()+"px"}};function dirname(path){var dirname=path.split("/").slice(0,-1).join("/");if(dirname)dirname+="/";return dirname}exports.load=function(path,loaded_cb,stageload_cb,wait_complete_loading,load_hidden){var stages={"load_main":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,
inputs:[],is_resource:false,relative_size:500,primary_only:false,cb_before:load_main},"duplicate_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["load_main"],is_resource:false,relative_size:50,primary_only:false,cb_before:duplicate_objects},"load_binaries":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,inputs:["load_main"],is_resource:false,relative_size:500,primary_only:false,cb_before:load_binaries},"wait_for_shaders":{priority:m_loader.SYNC_PRIORITY,background_loading:false,
inputs:[],is_resource:false,relative_size:50,primary_only:true,cb_loop:wait_for_shaders},"prepare_bindata":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["duplicate_objects","load_binaries"],is_resource:false,relative_size:100,primary_only:false,cb_before:prepare_bindata},"prepare_bpy_data":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["duplicate_objects","prepare_bindata"],is_resource:false,relative_size:100,primary_only:false,cb_before:prepare_bpy_data},"process_objects":{priority:m_loader.SYNC_PRIORITY,
background_loading:false,inputs:["prepare_bpy_data"],is_resource:false,relative_size:150,primary_only:false,cb_before:process_objects},"process_scenes":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["process_objects","wait_for_shaders"],is_resource:false,relative_size:300,primary_only:false,cb_before:process_scenes},"load_smaa_textures":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,inputs:["process_scenes"],is_resource:false,relative_size:30,primary_only:true,cb_before:load_smaa_textures},
"load_shoremap":{priority:m_loader.ASYNC_PRIORITY,background_loading:false,inputs:["process_scenes"],is_resource:false,relative_size:30,primary_only:true,cb_before:load_shoremap},"load_textures":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["process_scenes"],is_resource:true,relative_size:500,primary_only:false,cb_before:load_textures},"update_scenes_nla":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["process_scenes","load_textures"],is_resource:false,relative_size:50,
primary_only:false,cb_before:update_scenes_nla},"wait_physics_workers":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["load_shoremap"],is_resource:false,relative_size:20,primary_only:false,cb_loop:wait_physics_workers},"add_physics_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["wait_physics_workers"],is_resource:false,relative_size:50,primary_only:false,cb_before:add_physics_objects},"add_objects":{priority:m_loader.SYNC_PRIORITY,background_loading:false,
inputs:["add_physics_objects"],is_resource:false,relative_size:600,primary_only:false,cb_before:prepare_objects_adding,cb_loop:add_objects,cb_after:end_objects_adding,cb_param:{added_objects:[],obj_counter:0}},"load_speakers":{priority:m_loader.ASYNC_PRIORITY,background_loading:true,inputs:["add_objects"],is_resource:true,relative_size:100,primary_only:false,cb_before:load_speakers},"mobile_media_start":{priority:m_loader.SYNC_PRIORITY,background_loading:false,inputs:["load_textures","update_scenes_nla",
"load_speakers"],is_resource:true,relative_size:5,primary_only:false,cb_before:mobile_media_start,cb_loop:mobile_media_start},"synchronize_media":{priority:m_loader.SYNC_PRIORITY,background_loading:true,inputs:["mobile_media_start"],is_resource:true,relative_size:50,primary_only:false,cb_before:synchronize_media},"start_nla":{priority:m_loader.SYNC_PRIORITY,background_loading:true,inputs:["mobile_media_start"],is_resource:false,relative_size:5,primary_only:true,cb_before:start_nla}};var scheduler=
m_loader.get_scheduler();if(!scheduler){scheduler=m_loader.create_scheduler();_bpy_data_array={};_all_objects_cache={};_dupli_obj_id_overrides={}}_bpy_data_array[scheduler.threads.length]={};var data_id=m_loader.create_thread(stages,path,loaded_cb,stageload_cb,free_load_data,wait_complete_loading||cfg_sfx.audio_loading_hack,cfg_def.do_not_load_resources,load_hidden);return data_id};exports.unload=function(data_id){var scheduler=m_loader.get_scheduler();if(!scheduler||!scheduler.threads.length||data_id&&
!m_loader.thread_is_finished(scheduler.threads[data_id])){m_print.error("Unable to unload data!");return}if(data_id==0){m_print.log("%cUNLOAD ALL","color: #00a");m_anchors.cleanup();m_anim.cleanup();m_sfx.cleanup();m_nla.cleanup();m_scenes.cleanup();m_loader.cleanup();m_ctl.cleanup();m_phy.cleanup();m_obj.cleanup();m_util.cleanup();m_render.cleanup();m_nodemat.cleanup();m_shaders.cleanup();m_ext.cleanup();m_assets.cleanup();m_tex.cleanup();m_lnodes.cleanup();m_particles.cleanup();m_input.cleanup();
_all_objects_cache=null;_dupli_obj_id_overrides={};_primary_scene=null;_bpy_data_array=null;_media_data_init=false}else{m_print.log("%cUNLOAD DATA "+data_id,"color: #00a");m_anim.remove_actions(data_id);var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];var objs=m_obj.get_scene_objs(scene,"ALL",data_id);for(var j=objs.length-1;j>=0;j--){var obj=objs[j];prepare_object_unloading(scene,obj,true);m_obj.remove_object(obj)}}}remove_media_controls()};exports.prepare_object_unloading=
prepare_object_unloading;function prepare_object_unloading(scene,obj,clean_buffs){if(m_anim.is_animated(obj))m_anim.remove(obj);m_particles.remove_obj_from_cache(obj);m_obj.clear_outline_anim(obj);if(m_ctl.check_sensor_manifold(obj))m_ctl.remove_sensor_manifold(obj);if(m_phy.obj_has_physics(obj))m_phy.remove_object(obj);m_scenes.remove_object_bundles(scene,obj,clean_buffs);if(m_obj_util.is_speaker(obj))m_sfx.speaker_remove(obj);if(m_anchors.is_anchor(obj))m_anchors.remove(obj)}exports.set_debug_resources_root=
function(debug_resources_root){_debug_resources_root=debug_resources_root};function parent_num(bpy_obj){var par=get_parent(bpy_obj);if(par)return 1+parent_num(par);else return 0}function get_parent(bpy_obj){var armobj=m_anim.get_bpy_armobj(bpy_obj);if(armobj&&armobj["parent"]==bpy_obj)return null;else return bpy_obj["parent"]||armobj}exports.activate_media=function(){if(!_media_data_init&&!cfg_def.media_auto_activation){m_tex.play();m_tex.pause();m_tex.reset();speakers_play(_primary_scene,m_obj.DATA_ID_ALL,
true);m_sfx.pause();if(cfg_def.init_wa_context_hack)m_sfx.play_empty_sound();_media_data_init=true}}};b4w.module["__batch"]=function(exports,require){var m_bounds=require("__boundings");var m_cfg=require("__config");var m_print=require("__print");var m_extensions=require("__extensions");var m_geometry=require("__geometry");var m_graph=require("__graph");var m_nodemat=require("__nodemat");var m_obj_util=require("__obj_util");var m_particles=require("__particles");var m_primitives=require("__primitives");var m_quat=require("__quat");var m_reformer=require("__reformer");var m_render=require("__renderer");
var m_scenegraph=require("__scenegraph");var m_shaders=require("__shaders");var m_textures=require("__textures");var m_tsr=require("__tsr");var m_util=require("__util");var m_anim=require("__animation");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var m_mat3=require("__mat3");var cfg_def=m_cfg.defaults;var DEBUG_SAVE_SUBMESHES=false;var DEBUG_KEEP_BUFS_DATA_ARRAYS=false;var BATCH_TYPES_DEBUG_SPHERE=["MAIN"];var STREE_CELL_COUNT=20;var DEFAULT_PART_SYS_QUAT=new Float32Array([0,-Math.sqrt(.5),
0,Math.sqrt(.5)]);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _tsr_tmp=m_tsr.create();var _bb_corners_tmp=new Float32Array(24);var _mat3_tmp=m_mat3.create();exports.BATCH_INHERITED_TEXTURES=BATCH_INHERITED_TEXTURES;var BATCH_INHERITED_TEXTURES=["u_colormap0","u_colormap1","u_stencil0","u_specmap0","u_normalmap0","u_mirrormap"];exports.init_batch=init_batch;function init_batch(type){var batch={type:type,
subtype:"",id:0,render_id:0,cluster_id:-1,debug_id:-1,odd_id_prop:"",textures:[],texture_names:[],material_names:[],common_attributes:[],uv_maps_usage:null,vertex_colors_usage:{},shader:null,shaders_info:{vert:null,frag:null,directives:[],node_elements:[]},attribute_setters:[],particle_system:null,bufs_data:null,use_shape_keys:false,debug_sphere:false,debug_sphere_dynamic:false,debug_view_mode:0,num_vertices:0,num_triangles:0,jitter_amp:0,jitter_freq:0,grass_scale_threshold:0,grass_size:0,grass_map_dim:new Float32Array(3),
cube_fog:new Float32Array(16),alpha_clip:false,blend:false,color_mask:false,depth_mask:false,xray:false,use_backface_culling:false,use_shadeless:false,dynamic_geometry:false,shadow_cast:false,shadow_cast_only:false,shadow_receive:false,reflexible:false,reflexible_only:false,reflective:false,dynamic_grass:false,procedural_sky:false,draw_mode:m_geometry.DM_DEFAULT,z_sort:false,can_fork_outline:false,forked_batch:false,psys_name:"",shadow_source:"",halo:false,halo_size:0,halo_hardness:0,halo_stars_blend:0,
halo_stars_height:0,halo_rings_color:new Float32Array(3),halo_lines_color:new Float32Array(3),halo_particles:false,ambient:0,emit:0,diffuse_intensity:1,reflect_factor:0,specular_color_factor:0,specular_alpha:1,parallax_scale:0,diffuse_color_factor:0,alpha_factor:1,normal_factor:0,mirror_factor:0,offset_z:0,refr_bump:0,diffuse_params:new Array(2),specular_params:new Float32Array(3),texture_scale:new Float32Array(3),specular_color:new Float32Array(3),diffuse_color:new Float32Array(4),fresnel_params:new Float32Array(4),
lamp_uuid_indexes:null,lamp_light_positions:null,lamp_light_directions:null,lamp_light_color_intensities:null,lamp_light_factors:null,has_nodes:false,water:false,water_dynamic:false,water_shore_smoothing:false,water_generated_mesh:false,water_num_cascads:0,water_subdivs:0,water_detailed_dist:0,water_norm_uv_velocity:.1,shallow_water_col_fac:0,shore_water_col_fac:0,foam_factor:0,foam_uv_freq:new Float32Array(2),foam_mag:new Float32Array(2),foam_scale:new Float32Array(2),shallow_water_col:new Float32Array(3),
shore_water_col:new Float32Array(3),normalmap_scales:null,refractive:false,particles_data:null,line_width:0,part_use_tangent:false,part_node_data:null,node_values:null,node_value_inds:null,node_anim_inds:null,node_rgbs:null,node_rgb_inds:null,node_rgb_anim_inds:null,bb_local:null,be_local:null,bb_world:null,be_world:null};batch.diffuse_color[3]=1;batch.color_mask=true;batch.depth_mask=true;batch.line_width=1;return batch}exports.generate_main_batches=function(scene,bpy_mesh_objects,lamps,meta_objects){var bpy_dynamic_objs=
[];var bpy_static_objs=[];separate_dynamic_objs(bpy_mesh_objects,bpy_dynamic_objs,bpy_static_objs);var all_mbatches=[];all_mbatches=all_mbatches.concat(make_dynamic_metabatches(bpy_dynamic_objs,scene._render.graph));all_mbatches=all_mbatches.concat(make_static_metabatches(bpy_static_objs,scene._render.graph));var metabatches=merge_metabatches(all_mbatches);for(var i=0;i<metabatches.length;i++){var batch=metabatches[i].batch;batch.material_names=metabatches[i].mat_names;update_batch_geometry(batch,
metabatches[i].submesh);update_batch_lights(batch,lamps,scene);if(metabatches[i].render.type=="STATIC"&&batch.type!="COLOR_ID"){var unique_name=m_util.unique_name("%meta%"+batch.type+"%"+batch.material_names.join("%")+"%");var meta_obj=m_obj_util.create_object(unique_name,"MESH");meta_obj.render=m_util.clone_object_r(metabatches[i].render);m_obj_util.append_scene_data(meta_obj,scene);m_obj_util.append_batch(meta_obj,scene,batch);meta_objects.push(meta_obj);var bounding_verts=[];for(var j=0;j<metabatches[i].rel_bpy_objects.length;j++){var bpy_obj=
metabatches[i].rel_bpy_objects[j];var obj=bpy_obj._object;m_bounds.extract_bb_corners(obj.render.bb_world,_bb_corners_tmp);for(var k=0;k<_bb_corners_tmp.length;k++)bounding_verts.push(_bb_corners_tmp[k]);if(batch.type=="MAIN")obj.meta_objects.push(meta_obj)}meta_obj.render.be_world=m_bounds.create_bounding_ellipsoid_by_bb(bounding_verts,true);meta_obj.render.be_local=m_bounds.calc_be_local_by_tsr(meta_obj.render.be_world,meta_obj.render.world_tsr)}else{var unique_obj_names=[];for(var j=0;j<metabatches[i].rel_bpy_objects.length;j++){var bpy_obj=
metabatches[i].rel_bpy_objects[j];var obj=bpy_obj._object;if(unique_obj_names.indexOf(obj.name)==-1){m_obj_util.append_batch(obj,scene,batch);unique_obj_names.push(obj.name)}}}}if(cfg_def.debug_view){for(var i=0;i<metabatches.length;i++){var render=metabatches[i].render;if(render.type=="DYNAMIC"){var obj=metabatches[i].rel_bpy_objects[0]._object;if(BATCH_TYPES_DEBUG_SPHERE.indexOf(metabatches[i].batch.type)>-1){var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;var has_debug_sphere=
false;for(var j=0;j<batches.length;j++)if(batches[j].debug_sphere){has_debug_sphere=true;continue}if(has_debug_sphere)continue;var ds_batch=create_bounding_ellipsoid_batch(render.be_local,render,obj.name,true,true,render);m_obj_util.append_batch(obj,scene,ds_batch)}}}for(var i=0;i<meta_objects.length;i++){var obj=meta_objects[i];var render=obj.render;var sc_data=m_obj_util.get_scene_data(obj,scene);var batches=sc_data.batches;if(BATCH_TYPES_DEBUG_SPHERE.indexOf(batches[0].type)>-1){var ds_batch=create_bounding_ellipsoid_batch(batches[0].be_world,
render,obj.name,true,false,batches[0]);m_obj_util.append_batch(obj,scene,ds_batch)}}for(var i=0;i<metabatches.length;i++)metabatches[i].batch.debug_id=i}for(var i=0;i<bpy_mesh_objects.length;i++){var sc_data=m_obj_util.get_scene_data(bpy_mesh_objects[i]._object,scene);var batches=sc_data.batches;for(var j=0;j<batches.length;j++)update_batch_subtype(batches[j])}for(var i=0;i<meta_objects.length;i++){var sc_data=m_obj_util.get_scene_data(meta_objects[i],scene);var batches=sc_data.batches;for(var j=
0;j<batches.length;j++)update_batch_subtype(batches[j])}};function separate_dynamic_objs(bpy_mesh_objects,dynamic_objs,static_objs){for(var i=0;i<bpy_mesh_objects.length;i++){var bpy_obj=bpy_mesh_objects[i];var obj=bpy_obj._object;if(obj.is_hair_dupli)continue;if(m_obj_util.is_dynamic(obj))dynamic_objs.push(bpy_obj);else static_objs.push(bpy_obj)}}exports.append_sky_batch_to_world=function(scene,sky,world){var wls=scene._render.world_light_set;var batch=init_batch("MAIN");apply_shader(batch,"special_skydome.glslv",
"special_skydome.glslf");if(sky.procedural_skydome){set_batch_directive(batch,"PROCEDURAL_SKYDOME",1);batch.procedural_sky=true}else{var sts=wls.sky_texture_param;if(sts){set_batch_directive(batch,"WO_SKYTEX",1);var sky_texture=m_textures.get_batch_texture(wls.sky_texture_slot,null);append_texture(batch,sky_texture,"u_sky");if(sts.invert)set_batch_directive(batch,"MTEX_NEGATIVE",1);if(sts.use_rgb_to_intensity)set_batch_directive(batch,"MTEX_RGBTOINT",1);set_batch_directive(batch,"BLENDTYPE",sts.blend_type);
if(sts.use_map_blend)set_batch_directive(batch,"WOMAP_BLEND",1);if(sts.use_map_horizon)set_batch_directive(batch,"WOMAP_HORIZ",1);if(sts.use_map_zenith_up)set_batch_directive(batch,"WOMAP_ZENUP",1);if(sts.use_map_zenith_down)set_batch_directive(batch,"WOMAP_ZENDOWN",1)}if(wls.use_sky_blend)set_batch_directive(batch,"WO_SKYBLEND",1);if(wls.use_sky_paper)set_batch_directive(batch,"WO_SKYPAPER",1);if(wls.use_sky_real)set_batch_directive(batch,"WO_SKYREAL",1)}if(sky.reflexible){batch.reflexible=true;
if(sky.reflexible_only)batch.reflexible_only=true}batch.offset_z=99999;set_batch_c_attr(batch,"a_position");var submesh=m_primitives.generate_fullscreen_quad();update_batch_geometry(batch,submesh);update_batch_subtype(batch);var sc_data=m_obj_util.get_scene_data(world,scene);world.render.do_not_cull=true;world.render.bb_local=m_bounds.zero_bounding_box();world.render.bs_local=m_bounds.zero_bounding_sphere();world.render.bb_world=m_bounds.zero_bounding_box();world.render.bs_world=m_bounds.zero_bounding_sphere();
world.render.be_local=m_bounds.zero_bounding_ellipsoid();world.render.be_world=m_bounds.zero_bounding_ellipsoid();batch.be_local=m_bounds.zero_bounding_ellipsoid();batch.be_world=m_bounds.zero_bounding_ellipsoid();batch.bb_local=m_bounds.zero_bounding_box();batch.bb_world=m_bounds.zero_bounding_box();sc_data.batches.push(batch)};function update_batch_subtype(batch){switch(batch.type){case "MAIN":case "PARTICLES":case "LINE":if(batch.blend)if(batch.xray)batch.subtype="XRAY";else batch.subtype="BLEND";
else batch.subtype="OPAQUE";break;case "SHADOW":if(batch.shadow_cast_only)batch.subtype="CAST";else batch.subtype="RECEIVE";break;case "COLOR_ID":if(batch.xray)batch.subtype="COLOR_ID_XRAY";else batch.subtype="COLOR_ID";break}}exports.create_forked_batches=function(obj,graph,scene){var scene_data=m_obj_util.get_scene_data(obj,scene);var batches=scene_data.batches;var forked_batches=[];var shadow_cast_subs=m_scenegraph.find_subs(graph,"SHADOW_CAST");var main_reflect_subs=m_scenegraph.find_subs(graph,
"MAIN_PLANE_REFLECT");var cube_reflect_subs=m_scenegraph.find_subs(graph,"MAIN_CUBE_REFLECT");var outline_mask_subs=m_scenegraph.find_subs(graph,"OUTLINE_MASK");var picking_mask_subs=m_scenegraph.find_subs(graph,"COLOR_PICKING");for(var j=0;j<batches.length;j++){var batch_src=batches[j];var batch=null;if(batch_src.type=="SHADOW"&&batch_src.subtype=="RECEIVE"&&batch_src.shadow_cast){batch=copy_forked_batch(batch_src);batch.subtype="CAST"}if((batch_src.type=="MAIN"||batch_src.type=="PARTICLES")&&(main_reflect_subs||
cube_reflect_subs)&&batch_src.reflexible){batch=copy_forked_batch(batch_src);batch.subtype="REFLECT";batch.particles_data=batch_src.particles_data;if(batch.z_sort){batch.z_sort=false;batch.depth_mask=false}}if(batch_src.type=="COLOR_ID"&&batch_src.can_fork_outline)if(outline_mask_subs&&obj.render.outlining)if(picking_mask_subs&&obj.render.selectable){batch=copy_forked_batch(batch_src);batch.subtype="OUTLINE"}else batch_src.subtype="OUTLINE";if(batch){batch.forked_batch=true;update_batch_id(batch,
obj.render.id);forked_batches.push(batch)}}batches.push.apply(batches,forked_batches)};function copy_forked_batch(batch_src){var bufs_data=batch_src.bufs_data;batch_src.bufs_data=null;var batch=m_obj_util.copy_object_props_by_value(batch_src);batch_src.bufs_data=bufs_data;batch.bufs_data=bufs_data;return batch}function batch_copy_wo_bufs(batch){var batch_copy=m_util.clone_object_nr(batch);batch.shaders_info=JSON.parse(JSON.stringify(batch.shaders_info));return batch_copy}function make_dynamic_metabatches(bpy_dynamic_objs,
graph){var metabatches=[];for(var i=0;i<bpy_dynamic_objs.length;i++){var bpy_obj=bpy_dynamic_objs[i];var render=bpy_obj._object.render;var bb_local=m_bounds.zero_bounding_box();m_bounds.copy_bb(render.bb_original,bb_local);var cyl_radius=bpy_obj["data"]["b4w_bounding_cylinder_radius"];var bs_radius=bpy_obj["data"]["b4w_bounding_sphere_radius"];var bs_center=bpy_obj["data"]["b4w_bounding_sphere_center"];var be_axes=bpy_obj["data"]["b4w_bounding_ellipsoid_axes"];var be_center=bpy_obj["data"]["b4w_bounding_ellipsoid_center"];
if(render.billboard){var x=Math.max(Math.abs(bb_local.max_x),Math.abs(bb_local.min_x));var y=Math.max(Math.abs(bb_local.max_y),Math.abs(bb_local.min_y));var z=Math.max(Math.abs(bb_local.max_z),Math.abs(bb_local.min_z));var sphere_radius=Math.sqrt(x*x+y*y+z*z);var cylinder_radius=Math.sqrt(x*x+y*y);bb_local.max_x=bb_local.max_y=bb_local.max_z=sphere_radius;bb_local.min_x=bb_local.min_y=bb_local.min_z=-sphere_radius;cyl_radius=cylinder_radius;bs_radius=sphere_radius;bs_center[0]=bs_center[1]=bs_center[2]=
0;be_axes[0]=be_axes[1]=be_axes[2]=sphere_radius;be_center[0]=be_center[1]=be_center[2]=0}render.bb_local=bb_local;var bb_world=m_bounds.bounding_box_transform(bb_local,render.world_tsr);render.bb_world=bb_world;set_local_cylinder_capsule(render,cyl_radius,cyl_radius,bb_local);var bs_local=m_bounds.create_bounding_sphere(bs_radius,bs_center);render.bs_local=bs_local;var bs_world=m_bounds.bounding_sphere_transform(bs_local,render.world_tsr);render.bs_world=bs_world;var be_local=m_bounds.create_bounding_ellipsoid([be_axes[0],
0,0],[0,be_axes[1],0],[0,0,be_axes[2]],be_center);render.be_local=be_local;var be_world=m_bounds.bounding_ellipsoid_transform(be_local,render.world_tsr);render.be_world=be_world;metabatches=metabatches.concat(make_object_metabatches(bpy_obj,render,graph))}return metabatches}function make_static_metabatches(bpy_static_objs,graph){var metabatches=[];var clusters=create_object_clusters(bpy_static_objs);for(var i=0;i<clusters.length;i++){var render=clusters[i].render;var bpy_objs=clusters[i].bpy_objects;
for(var j=0;j<bpy_objs.length;j++){var bpy_obj=bpy_objs[j];var obj_render=bpy_obj._object.render;var obj_metabatches=make_object_metabatches(bpy_obj,render,graph);var tsr=m_tsr.create();if(obj_render.billboard&&!obj_render.billboard_pres_glob_orientation){var obj_trans=m_tsr.get_trans_view(obj_render.world_tsr);m_tsr.set_trans(obj_trans,tsr)}else m_tsr.copy(obj_render.world_tsr,tsr);var params={};if(render.wind_bending||render.billboard)params["au_center_pos"]=[tsr[0],tsr[1],tsr[2]];if(render.wind_bending){params["au_wind_bending_amp"]=
[obj_render.wind_bending_amp];params["au_wind_bending_freq"]=[bpy_obj["b4w_wind_bending_freq"]];params["au_detail_bending_amp"]=[bpy_obj["b4w_detail_bending_amp"]];params["au_detail_bending_freq"]=[bpy_obj["b4w_detail_bending_freq"]];params["au_branch_bending_amp"]=[bpy_obj["b4w_branch_bending_amp"]]}for(var k=0;k<obj_metabatches.length;k++){var metabatch_render=obj_metabatches[k].render;var submesh=obj_metabatches[k].submesh;var batch=obj_metabatches[k].batch;if(!metabatch_render.is_hair_particles){if(batch.type==
"COLOR_ID"){obj_metabatches[k].render=obj_render;batch.odd_id_prop=bpy_obj["uuid"];update_batch_render(batch,obj_render);var render_id=calculate_render_id(obj_render);update_batch_id(batch,render_id,0)}submesh=m_geometry.submesh_apply_transform(submesh,tsr);submesh=m_geometry.submesh_apply_params(submesh,params)}else if(metabatch_render.billboard)submesh=m_geometry.submesh_apply_particle_transform(submesh,tsr);else submesh=m_geometry.submesh_apply_transform(submesh,tsr)}metabatches=metabatches.concat(obj_metabatches)}}return metabatches}
function make_object_metabatches(bpy_obj,render,graph){var metabatches=[];var batch_types=get_batch_types(graph,render,!render.do_not_render,false);var render_id=calculate_render_id(render);var mesh=bpy_obj["data"];var materials=mesh["materials"];var batches_main=new Array(materials.length);var batches_debug_view=new Array(materials.length);var subs_main=m_scenegraph.find_subs(graph,"MAIN_OPAQUE");var has_lamp=false;if(subs_main)has_lamp=subs_main.light_positions.length?true:false;for(var i=0;i<batch_types.length;i++){var type=
batch_types[i];for(var j=0;j<materials.length;j++){var material=materials[j];if(material["name"]=="LENS_FLARES"&&!has_lamp)continue;if(m_geometry.has_empty_submesh(mesh,j))continue;var batch=init_batch(type);if(type=="COLOR_ID")batch.can_fork_outline=!(bpy_obj["b4w_do_not_render"]||material["b4w_do_not_render"]);if(type=="MAIN")batches_main[j]=batch;else if(type=="DEBUG_VIEW")batches_debug_view[j]=batch;batch.cluster_id=bpy_obj["b4w_cluster_data"]["cluster_id"];if(!batch_material_is_valid(batch,material))continue;
if(type=="SHADOW"&&batches_main[j])batch.use_shadeless=batches_main[j].use_shadeless;batch.draw_mode=render.use_shape_keys||render.dynamic_geometry?m_geometry.DM_DYNAMIC_TRIANGLES:m_geometry.DM_DEFAULT;update_batch_render(batch,render);update_batch_particle_systems(batch,bpy_obj["particle_systems"]);if(render.type=="DYNAMIC")batch.odd_id_prop=bpy_obj["uuid"];update_batch_id(batch,render_id);var submesh=m_geometry.extract_submesh(mesh,j,batch.common_attributes,render.bone_skinning_info,batch.vertex_colors_usage,
batch.uv_maps_usage);var submesh_bd=submesh.submesh_bd;submesh_bd.bb_world=m_bounds.bounding_box_transform(submesh_bd.bb_local,bpy_obj._object.render.world_tsr);submesh_bd.be_world=m_bounds.bounding_ellipsoid_transform(submesh_bd.be_local,bpy_obj._object.render.world_tsr);if(material["name"]=="LENS_FLARES")submesh=m_particles.prepare_lens_flares(submesh);metabatches.push({batch:batch,submesh:submesh,mat_names:[material["name"]],render:render,rel_bpy_objects:[bpy_obj]})}}for(var i=0;i<batches_debug_view.length;i++)if(batches_debug_view[i]){batches_debug_view[i].debug_id=
batches_main[i].id;update_batch_id(batches_debug_view[i],batches_debug_view[i].render_id)}var psystems=bpy_obj["particle_systems"];if(psystems.length>0&&metabatches.length){var render_emitter=false;var need_emitter_submesh=false;for(var i=0;i<psystems.length;i++){var psys=psystems[i];var pset=psys["settings"];if(pset["use_render_emitter"])render_emitter=true;if(pset["type"]=="HAIR"&&(pset["render_type"]=="OBJECT"||pset["render_type"]=="GROUP"||!psys["transforms"].length))need_emitter_submesh=true;
if(render_emitter&&need_emitter_submesh)break}var emitter_vc=metabatches[0].batch.vertex_colors_usage;if(need_emitter_submesh)if(materials.length>1)var em_submesh=build_emitter_submesh(mesh,psystems,emitter_vc,bpy_obj._object.render);else var em_submesh=metabatches[0].submesh;else var em_submesh=null;var particles_metabatches=make_particles_metabatches(bpy_obj,render,graph,render_id,emitter_vc,em_submesh);if(render_emitter)metabatches=metabatches.concat(particles_metabatches);else metabatches=particles_metabatches}return metabatches}
function build_emitter_submesh(mesh,psystems,emitter_vc,render){var emitter_inherit_vc_usage={};for(var i=0;i<psystems.length;i++){var pset=psystems[i]["settings"];if(pset["type"]=="HAIR"&&(pset["render_type"]=="OBJECT"||pset["render_type"]=="GROUP")){var vcol_from=pset["b4w_vcol_from_name"];var vcol_to=pset["b4w_vcol_to_name"];if(vcol_from!==""&&vcol_to!=="")emitter_inherit_vc_usage[vcol_from]=m_util.clone_object_r(emitter_vc[vcol_from])}}if("a_bending_col_main"in emitter_vc)emitter_inherit_vc_usage["a_bending_col_main"]=
m_util.clone_object_r(emitter_vc["a_bending_col_main"]);if("a_bending_col_detail"in emitter_vc)emitter_inherit_vc_usage["a_bending_col_detail"]=m_util.clone_object_r(emitter_vc["a_bending_col_detail"]);return m_geometry.extract_submesh_all_mats(mesh,[],emitter_inherit_vc_usage,render)}function make_particles_metabatches(bpy_obj,render,graph,render_id,emitter_vc,em_submesh){var obj=bpy_obj._object;var metabatches=[];var psystems=bpy_obj["particle_systems"];var mesh=bpy_obj["data"];var materials=mesh["materials"];
for(var i=0;i<psystems.length;i++){var psys=psystems[i];var pset=psys["settings"];if(!pset["count"])continue;if(pset["type"]=="EMITTER"){if(render.type=="DYNAMIC"){var batch=init_batch("PARTICLES");batch.bb_local=render.bb_local;batch.be_local=render.be_local;batch.bb_world=render.bb_world;batch.be_world=render.be_world;var pmaterial=select_psys_material(psys,mesh["materials"]);if(psys["settings"]["render_type"]==="HALO"&&pmaterial["type"]==="HALO")batch.halo_particles=true;update_batch_material(batch,
pmaterial);update_batch_particles_emitter(batch,psys,bpy_obj);batch.dynamic_geometry=true;batch.odd_id_prop=obj.name+"_"+pset["uuid"];batch.psys_name=psys["name"];update_batch_id(batch,render_id);m_particles.init_particles_data(batch,psys,pmaterial);var submesh=m_particles.generate_emitter_particles_submesh(batch,mesh,psys,obj.render);m_particles.update_particles_submesh(submesh,batch,pset["count"],pmaterial);m_particles.update_particles_objs_cache(obj);update_batch_render(batch,obj.render);metabatches.push({batch:batch,
submesh:submesh,mat_names:[pmaterial["name"]],render:render,rel_bpy_objects:[bpy_obj]})}}else if(pset["type"]=="HAIR"){var seed=m_util.init_rand_r_seed(psys["seed"]);if(pset["b4w_dynamic_grass"])render.do_not_cull=true;var use_particles_rotation=m_reformer.check_particles_bin_format(cfg_def.loaded_data_version)&&!pset["b4w_initial_rand_rotation"]&&!pset["b4w_hair_billboard"];var data_len=4;if(use_particles_rotation)data_len=8;if(psys["transforms"].length)var ptrans=psys["transforms"];else{var points=
m_geometry.geometry_random_points(em_submesh,pset["count"],false,seed);var ptrans=new Float32Array(points.length*data_len);for(var j=0;j<points.length;j++){var scale=.75+.5*m_util.rand_r(seed);ptrans[j*data_len]=points[j][0];ptrans[j*data_len+1]=points[j][1];ptrans[j*data_len+2]=points[j][2];ptrans[j*data_len+3]=scale;if(use_particles_rotation){ptrans[j*data_len+4]=1;ptrans[j*data_len+5]=0;ptrans[j*data_len+6]=0;ptrans[j*data_len+7]=0}}}var use_grass_map=m_scenegraph.find_subs(graph,"GRASS_MAP")?
true:false;if(pset["render_type"]=="OBJECT"){var particles_batch_types=[get_batch_types(graph,pset["dupli_object"]._object.render,!render.do_not_render,true)];var hair_metabatches=make_hair_particles_metabatches(bpy_obj,render,emitter_vc,em_submesh,[pset["dupli_object"]],particles_batch_types,[ptrans],pset,psys,use_grass_map,seed,false);metabatches=metabatches.concat(hair_metabatches)}else if(pset["render_type"]=="GROUP"){var bpy_part_objs=pset["dupli_group"]["objects"];var particles_batch_types=
[];for(var j=0;j<bpy_part_objs.length;j++){var btypes=get_batch_types(graph,bpy_part_objs[j]._object.render,!render.do_not_render,true);particles_batch_types.push(btypes)}var reset_seed=false;var part_objs=[];for(var j=0;j<bpy_part_objs.length;j++)part_objs.push(bpy_part_objs[j]._object);if(pset["use_whole_group"]){var ptrans_dist=distribute_ptrans_group(ptrans,part_objs,use_particles_rotation,data_len);reset_seed=true}else if(pset["use_group_count"])var ptrans_dist=distribute_ptrans_by_dupli_weights(ptrans,
part_objs,pset["dupli_weights"],seed,use_particles_rotation,data_len);else var ptrans_dist=distribute_ptrans_equally(ptrans,part_objs,seed,use_particles_rotation,data_len);var hair_metabatches=make_hair_particles_metabatches(bpy_obj,render,emitter_vc,em_submesh,bpy_part_objs,particles_batch_types,ptrans_dist,pset,psys,use_grass_map,seed,reset_seed);metabatches=metabatches.concat(hair_metabatches)}if(pset["b4w_wind_bend_inheritance"]=="INSTANCE"&&obj.render.wind_bending)m_print.warn('Emitter object "'+
obj.name+'" has a particle'+" system with wind bending inheritance from the "+"particle instance. Wind bending on the emitter isn't "+"disabled. Expect unforeseen behavior.")}else throw"Unknown particle settings type";}return metabatches}function select_psys_material(psys,materials){var mat_index=psys["settings"]["material"]-1;if(mat_index>=materials.length){m_print.warn("Wrong material used for rendering particle "+'system "'+psys["name"]+'"');mat_index=0}return materials[mat_index]}function merge_metabatches(metabatches){var merged_metabatches=
[];var unique_data=[];var batches_ids={};for(var i=0;i<metabatches.length;i++){var batch=metabatches[i].batch;var render=metabatches[i].render;var batch_data=null;if(batch.id in batches_ids){var index=batches_ids[batch.id];var collision_batch=unique_data[index].batch;var collision_render=unique_data[index].render;var canvas_context=null;var video_elements=null;var bb_local=batch.bb_local;var be_local=batch.be_local;var bb_world=batch.bb_world;var be_world=batch.be_world;batch.bb_local=null;batch.be_local=
null;batch.bb_world=null;batch.be_world=null;var bb_local_col=collision_batch.bb_local;var be_local_col=collision_batch.be_local;var bb_world_col=collision_batch.bb_world;var be_world_col=collision_batch.be_world;collision_batch.bb_local=null;collision_batch.be_local=null;collision_batch.bb_world=null;collision_batch.be_world=null;for(var j=0;j<batch.textures.length;j++){var ctx=batch.textures[j].canvas_context;if(ctx){if(!canvas_context)canvas_context={};canvas_context[j]=ctx;batch.textures[j].canvas_context=
null}var video=batch.textures[j].video_file;if(video){if(!video_elements)video_elements={};video_elements[j]=video;batch.textures[j].video_file=null}}if(m_util.strict_objs_is_equal(batch,collision_batch,true)&&m_util.strict_objs_is_equal(render,collision_render,true))var batch_data=unique_data[index];batch.bb_local=bb_local;batch.be_local=be_local;batch.bb_world=bb_world;batch.be_world=be_world;collision_batch.bb_local=bb_local_col;collision_batch.be_local=be_local_col;collision_batch.bb_world=bb_world_col;
collision_batch.be_world=be_world_col;if(canvas_context)for(var j in canvas_context)batch.textures[j].canvas_context=canvas_context[j];if(video_elements)for(var j in video_elements)batch.textures[j].video_file=video_elements[j];if(!batch_data){do batch.id++;while(batches_ids[batch.id])}}if(!batch_data){var batch_data={batch:batch,render:metabatches[i].render,rel_bpy_objects:[],submeshes:[],mat_names:[]};batches_ids[batch.id]=unique_data.length;unique_data.push(batch_data)}batch_data.rel_bpy_objects=
batch_data.rel_bpy_objects.concat(metabatches[i].rel_bpy_objects);if(metabatches[i].submesh&&metabatches[i].submesh.base_length)batch_data.submeshes.push(metabatches[i].submesh);if(batch_data.mat_names.length)for(var j=0;j<metabatches[i].mat_names.length;j++){var mat_name=metabatches[i].mat_names[j];if(batch_data.mat_names.indexOf(mat_name)==-1)batch_data.mat_names.push(mat_name)}else batch_data.mat_names=metabatches[i].mat_names;m_geometry.sort_two_arrays(batch_data.mat_names,batch_data.submeshes,
m_geometry.SORT_STRING,false)}for(var i=0;i<unique_data.length;i++){var submeshes=unique_data[i].submeshes;if(submeshes.length==0)var submesh=m_util.create_empty_submesh(m_util.unique_name("%empty"));else if(submeshes.length==1)var submesh=submeshes[0];else{var short_submeshes=[];for(var j=0;j<submeshes.length;j++)if(!m_geometry.is_long_submesh(submeshes[j]))short_submeshes.push(j);if(short_submeshes.length<submeshes.length)for(var j=0;j<short_submeshes.length;j++)m_geometry.submesh_drop_indices(submeshes[short_submeshes[j]]);
var submesh=m_geometry.submesh_list_join(submeshes)}if(unique_data[i].batch.type!="PARTICLES"){var submesh_bd=submesh.submesh_bd;unique_data[i].batch.bb_local=m_util.clone_object_r(submesh_bd.bb_local);unique_data[i].batch.be_local=m_util.clone_object_r(submesh_bd.be_local);unique_data[i].batch.bb_world=m_util.clone_object_r(submesh_bd.bb_world);unique_data[i].batch.be_world=m_util.clone_object_r(submesh_bd.be_world)}var metabatch={batch:unique_data[i].batch,render:unique_data[i].render,submesh:submesh,
mat_names:unique_data[i].mat_names,rel_bpy_objects:unique_data[i].rel_bpy_objects};merged_metabatches.push(metabatch)}return merged_metabatches}exports.set_local_cylinder_capsule=set_local_cylinder_capsule;function set_local_cylinder_capsule(render,cyl_radius,cap_radius,bb_local){render.bcyl_local=m_bounds.create_bounding_cylinder(cyl_radius,bb_local);render.bcap_local=m_bounds.create_bounding_capsule(cap_radius,bb_local);render.bcon_local=m_bounds.create_bounding_cone(cyl_radius,bb_local)}exports.wb_angle_to_amp=
wb_angle_to_amp;function wb_angle_to_amp(angle,bbox,scale){if(bbox)var height=scale*(bbox.max_y-bbox.min_y);else{var height=1;throw"No bounding box for mesh";}if(height==0)return 0;var delta=height*Math.tan(m_util.deg_to_rad(angle));var amp=Math.sqrt(2*Math.sqrt(4*delta+1)+2)/2-1;return.5*amp/height}exports.bb_bpy_to_b4w=bb_bpy_to_b4w;function bb_bpy_to_b4w(bpy_bb){var max_x=bpy_bb["max_x"];var max_y=bpy_bb["max_y"];var max_z=bpy_bb["max_z"];var min_x=bpy_bb["min_x"];var min_y=bpy_bb["min_y"];var min_z=
bpy_bb["min_z"];var bb={max_x:max_x,min_x:min_x,max_y:max_y,min_y:min_y,max_z:max_z,min_z:min_z};return bb}function exclude_batch_types(batch_types,unwanted_types){for(var i=0;i<unwanted_types.length;i++){var index=batch_types.indexOf(unwanted_types[i]);if(index!==-1)batch_types.splice(index,1)}return batch_types}function get_batch_types(graph,render,is_rendered,is_hair_particles){var batch_types=[];if(!is_hair_particles)if(render.selectable&&m_scenegraph.find_subs(graph,"COLOR_PICKING")||render.outlining&&
m_scenegraph.find_subs(graph,"OUTLINE_MASK"))batch_types.push("COLOR_ID");if(is_rendered){batch_types.push("MAIN");batch_types.push("NODES_GLOW");if(m_scenegraph.find_subs(graph,"DEBUG_VIEW"))batch_types.push("DEBUG_VIEW");if(m_scenegraph.find_subs(graph,"SHADOW_RECEIVE"))batch_types.push("SHADOW");if(m_scenegraph.find_subs(graph,"GRASS_MAP"))batch_types.push("GRASS_MAP")}batch_types.push("PHYSICS");if(render.shadow_cast_only||render.reflexible_only){var unwanted_types=null;if(render.shadow_cast_only)unwanted_types=
["MAIN","NODES_GLOW","COLOR_ID","PHYSICS","DEBUG_VIEW"];if(render.reflexible_only){var types=["COLOR_ID","PHYSICS","SHADOW","DEBUG_VIEW"];if(unwanted_types!==null)unwanted_types=m_util.array_intersect(unwanted_types,types);else unwanted_types=types}batch_types=exclude_batch_types(batch_types,unwanted_types)}return batch_types}function update_batch_material(batch,material,update_tex_color){var ret;switch(batch.type){case "MAIN":ret=update_batch_material_main(batch,material,update_tex_color);break;
case "NODES_GLOW":ret=update_batch_material_nodes(batch,material,"GLOW");break;case "SHADOW":ret=update_batch_material_shadow_receive(batch,material);break;case "PHYSICS":ret=update_batch_material_physics(batch,material);break;case "COLOR_ID":ret=update_batch_material_color_id(batch,material);break;case "GRASS_MAP":ret=update_batch_material_grass_map(batch,material);break;case "DEBUG_VIEW":ret=update_batch_material_debug_view(batch,material);break;case "PARTICLES":ret=update_batch_material_particles(batch,
material);break;default:throw"Wrong batch type: "+batch.type;}return ret}function update_batch_material_main(batch,material,update_tex_color){if(material["b4w_do_not_render"])return false;if(material["use_nodes"]&&material["type"]!="HALO"){update_batch_material_nodes(batch,material,"MAIN");return true}update_batch_game_settings(batch,material);var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";
batch.offset_z=material["offset_z"];batch.texture_scale.set([1,1,1]);var texture_slots=material["texture_slots"];m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color);switch(material["name"]){case "LENS_FLARES":apply_shader(batch,"special_lens_flares.glslv","special_lens_flares.glslf");set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_texcoord");var tex_col=update_tex_color?[1,1,1,0]:null;var tex=m_textures.get_batch_texture(texture_slots[0],
tex_col);append_texture(batch,tex);break;default:apply_shader(batch,"main.glslv","main_stack.glslf");if(!material["use_shadeless"]){var data={use_shadeless:material["use_shadeless"],diffuse_shader:material["diffuse_shader"],specular_shader:material["specular_shader"]};var nmat_graph=m_nodemat.create_lighting_graph(material["uuid"],material["name"],data);batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph)}var colormaps=find_valid_textures("use_map_color_diffuse",true,texture_slots);
var specmaps=find_valid_textures("use_map_color_spec",true,texture_slots);var normalmaps=find_valid_textures("use_map_normal",true,texture_slots);var mirrormaps=find_valid_textures("use_map_mirror",true,texture_slots);var stencilmaps=find_valid_textures("use_stencil",true,texture_slots);var colormap0=colormaps[0];var specmap0=specmaps[0];var normalmap0=normalmaps[0];var mirrormap0=mirrormaps[0];var colormap1=colormaps[1];var stencil0=stencilmaps[0]&&find_valid_textures("use_rgb_to_intensity",true,
texture_slots)[0];if(colormap0){switch(colormap0["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}if(colormap0["texture"]._render.source=="IMAGE"&&update_tex_color)var tex_col=[batch.diffuse_color[0],batch.diffuse_color[1],batch.diffuse_color[2],1];else if(colormap0["texture"]._render.source=="ENVIRONMENT_MAP"&&update_tex_color)var tex_col=[.8,
.8,.8,1];else var tex_col=null;var tex=m_textures.get_batch_texture(colormap0,tex_col);append_texture(batch,tex,"u_colormap0");batch.diffuse_color_factor=colormap0["diffuse_color_factor"];if(colormap0["use_map_alpha"])batch.alpha_factor=colormap0["alpha_factor"];else batch.alpha_factor=0;batch.texture_scale.set(colormap0["scale"])}var alpha_as_spec=colormap0&&colormap0==specmap0;if(specmap0){if(!alpha_as_spec){var tex_col=update_tex_color?[.5,.5,.5,1]:null;var tex=m_textures.get_batch_texture(specmap0,
tex_col);append_texture(batch,tex,"u_specmap0")}batch.specular_color_factor=specmap0["specular_color_factor"]}if(normalmap0){set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_tangent");batch.part_use_tangent=true;var tex_col=update_tex_color?[.5,.5,1,1]:null;var tex=m_textures.get_batch_texture(normalmap0,tex_col);append_texture(batch,tex,"u_normalmap0");batch.normal_factor=normalmap0["normal_factor"];var nm0tex=normalmap0["texture"];if(nm0tex["b4w_use_map_parallax"]&&cfg_def.parallax){var steps=
m_shaders.glsl_value(nm0tex["b4w_parallax_steps"]);var lod_dist=m_shaders.glsl_value(nm0tex["b4w_parallax_lod_dist"]);set_batch_directive(batch,"PARALLAX",1);set_batch_directive(batch,"PARALLAX_STEPS",steps);set_batch_directive(batch,"PARALLAX_LOD_DIST",lod_dist);batch.parallax_scale=nm0tex["b4w_parallax_scale"]}}if(mirrormap0){var tex_col=update_tex_color?[0,0,.5,1]:null;var tex=m_textures.get_batch_texture(mirrormap0,tex_col);append_texture(batch,tex,"u_mirrormap");batch.mirror_factor=mirrormap0["mirror_factor"]}var TEXTURE_STENCIL_ALPHA_MASK=
colormap0&&colormap1&&stencil0?1:0;if(TEXTURE_STENCIL_ALPHA_MASK){var tex_col=update_tex_color?[.8,.8,.8,1]:null;var tex=m_textures.get_batch_texture(colormap1,tex_col);append_texture(batch,tex,"u_colormap1");var tex_col=update_tex_color?[.5,.5,.5,1]:null;var tex=m_textures.get_batch_texture(stencil0,tex_col);append_texture(batch,tex,"u_stencil0")}var some_tex=colormap0||specmap0||normalmap0;if(some_tex)batch.texture_scale.set(some_tex["scale"]);set_batch_directive(batch,"TEXTURE_SPEC",specmap0==
undefined?0:1);set_batch_directive(batch,"ALPHA_AS_SPEC",alpha_as_spec?1:0);set_batch_directive(batch,"TEXTURE_STENCIL_ALPHA_MASK",TEXTURE_STENCIL_ALPHA_MASK);set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");if(colormap0||specmap0||normalmap0)set_batch_c_attr(batch,"a_texcoord");if(material["b4w_water"])init_water_material(material,batch);if(material["type"]==="HALO"){apply_shader(batch,"halo.glslv","halo.glslf");set_batch_halo_data(batch,material);batch.common_attributes=["a_position"]}set_batch_directive(batch,
"TEXCOORD",0);set_batch_directive(batch,"NORMAL_TEXCOORD",0);if(colormap0)set_batch_texcoord_directive(batch,colormap0,"TEXTURE_COLOR0_CO");if(colormap1)set_batch_texcoord_directive(batch,colormap1,"TEXTURE_COLOR1_CO");if(stencil0)set_batch_texcoord_directive(batch,stencil0,"TEXTURE_STENCIL_ALPHA_MASK_CO");if(specmap0)set_batch_texcoord_directive(batch,specmap0,"TEXTURE_SPEC_CO");if(normalmap0)set_batch_texcoord_directive(batch,normalmap0,"TEXTURE_NORM_CO");set_batch_directive(batch,"SHADELESS",material["use_shadeless"]?
1:0);batch.use_shadeless=material["use_shadeless"]}var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"DOUBLE_SIDED_LIGHTING",material["b4w_double_sided_lighting"]?1:0);if(material["use_vertex_color_paint"]){set_batch_directive(batch,"VERTEX_COLOR",1);set_batch_c_attr(batch,"a_color")}else set_batch_directive(batch,"VERTEX_COLOR",0);batch.ambient=
material["ambient"];batch.diffuse_intensity=material["diffuse_intensity"];batch.emit=material["emit"];batch.specular_color.set(material["specular_color"]);batch.specular_alpha=material["specular_alpha"];update_batch_specular_params(batch,material);update_batch_diffuse_params(batch,material);if(material["b4w_wettable"])set_batch_directive(batch,"WETTABLE",1);else set_batch_directive(batch,"WETTABLE",0);update_batch_fresnel_params(batch,material);if(material["b4w_refractive"]&&!batch.blend){m_print.warn('Material "'+
material["name"]+'" is not blend. '+"Disabling refractions.");batch.refractive=false}else batch.refractive=material["b4w_refractive"];batch.refr_bump=material["b4w_refr_bump"];return true}function set_batch_halo_data(batch,material){var mat_halo=material["halo"];set_batch_directive(batch,"NUM_RINGS",mat_halo["ring_count"]);set_batch_directive(batch,"NUM_LINES",mat_halo["line_count"]);set_batch_directive(batch,"NUM_STARS",mat_halo["star_tip_count"]);set_batch_directive(batch,"SKY_STARS",material["b4w_halo_sky_stars"]?
1:0);batch.halo_size=mat_halo["size"];batch.halo_hardness=mat_halo["hardness"]/20;batch.halo_rings_color.set(mat_halo["b4w_halo_rings_color"]);batch.halo_lines_color.set(mat_halo["b4w_halo_lines_color"]);batch.halo_stars_blend=1/material["b4w_halo_stars_blend_height"];batch.halo_stars_height=material["b4w_halo_stars_min_height"];batch.halo=true}function set_batch_texcoord_directive(batch,texture,directive_name){switch(texture["texture_coords"]){case "UV":case "ORCO":set_batch_directive(batch,directive_name,
"TEXTURE_COORDS_UV_ORCO");set_batch_directive(batch,"TEXCOORD",1);break;case "NORMAL":set_batch_directive(batch,directive_name,"TEXTURE_COORDS_NORMAL");set_batch_directive(batch,"NORMAL_TEXCOORD",1);break;default:set_batch_directive(batch,directive_name,0)}}function update_batch_game_settings(batch,material){var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];switch(alpha_blend){case "ALPHA_SORT":batch.blend=true;batch.z_sort=true;batch.depth_mask=true;batch.alpha_clip=false;break;
case "ALPHA":batch.blend=true;batch.z_sort=false;batch.depth_mask=true;batch.alpha_clip=false;break;case "CLIP":batch.blend=false;batch.z_sort=false;batch.depth_mask=true;batch.alpha_clip=true;break;case "ADD":batch.blend=true;batch.z_sort=false;batch.depth_mask=false;batch.alpha_clip=false;break;case "OPAQUE":batch.blend=false;batch.z_sort=false;batch.depth_mask=true;batch.alpha_clip=false;break;default:throw new Error("Unknown alpha blend mode: "+alpha_blend);}batch.use_backface_culling=gs["use_backface_culling"]}
function find_valid_textures(key,value,slots){var results=[];var len=slots.length;for(var i=0;i<len;i++){var slot=slots[i];if(slot[key]==value&&slot["texture"]&&slot["texture"]._render)results.push(slot)}return results}function init_water_material(material,batch){batch.water=true;batch.water_dynamic=material["b4w_water_dynamic"];if(material["b4w_water_shore_smoothing"]&&!batch.blend){m_print.warn('Material: "'+material["name"]+'" is opaque.',"Disabling shore smoothing.");batch.water_shore_smoothing=
false}else batch.water_shore_smoothing=material["b4w_water_shore_smoothing"];apply_shader(batch,"special_water.glslv","special_water.glslf");var data={use_shadeless:false,diffuse_shader:material["diffuse_shader"],specular_shader:material["specular_shader"]};var nmat_graph=m_nodemat.create_lighting_graph(material["uuid"],material["name"],data);batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph);set_batch_c_attr(batch,"a_position");if(cfg_def.water_wireframe_debug){set_batch_c_attr(batch,
"a_polyindex");batch.depth_mask=true;batch.wireframe_edge_color=[0,0,0];if(m_extensions.get_standard_derivatives())set_batch_directive(batch,"DEBUG_WIREFRAME",1);else set_batch_directive(batch,"DEBUG_WIREFRAME",2)}else set_batch_directive(batch,"DEBUG_WIREFRAME",0);var texture_slots=material["texture_slots"];var normalmaps=find_valid_textures("use_map_normal",true,texture_slots);var mirrormap0=find_valid_textures("use_map_mirror",true,texture_slots)[0];if(normalmaps.length){var tex_nm=m_textures.get_batch_texture(normalmaps[0]);
append_texture(batch,tex_nm,"u_normalmap0");batch.water_norm_uv_velocity=material["b4w_water_norm_uv_velocity"]}set_batch_directive(batch,"NUM_NORMALMAPS",normalmaps.length);batch.normalmap_scales=new Array(normalmaps.length);for(var i=0;i<normalmaps.length;i++){batch.normalmap_scales[i]=new Float32Array(2);batch.normalmap_scales[i].set([normalmaps[i]["scale"][0],normalmaps[i]["scale"][1]])}if(mirrormap0){var tex_mm=m_textures.get_batch_texture(mirrormap0);append_texture(batch,tex_mm,"u_mirrormap");
batch.mirror_factor=mirrormap0["mirror_factor"]}var foam=null;if(cfg_def.foam)for(var i=0;i<texture_slots.length;i++){var texture=texture_slots[i];if(texture["texture"]["b4w_water_foam"]===true){foam=texture;break}}if(foam){set_batch_directive(batch,"FOAM",1);var tex_foam=m_textures.get_batch_texture(foam);append_texture(batch,tex_foam,"u_foam");batch.foam_factor=material["b4w_foam_factor"];batch.foam_uv_freq.set(foam["texture"]["b4w_foam_uv_freq"]);batch.foam_mag.set(foam["texture"]["b4w_foam_uv_magnitude"]);
batch.foam_scale[0]=foam["scale"][0];batch.foam_scale[1]=foam["scale"][1]}else set_batch_directive(batch,"FOAM",0);for(var i=0;i<texture_slots.length;i++){var texture=texture_slots[i];if(texture["texture"]["b4w_shore_dist_map"]===true){var shore_dist_map=texture;break}}if(shore_dist_map&&cfg_def.allow_vertex_textures){var tex_shr0=m_textures.get_batch_texture(shore_dist_map);append_texture(batch,tex_shr0,"u_shore_dist_map");set_batch_directive(batch,"SHORE_PARAMS",1);var sh_bounds=texture["texture"]["b4w_shore_boundings"];
set_batch_directive(batch,"MAX_SHORE_DIST",m_shaders.glsl_value(texture["texture"]["b4w_max_shore_dist"]));set_batch_directive(batch,"SHORE_MAP_SIZE_X",m_shaders.glsl_value(sh_bounds[0]-sh_bounds[1]));set_batch_directive(batch,"SHORE_MAP_SIZE_Y",m_shaders.glsl_value(sh_bounds[2]-sh_bounds[3]));set_batch_directive(batch,"SHORE_MAP_CENTER_X",m_shaders.glsl_value((sh_bounds[0]+sh_bounds[1])/2));set_batch_directive(batch,"SHORE_MAP_CENTER_Y",m_shaders.glsl_value((sh_bounds[2]+sh_bounds[3])/2))}else set_batch_directive(batch,
"SHORE_PARAMS",0);if(material["b4w_generated_mesh"]){set_batch_directive(batch,"GENERATED_MESH",1);batch.water_generated_mesh=true;batch.water_num_cascads=material["b4w_water_num_cascads"];batch.water_subdivs=material["b4w_water_subdivs"];batch.water_detailed_dist=material["b4w_water_detailed_dist"]}else{set_batch_c_attr(batch,"a_normal");if(foam||normalmaps.length){set_batch_c_attr(batch,"a_texcoord");set_batch_c_attr(batch,"a_tangent");batch.part_use_tangent=true}set_batch_directive(batch,"GENERATED_MESH",
0)}if(material["b4w_water_dynamic"]){var dst_noise_scale0=m_shaders.glsl_value(material["b4w_water_dst_noise_scale0"]);var dst_noise_scale1=m_shaders.glsl_value(material["b4w_water_dst_noise_scale1"]);var dst_noise_freq0=m_shaders.glsl_value(material["b4w_water_dst_noise_freq0"]);var dst_noise_freq1=m_shaders.glsl_value(material["b4w_water_dst_noise_freq1"]);var dir_min_shore_fac=m_shaders.glsl_value(material["b4w_water_dir_min_shore_fac"]);var dir_freq=m_shaders.glsl_value(material["b4w_water_dir_freq"]);
var dir_noise_scale=m_shaders.glsl_value(material["b4w_water_dir_noise_scale"]);var dir_noise_freq=m_shaders.glsl_value(material["b4w_water_dir_noise_freq"]);var dir_min_noise_fac=m_shaders.glsl_value(material["b4w_water_dir_min_noise_fac"]);var dst_min_fac=m_shaders.glsl_value(material["b4w_water_dst_min_fac"]);var waves_hor_fac=m_shaders.glsl_value(material["b4w_water_waves_hor_fac"]);set_batch_directive(batch,"DST_NOISE_SCALE_0",dst_noise_scale0);set_batch_directive(batch,"DST_NOISE_SCALE_1",dst_noise_scale1);
set_batch_directive(batch,"DST_NOISE_FREQ_0",dst_noise_freq0);set_batch_directive(batch,"DST_NOISE_FREQ_1",dst_noise_freq1);set_batch_directive(batch,"DIR_MIN_SHR_FAC",dir_min_shore_fac);set_batch_directive(batch,"DIR_FREQ",dir_freq);set_batch_directive(batch,"DIR_NOISE_SCALE",dir_noise_scale);set_batch_directive(batch,"DIR_NOISE_FREQ",dir_noise_freq);set_batch_directive(batch,"DIR_MIN_NOISE_FAC",dir_min_noise_fac);set_batch_directive(batch,"DST_MIN_FAC",dst_min_fac);set_batch_directive(batch,"WAVES_HOR_FAC",
waves_hor_fac)}update_batch_specular_params(batch,material);update_batch_diffuse_params(batch,material);batch.shallow_water_col.set(material["b4w_shallow_water_col"]);batch.shore_water_col.set(material["b4w_shore_water_col"]);batch.shallow_water_col_fac=material["b4w_shallow_water_col_fac"];batch.shore_water_col_fac=material["b4w_shore_water_col_fac"];set_batch_directive(batch,"ABSORB",m_shaders.glsl_value(material["b4w_water_absorb_factor"]));set_batch_directive(batch,"SSS_STRENGTH",m_shaders.glsl_value(material["b4w_water_sss_strength"]));
set_batch_directive(batch,"SSS_WIDTH",m_shaders.glsl_value(material["b4w_water_sss_width"]))}function update_batch_fresnel_params(batch,material){var rt=material["raytrace_transparency"];batch.fresnel_params[0]=rt["fresnel"];batch.fresnel_params[1]=1-rt["fresnel_factor"]/5;var rm=material["raytrace_mirror"];batch.reflect_factor=rm["reflect_factor"];batch.fresnel_params[2]=rm["fresnel"];batch.fresnel_params[3]=1-rm["fresnel_factor"]/5}function update_batch_specular_params(batch,material){var spec_param_0;
var spec_param_1=0;switch(material["specular_shader"]){case "PHONG":case "COOKTORR":spec_param_0=material["specular_hardness"];break;case "WARDISO":spec_param_0=material["specular_slope"];break;case "TOON":spec_param_0=material["specular_toon_size"];spec_param_1=material["specular_toon_smooth"];break;case "BLINN":spec_param_0=material["specular_ior"];spec_param_1=material["specular_hardness"];break;default:m_print.error("unsupported specular shader: "+material["specular_shader"]+' (material "'+material["name"]+
'")');spec_param_0=material["specular_hardness"];break}batch.specular_params[0]=material["specular_intensity"];batch.specular_params[1]=spec_param_0;batch.specular_params[2]=spec_param_1}function update_batch_diffuse_params(batch,material){switch(material["diffuse_shader"]){case "LAMBERT":batch.diffuse_params[0]=0;batch.diffuse_params[1]=0;break;case "OREN_NAYAR":batch.diffuse_params[0]=material["roughness"];batch.diffuse_params[1]=0;break;case "FRESNEL":batch.diffuse_params[0]=material["diffuse_fresnel"];
batch.diffuse_params[1]=material["diffuse_fresnel_factor"];break;case "MINNAERT":batch.diffuse_params[0]=material["darkness"];batch.diffuse_params[1]=0;break;case "TOON":batch.diffuse_params[0]=material["diffuse_toon_size"];batch.diffuse_params[1]=material["diffuse_toon_smooth"];break;default:m_print.error("unsupported diffuse shader: "+material["diffuse_shader"]+' (material "'+material["name"]+'")');batch.diffuse_params[0]=0;batch.diffuse_params[1]=0;break}}function update_batch_material_nodes(batch,
material,shader_type){if(!material["use_nodes"]||material["b4w_do_not_render"])return false;var is_glow_output;switch(shader_type){case "MAIN":apply_shader(batch,"main.glslv","main.glslf");is_glow_output=false;break;case "GLOW":apply_shader(batch,"main.glslv","main.glslf");is_glow_output=true;break;case "SHADOW":apply_shader(batch,"shadow.glslv","shadow.glslf");is_glow_output=false;break;case "COLOR_ID":apply_shader(batch,"color_id.glslv","color_id.glslf");is_glow_output=false;break}var node_tree=
material["node_tree"];var uuid=material["uuid"];var nmat_graph=m_nodemat.compose_nmat_graph(node_tree,uuid,false,material["name"],shader_type);if(!nmat_graph){m_print.error('Failed to create node graph for material "'+material["name"]+'", disable nodes');update_batch_material_error(batch,material);return true}batch.has_nodes=true;set_batch_directive(batch,"NODES",1);set_batch_directive(batch,"DOUBLE_SIDED_LIGHTING",material["b4w_double_sided_lighting"]?1:0);set_batch_c_attr(batch,"a_position");if(material["use_orco_tex_coord"])set_batch_c_attr(batch,
"a_orco_tex_coord");update_batch_game_settings(batch,material);batch.offset_z=material["offset_z"];var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];if(is_glow_output){set_batch_directive(batch,"ALPHA",1);set_batch_directive(batch,"ALPHA_CLIP",0)}else{set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0)}batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";m_vec4.set(material["diffuse_color"][0],
material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color);batch.emit=material["emit"];batch.ambient=material["ambient"];update_batch_fresnel_params(batch,material);if(material["b4w_wettable"])set_batch_directive(batch,"WETTABLE",1);else set_batch_directive(batch,"WETTABLE",0);var node_texture=null;var has_material_nodes=false;m_graph.traverse(nmat_graph,function(node,attr){switch(attr.type){case "UVMAP":case "TEX_COORD_UV":case "GEOMETRY_UV":case "UV_MERGED":var name=
attr.data.name;var uv_layer=attr.data.value;if(!batch.uv_maps_usage)batch.uv_maps_usage={};batch.uv_maps_usage[uv_layer]=name;break;case "GEOMETRY_VC":case "GEOMETRY_VC1":case "GEOMETRY_VC2":case "GEOMETRY_VC3":var name=attr.data.name;var vc_layer=attr.data.value;batch.vertex_colors_usage[name]={generate_buffer:true,src:[{name:vc_layer}]};var mask=0;if(attr.type=="GEOMETRY_VC")mask=7;else for(var i=0;i<attr.outputs.length;i++){var index="RGB".indexOf(attr.outputs[i].identifier);if(index>-1)mask|=
1<<2-index}batch.vertex_colors_usage[name].src[0].mask=mask;break;case "TEX_COORD_NO":case "GEOMETRY_NO":set_batch_c_attr(batch,"a_normal");break;case "MATERIAL_BEGIN":var mat_data=attr.data.value;set_batch_c_attr(batch,"a_normal");has_material_nodes=true;break;case "TEXTURE_COLOR":case "TEXTURE_ENVIRONMENT":var name=attr.data.name;var tex=attr.data.value;if(!tex._render){m_print.warn('Wrong texture "'+attr.data.value["name"]+'" in material "'+material["name"]+'".');update_batch_material_error(batch,
material);return}if(tex._render.allow_node_dds!==false)if(attr.type!="TEXTURE_ENVIRONMENT")tex._render.allow_node_dds=true;else tex._render.allow_node_dds=false;append_texture(batch,tex._render,name);break;case "TEXTURE_NORMAL":case "B4W_PARALLAX":set_batch_directive(batch,"CALC_TBN_SPACE",1);set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_tangent");batch.part_use_tangent=true;var name=attr.data.name;var tex=attr.data.value;tex._render.allow_node_dds=false;append_texture(batch,tex._render,
name);break;case "LAMP":if(attr.data)batch.lamp_uuid_indexes=attr.data;break;case "B4W_REFRACTION":if(batch.blend)batch.refractive=true;else{batch.refractive=true;m_print.warn('Material "'+material["name"]+'" is not blend. '+"Disabling refractions.")}break;case "VALTORGB":case "CURVE_VEC":case "CURVE_RGB":if(!node_texture)node_texture=attr.data.texture;break;case "PARTICLE_INFO":if(batch.type=="PARTICLES"&&attr.data)batch.part_node_data=attr.data;break;case "VECT_TRANSFORM":var conv_type=Number(attr.dirs[1][1]);
switch(conv_type){case m_nodemat.VT_WORLD_TO_OBJECT:set_batch_directive(batch,"USE_ZUP_MODEL_MATRIX_INVERSE",1);break;case m_nodemat.VT_WORLD_TO_CAMERA:set_batch_directive(batch,"USE_ZUP_VIEW_MATRIX",1);break;case m_nodemat.VT_OBJECT_TO_WORLD:set_batch_directive(batch,"USE_ZUP_MODEL_MATRIX",1);break;case m_nodemat.VT_OBJECT_TO_CAMERA:set_batch_directive(batch,"USE_ZUP_MODEL_MATRIX",1);set_batch_directive(batch,"USE_ZUP_VIEW_MATRIX",1);break;case m_nodemat.VT_CAMERA_TO_WORLD:set_batch_directive(batch,
"USE_ZUP_VIEW_MATRIX_INVERSE",1);break;case m_nodemat.VT_CAMERA_TO_OBJECT:set_batch_directive(batch,"USE_ZUP_MODEL_MATRIX_INVERSE",1);set_batch_directive(batch,"USE_ZUP_VIEW_MATRIX_INVERSE",1);break}break}});if(node_texture)append_texture(batch,node_texture,"u_nodes_texture");if(!has_material_nodes)batch.use_shadeless=true;var node_elems=batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph);prepare_nodemats_containers(node_tree,batch,material["name"]);var node_value_inds=batch.node_value_inds;
var node_rgb_inds=batch.node_rgb_inds;for(var i=0;i<node_elems.length;i++){var node=node_elems[i];switch(node.id){case "VALUE":var ind=node.param_values[0];if(ind)for(var j=0;j<node_value_inds.length;j+=2)if(node_value_inds[j]==ind){node.dirs.push(["VALUE_IND",node_value_inds[j+1]]);break}break;case "RGB":var ind=node.param_values[0];if(ind)for(var j=0;j<node_rgb_inds.length;j+=2)if(node_rgb_inds[j]==ind){node.dirs.push(["RGB_IND",node_rgb_inds[j+1]]);break}break;default:}}set_batch_directive(batch,
"NUM_VALUES",batch.node_values.length);set_batch_directive(batch,"NUM_RGBS",batch.node_rgbs.length);return true}function prepare_nodemats_containers(node_tree,batch,mat_name){var node_values=[];var node_value_inds=[];var node_anim_inds=[];var node_rgbs=[];var node_rgb_inds=[];var node_rgb_anim_inds=[];var anim_data=node_tree["animation_data"];gather_node_values_r(node_tree,mat_name,anim_data,node_values,node_value_inds,node_anim_inds,node_rgbs,node_rgb_inds,node_rgb_anim_inds);batch.node_values=node_values;
batch.node_value_inds=node_value_inds;batch.node_anim_inds=node_anim_inds;batch.node_rgbs=node_rgbs;batch.node_rgb_inds=node_rgb_inds;batch.node_rgb_anim_inds=node_rgb_anim_inds}function gather_node_values_r(node_tree,names_str,anim_data,node_values,value_inds,val_anim_inds,node_rgbs,rgb_inds,rgb_anim_inds){for(var i=0;i<node_tree["nodes"].length;i++){var node=node_tree["nodes"][i];if(node["type"]=="VALUE"){var param_name=join_name(names_str,node["name"]);node_values.push(node["outputs"][0]["default_value"]);
value_inds.push(param_name,value_inds.length/2)}else if(node["type"]=="RGB"){var param_name=join_name(names_str,node["name"]);var def_value=node["outputs"][0]["default_value"].slice(0,3);node_rgbs.push(def_value[0],def_value[1],def_value[2]);rgb_inds.push(param_name,rgb_inds.length/2)}else if(node["type"]=="GROUP"){var gr_node_tree=node["node_group"]["node_tree"];var ntree_anim_data=gr_node_tree["animation_data"];var new_names_str=join_name(names_str,node["name"]);gather_node_values_r(gr_node_tree,
new_names_str,ntree_anim_data,node_values,value_inds,val_anim_inds,node_rgbs,rgb_inds,rgb_anim_inds)}}if(anim_data)process_ntree_anim_data(anim_data,names_str,val_anim_inds,value_inds,rgb_inds,rgb_anim_inds)}function process_ntree_anim_data(anim_data,names_str,val_anim_inds,value_inds,rgb_inds,rgb_anim_inds){var action=anim_data["action"];if(action&&action._render.type==m_anim.AT_MATERIAL)extract_nodemat_action_params(action,names_str,val_anim_inds,value_inds,rgb_anim_inds,rgb_inds);var nla_tracks=
anim_data["nla_tracks"];for(var j=0;j<nla_tracks.length;j++){var nla_strips=nla_tracks[j]["strips"];for(var k=0;k<nla_tracks[j]["strips"].length;k++){var strip=nla_strips[k];var action=strip["action"];if(action&&action._render.type==m_anim.AT_MATERIAL)extract_nodemat_action_params(action,names_str,val_anim_inds,value_inds,rgb_anim_inds,rgb_inds)}}}function extract_nodemat_action_params(action,names_str,val_anim_inds,value_inds,rgb_anim_inds,rgb_inds){var params=action._render.params;for(var param in params){var full_node_path=
join_name(names_str,node_name_from_param_name(param));var ind=node_ind_by_full_path(value_inds,full_node_path);if(ind!=null){var param_name=join_name(action["name"],param);val_anim_inds.push(param_name,ind)}else{var ind=node_ind_by_full_path(rgb_inds,full_node_path);if(ind!=null){var param_name=join_name(action["name"],param);rgb_anim_inds.push(param_name,ind)}}}}function join_name(name1,name2){return name1+"%join%"+name2}function node_name_from_param_name(param_name){return param_name.match(/"(.*?)"/)[1]}
function node_ind_by_full_path(inds,path){for(var i=0;i<inds.length;i+=2){var name=inds[i];if(name==path)return inds[i+1]}return null}exports.append_texture_to_batch=function(batch,image_data,tex_name,size){var tex=m_textures.generate_batch_texure(image_data,size);append_texture(batch,tex,tex_name)};exports.update_batch_material_error=update_batch_material_error;function update_batch_material_error(batch,material){switch(batch.type){case "SHADOW":apply_shader(batch,"shadow.glslv","shadow.glslf");
break;case "COLOR_ID":apply_shader(batch,"color_id.glslv","color_id.glslf");break;default:apply_shader(batch,"main.glslv","main_stack.glslf");break}set_batch_directive(batch,"SHADELESS",1);set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");m_vec4.set(1,0,1,1,batch.diffuse_color);if(material){var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,
"VERTEX_COLOR",0);batch.offset_z=material["offset_z"];update_batch_game_settings(batch,material)}return true}function update_batch_material_shadow_receive(batch,material){if(material["name"]==="LENS_FLARES"||material["b4w_water"]||material["b4w_do_not_render"]||material["type"]==="HALO")return false;update_batch_game_settings(batch,material);if(batch.blend)return false;var alpha_blend=material["game_settings"]["alpha_blend"];if(material["use_nodes"]&&alpha_blend=="CLIP")update_batch_material_nodes(batch,
material,"SHADOW");else{apply_shader(batch,"shadow.glslv","shadow.glslf");m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color)}set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");var alpha=alpha_blend==="OPAQUE"?0:1;set_batch_directive(batch,"ALPHA",alpha);batch.texture_scale.set([1,1,1]);var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,
texture_slots)[0];var alpha_clip=alpha_blend==="CLIP"?1:0;if(colormap0&&alpha_clip){switch(colormap0["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}batch.texture_scale.set(colormap0["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",1);set_batch_c_attr(batch,"a_texcoord");if(colormap0["texture"]._render.source=="IMAGE"||colormap0["texture"]._render.source==
"ENVIRONMENT_MAP"||colormap0["texture"]._render.source=="CANVAS"){var tex=m_textures.get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}if(colormap0["texture"]._render.source=="NONE"){var tex=m_textures.get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}}else set_batch_directive(batch,"TEXTURE_COLOR",0);return true}function update_batch_material_physics(batch,material){if(material["b4w_collision"]){batch.use_ghost=material["b4w_use_ghost"];batch.collision_id=material["b4w_collision_id"];
batch.collision_margin=material["b4w_collision_margin"];batch.collision_group=material["b4w_collision_group"];batch.collision_mask=material["b4w_collision_mask"];batch.friction=material["physics"]["friction"];batch.elasticity=material["physics"]["elasticity"];return true}else if(material["b4w_water"]){batch.water=true;batch.water_dynamics=material["b4w_water_dynamic"];batch.dst_noise_scale0=material["b4w_water_dst_noise_scale0"];batch.dst_noise_scale1=material["b4w_water_dst_noise_scale1"];batch.dst_noise_freq0=
material["b4w_water_dst_noise_freq0"];batch.dst_noise_freq1=material["b4w_water_dst_noise_freq1"];batch.dir_min_shore_fac=material["b4w_water_dir_min_shore_fac"];batch.dir_freq=material["b4w_water_dir_freq"];batch.dir_noise_scale=material["b4w_water_dir_noise_scale"];batch.dir_noise_freq=material["b4w_water_dir_noise_freq"];batch.dir_min_noise_fac=material["b4w_water_dir_min_noise_fac"];batch.dst_min_fac=material["b4w_water_dst_min_fac"];batch.waves_hor_fac=material["b4w_water_waves_hor_fac"];return true}else return false}
function update_batch_material_color_id(batch,material){if(material["name"]==="LENS_FLARES"||material["type"]==="HALO")return false;update_batch_game_settings(batch,material);batch.z_sort=false;batch.depth_mask=true;batch.blend=false;var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";if(material["use_nodes"]&&alpha_blend=="CLIP")update_batch_material_nodes(batch,material,"COLOR_ID");else{apply_shader(batch,
"color_id.glslv","color_id.glslf");m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color)}set_batch_c_attr(batch,"a_position");var alpha=alpha_blend==="OPAQUE"?0:1;set_batch_directive(batch,"ALPHA",alpha);batch.texture_scale.set([1,1,1]);var texture_slots=material["texture_slots"];var colormap0=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];var alpha_clip=alpha_blend==="CLIP"?1:0;if(colormap0&&alpha_clip){switch(colormap0["blend_type"]){case "MIX":set_batch_directive(batch,
"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}batch.texture_scale.set(colormap0["scale"]);set_batch_directive(batch,"TEXTURE_COLOR",1);set_batch_c_attr(batch,"a_texcoord");if(colormap0["texture"]._render.source=="IMAGE"||colormap0["texture"]._render.source=="ENVIRONMENT_MAP"){var tex=m_textures.get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}if(colormap0["texture"]._render.source==
"NONE"){var tex=m_textures.get_batch_texture(colormap0);append_texture(batch,tex,"u_colormap0")}}else set_batch_directive(batch,"TEXTURE_COLOR",0);return true}function update_batch_material_debug_view(batch,material){if(material["name"]==="LENS_FLARES"||material["b4w_water"]||material["b4w_do_not_render"]||material["type"]==="HALO")return false;apply_shader(batch,"debug_view.glslv","debug_view.glslf");set_batch_c_attr(batch,"a_position");set_batch_c_attr(batch,"a_normal");set_batch_c_attr(batch,"a_polyindex");
batch.depth_mask=true;batch.debug_view_mode=0;batch.wireframe_edge_color=[0,0,0];return true}function update_batch_material_grass_map(batch,material){if(!material["b4w_terrain"]||material["b4w_do_not_render"])return false;update_batch_game_settings(batch,material);batch.blend=false;batch.z_sort=false;batch.depth_mask=true;apply_shader(batch,"grass_map.glslv","grass_map.glslf");set_batch_c_attr(batch,"a_position");if(material["b4w_dynamic_grass_size"])var vc_usage_gr_size=material["b4w_dynamic_grass_size"];
else var vc_usage_gr_size=null;if(material["b4w_dynamic_grass_color"])var vc_usage_gr_color=material["b4w_dynamic_grass_color"];else var vc_usage_gr_color=null;batch.vertex_colors_usage["a_grass_size"]={generate_buffer:true,src:[]};if(vc_usage_gr_size){batch.vertex_colors_usage["a_grass_size"].src.push({name:vc_usage_gr_size,mask:4});set_batch_directive(batch,"DYNAMIC_GRASS_SIZE",1)}else set_batch_directive(batch,"DYNAMIC_GRASS_SIZE",0);batch.vertex_colors_usage["a_grass_color"]={generate_buffer:true,
src:[]};if(vc_usage_gr_color){batch.vertex_colors_usage["a_grass_color"].src.push({name:vc_usage_gr_color,mask:7});set_batch_directive(batch,"DYNAMIC_GRASS_COLOR",1)}else set_batch_directive(batch,"DYNAMIC_GRASS_COLOR",0);return true}function update_batch_material_particles(batch,material){if(material["b4w_do_not_render"])return false;var texture_slots=material["texture_slots"];if(batch.halo_particles){apply_shader(batch,"particle_system.glslv","particle_system_stack.glslf");set_batch_directive(batch,
"HALO_PARTICLES",1);set_batch_halo_data(batch,material)}else{var data={use_shadeless:false,diffuse_shader:material["diffuse_shader"],specular_shader:material["specular_shader"]};if(material["use_nodes"]){apply_shader(batch,"particle_system.glslv","particle_system.glslf");update_batch_material_nodes(batch,material,"PARTICLES");return true}else{apply_shader(batch,"particle_system.glslv","particle_system_stack.glslf");var nmat_graph=m_nodemat.create_lighting_graph(material["uuid"],material["name"],data);
batch.shaders_info.node_elements=m_nodemat.compose_node_elements(nmat_graph)}var colormap=find_valid_textures("use_map_color_diffuse",true,texture_slots)[0];if(colormap){set_batch_directive(batch,"TEXTURE_COLOR",1);switch(colormap["blend_type"]){case "MIX":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":set_batch_directive(batch,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY");break}batch.diffuse_color_factor=colormap["diffuse_color_factor"];if(colormap["use_map_alpha"])batch.alpha_factor=
colormap["alpha_factor"];else batch.alpha_factor=0;var tex=m_textures.get_batch_texture(colormap);append_texture(batch,tex)}}m_vec4.set(material["diffuse_color"][0],material["diffuse_color"][1],material["diffuse_color"][2],material["alpha"],batch.diffuse_color);batch.ambient=material["ambient"];batch.diffuse_intensity=material["diffuse_intensity"];batch.emit=material["emit"];batch.specular_color.set(material["specular_color"]);batch.specular_alpha=material["specular_alpha"];set_batch_c_attr(batch,
"a_position");set_batch_c_attr(batch,"a_normal");var alpha_blend=material["game_settings"]["alpha_blend"];set_batch_directive(batch,"ALPHA",alpha_blend==="OPAQUE"?0:1);set_batch_directive(batch,"ALPHA_CLIP",alpha_blend==="CLIP"?1:0);set_batch_directive(batch,"PARTICLES_SHADELESS",material["use_shadeless"]?1:0);update_batch_specular_params(batch,material);update_batch_diffuse_params(batch,material);update_batch_game_settings(batch,material);var gs=material["game_settings"];var alpha_blend=gs["alpha_blend"];
batch.xray=material["b4w_render_above_all"]&&alpha_blend!="OPAQUE"&&alpha_blend!="CLIP";batch.offset_z=material["offset_z"];return true}function update_batch_render(batch,render){if(batch.type==="PHYSICS")return;if(render.type=="DYNAMIC"){if(render.is_hair_particles)set_batch_directive(batch,"AU_QUALIFIER","attribute");else set_batch_directive(batch,"AU_QUALIFIER","uniform");set_batch_directive(batch,"STATIC_BATCH",0)}else{set_batch_directive(batch,"AU_QUALIFIER","attribute");set_batch_directive(batch,
"STATIC_BATCH",1)}if(batch.type=="DEBUG_VIEW"){if(m_extensions.get_standard_derivatives())set_batch_directive(batch,"WIREFRAME_QUALITY",1);else set_batch_directive(batch,"WIREFRAME_QUALITY",0);if(batch.debug_sphere){set_batch_directive(batch,"DEBUG_SPHERE",1);if(batch.debug_sphere_dynamic)set_batch_directive(batch,"DEBUG_SPHERE_DYNAMIC",1);else set_batch_directive(batch,"DEBUG_SPHERE_DYNAMIC",0)}else set_batch_directive(batch,"DEBUG_SPHERE",0);set_batch_directive(batch,"ALPHA",1)}if(render.use_shape_keys)batch.use_shape_keys=
render.use_shape_keys;if(render.wind_bending){if(render.main_bend_col!==""){batch.vertex_colors_usage["a_bending_col_main"]={generate_buffer:true,src:[{name:render.main_bend_col,mask:4}]};set_batch_c_attr(batch,"a_bending_col_main");if(render.detail_bend_col.leaves_stiffness!==""&&render.detail_bend_col.leaves_phase!==""&&render.detail_bend_col.overall_stiffness!==""){batch.vertex_colors_usage["a_bending_col_detail"]={generate_buffer:true,src:[{name:render.detail_bend_col.leaves_stiffness,mask:4},
{name:render.detail_bend_col.leaves_phase,mask:2},{name:render.detail_bend_col.overall_stiffness,mask:1}]};set_batch_c_attr(batch,"a_bending_col_detail");set_batch_c_attr(batch,"a_normal");set_batch_directive(batch,"DETAIL_BEND",1)}else set_batch_directive(batch,"DETAIL_BEND",0);set_batch_directive(batch,"MAIN_BEND_COL",1)}else set_batch_directive(batch,"MAIN_BEND_COL",0);set_batch_directive(batch,"WIND_BEND",1)}else set_batch_directive(batch,"WIND_BEND",0);if(render.bend_center_only)set_batch_directive(batch,
"BEND_CENTER_ONLY",1);else set_batch_directive(batch,"BEND_CENTER_ONLY",0);set_batch_directive(batch,"BILLBOARD_PRES_GLOB_ORIENTATION",render.billboard_pres_glob_orientation|0);if(render.billboard)set_batch_directive(batch,"BILLBOARD",1);else set_batch_directive(batch,"BILLBOARD",0);if(render.billboard&&render.is_hair_particles)set_batch_directive(batch,"HAIR_BILLBOARD",1);else set_batch_directive(batch,"HAIR_BILLBOARD",0);if(render.billboard_spherical)set_batch_directive(batch,"BILLBOARD_SPHERICAL",
1);else set_batch_directive(batch,"BILLBOARD_SPHERICAL",0);switch(render.billboard_type){case "RANDOM":set_batch_directive(batch,"BILLBOARD_RANDOM",1);set_batch_directive(batch,"BILLBOARD_JITTERED",0);break;case "JITTERED":set_batch_directive(batch,"BILLBOARD_RANDOM",0);set_batch_directive(batch,"BILLBOARD_JITTERED",1);break;default:set_batch_directive(batch,"BILLBOARD_RANDOM",0);set_batch_directive(batch,"BILLBOARD_JITTERED",0);break}if(render.dynamic_grass&&cfg_def.allow_vertex_textures)set_batch_directive(batch,
"DYNAMIC_GRASS",1);else set_batch_directive(batch,"DYNAMIC_GRASS",0);batch.dynamic_grass=render.dynamic_grass;if(batch.type!="PARTICLES")batch.dynamic_geometry=render.dynamic_geometry;batch.shadow_cast=render.shadow_cast;batch.shadow_cast_only=render.shadow_cast_only;batch.shadow_receive=render.shadow_receive&&!batch.use_shadeless&&!(batch.blend&&cfg_def.disable_blend_shadows_hack);batch.reflexible=render.reflexible;batch.reflexible_only=render.reflexible_only;batch.reflective=render.reflective;if(render.is_skinning){set_batch_c_attr(batch,
"a_influence");set_batch_directive(batch,"SKINNED",1);if(cfg_def.amd_skinning_hack){set_batch_directive(batch,"DISABLE_TANGENT_SKINNING",1);set_batch_directive(batch,"FRAMES_BLENDING",0)}else{set_batch_directive(batch,"DISABLE_TANGENT_SKINNING",0);if(render.frames_blending)set_batch_directive(batch,"FRAMES_BLENDING",1);else set_batch_directive(batch,"FRAMES_BLENDING",0)}set_batch_directive(batch,"MAX_BONES",render.max_bones)}else{set_batch_directive(batch,"SKINNED",0);set_batch_directive(batch,"FRAMES_BLENDING",
0);set_batch_directive(batch,"DISABLE_TANGENT_SKINNING",0)}if(render.vertex_anim){set_batch_directive(batch,"VERTEX_ANIM",1);if(cfg_def.vert_anim_mix_normals_hack)set_batch_directive(batch,"VERTEX_ANIM_MIX_NORMALS_FACTOR",.5);else set_batch_directive(batch,"VERTEX_ANIM_MIX_NORMALS_FACTOR","u_va_frame_factor")}else set_batch_directive(batch,"VERTEX_ANIM",0);if(render.is_skinning&&render.vertex_anim)throw"Skinning and vertex animation are mutually exlusive";if(render.disable_fogging)set_batch_directive(batch,
"DISABLE_FOG",1);else set_batch_directive(batch,"DISABLE_FOG",0)}exports.update_batch_lights=update_batch_lights;function update_batch_lights(batch,lamps,scene){if(!lamps.length)return;var use_ssao=cfg_def.ssao&&scene["b4w_enable_ssao"];var shadow_lamps=m_obj_util.get_shadow_lamps(lamps,use_ssao);var shaders_info=batch.shaders_info;var lamp_index=0;for(var i=0;i<batch.shaders_info.node_elements.length;i++){var node=batch.shaders_info.node_elements[i];if(node.id=="LIGHTING_LAMP"){var lamp=lamps[lamp_index++%
lamps.length];var light=lamp.light;if(light.type=="AREA"){lamp=lamps[lamp_index++%lamps.length];light=lamp.light}var lamp_sc_data=m_obj_util.get_scene_data(lamp,scene);if(light.type=="SPOT"||light.type=="POINT")var sp_size=Math.cos(light.spot_size/2);if(light.type=="SPOT")var blend=light.spot_blend*(1-sp_size);var index=lamp_sc_data.light_index;var lfac_index=Math.floor(index/2);var lfac_channels=index%2==0?"rg":"ba";var shadow_map_ind=shadow_lamps.indexOf(lamp);node.dirs=[["LAMP_TYPE",light.type],
["LAMP_IND",index],["LAMP_LIGHT_FACT_IND",lfac_index],["LAMP_FAC_CHANNELS",lfac_channels],["LAMP_SPOT_SIZE",m_shaders.glsl_value(sp_size||.01)],["LAMP_SPOT_BLEND",m_shaders.glsl_value(blend||.01)],["LAMP_LIGHT_DIST",m_shaders.glsl_value(light.distance)],["LAMP_SHADOW_MAP_IND",shadow_map_ind]]}}if(batch.lamp_uuid_indexes){var lamp_size=0;for(var key in batch.lamp_uuid_indexes)lamp_size++;batch.lamp_light_positions=new Float32Array(lamp_size*3);batch.lamp_light_directions=new Float32Array(lamp_size*
3);batch.lamp_light_color_intensities=new Float32Array(lamp_size*3);batch.lamp_light_factors=new Float32Array(lamp_size*4);m_shaders.set_directive(shaders_info,"NUM_LAMP_LIGHTS",lamp_size);for(var i=0;i<lamps.length;i++)set_lamp_data(batch,lamps[i])}}exports.set_lamp_data=set_lamp_data;function set_lamp_data(batch,lamp){if(lamp.uuid in batch.lamp_uuid_indexes){var data_lamp_index=batch.lamp_uuid_indexes[lamp.uuid];var lamp_trans=m_tsr.get_trans_view(lamp.render.world_tsr);batch.lamp_light_positions.set(lamp_trans,
data_lamp_index*3);batch.lamp_light_directions.set(lamp.light.direction,data_lamp_index*3);batch.lamp_light_color_intensities.set(lamp.light.color_intensity,data_lamp_index*3);var light_factor=_vec4_tmp;prepare_lamp_light_factor(lamp.light,light_factor);batch.lamp_light_factors.set(light_factor,data_lamp_index*4)}}function prepare_lamp_light_factor(light,light_factor){light_factor[0]=-1;light_factor[1]=-1;light_factor[2]=-1;light_factor[3]=light.use_specular?1:0;switch(light.type){case "POINT":light_factor[2]=
light.distance;break;case "SPOT":light_factor[2]=light.distance;var sp_size=light_factor[0]=Math.cos(light.spot_size/2);light_factor[1]=light.spot_blend*(1-sp_size);break}}function update_batch_particle_systems(batch,psystems){for(var i=0;i<psystems.length;i++){var emitter_col_name=psystems[i]["settings"]["b4w_vcol_from_name"];var particle_col_name=psystems[i]["settings"]["b4w_vcol_to_name"];if(emitter_col_name!==""&&particle_col_name!=="")batch.vertex_colors_usage[emitter_col_name]={generate_buffer:false,
src:[{name:emitter_col_name,mask:7}]}}}exports.assign_shadow_receive_dirs=function(batch,shadow_params,subs_cast){set_batch_directive(batch,"CSM_SECTION0",0);set_batch_directive(batch,"CSM_SECTION1",0);set_batch_directive(batch,"CSM_SECTION2",0);set_batch_directive(batch,"CSM_SECTION3",0);set_batch_directive(batch,"NUM_CAST_LAMPS",0);if(shadow_params){var num_cast_lamps=shadow_params.lamp_types.length;set_batch_directive(batch,"NUM_CAST_LAMPS",num_cast_lamps);if(cfg_def.mac_os_shadow_hack)set_batch_directive(batch,
"MAC_OS_SHADOW_HACK",1);for(var i=0;i<shadow_params.csm_num;i++)set_batch_directive(batch,"CSM_SECTION"+String(i),1);set_batch_directive(batch,"SHADOW_TEX_RES",m_shaders.glsl_value(shadow_params.csm_resolution));set_batch_directive(batch,"CSM_FADE_LAST_CASCADE",shadow_params.fade_last_cascade?1:0);set_batch_directive(batch,"CSM_BLEND_BETWEEN_CASCADES",shadow_params.blend_between_cascades?1:0)}else{set_batch_directive(batch,"SHADOW_TEX_RES",0);set_batch_directive(batch,"CSM_FADE_LAST_CASCADE",0);set_batch_directive(batch,
"CSM_BLEND_BETWEEN_CASCADES",0)}};function set_batch_c_attr(batch,name){var cattrs=batch.common_attributes;if(cattrs.indexOf(name)==-1)cattrs.push(name)}exports.set_batch_directive=set_batch_directive;function set_batch_directive(batch,name,value){m_shaders.set_directive(batch.shaders_info,name,value)}exports.get_batch_directive=get_batch_directive;function get_batch_directive(batch,name){return m_shaders.get_directive(batch.shaders_info,name)}exports.update_batch_geometry=update_batch_geometry;function update_batch_geometry(batch,
submesh){if(batch.type=="PHYSICS"){if(submesh.shape_keys.length>0)m_geometry.submesh_init_shape_keys(submesh,submesh.va_frames[0]);batch.submesh=submesh;return}var z_sort=batch.z_sort;var draw_mode=batch.draw_mode;if(batch.halo&&batch.type!="PARTICLES")var submesh=m_geometry.extract_halo_submesh(submesh);if(batch.water_generated_mesh){var num_cascads=batch.water_num_cascads;var subdivs=batch.water_subdivs;var detailed_dist=batch.water_detailed_dist;var submesh=m_primitives.generate_multigrid(num_cascads,
subdivs,detailed_dist)}var bufs_data=m_geometry.submesh_to_bufs_data(submesh,z_sort,draw_mode,batch.vertex_colors_usage);batch.bufs_data=bufs_data;if(!(DEBUG_KEEP_BUFS_DATA_ARRAYS||batch.dynamic_geometry||bufs_data.info_for_z_sort_updates||batch.use_shape_keys)){bufs_data.ibo_array=null;bufs_data.vbo_array=null}var frames=submesh.va_frames.length;batch.num_vertices=submesh.base_length*frames;if(is_triangle_batch(batch))if(m_geometry.is_indexed(submesh))batch.num_triangles=submesh.indices.length/3*
frames;else batch.num_triangles=submesh.base_length/3*frames;else batch.num_triangles=0;if(DEBUG_SAVE_SUBMESHES)batch.submesh=submesh}function is_triangle_batch(batch){switch(batch.draw_mode){case m_geometry.DM_DEFAULT:case m_geometry.DM_TRIANGLES:case m_geometry.DM_DYNAMIC_TRIANGLES:return true;default:return false}}function update_batch_particles_emitter(batch,psystem,bpy_obj){var pset=psystem["settings"];switch(pset["b4w_billboard_align"]){case "VIEW":set_batch_directive(batch,"BILLBOARD_ALIGN",
"BILLBOARD_ALIGN_VIEW");break;case "XY":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_XY");break;case "YZ":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_YZ");break;case "ZX":set_batch_directive(batch,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_ZX");break;default:throw"Wrong billboard align value";break}set_batch_directive(batch,"BILLBOARD",0);var obj_soft_particles=pset["b4w_enable_soft_particles"]&&m_obj_util.check_obj_soft_particles_accessibility(bpy_obj,pset);var enable_softness=
pset["b4w_particles_softness"]>0&&obj_soft_particles&&cfg_def.depth_tex_available;set_batch_directive(batch,"SOFT_PARTICLES",enable_softness?1:0);set_batch_directive(batch,"SOFT_STRENGTH",m_shaders.glsl_value(pset["b4w_particles_softness"]));var world_space=pset["b4w_coordinate_system"]=="WORLD"?1:0;m_shaders.set_directive(batch.shaders_info,"WORLD_SPACE",world_space)}function make_hair_particles_metabatches(bpy_em_obj,render,emitter_vc,em_submesh,bpy_part_objs,batch_types_arr,objs_ptrans,pset,psys,
use_grass_map,seed,reset_seed){var em_obj=bpy_em_obj._object;var metabatches=[];var dyn_grass=pset["b4w_dynamic_grass"];if(!use_grass_map&&dyn_grass)return metabatches;var inst_inherit_bend=pset["b4w_wind_bend_inheritance"]=="INSTANCE";var inst_inherit_shadow=pset["b4w_shadow_inheritance"]=="INSTANCE";var inst_inherit_reflection=pset["b4w_reflection_inheritance"]=="INSTANCE";var objs_hair_render=[];var objs_tsr_array=[];for(var i=0;i<bpy_part_objs.length;i++){var part_render=bpy_part_objs[i]._object.render;
var hair_render=m_util.clone_object_nr(render);hair_render.billboard=pset["b4w_hair_billboard"];hair_render.billboard_type=pset["b4w_hair_billboard_type"];hair_render.billboard_spherical=pset["b4w_hair_billboard_geometry"]=="SPHERICAL";hair_render.dynamic_grass=dyn_grass;hair_render.is_hair_particles=true;if(inst_inherit_bend){hair_render.wind_bending=part_render.wind_bending;hair_render.wind_bending_angle=part_render.wind_bending_angle;hair_render.wind_bending_freq=part_render.wind_bending_freq;
hair_render.detail_bending_freq=part_render.detail_bending_freq;hair_render.main_bend_col=part_render.main_bend_col;hair_render.detail_bending_amp=part_render.detail_bending_amp;hair_render.branch_bending_amp=part_render.branch_bending_amp;hair_render.wind_bending_amp=part_render.wind_bending_amp;hair_render.detail_bend_col=part_render.detail_bend_col;hair_render.bend_center_only=false}else{hair_render.wind_bending=em_obj.render.wind_bending;hair_render.wind_bending_angle=em_obj.render.wind_bending_angle;
hair_render.wind_bending_freq=em_obj.render.wind_bending_freq;hair_render.detail_bending_freq=em_obj.render.detail_bending_freq;hair_render.main_bend_col=em_obj.render.main_bend_col;hair_render.detail_bending_amp=em_obj.render.detail_bending_amp;hair_render.branch_bending_amp=em_obj.render.branch_bending_amp;hair_render.wind_bending_amp=em_obj.render.wind_bending_amp;hair_render.detail_bend_col=em_obj.render.detail_bend_col;hair_render.bend_center_only=true}if(inst_inherit_shadow){hair_render.shadow_cast=
part_render.shadow_cast;hair_render.shadow_cast_only=part_render.shadow_cast_only;hair_render.shadow_receive=part_render.shadow_receive}else{hair_render.shadow_cast=em_obj.render.shadow_cast;hair_render.shadow_cast_only=em_obj.render.shadow_cast_only;hair_render.shadow_receive=em_obj.render.shadow_receive}if(inst_inherit_reflection){hair_render.reflexible=part_render.reflexible;hair_render.reflexible_only=part_render.reflexible_only;hair_render.reflective=part_render.reflective;hair_render.cube_reflection_id=
part_render.cube_reflection_id;hair_render.plane_reflection_id=part_render.plane_reflection_id;hair_render.reflection_type=part_render.reflection_type}else{hair_render.reflexible=em_obj.render.reflexible;hair_render.reflexible_only=em_obj.render.reflexible_only;hair_render.reflective=em_obj.render.reflective;hair_render.cube_reflection_id=em_obj.render.cube_reflection_id;hair_render.plane_reflection_id=em_obj.render.plane_reflection_id;hair_render.reflection_type=em_obj.render.reflection_type}objs_hair_render.push(hair_render);
var ptrans=objs_ptrans[i];if(!ptrans)ptrans=new Float32Array;if(reset_seed)m_util.init_rand_r_seed(psys["seed"],seed);var trans=new Float32Array(3);var quat=new Float32Array([0,0,0,1]);var tsr_array=[];var use_particles_rotation=m_reformer.check_particles_bin_format(cfg_def.loaded_data_version)&&!pset["b4w_initial_rand_rotation"]&&!pset["b4w_hair_billboard"];var data_len=4;if(use_particles_rotation)data_len=8;for(var j=0;j<ptrans.length;j+=data_len){trans[0]=ptrans[j];trans[1]=ptrans[j+1];trans[2]=
ptrans[j+2];var scale=ptrans[j+3]*m_tsr.get_scale(part_render.world_tsr);if(pset["b4w_initial_rand_rotation"]){switch(pset["b4w_rotation_type"]){case "XYZ":var axis=new Float32Array([m_util.rand_r(seed),m_util.rand_r(seed),m_util.rand_r(seed)]);m_vec3.normalize(axis,axis);break;case "Z":var axis=new Float32Array([0,1,0]);break;default:throw"Unsupported random rotation type: "+pset["b4w_rotation_type"];break}var strength=pset["b4w_rand_rotation_strength"];m_quat.setAxisAngle(axis,strength*(2*Math.PI*
m_util.rand_r(seed)-Math.PI),quat)}else if(use_particles_rotation){quat.set(ptrans.subarray(j+4,j+8));m_util.quat_bpy_b4w(quat,quat);if(!pset["use_whole_group"])if(pset["use_rotation_dupli"]){var part_quat=m_tsr.get_quat_view(part_render.world_tsr);m_quat.multiply(quat,part_quat,quat)}else m_quat.multiply(quat,DEFAULT_PART_SYS_QUAT,quat)}var tsr=m_tsr.set_sep(trans,scale,quat,m_tsr.create());tsr_array.push(tsr)}objs_tsr_array.push(tsr_array)}var spatial_tree={};for(var i=0;i<bpy_part_objs.length;i++){var bpy_obj=
bpy_part_objs[i];var btypes=batch_types_arr[i];var hair_render=objs_hair_render[i];var submesh_params={};if(hair_render.wind_bending){submesh_params["au_wind_bending_amp"]=[hair_render.wind_bending_amp];submesh_params["au_wind_bending_freq"]=[hair_render.wind_bending_freq];submesh_params["au_detail_bending_freq"]=[hair_render.detail_bending_freq];submesh_params["au_detail_bending_amp"]=[hair_render.detail_bending_amp];submesh_params["au_branch_bending_amp"]=[hair_render.branch_bending_amp];hair_render.wind_bending_amp=
0;hair_render.wind_bending_freq=0;hair_render.detail_bending_freq=0;hair_render.detail_bending_amp=0;hair_render.branch_bending_amp=0}var hair_render_id=calculate_render_id(hair_render);var tsr_array=objs_tsr_array[i];if(!tsr_array.length)continue;var mesh=bpy_obj["data"];var materials=mesh["materials"];var batches_main=new Array(materials.length);var batches_debug_view=new Array(materials.length);for(var j=0;j<materials.length;j++){if(m_geometry.has_empty_submesh(mesh,j))continue;for(var k=0;k<btypes.length;k++){var type=
btypes[k];var batch=init_batch(type);var material=materials[j];if(type=="COLOR_ID")batch.can_fork_outline=!(bpy_obj["b4w_do_not_render"]||material["b4w_do_not_render"]);if(type=="MAIN")batches_main[j]=batch;else if(type=="DEBUG_VIEW")batches_debug_view[j]=batch;batch.cluster_id=bpy_em_obj["b4w_cluster_data"]["cluster_id"];if(!batch_material_is_valid(batch,material))continue;if(type=="SHADOW"&&batches_main[j])batch.use_shadeless=batches_main[j].use_shadeless;batch.draw_mode=m_geometry.DM_DEFAULT;update_batch_render(batch,
hair_render);batch.odd_id_prop=pset["uuid"];if(pset["b4w_hair_billboard_type"]=="JITTERED"){batch.jitter_amp=pset["b4w_hair_billboard_jitter_amp"];batch.jitter_freq=pset["b4w_hair_billboard_jitter_freq"]}if(dyn_grass)batch.grass_scale_threshold=pset["b4w_dynamic_grass_scale_threshold"];if(!inst_inherit_bend){delete batch.vertex_colors_usage["a_bending_col_main"];delete batch.vertex_colors_usage["a_bending_col_detail"]}update_batch_id(batch,hair_render_id);var src_submesh=m_geometry.extract_submesh(mesh,
j,batch.common_attributes,render.bone_skinning_info,batch.vertex_colors_usage,batch.uv_maps_usage);var submesh=m_geometry.make_clone_submesh(src_submesh,submesh_params,tsr_array,em_obj);submesh=fill_submesh_center_pos(submesh,tsr_array);if(hair_render.wind_bending&&hair_render.bend_center_only)submesh=fill_submesh_emitter_center(submesh,em_obj.render.world_tsr);var particle_inherited_attrs=get_particle_inherited_attrs(pset["b4w_vcol_from_name"],pset["b4w_vcol_to_name"],batch,emitter_vc,!inst_inherit_bend,
mesh);submesh=make_particle_inherited_vcols(submesh,tsr_array,em_obj.render.bb_local,em_submesh,particle_inherited_attrs,batch.vertex_colors_usage,spatial_tree);metabatches.push({batch:batch,submesh:submesh,mat_names:[material["name"]],render:hair_render,rel_bpy_objects:[bpy_em_obj]})}}for(var j=0;j<batches_debug_view.length;j++)if(batches_debug_view[j]){batches_debug_view[j].debug_id=batches_main[j].id;update_batch_id(batches_debug_view[j],batches_debug_view[j].render_id)}}return metabatches}function batch_material_is_valid(batch,
material){var is_valid=true;if(batch.type=="NODES_GLOW")is_valid=m_nodemat.check_material_glow_output(material);is_valid=is_valid&&update_batch_material(batch,material);return is_valid}function make_spatial_tree(spatial_tree,obj_bb_local,positions){spatial_tree.cell_size=new Float32Array(3);spatial_tree.base_point=new Float32Array(3);spatial_tree.verts_indices=new Uint32Array(positions.length/3);spatial_tree.octs_indices=new Uint32Array(positions.length/3);spatial_tree.cell_size[0]=(obj_bb_local.max_x-
obj_bb_local.min_x)/STREE_CELL_COUNT;spatial_tree.cell_size[1]=(obj_bb_local.max_y-obj_bb_local.min_y)/STREE_CELL_COUNT;spatial_tree.cell_size[2]=(obj_bb_local.max_z-obj_bb_local.min_z)/STREE_CELL_COUNT;spatial_tree.base_point[0]=obj_bb_local.min_x;spatial_tree.base_point[1]=obj_bb_local.min_y;spatial_tree.base_point[2]=obj_bb_local.min_z;for(var i=0;i<positions.length/3;i++){var x=positions[i*3];var y=positions[i*3+1];var z=positions[i*3+2];var num_x=m_util.trunc((x-spatial_tree.base_point[0])/spatial_tree.cell_size[0]);
var num_y=m_util.trunc((y-spatial_tree.base_point[1])/spatial_tree.cell_size[1]);var num_z=m_util.trunc((z-spatial_tree.base_point[2])/spatial_tree.cell_size[2]);num_x=m_util.clamp(num_x,0,STREE_CELL_COUNT-1);num_y=m_util.clamp(num_y,0,STREE_CELL_COUNT-1);num_z=m_util.clamp(num_z,0,STREE_CELL_COUNT-1);spatial_tree.verts_indices[i]=i;spatial_tree.octs_indices[i]=num_z*Math.pow(STREE_CELL_COUNT,2)+num_y*STREE_CELL_COUNT+num_x}m_geometry.sort_two_arrays(spatial_tree.octs_indices,spatial_tree.verts_indices,
m_geometry.SORT_NUMERIC,true);spatial_tree.verts_offsets=new Uint32Array(Math.pow(STREE_CELL_COUNT,3));for(var i=0;i<spatial_tree.octs_indices.length;i++){var index=spatial_tree.octs_indices[i];spatial_tree.verts_offsets[index]++}delete spatial_tree.octs_indices;for(var i=1;i<spatial_tree.verts_offsets.length;i++)spatial_tree.verts_offsets[i]+=spatial_tree.verts_offsets[i-1];return spatial_tree}function get_particle_inherited_attrs(vc_name_from,vc_name_to,batch,emitter_vc,bend_inheritance,particle_mesh){var inherited_attrs=
[];if(vc_name_from!==""&&vc_name_to!==""){var col_usage_data=get_vcol_usage_data_by_name(vc_name_to,batch.vertex_colors_usage);if(col_usage_data.length>0)for(var i=0;i<col_usage_data.length;i+=3)inherited_attrs.push({emitter_attr:vc_name_from,emitter_mask:7,particle_attr:col_usage_data[i],particle_mask:col_usage_data[i+1],dst_channel_offset:col_usage_data[i+2]});else if(m_geometry.has_attr(batch.common_attributes,"a_color"))if(vc_name_to==particle_mesh["active_vcol_name"])inherited_attrs.push({emitter_attr:vc_name_from,
emitter_mask:7,particle_attr:"a_color",particle_mask:7,dst_channel_offset:0})}if(bend_inheritance){if("a_bending_col_main"in emitter_vc)inherited_attrs.push({emitter_attr:"a_bending_col_main",emitter_mask:4,particle_attr:"a_bending_col_main",particle_mask:4,dst_channel_offset:0});if("a_bending_col_detail"in emitter_vc)inherited_attrs.push({emitter_attr:"a_bending_col_detail",emitter_mask:7,particle_attr:"a_bending_col_detail",particle_mask:7,dst_channel_offset:0})}return inherited_attrs}function get_vcol_usage_data_by_name(color_name,
vc_usage){var data=[];for(var attr_name in vc_usage){var src_colors=vc_usage[attr_name].src;var dst_channel_offset=0;for(var i=0;i<src_colors.length;i++){var mask=src_colors[i].mask;if(color_name==src_colors[i].name)data.push(attr_name,mask,dst_channel_offset);dst_channel_offset+=m_util.rgb_mask_get_channels_count(mask)}}return data}function fill_submesh_center_pos(submesh,transforms){submesh.va_common["au_center_pos"]=new Float32Array(submesh.base_length*3);var t_count=transforms.length;var base_length=
submesh.base_length/t_count;for(var i=0;i<t_count;i++){var transform=transforms[i];var v_offset=base_length*3*i;for(var j=0;j<base_length;j++){submesh.va_common["au_center_pos"][v_offset+j*3]=transform[0];submesh.va_common["au_center_pos"][v_offset+j*3+1]=transform[1];submesh.va_common["au_center_pos"][v_offset+j*3+2]=transform[2]}}return submesh}function fill_submesh_emitter_center(submesh,em_world_tsr){submesh.va_common["a_emitter_center"]=new Float32Array(submesh.base_length*3);var origin=m_vec3.fromValues(0,
0,0);m_tsr.transform_vec3(origin,em_world_tsr,origin);for(var i=0;i<submesh.base_length;i++){submesh.va_common["a_emitter_center"][i*3]=origin[0];submesh.va_common["a_emitter_center"][i*3+1]=origin[1];submesh.va_common["a_emitter_center"][i*3+2]=origin[2]}return submesh}function make_particle_inherited_vcols(submesh,transforms,em_bb_local,em_submesh,inherited_attrs,vc_usage,spatial_tree){var calc_nearest=false;for(var i=0;i<inherited_attrs.length;i++){var em_attr=inherited_attrs[i].emitter_attr;var cols=
em_submesh.va_common[em_attr];if(cols&&cols.length>0){calc_nearest=true;break}}if(calc_nearest){var nearest_points=calc_emitter_nearest_points(em_bb_local,em_submesh.va_frames[0]["a_position"],transforms,spatial_tree);var particle_verts_count=submesh.base_length/transforms.length;for(var i=0;i<inherited_attrs.length;i++){var p_attr=inherited_attrs[i].particle_attr;var p_mask=inherited_attrs[i].particle_mask;var em_attr=inherited_attrs[i].emitter_attr;var em_mask=inherited_attrs[i].emitter_mask;var cols=
em_submesh.va_common[em_attr];switch(p_attr){case "a_bending_col_main":var p_attr_channels_total=1;break;case "a_bending_col_detail":var p_attr_channels_total=3;break;case "a_color":var p_attr_channels_total=3;break;default:var p_attr_channels_total=0;for(var j=0;j<vc_usage[p_attr].src.length;j++)p_attr_channels_total+=m_util.rgb_mask_get_channels_count(vc_usage[p_attr].src[j].mask);break}if(cols&&cols.length>0){var emitter_comp_count=m_util.rgb_mask_get_channels_count(em_mask);var particle_comp_count=
m_util.rgb_mask_get_channels_count(p_mask);var mask_from=em_mask&p_mask;var channel_presence_from=m_util.rgb_mask_get_channels_presence(mask_from);if(mask_from!=p_mask)m_print.error("Wrong color extraction from "+em_attr+" to "+p_attr+".");if(p_attr=="a_bending_col_main"||p_attr=="a_bending_col_detail")submesh.va_common[p_attr]=new Float32Array(submesh.base_length*particle_comp_count);for(var j=0;j<transforms.length;j++){var nearest_index=nearest_points[j];var em_vert_offset=nearest_index*emitter_comp_count;
var p_offset=j*particle_verts_count*p_attr_channels_total;if(nearest_index!=-1)for(var k=0;k<particle_verts_count;k++){var p_vert_offset=k*p_attr_channels_total;for(var l=0;l<channel_presence_from.length;l++)if(channel_presence_from[l]){var em_channel_offset=m_util.rgb_mask_get_channel_presence_index(em_mask,l);var p_channel_offset=inherited_attrs[i].dst_channel_offset+m_util.rgb_mask_get_channel_presence_index(p_mask,l);submesh.va_common[p_attr][p_offset+p_vert_offset+p_channel_offset]=cols[em_vert_offset+
em_channel_offset]}}}}else submesh.va_common[p_attr]=new Float32Array(0)}}return submesh}function calc_emitter_nearest_points(em_bb_local,em_positions,transforms,spatial_tree){var particle_cen=new Float32Array(3);var em_vert=new Float32Array(3);var nearest_points=new Uint32Array(transforms.length);if(!("verts_indices"in spatial_tree))make_spatial_tree(spatial_tree,em_bb_local,em_positions);for(var i=0;i<transforms.length;i++){particle_cen[0]=transforms[i][0];particle_cen[1]=transforms[i][1];particle_cen[2]=
transforms[i][2];var min_dist=1E10;var min_index=-1;var num_x=m_util.trunc((particle_cen[0]-spatial_tree.base_point[0])/spatial_tree.cell_size[0]);var num_y=m_util.trunc((particle_cen[1]-spatial_tree.base_point[1])/spatial_tree.cell_size[1]);var num_z=m_util.trunc((particle_cen[2]-spatial_tree.base_point[2])/spatial_tree.cell_size[2]);num_x=m_util.clamp(num_x,0,STREE_CELL_COUNT-1);num_y=m_util.clamp(num_y,0,STREE_CELL_COUNT-1);num_z=m_util.clamp(num_z,0,STREE_CELL_COUNT-1);var oct_index=num_z*Math.pow(STREE_CELL_COUNT,
2)+num_y*STREE_CELL_COUNT+num_x;var from_index=oct_index==0?0:spatial_tree.verts_offsets[oct_index-1];var to_index=spatial_tree.verts_offsets[oct_index];for(var j=from_index;j<to_index;j++){var index=spatial_tree.verts_indices[j];em_vert[0]=em_positions[index*3];em_vert[1]=em_positions[index*3+1];em_vert[2]=em_positions[index*3+2];m_vec3.sub(em_vert,particle_cen,em_vert);var sq_len=m_vec3.sqrLen(em_vert);if(sq_len<=min_dist){min_dist=sq_len;min_index=index}}if(min_index==-1)for(var j=0;j<em_positions.length/
3;j++){em_vert[0]=em_positions[j*3];em_vert[1]=em_positions[j*3+1];em_vert[2]=em_positions[j*3+2];m_vec3.sub(em_vert,particle_cen,em_vert);var sq_len=m_vec3.sqrLen(em_vert);if(sq_len<=min_dist){min_dist=sq_len;min_index=j}}nearest_points[i]=min_index}return nearest_points}function distribute_ptrans_equally(ptrans,dupli_objects,seed,use_particles_rotation,data_len){var objs_count=dupli_objects.length;var ptrans_dist={};for(var i=0;i<ptrans.length;i+=data_len){var index=Math.floor(objs_count*m_util.rand_r(seed));
var robj_name=dupli_objects[index].name;ptrans_dist[index]=ptrans_dist[index]||[];ptrans_dist[index].push(ptrans[i],ptrans[i+1],ptrans[i+2],ptrans[i+3]);if(use_particles_rotation)ptrans_dist[index].push(ptrans[i+4],ptrans[i+5],ptrans[i+6],ptrans[i+7])}for(var index in ptrans_dist)ptrans_dist[index]=new Float32Array(ptrans_dist[index]);return ptrans_dist}function distribute_ptrans_group(ptrans,dupli_objects,use_particles_rotation,data_len){var ptrans_dist={};var quat=new Float32Array([0,0,0,1]);for(var i=
0;i<ptrans.length;i+=data_len)for(var j=0;j<dupli_objects.length;j++){var obj_name=dupli_objects[j].name;var obj_trans=m_vec3.create();var dupli_scale=m_tsr.get_scale(dupli_objects[j].render.world_tsr);var dupli_trans=m_tsr.get_trans_view(dupli_objects[j].render.world_tsr);m_vec3.scale(dupli_trans,dupli_scale,obj_trans);var res_trans=m_vec3.clone([ptrans[i],ptrans[i+1],ptrans[i+2]]);if(!ptrans_dist[j])ptrans_dist[j]=new Float32Array(ptrans.length);if(use_particles_rotation){ptrans_dist[j][i+4]=quat[0]=
ptrans[i+4];ptrans_dist[j][i+5]=quat[1]=ptrans[i+5];ptrans_dist[j][i+6]=quat[2]=ptrans[i+6];ptrans_dist[j][i+7]=quat[3]=ptrans[i+7];m_util.quat_bpy_b4w(quat,quat);m_util.transformQuatFast(obj_trans,quat,obj_trans)}m_vec3.add(res_trans,obj_trans,res_trans);ptrans_dist[j][i]=res_trans[0];ptrans_dist[j][i+1]=res_trans[1];ptrans_dist[j][i+2]=res_trans[2];ptrans_dist[j][i+3]=ptrans[i+3]}return ptrans_dist}function distribute_ptrans_by_dupli_weights(ptrans,dupli_objects,dupli_weights,seed,use_particles_rotation,
data_len){var ptrans_dist={};function rand_obj_index_by_weights(dupli_weights){var weight_sum_array=[0];for(var i=0;i<dupli_weights.length;i++){var weight=dupli_weights[i];weight_sum_array[i+1]=weight_sum_array[i]+weight["count"]}var last=weight_sum_array[weight_sum_array.length-1];var weight_sum_rand=last*m_util.rand_r(seed);var weight_index=0;for(var i=0;i<weight_sum_array.length;i++)if(weight_sum_rand>=weight_sum_array[i]&&weight_sum_rand<weight_sum_array[i+1]){weight_index=i;break}return weight_index}
var dupli_weights_sorted=[];for(var i=0;i<dupli_objects.length;i++){var dg_obj=dupli_objects[i];var name=dg_obj.origin_name||dg_obj.name;for(var j=0;j<dupli_weights.length;j++){var weight=dupli_weights[j];if(name==weight["name"])dupli_weights_sorted.push(weight)}}if(dupli_weights.length!=dupli_weights_sorted.length)m_print.error("dupli weights match failed");for(var i=0;i<ptrans.length;i+=data_len){var index=rand_obj_index_by_weights(dupli_weights_sorted);ptrans_dist[index]=ptrans_dist[index]||[];
ptrans_dist[index].push(ptrans[i],ptrans[i+1],ptrans[i+2],ptrans[i+3]);if(use_particles_rotation)ptrans_dist[index].push(ptrans[i+4],ptrans[i+5],ptrans[i+6],ptrans[i+7])}for(var index in ptrans_dist)ptrans_dist[index]=new Float32Array(ptrans_dist[index]);return ptrans_dist}function create_object_clusters(bpy_static_objs){var clusters=[];var cluster_ids={};for(var i=0;i<bpy_static_objs.length;i++){var bpy_obj=bpy_static_objs[i];var obj_render=bpy_obj._object.render;var bb_local=m_bounds.zero_bounding_box();
m_bounds.copy_bb(obj_render.bb_original,bb_local);var bb_world=m_bounds.bounding_box_transform(bb_local,obj_render.world_tsr);var bs_local=m_bounds.create_bounding_sphere(bpy_obj["data"]["b4w_bounding_sphere_radius"],bpy_obj["data"]["b4w_bounding_sphere_center"]);var bs_world=m_bounds.bounding_sphere_transform(bs_local,obj_render.world_tsr);var be_axes=bpy_obj["data"]["b4w_bounding_ellipsoid_axes"];var be_local=m_bounds.create_bounding_ellipsoid([be_axes[0],0,0],[0,be_axes[1],0],[0,0,be_axes[2]],
bpy_obj["data"]["b4w_bounding_ellipsoid_center"]);var be_world=m_bounds.bounding_ellipsoid_transform(be_local,obj_render.world_tsr);obj_render.bb_local=bb_local;obj_render.bb_world=bb_world;obj_render.bs_local=bs_local;obj_render.bs_world=bs_world;obj_render.be_local=be_local;obj_render.be_world=be_world;var render_props={};render_props.shadow_cast=obj_render.shadow_cast;render_props.shadow_cast_only=obj_render.shadow_cast_only;render_props.shadow_receive=obj_render.shadow_receive;render_props.selectable=
obj_render.selectable;render_props.origin_selectable=obj_render.origin_selectable;render_props.outlining=obj_render.outlining;render_props.origin_outlining=obj_render.origin_outlining;render_props.outline_anim_settings_default=obj_render.outline_anim_settings_default;render_props.reflexible=obj_render.reflexible;render_props.reflexible_only=obj_render.reflexible_only;render_props.reflective=obj_render.reflective;render_props.cube_reflection_id=obj_render.cube_reflection_id;render_props.plane_reflection_id=
obj_render.plane_reflection_id;render_props.reflection_type=obj_render.reflection_type;render_props.caustics=obj_render.caustics;render_props.wind_bending=obj_render.wind_bending;render_props.main_bend_col=obj_render.main_bend_col;render_props.detail_bend_col=obj_render.detail_bend_col;render_props.billboard=obj_render.billboard;render_props.billboard_type=obj_render.billboard_type;render_props.billboard_spherical=obj_render.billboard_spherical;render_props.dynamic_grass=obj_render.dynamic_grass;
render_props.do_not_cull=obj_render.do_not_cull;render_props.disable_fogging=obj_render.disable_fogging;render_props.dynamic_geometry=obj_render.dynamic_geometry;render_props.cluster_id=bpy_obj["b4w_cluster_data"]["cluster_id"];render_props.lod_dist_max=obj_render.lod_dist_max;render_props.lod_dist_min=obj_render.lod_dist_min;render_props.lod_transition_ratio=obj_render.lod_transition_ratio;render_props.do_not_render=obj_render.do_not_render;var id=JSON.stringify(render_props);cluster_ids[id]=cluster_ids[id]||
[];cluster_ids[id].push(bpy_obj)}for(var key in cluster_ids){var render_props=JSON.parse(key);delete render_props.cluster_id;var bpy_objects=cluster_ids[key];var render=m_obj_util.create_render("STATIC");for(var prop in render_props)render[prop]=render_props[prop];render.data_id=bpy_static_objs[0]._object.render.data_id;render.wind_bending_amp=0;render.wind_bending_freq=0;render.detail_bending_freq=0;render.detail_bending_amp=0;render.branch_bending_amp=0;render.hide=false;for(var i=0;i<bpy_objects.length;i++){var obj=
bpy_objects[i]._object;if(i==0){render.bb_world=m_util.clone_object_r(obj.render.bb_world);render.bs_world=m_util.clone_object_r(obj.render.bs_world)}else{m_bounds.expand_bounding_box(render.bb_world,obj.render.bb_world);m_bounds.expand_bounding_sphere(render.bs_world,obj.render.bs_world)}}render.be_world=m_bounds.zero_bounding_ellipsoid();render.be_local=m_bounds.zero_bounding_ellipsoid();render.bb_local=m_util.clone_object_r(render.bb_world);render.bs_local=m_util.clone_object_r(render.bs_world);
var cluster={render:render,bpy_objects:bpy_objects};clusters.push(cluster)}return clusters}exports.update_batch_id=update_batch_id;function update_batch_id(batch,render_id){var canvas_context=null;var video_elements=null;var bb_local=batch.bb_local;var be_local=batch.be_local;var bb_world=batch.bb_world;var be_world=batch.be_world;batch.bb_local=null;batch.be_local=null;batch.bb_world=null;batch.be_world=null;for(var i=0;i<batch.textures.length;i++){var ctx=batch.textures[i].canvas_context;if(ctx){if(!canvas_context)canvas_context=
{};canvas_context[i]=ctx;batch.textures[i].canvas_context=null}var video=batch.textures[i].video_file;if(video){if(!video_elements)video_elements={};video_elements[i]=video;batch.textures[i].video_file=null}}batch.id=0;batch.render_id=render_id;batch.id=m_util.calc_variable_id(batch,render_id);batch.bb_local=bb_local;batch.be_local=be_local;batch.bb_world=bb_world;batch.be_world=be_world;if(canvas_context)for(var j in canvas_context)batch.textures[j].canvas_context=canvas_context[j];if(video_elements)for(var j in video_elements)batch.textures[j].video_file=
video_elements[j]}exports.calculate_render_id=calculate_render_id;function calculate_render_id(render){var bone_pointers=render.bone_pointers;render.bone_pointers=null;var id=m_util.calc_variable_id(render,0);render.bone_pointers=bone_pointers;return id}exports.create_bounding_ellipsoid_batch=create_bounding_ellipsoid_batch;function create_bounding_ellipsoid_batch(bv,render,obj_name,ellipsoid,is_dynamic,source_obj){var batch=init_batch("DEBUG_VIEW");apply_shader(batch,"debug_view.glslv","debug_view.glslf");
batch.debug_view_mode=0;batch.debug_sphere=true;batch.depth_mask=true;batch.odd_id_prop=obj_name;if(is_dynamic)batch.debug_sphere_dynamic=true;update_batch_render(batch,render);var render_id=calculate_render_id(render);update_batch_id(batch,render_id);if(ellipsoid){var center=is_dynamic?bv.center:[0,0,0];var submesh=m_primitives.generate_uv_sphere(16,8,1,center,false,false);var scale=[m_vec3.length(bv.axis_x),m_vec3.length(bv.axis_y),m_vec3.length(bv.axis_z)];m_geometry.scale_submesh_xyz(submesh,
scale,center);if(!is_dynamic){m_tsr.set_trans(bv.center,_tsr_tmp);var axis_x=m_vec3.normalize(bv.axis_x,_vec3_tmp);var axis_y=m_vec3.normalize(bv.axis_y,_vec3_tmp2);var axis_z=m_vec3.normalize(bv.axis_z,_vec3_tmp3);var ellipsoid_mat=m_util.ellipsoid_axes_to_mat3(axis_x,axis_y,axis_z,_mat3_tmp);m_mat3.invert(ellipsoid_mat,ellipsoid_mat);var quat=m_quat.fromMat3(ellipsoid_mat,_vec4_tmp);m_tsr.set_quat(quat,_tsr_tmp);m_tsr.set_scale(1,_tsr_tmp);m_geometry.submesh_apply_transform(submesh,_tsr_tmp)}}else var submesh=
m_primitives.generate_uv_sphere(16,8,bv.radius,bv.center,false,false);batch.bb_local=m_util.clone_object_r(source_obj.bb_local);batch.be_local=m_util.clone_object_r(source_obj.be_local);batch.bb_world=m_util.clone_object_r(source_obj.bb_world);batch.be_world=m_util.clone_object_r(source_obj.be_world);m_geometry.submesh_drop_indices(submesh,1,true);submesh.va_common["a_polyindex"]=m_geometry.extract_polyindices(submesh);update_batch_geometry(batch,submesh);return batch}function apply_shader(batch,
vert,frag){batch.shaders_info.vert=vert;batch.shaders_info.frag=frag;m_shaders.set_default_directives(batch.shaders_info)}exports.append_texture=append_texture;function append_texture(batch,texture,name){if(batch.textures.length==1&&batch.texture_names.length==0)batch.texture_names.push("default0");name=name||"default"+String(batch.textures.length);if(batch.texture_names.indexOf(name)==-1){batch.textures.push(texture);batch.texture_names.push(name)}if(batch.shader)m_render.assign_texture_uniforms(batch)}
exports.replace_texture=function(batch,texture,name){var index=batch.texture_names.indexOf(name);if(index>-1)batch.textures[index]=texture};exports.create_shadeless_batch=function(submesh,color,alpha){var batch=init_batch("MAIN");if(alpha<1)batch.blend=true;m_vec4.set(color[0],color[1],color[2],alpha,batch.diffuse_color);batch.draw_mode=m_geometry.DM_TRIANGLES;update_batch_geometry(batch,submesh);apply_shader(batch,"main.glslv","main_stack.glslf");set_batch_directive(batch,"SHADELESS",1);update_shader(batch);
return batch};exports.update_shader=update_shader;function update_shader(batch){if(!batch.shaders_info)throw"No shaders info for batch "+batch.name;batch.shader=m_shaders.get_compiled_shader(batch.shaders_info);m_render.assign_uniform_setters(batch.shader);m_render.assign_attribute_setters(batch);m_render.assign_texture_uniforms(batch)}exports.generate_line_batches=function(scene,bpy_line_objects){for(var i=0;i<bpy_line_objects.length;i++){var line_obj=bpy_line_objects[i]._object;var batch=init_batch("LINE");
apply_shader(batch,"line.glslv","line.glslf");batch.blend=true;var submesh=m_primitives.generate_line();update_batch_geometry(batch,submesh);update_batch_subtype(batch);batch.bb_local=m_bounds.zero_bounding_box();batch.bb_world=m_bounds.zero_bounding_box();batch.be_local=m_bounds.zero_bounding_ellipsoid();batch.be_world=m_bounds.zero_bounding_ellipsoid();m_obj_util.append_scene_data(line_obj,scene);var sc_data=m_obj_util.get_scene_data(line_obj,scene);sc_data.batches.push(batch);update_shader(batch)}};
exports.check_batch_perm_uniform=function(batch,uniform_name){if(!batch.shader.permanent_uniform_setters.length)return false;if(batch.shader.permanent_uniform_setters_table[uniform_name])return true;return false};exports.create_depth_pack_batch=function(tex){var batch=init_batch("DEPTH_PACK");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/depth_pack.glslf");
update_shader(batch);return batch};exports.create_postprocessing_batch=function(post_effect){var batch=init_batch("POSTPROCESSING");apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/postprocessing.glslf");switch(post_effect){case "NONE":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_NONE");break;case "GRAYSCALE":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_GRAYSCALE");break;case "X_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_BLUR");break;case "Y_BLUR":set_batch_directive(batch,
"POST_EFFECT","POST_EFFECT_Y_BLUR");break;case "X_GLOW_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_GLOW_BLUR");break;case "Y_GLOW_BLUR":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_Y_GLOW_BLUR");break;case "X_EXTEND":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_EXTEND");break;case "Y_EXTEND":set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_Y_EXTEND");break;case "FLIP_CUBEMAP_COORDS":set_batch_directive(batch,"POST_EFFECT","FLIP_CUBEMAP_COORDS");break;default:throw"Wrong postprocessing effect: "+
post_effect;break}batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);update_shader(batch);return batch};exports.create_ssao_batch=function(subs){var batch=init_batch("SSAO");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/ssao.glslf");set_batch_directive(batch,
"SSAO_QUALITY","SSAO_QUALITY_"+subs.ssao_samples);set_batch_directive(batch,"SSAO_HEMISPHERE",subs.ssao_hemisphere?1:0);var texture=m_textures.generate_texture("SSAO_TEXTURE",subs);var texture_slot={"texture":texture};var random_vector_table={width:4,height:4,data:new Uint8Array([150,123,254,0,127,3,97,0,164,246,99,0,155,177,14,0,54,83,221,0,2,142,143,0,32,57,79,0,49,160,32,0,57,232,115,0,178,216,203,0,70,196,218,0,241,164,82,0,225,58,85,0,233,88,189,0,144,25,203,0,117,73,12,0])};var tex=m_textures.get_batch_texture(texture_slot,
random_vector_table);append_texture(batch,tex,"u_ssao_special_tex");update_shader(batch);return batch};exports.create_ssao_blur_batch=function(subs){var batch=init_batch("SSAO_BLUR");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/ssao_blur.glslf");set_batch_directive(batch,"SSAO_BLUR_DEPTH",subs.ssao_blur_depth?1:0);update_shader(batch);
return batch};exports.create_dof_batch=function(subs){var batch=init_batch("DOF");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/dof.glslf");set_batch_directive(batch,"DEPTH_RGBA",1);update_shader(batch);return batch};exports.create_outline_batch=function(){var batch=init_batch("OUTLINE");batch.depth_mask=false;batch.use_backface_culling=
true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/outline.glslf");update_shader(batch);return batch};exports.create_glow_combine_batch=function(){var batch=init_batch("GLOW_COMBINE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/glow.glslf");
update_shader(batch);return batch};exports.create_god_rays_batch=function(tex_input,pack,water,steps){var batch=init_batch("GOD_RAYS");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_billboard();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/god_rays.glslv","postprocessing/god_rays.glslf");set_batch_directive(batch,"DEPTH_RGBA",pack?1:0);set_batch_directive(batch,"WATER_EFFECTS",water?1:0);set_batch_directive(batch,"STEPS_PER_PASS",
m_shaders.glsl_value(steps,1));update_shader(batch);return batch};exports.create_god_rays_combine_batch=function(tex_main,tex_god_rays){var batch=init_batch("GOD_RAYS_COM");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/god_rays_combine.glslf");set_batch_directive(batch,"SAFARI_CANVAS_ALPHA_HACK",cfg_def.safari_canvas_alpha_hack?1:
0);update_shader(batch);return batch};exports.create_procedural_sky_batch=function(){var batch=init_batch("SKY");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_cube();update_batch_geometry(batch,submesh);apply_shader(batch,"procedural_skydome.glslv","procedural_skydome.glslf");set_batch_directive(batch,"WATER_EFFECTS",1);update_shader(batch);return batch};exports.create_antialiasing_batch=function(subs){var batch=init_batch("ANTIALIASING");batch.depth_mask=
false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/antialiasing.glslf");if(cfg_def.quality_aa_method){set_batch_directive(batch,"AA_METHOD","AA_METHOD_FXAA_QUALITY");set_batch_directive(batch,"AA_QUALITY",subs.fxaa_quality)}else set_batch_directive(batch,"AA_METHOD","AA_METHOD_FXAA_LIGHT");update_shader(batch);return batch};exports.create_smaa_batch=function(type){var batch=
init_batch("SMAA");var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/smaa.glslv","postprocessing/smaa.glslf");set_batch_directive(batch,"AA_METHOD","AA_METHOD_SMAA_HIGH");set_batch_directive(batch,"SMAA_PASS",type);set_batch_directive(batch,"SMAA_PREDICATION",0);set_batch_directive(batch,"SMAA_REPROJECTION",0);update_shader(batch);batch.depth_mask=false;batch.use_backface_culling=true;return batch};exports.create_compositing_batch=
function(){var batch=init_batch("COMPOSITING");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/compositing.glslf");update_shader(batch);return batch};exports.create_motion_blur_batch=function(decay_threshold){var batch=init_batch("MOTION_BLUR");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();
update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/motion_blur.glslf");update_shader(batch);return batch};exports.create_stereo_batch=function(stereo_type){var batch=init_batch("STEREO");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/stereo.glslf");set_batch_directive(batch,
"ANAGLYPH",stereo_type==="ANAGLYPH"?1:0);set_batch_directive(batch,"DISABLE_DISTORTION_CORRECTION",0);update_shader(batch);return batch};exports.create_luminance_batch=function(){var batch=init_batch("LUMINANCE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/luminance.glslf");update_shader(batch);return batch};exports.create_average_luminance_batch=
function(){var batch=init_batch("LUMINANCE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/luminance_av.glslf");update_shader(batch);return batch};exports.create_luminance_trunced_batch=function(){var batch=init_batch("LUMINANCE_X_BLUR");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();
update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/luminance_trunced.glslv","postprocessing/luminance_trunced.glslf");update_shader(batch);return batch};exports.create_bloom_blur_batch=function(){var batch=init_batch("POSTPROCESSING");batch.use_backface_culling=true;batch.depth_mask=false;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/bloom_blur.glslf");update_shader(batch);
return batch};exports.create_bloom_combine_batch=function(){var batch=init_batch("BLOOM");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/bloom_combine.glslf");update_shader(batch);return batch};exports.create_velocity_batch=function(){var batch=init_batch("VELOCITY");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=
m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/velocity.glslf");update_shader(batch);return batch};exports.create_anchor_visibility_batch=function(){var batch=init_batch("ANCHOR_VISIBILITY");batch.depth_mask=true;batch.use_backface_culling=true;batch.draw_mode=m_geometry.DM_POINTS;apply_shader(batch,"anchors.glslv","anchors.glslf");var submesh=m_primitives.generate_index(1);update_batch_geometry(batch,
submesh);set_batch_directive(batch,"ANCHOR_NUM",1);update_shader(batch);batch.positions=new Float32Array([0,0,0]);return batch};exports.create_performance_batch=function(){var batch=init_batch("PERFORMANCE");batch.depth_mask=false;batch.use_backface_culling=true;var submesh=m_primitives.generate_fullscreen_tri();update_batch_geometry(batch,submesh);apply_shader(batch,"postprocessing/postprocessing.glslv","postprocessing/performance.glslf");set_batch_directive(batch,"POST_EFFECT","POST_EFFECT_X_BLUR");
update_shader(batch);return batch};exports.update_anchor_visibility_batch=function(batch,positions){var num=positions.length/3;if(num!=batch.positions.length/3){var submesh=m_primitives.generate_index(num);update_batch_geometry(batch,submesh);set_batch_directive(batch,"ANCHOR_NUM",num);update_shader(batch)}batch.positions=positions};exports.get_first_batch=function(obj){if(!obj.scenes_data.length)return null;var scene_data=obj.scenes_data[0];if(scene_data.batches.length)return scene_data.batches[0];
else return null};exports.find_batch_material=find_batch_material;function find_batch_material(obj,mat_name,type){var scene_data=obj.scenes_data[0];var batches=scene_data.batches;for(var i=0;i<batches.length;i++)if(batches[i].type==type&&!batches[i].forked_batch&&batches[i].material_names.indexOf(mat_name)!=-1)return batches[i];return null}exports.find_batch_material_forked=find_batch_material_forked;function find_batch_material_forked(obj,mat_name,type){var scene_data=obj.scenes_data[0];var batches=
scene_data.batches;for(var i=0;i<batches.length;i++)if(batches[i].type==type&&batches[i].forked_batch&&batches[i].material_names.indexOf(mat_name)!=-1)return batches[i];return null}exports.set_material_props=set_material_props;function set_material_props(batch_to,batch_from){batch_to.diffuse_color.set(batch_from.diffuse_color);batch_to.diffuse_intensity=batch_from.diffuse_intensity;batch_to.specular_color.set(batch_from.specular_color);batch_to.specular_color_factor=batch_from.specular_color_factor;
batch_to.specular_params.set(batch_from.specular_params);batch_to.emit=batch_from.emit;batch_to.ambient=batch_from.ambient;batch_to.diffuse_color_factor=batch_from.diffuse_color_factor;batch_to.alpha_factor=batch_from.alpha_factor;batch_to.reflect_factor=batch_from.reflect_factor;batch_to.fresnel_params.set(batch_from.fresnel_params);batch_to.parallax_scale=batch_from.parallax_scale;batch_to.shallow_water_col.set(batch_from.shallow_water_col);batch_to.shallow_water_col_fac=batch_from.shallow_water_col_fac;
batch_to.shore_water_col.set(batch_from.shore_water_col);batch_to.shore_water_col_fac=batch_from.shore_water_col_fac;batch_to.foam_factor=batch_from.foam_factor;batch_to.water_norm_uv_velocity=batch_from.water_norm_uv_velocity}exports.check_batch_type=function(obj,type){var scene_data=obj.scenes_data[0];var batches=scene_data.batches;for(var i=0;i<batches.length;i++)if(batches[i].type==type)return true;return false};exports.clear_batch=function(batch){var textures=batch.textures;for(var i=0;i<textures.length;i++){var tex=
textures[i];m_textures.delete_texture(tex.w_texture)}m_geometry.cleanup_bufs_data(batch.bufs_data)};exports.inherit_material=function(obj_from,mat_from_name,obj_to,mat_to_name){var types=["MAIN","SHADOW","COLOR_ID"];var batches_found=false;for(var i=0;i<types.length;i++){var type=types[i];var batch_from=find_batch_material(obj_from,mat_from_name,type);var batch_to=find_batch_material(obj_to,mat_to_name,type);if(batch_from&&batch_to){batches_found=true;var child_batch=find_batch_material_forked(obj_to,
mat_to_name,type);if(type=="MAIN"){set_material_props(batch_to,batch_from);if(child_batch)set_material_props(child_batch,batch_from)}for(var j=0;j<batch_to.texture_names.length;j++){var to_name=batch_to.texture_names[j];if(BATCH_INHERITED_TEXTURES.indexOf(to_name)!==-1){var from_index=batch_from.texture_names.indexOf(to_name);if(from_index!==-1){batch_to.textures[j]=batch_from.textures[from_index];if(child_batch){var child_index=child_batch.texture_names.indexOf(to_name);if(child_index!==-1)child_batch.textures[child_index]=
batch_from.textures[from_index]}}}}}}if(!batches_found)m_print.error("Wrong objects for inheriting material!")};exports.set_nodemat_value=function(obj,name_list,value){var mat_name=name_list[0];var batch_main=find_batch_material(obj,mat_name,"MAIN");if(batch_main===null){m_print.error('Material "'+mat_name+'" was not found in the object "'+obj.name+'".');return}var node_id=name_list.join("%join%");var ind=get_value_node_ind_by_id(batch_main,node_id);if(ind!==null)for(var i=0;i<obj.scenes_data.length;i++){var batches=
obj.scenes_data[i].batches;for(var j=0;j<batches.length;j++){var batch=batches[j];if(batch.material_names.indexOf(mat_name)==-1||!batch.node_values)continue;batch.node_values[ind]=value}}else m_print.error('Value node "'+node_id+'" was not found in the object "'+obj.name+'".')};exports.set_nodemat_rgb=function(obj,name_list,r,g,b){var mat_name=name_list[0];var node_id=name_list.join("%join%");var batch_main=find_batch_material(obj,mat_name,"MAIN");var ind=get_rgb_node_ind_by_id(batch_main,node_id);
if(ind!=null)for(var i=0;i<obj.scenes_data.length;i++){var batches=obj.scenes_data[i].batches;for(var j=0;j<batches.length;j++){var batch=batches[j];if(batch.material_names.indexOf(mat_name)==-1||!batch.node_rgbs)continue;batch.node_rgbs[3*ind]=r;batch.node_rgbs[3*ind+1]=g;batch.node_rgbs[3*ind+2]=b}}else m_print.error('RGB node "'+node_id+'" was not found in the object "'+obj.name+'".')};exports.get_nodemat_value=function(obj,name_list){var mat_name=name_list[0];var node_id=name_list.join("%join%");
var batch_main=find_batch_material(obj,mat_name,"MAIN");var ind=get_value_node_ind_by_id(batch_main,node_id);if(ind!=null)return batch_main.node_values[ind];else m_print.error('Value node "'+node_id+'" was not found in the object "'+obj.name+'".');return null};exports.get_nodemat_rgb=function(obj,name_list,dest){var mat_name=name_list[0];var node_id=name_list.join("%join%");var batch_main=find_batch_material(obj,mat_name,"MAIN");var ind=get_rgb_node_ind_by_id(batch_main,node_id);if(ind!=null){dest[0]=
batch_main.node_rgbs[3*ind];dest[1]=batch_main.node_rgbs[3*ind+1];dest[2]=batch_main.node_rgbs[3*ind+2];return dest}else m_print.error('RGB node "'+node_id+'" was not found in the object "'+obj.name+'".');return null};function get_value_node_ind_by_id(batch,id){var value_inds=batch.node_value_inds;for(var i=0;i<value_inds.length;i+=2)if(value_inds[i]==id)return value_inds[i+1];return null}function get_rgb_node_ind_by_id(batch,id){var rgb_inds=batch.node_rgb_inds;for(var i=0;i<rgb_inds.length;i+=2)if(rgb_inds[i]==
id)return rgb_inds[i+1];return null}};b4w.module["__nodemat"]=function(exports,require){var m_cfg=require("__config");var m_debug=require("__debug");var m_graph=require("__graph");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_obj=require("__objects");var m_print=require("__print");var m_shaders=require("__shaders");var m_scenes=require("__scenes");var m_util=require("__util");var m_vec3=require("__vec3");var m_tex=require("__textures");var _shader_ident_counters={};var _composed_node_graphs={};var _composed_stack_graphs=
{};var _lamp_indexes={};var _lamp_index=0;var _material_index=0;var _vec4_tmp=new Float32Array(4);var cfg_def=m_cfg.defaults;var DEBUG_NODE_GRAPHS=false;var VECTOR_VALUE=0;var SCALAR_VALUE=1;var CURVE_POINT_EPS=.01;var VT_POINT=0;var VT_VECTOR=1;var VT_NORMAL=2;var VT_WORLD_TO_WORLD=0;var VT_WORLD_TO_OBJECT=1;var VT_WORLD_TO_CAMERA=2;var VT_OBJECT_TO_WORLD=3;var VT_OBJECT_TO_OBJECT=4;var VT_OBJECT_TO_CAMERA=5;var VT_CAMERA_TO_WORLD=6;var VT_CAMERA_TO_OBJECT=7;var VT_CAMERA_TO_CAMERA=8;exports.VT_WORLD_TO_WORLD=
VT_WORLD_TO_WORLD;exports.VT_WORLD_TO_OBJECT=VT_WORLD_TO_OBJECT;exports.VT_WORLD_TO_CAMERA=VT_WORLD_TO_CAMERA;exports.VT_OBJECT_TO_WORLD=VT_OBJECT_TO_WORLD;exports.VT_OBJECT_TO_OBJECT=VT_OBJECT_TO_OBJECT;exports.VT_OBJECT_TO_CAMERA=VT_OBJECT_TO_CAMERA;exports.VT_CAMERA_TO_WORLD=VT_CAMERA_TO_WORLD;exports.VT_CAMERA_TO_OBJECT=VT_CAMERA_TO_OBJECT;exports.VT_CAMERA_TO_CAMERA=VT_CAMERA_TO_CAMERA;exports.compose_nmat_graph=compose_nmat_graph;function compose_nmat_graph(node_tree,source_id,is_node_group,
mat_name,shader_type){var active_scene=m_scenes.get_active();var ntree_graph_id=generate_graph_id(source_id,shader_type,active_scene["uuid"]);if(ntree_graph_id in _composed_node_graphs)return _composed_node_graphs[ntree_graph_id];if(shader_type!="SHADOW"&&shader_type!="COLOR_ID"){var graph=m_graph.create();var bpy_nodes=node_tree["nodes"];for(var i=0;i<bpy_nodes.length;i++){var bpy_node=bpy_nodes[i];if(append_nmat_node(graph,bpy_node,0,mat_name,shader_type)==null){_composed_node_graphs[ntree_graph_id]=
null;return null}}if(is_node_group)if(find_node_id(node_tree,graph,"GROUP_OUTPUT","group")==-1)return null;var node_groups=trace_group_nodes(graph);var links=is_node_group?node_tree["links"]:node_tree["links"].slice();if(!append_node_groups_graphs(graph,links,node_groups))return null;if(is_node_group)return graph;for(var i=0;i<links.length;i++){var link=links[i];var node_ids1=nmat_node_ids(link["from_node"],graph);var node_ids2=nmat_node_ids(link["to_node"],graph);for(var j=0;j<node_ids1.length;j++)for(var k=
0;k<node_ids2.length;k++){var node_id1=node_ids1[j];var node_id2=node_ids2[k];var node_attr1=m_graph.get_node_attr(graph,node_id1);var node_attr2=m_graph.get_node_attr(graph,node_id2);if(!append_nmat_edge(graph,node_id1,node_id2,node_attr1,node_attr2,link)){_composed_node_graphs[ntree_graph_id]=null;return null}}}complete_edges(graph);if(shader_type=="GLOW")var output_id=find_node_id(node_tree,graph,"B4W_GLOW_OUTPUT","material",true);else var output_id=find_node_id(node_tree,graph,"OUTPUT","material",
false,true);if(output_id==-1){graph=create_default_graph();output_id=0}nmat_cleanup_graph(graph);var graph_out=m_graph.subgraph_node_conn(graph,output_id,m_graph.BACKWARD_DIR);split_material_nodes(graph_out,mat_name,shader_type);clean_sockets_linked_property(graph_out);merge_nodes(graph_out);optimize_geometry_vcol(graph_out);fix_socket_types(graph_out,mat_name,shader_type);create_node_textures(graph_out)}else{var main_graph=compose_nmat_graph(node_tree,source_id,is_node_group,mat_name,"MAIN");var nodes_cb=
function(node){var new_node=m_util.clone_object_nr(node);new_node.inputs=m_util.clone_object_r(node.inputs);new_node.outputs=m_util.clone_object_r(node.outputs);return new_node};var ntree_graph=m_graph.clone(main_graph,nodes_cb);var output_id=find_node_id(node_tree,ntree_graph,"OUTPUT","material",false,true);remove_color_output(ntree_graph,output_id);var graph_out=m_graph.subgraph_node_conn(ntree_graph,output_id,m_graph.BACKWARD_DIR);clean_sockets_linked_property(graph_out)}_composed_node_graphs[ntree_graph_id]=
graph_out;if(DEBUG_NODE_GRAPHS)print_node_graph(graph_out,mat_name);return graph_out}exports.create_lighting_graph=function(source_id,mat_name,data){var active_scene=m_scenes.get_active();var ntree_graph_id=generate_graph_id(source_id,"MAIN",active_scene["uuid"]);if(ntree_graph_id in _composed_stack_graphs)return _composed_stack_graphs[ntree_graph_id];var graph=m_graph.create();var bpy_node={"name":"LIGHTING_BEGIN","type":"LIGHTING_BEGIN"};var begin_node_id=append_nmat_node(graph,bpy_node,0,mat_name,
null);bpy_node={"name":"LIGHTING_END","type":"LIGHTING_END"};var end_node_id=append_nmat_node(graph,bpy_node,0,mat_name,null);var translucency_edges=[[begin_node_id,[8,10]],[begin_node_id,[9,6]]];add_lighting_subgraph(graph,data,begin_node_id,end_node_id,translucency_edges,mat_name);clean_sockets_linked_property(graph);_composed_stack_graphs[ntree_graph_id]=graph;return graph};function split_material_nodes(graph,mat_name,shader_type){var material_nodes=[];m_graph.traverse(graph,function(id,node){if(node.type==
"MATERIAL"||node.type=="MATERIAL_EXT"){var material={node_id:id,node:node};material_nodes.push(material)}});for(var i=0;i<material_nodes.length;++i){var node_id=material_nodes[i].node_id;var node=material_nodes[i].node;var material_begin_id=m_graph.gen_node_id(graph);m_graph.append_node(graph,material_begin_id,node.data.material_begin);var material_end_id=m_graph.gen_node_id(graph);m_graph.append_node(graph,material_end_id,node.data.material_end);m_graph.append_edge(graph,material_begin_id,material_end_id,
[4,2]);var material_socket_map={5:["LIGHTING_APPLY",10],6:["LIGHTING_APPLY",6],7:["MATERIAL_END",3],8:["MATERIAL_END",4],9:["MATERIAL_END",5]};var in_count=m_graph.in_edge_count(graph,node_id);var remove_edges_in=[];var append_edges_in=[];var translucency_edges=[];var edges_in_counter={};for(var k=0;k<in_count;k++){var in_id=m_graph.get_in_edge(graph,node_id,k);if(!(in_id in edges_in_counter))edges_in_counter[in_id]=0;var edge_attr=m_graph.get_edge_attr(graph,in_id,node_id,edges_in_counter[in_id]++);
remove_edges_in.push([in_id,node_id,edge_attr]);var dest=material_socket_map[edge_attr[1]];if(dest)switch(dest[0]){case "MATERIAL_END":append_edges_in.push([in_id,material_end_id,[edge_attr[0],dest[1]]]);break;case "LIGHTING_APPLY":translucency_edges.push([in_id,[edge_attr[0],dest[1]]]);break}else append_edges_in.push([in_id,material_begin_id,edge_attr])}add_lighting_subgraph(graph,node.data.value,material_begin_id,material_end_id,translucency_edges,mat_name);for(var k=0;k<remove_edges_in.length;k++)m_graph.remove_edge_by_attr(graph,
remove_edges_in[k][0],remove_edges_in[k][1],remove_edges_in[k][2]);for(var k=0;k<append_edges_in.length;k++)m_graph.append_edge(graph,append_edges_in[k][0],append_edges_in[k][1],append_edges_in[k][2]);var out_count=m_graph.out_edge_count(graph,node_id);var remove_out_edges=[];var append_out_edges=[];var edges_out_counter={};for(var k=0;k<out_count;k++){var out_id=m_graph.get_out_edge(graph,node_id,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,
node_id,out_id,edges_out_counter[out_id]++);remove_out_edges.push([node_id,out_id,edge_attr]);append_out_edges.push([material_end_id,out_id,edge_attr])}for(var k=0;k<remove_out_edges.length;k++)m_graph.remove_edge_by_attr(graph,remove_out_edges[k][0],remove_out_edges[k][1],remove_out_edges[k][2]);for(var k=0;k<append_out_edges.length;k++)m_graph.append_edge(graph,append_out_edges[k][0],append_out_edges[k][1],append_out_edges[k][2]);m_graph.remove_node(graph,node_id)}}function add_lighting_subgraph(graph,
data,begin_node_id,end_node_id,translucency_edges,mat_name){var bpy_node={"name":"LIGHTING_AMBIENT","type":"LIGHTING_AMBIENT"};var curr_node_id=append_nmat_node(graph,bpy_node,0,mat_name,null);var prev_node_id=curr_node_id;link_nlight_edge(graph,begin_node_id,curr_node_id,"E");link_nlight_edge(graph,begin_node_id,curr_node_id,"A");link_nlight_edge(graph,begin_node_id,curr_node_id,"D");var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);if(!data.use_shadeless){var lamp_node_id;
var lighting_apply_node_id;var shade_spec_node_id;var shade_dif_node_id;for(var i=0;i<lamps.length;i++){var light=lamps[i].light;bpy_node={"name":"LIGHTING_LAMP","type":"LIGHTING_LAMP"};lamp_node_id=append_nmat_node(graph,bpy_node,0,mat_name,null);bpy_node={"name":"LIGHTING_APPLY","type":"LIGHTING_APPLY"};lighting_apply_node_id=append_nmat_node(graph,bpy_node,0,mat_name,null);link_nlight_edge(graph,prev_node_id,lighting_apply_node_id,"color");link_nlight_edge(graph,prev_node_id,lighting_apply_node_id,
"specular");link_nlight_edge(graph,lamp_node_id,lighting_apply_node_id,"ldir");link_nlight_edge(graph,begin_node_id,lighting_apply_node_id,"normal");link_nlight_edge(graph,begin_node_id,lighting_apply_node_id,"D");link_nlight_edge(graph,begin_node_id,lighting_apply_node_id,"S");link_nlight_edge(graph,lamp_node_id,lighting_apply_node_id,"lcolorint");link_nlight_edge(graph,begin_node_id,lamp_node_id,"shadow_factor");if(data.specular_shader=="COOKTORR")var spec_name="SPECULAR_PHONG";else var spec_name=
"SPECULAR_"+data.specular_shader;bpy_node={"name":spec_name,"type":spec_name};shade_spec_node_id=append_nmat_node(graph,bpy_node,0,mat_name,null);link_nlight_edge(graph,lamp_node_id,shade_spec_node_id,"ldir");link_nlight_edge(graph,lamp_node_id,shade_spec_node_id,"lfac");link_nlight_edge(graph,begin_node_id,shade_spec_node_id,"normal");link_nlight_edge(graph,shade_spec_node_id,lighting_apply_node_id,"sfactor");if(spec_name=="SPECULAR_PHONG"||spec_name=="SPECULAR_BLINN"){link_nlight_edge(graph,lamp_node_id,
shade_spec_node_id,"norm_fac");link_nlight_edge(graph,begin_node_id,shade_spec_node_id,"sp_params")}else link_nlight_edge(graph,begin_node_id,shade_spec_node_id,"sp_params");if(light.type=="HEMI")var dif_name="DIFFUSE_LAMBERT";else var dif_name="DIFFUSE_"+data.diffuse_shader;bpy_node={"name":dif_name,"type":dif_name};shade_dif_node_id=append_nmat_node(graph,bpy_node,0,mat_name,null);link_nlight_edge(graph,lamp_node_id,shade_dif_node_id,"ldir");link_nlight_edge(graph,lamp_node_id,shade_dif_node_id,
"lfac");link_nlight_edge(graph,begin_node_id,shade_dif_node_id,"normal");link_nlight_edge(graph,lamp_node_id,shade_dif_node_id,"norm_fac");link_nlight_edge(graph,shade_dif_node_id,lighting_apply_node_id,"lfactor");if(dif_name!="DIFFUSE_LAMBERT")link_nlight_edge(graph,begin_node_id,shade_dif_node_id,"dif_params");for(var j=0;j<translucency_edges.length;j++){var in_node_id=translucency_edges[j][0];var edge_attr=translucency_edges[j][1];m_graph.append_edge(graph,in_node_id,lighting_apply_node_id,edge_attr)}prev_node_id=
lighting_apply_node_id}}link_nlight_edge(graph,prev_node_id,end_node_id,"color");link_nlight_edge(graph,prev_node_id,end_node_id,"specular")}function link_nlight_edge(graph,id1,id2,inout_name){var node1=m_graph.get_node_attr(graph,id1);var node2=m_graph.get_node_attr(graph,id2);var in2;for(var i=0;i<node2.inputs.length;i++){var input=node2.inputs[i];if(inout_name==input.identifier){in2=i;break}}var out1;for(var i=0;i<node1.outputs.length;i++){var output=node1.outputs[i];if(inout_name==output.identifier){out1=
i;break}}if(in2!=undefined&&out1!=undefined)m_graph.append_edge(graph,id1,id2,[out1,in2])}function generate_graph_id(graph_id,shader_type,scene_id){switch(shader_type){case "GLOW":return graph_id+scene_id+"11";case "COLOR_ID":case "SHADOW":return graph_id+scene_id+"00";default:return graph_id+scene_id+"10"}}function remove_color_output(graph,output_id){m_graph.traverse_edges(graph,function(id1,id2,attr){var out_node=m_graph.get_node_attr(graph,id2);if(id2==output_id&&out_node.inputs[attr[1]].identifier==
"Color")m_graph.remove_edge_by_attr(graph,id1,id2,attr)})}function create_default_graph(){var graph=m_graph.create();var input_color={default_value:new Float32Array([0,0,0]),identifier:"Color",is_linked:false,name:"Color"};var input_alpha={default_value:1,identifier:"Alpha",is_linked:false,name:"Alpha"};var node={data:null,dirs:[],params:[],inputs:[input_color,input_alpha],outputs:[],type:"OUTPUT",vparams:[]};m_graph.append_node(graph,0,node);return graph}function clean_sockets_linked_property(graph){m_graph.traverse(graph,
function(id,node){var inputs=node.inputs;var outputs=node.outputs;for(var i=0;i<inputs.length;i++)fix_socket_property(graph,inputs[i],id,i,1);for(var i=0;i<outputs.length;i++)fix_socket_property(graph,outputs[i],id,i,0)})}function fix_socket_property(graph,connection,id,num,check_in_edge){if(connection.is_linked){var clear_linked=true;m_graph.traverse_edges(graph,function(in_edge,out_edge,sockets){if(!check_in_edge&&in_edge==id&&sockets[0]==num||check_in_edge&&out_edge==id&&sockets[1]==num)clear_linked=
false});if(clear_linked)connection.is_linked=false}}function fix_socket_types(graph,mat_name,shader_type){var edge_data=[];m_graph.traverse_edges(graph,function(in_edge,out_edge,sockets){var in_node=m_graph.get_node_attr(graph,in_edge);var out_node=m_graph.get_node_attr(graph,out_edge);var is_output_vec=m_util.is_vector(in_node.outputs[sockets[0]].default_value);var is_input_vec=m_util.is_vector(out_node.inputs[sockets[1]].default_value);if(is_output_vec!=is_input_vec){var trans_node;var vector={"default_value":[0,
0,0],"identifier":"Vector","is_linked":true,"name":"Vector"};var value={"default_value":0,"identifier":"Value","is_linked":true,"name":"Value"};if(is_output_vec&&!is_input_vec)trans_node=init_bpy_node("vector_to_scalar","B4W_VECTOSCAL",[vector],[value]);else if(!is_output_vec&&is_input_vec)trans_node=init_bpy_node("scalar_to_vector","B4W_SCALTOVEC",[value],[vector]);append_nmat_node(graph,trans_node,0,mat_name,shader_type);edge_data.push([in_edge,out_edge,graph.nodes[graph.nodes.length-2],sockets])}});
for(var i=0;i<edge_data.length;++i){m_graph.remove_edge_by_attr(graph,edge_data[i][0],edge_data[i][1],edge_data[i][3]);m_graph.append_edge(graph,edge_data[i][0],edge_data[i][2],[edge_data[i][3][0],0]);m_graph.append_edge(graph,edge_data[i][2],edge_data[i][1],[0,edge_data[i][3][1]])}}function complete_edges(graph){var appended_edges=[];m_graph.traverse(graph,function(id,attr){switch(attr.type){case "B4W_TRANSLUCENCY":m_graph.traverse_edges(graph,function(edge_from,edge_to,edge_attr){if(edge_from==
id){var from_socket_index=edge_attr[0];if(attr.outputs[from_socket_index].name=="Translucency")appended_edges.push(edge_from,edge_to,[edge_attr[0]+1,edge_attr[1]+1])}});break}});for(var i=0;i<appended_edges.length;i+=3)m_graph.append_edge(graph,appended_edges[i],appended_edges[i+1],appended_edges[i+2])}function nmat_node_ids(bpy_node,graph){var node_ids=[];m_graph.traverse(graph,function(id,attr){if(attr.name==bpy_node["name"])node_ids.push(id)});if(node_ids.length)return node_ids;else throw"Node not found";
}function nmat_cleanup_graph(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="B4W_PARALLAX"||attr.type=="REROUTE")id_attr.push(id,attr)});for(var i=0;i<id_attr.length;i+=2){var id=id_attr[i];var attr=id_attr[i+1];if(attr.type=="B4W_PARALLAX"){var input_id1=get_in_edge_by_input_num(graph,id,1);if(input_id1!=-1){var input_input_id=m_graph.get_in_edge(graph,input_id1,0);m_graph.remove_edge(graph,input_id1,id,-1);if(input_input_id!=-1)m_graph.remove_edge(graph,input_input_id,
input_id1,-1);var input1_attr=m_graph.get_node_attr(graph,input_id1);attr.data=input1_attr.data;attr.params[0]=input1_attr.params[0];m_graph.remove_node(graph,input_id1)}attr.inputs.splice(1,1)}else if(attr.type=="REROUTE"){var input_id=m_graph.get_in_edge(graph,id,0);var out_edge_count=m_graph.out_edge_count(graph,id);var removed_edges=[];var output_ids=[];var edges_quantity=[];for(var j=0;j<out_edge_count;j++){var output_id=m_graph.get_out_edge(graph,id,j);var id_place=output_ids.indexOf(output_id);
if(id_place!=-1)edges_quantity[id_place]+=1;else{output_ids.push(output_id);edges_quantity.push(1);removed_edges.push(id,output_id)}}if(input_id!=-1){var from_index=m_graph.get_edge_attr(graph,input_id,id,0)[0];for(var j=0;j<output_ids.length;j++)for(var k=0;k<edges_quantity[j];k++){var to_index=m_graph.get_edge_attr(graph,id,output_ids[j],k)[1];m_graph.append_edge(graph,input_id,output_ids[j],[from_index,to_index])}}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],
removed_edges[j+1],-1)}}}function get_in_edge_by_input_num(graph,node,input_num){var edges=graph.edges;for(var i=0;i<edges.length;i+=3)if(edges[i+1]==node){var num=edges[i+2][1];if(num==input_num)return edges[i]}return-1}function merge_nodes(graph){merge_geometry(graph);merge_textures(graph);merge_uvs(graph)}function merge_uvs(graph,shader_type){var id_attr=[];var uv_0="";var uv_1="";var uv_counter={};m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_UV"||attr.type=="UVMAP"||attr.type==
"TEX_COORD_UV"){id_attr.push(id,attr);var curr_uv_layer=attr.data.value;if(!uv_0){uv_0=curr_uv_layer;uv_counter[uv_0]=0}else if(uv_0!=curr_uv_layer&&!uv_1){uv_1=curr_uv_layer;uv_counter[uv_1]=0}uv_counter[curr_uv_layer]++}});for(var curr_uv_layer in uv_counter)if(uv_counter[curr_uv_layer]<2){for(var i=0;i<id_attr.length;i=i+2)if(id_attr[i+1].data.value==curr_uv_layer)id_attr.splice(i,2);delete uv_counter[curr_uv_layer];if(uv_0==curr_uv_layer){uv_0=uv_1;uv_1=""}if(uv_1==curr_uv_layer)uv_1=""}if(id_attr.length<
3)return;var node_name="";var UV_geom={"default_value":[0,0,0],"identifier":"UV_geom","is_linked":false,"name":"UV_geom"};var UV_cycles={"default_value":[0,0,0],"identifier":"UV_cycles","is_linked":false,"name":"UV_cycles"};var uv_0_node=init_bpy_node("merged_uv","UV_MERGED",[],[UV_geom,UV_cycles]);uv_0_node["uv_layer"]=uv_0;append_nmat_node(graph,uv_0_node,0,"",shader_type);var uv_0_node_id=graph.nodes[graph.nodes.length-2];uv_0_node=graph.nodes[graph.nodes.length-1];if(uv_1){var uv_1_node=init_bpy_node("merged_uv",
"UV_MERGED",[],[UV_geom,UV_cycles]);uv_1_node["uv_layer"]=uv_1;append_nmat_node(graph,uv_1_node,0,"",shader_type);var uv_1_node_id=graph.nodes[graph.nodes.length-2];uv_1_node=graph.nodes[graph.nodes.length-1]}else var uv_1_node=null;var unode_id=-1;var unode=null;for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];if(can_merge_nodes_uv(attr_current,id_attr[1])){unode_id=uv_0_node_id;unode=uv_0_node}else if(uv_1_node){unode_id=uv_1_node_id;unode=uv_1_node}var removed_edges=
[];var out_num=m_graph.out_edge_count(graph,id_current);var edges_out_counter={};for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,id_current,out_id,edges_out_counter[out_id]++);removed_edges.push(id_current,out_id,edge_attr);var new_edge_attr=edge_attr.splice(0,edge_attr.length);switch(attr_current.type){case "GEOMETRY_UV":new_edge_attr[0]=0;unode.outputs[0].is_linked=
true;break;case "UVMAP":case "TEX_COORD_UV":new_edge_attr[0]=1;unode.outputs[1].is_linked=true;break}m_graph.append_edge(graph,unode_id,out_id,new_edge_attr)}for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,id_current)}}function merge_geometry(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_VC"||attr.type=="GEOMETRY_NO"||attr.type=="GEOMETRY_FB"||attr.type=="GEOMETRY_VW"||attr.type==
"GEOMETRY_GL"||attr.type=="GEOMETRY_LO"||attr.type=="GEOMETRY_OR")id_attr.push(id,attr)});var unique_nodes=[];for(var i=0;i<id_attr.length;i+=2){var id_current=id_attr[i];var attr_current=id_attr[i+1];var is_unique=true;for(var j=0;j<unique_nodes.length;j++){var unode=unique_nodes[j];if(can_merge_nodes(attr_current,unode.attr)){var removed_edges=[];var out_num=m_graph.out_edge_count(graph,id_current);for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);var edge_attr=m_graph.get_edge_attr(graph,
id_current,out_id,0);removed_edges.push(id_current,out_id,edge_attr);m_graph.append_edge(graph,unode.id,out_id,edge_attr)}for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,id_current);is_unique=false;break}}if(is_unique){var unode={id:id_current,attr:attr_current};unique_nodes.push(unode)}}}function get_attrs_ascendants(graph){var attrs_ascendants={};for(var i=0;i<graph.nodes.length;i+=2){var id=graph.nodes[i];attrs_ascendants[id]=
[]}for(var i=0;i<graph.edges.length;i+=3){var id_from=graph.edges[i];var id_to=graph.edges[i+1];insert_id_ascendant_lists(attrs_ascendants[id_to],id_from);merge_ascendant_lists(attrs_ascendants[id_to],attrs_ascendants[id_from])}return attrs_ascendants}function insert_id_ascendant_lists(list,id){for(var i=0;i<=list.length;i++){if(i>=list.length||list[i]>id)list.splice(i,0,id);else if(list[i]!=id)continue;return}}function merge_ascendant_lists(list1,list2){var index1=0;var index2=0;var result_length=
list1.length+list2.length;var result_list=[];for(var i=0;i<result_length;i++)if(index1>list1.length||list1[index1]>list2[index2])result_list.push(list2[index2++]);else result_list.push(list1[index1++]);list1=result_list}function merge_textures(graph){var id_attr=[];m_graph.traverse(graph,function(id,attr){if(attr.type=="TEXTURE_COLOR"||attr.type=="TEXTURE_NORMAL")id_attr.push(id,attr)});if(!id_attr.length)return;var ascs=get_attrs_ascendants(graph);var unique_nodes=[];for(var i=0;i<id_attr.length;i+=
2){var id_current=id_attr[i];var attr_current=id_attr[i+1];var is_unique=true;for(var j=0;j<unique_nodes.length;j++){var unode=unique_nodes[j];if(unode.merged_nodes.length>=3)continue;if(!can_merge_nodes(attr_current,unode.attr))continue;if(ascs[id_current].indexOf(unode.id)>-1||ascs[unode.id].indexOf(id_current)>-1)continue;var is_reachable=false;for(var k=0;k<unode.merged_nodes.length;k++){var merged_id=unode.merged_nodes[k].id;if(ascs[id_current].indexOf(merged_id)>-1||ascs[merged_id].indexOf(id_current)>
-1){is_reachable=true;break}}if(is_reachable)continue;var removed_edges_in=[];var in_num=m_graph.in_edge_count(graph,id_current);var edges_in_counter={};for(k=0;k<in_num;k++){var in_id=m_graph.get_in_edge(graph,id_current,k);if(!(in_id in edges_in_counter))edges_in_counter[in_id]=0;var edge_attr=m_graph.get_edge_attr(graph,in_id,id_current,edges_in_counter[in_id]++);removed_edges_in.push(in_id,id_current,edge_attr)}var removed_edges_out=[];var out_num=m_graph.out_edge_count(graph,id_current);var edges_out_counter=
{};for(k=0;k<out_num;k++){var out_id=m_graph.get_out_edge(graph,id_current,k);if(!(out_id in edges_out_counter))edges_out_counter[out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,id_current,out_id,edges_out_counter[out_id]++);removed_edges_out.push(id_current,out_id,edge_attr)}var removed_edges=removed_edges_in.concat(removed_edges_out);for(var k=0;k<removed_edges.length;k+=3)m_graph.remove_edge(graph,removed_edges[k],removed_edges[k+1],0);m_graph.remove_node(graph,id_current);var mnode={id:id_current,
attr:attr_current,edges_in:removed_edges_in,edges_out:removed_edges_out};unode.merged_nodes.push(mnode);is_unique=false;break}if(is_unique){var unode={id:id_current,attr:attr_current,merged_nodes:[]};unique_nodes.push(unode)}}for(var i=0;i<unique_nodes.length;i++){var unode=unique_nodes[i];var mnodes_count=unode.merged_nodes.length;for(var j=0;j<mnodes_count;j++){var merged_data=unode.merged_nodes[j];var mnode=merged_data.attr;var edges_in=merged_data.edges_in;var edges_out=merged_data.edges_out;
unode.attr.inputs[j+1].is_linked=mnode.inputs[0].is_linked;unode.attr.inputs[j+1].default_value=mnode.inputs[0].default_value;unode.attr.outputs[2*(j+1)].is_linked=mnode.outputs[0].is_linked;unode.attr.outputs[2*(j+1)].default_value=mnode.outputs[0].default_value;unode.attr.outputs[2*(j+1)+1].is_linked=mnode.outputs[1].is_linked;unode.attr.outputs[2*(j+1)+1].default_value=mnode.outputs[1].default_value;for(var k=0;k<edges_in.length;k+=3){var in_id=edges_in[k];var edge_attr=edges_in[k+2];edge_attr[1]+=
j+1;m_graph.append_edge(graph,in_id,unode.id,edge_attr)}for(var k=0;k<edges_out.length;k+=3){var out_id=edges_out[k+1];var edge_attr=edges_out[k+2];edge_attr[0]+=(j+1)*2;m_graph.append_edge(graph,unode.id,out_id,edge_attr)}unode.attr.dirs.push(["USE_uv"+(j+2),1])}m_graph.remove_node(graph,unode.id);m_graph.append_node(graph,unode.id,unode.attr)}}function can_merge_nodes(attr1,attr2){if(attr1.type!==attr2.type)return false;switch(attr1.type){case "GEOMETRY_VC":return attr1.data.value==attr2.data.value;
case "GEOMETRY_NO":case "GEOMETRY_FB":case "GEOMETRY_VW":case "GEOMETRY_GL":case "GEOMETRY_LO":case "GEOMETRY_OR":return true;case "TEXTURE_COLOR":case "TEXTURE_NORMAL":return attr1.data.value["uuid"]==attr2.data.value["uuid"];default:return false}}function can_merge_nodes_uv(attr1,attr2){var permissible_types=["GEOMETRY_UV","TEX_COORD_UV","UVMAP"];if(permissible_types.indexOf(attr1.type)!=-1&&permissible_types.indexOf(attr2.type)!=-1)return attr1.data.value==attr2.data.value;return false}function optimize_geometry_vcol(graph){var id_attr=
[];m_graph.traverse(graph,function(id,attr){if(attr.type=="GEOMETRY_VC")id_attr.push(id,attr)});for(var i=0;i<id_attr.length;i+=2){var geom_id=id_attr[i];var geom_attr=id_attr[i+1];var need_optimize=false;var removed_edges=[];var removed_seprgb_nodes=[];var channels_usage=[[],[],[]];var geometry_out_num=m_graph.out_edge_count(graph,geom_id);for(var j=0;j<geometry_out_num;j++){var out_id=m_graph.get_out_edge(graph,geom_id,j);var out_node=m_graph.get_node_attr(graph,out_id);if(out_node.type!="SEPRGB"){need_optimize=
false;break}removed_edges.push(geom_id,out_id);var edges_out_num={};var seprgb_out_num=m_graph.out_edge_count(graph,out_id);for(var k=0;k<seprgb_out_num;k++){var seprgb_out_id=m_graph.get_out_edge(graph,out_id,k);if(!(seprgb_out_id in edges_out_num))edges_out_num[seprgb_out_id]=0;var edge_attr=m_graph.get_edge_attr(graph,out_id,seprgb_out_id,edges_out_num[seprgb_out_id]++);removed_edges.push(out_id,seprgb_out_id);channels_usage[edge_attr[0]].push(geom_id,seprgb_out_id,edge_attr)}removed_seprgb_nodes.push(out_id);
need_optimize=true}if(need_optimize){var channels_count=0;var mask=0;for(var j=0;j<channels_usage.length;j++)if(channels_usage[j].length){channels_count++;mask|=1<<2-j}if(channels_count){geom_attr.type+=channels_count;geom_attr.outputs=[];for(var j=0;j<channels_usage.length;j++)if(channels_usage[j].length){geom_attr.outputs.push({default_value:0,identifier:"RGB"[j],is_linked:true,name:"RGB"[j]});for(var k=0;k<channels_usage[j].length;k+=3)channels_usage[j][k+2][0]=m_util.rgb_mask_get_channel_presence_index(mask,
j)}for(var j=0;j<removed_edges.length;j+=2)m_graph.remove_edge(graph,removed_edges[j],removed_edges[j+1],0);for(var j=0;j<removed_seprgb_nodes.length;j++)m_graph.remove_node(graph,removed_seprgb_nodes[j]);for(var j=0;j<channels_usage.length;j++)for(var k=0;k<channels_usage[j].length;k+=3)m_graph.append_edge(graph,channels_usage[j][k],channels_usage[j][k+1],channels_usage[j][k+2])}}}}function find_node_id(node_tree,graph,type,source_type,is_group_node,suppress_errors){var bpy_nodes=node_tree["nodes"];
var last_output_node=null;for(var i=0;i<bpy_nodes.length;i++){var bpy_node=bpy_nodes[i];if(is_group_node){if(bpy_node["type"]=="GROUP"&&bpy_node["node_tree_name"]==type)last_output_node=bpy_node}else if(bpy_node["type"]==type)last_output_node=bpy_node}if(!last_output_node){if(!suppress_errors)m_print.error('No "'+type+'" node in node '+source_type);return-1}return nmat_node_ids(last_output_node,graph)[0]}function init_bpy_node(name,type,inputs,outputs){var node={"name":name,"type":type,"inputs":inputs,
"outputs":outputs};return node}function init_bpy_link(from_node,from_socket,to_node,to_socket){var link={"from_node":from_node,"from_socket":from_socket,"to_node":to_node,"to_socket":to_socket};return link}function append_nmat_node(graph,bpy_node,output_num,mat_name,shader_type){var name=bpy_node["name"];var type=bpy_node["type"];var vparams=[];var inputs=[];var outputs=[];var params=[];var data=null;var dirs=[];switch(type){case "BSDF_ANISOTROPIC":case "BSDF_DIFFUSE":case "BSDF_GLOSSY":case "BSDF_GLASS":case "BSDF_HAIR":case "BSDF_TRANSPARENT":case "BSDF_TRANSLUCENT":case "BSDF_REFRACTION":case "BSDF_TOON":case "BSDF_VELVET":case "SUBSURFACE_SCATTERING":case "EMISSION":case "AMBIENT_OCCLUSION":case "VOLUME_ABSORPTION":case "VOLUME_SCATTER":case "BUMP":case "NORMAL_MAP":case "BLACKBODY":case "WAVELENGTH":case "SEPXYZ":case "COMBXYZ":case "LIGHT_FALLOFF":case "TEX_IMAGE":case "TEX_ENVIRONMENT":case "TEX_SKY":case "TEX_NOISE":case "TEX_WAVE":case "TEX_MUSGRAVE":case "TEX_GRADIENT":case "TEX_MAGIC":case "TEX_CHECKER":case "TEX_BRICK":case "WIREFRAME":case "LAYER_WEIGHT":case "TANGENT":case "LIGHT_PATH":case "ATTRIBUTE":case "HOLDOUT":case "HAIR_INFO":case "OBJECT_INFO":case "SCRIPT":case "NEW_GEOMETRY":inputs=
node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);m_print.warn(type+" node is not fully supported.");break;case "BRIGHTCONTRAST":case "ADD_SHADER":case "MIX_SHADER":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "UVMAP":var uv_layer=bpy_node["uv_layer"];if(!uv_layer)type="EMPTY_UV";if(type!="EMPTY_UV"){var uv_name=shader_ident("param_"+type+"_a");var uv_tra_name=shader_ident("param_"+type+"_v");vparams.push(node_param(uv_name));
vparams.push(node_param(uv_tra_name));params.push(node_param(uv_tra_name));data={name:uv_name,value:uv_layer}}outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "UV_MERGED":var uv_name=shader_ident("param_UV_MERGED_a");var uv_tra_name=shader_ident("param_UV_MERGED_v");vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));outputs.push(node_output_by_ident(bpy_node,"UV_geom"));outputs.push(node_output_by_ident(bpy_node,"UV_cycles"));params.push(node_param(uv_tra_name));data={name:uv_name,
value:bpy_node["uv_layer"]};break;case "CAMERA":inputs=[];outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "COMBRGB":case "COMBHSV":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "CURVE_RGB":case "CURVE_VEC":if(type=="CURVE_RGB"){if(check_curve_usage(bpy_node,0,0,1))dirs.push(["READ_R",1]);if(check_curve_usage(bpy_node,1,0,1))dirs.push(["READ_G",1]);if(check_curve_usage(bpy_node,2,0,1))dirs.push(["READ_B",1]);if(check_curve_usage(bpy_node,3,0,1))dirs.push(["READ_A",
1])}else{if(check_curve_usage(bpy_node,0,-1,1))dirs.push(["READ_R",1]);if(check_curve_usage(bpy_node,1,-1,1))dirs.push(["READ_G",1]);if(check_curve_usage(bpy_node,2,-1,1))dirs.push(["READ_B",1])}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);data={value:bpy_node};break;case "PARTICLE_INFO":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);for(var k=0;k<bpy_node["outputs"].length;k++){var output=bpy_node["outputs"][k];var identifier=
output["identifier"];var v_name=node_param("v_param_PART_INFO_"+identifier.replace(" ",""));if(output["is_linked"])switch(identifier){case "Size":dirs.push(["PART_INFO_SIZE",m_shaders.glsl_value(1)]);break;case "Age":dirs.push(["PART_INFO_AGE",m_shaders.glsl_value(1)]);break;case "Lifetime":dirs.push(["PART_INFO_LT",m_shaders.glsl_value(1)]);break;case "Location":dirs.push(["PART_INFO_LOC",m_shaders.glsl_value(1)]);break;case "Index":var a_name=node_param("a_param_PART_INFO_"+output.identifier.replace(" ",
""));data=a_name;dirs.push(["PART_INFO_IND",m_shaders.glsl_value(1)]);break;case "Velocity":dirs.push(["PART_INFO_VEL",m_shaders.glsl_value(1)]);break;case "Angular Velocity":dirs.push(["PART_INFO_A_VEL",m_shaders.glsl_value(1)]);break}if(identifier!="Age"&&identifier!="Lifetime"&&identifier!="Size"){vparams.push(v_name);params.push(v_name)}}if(a_name)vparams.push(a_name);break;case "GEOMETRY":if(!check_input_node_outputs(bpy_node))return true;type=geometry_node_type(bpy_node,output_num);if(!type){m_print.error("Geometry output is not supported");
return null}switch(type){case "GEOMETRY_UV":var curr_uv_layer=bpy_node["uv_layer"];if(!curr_uv_layer)type="EMPTY_UV";if(type!="EMPTY_UV"){var uv_name=shader_ident("param_GEOMETRY_UV_a");var uv_tra_name=shader_ident("param_GEOMETRY_UV_v");vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));params.push(node_param(uv_tra_name));data={name:uv_name,value:curr_uv_layer}}outputs.push(node_output_by_ident(bpy_node,"UV"));break;case "GEOMETRY_VC":var curr_color_layer=bpy_node["color_layer"];
if(!curr_color_layer)type="EMPTY_VC";if(type!="EMPTY_VC"){var vc_name=shader_ident("param_GEOMETRY_VC_a");var vc_tra_name=shader_ident("param_GEOMETRY_VC_v");vparams.push(node_param(vc_name));vparams.push(node_param(vc_tra_name));params.push(node_param(vc_tra_name));data={name:vc_name,value:curr_color_layer}}outputs.push(node_output_by_ident(bpy_node,"Vertex Color"));break;case "GEOMETRY_NO":outputs.push(node_output_by_ident(bpy_node,"Normal"));break;case "GEOMETRY_FB":outputs.push(node_output_by_ident(bpy_node,
"Front/Back"));break;case "GEOMETRY_VW":outputs.push(node_output_by_ident(bpy_node,"View"));break;case "GEOMETRY_GL":outputs.push(node_output_by_ident(bpy_node,"Global"));break;case "GEOMETRY_LO":outputs.push(node_output_by_ident(bpy_node,"Local"));break;case "GEOMETRY_OR":var or_tra_name=shader_ident("param_GEOMETRY_OR_v");vparams.push(node_param(or_tra_name));outputs.push(node_output_by_ident(bpy_node,"Orco"));params.push(node_param(or_tra_name));break}break;case "TEX_COORD":if(!check_input_node_outputs(bpy_node))return true;
type=tex_coord_node_type(bpy_node,output_num);if(!type){m_print.error("Texture coordinate output is not supported");return null}switch(type){case "TEX_COORD_UV":var uv_layer=bpy_node["uv_layer"];if(!uv_layer)type="EMPTY_UV";if(type!="EMPTY_UV"){var uv_name=shader_ident("param_TEX_COORD_UV_a");var uv_tra_name=shader_ident("param_TEX_COORD_UV_v");vparams.push(node_param(uv_name));vparams.push(node_param(uv_tra_name));params.push(node_param(uv_tra_name));data={name:uv_name,value:bpy_node["uv_layer"]}}outputs.push(node_output_by_ident(bpy_node,
"UV"));break;case "TEX_COORD_NO":outputs.push(node_output_by_ident(bpy_node,"Normal"));break;case "TEX_COORD_GE":var ge_tra_name=shader_ident("param_TEX_COORD_GE_v");vparams.push(node_param(ge_tra_name));outputs.push(node_output_by_ident(bpy_node,"Generated"));params.push(node_param(ge_tra_name));break;case "TEX_COORD_OB":outputs.push(node_output_by_ident(bpy_node,"Object"));m_print.warn('Output "Object" of node "Texture Coordinate" doesn\'t supported fully.');break;case "TEX_COORD_CA":outputs.push(node_output_by_ident(bpy_node,
"Camera"));break;case "TEX_COORD_WI":outputs.push(node_output_by_ident(bpy_node,"Window"));m_print.warn('Output "Window" of node "Texture Coordinate" doesn\'t supported fully.');break;case "TEX_COORD_RE":outputs.push(node_output_by_ident(bpy_node,"Reflection"));m_print.warn('Output "Reflection" of node "Texture Coordinate" doesn\'t supported fully.');break}break;case "GROUP":var node_name=bpy_node["node_tree_name"];switch(node_name){case "B4W_LINEAR_TO_SRGB":if(!validate_custom_node_group(bpy_node,
[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_LINEAR_TO_SRGB";break;case "B4W_NORMAL_VIEW":case "B4W_VECTOR_VIEW":if(!validate_custom_node_group(bpy_node,[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_VECTOR_VIEW";break;case "B4W_SRGB_TO_LINEAR":if(!validate_custom_node_group(bpy_node,[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_SRGB_TO_LINEAR";break;case "B4W_REFLECT":if(!validate_custom_node_group(bpy_node,
[1,1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_REFLECT";break;case "B4W_REFRACTION":if(!validate_custom_node_group(bpy_node,[1,0],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_REFRACTION";break;case "B4W_PARALLAX":if(!validate_custom_node_group(bpy_node,[1,1,0,0,0],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_PARALLAX";var tex_name=shader_ident("temp_texture");params.push(node_param(tex_name));break;
case "B4W_CLAMP":if(!validate_custom_node_group(bpy_node,[1],[1])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_CLAMP";break;case "B4W_TRANSLUCENCY":if(!validate_custom_node_group(bpy_node,[0,0,0,0,0],[0])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_TRANSLUCENCY";break;case "B4W_TIME":if(!validate_custom_node_group(bpy_node,[],[0])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_TIME";break;case "B4W_SMOOTHSTEP":if(!validate_custom_node_group(bpy_node,
[0,0,0],[0])){data=process_node_group(bpy_node,mat_name,shader_type);break}type="B4W_SMOOTHSTEP";break;case "B4W_GLOW_OUTPUT":type="B4W_GLOW_OUTPUT";break;default:data=process_node_group(bpy_node,mat_name,shader_type)}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);if(node_name=="B4W_TRANSLUCENCY"){var out=default_node_inout("TranslucencyParams","TranslucencyParams",[0,0,0,0]);out.is_linked=outputs[0].is_linked;outputs.push(out)}break;case "LAMP":var bpy_lamp=bpy_node["lamp"];
if(!bpy_lamp){m_print.error("There is no lamp in node: "+bpy_node["name"]);return null}outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Light Vector"));outputs.push(node_output_by_ident(bpy_node,"Distance"));outputs.push(node_output_by_ident(bpy_node,"Visibility Factor"));if(!(bpy_lamp["uuid"]in _lamp_indexes)){_lamp_indexes[bpy_lamp["uuid"]]=_lamp_index;dirs.push(["LAMP_INDEX",String(_lamp_index++)])}else dirs.push(["LAMP_INDEX",String(_lamp_indexes[bpy_lamp["uuid"]])]);
data=_lamp_indexes;break;case "LIGHTING_AMBIENT":inputs=[default_node_inout("E","E",[0,0,0],true),default_node_inout("A","A",[0,0,0],true),default_node_inout("D","D",[0,0,0],true)];outputs=[default_node_inout("color","color",[0,0,0],true),default_node_inout("specular","specular",[0,0,0],true)];break;case "LIGHTING_BEGIN":outputs=[default_node_inout("E","E",[0,0,0],true),default_node_inout("A","A",[0,0,0],true),default_node_inout("D","D",[0,0,0],true),default_node_inout("S","S",[0,0,0],true),default_node_inout("normal",
"normal",[0,0,0],true),default_node_inout("dif_params","dif_params",[0,0],true),default_node_inout("sp_params","sp_params",[0,0],true),default_node_inout("shadow_factor","shadow_factor",0,true),default_node_inout("translucency_color","translucency_color",0,true),default_node_inout("translucency_params","translucency_params",[0,0,0,0],true)];break;case "LIGHTING_END":inputs=[default_node_inout("color","color",[0,0,0],true),default_node_inout("specular","specular",[0,0,0],true)];break;case "LIGHTING_LAMP":inputs=
[default_node_inout("shadow_factor","shadow_factor",0,true)];outputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("lcolorint","lcolorint",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true)];break;case "DIFFUSE_LAMBERT":inputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true)];outputs=
[default_node_inout("lfactor","lfactor",0,true)];break;case "DIFFUSE_FRESNEL":case "DIFFUSE_MINNAERT":case "DIFFUSE_OREN_NAYAR":case "DIFFUSE_TOON":inputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true),default_node_inout("dif_params","dif_params",[0,0],true)];outputs=[default_node_inout("lfactor","lfactor",0,true)];break;case "SPECULAR_BLINN":case "SPECULAR_PHONG":inputs=
[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("norm_fac","norm_fac",0,true),default_node_inout("sp_params","sp_params",[0,0],true)];outputs=[default_node_inout("sfactor","sfactor",0,true)];break;case "SPECULAR_TOON":case "SPECULAR_WARDISO":inputs=[default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("lfac","lfac",[0,0],true),default_node_inout("normal","normal",[0,0,0],
true),default_node_inout("sp_params","sp_params",[0,0],true)];outputs=[default_node_inout("sfactor","sfactor",0,true)];break;case "LIGHTING_APPLY":inputs=[default_node_inout("color","color",[0,0,0,0],true),default_node_inout("specular","specular",[0,0,0],true),default_node_inout("lfactor","lfactor",0,true),default_node_inout("sfactor","sfactor",0,true),default_node_inout("ldir","ldir",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("translucency_params","translucency_params",
[0,0,0,0],true),default_node_inout("D","D",[0,0,0],true),default_node_inout("S","S",[0,0,0],true),default_node_inout("lcolorint","lcolorint",[0,0,0],true),default_node_inout("translucency_color","translucency_color",0,true)];outputs=[default_node_inout("color","color",[0,0,0,0],true),default_node_inout("specular","specular",[0,0,0],true)];break;case "NORMAL":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);var output_norm=node_output_by_ident(bpy_node,"Normal");params.push(node_param(shader_ident("param_NORMAL_Normal"),
output_norm.default_value,3));break;case "MAPPING":var vector_type=bpy_node["vector_type"];type="MAPPING";inputs.push(node_input_by_ident(bpy_node,"Vector"));outputs.push(node_output_by_ident(bpy_node,"Vector"));var rot=bpy_node["rotation"];var scale=bpy_node["scale"];var trans=bpy_node["translation"];var trs_matrix=m_mat3.create();var rot_matrix=m_util.euler_to_rotation_matrix(rot);if(vector_type=="TEXTURE"){scale[0]=scale[0]||1;scale[1]=scale[1]||1;scale[2]=scale[2]||1}var scale_matrix=new Float32Array([scale[0],
0,0,0,scale[1],0,0,0,scale[2]]);m_mat3.multiply(rot_matrix,scale_matrix,trs_matrix);trs_matrix=m_util.mat3_to_mat4(trs_matrix,m_mat4.create());switch(vector_type){case "POINT":trs_matrix[12]=trans[0];trs_matrix[13]=trans[1];trs_matrix[14]=trans[2];break;case "TEXTURE":trs_matrix[12]=trans[0];trs_matrix[13]=trans[1];trs_matrix[14]=trans[2];trs_matrix=m_mat4.invert(trs_matrix,trs_matrix);break;case "NORMAL":m_mat4.invert(trs_matrix,trs_matrix);m_mat4.transpose(trs_matrix,trs_matrix);break}switch(vector_type){case "NORMAL":dirs.push(["MAPPING_IS_NORMAL",
1]);case "TEXTURE":dirs.push(["MAPPING_TRS_MATRIX",m_shaders.glsl_value(trs_matrix,16)]);break;case "POINT":if(m_vec3.length(rot)!==0)dirs.push(["MAPPING_TRS_MATRIX",m_shaders.glsl_value(trs_matrix,16)]);else{if(m_vec3.length(scale)!==0)dirs.push(["MAPPING_SCALE",m_shaders.glsl_value(scale,3)]);if(m_vec3.length(trans)!==0)dirs.push(["MAPPING_TRANSLATION",m_shaders.glsl_value(trans,3)])}break;case "VECTOR":if(m_vec3.length(rot)!==0)dirs.push(["MAPPING_TRS_MATRIX",m_shaders.glsl_value(trs_matrix,16)]);
else if(m_vec3.length(scale)!==0)dirs.push(["MAPPING_SCALE",m_shaders.glsl_value(scale,3)]);break}if(bpy_node["use_min"])dirs.push(["MAPPING_MIN_CLIP",m_shaders.glsl_value(bpy_node["min"],3)]);if(bpy_node["use_max"])dirs.push(["MAPPING_MAX_CLIP",m_shaders.glsl_value(bpy_node["max"],3)]);break;case "MATERIAL":case "MATERIAL_EXT":var material_begin_dirs=[];var material_end_dirs=[];var material_begin_inputs=[];var material_begin_outputs=[default_node_inout("E","E",[0,0,0],true),default_node_inout("A",
"A",[0,0,0],true),default_node_inout("D","D",[0,0,0],true),default_node_inout("S","S",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true),default_node_inout("dif_params","dif_params",[0,0],true),default_node_inout("sp_params","sp_params",[0,0],true),default_node_inout("shadow_factor","shadow_factor",0,true)];var material_end_inputs=[default_node_inout("color","color",[0,0,0],true),default_node_inout("specular","specular",[0,0,0],true),default_node_inout("normal","normal",[0,0,0],true)];
var material_end_outputs=[node_output_by_ident(bpy_node,"Color"),node_output_by_ident(bpy_node,"Alpha"),node_output_by_ident(bpy_node,"Normal")];var material_end_params=[];var input=node_input_by_ident(bpy_node,"Color");input.default_value.splice(3);material_begin_inputs.push(input);inputs.push(input);input=node_input_by_ident(bpy_node,"Spec");input.default_value.splice(3);material_begin_inputs.push(input);inputs.push(input);material_begin_inputs.push(default_node_inout("DiffuseIntensity","DiffuseIntensity",
bpy_node["diffuse_intensity"]));inputs.push(input);var input_norm=node_input_by_ident(bpy_node,"Normal");input_norm.default_value.splice(3);material_begin_inputs.push(input_norm);inputs.push(input_norm);if(type=="MATERIAL_EXT"){input=node_input_by_ident(bpy_node,"Emit");if(!input)input=default_node_inout("Emit","Emit",0);material_begin_inputs.push(input);inputs.push(input);input=node_input_by_ident(bpy_node,"Translucency");if(input){input.default_value=0;input.name="Translucency";input.identifier=
"Translucency"}else input=default_node_inout("Translucency","Translucency",0);inputs.push(input);input=node_input_by_ident(bpy_node,"Translucency");if(input){input.default_value=[0,0,0,0];input.name="TranslucencyParams";input.identifier="TranslucencyParams"}else input=default_node_inout("TranslucencyParams","TranslucencyParams",[0,0,0,0]);inputs.push(input);var input_new=node_input_by_ident(bpy_node,"Reflectivity");var input_old=node_input_by_ident(bpy_node,"Ray Mirror");if(input_new){input=input_new;
var input_name="Reflectivity"}else if(input_old){input=input_old;var input_name="Ray Mirror"}else{input=input_new;var input_name="Reflectivity"}if(!input)input=default_node_inout(input_name,input_name,0);inputs.push(input);material_end_inputs.push(input);input=node_input_by_ident(bpy_node,"SpecTra");if(!input)input=default_node_inout("SpecTra","SpecTra",0);inputs.push(input);material_end_inputs.push(input);input=node_input_by_ident(bpy_node,"Alpha");if(!input)input=default_node_inout("Alpha","Alpha",
bpy_node["alpha"]);inputs.push(input);material_end_inputs.push(input);material_end_outputs.push(node_output_by_ident(bpy_node,"Diffuse"));material_end_outputs.push(node_output_by_ident(bpy_node,"Spec"));material_begin_dirs.push(["MATERIAL_EXT",1]);material_end_dirs.push(["MATERIAL_EXT",1])}else{material_begin_inputs.push(default_node_inout("emit_intensity","emit_intensity",0));material_end_inputs.push(default_node_inout("reflect_factor","reflect_factor",0));material_end_inputs.push(default_node_inout("specular_alpha",
"specular_alpha",0));material_end_inputs.push(default_node_inout("alpha_in","alpha_in",0));material_end_outputs.push(default_node_inout("diffuse_out","diffuse_out",0));material_end_outputs.push(default_node_inout("spec_out","spec_out",0));material_begin_dirs.push(["MATERIAL_EXT",0]);material_end_dirs.push(["MATERIAL_EXT",0])}material_end_params.push(node_param(shader_ident("param_MATERIAL_alpha"),bpy_node["alpha"]));material_end_params.push(node_param(shader_ident("param_MATERIAL_spec_alpha"),bpy_node["specular_alpha"]));
outputs=material_end_outputs;if(input_norm.is_linked)material_begin_dirs.push(["USE_MATERIAL_NORMAL",1]);if(bpy_node["use_diffuse"]){material_begin_dirs.push(["USE_MATERIAL_DIFFUSE",1]);material_end_dirs.push(["USE_MATERIAL_DIFFUSE",1])}if(bpy_node["use_specular"])material_end_dirs.push(["USE_MATERIAL_SPECULAR",1]);var material_begin_params=[];var spec_param_0;var spec_param_1=0;switch(bpy_node["specular_shader"]){case "COOKTORR":case "PHONG":spec_param_0=bpy_node["specular_hardness"];break;case "WARDISO":spec_param_0=
bpy_node["specular_slope"];break;case "TOON":spec_param_0=bpy_node["specular_toon_size"];spec_param_1=bpy_node["specular_toon_smooth"];break;case "BLINN":spec_param_0=bpy_node["specular_ior"];spec_param_1=bpy_node["specular_hardness"];break;default:m_print.error("unsupported specular shader: "+bpy_node["specular_shader"]+' (material "'+bpy_node["material_name"]+'")');spec_param_0=bpy_node["specular_hardness"];break}var diffuse_param;var diffuse_param2;switch(bpy_node["diffuse_shader"]){case "LAMBERT":diffuse_param=
0;diffuse_param2=0;break;case "OREN_NAYAR":diffuse_param=bpy_node["roughness"];diffuse_param2=0;break;case "FRESNEL":diffuse_param=bpy_node["diffuse_fresnel"];diffuse_param2=bpy_node["diffuse_fresnel_factor"];break;case "MINNAERT":diffuse_param=bpy_node["darkness"];diffuse_param2=0;break;case "TOON":diffuse_param=bpy_node["diffuse_toon_size"];diffuse_param2=bpy_node["diffuse_toon_smooth"];break;default:m_print.error("unsupported diffuse shader: "+bpy_node["diffuse_shader"]+' (material "'+bpy_node["material_name"]+
'")');diffuse_param=0;diffuse_param2=0;break}material_begin_params.push(node_param(shader_ident("param_MATERIAL_diffuse"),[diffuse_param,diffuse_param2],2));material_begin_params.push(node_param(shader_ident("param_MATERIAL_spec"),[bpy_node["specular_intensity"],spec_param_0,spec_param_1],3));material_begin_dirs.push(["SHADELESS_MAT",bpy_node["use_shadeless"]?1:0]);var path_data={name:bpy_node["name"],value:{specular_shader:bpy_node["specular_shader"],diffuse_shader:bpy_node["diffuse_shader"],use_shadeless:bpy_node["use_shadeless"]}};
var material_begin={"name":"material_begin","type":"MATERIAL_BEGIN",inputs:material_begin_inputs,outputs:material_begin_outputs,params:material_begin_params,data:path_data,dirs:material_begin_dirs,vparams:[]};var material_end={"name":"material_end","type":"MATERIAL_END",inputs:material_end_inputs,outputs:material_end_outputs,params:material_end_params,data:path_data,dirs:material_end_dirs,vparams:[]};data={name:bpy_node["name"],value:{specular_shader:bpy_node["specular_shader"],diffuse_shader:bpy_node["diffuse_shader"],
use_shadeless:bpy_node["use_shadeless"]},material_begin:material_begin,material_end:material_end};break;case "MATH":switch(bpy_node["operation"]){case "ADD":type="MATH_ADD";break;case "SUBTRACT":type="MATH_SUBTRACT";break;case "MULTIPLY":type="MATH_MULTIPLY";break;case "DIVIDE":type="MATH_DIVIDE";break;case "SINE":type="MATH_SINE";break;case "COSINE":type="MATH_COSINE";break;case "TANGENT":type="MATH_TANGENT";break;case "ARCSINE":type="MATH_ARCSINE";break;case "ARCCOSINE":type="MATH_ARCCOSINE";break;
case "ARCTANGENT":type="MATH_ARCTANGENT";break;case "POWER":type="MATH_POWER";break;case "LOGARITHM":type="MATH_LOGARITHM";break;case "MINIMUM":type="MATH_MINIMUM";break;case "MAXIMUM":type="MATH_MAXIMUM";break;case "ROUND":type="MATH_ROUND";break;case "LESS_THAN":type="MATH_LESS_THAN";break;case "GREATER_THAN":type="MATH_GREATER_THAN";break;case "MODULO":type="MATH_MODULO";break;case "ABSOLUTE":type="MATH_ABSOLUTE";break;default:m_print.error("Unsupported MATH operation: "+bpy_node["operation"]);
return null}dirs.push(["MATH_USE_CLAMP",Number(bpy_node["use_clamp"])]);inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "MIX_RGB":switch(bpy_node["blend_type"]){case "MIX":type="MIX_RGB_MIX";break;case "ADD":type="MIX_RGB_ADD";break;case "MULTIPLY":type="MIX_RGB_MULTIPLY";break;case "SUBTRACT":type="MIX_RGB_SUBTRACT";break;case "SCREEN":type="MIX_RGB_SCREEN";break;case "DIVIDE":type="MIX_RGB_DIVIDE";break;case "DIFFERENCE":type="MIX_RGB_DIFFERENCE";break;
case "DARKEN":type="MIX_RGB_DARKEN";break;case "LIGHTEN":type="MIX_RGB_LIGHTEN";break;case "OVERLAY":type="MIX_RGB_OVERLAY";break;case "DODGE":type="MIX_RGB_DODGE";break;case "BURN":type="MIX_RGB_BURN";break;case "HUE":type="MIX_RGB_HUE";break;case "SATURATION":type="MIX_RGB_SATURATION";break;case "VALUE":type="MIX_RGB_VALUE";break;case "COLOR":type="MIX_RGB_COLOR";break;case "SOFT_LIGHT":type="MIX_RGB_SOFT_LIGHT";break;case "LINEAR_LIGHT":type="MIX_RGB_LINEAR_LIGHT";break;default:m_print.error("Unsupported MIX_RGB blend type: "+
bpy_node["blend_type"]);return null}dirs.push(["MIX_RGB_USE_CLAMP",Number(bpy_node["use_clamp"])]);inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "OUTPUT":inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=[];break;case "RGB":var param_name=mat_name+"%join%"+bpy_node["name"];var param={name:"-1",value:param_name};params.push(param);outputs.push(node_output_by_ident(bpy_node,"Color"));break;case "SEPRGB":case "SEPHSV":inputs=node_inputs_bpy_to_b4w(bpy_node);
outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "TEXTURE":type=texture_node_type(bpy_node);if(type=="TEXTURE_EMPTY"){outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Normal"));outputs.push(node_output_by_ident(bpy_node,"Value"))}else if(type=="TEXTURE_ENVIRONMENT"){inputs.push(node_input_by_ident(bpy_node,"Vector"));outputs.push(node_output_by_ident(bpy_node,"Color"));outputs.push(node_output_by_ident(bpy_node,"Value"))}else{if(type=="TEXTURE_NORMAL")if(bpy_node["texture"]["type"]==
"ENVIRONMENT_MAP"){m_print.error("Wrong output for ENVIRONMENT_MAP texture: "+bpy_node["name"]);return null}for(var i=0;i<4;++i){var input,output1,output2;if(i){input=default_node_inout("Vector"+i,"Vector"+i,[0,0,0]);if(type=="TEXTURE_COLOR"){output1=default_node_inout("Color"+i,"Color"+i,[0,0,0]);output2=default_node_inout("Value"+i,"Value"+i,0)}if(type=="TEXTURE_NORMAL"){output1=default_node_inout("Normal"+i,"Normal"+i,[0,0,0]);output2=default_node_inout("Value"+i,"Value"+i,0)}}else{input=node_input_by_ident(bpy_node,
"Vector");if(type=="TEXTURE_COLOR"){output1=node_output_by_ident(bpy_node,"Color");output2=node_output_by_ident(bpy_node,"Value")}if(type=="TEXTURE_NORMAL"){output1=node_output_by_ident(bpy_node,"Normal");output2=node_output_by_ident(bpy_node,"Value")}}inputs.push(input);outputs.push(output1);outputs.push(output2)}}var tex_name=shader_ident("param_TEXTURE_texture");params.push(node_param(tex_name));data={name:tex_name,value:bpy_node["texture"]};break;case "VALTORGB":inputs=node_inputs_bpy_to_b4w(bpy_node);
outputs=node_outputs_bpy_to_b4w(bpy_node);data={value:bpy_node};var interpolation=bpy_node["color_ramp"]["interpolation"];if(interpolation!="CONSTANT"&&interpolation!="LINEAR")m_print.warn("Color Ramp node is not fully supported.");break;case "VALUE":type="VALUE";var param_name=mat_name+"%join%"+bpy_node["name"];var param={name:"-1",value:param_name};params.push(param);outputs.push(node_output_by_ident(bpy_node,"Value"));break;case "VECT_MATH":switch(bpy_node["operation"]){case "ADD":type="VECT_MATH_ADD";
break;case "SUBTRACT":type="VECT_MATH_SUBTRACT";break;case "AVERAGE":type="VECT_MATH_AVERAGE";break;case "DOT_PRODUCT":type="VECT_MATH_DOT_PRODUCT";break;case "CROSS_PRODUCT":type="VECT_MATH_CROSS_PRODUCT";break;case "NORMALIZE":type="VECT_MATH_NORMALIZE";break;default:m_print.error("Unsupported VECT_MATH operation: "+bpy_node["operation"]);return null}inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break;case "VECT_TRANSFORM":switch(bpy_node["vector_type"]){case "POINT":dirs.push(["VECTOR_TYPE",
m_shaders.glsl_value(VT_POINT)]);break;case "VECTOR":dirs.push(["VECTOR_TYPE",m_shaders.glsl_value(VT_VECTOR)]);break;case "NORMAL":dirs.push(["VECTOR_TYPE",m_shaders.glsl_value(VT_NORMAL)]);break;default:m_print.error("Unsupported VECT_TRANSFORM vector_type: "+bpy_node["vector_type"]);return null}var convert_from=bpy_node["convert_from"];var convert_to=bpy_node["convert_to"];if(convert_from=="WORLD")if(convert_to=="WORLD")var conv_type=VT_WORLD_TO_WORLD;else if(convert_to=="OBJECT")var conv_type=
VT_WORLD_TO_OBJECT;else if(convert_to=="CAMERA")var conv_type=VT_WORLD_TO_CAMERA;else{m_print.error("Unsupported VECT_TRANSFORM convert_to: "+bpy_node["convert_to"]);return null}else if(convert_from=="OBJECT")if(convert_to=="WORLD")var conv_type=VT_OBJECT_TO_WORLD;else if(convert_to=="OBJECT")var conv_type=VT_OBJECT_TO_OBJECT;else if(convert_to=="CAMERA")var conv_type=VT_OBJECT_TO_CAMERA;else{m_print.error("Unsupported VECT_TRANSFORM convert_to: "+bpy_node["convert_to"]);return null}else if(convert_from==
"CAMERA")if(convert_to=="WORLD")var conv_type=VT_CAMERA_TO_WORLD;else if(convert_to=="OBJECT")var conv_type=VT_CAMERA_TO_OBJECT;else if(convert_to=="CAMERA")var conv_type=VT_CAMERA_TO_CAMERA;else{m_print.error("Unsupported VECT_TRANSFORM convert_to: "+bpy_node["convert_to"]);return null}else{m_print.error("Unsupported VECT_TRANSFORM convert_from: "+bpy_node["convert_from"]);return null}dirs.push(["CONVERT_TYPE",m_shaders.glsl_value(conv_type)]);inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);
break;default:inputs=node_inputs_bpy_to_b4w(bpy_node);outputs=node_outputs_bpy_to_b4w(bpy_node);break}var attr={name:name,type:type,vparams:vparams,inputs:inputs,outputs:outputs,params:params,data:data,dirs:dirs};var new_node_id=m_graph.gen_node_id(graph);m_graph.append_node(graph,m_graph.gen_node_id(graph),attr);if((bpy_node["type"]=="GEOMETRY"||bpy_node["type"]=="TEX_COORD")&&node_output_check_next(bpy_node,output_num))if(append_nmat_node(graph,bpy_node,++output_num,mat_name,shader_type)==null)return null;
return new_node_id}function validate_custom_node_group(bpy_node,inputs_map,outputs_map){var bpy_inputs=bpy_node["inputs"];var bpy_outputs=bpy_node["outputs"];var node_name=bpy_node["node_tree_name"];for(var i=0;i<inputs_map.length;i++){var input=bpy_inputs[i];var need_vec_in=inputs_map[i];if(!input||input["default_value"]instanceof Array!=need_vec_in){m_print.warn('Wrong inputs for custom node group "'+bpy_node["name"]+'" of type: "',node_name,'".'+"Processing as general node group.");return false}}for(var i=
0;i<outputs_map.length;i++){var output=bpy_outputs[i];var need_vec_out=outputs_map[i];if(!output||output["default_value"]instanceof Array!=need_vec_out){m_print.warn('Wrong outputs for custom node group "'+bpy_node["name"]+'" of type: "',node_name,'".'+"Processing as general node group.");return false}}return true}function process_node_group(bpy_node,mat_name,shader_type){var node_tree=clone_node_tree(bpy_node["node_group"]["node_tree"]);var node_name=bpy_node["node_tree_name"];if(node_name=="B4W_REPLACE"||
node_name=="B4W_LEVELS_OF_QUALITY"){var gi=init_bpy_node("Group input","GROUP_INPUT",[],bpy_node["inputs"]);var go=init_bpy_node("Group output","GROUP_OUTPUT",bpy_node["outputs"],[]);var link=null;if(node_name=="B4W_REPLACE"||node_name=="B4W_LEVELS_OF_QUALITY"&&(cfg_def.quality==m_cfg.P_LOW||cfg_def.force_low_quality_nodes))link=init_bpy_link(gi,gi["outputs"][1],go,go["inputs"][0]);else link=init_bpy_link(gi,gi["outputs"][0],go,go["inputs"][0]);node_tree["nodes"]=[gi,go];node_tree["links"]=[link]}rename_node_group_nodes(bpy_node["name"],
node_tree);var node_group_graph=compose_nmat_graph(node_tree,bpy_node["node_group"]["uuid"],true,mat_name,shader_type);var data={node_group_graph:node_group_graph,node_group_links:node_tree["links"]};return data}function reset_shader_ident_counters(){_shader_ident_counters={}}function copy_obj(obj){var type=typeof obj;if(type=="string"||type=="number"||type=="boolean"||!obj)return obj;return m_util.clone_object_nr(obj)}function clone_node_tree(tree){var new_tree={};for(var i in tree)if(i=="links"||
i=="nodes"){new_tree[i]=[];for(var j=0;j<tree[i].length;j++){new_tree[i][j]={};for(var k in tree[i][j])if(i=="links"){new_tree[i][j][k]={};for(var l in tree[i][j][k])new_tree[i][j][k][l]=copy_obj(tree[i][j][k][l])}else new_tree[i][j][k]=copy_obj(tree[i][j][k])}}else new_tree[i]=copy_obj(tree[i]);return new_tree}function shader_ident(name_base){if(!_shader_ident_counters[name_base])_shader_ident_counters[name_base]=0;var name=name_base+"_"+_shader_ident_counters[name_base];name=name.replace(/ /g,"_").replace(/\//g,
"_");_shader_ident_counters[name_base]++;return name}function check_input_node_outputs(bpy_node){var outputs=bpy_node["outputs"];for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output["is_linked"])return true}return false}function geometry_node_type(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++<output_num)continue;switch(output["identifier"]){case "UV":return"GEOMETRY_UV";
case "Vertex Color":return"GEOMETRY_VC";case "Normal":return"GEOMETRY_NO";case "Front/Back":return"GEOMETRY_FB";case "View":return"GEOMETRY_VW";case "Global":return"GEOMETRY_GL";case "Local":return"GEOMETRY_LO";case "Orco":return"GEOMETRY_OR";default:return null}}}function tex_coord_node_type(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++<output_num)continue;switch(output["identifier"]){case "Camera":return"TEX_COORD_CA";
case "Generated":return"TEX_COORD_GE";case "Normal":return"TEX_COORD_NO";case "Object":return"TEX_COORD_OB";case "Reflection":return"TEX_COORD_RE";case "UV":return"TEX_COORD_UV";case "Window":return"TEX_COORD_WI";default:return null}}}function node_output_check_next(bpy_node,output_num){var outputs=bpy_node["outputs"];var out_counter=0;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;if(out_counter++>output_num)return true}return false}function texture_node_type(bpy_node){if(!bpy_node["texture"])return"TEXTURE_EMPTY";
var outputs=bpy_node["outputs"];var node_color=false;var node_normal=false;var node_value=false;for(var i=0;i<outputs.length;i++){var output=outputs[i];if(!output["is_linked"])continue;var ident=output["identifier"];switch(ident){case "Color":node_color=true;break;case "Normal":node_normal=true;break;case "Value":node_value=true;break;default:throw"Unknown texture output";}}if(node_color){if(node_normal)m_print.warn('Node "'+bpy_node["name"]+'" has both Color '+"and Normal outputs. Normal will be omitted");
if(bpy_node["texture"]["type"]=="ENVIRONMENT_MAP")return"TEXTURE_ENVIRONMENT";else return"TEXTURE_COLOR"}else if(node_normal)return"TEXTURE_NORMAL";else if(node_value)if(bpy_node["texture"]["type"]=="ENVIRONMENT_MAP")return"TEXTURE_ENVIRONMENT";else return"TEXTURE_COLOR"}function node_input_by_ident(bpy_node,ident){var inputs=bpy_node["inputs"];for(var i=0;i<inputs.length;i++){var input=inputs[i];if(input["identifier"]==ident)return node_inout_bpy_to_b4w(input)}return null}function node_output_by_ident(bpy_node,
ident){var outputs=bpy_node["outputs"];for(var i=0;i<outputs.length;i++){var output=outputs[i];if(output["identifier"]==ident)return node_inout_bpy_to_b4w(output)}return null}function node_inout_bpy_to_b4w(bpy_node_inout){return{name:bpy_node_inout["name"],identifier:bpy_node_inout["identifier"],is_linked:bpy_node_inout["is_linked"],default_value:bpy_to_b4w_value(bpy_node_inout["default_value"])}}function default_node_inout(name,identifier,default_value,is_linked){return{name:name,identifier:identifier,
is_linked:is_linked||false,default_value:default_value}}function bpy_to_b4w_value(value){if(m_util.is_vector(value))return value.slice(0);return value}function node_inputs_bpy_to_b4w(bpy_node){var inputs=[];for(var i=0;i<bpy_node["inputs"].length;i++){var input=node_inout_bpy_to_b4w(bpy_node["inputs"][i]);if(input.default_value.length)input.default_value.splice(3);inputs.push(input)}return inputs}function node_outputs_bpy_to_b4w(bpy_node){var outputs=[];for(var i=0;i<bpy_node["outputs"].length;i++){var output=
node_inout_bpy_to_b4w(bpy_node["outputs"][i]);outputs.push(output)}return outputs}function node_param(name,value,dim){if(value===null||value===undefined)var pval=null;else var pval=m_shaders.glsl_value(value,dim);var param={name:name,value:pval};return param}function replace_zero_unity_vals(str_val){str_val=str_val.replace(/(,)/g,"$1 ");str_val=str_val.replace(/(^|[^0-9]|\s)(0\.0)($|[^0-9]|\s)/g,"$1ZERO_VALUE_NODES$3");str_val=str_val.replace(/(^|[^0-9]|\s)(1\.0)($|[^0-9]|\s)/g,"$1UNITY_VALUE_NODES$3");
str_val=str_val.replace(/\s+/g,"");return str_val}function append_nmat_edge(graph,id1,id2,attr1,attr2,bpy_link){var attr=[];var ident1=bpy_link["from_socket"]["identifier"];var ident2=bpy_link["to_socket"]["identifier"];var outputs1=attr1.outputs;for(var i=0;i<outputs1.length;i++){var out1=outputs1[i];if(out1.identifier==ident1){attr.push(i);break}}var inputs2=attr2.inputs;for(var i=0;i<inputs2.length;i++){var in2=inputs2[i];if(in2.identifier==ident2){attr.push(i);break}}if(attr.length==2)m_graph.append_edge(graph,
id1,id2,attr);return true}exports.compose_node_elements=function(graph){var node_elements=[];var node_elem_map={};reset_shader_ident_counters();var sgraph=m_graph.topsort(graph);m_graph.traverse(sgraph,function(id,attr){var elem=init_node_elem(attr);node_elements.push(elem);node_elem_map[id]=elem});m_graph.traverse_edges(sgraph,function(id1,id2,attr){var node1=m_graph.get_node_attr(sgraph,id1);var node2=m_graph.get_node_attr(sgraph,id2);var out1=node1.outputs[attr[0]];var in2=node2.inputs[attr[1]];
var elem1_outputs=node_elem_map[id1].outputs;var elem2_inputs=node_elem_map[id2].inputs;var name=elem1_outputs[attr[0]]||shader_ident("out_"+node1.type+"_"+out1.identifier);elem1_outputs[attr[0]]=name;elem2_inputs[attr[1]]=name});return node_elements};function init_node_elem(mat_node){var finputs=[];var finput_values=[];var foutputs=[];var fparams=[];var fparam_values=[];var vparams=[];for(var i=0;i<mat_node.inputs.length;i++){var input=mat_node.inputs[i];if(input.is_linked){finputs.push(null);finput_values.push(null)}else{finputs.push(shader_ident("in_"+
mat_node.type+"_"+input.identifier));var input_val=m_shaders.glsl_value(input.default_value,0);if(cfg_def.shader_constants_hack)if(mat_node.type.indexOf("MIX_RGB_")>=0&&(input.identifier=="Color1"||input.identifier=="Color2"||input.identifier=="Fac")||mat_node.type.indexOf("MATH_")>=0&&(input.identifier=="Value"||input.identifier=="Value_001")||mat_node.type.indexOf("VECT_MATH_")>=0&&input.identifier=="Vector_001"||mat_node.type.indexOf("LIGHTING_APPLY")>=0||mat_node.type.indexOf("MATERIAL_END")>=
0||mat_node.type.indexOf("MATERIAL_BEGIN")>=0)input_val=replace_zero_unity_vals(input_val);finput_values.push(input_val)}}for(var i=0;i<mat_node.outputs.length;i++){var output=mat_node.outputs[i];if(output.is_linked)foutputs.push(null);else foutputs.push(shader_ident("out_"+mat_node.type+"_"+output.identifier))}for(var i=0;i<mat_node.params.length;i++){var param=mat_node.params[i];fparams.push(param.name);fparam_values.push(param.value)}for(var i=0;i<mat_node.vparams.length;i++){var vparam=mat_node.vparams[i];
vparams.push(vparam.name)}var elem={id:mat_node.type,inputs:finputs,input_values:finput_values,outputs:foutputs,params:fparams,param_values:fparam_values,vparams:vparams,dirs:JSON.parse(JSON.stringify(mat_node.dirs))};return elem}function create_new_name(type,group_name,name){if(type=="GROUP_INPUT")return group_name+"*GI*"+name;else if(type=="GROUP_OUTPUT")return group_name+"*GO*"+name;return group_name+"%join%"+name}function rename_node_group_nodes(node_group_name,node_tree){var nodes=node_tree["nodes"];
var links=node_tree["links"];for(var i=0;i<nodes.length;i++)nodes[i]["name"]=create_new_name(nodes[i].type,node_group_name,nodes[i].name);for(var i=0;i<links.length;i++){links[i]["from_node"]["name"]=create_new_name(links[i]["from_node"]["type"],node_group_name,links[i]["from_node"]["name"]);links[i]["to_node"]["name"]=create_new_name(links[i]["to_node"]["type"],node_group_name,links[i]["to_node"]["name"])}}function trace_group_nodes(graph){var node_groups=[];m_graph.traverse(graph,function(id,node){if(node["type"]==
"GROUP")node_groups.push(node)});return node_groups}function append_node_groups_graphs(graph,links,node_groups){for(var i=0;i<node_groups.length;i++){var node_group_graph=node_groups[i].data.node_group_graph;var node_group_links=node_groups[i].data.node_group_links;if(!node_group_graph)return false;m_graph.traverse(node_group_graph,function(id,node){m_graph.append_node(graph,m_graph.gen_node_id(graph),node)});for(var j=0;j<node_group_links.length;j++)links.push(node_group_links[j]);change_node_groups_links(node_groups[i],
links,graph)}return true}function distribute_link(property,group_name,link,node_group_links,node_group_input_links,node_group_output_links){switch(property.type){case "GROUP":if(property["name"]==group_name)node_group_links.push(link);break;case "GROUP_INPUT":if(!property["name"].indexOf(group_name+"*GI*"))node_group_input_links.push(link);break;case "GROUP_OUTPUT":if(!property["name"].indexOf(group_name+"*GO*"))node_group_output_links.push(link);break}}function relink(links,input_links,output_links){var unused_links=
[];for(var i=0;i<output_links.length;i++){var output=output_links[i];var input=null;for(var j=0;j<input_links.length;j++)if(output["from_socket"]["identifier"]==input_links[j]["to_socket"]["identifier"]){input=input_links[j];break}if(input){output["from_node"]=input["from_node"];output["from_socket"]=input["from_socket"]}else unused_links.push(output)}for(var i=0;i<input_links.length;i++)links.splice(links.indexOf(input_links[i]),1);return unused_links}function add_unused_input_links(links,unused_links){if(!unused_links.length)return;
var gi_name=unused_links[0]["from_node"]["name"];for(var i=0;i<links.length;i++)if(links[i]["from_node"]["name"]==gi_name)unused_links.push(links[i])}function set_input_default_value(link,graph,value){var node_ids=nmat_node_ids(link["to_node"],graph);for(var i=0;i<node_ids.length;i++){var node_attr=m_graph.get_node_attr(graph,node_ids[i]);for(var j=0;j<node_attr.inputs.length;j++){var input=node_attr.inputs[j];if(input.identifier==link["to_socket"]["identifier"]){var old_val_type=get_socket_value_type(input.default_value);
var new_val_type=get_socket_value_type(value);if(new_val_type==old_val_type)input.default_value=value;else switch(old_val_type){case VECTOR_VALUE:scalar_to_vector(value,input.default_value);break;case SCALAR_VALUE:input.default_value=vector_to_scalar(value);break}break}}}}function change_default_values(links,graph,node,unused_links){for(var i=0;i<unused_links.length;i++){var link=unused_links[i];var value;for(var j=0;j<node.inputs.length;j++)if(link["from_socket"]["identifier"]==node.inputs[j].identifier){value=
node.inputs[j].default_value;break}set_input_default_value(link,graph,value);var index=links.indexOf(link);if(index!=-1)links.splice(index,1)}}function get_socket_value_type(value){return value instanceof Object?VECTOR_VALUE:SCALAR_VALUE}function scalar_to_vector(scalar,vector){vector[0]=vector[1]=vector[2]=scalar;return vector}function vector_to_scalar(vector){return(vector[0]+vector[1]+vector[2])/3}function change_node_groups_links(node,links,graph){var group_name=node.name;var node_group_links_from=
[];var node_group_links_to=[];var node_group_input_links=[];var node_group_output_links=[];for(var i=0;i<links.length;i++){var link=links[i];distribute_link(link["from_node"],group_name,link,node_group_links_from,node_group_input_links,node_group_output_links);distribute_link(link["to_node"],group_name,link,node_group_links_to,node_group_input_links,node_group_output_links)}var unused_input_links=relink(links,node_group_links_to,node_group_input_links);var unused_output_links=relink(links,node_group_output_links,
node_group_links_from);add_unused_input_links(links,unused_input_links);change_default_values(links,graph,node,unused_input_links);if(unused_output_links.length){var output_node;m_graph.traverse(graph,function(id,node){if(node.type=="GROUP_OUTPUT"&&!node.name.indexOf(group_name+"*GO*"))output_node=node});change_default_values(links,graph,output_node,unused_output_links)}}exports.check_material_glow_output=function(mat){if(mat["node_tree"])for(var i=0;i<mat["node_tree"]["nodes"].length;i++){var node=
mat["node_tree"]["nodes"][i];if(node.type=="GROUP"&&node["node_tree_name"]=="B4W_GLOW_OUTPUT")return true}return false};function print_node_graph(node_graph,mat_name){m_print.log("\n================ MATERIAL: "+mat_name+" ================"+"\n"+m_debug.nodegraph_to_dot(node_graph,true)+"\n============================================================")}exports.cleanup=cleanup;function cleanup(){for(var graph_id in _composed_node_graphs)delete _composed_node_graphs[graph_id];for(var graph_id in _composed_stack_graphs)delete _composed_stack_graphs[graph_id];
for(var key in _lamp_indexes)delete _lamp_indexes[key];_lamp_index=0;_material_index=0}function create_node_textures(nmat_graph){var color_ramp_nodes=[];var curves_nodes=[];m_graph.traverse(nmat_graph,function(node,attr){switch(attr.type){case "VALTORGB":color_ramp_nodes.push(attr);break;case "CURVE_VEC":case "CURVE_RGB":curves_nodes.push(attr);break}});var row=0;var color_ramp_id=null;var curve_id=null;var length=color_ramp_nodes.length+curves_nodes.length;if(color_ramp_nodes.length){color_ramp_id=
m_tex.create_color_ramp_texture(color_ramp_nodes,m_tex.COLORRAMP_TEXT_SIZE);for(var i=0;i<color_ramp_nodes.length;i++){color_ramp_nodes[i].dirs.push(["NODE_TEX_ROW",m_shaders.glsl_value((row+.5)/length)]);row++}}if(curves_nodes.length){curve_id=m_tex.create_vec_curve_texture(curves_nodes,m_tex.CURVE_NODES_TEXT_SIZE);for(var i=0;i<curves_nodes.length;i++){curves_nodes[i].dirs.push(["NODE_TEX_ROW",m_shaders.glsl_value((row+.5)/length)]);row++}}var image_data=null;if(color_ramp_id&&curve_id){image_data=
new Uint8Array(color_ramp_id.length+curve_id.length);image_data.set(color_ramp_id);image_data.set(curve_id,color_ramp_id.length)}else if(color_ramp_id)image_data=color_ramp_id;else image_data=curve_id;if(image_data)var tex=m_tex.generate_batch_texure(image_data,m_tex.CURVE_NODES_TEXT_SIZE);else var tex=null;for(var i=0;i<color_ramp_nodes.length;i++)color_ramp_nodes[i].data.texture=tex;for(var i=0;i<curves_nodes.length;i++)curves_nodes[i].data.texture=tex}function check_curve_usage(bpy_node,ind,start,
end){var curve=bpy_node["curve_mapping"]["curves_data"][ind];if(curve.length==2&&curve[0][0]<start+CURVE_POINT_EPS&&curve[0][1]<start+CURVE_POINT_EPS&&curve[1][0]>end-CURVE_POINT_EPS&&curve[1][1]>end-CURVE_POINT_EPS)return false;return true}};b4w.module["__animation"]=function(exports,require){var m_cfg=require("__config");var m_obj_util=require("__obj_util");var m_particles=require("__particles");var m_phy=require("__physics");var m_print=require("__print");var m_quat=require("__quat");var m_reformer=require("__reformer");var m_sfx=require("__sfx");var m_time=require("__time");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_armat=require("__armature");var m_lights=
require("__lights");var m_scs=require("__scenes");var cfg_ani=m_cfg.animation;var cfg_def=m_cfg.defaults;var LAST_FRAME_EPSILON=1E-6;exports.LAST_FRAME_EPSILON=LAST_FRAME_EPSILON;var OBJ_ANIM_TYPE_NONE=0;var OBJ_ANIM_TYPE_ARMATURE=10;var OBJ_ANIM_TYPE_OBJECT=20;var OBJ_ANIM_TYPE_VERTEX=30;var OBJ_ANIM_TYPE_SOUND=40;var OBJ_ANIM_TYPE_PARTICLES=50;var OBJ_ANIM_TYPE_MATERIAL=60;var OBJ_ANIM_TYPE_LIGHT=70;var OBJ_ANIM_TYPE_ENVIRONMENT=80;exports.OBJ_ANIM_TYPE_NONE=OBJ_ANIM_TYPE_NONE;exports.OBJ_ANIM_TYPE_ARMATURE=
OBJ_ANIM_TYPE_ARMATURE;exports.OBJ_ANIM_TYPE_OBJECT=OBJ_ANIM_TYPE_OBJECT;exports.OBJ_ANIM_TYPE_VERTEX=OBJ_ANIM_TYPE_VERTEX;exports.OBJ_ANIM_TYPE_SOUND=OBJ_ANIM_TYPE_SOUND;exports.OBJ_ANIM_TYPE_PARTICLES=OBJ_ANIM_TYPE_PARTICLES;exports.OBJ_ANIM_TYPE_MATERIAL=OBJ_ANIM_TYPE_MATERIAL;exports.OBJ_ANIM_TYPE_LIGHT=OBJ_ANIM_TYPE_LIGHT;exports.OBJ_ANIM_TYPE_ENVIRONMENT=OBJ_ANIM_TYPE_ENVIRONMENT;var SLOT_0=0;var SLOT_1=1;var SLOT_2=2;var SLOT_3=3;var SLOT_4=4;var SLOT_5=5;var SLOT_6=6;var SLOT_7=7;var SLOT_ALL=
-1;exports.SLOT_0=SLOT_0;exports.SLOT_1=SLOT_1;exports.SLOT_2=SLOT_2;exports.SLOT_3=SLOT_3;exports.SLOT_4=SLOT_4;exports.SLOT_5=SLOT_5;exports.SLOT_6=SLOT_6;exports.SLOT_7=SLOT_7;exports.SLOT_ALL=SLOT_ALL;var KF_INTERP_BEZIER=0;var KF_INTERP_LINEAR=1;var KF_INTERP_CONSTANT=2;var AB_CYCLIC=10;var AB_FINISH_RESET=20;var AB_FINISH_STOP=30;var VECTORS_RESERVED=50;exports.AB_CYCLIC=AB_CYCLIC;exports.AB_FINISH_RESET=AB_FINISH_RESET;exports.AB_FINISH_STOP=AB_FINISH_STOP;var AT_NONE=exports.AT_NONE=0;var AT_ARMATURE=
exports.AT_ARMATURE=1;var AT_SPEAKER=exports.AT_SPEAKER=2;var AT_OBJECT=exports.AT_OBJECT=3;var AT_MATERIAL=exports.AT_MATERIAL=4;var AT_LIGHT=exports.AT_LIGHT=5;var AT_ENVIRONMENT=exports.AT_ENVIRONMENT=6;var AEM_ENERGY=0;var AEM_HORIZON_COLOR=1;var AEM_ZENITH_COLOR=2;var AEM_FOG_INTENSITY=3;var AEM_FOG_DEPTH=4;var AEM_FOG_START=5;var AEM_FOG_HEIGHT=6;var AEM_FOG_COLOR=7;var _frame_info_tmp=new Array(3);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _quat4_tmp=new Float32Array(4);
var _quat4_tmp2=new Float32Array(4);var _quat4_tmp3=new Float32Array(4);var _tsr_tmp=m_tsr.create();var _mat4_tmp=new Float32Array(16);var _anim_objs_cache=[];var _actions=[];exports.get_max_bones=function(){return m_util.trunc((cfg_def.max_vertex_uniform_vectors-VECTORS_RESERVED)/4)};exports.frame_to_sec=function(frame){return frame/m_time.get_framerate()};function create_action_render(){var render={type:AT_NONE,num_pierced:0,pierce_step:0,params:null,bones:null,bflags:null,channels_mask:new Int8Array(8)};
return render}exports.update=function(elapsed){for(var i=0;i<_anim_objs_cache.length;i++){var obj=_anim_objs_cache[i];for(var j=0;j<8;j++)animate(obj,elapsed,j);if(obj.render.anim_mixing){process_mix_factor(obj,elapsed);mix_skeletal_animation(obj,elapsed)}}for(var i=0;i<_anim_objs_cache.length;i++){var obj=_anim_objs_cache[i];for(var j=0;j<8;j++){if(!obj.anim_slots.length)break;handle_finish_callback(obj,j)}}};function handle_finish_callback(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(!anim_slot)return;
if(anim_slot.finish_callback&&anim_slot.exec_finish_callback){anim_slot.exec_finish_callback=false;anim_slot.finish_callback(obj,slot_num)}}exports.get_all_actions=function(){return _actions};function apply_vertex_anim(obj,va,slot_num){var anim_slot=obj.anim_slots[slot_num];anim_slot.type=OBJ_ANIM_TYPE_VERTEX;var start=va.frame_start;var length=va.frame_end-start+1;anim_slot.start=start;anim_slot.length=length;anim_slot.current_frame_float=start;anim_slot.animation_name=va.name;var va_frame_offset=
0;for(var i=0;i<obj.vertex_anim.length;i++){var va_i=obj.vertex_anim[i];if(va_i==va)break;else va_frame_offset+=va_i.frame_end-va_i.frame_start+1}anim_slot.va_frame_offset=va_frame_offset}function apply_particles_anim(batch,anim_slot,pdata){anim_slot.type=OBJ_ANIM_TYPE_PARTICLES;anim_slot.animation_name=pdata.name;anim_slot.start=pdata.frame_start;anim_slot.length=pdata.frame_end-anim_slot.start;if(!pdata.cyclic)anim_slot.length+=pdata.lifetime_frames}function apply_obj_particles_anim(obj,psys_name,
slot_num){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(!pdata||pdata.name!=psys_name)continue;var anim_slot=obj.anim_slots[slot_num];apply_particles_anim(batches[j],anim_slot,pdata)}}}function init_anim(obj,slot_num){var anim_slot={type:null,animation_name:null,action_frame_range:null,action_step:0,action_bflags:null,channels_mask:new Int8Array(8),quats:null,trans:null,
skinning_data:[],play:false,behavior:AB_FINISH_RESET,current_frame_float:0,start:0,length:0,trans_smooth_period:0,quat_smooth_period:0,exec_finish_callback:false,va_frame_offset:null,speed:1,volume:null,pitch:null,color:null,energy:null,zenith_color:null,horizon_color:null,fog_intensity:null,fog_depth:null,fog_start:null,fog_height:null,fog_color:null,nodemat_values:[],node_value_inds:[],nodemat_rgbs:[],node_rgb_inds:[],node_batches:null};if(!obj.anim_slots.length)for(var i=0;i<8;i++)obj.anim_slots.push(null);
obj.anim_slots[slot_num]=anim_slot}function update_anim_cache(obj){if(_anim_objs_cache.indexOf(obj)==-1)_anim_objs_cache.push(obj)}exports.get_anim_names=function(obj){var anim_names=[];if(has_vertex_anim(obj))for(var i=0;i<obj.vertex_anim.length;i++)anim_names.push(obj.vertex_anim[i].name);var actions=get_actions(obj);for(var i=0;i<actions.length;i++)anim_names.push(strip_baked_suffix(actions[i]["name"]));if(m_particles.obj_has_particles(obj)&&m_particles.obj_has_anim_particles(obj)){var scenes_data=
obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata)anim_names.push(pdata.name)}}}return anim_names};exports.strip_baked_suffix=strip_baked_suffix;function strip_baked_suffix(name){return name.replace(/_B4W_BAKED$/,"")}exports.get_anim_type=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(anim_slot)return anim_slot.type;return OBJ_ANIM_TYPE_NONE};exports.apply_def=function(obj){var slot_num=
SLOT_0;var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata&&pdata.p_type=="EMITTER"&&!batches[j].forked_batch){do_before_apply(obj,slot_num);apply_particles_anim(batches[j],obj.anim_slots[slot_num],pdata);do_after_apply(obj,slot_num);if(pdata.cyclic)obj.anim_slots[slot_num].behavior=AB_CYCLIC;else obj.anim_slots[slot_num].behavior=obj.anim_behavior_def;slot_num++}}}var actions=
get_default_actions(obj);for(var i=0;i<actions.length;i++){var action=actions[i];do_before_apply(obj,slot_num);if(apply_action(obj,action,slot_num)){do_after_apply(obj,slot_num);obj.anim_slots[slot_num].behavior=obj.anim_behavior_def;slot_num++}else obj.anim_slots[slot_num]=null}if(has_vertex_anim(obj)){do_before_apply(obj,slot_num);apply_vertex_anim(obj,obj.vertex_anim[0],slot_num);do_after_apply(obj,slot_num);obj.anim_slots[slot_num].behavior=obj.anim_behavior_def;slot_num++}};exports.anim_behavior_bpy_b4w=
function(behavior){switch(behavior){case "CYCLIC":return AB_CYCLIC;case "FINISH_RESET":return AB_FINISH_RESET;case "FINISH_STOP":return AB_FINISH_STOP;default:m_util.panic("Wrong animation behavior")}};function get_actions(obj){var act_list=[];for(var i=0;i<_actions.length;i++){var action=_actions[i];var act_render=action._render;if(act_render.type==AT_OBJECT)act_list.push(action);else if(act_render.type==AT_ARMATURE&&obj.type=="ARMATURE")act_list.push(action);else if(act_render.type==AT_SPEAKER&&
obj.type=="SPEAKER")act_list.push(action);else if(act_render.type==AT_ENVIRONMENT&&obj.type=="WORLD")act_list.push(action)}if(obj.type=="MESH")for(var i=0;i<obj.actions.length;i++){var action=obj.actions[i];if(action._render.type==AT_MATERIAL)act_list.push(action)}return act_list}function get_default_actions(obj){return obj.actions.slice()}exports.get_bpy_material_actions=function(bpy_obj){var act_list=[];var materials=bpy_obj["data"]["materials"];for(var i=0;i<materials.length;i++){var mat=materials[i];
var node_tree=mat["node_tree"];if(node_tree)get_node_tree_actions_r(node_tree,act_list)}return act_list};function get_node_tree_actions_r(node_tree,container){if(node_tree["animation_data"]){var anim_data=node_tree["animation_data"];var action=anim_data["action"];if(action&&action._render.type==AT_MATERIAL)container.push(action)}var nodes=node_tree["nodes"];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node["node_group"]){var g_node_tree=node["node_group"]["node_tree"];if(g_node_tree)get_node_tree_actions_r(g_node_tree,
container)}}}function has_vertex_anim(obj){if(m_obj_util.is_mesh(obj)&&obj.render.vertex_anim)return true;else return false}exports.play=function(obj,finish_callback,slot_num){function play_slot(anim_slot){anim_slot.play=true;if(finish_callback)anim_slot.finish_callback=finish_callback;else anim_slot.finish_callback=null;anim_slot.exec_finish_callback=false}process_anim_slots(obj.anim_slots,slot_num,play_slot);if(obj.render.anim_mixing)sync_skeletal_animations(obj)};exports.stop=function(obj,slot_num){function stop_slot(anim_slot){anim_slot.play=
false;anim_slot.finish_callback=null;anim_slot.exec_finish_callback=false}process_anim_slots(obj.anim_slots,slot_num,stop_slot)};exports.is_play=function(obj,slot_num){var anim_slots=obj.anim_slots;if(slot_num==SLOT_ALL)for(var i=0;i<8;i++){if(anim_slots[i])if(anim_slots[i].play)return true}else{var anim_slot=anim_slots[slot_num];if(anim_slot)return anim_slot.play}return false};exports.set_frame=set_frame;function set_frame(obj,cff,slot_num){var anim_slots=obj.anim_slots;if(slot_num==SLOT_ALL)for(var i=
0;i<8;i++){var anim_slot=anim_slots[i];if(anim_slot){anim_slot.current_frame_float=cff;update_object_animation(obj,0,i,true)}}else{var anim_slot=anim_slots[slot_num];if(anim_slot){anim_slot.current_frame_float=cff;update_object_animation(obj,0,slot_num,true)}}}exports.set_first_frame=set_first_frame;function set_first_frame(obj,slot_num){function set_slot_first_frame(slot){set_frame(obj,slot.start,slot_num)}slot_num=slot_num||SLOT_0;process_anim_slots(obj.anim_slots,slot_num,set_slot_first_frame)}
exports.get_current_frame_float=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(anim_slot&&anim_slot.current_frame_float)return anim_slot.current_frame_float;else return 0};exports.is_cyclic=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot&&anim_slot.behavior==AB_CYCLIC};exports.set_behavior=function(obj,behavior,slot_num){function set_slot_behavior(anim_slot){anim_slot.behavior=behavior}process_anim_slots(obj.anim_slots,slot_num,set_slot_behavior)};
exports.get_behavior=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot&&anim_slot.behavior};exports.apply_smoothing=function(obj,trans_period,quat_period,slot_num){function apply_slot_smoothing(anim_slot){anim_slot.trans_smooth_period=trans_period||0;anim_slot.quat_smooth_period=quat_period||0}process_anim_slots(obj.anim_slots,slot_num,apply_slot_smoothing)};exports.remove_slot_animation=function(obj,slot_num){if(slot_num==SLOT_ALL)for(var i=0;i<8;i++)obj.anim_slots[i]=
null;else obj.anim_slots[slot_num]=null;if(obj.render.anim_mixing)recalculate_armature_anim_slots(obj,slot_num)};function process_anim_slots(anim_slots,slot_num,procedure){if(slot_num==SLOT_ALL)for(var i=0;i<8;i++){var anim_slot=anim_slots[i];if(anim_slot)procedure(anim_slot)}else{var anim_slot=anim_slots[slot_num];if(anim_slot)procedure(anim_slot)}}exports.update_object_animation=update_object_animation;function update_object_animation(obj,elapsed,slot_num,force_update){animate(obj,elapsed,slot_num,
force_update);handle_finish_callback(obj,slot_num);if(obj.render.anim_mixing){process_mix_factor(obj,elapsed);mix_skeletal_animation(obj,elapsed)}}exports.obj_is_animatable=function(obj){if(obj.type=="ARMATURE")return true;if(obj.armobj)return true;if(obj.type=="WORLD")return true;for(var i=0;i<obj.actions.length;i++){var act_type=obj.actions[i]._render.type;if(act_type==AT_OBJECT||act_type==AT_ARMATURE||act_type==AT_SPEAKER&&obj.type=="SPEAKER"||act_type==AT_LIGHT&&obj.type=="LAMP"||act_type==AT_MATERIAL&&
obj.type=="MESH")return true}if(m_particles.obj_has_particles(obj)&&m_particles.obj_has_anim_particles(obj))return true;if(obj.type=="MESH"&&obj.vertex_anim.length)return true;return false};exports.bpy_obj_is_animatable=function(bpy_obj,obj){if(obj.type=="ARMATURE")return true;var armobj=get_bpy_armobj(bpy_obj);if(armobj)return true;if(obj.type=="WORLD")return true;for(var i=0;i<obj.actions.length;i++){var act_type=obj.actions[i]._render.type;if(act_type==AT_OBJECT||act_type==AT_ARMATURE||act_type==
AT_SPEAKER&&obj.type=="SPEAKER"||act_type==AT_MATERIAL&&obj.type=="MESH")return true}if(m_particles.bpy_obj_has_particles(bpy_obj)&&m_particles.bpy_obj_has_anim_particles(bpy_obj))return true;if(obj.type=="MESH"&&bpy_obj["data"]["b4w_vertex_anim"].length)return true;return false};exports.is_animated=is_animated;function is_animated(obj){return Boolean(obj.anim_slots.length)}function apply_action(obj,action,slot_num){var frame_range=action["frame_range"];if(frame_range[0]>frame_range[1]){m_print.warn('Incompatible action "'+
action["name"]+'" has been applied to object "'+obj.name+'"');return false}var act_render=action._render;var anim_slot=obj.anim_slots[slot_num];anim_slot.animation_name=action["name"];anim_slot.action_frame_range=frame_range;anim_slot.action_step=act_render.pierce_step;anim_slot.action_bflags=act_render.bflags;anim_slot.channels_mask.set(act_render.channels_mask);anim_slot.start=frame_range[0];anim_slot.length=frame_range[1]-frame_range[0];anim_slot.current_frame_float=frame_range[0];var bones=act_render.bones;
switch(act_render.type){case AT_ARMATURE:if(m_obj_util.is_armature(obj)){anim_slot.type=OBJ_ANIM_TYPE_ARMATURE;var pose_data_frames=get_cached_anim_data(obj,action);if(!pose_data_frames){var pose_data_frames=calc_pose_data_frames(action,obj.render.bone_pointers);cache_anim_data(obj,action,pose_data_frames)}anim_slot.trans=pose_data_frames.trans;anim_slot.quats=pose_data_frames.quats;init_skinned_objs_data(obj,slot_num,action,pose_data_frames)}break;case AT_SPEAKER:if(m_obj_util.is_speaker(obj)){anim_slot.volume=
act_render.params["volume"]||null;anim_slot.pitch=act_render.params["pitch"]||null;anim_slot.type=OBJ_ANIM_TYPE_SOUND}break;case AT_LIGHT:if(m_obj_util.is_lamp(obj)){anim_slot.color=act_render.params["color"]||null;anim_slot.energy=act_render.params["energy"]||null;anim_slot.type=OBJ_ANIM_TYPE_LIGHT}break;case AT_MATERIAL:if(obj.type=="MESH"){anim_slot.type=OBJ_ANIM_TYPE_MATERIAL;var nodemat_anim_data=get_cached_anim_data(obj,action);if(!nodemat_anim_data){nodemat_anim_data=calc_nodemat_anim_data(obj,
action);cache_anim_data(obj,action,nodemat_anim_data)}anim_slot.node_value_inds=nodemat_anim_data.val_inds;anim_slot.nodemat_values=nodemat_anim_data.values;anim_slot.node_rgb_inds=nodemat_anim_data.rgb_inds;anim_slot.nodemat_rgbs=nodemat_anim_data.rgbs;anim_slot.node_batches=nodemat_anim_data.node_batches}break;case AT_OBJECT:var tsr=act_render.params["tsr"];if(tsr){anim_slot.type=OBJ_ANIM_TYPE_OBJECT;var obj_anim_data=get_cached_anim_data(obj,action);if(!obj_anim_data){obj_anim_data=calc_obj_anim_data(obj,
action,tsr);cache_anim_data(obj,action,obj_anim_data)}anim_slot.trans=obj_anim_data.trans;anim_slot.quats=obj_anim_data.quats;if(m_particles.obj_has_particles(obj)){var trans=anim_slot.trans[0];var quats=anim_slot.quats[0];m_particles.update_start_pos(obj,trans,quats)}}else{m_print.warn('Incompatible action "'+action["name"]+'" has been applied to object "'+obj.name+'"');return false}break;case AT_ENVIRONMENT:if(m_obj_util.is_world(obj)){anim_slot.energy=act_render.params["light_settings.environment_energy"]||
null;anim_slot.horizon_color=act_render.params["horizon_color"]||null;anim_slot.zenith_color=act_render.params["zenith_color"]||null;anim_slot.fog_intensity=act_render.params["mist_settings.intensity"]||null;anim_slot.fog_depth=act_render.params["mist_settings.depth"]||null;anim_slot.fog_start=act_render.params["mist_settings.start"]||null;anim_slot.fog_height=act_render.params["mist_settings.height"]||null;anim_slot.fog_color=act_render.params["b4w_fog_color"]||null;anim_slot.type=OBJ_ANIM_TYPE_ENVIRONMENT}break}if(m_obj_util.is_armature(obj)&&
act_render.type!=AT_ARMATURE)recalculate_armature_anim_slots(obj,slot_num);return true}function get_cached_anim_data(obj,action){var cache=obj.action_anim_cache;for(var i=0;i<cache.length;i+=2)if(action==cache[i])return cache[i+1];return null}function cache_anim_data(obj,action,data){var cache=obj.action_anim_cache;cache.push(action,data)}function init_skinned_objs_data(armobj,slot_num,action,armobj_pose_data_frames){var render=armobj.render;var skinned_renders=render.skinned_renders;var anim_slot=
armobj.anim_slots[slot_num];var skinning_data=anim_slot.skinning_data;var skinning_data_cache=get_cached_skinning_data(render,action);if(!skinning_data_cache){for(var i=0;i<skinned_renders.length;i++){var sk_rend=skinned_renders[i];var pose_data_frames=calc_skinned_pose_data_frames(armobj_pose_data_frames,sk_rend.bone_skinning_info);skinning_data.push(pose_data_frames)}cache_skinning_data(render,action,skinning_data)}else anim_slot.skinning_data=skinning_data_cache;if(render.anim_mixing){var skeletal_slots=
render.two_last_skeletal_slots;if(slot_num>skeletal_slots[1]){var tmp=skeletal_slots[1];skeletal_slots[1]=slot_num;skeletal_slots[0]=tmp}else if(slot_num>skeletal_slots[0]&&slot_num<skeletal_slots[1])skeletal_slots[0]=slot_num;sync_skeletal_animations(armobj)}}function get_cached_skinning_data(render,action){var cache=render.skinning_data_cache;for(var i=0;i<cache.length;i+=2)if(action==cache[i])return cache[i+1];return null}function cache_skinning_data(render,action,skinning_data){var cache=render.skinning_data_cache;
cache.push(action,skinning_data)}function sync_skeletal_animations(armobj){var skeletal_slots=armobj.render.two_last_skeletal_slots;if(skeletal_slots[0]==-1||skeletal_slots[1]==-1)return;var last_skel_slot=skeletal_slots[1];var anim_slots=armobj.anim_slots;var last_skel_anim=anim_slots[last_skel_slot];var cff=last_skel_anim.current_frame_float;var cff_int=Math.floor(cff);var frame_factor=cff-cff_int;var prev_skel_slot=skeletal_slots[0];var prev_skel_anim=anim_slots[prev_skel_slot];var cff=prev_skel_anim.current_frame_float;
var cff_int=Math.floor(cff);prev_skel_anim.current_frame_float=cff_int+frame_factor}function recalculate_armature_anim_slots(obj,overriden_slot){var skeletal_slots=obj.render.two_last_skeletal_slots;var last_skel_slot=skeletal_slots[1];skeletal_slots[0]=-1;skeletal_slots[1]=-1;if(overriden_slot==SLOT_ALL)return;var anim_slots=obj.anim_slots;for(var i=last_skel_slot;i>=SLOT_0;i--){var anim_slot=anim_slots[i];if(anim_slot&&anim_slot.type==OBJ_ANIM_TYPE_ARMATURE){if(i>skeletal_slots[1]){skeletal_slots[1]=
i;continue}else if(i>skeletal_slots[0])skeletal_slots[1]=i;break}}}function find_armature_constraint(constraints,type){for(var i=0;i<constraints.length;i++){var cons=constraints[i];if(cons["type"]==type){var target=cons["target"];if(target&&target["type"]=="ARMATURE")return cons}}return false}function calc_nodemat_anim_data(obj,action){var val_inds=[];var values=[];var rgb_inds=[];var rgbs=[];var node_batches=[];var act_render=action._render;var animated_mat_names=[];for(var node_name in act_render.params){var act_node_name=
action["name"]+"%join%"+node_name;for(var i=0;i<obj.scenes_data.length;i++){var batches=obj.scenes_data[i].batches;for(var j=0;j<batches.length;j++){var batch=batches[j];var val_ind_pairs=batch.node_anim_inds;var rgb_ind_pairs=batch.node_rgb_anim_inds;if(val_ind_pairs){var found_values=calc_node_act(node_name,act_node_name,act_render,values,val_inds,val_ind_pairs);var found_rgbs=calc_node_act(node_name,act_node_name,act_render,rgbs,rgb_inds,rgb_ind_pairs);if(found_values||found_rgbs)node_batches.push(batch)}}}}return{val_inds:val_inds,
values:values,rgb_inds:rgb_inds,rgbs:rgbs,node_batches:node_batches}}function calc_node_act(node_name,act_node_name,act_render,values,inds,val_ind_pairs){var found_vals=false;for(var i=0;i<val_ind_pairs.length;i+=2){var name=val_ind_pairs[i];if(act_node_name==name){var ind=val_ind_pairs[i+1];inds.push(ind);values.push(new Float32Array(act_render.params[node_name]));found_vals=true}}return found_vals}function calc_obj_anim_data(obj,action,tsr){var act_render=action._render;var num_pierced=act_render.num_pierced;
var anim_trans=[];var anim_quats=[];for(var i=0;i<num_pierced;i++){anim_trans.push(tsr.subarray(i*8,i*8+4));anim_quats.push(tsr.subarray(i*8+4,i*8+8))}return{trans:anim_trans,quats:anim_quats}}function is_material_action(action){var act_render=action._render;for(var param in act_render.params)if(param.indexOf("nodes")!=-1)return true;return false}function animate(obj,elapsed,slot_num,force_update){var anim_slot=obj.anim_slots[slot_num];if(!anim_slot||anim_slot.type==null)return;if(!anim_slot.play&&
!force_update)return;var render=obj.render;var cff=anim_slot.current_frame_float;var start=anim_slot.start;var length=anim_slot.length;cff+=anim_slot.speed*elapsed*m_time.get_framerate();var anim_type=anim_slot.type;var speed=anim_slot.speed;if(speed>=0&&cff>=start+length||speed<0&&cff<start){if(!force_update)anim_slot.exec_finish_callback=true;switch(anim_slot.behavior){case AB_CYCLIC:if(speed>=0)cff=(cff-start)%length+start;else cff=start+length-LAST_FRAME_EPSILON;break;case AB_FINISH_RESET:if(speed>=
0)cff=start;else cff=start+length-LAST_FRAME_EPSILON;anim_slot.play=false;break;case AB_FINISH_STOP:if(speed>=0)cff=start+length-LAST_FRAME_EPSILON;else cff=start;anim_slot.play=false;break}}anim_slot.current_frame_float=cff;switch(anim_type){case OBJ_ANIM_TYPE_ARMATURE:if(!render.anim_mixing){var finfo=action_anim_finfo(anim_slot);var frame=finfo[0];var frame_next=finfo[1];var frame_factor=finfo[2];render.quats_before=anim_slot.quats[frame];render.quats_after=anim_slot.quats[frame_next];render.trans_before=
anim_slot.trans[frame];render.trans_after=anim_slot.trans[frame_next];render.frame_factor=frame_factor;animate_skinned_objs(render,anim_slot,frame,frame_next);m_trans.update_transform(obj)}break;case OBJ_ANIM_TYPE_OBJECT:var finfo=action_anim_finfo(anim_slot);var trans=get_anim_translation(anim_slot,0,finfo,_vec3_tmp);var quat=get_anim_rotation(anim_slot,0,finfo,_quat4_tmp);var scale=get_anim_scale(anim_slot,0,finfo);if(obj.parent&&obj.pinverse_tsr){var tsr=_tsr_tmp;m_tsr.set_sep(trans,scale,quat,
tsr);m_tsr.multiply(obj.pinverse_tsr,tsr,tsr);m_tsr.get_trans_value(tsr,trans);m_tsr.get_quat_value(tsr,quat);scale=m_tsr.get_scale(tsr)}if(anim_slot.trans_smooth_period){var trans_old=_vec3_tmp2;m_trans.get_translation(obj,trans_old);m_util.smooth_v(trans,trans_old,elapsed,anim_slot.trans_smooth_period,trans)}if(anim_slot.quat_smooth_period){var quat_old=_quat4_tmp2;m_trans.get_rotation(obj,quat_old);m_util.smooth_q(quat,quat_old,elapsed,anim_slot.quat_smooth_period,quat)}var mask=anim_slot.channels_mask;
if(mask[0])m_trans.set_translation_rel(obj,trans);if(mask[1])m_trans.set_rotation_rel(obj,quat);if(mask[2])m_trans.set_scale_rel(obj,scale);m_trans.update_transform(obj);m_phy.sync_transform(obj);break;case OBJ_ANIM_TYPE_VERTEX:var finfo=vertex_anim_finfo(anim_slot);render.va_frame=finfo[0];render.va_frame_factor=finfo[2];break;case OBJ_ANIM_TYPE_SOUND:var finfo=action_anim_finfo(anim_slot);var fc=finfo[0];var fn=finfo[1];var ff=finfo[2];if(anim_slot.volume){var volume=(1-ff)*anim_slot.volume[fc]+
ff*anim_slot.volume[fn];m_sfx.set_volume(obj,volume)}if(anim_slot.pitch){var pitch=(1-ff)*anim_slot.pitch[fc]+ff*anim_slot.pitch[fn];m_sfx.playrate(obj,pitch)}break;case OBJ_ANIM_TYPE_PARTICLES:if(anim_slot.behavior==AB_CYCLIC)var time=(cff-start)/m_time.get_framerate();else var time=cff/m_time.get_framerate();m_particles.set_time(obj,anim_slot.animation_name,time);break;case OBJ_ANIM_TYPE_MATERIAL:var finfo=action_anim_finfo(anim_slot);var fc=finfo[0];var fn=finfo[1];var ff=finfo[2];var values=anim_slot.nodemat_values;
var val_indices=anim_slot.node_value_inds;var rgbs=anim_slot.nodemat_rgbs;var rgb_indices=anim_slot.node_rgb_inds;var node_batches=anim_slot.node_batches;for(var i=0;i<val_indices.length;i++){var vals=values[i];var ind=val_indices[i];var nodemat_value=(1-ff)*vals[fc]+ff*vals[fn];for(var j=0;j<node_batches.length;j++)node_batches[j].node_values[ind]=nodemat_value}for(var i=0;i<rgb_indices.length;i++){var rgb=rgbs[i];var ind=rgb_indices[i];var prev=rgb.subarray(fc*3,fc*3+3);var next=rgb.subarray(fn*
3,fn*3+3);var curr=m_vec3.lerp(prev,next,ff,_vec3_tmp);for(var j=0;j<node_batches.length;j++){node_batches[j].node_rgbs[3*ind]=curr[0];node_batches[j].node_rgbs[3*ind+1]=curr[1];node_batches[j].node_rgbs[3*ind+2]=curr[2]}}break;case OBJ_ANIM_TYPE_LIGHT:var finfo=action_anim_finfo(anim_slot);var fc=finfo[0];var fn=finfo[1];var ff=finfo[2];var mask=anim_slot.channels_mask;var energy=anim_slot.energy;if(energy&&mask[0]){var en=(1-ff)*energy[fc]+ff*energy[fn];m_lights.set_light_energy(obj.light,en)}var color=
anim_slot.color;if(color&&mask[1]){_vec3_tmp[0]=(1-ff)*color[3*fc]+ff*color[3*fn];_vec3_tmp[1]=(1-ff)*color[3*fc+1]+ff*color[3*fn+1];_vec3_tmp[2]=(1-ff)*color[3*fc+2]+ff*color[3*fn+2];m_lights.set_light_color(obj.light,_vec3_tmp)}var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++)m_scs.update_lamp_scene_color_intensity(obj,scenes_data[i].scene);break;case OBJ_ANIM_TYPE_ENVIRONMENT:var finfo=action_anim_finfo(anim_slot);var fc=finfo[0];var fn=finfo[1];var ff=finfo[2];var mask=anim_slot.channels_mask;
var scenes_data=obj.scenes_data;var subs=m_scs.get_subs(scenes_data[0].scene,"MAIN_OPAQUE");var energy=anim_slot.energy;if(mask[AEM_ENERGY])var energy_value=(1-ff)*energy[fc]+ff*energy[fn];else var energy_value=subs.energy;var horizon_color=anim_slot.horizon_color;if(mask[AEM_HORIZON_COLOR]){_vec3_tmp[0]=(1-ff)*horizon_color[3*fc]+ff*horizon_color[3*fn];_vec3_tmp[1]=(1-ff)*horizon_color[3*fc+1]+ff*horizon_color[3*fn+1];_vec3_tmp[2]=(1-ff)*horizon_color[3*fc+2]+ff*horizon_color[3*fn+2];var horizon_color_value=
_vec3_tmp}else var horizon_color_value=subs.horizon_color;var zenith_color=anim_slot.zenith_color;if(mask[AEM_ZENITH_COLOR]){_vec3_tmp2[0]=(1-ff)*zenith_color[3*fc]+ff*zenith_color[3*fn];_vec3_tmp2[1]=(1-ff)*zenith_color[3*fc+1]+ff*zenith_color[3*fn+1];_vec3_tmp2[2]=(1-ff)*zenith_color[3*fc+2]+ff*zenith_color[3*fn+2];var zenith_color_value=_vec3_tmp2}else var zenith_color_value=subs.zenith_color;var fog_intensity=anim_slot.fog_intensity;if(mask[AEM_FOG_INTENSITY])var fog_intensity_value=(1-ff)*fog_intensity[fc]+
ff*fog_intensity[fn];var fog_depth=anim_slot.fog_depth;if(mask[AEM_FOG_DEPTH])var fog_depth_value=(1-ff)*fog_depth[fc]+ff*fog_depth[fn];var fog_start=anim_slot.fog_start;if(mask[AEM_FOG_START])var fog_start_value=(1-ff)*fog_start[fc]+ff*fog_start[fn];var fog_height=anim_slot.fog_height;if(mask[AEM_FOG_HEIGHT])var fog_height_value=(1-ff)*fog_height[fc]+ff*fog_height[fn];var fog_color=anim_slot.fog_color;if(mask[AEM_FOG_COLOR]){_quat4_tmp[0]=(1-ff)*fog_color[3*fc]+ff*fog_color[3*fn];_quat4_tmp[1]=(1-
ff)*fog_color[3*fc+1]+ff*fog_color[3*fn+1];_quat4_tmp[2]=(1-ff)*fog_color[3*fc+2]+ff*fog_color[3*fn+2];var fog_color_value=_quat4_tmp}for(var i=0;i<scenes_data.length;i++){var scene=obj.scenes_data[i].scene;if(mask[AEM_ENERGY]||mask[AEM_HORIZON_COLOR]||mask[AEM_ZENITH_COLOR])m_scs.set_environment_colors(scene,energy_value,horizon_color_value,zenith_color_value);if(mask[AEM_FOG_INTENSITY])m_scs.set_fog_intensity(scene,fog_intensity_value);if(mask[AEM_FOG_DEPTH])m_scs.set_fog_depth(scene,fog_depth_value);
if(mask[AEM_FOG_START])m_scs.set_fog_start(scene,fog_start_value);if(mask[AEM_FOG_HEIGHT])m_scs.set_fog_height(scene,fog_height_value);if(mask[AEM_FOG_COLOR])m_scs.set_fog_color_density(scene,fog_color_value)}break;default:m_util.panic("Unknown animation type:"+anim_type);break}}function action_anim_finfo(anim_slot){var cff=anim_slot.current_frame_float;var action_start=anim_slot.action_frame_range[0];var action_end=anim_slot.action_frame_range[1];var range=action_end-action_start;var index_float=
cff-action_start;if(index_float<0)index_float=0;if(index_float>=range)index_float=range;var step=anim_slot.action_step;index_float/=step;var frame=Math.floor(index_float);if(anim_slot.action_bflags[frame])var frame_factor=index_float-frame;else var frame_factor=0;var frame_next=Math.ceil(frame+frame_factor);_frame_info_tmp[0]=frame;_frame_info_tmp[1]=frame_next;_frame_info_tmp[2]=frame_factor;return _frame_info_tmp}function vertex_anim_finfo(anim_slot){var cff=anim_slot.current_frame_float;var index_float=
cff-anim_slot.start;if(index_float<0)index_float=0;if(index_float>=anim_slot.length)index_float=anim_slot.length;var frame=Math.floor(index_float);var frame_next=frame+1;var frame_factor=index_float-frame;if(anim_slot.behavior!=AB_CYCLIC&&frame_next==anim_slot.length){frame=frame-1;frame_next=frame;frame_factor=1}var va_frame_offset=anim_slot.va_frame_offset;_frame_info_tmp[0]=frame+va_frame_offset;_frame_info_tmp[1]=frame_next+va_frame_offset;_frame_info_tmp[2]=frame_factor;return _frame_info_tmp}
function animate_skinned_objs(render,anim_slot,frame,frame_next){var skinned_renders=render.skinned_renders;var skinning_data=anim_slot.skinning_data;for(var i=0;i<skinned_renders.length;i++){var skinned_render=skinned_renders[i];var sk_data=skinning_data[i];skinned_render.quats_before=sk_data.quats[frame];skinned_render.quats_after=sk_data.quats[frame_next];skinned_render.trans_before=sk_data.trans[frame];skinned_render.trans_after=sk_data.trans[frame_next];skinned_render.frame_factor=render.frame_factor}}
function mix_skeletal_animation(obj,elapsed){var render=obj.render;var mix_factor=render.anim_mix_factor;var skeletal_slots=render.two_last_skeletal_slots;var ind_0=skeletal_slots[0];var ind_1=skeletal_slots[1];if(ind_1==-1)return;if(ind_0!=-1){var skeletal_slot_0=obj.anim_slots[ind_0];if(skeletal_slot_0.play||elapsed==0){var finfo_0=action_anim_finfo(skeletal_slot_0);var frame_0=finfo_0[0];var frame_next_0=finfo_0[1];render.frame_factor=finfo_0[2];var quats_prev_0=skeletal_slot_0.quats[frame_0];
var quats_next_0=skeletal_slot_0.quats[frame_next_0];var trans_prev_0=skeletal_slot_0.trans[frame_0];var trans_next_0=skeletal_slot_0.trans[frame_next_0]}else mix_factor=1}else mix_factor=1;var skeletal_slot_1=obj.anim_slots[ind_1];if(skeletal_slot_1.play||elapsed==0){var finfo_1=action_anim_finfo(skeletal_slot_1);var frame_1=finfo_1[0];var frame_next_1=finfo_1[1];render.frame_factor=finfo_1[2]}else if(ind_0!=-1&&skeletal_slot_0.play)mix_factor=0;else return;var quats_prev_1=skeletal_slot_1.quats[frame_1];
var quats_next_1=skeletal_slot_1.quats[frame_next_1];var trans_prev_1=skeletal_slot_1.trans[frame_1];var trans_next_1=skeletal_slot_1.trans[frame_next_1];if(mix_factor==1){render.quats_before.set(quats_prev_1);render.quats_after.set(quats_next_1);render.trans_before.set(trans_prev_1);render.trans_after.set(trans_next_1)}else if(mix_factor==0){render.quats_before.set(quats_prev_0);render.quats_after.set(quats_next_0);render.trans_before.set(trans_prev_0);render.trans_after.set(trans_next_0)}else{for(var i=
0;i<quats_prev_0.length;i+=4){var quat1=_quat4_tmp;var quat2=_quat4_tmp2;for(var j=0;j<4;j++){quat1[j]=quats_prev_0[i+j];quat2[j]=quats_prev_1[i+j]}m_quat.slerp(quat1,quat2,mix_factor,quat1);for(var j=0;j<4;j++)render.quats_before[i+j]=quat1[j];for(var j=0;j<4;j++){quat1[j]=quats_next_0[i+j];quat2[j]=quats_next_1[i+j]}m_quat.slerp(quat1,quat2,mix_factor,quat1);for(var j=0;j<4;j++)render.quats_after[i+j]=quat1[j]}m_util.blend_arrays(trans_prev_0,trans_prev_1,mix_factor,render.trans_before);m_util.blend_arrays(trans_next_0,
trans_next_1,mix_factor,render.trans_after)}m_trans.update_transform(obj);m_armat.update_skinned_renders(obj)}function process_mix_factor(obj,elapsed){var render=obj.render;var cur_mix_factor=render.anim_mix_factor;var speed=render.anim_mix_factor_change_speed;if(speed==0)return;var dest_mix_factor=render.anim_destination_mix_factor;var delta=dest_mix_factor-cur_mix_factor;var increment=speed*elapsed;if(m_util.sign(delta)==m_util.sign(speed)&&Math.abs(increment)<Math.abs(delta))render.anim_mix_factor+=
increment;else{render.anim_mix_factor=render.anim_destination_mix_factor;render.anim_mix_factor_change_speed=0}}function calc_pose_data_frames(action,bone_pointers){var trans_frames=[];var quats_frames=[];var num_pierced=action._render.num_pierced;for(var i=0;i<num_pierced;i++){for(var bone_name in bone_pointers){var bpointer=bone_pointers[bone_name];var tsr_basis=bpointer.tsr_basis;var bone_tsr=action._render.bones[bone_name];if(bone_tsr)m_tsr.copy(bone_tsr.subarray(i*8,i*8+8),tsr_basis);else m_tsr.identity(tsr_basis);
bpointer.tsr_channel_cache_valid=false}var pose_data=calc_pose_data(bone_pointers);trans_frames.push(pose_data.trans);quats_frames.push(pose_data.quats)}return{trans:trans_frames,quats:quats_frames}}exports.calc_pose_data=calc_pose_data;function calc_pose_data(bone_pointers){var trans=[];var quats=[];var t=new Float32Array(4);var q=new Float32Array(4);for(var bone_name in bone_pointers){var bpointer=bone_pointers[bone_name];calc_pose_bone(bpointer,t,q);var bone_index=bpointer.bone_index;for(var i=
0;i<4;i++){var comp_index=4*bone_index+i;trans[comp_index]=t[i];quats[comp_index]=q[i]}}return{trans:trans,quats:quats}}function calc_skinned_pose_data_frames(armobj_pose_data_frames,bone_skinning_info){var trans_frames=[];var quats_frames=[];var armobj_trans_frames=armobj_pose_data_frames.trans;var armobj_quats_frames=armobj_pose_data_frames.quats;for(var i=0;i<armobj_trans_frames.length;i++){var armobj_pose_data=armobj_pose_data_frames[i];var pose_data=extract_skinned_pose_data(armobj_trans_frames[i],
armobj_quats_frames[i],bone_skinning_info);trans_frames.push(pose_data.trans);quats_frames.push(pose_data.quats)}return{trans:trans_frames,quats:quats_frames}}exports.extract_skinned_pose_data=extract_skinned_pose_data;function extract_skinned_pose_data(arm_trans,arm_quats,bone_skinning_info){var trans=[];var quats=[];var t=new Float32Array(4);var q=new Float32Array(4);for(var bone_name in bone_skinning_info){var skininfo=bone_skinning_info[bone_name];var index=skininfo.bone_index;var deform_index=
skininfo.deform_bone_index;for(var i=0;i<4;i++){var comp_skin_index=4*deform_index+i;var comp_arm_index=4*index+i;trans[comp_skin_index]=arm_trans[comp_arm_index];quats[comp_skin_index]=arm_quats[comp_arm_index]}}trans=new Float32Array(trans);quats=new Float32Array(quats);return{trans:trans,quats:quats}}function calc_pose_bone(bone_pointer,dest_trans_scale,dest_quat){var chain=bone_pointer.chain;var bone_root_ptr=chain[chain.length-1];var tsr_channel_parent=bone_root_ptr.tsr_channel_cache;if(!bone_root_ptr.tsr_channel_cache_valid)m_tsr.identity(tsr_channel_parent);
for(var i=chain.length-1;i>=0;i--){var bone_ptr=chain[i];var tsr_channel=bone_ptr.tsr_channel_cache;if(bone_ptr.tsr_channel_cache_valid){tsr_channel_parent=tsr_channel;continue}var tsr_local=bone_ptr.tsr_local_rest;var tsr_basis=bone_ptr.tsr_basis;m_tsr.invert(tsr_local,_tsr_tmp);m_tsr.multiply(tsr_basis,_tsr_tmp,_tsr_tmp);m_tsr.multiply(tsr_local,_tsr_tmp,_tsr_tmp);m_tsr.multiply(tsr_channel_parent,_tsr_tmp,tsr_channel);tsr_channel_parent=tsr_channel;bone_ptr.tsr_channel_cache_valid=true}var tsr=
bone_ptr.tsr_channel_cache;dest_trans_scale[0]=tsr[0];dest_trans_scale[1]=tsr[1];dest_trans_scale[2]=tsr[2];dest_trans_scale[3]=tsr[3];dest_quat[0]=tsr[4];dest_quat[1]=tsr[5];dest_quat[2]=tsr[6];dest_quat[3]=tsr[7];m_quat.normalize(dest_quat,dest_quat)}exports.append_action=function(action){var BONE_EXP=new RegExp(/pose.bones\[\".+\"\]/g);var TSR8_DEF=m_tsr.create();var init_storage=function(pierced_points,default_value){if(typeof default_value=="object"&&default_value.length){var len=default_value.length;
var storage=new Float32Array(pierced_points*len);for(var i=0;i<pierced_points;i++)for(var j=0;j<len;j++)storage[i*len+j]=default_value[j]}else if(typeof default_value=="number"){var storage=new Float32Array(pierced_points);for(var i=0;i<pierced_points;i++)storage[i]=default_value}else m_util.panic("Wrong storage default value");return storage};var get_storage=function(params,bones,data_path,pierced_points,num_channels){if(data_path.search(BONE_EXP)>-1){var storage_obj=bones;var name=data_path.split('"')[1];
var def_val=TSR8_DEF}else{var storage_obj=params;if(num_channels==8){var name="tsr";var def_val=TSR8_DEF}else if(num_channels>1){var name=data_path;var def_val=new Float32Array(num_channels)}else{var name=data_path;var def_val=0}}if(!storage_obj[name])storage_obj[name]=init_storage(pierced_points,def_val);return storage_obj[name]};var storage_offset=function(data_path,array_index){if(data_path.indexOf("location")>-1){var base_offset=0;var channel_offset=array_index}else if(data_path.indexOf("rotation_quaternion")>
-1){var base_offset=4;var channel_offset=array_index==0?3:array_index-1}else if(data_path.indexOf("scale")>-1){var base_offset=3;var channel_offset=0}else{var base_offset=0;var channel_offset=array_index}return base_offset+channel_offset};var prepare_tsr_arr=function(tsr_arr,num_pierced){for(var i=0;i<num_pierced;i++){var quat=tsr_arr.subarray(i*8+4,i*8+8);m_quat.normalize(quat,quat)}};var act_render=action._render=create_action_render();act_render.pierce_step=1/cfg_ani.frame_steps;var fcurves=action["fcurves"];
var params={};var bones={};var num_pierced=0;for(var data_path in fcurves){var channels=fcurves[data_path];for(var array_index in channels){var fcurve=channels[array_index];var pp=fcurve._pierced_points;m_reformer.check_anim_fcurve_completeness(fcurve,action);var num_channels=fcurve["num_channels"];if(!num_pierced)num_pierced=pp.length;var storage=get_storage(params,bones,data_path,num_pierced,num_channels);var stride=storage.length/num_pierced;var offset=storage_offset(data_path,array_index|0);for(var i=
0;i<num_pierced;i++)storage[i*stride+offset]=pp[i]}}if(m_util.get_dict_length(params)){for(var p in params)if(p=="tsr")prepare_tsr_arr(params[p],num_pierced);act_render.params=params}if(m_util.get_dict_length(bones)){for(var b in bones)prepare_tsr_arr(bones[b],num_pierced);act_render.bones=bones}act_render.num_pierced=num_pierced;act_render.bflags=action._bflags;if("tsr"in params)set_tsr_act_channels_mask(fcurves,act_render.channels_mask);if("color"in params||"energy"in params)set_lamp_act_channels_mask(fcurves,
act_render.channels_mask);if("light_settings.environment_energy"in params||"horizon_color"in params||"zenith_color"in params||"mist_settings.intensity"in params||"mist_settings.depth"in params||"mist_settings.start"in params||"mist_settings.height"in params||"b4w_fog_color"in params)set_environment_act_channels_mask(fcurves,act_render.channels_mask);update_action_type(action);_actions.push(action)};function update_action_type(action){var act_render=action._render;if(act_render.bones)act_render.type=
AT_ARMATURE;else if(act_render.params)if("volume"in act_render.params||"pitch"in act_render.params)act_render.type=AT_SPEAKER;else if(is_material_action(action))act_render.type=AT_MATERIAL;else if(is_light_action(action))act_render.type=AT_LIGHT;else if(is_environment_action(action))act_render.type=AT_ENVIRONMENT;else if(is_object_action(action))act_render.type=AT_OBJECT;else act_render.type=AT_NONE;else act_render.type=AT_NONE}function is_material_action(action){var params=action._render.params;
if(params)for(var param in params)if(param.indexOf("nodes")!=-1)return true;return false}function is_light_action(action){var params=action._render.params;if(params){var fcurves=action["fcurves"];for(var param in fcurves)if(param=="color"&&!fcurves[param][3])return true;if(param=="energy")return true}return false}function is_environment_action(action){var params=action._render.params;if("light_settings.environment_energy"in params||"horizon_color"in params||"zenith_color"in params||"mist_settings.intensity"in
params||"mist_settings.depth"in params||"mist_settings.start"in params||"mist_settings.height"in params||"b4w_fog_color"in params)return true;return false}function is_object_action(action){var params=action._render.params;if(params){var fcurves=action["fcurves"];for(var param in fcurves)if(param=="location"||param=="rotation_quaternion"||param=="scale")return true}return false}function set_tsr_act_channels_mask(fcurves,mask){mask[0]=mask[1]=mask[2]=0;for(var data_path in fcurves){var channels=fcurves[data_path];
if(data_path=="location")mask[0]=1;else if(data_path=="rotation_quaternion")mask[1]=1;else if(data_path=="scale")mask[2]=1}}function set_lamp_act_channels_mask(fcurves,mask){mask[0]=mask[1]=0;for(var data_path in fcurves){var channels=fcurves[data_path];if(data_path=="energy")mask[0]=1;else if(data_path=="color")mask[1]=1}}function set_environment_act_channels_mask(fcurves,mask){mask[AEM_ENERGY]=mask[AEM_HORIZON_COLOR]=mask[AEM_ZENITH_COLOR]=0;mask[AEM_FOG_INTENSITY]=mask[AEM_FOG_DEPTH]=mask[AEM_FOG_START]=
0;mask[AEM_FOG_HEIGHT]=mask[AEM_FOG_COLOR]=0;for(var data_path in fcurves){var channels=fcurves[data_path];if(data_path=="light_settings.environment_energy")mask[AEM_ENERGY]=1;else if(data_path=="horizon_color")mask[AEM_HORIZON_COLOR]=1;else if(data_path=="zenith_color")mask[AEM_ZENITH_COLOR]=1;else if(data_path=="mist_settings.intensity")mask[AEM_FOG_INTENSITY]=1;else if(data_path=="mist_settings.depth")mask[AEM_FOG_DEPTH]=1;else if(data_path=="mist_settings.start")mask[AEM_FOG_START]=1;else if(data_path==
"mist_settings.height")mask[AEM_FOG_HEIGHT]=1;else if(data_path=="b4w_fog_color")mask[AEM_FOG_COLOR]=1}}exports.get_approx_curve_length=function(start,end){return(end-start)*cfg_ani.frame_steps+1};exports.approximate_curve=function(fcurve,fcurve_bin_data,points,bflags,start,end){var v1=new Float32Array(2);var v2=new Float32Array(2);var v3=new Float32Array(2);var v4=new Float32Array(2);var step=1/cfg_ani.frame_steps;var first_frame=fcurve_bin_data[1];var first_frame_value=fcurve_bin_data[2];var last_frame=
fcurve_bin_data[fcurve["last_frame_offset"]+1];var last_frame_value=fcurve_bin_data[fcurve["last_frame_offset"]+2];var out_cursor=0;var bin_cursor=0;var interp_prev=null;for(var i=start;i<=end;i++)if(i<first_frame)for(var j=0;j<cfg_ani.frame_steps;j++)points[out_cursor++]=first_frame_value;else if(i>last_frame)for(var j=0;j<cfg_ani.frame_steps;j++)points[out_cursor++]=last_frame_value;else{var interp=fcurve_bin_data[bin_cursor];var offset_to_next_kf=3;if(interp===KF_INTERP_BEZIER)offset_to_next_kf+=
2;if(interp_prev===KF_INTERP_BEZIER)offset_to_next_kf+=2;var is_blended=interp===KF_INTERP_CONSTANT?0:1;if(fcurve_bin_data[bin_cursor+1]==fcurve_bin_data[bin_cursor+offset_to_next_kf+1]){interp_prev=interp;bin_cursor+=offset_to_next_kf;continue}var substep_from=0;if(i==fcurve_bin_data[bin_cursor+1]){if(is_blended)bflags[out_cursor]=1;points[out_cursor]=fcurve_bin_data[bin_cursor+2];out_cursor++;substep_from++}if(i==last_frame)for(var j=substep_from;j<cfg_ani.frame_steps;j++)points[out_cursor++]=last_frame_value;
else{v1[0]=fcurve_bin_data[bin_cursor+1];v1[1]=fcurve_bin_data[bin_cursor+2];if(interp!==KF_INTERP_BEZIER){v2[0]=0;v2[1]=0}else if(interp_prev===KF_INTERP_BEZIER){v2[0]=fcurve_bin_data[bin_cursor+5];v2[1]=fcurve_bin_data[bin_cursor+6]}else{v2[0]=fcurve_bin_data[bin_cursor+3];v2[1]=fcurve_bin_data[bin_cursor+4]}if(interp!==KF_INTERP_BEZIER){v3[0]=0;v3[1]=0}else{v3[0]=fcurve_bin_data[bin_cursor+offset_to_next_kf+3];v3[1]=fcurve_bin_data[bin_cursor+offset_to_next_kf+4]}v4[0]=fcurve_bin_data[bin_cursor+
offset_to_next_kf+1];v4[1]=fcurve_bin_data[bin_cursor+offset_to_next_kf+2];for(var j=substep_from;j<cfg_ani.frame_steps;j++){var interp_val=i+j/cfg_ani.frame_steps;switch(interp){case KF_INTERP_BEZIER:correct_bezpart(v1,v2,v3,v4);if(is_blended)bflags[out_cursor]=1;points[out_cursor]=bezier(interp_val,v1,v2,v3,v4);out_cursor++;break;case KF_INTERP_LINEAR:if(is_blended)bflags[out_cursor]=1;points[out_cursor]=linear(interp_val,v1,v4);out_cursor++;break;case KF_INTERP_CONSTANT:if(is_blended)bflags[out_cursor]=
1;points[out_cursor]=fcurve_bin_data[bin_cursor+2];out_cursor++;break;default:m_util.panic("Unknown keyframe interpolation mode: "+interp)}}}if(i+1==fcurve_bin_data[bin_cursor+offset_to_next_kf+1]){interp_prev=interp;bin_cursor+=offset_to_next_kf}}};function linear(x,v1,v4){var x1=v1[0],y1=v1[1],x2=v4[0],y2=v4[1];var k=(y2-y1)/(x2-x1);var b=y1-k*x1;return k*x+b}function correct_bezpart(v1,v2,v3,v4){var h1=[];var h2=[];var len1,len2,len,fac;h1[0]=v1[0]-v2[0];h1[1]=v1[1]-v2[1];h2[0]=v4[0]-v3[0];h2[1]=
v4[1]-v3[1];len=v4[0]-v1[0];len1=Math.abs(h1[0]);len2=Math.abs(h2[0]);if(len1+len2==0)return;if(len1+len2>len){fac=len/(len1+len2);v2[0]=v1[0]-fac*h1[0];v2[1]=v1[1]-fac*h1[1];v3[0]=v4[0]-fac*h2[0];v3[1]=v4[1]-fac*h2[1]}}function bezier(x,v1,v2,v3,v4){var t=bezier_find_root(0,1,x,v1[0],v2[0],v3[0],v4[0]);var y=bezier_parametric(t,v1[1],v2[1],v3[1],v4[1]);return y}function bezier_find_root(t0_so_far,t1_so_far,x_needed,x0,x1,x2,x3){var t=t0_so_far+(t1_so_far-t0_so_far)/2;var x=bezier_parametric(t,x0,
x1,x2,x3);var dx=x-x_needed;var precision=.02;if(Math.abs(dx)<precision)return t;if(dx>0)return bezier_find_root(t0_so_far,t,x_needed,x0,x1,x2,x3);else return bezier_find_root(t,t1_so_far,x_needed,x0,x1,x2,x3)}function bezier_parametric(t,p0,p1,p2,p3){var t1=1-t;return p0*t1*t1*t1+3*p1*t1*t1*t+3*p2*t1*t*t+p3*t*t*t}function get_anim_translation(anim_slot,index,frame_info,dest){var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var trans=anim_slot.trans;var x=trans[frame][4*
index];var y=trans[frame][4*index+1];var z=trans[frame][4*index+2];var xn=trans[frame_next][4*index];var yn=trans[frame_next][4*index+1];var zn=trans[frame_next][4*index+2];dest[0]=(1-frame_factor)*x+frame_factor*xn;dest[1]=(1-frame_factor)*y+frame_factor*yn;dest[2]=(1-frame_factor)*z+frame_factor*zn;return dest}function get_anim_rotation(anim_slot,index,frame_info,dest){var frame=frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var quats=anim_slot.quats;var quat_frame=_quat4_tmp2;
quat_frame[0]=quats[frame][4*index];quat_frame[1]=quats[frame][4*index+1];quat_frame[2]=quats[frame][4*index+2];quat_frame[3]=quats[frame][4*index+3];var quat_frame_next=_quat4_tmp3;quat_frame_next[0]=quats[frame_next][4*index];quat_frame_next[1]=quats[frame_next][4*index+1];quat_frame_next[2]=quats[frame_next][4*index+2];quat_frame_next[3]=quats[frame_next][4*index+3];m_quat.slerp(quat_frame,quat_frame_next,frame_factor,dest);return dest}function get_anim_scale(anim_slot,index,frame_info){var frame=
frame_info[0];var frame_next=frame_info[1];var frame_factor=frame_info[2];var trans=anim_slot.trans;var s=trans[frame][4*index+3];var sn=trans[frame_next][4*index+3];var scale=(1-frame_factor)*s+frame_factor*sn;return scale}function do_before_apply(obj,slot_num){init_anim(obj,slot_num);update_anim_cache(obj)}function do_after_apply(obj,slot_num){m_trans.update_transform(obj);m_phy.sync_transform(obj);update_object_animation(obj,0,slot_num,true)}exports.apply=apply;function apply(obj,name,slot_num){slot_num=
slot_num||SLOT_0;if(m_obj_util.is_mesh(obj)){var vertex_anim=get_vertex_anim_by_name(obj,name);if(vertex_anim){do_before_apply(obj,slot_num);apply_vertex_anim(obj,vertex_anim,slot_num);do_after_apply(obj,slot_num);return true}var pdata=get_particles_data_by_name(obj,name);if(pdata&&pdata.p_type=="EMITTER"){do_before_apply(obj,slot_num);apply_obj_particles_anim(obj,pdata.name,slot_num);do_after_apply(obj,slot_num);return true}}var action=m_util.keysearch("name",name,_actions)||m_util.keysearch("name",
name+"_B4W_BAKED",_actions);if(action){do_before_apply(obj,slot_num);if(apply_action(obj,action,slot_num)){do_after_apply(obj,slot_num);return true}else obj.anim_slots[slot_num]=null}m_print.error('Unsupported object: "'+obj.name+'" or animation name: "'+name+'"');return false}exports.apply_by_uuid=function(obj,uuid,slot_num){slot_num=slot_num||SLOT_0;var action=m_util.keysearch("uuid",uuid,_actions);if(action){do_before_apply(obj,slot_num);if(apply_action(obj,action,slot_num)){do_after_apply(obj,
slot_num);return true}else obj.anim_slots[slot_num]=null}m_print.error('Unsupported object: "'+obj.name+'" or animation uuid: "'+uuid+'"');return false};exports.validate_action_by_name=function(obj,name){var action=m_util.keysearch("name",name,_actions)||m_util.keysearch("name",name+"_B4W_BAKED",_actions);if(action){if(action._render.type==AT_NONE)return false}else{var pdata=get_particles_data_by_name(obj,name);if(!pdata)if(!m_obj_util.is_mesh(obj)||!get_vertex_anim_by_name(obj,name))return false}return true};
exports.get_slot_num_by_anim=get_slot_num_by_anim;function get_slot_num_by_anim(obj,anim_name){var anim_slots=obj.anim_slots;for(var i=0;i<anim_slots.length;i++){var anim_slot=anim_slots[i];if(anim_slot&&strip_baked_suffix(anim_slot.animation_name)==strip_baked_suffix(anim_name))return i}return-1}exports.get_anim_by_slot_num=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];if(anim_slot&&anim_slot.animation_name)return strip_baked_suffix(anim_slot.animation_name);return null};exports.remove=
function(obj){obj.anim_slots.length=0;var ind=_anim_objs_cache.indexOf(obj);if(ind!=-1)_anim_objs_cache.splice(ind,1)};exports.remove_actions=function(data_id){for(var i=_actions.length-1;i>=0;i--)if(_actions[i]._data_id==data_id)_actions.splice(i,1)};exports.apply_to_first_empty_slot=function(obj,name){if(!obj.anim_slots.length)if(apply(obj,name,SLOT_0))return SLOT_0;else return-1;for(var i=0;i<obj.anim_slots.length;i++)if(!obj.anim_slots[i])if(apply(obj,name,i))return i;else return-1};exports.set_skel_mix_factor=
function(obj,factor,time){var cur_mix_factor=obj.render.anim_mix_factor;var speed=(factor-cur_mix_factor)/time;obj.render.anim_mix_factor_change_speed=speed;obj.render.anim_destination_mix_factor=factor};exports.set_speed=function(obj,speed,slot_num){function set_speed(anim_slot){anim_slot.speed=speed}process_anim_slots(obj.anim_slots,slot_num,set_speed)};exports.get_speed=function(obj,slot_num){return obj.anim_slots[slot_num].speed};exports.get_anim_start_frame=get_anim_start_frame;function get_anim_start_frame(obj,
slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot.start}exports.get_anim_length=function(obj,slot_num){var anim_slot=obj.anim_slots[slot_num];return anim_slot.length};exports.cleanup=function(){_anim_objs_cache.length=0;_actions.length=0};exports.fcurve_replace_euler_by_quat=function(fcurve){var ch=fcurve[0]||fcurve[1]||fcurve[2];var pcount=ch._pierced_points.length;var quat=_quat4_tmp;var euler_angles=_vec3_tmp;var is_x_rot=Boolean(fcurve[0]);if(!is_x_rot)fcurve[0]={_pierced_points:new Float32Array(pcount),
"num_channels":8};var is_y_rot=Boolean(fcurve[1]);if(!is_y_rot)fcurve[1]={_pierced_points:new Float32Array(pcount),"num_channels":8};var is_z_rot=Boolean(fcurve[2]);if(!is_z_rot)fcurve[2]={_pierced_points:new Float32Array(pcount),"num_channels":8};fcurve[3]={_pierced_points:new Float32Array(pcount),"num_channels":8};for(var i=0;i<pcount;i++){euler_angles[0]=is_x_rot?fcurve[0]._pierced_points[i]:0;euler_angles[1]=is_y_rot?fcurve[1]._pierced_points[i]:0;euler_angles[2]=is_z_rot?fcurve[2]._pierced_points[i]:
0;m_util.euler_to_quat(euler_angles,quat);fcurve[0]._pierced_points[i]=quat[3];fcurve[1]._pierced_points[i]=quat[0];fcurve[2]._pierced_points[i]=quat[1];fcurve[3]._pierced_points[i]=quat[2]}};function get_vertex_anim_by_name(obj,name){for(var i=0;i<obj.vertex_anim.length;i++){var va=obj.vertex_anim[i];if(va.name===name)return va}return null}function get_particles_data_by_name(obj,name){var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=
0;j<batches.length;j++){var pdata=batches[j].particles_data;if(pdata&&pdata.name===name)return pdata}}return null}exports.get_bpy_armobj=get_bpy_armobj;function get_bpy_armobj(bpy_obj){var modifiers=bpy_obj["modifiers"];for(var i=0;i<modifiers.length;i++){var modifier=modifiers[i];if(modifier["type"]=="ARMATURE")return modifier["object"]}return null}};b4w.module["__time"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var _timeline=0;var _timeline_epoch=0;var _timeouts=[];var _timeout_counter=0;var _animator_counter=0;var _animators=[];var _framerate=-1;exports.set_timeline=function(timeline){_timeline=timeline;_timeline_epoch=performance.now();for(var i=0;i<_timeouts.length;i++){var timeout=_timeouts[i];if(_timeline>timeout.expire_time){_timeouts.splice(i,1);i--;timeout.callback()}}for(var i=0;i<_animators.length;i++){var animator=
_animators[i];var time_amount=1-(animator.expire_time-_timeline)/animator.duration;time_amount=Math.min(time_amount,1);var value=animator.from+time_amount*(animator.to-animator.from);animator.callback(value);if(time_amount==1){_animators.splice(i,1);i--}}};exports.get_timeline=get_timeline;function get_timeline(){return _timeline}function get_timeout_id(){_timeout_counter++;return _timeout_counter}function get_animation_id(){_animator_counter++;return _animator_counter}exports.set_timeout=function(callback,
time){var id=get_timeout_id();var timeout={id:id,callback:callback,expire_time:_timeline+(performance.now()-_timeline_epoch+time)/1E3};_timeouts.push(timeout);return id};exports.clear_timeout=function(id){for(var i=0;i<_timeouts.length;i++){var timeout=_timeouts[i];if(timeout.id==id){_timeouts.splice(i,1);break}}};exports.clear_animation=function(id){for(var i=_animators.length;i--;){var animator=_animators[i];if(animator.id==id){_animators.splice(i,1);break}}};exports.animate=function(from,to,timeout,
anim_cb){var duration=timeout/1E3;var id=get_animation_id();var animator={id:id,callback:anim_cb,from:from,to:to,expire_time:_timeline+duration,duration:duration};_animators.push(animator);anim_cb(from);return id};exports.reset=function(id){_timeline=0;_timeline_epoch=0;_timeouts.length=0;_animators.length=0;_timeout_counter=0;_animator_counter=0};exports.get_framerate=get_framerate;function get_framerate(){if(m_cfg.animation.framerate!==-1)return m_cfg.animation.framerate;else return _framerate}
exports.set_framerate=function(value){_framerate=value};exports.get_frame=function(timeline){return timeline*get_framerate()}};b4w.module["__transform"]=function(exports,require){var m_bounds=require("__boundings");var m_cam=require("__camera");var m_cons=require("__constraints");var m_lights=require("__lights");var m_quat=require("__quat");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_tsr=require("__tsr");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var _vec3_tmp=new Float32Array(3);var _quat4_tmp=
new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _tsr_tmp=m_tsr.create();var _tsr_tmp2=m_tsr.create();var _elapsed=0;exports.SPACE_WORLD=0;exports.SPACE_LOCAL=1;exports.update=function(elapsed){_elapsed=elapsed};exports.set_translation=function(obj,trans){var render=obj.render;if(m_cons.has_child_of(obj)){m_tsr.set_trans(trans,render.world_tsr);var tsr_par=m_cons.get_child_of_parent_tsr(obj);var tsr_inv=m_tsr.invert(tsr_par,_tsr_tmp);var offset=m_cons.get_child_of_offset(obj);m_tsr.multiply(tsr_inv,
render.world_tsr,offset)}else m_tsr.set_trans(trans,render.world_tsr)};exports.set_translation_rel=set_translation_rel;function set_translation_rel(obj,trans){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_trans(trans,offset)}else{var render=obj.render;m_tsr.set_trans(trans,render.world_tsr)}}exports.get_translation=function(obj,dest){var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_vec3.copy(trans,dest);return dest};exports.get_translation_rel=function(obj,
dest){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_vec3.copy(m_tsr.get_trans_view(offset),dest)}else{var trans=m_tsr.get_trans_view(obj.render.world_tsr);m_vec3.copy(trans,dest)}return dest};exports.set_rotation=set_rotation;function set_rotation(obj,quat){var render=obj.render;if(m_cons.has_child_of(obj)){m_tsr.set_quat(quat,render.world_tsr);var tsr_par=m_cons.get_child_of_parent_tsr(obj);var tsr_inv=m_tsr.invert(tsr_par,_tsr_tmp);var offset=m_cons.get_child_of_offset(obj);
m_tsr.multiply(tsr_inv,render.world_tsr,offset)}else m_tsr.set_quat(quat,render.world_tsr)}exports.set_rotation_rel=set_rotation_rel;function set_rotation_rel(obj,quat){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_quat(quat,offset)}else m_tsr.set_quat(quat,obj.render.world_tsr)}exports.get_rotation=function(obj,dest){var quat=m_tsr.get_quat_view(obj.render.world_tsr);m_quat.copy(quat,dest);return dest};exports.get_rotation_rel=function(obj,dest){if(m_cons.has_child_of(obj)){var offset=
m_cons.get_child_of_offset(obj);m_quat.copy(m_tsr.get_quat_view(offset),dest)}else{var quat=m_tsr.get_quat_view(obj.render.world_tsr);m_quat.copy(quat,dest)}return dest};exports.set_rotation_euler=function(obj,euler){var quat=m_util.euler_to_quat(euler,_quat4_tmp);set_rotation(obj,quat)};exports.set_rotation_euler_rel=function(obj,euler){var quat=m_util.euler_to_quat(euler,_quat4_tmp);set_rotation_rel(obj,quat)};exports.set_scale=function(obj,scale){var render=obj.render;if(m_cons.has_child_of(obj)){var offset=
m_cons.get_child_of_offset(obj);var scale_par=m_tsr.get_scale(m_cons.get_child_of_parent_tsr(obj));m_tsr.set_scale(scale/scale_par,offset)}else m_tsr.set_scale(scale,render.world_tsr)};exports.set_scale_rel=function(obj,scale){var render=obj.render;if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.set_scale(scale,offset)}else m_tsr.set_scale(scale,render.world_tsr)};exports.get_scale=function(obj){return m_tsr.get_scale(obj.render.world_tsr)};exports.get_scale_rel=function(obj){if(m_cons.has_child_of(obj)){var offset=
m_cons.get_child_of_offset(obj);return m_tsr.get_scale(offset)}else return m_tsr.get_scale(obj.render.world_tsr)};exports.set_tsr=function(obj,tsr){m_tsr.copy(tsr,obj.render.world_tsr);if(m_cons.has_child_of(obj)){var tsr_par=m_cons.get_child_of_parent_tsr(obj);var tsr_inv=m_tsr.invert(tsr_par,_tsr_tmp);var offset=m_cons.get_child_of_offset(obj);m_tsr.multiply(tsr_inv,obj.render.world_tsr,offset)}};exports.set_tsr_rel=set_tsr_rel;function set_tsr_rel(obj,tsr){if(m_cons.has_child_of(obj)){var offset=
m_cons.get_child_of_offset(obj);m_tsr.copy(tsr,offset)}else m_tsr.copy(tsr,obj.render.world_tsr)}exports.get_tsr=function(obj,dest){return m_tsr.copy(obj.render.world_tsr,dest)};exports.get_tsr_rel=get_tsr_rel;function get_tsr_rel(obj,dest){if(m_cons.has_child_of(obj)){var offset=m_cons.get_child_of_offset(obj);m_tsr.copy(offset,dest)}else m_tsr.copy(obj.render.world_tsr,dest);return dest}exports.get_object_size=function(obj){var render=obj.render;var bb=render.bb_original;var scale=m_tsr.get_scale(render.world_tsr);
var x_size=scale*(bb.max_x-bb.min_x);var y_size=scale*(bb.max_y-bb.min_y);var z_size=scale*(bb.max_z-bb.min_z);var size=.5*Math.sqrt(x_size*x_size+y_size*y_size+z_size*z_size);return size};exports.get_object_center=function(obj,calc_bs_center,dest){if(!dest)var dest=new Float32Array(3);if(calc_bs_center){var render=obj.render;m_vec3.copy(render.bs_world.center,dest)}else{var render=obj.render;var bb=render.bb_original;dest[0]=(bb.max_x+bb.min_x)/2;dest[1]=(bb.max_y+bb.min_y)/2;dest[2]=(bb.max_z+bb.min_z)/
2;m_tsr.transform_vec3(dest,render.world_tsr,dest)}return dest};exports.move_local=function(obj,dx,dy,dz){var p_tsr=get_tsr_rel(obj,_tsr_tmp);var trans=_vec3_tmp;trans[0]=dx;trans[1]=dy;trans[2]=dz;m_tsr.transform_vec3(trans,p_tsr,trans);set_translation_rel(obj,trans)};exports.rotate_local=function(obj,quat){var p_tsr=get_tsr_rel(obj,_tsr_tmp);var tsr=m_tsr.set_quat(quat,m_tsr.identity(_tsr_tmp2));m_tsr.multiply(p_tsr,tsr,tsr);set_tsr_rel(obj,tsr)};exports.update_transform=update_transform;function update_transform(obj){var render=
obj.render;var scenes_data=obj.scenes_data;var obj_type=obj.type;if(obj_type=="CAMERA")m_cam.update_camera_upside_down(obj);m_cons.update_constraint(obj,_elapsed);if(obj_type=="CAMERA")m_cam.update_camera(obj);var trans=m_tsr.get_trans_value(render.world_tsr,_vec3_tmp);var quat=m_tsr.get_quat_value(render.world_tsr,_quat4_tmp);if(render.bb_local&&render.bb_world){m_bounds.bounding_box_transform(render.bb_local,render.world_tsr,render.bb_world);m_bounds.bounding_sphere_transform(render.bs_local,render.world_tsr,
render.bs_world);m_bounds.bounding_ellipsoid_transform(render.be_local,render.world_tsr,render.be_world)}for(var i=0;i<obj.scenes_data.length;i++){var batches=obj.scenes_data[i].batches;for(var j=0;j<batches.length;j++){var batch=batches[j];m_bounds.bounding_box_transform(batch.bb_local,render.world_tsr,batch.bb_world);m_bounds.bounding_ellipsoid_transform(batch.be_local,render.world_tsr,batch.be_world)}}switch(obj_type){case "SPEAKER":m_sfx.speaker_update_transform(obj,_elapsed);break;case "CAMERA":for(var i=
0;i<scenes_data.length;i++)m_cam.update_camera_transform(obj,scenes_data[i]);break;case "MESH":m_tsr.to_zup_model(obj.render.world_tsr,obj.render.world_zup_tsr);if(obj.need_inv_zup_tsr)m_tsr.invert(obj.render.world_zup_tsr,obj.render.world_inv_zup_tsr);var armobj=obj.armobj;if(armobj){var armobj_tsr=armobj.render.world_tsr;m_tsr.invert(armobj_tsr,_tsr_tmp);m_tsr.multiply(_tsr_tmp,render.world_tsr,_tsr_tmp);m_vec4.set(_tsr_tmp[0],_tsr_tmp[1],_tsr_tmp[2],_tsr_tmp[3],render.arm_rel_trans);m_quat.set(_tsr_tmp[4],
_tsr_tmp[5],_tsr_tmp[6],_tsr_tmp[7],render.arm_rel_quat)}render.force_zsort=true;break;case "LAMP":m_lights.update_light_transform(obj);break}for(var i=0;i<scenes_data.length;i++){var sc_data=scenes_data[i];if(sc_data.is_active){var scene=sc_data.scene;var sc_render=scene._render;var batches=sc_data.batches;switch(obj_type){case "LAMP":m_scs.update_lamp_scene(obj,scene);break;case "CAMERA":m_scs.schedule_grass_map_update(scene);if(sc_render.shadow_params){if(sc_render.shadow_params.enable_csm)m_scs.schedule_shadow_update(scene);
var cam_scene_data=m_obj_util.get_scene_data(obj,scene);var cam_main=cam_scene_data.cameras[0];m_scs.update_shadow_billboard_view(cam_main,sc_render.graph)}if(m_scs.get_active()==scene)m_sfx.listener_update_transform(scene,trans,quat,_elapsed);break;case "MESH":if(render.bb_local&&render.bb_world){if(render.shadow_cast)m_scs.schedule_shadow_update(scene);var cube_refl_subs=sc_data.cube_refl_subs;if(render.cube_reflection_id!=null&&cube_refl_subs)m_scs.update_cube_reflect_subs(cube_refl_subs,trans)}break;
case "EMPTY":m_obj.update_force(obj);break}var plane_refl_subs=sc_data.plane_refl_subs;var refl_objs=obj.reflective_objs;if(refl_objs.length)for(var j=0;j<plane_refl_subs.length;j++){var cam=plane_refl_subs[j].camera;m_scs.update_plane_reflect_subs(plane_refl_subs[j],trans,quat);m_obj_util.update_refl_objects(refl_objs,cam.reflection_plane);m_cam.set_view(cam,m_scs.get_camera(scene));m_util.extract_frustum_planes(cam.view_proj_matrix,cam.frustum_planes)}}}var cons_descends=obj.cons_descends;for(var i=
0;i<cons_descends.length;i++)update_transform(cons_descends[i]);var cons_armat_bone_descends=obj.cons_armat_bone_descends;for(var i=0;i<cons_armat_bone_descends.length;i++){var cons_armat_desc=cons_armat_bone_descends[i];var armobj=cons_armat_desc[0];var bone_name=cons_armat_desc[1];m_cons.update_bone_constraint(armobj,bone_name)}}exports.distance=function(obj1,obj2){var trans1=m_tsr.get_trans_view(obj1.render.world_tsr);var trans2=m_tsr.get_trans_view(obj2.render.world_tsr);return m_vec3.dist(trans1,
trans2)};exports.obj_point_distance=function(obj,point){var trans=m_tsr.get_trans_view(obj.render.world_tsr);return m_vec3.dist(trans,point)};exports.get_object_bounding_box=function(obj){return{max_x:obj.render.bb_world.max_x,min_x:obj.render.bb_world.min_x,max_y:obj.render.bb_world.max_y,min_y:obj.render.bb_world.min_y,max_z:obj.render.bb_world.max_z,min_z:obj.render.bb_world.min_z}}};b4w.module["__tsr"]=function(exports,require){var m_mat4=require("__mat4");var m_quat=require("__quat");var m_util=require("__util");var m_vec3=require("__vec3");var ZUP_SIN=Math.sin(-Math.PI/4);var ZUP_COS=-ZUP_SIN;var _vec3_tmp=new Float32Array(3);var _quat_tmp=new Float32Array(4);var _mat4_tmp=new Float32Array(16);exports.create=create;function create(){var tsr=new Float32Array(8);tsr[3]=1;tsr[7]=1;return tsr}exports.from_values=function(x,y,z,s,qx,qy,qz,qw){var tsr=create();tsr[0]=x;tsr[1]=y;
tsr[2]=z;tsr[3]=s;tsr[4]=qx;tsr[5]=qy;tsr[6]=qz;tsr[7]=qw;return tsr};exports.create_ext=create_ext;function create_ext(){var tsr=new Float32Array(9);tsr[3]=1;tsr[7]=1;return tsr}exports.from_values_ext=function(x,y,z,s,qx,qy,qz,qw){var tsr=create_ext();tsr[0]=x;tsr[1]=y;tsr[2]=z;tsr[3]=s;tsr[4]=qx;tsr[5]=qy;tsr[6]=qz;tsr[7]=qw;return tsr};exports.copy=copy;function copy(tsr,dest){dest[0]=tsr[0];dest[1]=tsr[1];dest[2]=tsr[2];dest[3]=tsr[3];dest[4]=tsr[4];dest[5]=tsr[5];dest[6]=tsr[6];dest[7]=tsr[7];
return dest}exports.identity=function(tsr){tsr[0]=0;tsr[1]=0;tsr[2]=0;tsr[3]=1;tsr[4]=0;tsr[5]=0;tsr[6]=0;tsr[7]=1;return tsr};exports.set_sep=set_sep;function set_sep(trans,scale,quat,dest){dest[0]=trans[0];dest[1]=trans[1];dest[2]=trans[2];dest[3]=scale;dest[4]=quat[0];dest[5]=quat[1];dest[6]=quat[2];dest[7]=quat[3];return dest}exports.set_trans=function(trans,dest){dest[0]=trans[0];dest[1]=trans[1];dest[2]=trans[2];return dest};exports.set_scale=function(scale,dest){dest[3]=scale;return dest};
exports.set_transcale=function(transcale,dest){dest[0]=transcale[0];dest[1]=transcale[1];dest[2]=transcale[2];dest[3]=transcale[3];return dest};exports.set_quat=function(quat,dest){dest[4]=quat[0];dest[5]=quat[1];dest[6]=quat[2];dest[7]=quat[3];return dest};exports.get_trans_view=function(tsr){return tsr.subarray(0,3)};exports.get_trans_value=function(tsr,dest){dest[0]=tsr[0];dest[1]=tsr[1];dest[2]=tsr[2];return dest};exports.get_scale=function(tsr){return tsr[3]};exports.get_quat_view=function(tsr){return tsr.subarray(4,
8)};exports.get_quat_value=function(tsr,dest){dest[0]=tsr[4];dest[1]=tsr[5];dest[2]=tsr[6];dest[3]=tsr[7];return dest};exports.invert=function(tsr,dest){var sc_inv=1/tsr[3];if(!sc_inv)return null;var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];_quat_tmp[0]=tsr[4];_quat_tmp[1]=tsr[5];_quat_tmp[2]=tsr[6];_quat_tmp[3]=tsr[7];m_quat.invert(_quat_tmp,_quat_tmp);var qx_inv=_quat_tmp[0];var qy_inv=_quat_tmp[1];var qz_inv=_quat_tmp[2];var qw_inv=_quat_tmp[3];var x=tx*sc_inv;var y=ty*sc_inv;var z=tz*sc_inv;var ix=
qw_inv*x+qy_inv*z-qz_inv*y;var iy=qw_inv*y+qz_inv*x-qx_inv*z;var iz=qw_inv*z+qx_inv*y-qy_inv*x;var iw=-qx_inv*x-qy_inv*y-qz_inv*z;dest[0]=-(ix*qw_inv+iw*-qx_inv+iy*-qz_inv-iz*-qy_inv);dest[1]=-(iy*qw_inv+iw*-qy_inv+iz*-qx_inv-ix*-qz_inv);dest[2]=-(iz*qw_inv+iw*-qz_inv+ix*-qy_inv-iy*-qx_inv);dest[3]=sc_inv;dest[4]=qx_inv;dest[5]=qy_inv;dest[6]=qz_inv;dest[7]=qw_inv;return dest};exports.to_mat4=function(tsr,dest){var trans=tsr.subarray(0,3);var scale=tsr[3];var quat=tsr.subarray(4,8);var mat=m_mat4.fromRotationTranslation(quat,
trans,dest);for(var i=0;i<12;i++)dest[i]*=scale;return dest};exports.from_mat4=function(mat,dest){var trans=m_util.matrix_to_trans(mat,_vec3_tmp);var scale=m_util.matrix_to_scale(mat);var quat=m_util.matrix_to_quat(mat,_quat_tmp);set_sep(trans,scale,quat,dest);return dest};exports.multiply=function(tsr,tsr2,dest){transform_vec3(tsr2,tsr,dest);dest[3]=tsr[3]*tsr2[3];var ax=tsr[4],ay=tsr[5],az=tsr[6],aw=tsr[7],bx=tsr2[4],by=tsr2[5],bz=tsr2[6],bw=tsr2[7];dest[4]=ax*bw+aw*bx+ay*bz-az*by;dest[5]=ay*bw+
aw*by+az*bx-ax*bz;dest[6]=az*bw+aw*bz+ax*by-ay*bx;dest[7]=aw*bw-ax*bx-ay*by-az*bz;return dest};exports.transform_mat4=transform_mat4;function transform_mat4(matrix,tsr,dest){var trans=tsr.subarray(0,3);var scale=tsr[3];var quat=tsr.subarray(4,8);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);for(var i=0;i<12;i++)m[i]*=scale;m_mat4.multiply(m,matrix,dest);return dest}exports.transform_vec3=transform_vec3;function transform_vec3(vec,tsr,dest){var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=
tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;dest[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[0]+=tx;dest[1]+=ty;dest[2]+=tz;return dest}exports.transform_vec3_inv=function(vec,tsr,dest){var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var x=vec[0]-tx;var y=vec[1]-ty;
var z=vec[2]-tz;var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var dot=qx*qx+qy*qy+qz*qz+qw*qw;var inv_dot=dot?1/dot:0;qx=-qx*inv_dot;qy=-qy*inv_dot;qz=-qz*inv_dot;qw=qw*inv_dot;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;dest[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[0]/=scale;dest[1]/=scale;dest[2]/=scale;return dest};exports.transform_vectors=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=
0;var len=vectors.length;var tx=tsr[0];var ty=tsr[1];var tz=tsr[2];var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=3){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;new_vectors[dest_offset+
i]+=tx;new_vectors[dest_offset+i+1]+=ty;new_vectors[dest_offset+i+2]+=tz}return new_vectors};exports.transform_dir_vectors=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=3){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+
i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx}return new_vectors};exports.transform_dir_vec3=function(vec,tsr,new_vec){var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vec[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;new_vec[1]=iy*qw+iw*-qy+iz*-qx-
ix*-qz;new_vec[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return new_vec};exports.transform_tangents=function(vectors,tsr,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];for(var i=0;i<len;i+=4){var x=vectors[i]*scale;var y=vectors[i+1]*scale;var z=vectors[i+2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;new_vectors[dest_offset+i]=ix*qw+iw*-qx+iy*-qz-iz*-qy;
new_vectors[dest_offset+i+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;new_vectors[dest_offset+i+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;new_vectors[dest_offset+i+3]=vectors[i+3]}return new_vectors};exports.translate=function(tsr,vec,dest){var scale=tsr[3];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];var x=vec[0]*scale;var y=vec[1]*scale;var z=vec[2]*scale;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;dest[0]=tsr[0]+ix*qw+iw*-qx+iy*-qz-iz*-qy;dest[1]=tsr[1]+iy*qw+iw*-qy+
iz*-qx-ix*-qz;dest[2]=tsr[2]+iz*qw+iw*-qz+ix*-qy-iy*-qx;dest[3]=tsr[3];dest[4]=tsr[4];dest[5]=tsr[5];dest[6]=tsr[6];dest[7]=tsr[7];return dest};exports.interpolate=function(tsr,tsr2,factor,dest){var trans=tsr.subarray(0,3);var trans2=tsr2.subarray(0,3);var trans_dst=dest.subarray(0,3);m_vec3.lerp(trans,trans2,factor,trans_dst);var scale=tsr[3];var scale2=tsr2[3];dest[3]=scale+factor*(scale2-scale);var quat=tsr.subarray(4,8);var quat2=tsr2.subarray(4,8);var quat_dst=dest.subarray(4,8);m_quat.slerp(quat,
quat2,factor,quat_dst);return dest};exports.extrapolate=function(tsr,tsr2,factor,dest){var trans=tsr.subarray(0,3);var trans2=tsr2.subarray(0,3);var trans_dst=dest.subarray(0,3);trans_dst[0]=trans2[0]*(factor+1)-trans[0]*factor;trans_dst[1]=trans2[1]*(factor+1)-trans[1]*factor;trans_dst[2]=trans2[2]*(factor+1)-trans[2]*factor;var scale=tsr[3];var scale2=tsr2[3];dest[3]=scale2*(factor+1)-scale*factor;var quat=tsr.subarray(4,8);var quat2=tsr2.subarray(4,8);var quat_dst=dest.subarray(4,8);quat_dst[0]=
quat2[0]*(factor+1)-quat[0]*factor;quat_dst[1]=quat2[1]*(factor+1)-quat[1]*factor;quat_dst[2]=quat2[2]*(factor+1)-quat[2]*factor;quat_dst[3]=quat2[3]*(factor+1)-quat[3]*factor;m_quat.normalize(quat_dst,quat_dst);return dest};exports.integrate=function(tsr,time,linvel,angvel,dest){dest[0]=tsr[0]+time*linvel[0];dest[1]=tsr[1]+time*linvel[1];dest[2]=tsr[2]+time*linvel[2];dest[3]=tsr[3];tsr_quat_deriv_angvel(tsr,angvel,dest);dest[4]=tsr[4]+dest[4]*time;dest[5]=tsr[5]+dest[5]*time;dest[6]=tsr[6]+dest[6]*
time;dest[7]=tsr[7]+dest[7]*time;tsr_quat_normalize(dest,dest)};function tsr_quat_deriv_angvel(tsr,angvel,dest){var wx=angvel[0];var wy=angvel[1];var wz=angvel[2];var qx=tsr[4];var qy=tsr[5];var qz=tsr[6];var qw=tsr[7];dest[4]=.5*(wx*qw+wy*qz-wz*qy);dest[5]=.5*(wy*qw+wz*qx-wx*qz);dest[6]=.5*(wz*qw+wx*qy-wy*qx);dest[7]=.5*(-wx*qx-wy*qy-wz*qz)}function tsr_quat_normalize(tsr,dest){var x=tsr[4];var y=tsr[5];var z=tsr[6];var w=tsr[7];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);dest[4]=tsr[4]*
len;dest[5]=tsr[5]*len;dest[6]=tsr[6]*len;dest[7]=tsr[7]*len}}exports.to_zup_view=function(tsr,dest){dest[0]=tsr[0];dest[1]=tsr[1];dest[2]=tsr[2];dest[3]=tsr[3];var ax=tsr[4],ay=tsr[5],az=tsr[6],aw=tsr[7];var bx=ZUP_SIN,bw=ZUP_COS;dest[4]=ax*bw+aw*bx;dest[5]=ay*bw+az*bx;dest[6]=az*bw-ay*bx;dest[7]=aw*bw-ax*bx};exports.to_zup_model=function(tsr,dest){dest[0]=tsr[0];dest[1]=-tsr[2];dest[2]=tsr[1];dest[3]=tsr[3];dest[4]=tsr[4];dest[5]=-tsr[6];dest[6]=tsr[5];dest[7]=tsr[7]}};b4w.module["__util"]=function(exports,require){var m_bounds=require("__boundings");var m_mat3=require("__mat3");var m_mat4=require("__mat4");var m_math=require("__math");var m_print=require("__print");var m_tsr=require("__tsr");var m_quat=require("__quat");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var _unique_counter=0;var _unique_name_counters={};var PROPER_EULER_ANGLES_LIST=[XYX,YZY,ZXZ,YXY,ZYZ];var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec4_tmp=new Float32Array(4);
var _vec4_tmp2=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _mat4_tmp=new Float32Array(16);var _mat4_tmp2=new Float32Array(16);var _hash_buffer_in=new Float64Array(1);var _hash_buffer_out=new Uint32Array(_hash_buffer_in.buffer);var VEC3_IDENT=new Float32Array([0,0,0]);var QUAT4_IDENT=new Float32Array([0,0,0,1]);var TSR8_IDENT=new Float32Array([0,0,0,1,0,0,0,1]);var VEC3_UNIT=new Float32Array([1,1,1]);var AXIS_X=new Float32Array([1,0,0]);var AXIS_Y=new Float32Array([0,1,0]);var AXIS_Z=
new Float32Array([0,0,1]);var AXIS_MX=new Float32Array([-1,0,0]);var AXIS_MY=new Float32Array([0,-1,0]);var AXIS_MZ=new Float32Array([0,0,-1]);var XYX=0;var YZY=1;var ZXZ=2;var XZX=3;var YXY=4;var ZYZ=5;var XYZ=6;var YZX=7;var ZXY=8;var XZY=9;var YXZ=10;var ZYX=11;var DEFAULT_SEED=5E4;var RAND_A=48271;var RAND_M=2147483647;var RAND_R=RAND_M%RAND_A;var RAND_Q=Math.floor(RAND_M/RAND_A);var MIN_CLAMPING_INTERVAL=.001;var INV_CUBE_VIEW_MATRS=[new Float32Array([0,0,-1,0,0,-1,0,0,-1,0,0,0,0,0,0,1]),new Float32Array([0,
0,1,0,0,-1,0,0,1,0,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]),new Float32Array([1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1]),new Float32Array([-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1])];var GAMMA=2.2;exports.VEC3_IDENT=VEC3_IDENT;exports.QUAT4_IDENT=QUAT4_IDENT;exports.TSR8_IDENT=TSR8_IDENT;exports.VEC3_UNIT=VEC3_UNIT;exports.AXIS_X=AXIS_X;exports.AXIS_Y=AXIS_Y;exports.AXIS_Z=AXIS_Z;exports.AXIS_MX=AXIS_MX;exports.AXIS_MY=AXIS_MY;exports.AXIS_MZ=
AXIS_MZ;exports.XYX=XYX;exports.YZY=YZY;exports.ZXZ=ZXZ;exports.XZX=XZX;exports.YXY=YXY;exports.ZYZ=ZYZ;exports.XYZ=XYZ;exports.YZX=YZX;exports.ZXY=ZXY;exports.XZY=XZY;exports.YXZ=YXZ;exports.ZYX=ZYX;exports.INV_CUBE_VIEW_MATRS=INV_CUBE_VIEW_MATRS;exports.isdef=function(v){return typeof v!="undefined"};exports.keyfind=keyfind;function keyfind(key,value,array){var results=[];var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value)results.push(obj)}return results}exports.float32_concat=
function(first,second){var firstLength=first.length;var result=new Float32Array(firstLength+second.length);result.set(first);result.set(second,firstLength);return result};exports.uint32_concat=function(first,second){var firstLength=first.length;var result=new Uint32Array(firstLength+second.length);result.set(first);result.set(second,firstLength);return result};exports.check_endians=function(){var value=255;var x=new Uint16Array([value]);var dataview=new DataView(x.buffer);return dataview.getUint16(0,
true)==value};exports.array_intersect=function(arr1,arr2){var r=[],o={},l=arr2.length,i,v;for(i=0;i<l;i++)o[arr2[i]]=true;l=arr1.length;for(i=0;i<l;i++){v=arr1[i];if(v in o)r.push(v)}return r};exports.sign=sign;function sign(value){return value>0?1:value<0?-1:0}exports.keycheck=function(key,value,array){var len=array.length;for(var i=0;i<len;i++){var obj=array[i];if(obj[key]==value)return true}return false};exports.keysearch=function(key,value,array){for(var i=0;i<array.length;i++){var obj=array[i];
if(obj[key]===value)return obj}return null};exports.key2search=function(key1,value1,key2,value2,array){for(var i=0;i<array.length;i++){var obj=array[i];if(obj[key1]==value1&&obj[key2]==value2)return obj}return null};exports.get_index_for_key_value=function(array,key,value){for(var i=0;i<array.length;i++)if(array[i][key]==value)return i;return-1};exports.append_unique=function(array,value){for(var i=0;i<array.length;i++)if(array[i]==value)return;array.push(value)};exports.check_uniqueness=function(array){for(var i=
0;i<array.length-1;i++){var elem_i=array[i];for(var j=i+1;j<array.length;j++){var elem_j=array[j];if(elem_i==elem_j)return false}}return true};exports.trans_matrix=function(x,y,z,dest){if(!dest)var dest=new Float32Array(16);m_mat4.identity(dest);dest[12]=x;dest[13]=y;dest[14]=z;return dest};var _next=1;exports.rand=function(){_next=(_next*69069+5)%Math.pow(2,32);return Math.round(_next/65536)%32768/32767};exports.srand=function(seed){_next=seed};exports.rand_r=function(seedp){var high=Math.floor(seedp[0]/
RAND_Q);var low=seedp[0]%RAND_Q;var test=RAND_A*low-RAND_R*high;if(test>0)seedp[0]=test;else seedp[0]=test+RAND_M;return(seedp[0]-1)/(RAND_M-1)};exports.init_rand_r_seed=function(seed_number,dest){if(!dest)dest=[];dest[0]=DEFAULT_SEED+Math.floor(seed_number);return dest};exports.euler_to_quat=function(euler,quat){if(!quat)quat=new Float32Array(4);var c1=Math.cos(euler[1]/2);var c2=Math.cos(euler[2]/2);var c3=Math.cos(euler[0]/2);var s1=Math.sin(euler[1]/2);var s2=Math.sin(euler[2]/2);var s3=Math.sin(euler[0]/
2);quat[0]=c1*c2*s3+s1*s2*c3;quat[1]=s1*c2*c3+c1*s2*s3;quat[2]=c1*s2*c3-s1*c2*s3;quat[3]=c1*c2*c3-s1*s2*s3;return quat};exports.ordered_angles_to_quat=function(angles,order,quat){var alpha=angles[0];var beta=angles[1];var gamma=angles[2];var c1=Math.cos(alpha/2);var c2=Math.cos(beta/2);var c3=Math.cos(gamma/2);var s1=Math.sin(alpha/2);var s2=Math.sin(beta/2);var s3=Math.sin(gamma/2);if(PROPER_EULER_ANGLES_LIST.indexOf(order)>-1){var c13=Math.cos((alpha+gamma)/2);var s13=Math.sin((alpha+gamma)/2);
var c1_3=Math.cos((alpha-gamma)/2);var s1_3=Math.sin((alpha-gamma)/2);var c3_1=Math.cos((gamma-alpha)/2);var s3_1=Math.sin((gamma-alpha)/2)}switch(order){case XYX:quat[0]=c2*s13;quat[1]=s2*c1_3;quat[2]=s2*s1_3;quat[3]=c2*c13;break;case YZY:quat[0]=s2*s1_3;quat[1]=c2*s13;quat[2]=s2*c1_3;quat[3]=c2*c13;break;case ZXZ:quat[0]=s2*c1_3;quat[1]=s2*s1_3;quat[2]=c2*s13;quat[3]=c2*c13;break;case XZX:quat[0]=c2*s13;quat[1]=s2*s3_1;quat[2]=s2*c3_1;quat[3]=c2*c13;break;case YXY:quat[0]=s2*c3_1;quat[1]=c2*s13;
quat[2]=s2*s3_1;quat[3]=c2*c13;break;case ZYZ:quat[0]=s2*s3_1;quat[1]=s2*c3_1;quat[2]=c2*s13;quat[3]=c2*c13;break;case XYZ:quat[0]=s1*c2*c3+c1*s2*s3;quat[1]=c1*s2*c3-s1*c2*s3;quat[2]=c1*c2*s3+s1*s2*c3;quat[3]=c1*c2*c3-s1*s2*s3;break;case YZX:quat[0]=c1*c2*s3+s1*s2*c3;quat[1]=s1*c2*c3+c1*s2*s3;quat[2]=c1*s2*c3-s1*c2*s3;quat[3]=c1*c2*c3-s1*s2*s3;break;case ZXY:quat[0]=c1*s2*c3-s1*c2*s3;quat[1]=c1*c2*s3+s1*s2*c3;quat[2]=s1*c2*c3+c1*s2*s3;quat[3]=c1*c2*c3-s1*s2*s3;break;case XZY:quat[0]=s1*c2*c3-c1*s2*
s3;quat[1]=c1*c2*s3-s1*s2*c3;quat[2]=c1*s2*c3+s1*c2*s3;quat[3]=c1*c2*c3+s1*s2*s3;break;case YXZ:quat[0]=c1*s2*c3+s1*c2*s3;quat[1]=s1*c2*c3-c1*s2*s3;quat[2]=c1*c2*s3-s1*s2*c3;quat[3]=c1*c2*c3+s1*s2*s3;break;case ZYX:quat[0]=c1*c2*s3-s1*s2*c3;quat[1]=c1*s2*c3+s1*c2*s3;quat[2]=s1*c2*c3-c1*s2*s3;quat[3]=c1*c2*c3+s1*s2*s3;break}return quat};exports.quat_to_ordered_angles=function(q,order,angles){var x=q[0],y=q[1],z=q[2],w=q[3];switch(order){case XYX:angles[0]=Math.atan2(x*y+z*w,y*w-x*z);angles[1]=Math.acos(1-
2*(y*y+z*z));angles[2]=Math.atan2(x*y-z*w,x*z+y*w);break;case YZY:angles[0]=Math.atan2(x*w+y*z,z*w-x*y);angles[1]=Math.acos(1-2*(x*x+z*z));angles[2]=Math.atan2(y*z-x*w,x*y+z*w);break;case ZXZ:angles[0]=Math.atan2(x*z+y*w,x*w-y*z);angles[1]=Math.acos(1-2*(x*x+y*y));angles[2]=Math.atan2(x*z-y*w,x*w+y*z);break;case XZX:angles[0]=Math.atan2(x*z-y*w,x*y+z*w);angles[1]=Math.acos(1-2*(y*y+z*z));angles[2]=Math.atan2(x*z+y*w,z*w-x*y);break;case YXY:angles[0]=Math.atan2(x*y-z*w,x*w+y*z);angles[1]=Math.acos(1-
2*(x*x+z*z));angles[2]=Math.atan2(x*y+z*w,x*w-y*z);break;case ZYZ:angles[0]=Math.atan2(y*z-x*w,x*z+y*w);angles[1]=Math.acos(1-2*(x*x+y*y));angles[2]=Math.atan2(x*w+y*z,y*w-x*z);break;case XYZ:angles[0]=Math.atan2(2*(x*w-y*z),1-2*(x*x+y*y));angles[1]=Math.asin(2*(x*z+y*w));angles[2]=Math.atan2(2*(z*w-x*y),1-2*(y*y+z*z));break;case YZX:angles[0]=Math.atan2(2*(y*w-x*z),1-2*(y*y+z*z));angles[1]=Math.asin(2*(x*y+z*w));angles[2]=Math.atan2(2*(x*w-y*z),1-2*(x*x+z*z));break;case ZXY:angles[0]=Math.atan2(2*
(z*w-x*y),1-2*(x*x+z*z));angles[1]=Math.asin(2*(x*w+y*z));angles[2]=Math.atan2(2*(y*w-x*z),1-2*(x*x+y*y));break;case XZY:angles[0]=Math.atan2(2*(x*w+y*z),1-2*(x*x+z*z));angles[1]=Math.asin(2*(z*w-x*y));angles[2]=Math.atan2(2*(x*z+y*w),1-2*(y*y+z*z));break;case YXZ:angles[0]=Math.atan2(2*(x*z+y*w),1-2*(x*x+y*y));angles[1]=Math.asin(2*(x*w-y*z));angles[2]=Math.atan2(2*(x*y+z*w),1-2*(x*x+z*z));break;case ZYX:angles[0]=Math.atan2(2*(x*y+z*w),1-2*(y*y+z*z));angles[1]=Math.asin(2*(y*w-x*z));angles[2]=Math.atan2(2*
(x*w+y*z),1-2*(x*x+y*y));break}return angles};exports.euler_to_rotation_matrix=function(euler){var matrix=m_mat3.create();var cosX=Math.cos(euler[0]);var cosY=Math.cos(euler[1]);var cosZ=Math.cos(euler[2]);var sinX=Math.sin(euler[0]);var sinY=Math.sin(euler[1]);var sinZ=Math.sin(euler[2]);var cosXcosZ=cosX*cosZ;var cosXsinZ=cosX*sinZ;var sinXcosZ=sinX*cosZ;var sinXsinZ=sinX*sinZ;matrix[0]=cosY*cosZ;matrix[1]=cosY*sinZ;matrix[2]=-sinY;matrix[3]=sinY*sinXcosZ-cosXsinZ;matrix[4]=sinY*sinXsinZ+cosXcosZ;
matrix[5]=cosY*sinX;matrix[6]=sinY*cosXcosZ+sinXsinZ;matrix[7]=sinY*cosXsinZ-sinXcosZ;matrix[8]=cosY*cosX;return matrix};exports.quat_to_euler=function(quat,euler){var qx=quat[0];var qy=quat[1];var qz=quat[2];var qw=quat[3];var qw2=qw*qw;var qx2=qx*qx;var qy2=qy*qy;var qz2=qz*qz;var test=qx*qy+qz*qw;if(test>.499999){euler[0]=0;euler[1]=2*Math.atan2(qx,qw);euler[2]=Math.PI/2}else if(test<-.499999){euler[0]=0;euler[1]=-2*Math.atan2(qx,qw);euler[2]=-Math.PI/2}else{euler[0]=Math.atan2(2*qx*qw-2*qy*qz,
1-2*qx2-2*qz2);euler[1]=Math.atan2(2*qy*qw-2*qx*qz,1-2*qy2-2*qz2);euler[2]=Math.asin(2*qx*qy+2*qz*qw)}return euler};exports.quat_to_dir=function(quat,ident,dest){if(!dest)var dest=new Float32Array(3);m_vec3.transformQuat(ident,quat,dest);return dest};exports.dir_to_quat=function(dir,ident,dest){if(!dest)var dest=new Float32Array(4);var dir=m_vec3.normalize(dir,_vec3_tmp);var dot=m_vec3.dot(ident,dir);var A=m_vec3.cross(ident,dir,_vec3_tmp2);var teta=Math.acos(dot);dest[0]=A[0]*Math.sin(teta/2);dest[1]=
A[1]*Math.sin(teta/2);dest[2]=A[2]*Math.sin(teta/2);dest[3]=Math.cos(teta/2);return dest};exports.trans_quat_to_plane=function(trans,quat,ident,dest){if(!dest)var dest=new Float32Array(4);m_vec3.transformQuat(ident,quat,dest);dest[3]=-m_vec3.dot(trans,dest);return dest};exports.dir_ground_proj_angle=function(obj){var render=obj.render;var quat=m_tsr.get_quat_view(render.world_tsr);var proj=_vec3_tmp;var defdir=_vec3_tmp2;switch(obj.type){case "CAMERA":proj[0]=0;proj[1]=-1;proj[2]=0;m_vec3.transformQuat(proj,
quat,proj);defdir[0]=0;defdir[1]=0;defdir[2]=-1;break;case "MESH":proj[0]=0;proj[1]=0;proj[2]=1;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=0;defdir[2]=1;break;case "EMPTY":proj[0]=0;proj[1]=1;proj[2]=0;m_vec3.transformQuat(proj,quat,proj);defdir[0]=0;defdir[1]=1;defdir[2]=0;break}proj[1]=0;m_vec3.normalize(proj,proj);var cos=m_vec3.dot(proj,defdir);var sign=-proj[0]*defdir[2]>0?-1:1;var angle=Math.acos(cos)*sign;return angle};exports.blend_arrays=blend_arrays;function blend_arrays(a1,
a2,f,dest){if(f==0)return a1;dest=dest||[];for(var i=0;i<a1.length;i++)dest[i]=(1-f)*a1[i]+f*a2[i];return dest}exports.unique_id=function(){_unique_counter++;return _unique_counter.toString(16)};exports.unique_name=function(name_base){if(!_unique_name_counters[name_base])_unique_name_counters[name_base]=0;var name=name_base+_unique_name_counters[name_base];_unique_name_counters[name_base]++;return name};exports.create_empty_va_frame=function(){var va_frame={"a_position":new Float32Array(0),"a_tangent":new Float32Array(0),
"a_normal":new Float32Array(0)};return va_frame};exports.create_empty_submesh=function(name){var va_common={"a_influence":new Float32Array(0),"a_color":new Float32Array(0),"a_texcoord":new Float32Array(0)};return{name:name,base_length:0,indices:null,va_frames:[],va_common:va_common,shape_keys:[],submesh_bd:{bb_world:m_bounds.zero_bounding_box(),be_world:m_bounds.zero_bounding_ellipsoid(),bb_local:m_bounds.zero_bounding_box(),be_local:m_bounds.zero_bounding_ellipsoid()}}};exports.clone_object_json=
function(obj){return JSON.parse(JSON.stringify(obj))};exports.clone_object_r=function(obj){if(!(obj instanceof Object))return obj;var obj_clone;var Constructor=obj.constructor;switch(Constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:obj_clone=new Constructor(obj);break;case Array:obj_clone=new Constructor(obj.length);for(var i=0;i<obj.length;i++)obj_clone[i]=exports.clone_object_r(obj[i]);break;default:obj_clone=
new Constructor;for(var prop in obj)obj_clone[prop]=exports.clone_object_r(obj[prop]);break}return obj_clone};exports.clone_object_nr=function(obj){var new_obj=obj instanceof Array?[]:{};for(var prop in obj)if(obj[prop]instanceof Object){var Constructor=obj[prop].constructor;switch(Constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:new_obj[prop]=new Constructor(obj[prop]);break;case Array:new_obj[prop]=
obj[prop].slice(0);break;default:new_obj[prop]=obj[prop];break}}else new_obj[prop]=obj[prop];return new_obj};exports.matrix_to_quat=matrix_to_quat;function matrix_to_quat(matrix,dest){if(!dest)var dest=new Float32Array(4);m_mat3.fromMat4(matrix,_mat3_tmp);var m0=_mat3_tmp[0];var m3=_mat3_tmp[3];var m6=_mat3_tmp[6];var m1=_mat3_tmp[1];var m4=_mat3_tmp[4];var m7=_mat3_tmp[7];var m2=_mat3_tmp[2];var m5=_mat3_tmp[5];var m8=_mat3_tmp[8];var l0=Math.sqrt(m0*m0+m3*m3+m6*m6)||1;var l1=Math.sqrt(m1*m1+m4*
m4+m7*m7)||1;var l2=Math.sqrt(m2*m2+m5*m5+m8*m8)||1;_mat3_tmp[0]/=l0;_mat3_tmp[3]/=l0;_mat3_tmp[6]/=l0;_mat3_tmp[1]/=l1;_mat3_tmp[4]/=l1;_mat3_tmp[7]/=l1;_mat3_tmp[2]/=l2;_mat3_tmp[5]/=l2;_mat3_tmp[8]/=l2;m_quat.fromMat3(_mat3_tmp,dest);m_quat.normalize(dest,dest);return dest}exports.matrix_to_trans=function(matrix,dest){if(!dest)var dest=new Float32Array(3);dest[0]=matrix[12];dest[1]=matrix[13];dest[2]=matrix[14];return dest};exports.matrix_to_scale=function(matrix){_vec4_tmp[0]=.577350269189626;
_vec4_tmp[1]=.577350269189626;_vec4_tmp[2]=.577350269189626;_vec4_tmp[3]=0;m_vec4.transformMat4(_vec4_tmp,matrix,_vec4_tmp);return m_vec4.length(_vec4_tmp)};exports.extract_frustum_planes=function(m,planes){var left=planes.left;var right=planes.right;var top=planes.top;var bottom=planes.bottom;var near=planes.near;var far=planes.far;left[0]=m[3]+m[0];left[1]=m[7]+m[4];left[2]=m[11]+m[8];left[3]=m[15]+m[12];right[0]=m[3]-m[0];right[1]=m[7]-m[4];right[2]=m[11]-m[8];right[3]=m[15]-m[12];top[0]=m[3]-
m[1];top[1]=m[7]-m[5];top[2]=m[11]-m[9];top[3]=m[15]-m[13];bottom[0]=m[3]+m[1];bottom[1]=m[7]+m[5];bottom[2]=m[11]+m[9];bottom[3]=m[15]+m[13];near[0]=m[3]+m[2];near[1]=m[7]+m[6];near[2]=m[11]+m[10];near[3]=m[15]+m[14];far[0]=m[3]-m[2];far[1]=m[7]-m[6];far[2]=m[11]-m[10];far[3]=m[15]-m[14];normalize_plane(left);normalize_plane(right);normalize_plane(top);normalize_plane(bottom);normalize_plane(near);normalize_plane(far);return planes};function normalize_plane(plane){var a=plane[0],b=plane[1],c=plane[2],
d=plane[3];var len=Math.sqrt(a*a+b*b+c*c);len=1/len;plane[0]=a*len;plane[1]=b*len;plane[2]=c*len;plane[3]=d*len}exports.sphere_is_out_of_frustum=function(pt,planes,radius){if(radius<-m_math.point_plane_dist(pt,planes.left)||radius<-m_math.point_plane_dist(pt,planes.right)||radius<-m_math.point_plane_dist(pt,planes.top)||radius<-m_math.point_plane_dist(pt,planes.bottom)||radius<-m_math.point_plane_dist(pt,planes.near)||radius<-m_math.point_plane_dist(pt,planes.far))return true;else return false};exports.ellipsoid_is_out_of_frustum=
function(pt,planes,axis_x,axis_y,axis_z){dot_nx=m_vec3.dot(axis_x,planes.far);dot_ny=m_vec3.dot(axis_y,planes.far);dot_nz=m_vec3.dot(axis_z,planes.far);var r_far=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_far<-m_math.point_plane_dist(pt,planes.near)||r_far<-m_math.point_plane_dist(pt,planes.far))return true;var dot_nx=m_vec3.dot(axis_x,planes.left);var dot_ny=m_vec3.dot(axis_y,planes.left);var dot_nz=m_vec3.dot(axis_z,planes.left);var r_left=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*
dot_nz);if(r_left<-m_math.point_plane_dist(pt,planes.left))return true;dot_nx=m_vec3.dot(axis_x,planes.right);dot_ny=m_vec3.dot(axis_y,planes.right);dot_nz=m_vec3.dot(axis_z,planes.right);var r_right=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_right<-m_math.point_plane_dist(pt,planes.right))return true;dot_nx=m_vec3.dot(axis_x,planes.top);dot_ny=m_vec3.dot(axis_y,planes.top);dot_nz=m_vec3.dot(axis_z,planes.top);var r_top=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_top<
-m_math.point_plane_dist(pt,planes.top))return true;dot_nx=m_vec3.dot(axis_x,planes.bottom);dot_ny=m_vec3.dot(axis_y,planes.bottom);dot_nz=m_vec3.dot(axis_z,planes.bottom);var r_bott=Math.sqrt(dot_nx*dot_nx+dot_ny*dot_ny+dot_nz*dot_nz);if(r_bott<-m_math.point_plane_dist(pt,planes.bottom))return true;return false};exports.positions_multiply_matrix=function(positions,matrix,new_positions,dest_offset){if(!dest_offset)var dest_offset=0;var len=positions.length;for(var i=0;i<len;i+=3){var x=positions[i];
var y=positions[i+1];var z=positions[i+2];new_positions[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*z+matrix[12];new_positions[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z+matrix[13];new_positions[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z+matrix[14]}return new_positions};exports.vectors_multiply_matrix=function(vectors,matrix,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;for(var i=0;i<len;i+=3){var x=vectors[i];var y=vectors[i+1];var z=
vectors[i+2];new_vectors[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*z;new_vectors[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z;new_vectors[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z}return new_vectors};exports.tangents_multiply_matrix=function(vectors,matrix,new_vectors,dest_offset){if(!dest_offset)var dest_offset=0;var len=vectors.length;for(var i=0;i<len;i+=4){var x=vectors[i];var y=vectors[i+1];var z=vectors[i+2];new_vectors[dest_offset+i]=matrix[0]*x+matrix[4]*y+matrix[8]*
z;new_vectors[dest_offset+i+1]=matrix[1]*x+matrix[5]*y+matrix[9]*z;new_vectors[dest_offset+i+2]=matrix[2]*x+matrix[6]*y+matrix[10]*z;new_vectors[dest_offset+i+3]=vectors[i+3]}return new_vectors};exports.vecdir_multiply_matrix=function(vec,matrix,dest){if(!dest)var dest=new Float32Array(3);var v4=_vec4_tmp;v4[0]=vec[0];v4[1]=vec[1];v4[2]=vec[2];v4[3]=0;m_vec4.transformMat4(v4,matrix,v4);dest[0]=v4[0];dest[1]=v4[1];dest[2]=v4[2]};exports.flatten=function(array,dest){var len=array.length;if(!len)throw"flatten(): Wrong or empty array";
var len0=array[0].length;if(!len0)throw"flatten(): Wrong or empty subarray";if(!dest)var dest=new Float32Array(len*len0);for(var i=0;i<len;i++)for(var j=0;j<len0;j++)dest[i*len0+j]=array[i][j];return dest};exports.vectorize=function(array,dest){if(!dest)var dest=[];for(var i=0;i<array.length;i+=3){var v3=new Float32Array([array[i],array[i+1],array[i+2]]);dest[i/3]=v3}return dest};exports.binary_search_max=function(arr,max,start,end){if(end<start)return start;var mid=start+Math.floor((end-start)/2);
if(arr[mid]>max)return exports.binary_search_max(arr,max,start,mid-1);else if(arr[mid]<max)return exports.binary_search_max(arr,max,mid+1,end);else return mid};exports.cmp_arr=function(arr_1,arr_2){for(var i=0;i<arr_1.length;i++)if(arr_1[i]!=arr_2[i])return false;return true};exports.cmp_arr_float=function(arr_1,arr_2,precision){for(var i=0;i<arr_1.length;i++)if(Math.abs(arr_1[i]-arr_2[i])>precision)return false;return true};exports.scale_mat4=function(matrix,scale,dest){if(!dest)var dest=new Float32Array(16);
for(var i=0;i<12;i++)dest[i]=matrix[i]*scale;dest[12]=matrix[12];dest[13]=matrix[13];dest[14]=matrix[14];dest[15]=matrix[15];return dest};exports.transform_mat4=function(matrix,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(16);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_mat4.multiply(m,matrix,dest);return dest};exports.transform_vec3=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(3);var m1=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);if(scale!==
1){var m2=m_mat4.identity(_mat4_tmp2);var s=m_vec3.set(scale,scale,scale,_vec3_tmp);m_mat4.scale(m2,s,m2);m_mat4.multiply(m1,m2,m1)}m_vec3.transformMat4(vec,m1,dest);return dest};exports.transform_vec4=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(4);var m=m_mat4.fromRotationTranslation(quat,trans,_mat4_tmp);m_vec4.transformMat4(vec,m,dest);return dest};exports.inverse_transform_vec3=function(vec,scale,quat,trans,dest){if(!dest)var dest=new Float32Array(3);var m=m_mat4.fromRotationTranslation(quat,
trans,_mat4_tmp);m_mat4.invert(m,m);m_vec3.transformMat4(vec,m,dest);return dest};exports.transcale_quat_to_matrix=function(trans,quat,dest){if(!dest)var dest=new Float32Array(16);m_mat4.fromRotationTranslation(quat,trans,dest);var scale=trans[3];for(var i=0;i<12;i++)dest[i]*=scale;return dest};exports.matrix_to_transcale_quat=function(matrix,dest_transcale,dest_quat){exports.matrix_to_trans(matrix,dest_transcale);dest_transcale[3]=exports.matrix_to_scale(matrix);exports.matrix_to_quat(matrix,dest_quat)};
exports.array_stringify=function(array){var out=[];for(var i=0;i<array.length;i++)out.push(array[i]);return JSON.stringify(out)};exports.rotate_point_pivot=function(point,pivot,quat,dest){if(!dest)var dest=new Float32Array(3);var point_rel=_vec3_tmp;m_vec3.subtract(pivot,point,point_rel);m_vec3.transformQuat(point_rel,quat,point_rel);m_vec3.subtract(pivot,point_rel,dest)};exports.generate_cubemap_matrices=function(){var eye_pos=_vec3_tmp;eye_pos[0]=0;eye_pos[1]=0;eye_pos[2]=0;var x_pos=new Float32Array(16);
var x_neg=new Float32Array(16);var y_pos=new Float32Array(16);var y_neg=new Float32Array(16);var z_pos=new Float32Array(16);var z_neg=new Float32Array(16);m_mat4.lookAt(eye_pos,[-1,0,0],[0,-1,0],x_pos);m_mat4.scale(x_pos,[-1,1,1],x_pos);m_mat4.scale(x_pos,[-1,1,-1],x_neg);m_mat4.lookAt(eye_pos,[0,-1,0],[0,0,-1],y_pos);m_mat4.scale(y_pos,[1,1,-1],y_pos);m_mat4.scale(y_pos,[1,-1,-1],y_neg);m_mat4.lookAt(eye_pos,[0,0,-1],[0,-1,0],z_pos);m_mat4.scale(z_pos,[-1,1,1],z_pos);m_mat4.scale(z_pos,[-1,1,-1],
z_neg);return[x_pos,x_neg,y_pos,y_neg,z_pos,z_neg]};exports.generate_inv_cubemap_matrices=function(){var eye_pos=_vec3_tmp;eye_pos[0]=0;eye_pos[1]=0;eye_pos[2]=0;var x_pos=new Float32Array(16);var x_neg=new Float32Array(16);var y_pos=new Float32Array(16);var y_neg=new Float32Array(16);var z_pos=new Float32Array(16);var z_neg=new Float32Array(16);m_mat4.lookAt(eye_pos,[1,0,0],[0,-1,0],x_pos);m_mat4.scale(x_pos,[-1,1,-1],x_neg);m_mat4.lookAt(eye_pos,[0,1,0],[0,0,1],y_pos);m_mat4.scale(y_pos,[1,-1,-1],
y_neg);m_mat4.lookAt(eye_pos,[0,0,1],[0,-1,0],z_pos);m_mat4.scale(z_pos,[-1,1,-1],z_neg);return[x_pos,x_neg,y_pos,y_neg,z_pos,z_neg]};exports.calc_variable_id=function(a,init_val){return hash_code(a,init_val)};exports.hash_code=hash_code;function hash_code(a,init_val){var hash=init_val;switch(typeof a){case "number":return hash_code_number(a,hash);case "string":return hash_code_string(a,hash);case "boolean":return hash_code_number(a|0,hash);case "function":case "undefined":return hash_code_number(0,
hash);case "object":if(a){switch(a.constructor){case WebGLUniformLocation:case WebGLProgram:case WebGLShader:case WebGLFramebuffer:case WebGLTexture:case WebGLBuffer:return hash_code_number(0,hash)}var is_typed_arr=a.buffer instanceof ArrayBuffer&&a.byteLength!=="undefined";if(is_typed_arr)for(var i=0;i<a.length;i++)hash=hash_code_number(a[i],hash);else if(a instanceof Array)for(var i=0;i<a.length;i++)hash=hash_code(a[i],hash);else for(var prop in a)hash=hash_code(a[prop],hash)}else hash=hash_code_number(0,
hash)}return hash}function hash_code_number(num,init_val){var hash=init_val;_hash_buffer_in[0]=num;hash=(hash<<5)-hash+_hash_buffer_out[0];hash=hash&hash;hash=(hash<<5)-hash+_hash_buffer_out[1];hash=hash&hash;return hash}exports.hash_code_string=hash_code_string;function hash_code_string(str,init_val){var hash=init_val;for(var i=0;i<str.length;i++){var symbol=str.charCodeAt(i);hash=(hash<<5)-hash+symbol;hash=hash&hash}return hash}exports.mat3_to_mat4=function(mat,dest){dest[15]=1;dest[14]=0;dest[13]=
0;dest[12]=0;dest[11]=0;dest[10]=mat[8];dest[9]=mat[7];dest[8]=mat[6];dest[7]=0;dest[6]=mat[5];dest[5]=mat[4];dest[4]=mat[3];dest[3]=0;dest[2]=mat[2];dest[1]=mat[1];dest[0]=mat[0];return dest};exports.quat_to_angle_axis=function(src,dest){if(!dest)dest=src;var sqrlen=src[0]*src[0]+src[1]*src[1]+src[2]*src[2];if(sqrlen>0){dest[3]=2*Math.acos(src[3]);var invlen=1/Math.sqrt(sqrlen);dest[0]=src[0]*invlen;dest[1]=src[1]*invlen;dest[2]=src[2]*invlen}else{dest[3]=0;dest[0]=1;dest[1]=0;dest[2]=0}return dest};
function permute3(x){x=(34*x+1)*x;return x%289}function fract(x){return x-Math.floor(x)}exports.trunc=function(x){return isNaN(x)||typeof x=="undefined"?NaN:x|0};exports.deg_to_rad=function(x){return x*Math.PI/180};exports.rad_to_deg=function(x){return x*180/Math.PI};exports.snoise=function(p){var C_x=.211324865405187;var C_y=.366025403784439;var C_z=-.577350269189626;var C_w=.024390243902439;var v_dot_Cyy=p[0]*C_y+p[1]*C_y;var i_x=Math.floor(p[0]+v_dot_Cyy);var i_y=Math.floor(p[1]+v_dot_Cyy);var i_dot_Cxx=
i_x*C_x+i_y*C_x;var x0_x=p[0]-i_x+i_dot_Cxx;var x0_y=p[1]-i_y+i_dot_Cxx;var i1_x=x0_x>x0_y?1:0;var i1_y=1-i1_x;var x12_x=x0_x+C_x-i1_x;var x12_y=x0_y+C_x-i1_y;var x12_z=x0_x+C_z;var x12_w=x0_y+C_z;i_x%=289;i_y%=289;var p_x=permute3(permute3(i_y)+i_x);var p_y=permute3(permute3(i_y+i1_y)+i_x+i1_x);var p_z=permute3(permute3(i_y+1)+i_x+1);var m_x=Math.max(.5-(x0_x*x0_x+x0_y*x0_y),0);var m_y=Math.max(.5-(x12_x*x12_x+x12_y*x12_y),0);var m_z=Math.max(.5-(x12_z*x12_z+x12_w*x12_w),0);m_x*=m_x*m_x*m_x;m_y*=
m_y*m_y*m_y;m_z*=m_z*m_z*m_z;var x_x=2*fract(p_x*C_w)-1;var x_y=2*fract(p_y*C_w)-1;var x_z=2*fract(p_z*C_w)-1;var h_x=Math.abs(x_x)-.5;var h_y=Math.abs(x_y)-.5;var h_z=Math.abs(x_z)-.5;var ox_x=Math.floor(x_x+.5);var ox_y=Math.floor(x_y+.5);var ox_z=Math.floor(x_z+.5);var a0_x=x_x-ox_x;var a0_y=x_y-ox_y;var a0_z=x_z-ox_z;m_x*=1.79284291400159-.85373472095314*(a0_x*a0_x+h_x*h_x);m_y*=1.79284291400159-.85373472095314*(a0_y*a0_y+h_y*h_y);m_z*=1.79284291400159-.85373472095314*(a0_z*a0_z+h_z*h_z);var g_x=
a0_x*x0_x+h_x*x0_y;var g_y=a0_y*x12_x+h_y*x12_y;var g_z=a0_z*x12_z+h_z*x12_w;var m_dot_g=m_x*g_x+m_y*g_y+m_z*g_z;return 130*m_dot_g};function permute(x){return mod289((34*x+5)*x)}function mod289(x){return x-Math.floor(x/289)*289}function mod7(x){return x-Math.floor(x/7)*7}exports.cellular2x2=function(P){var K=1/7;var K2=K/2;var JITTER=.7;var Pi_x=mod289(Math.floor(P[0]));var Pi_y=mod289(Math.floor(P[1]));var Pf_x=fract(P[0]);var Pf_y=fract(P[1]);var Pfx_x=Pf_x-.5;var Pfx_y=Pf_x-1.5;var Pfx_z=Pfx_x;
var Pfx_w=Pfx_y;var Pfy_x=Pf_y-.5;var Pfy_y=Pfy_x;var Pfy_z=Pf_y-1.5;var Pfy_w=Pfy_z;var p_x=permute(Pi_x);var p_y=permute(Pi_x+1);var p_z=p_x;var p_w=p_y;p_x=permute(p_x+Pi_y);p_y=permute(p_y+Pi_y);p_z=permute(p_z+Pi_y+1);p_w=permute(p_w+Pi_y+1);var ox_x=mod7(p_x)*K+K2;var ox_y=mod7(p_y)*K+K2;var ox_z=mod7(p_z)*K+K2;var ox_w=mod7(p_w)*K+K2;var oy_x=mod7(Math.floor(p_x*K))*K+K2;var oy_y=mod7(Math.floor(p_y*K))*K+K2;var oy_z=mod7(Math.floor(p_z*K))*K+K2;var oy_w=mod7(Math.floor(p_w*K))*K+K2;var dx_x=
Pfx_x+JITTER*ox_x;var dx_y=Pfx_y+JITTER*ox_y;var dx_z=Pfx_z+JITTER*ox_z;var dx_w=Pfx_w+JITTER*ox_w;var dy_x=Pfy_x+JITTER*oy_x;var dy_y=Pfy_y+JITTER*oy_y;var dy_z=Pfy_z+JITTER*oy_z;var dy_w=Pfy_w+JITTER*oy_w;var d_x=dx_x*dx_x+dy_x*dy_x;var d_y=dx_y*dx_y+dy_y*dy_y;var d_z=dx_z*dx_z+dy_z*dy_z;var d_w=dx_w*dx_w+dy_w*dy_w;var d=Math.min(d_x,d_y,d_z,d_w);return d};exports.quat_project=function(quat,quat_ident_dir,plane,plane_ident_dir,dest){if(!dest)var dest=new Float32Array(4);var to=m_vec3.transformQuat(quat_ident_dir,
quat,_vec3_tmp);var a=plane[0];var b=plane[1];var c=plane[2];var proj=_mat3_tmp;proj[0]=b*b+c*c;proj[1]=-b*a;proj[2]=-c*a;proj[3]=-a*b;proj[4]=a*a+c*c;proj[5]=-c*b;proj[6]=-a*c;proj[7]=-b*c;proj[8]=a*a+b*b;m_vec3.transformMat3(to,proj,to);m_vec3.normalize(to,to);m_quat.rotationTo(plane_ident_dir,to,dest);return dest};exports.cam_quat_to_mesh_quat=function(cam_quat,dest){if(!dest)var dest=new Float32Array(4);var quat_offset=_vec4_tmp;var quat_offset_x=_vec4_tmp2;quat_offset=m_quat.setAxisAngle([0,
1,0],Math.PI,m_quat.create());quat_offset_x=m_quat.setAxisAngle([1,0,0],Math.PI/2,m_quat.create());m_quat.multiply(quat_offset,quat_offset_x,quat_offset);m_quat.multiply(cam_quat,quat_offset,dest);return dest};exports.cleanup=function(){_unique_counter=0;_unique_name_counters={}};exports.clamp=function(value,min,max){return Math.min(Math.max(value,min),max)};exports.smooth=function(curr,last,delta,period){var e=Math.exp(-delta/period);return(1-e)*curr+e*last};exports.smooth_v=function(curr,last,delta,
period,dest){if(!dest)dest=new Float32Array(curr.length);var e=Math.exp(-delta/period);for(var i=0;i<dest.length;i++)dest[i]=(1-e)*curr[i]+e*last[i];return dest};exports.smooth_q=function(curr,last,delta,period,dest){if(!dest)dest=new Float32Array(curr.length);var e=Math.exp(-delta/period);m_quat.slerp(curr,last,e,dest);return dest};exports.is_arr_buf_view=function(o){if(typeof o==="object"&&o.buffer&&o.buffer instanceof ArrayBuffer)return true;else return false};exports.is_vector=function(o,dimension){if(o instanceof
Array||o.buffer&&o.buffer instanceof ArrayBuffer)if(dimension&&dimension==o.length)return true;else if(dimension)return false;else return true;return false};exports.correct_cam_quat_up=function(quat,up_only){var rmat=m_mat3.fromQuat(quat,_mat3_tmp);var y_world=_vec3_tmp2;y_world[0]=0;y_world[1]=1;y_world[2]=0;var y_cam_world=_vec3_tmp;y_cam_world[0]=rmat[3];y_cam_world[1]=rmat[4];y_cam_world[2]=rmat[5];var x_cam_world_new=m_vec3.cross(y_world,y_cam_world,y_cam_world);m_vec3.normalize(x_cam_world_new,
x_cam_world_new);var z_cam_world_y=rmat[7];if(!up_only&&z_cam_world_y>0){x_cam_world_new[0]*=-1;x_cam_world_new[1]*=-1;x_cam_world_new[2]*=-1}var x_cam_world=_vec3_tmp2;x_cam_world[0]=rmat[0];x_cam_world[1]=rmat[1];x_cam_world[2]=rmat[2];m_vec3.normalize(x_cam_world,x_cam_world);var correct_quat=_vec4_tmp2;m_quat.rotationTo(x_cam_world,x_cam_world_new,correct_quat);m_quat.multiply(correct_quat,quat,quat)};exports.get_array_smooth_value=function(array,row_width,x,y){var px=x*row_width-.5;var py=y*
row_width-.5;var fract_px=px-Math.floor(px);var fract_py=py-Math.floor(py);px=Math.floor(px);py=Math.floor(py);var up_lim=row_width-1;var val_00=array[py*row_width+px];var val_10=array[py*row_width+Math.min(px+1,up_lim)];var val_01=array[Math.min(py+1,up_lim)*row_width+px];var val_11=array[Math.min(py+1,up_lim)*row_width+Math.min(px+1,up_lim)];var val_0010=val_00*(1-fract_px)+val_10*fract_px;var val_0111=val_01*(1-fract_px)+val_11*fract_px;var smooth_value=val_0010*(1-fract_py)+val_0111*fract_py;
return smooth_value};exports.rgb_mask_get_channels_count=function(mask){var count=0;for(var i=0;i<3;i++)if((mask&1<<i)>0)count++;return count};exports.rgb_mask_get_channels_presence=rgb_mask_get_channels_presence;function rgb_mask_get_channels_presence(mask){var presence=[0,0,0];for(var i=0;i<3;i++)if((mask&1<<i)>0)presence[2-i]=1;return presence}exports.rgb_mask_get_channel_presence_index=function(mask,channel){var index=0;if(channel==1||channel==2)if((mask&1<<2)>0)index++;if(channel==2)if((mask&
1<<1)>0)index++;return index};exports.gen_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};exports.get_dict_length=function(dict){var count=0;for(var prop in dict)if(dict.hasOwnProperty(prop))count++;return count};exports.random_from_array=function(array){if(!array.length)return null;var pos=Math.floor(Math.random()*array.length);return array[pos]};exports.xz_direction=function(a,b,dest){if(!dest)dest=
new Float32Array(3);dest[0]=a[0]-b[0];dest[1]=0;dest[2]=a[2]-b[2];m_vec3.normalize(dest,dest)};exports.transformQuatFast=function(a,q,out){var ax=a[0],ay=a[1],az=a[2];var qx=q[0],qy=q[1],qz=q[2],qw=q[3];var uvx=qy*az-qz*ay,uvy=qz*ax-qx*az,uvz=qx*ay-qy*ax;var uuvx=qy*uvz-qz*uvy,uuvy=qz*uvx-qx*uvz,uuvz=qx*uvy-qy*uvx;uvx*=qw*2;uvy*=qw*2;uvz*=qw*2;uuvx*=2;uuvy*=2;uuvz*=2;out[0]=ax+uvx+uuvx;out[1]=ay+uvy+uuvy;out[2]=az+uvz+uuvz;return out};exports.assert=function(cond){if(!cond)throw new Error("Assertion failed");
};exports.panic=function(s){if(s)m_print.error.apply(m_print,arguments);throw"engine panic:\n"+"The engine tried to perform an invalid operation and halted.\n"+"Please copy the console contents above and submit it to the Blend4Web forum at\n"+"https://www.blend4web.com/en/forums/forum/17/";};exports.angle_wrap_periodic=angle_wrap_periodic;function angle_wrap_periodic(angle,from,to){var rel_angle=angle-from;var period=to-from;return from+(rel_angle-Math.floor(rel_angle/period)*period)}exports.angle_wrap_0_2pi=
angle_wrap_0_2pi;function angle_wrap_0_2pi(angle){return angle_wrap_periodic(angle,0,2*Math.PI)}exports.get_file_extension=function(file_path){var re=/(?:\.([^.]+))?$/;return re.exec(file_path)[1]};exports.strict_objs_is_equal=strict_objs_is_equal;function strict_objs_is_equal(a,b){for(var prop in a){var props_is_equal=true;var val1=a[prop];var val2=b[prop];switch(typeof val1){case "number":case "string":case "boolean":props_is_equal=val1==val2;break;case "object":props_is_equal=objs_is_equal(val1,
val2);break;default:break}if(!props_is_equal)return false}return true}function objs_is_equal(a,b){if(a&&b){var a_is_arr=a instanceof Array;var b_is_arr=b instanceof Array;if(a_is_arr!=b_is_arr)return false;var a_is_typed_arr=a.buffer instanceof ArrayBuffer&&a.byteLength!=="undefined";var b_is_typed_arr=b.buffer instanceof ArrayBuffer&&b.byteLength!=="undefined";if(a_is_typed_arr!=b_is_typed_arr)return false;if(a_is_arr){if(a.length!=b.length)return false;for(var i=0;i<a.length;i++)if(!vars_is_equal(a[i],
b[i]))return false}else if(a_is_typed_arr){if(a.length!=b.length)return false;for(var i=0;i<a.length;i++)if(a[i]!=b[i])return false}else{switch(a.constructor){case WebGLUniformLocation:case WebGLProgram:case WebGLShader:case WebGLFramebuffer:case WebGLTexture:case WebGLBuffer:return a==b}for(var prop in a)if(!vars_is_equal(a[prop],b[prop]))return false;for(var prop in b)if(!(prop in a))return false}return true}else return!(a||b)}function vars_is_equal(a,b){if(typeof a!=typeof b)return false;switch(typeof a){case "number":case "string":case "boolean":return a==
b;case "object":return objs_is_equal(a,b);default:return true}}exports.quat_bpy_b4w=function(quat,dest){var w=quat[0];var x=quat[1];var y=quat[2];var z=quat[3];dest[0]=x;dest[1]=y;dest[2]=z;dest[3]=w;return dest};exports.gen_color_id=function(counter){var counter=counter+1;if(counter>51*51*51)m_print.error("Color ID pool depleted");var r=Math.floor(counter/(51*51));counter%=51*51;var g=Math.floor(counter/51);counter%=51;var b=counter;var color_id=new Float32Array([r/51,g/51,b/51]);return color_id};
exports.line_plane_intersect=function(pn,p_dist,pline,dest){var plane=_vec4_tmp;plane.set(pn);plane[3]=p_dist;var line_dir=_vec4_tmp2;_vec3_tmp[0]=pline[3];_vec3_tmp[1]=pline[4];_vec3_tmp[2]=pline[5];line_dir.set(_vec3_tmp);line_dir[3]=0;var denominator=m_vec4.dot(plane,line_dir);if(denominator==0)return null;var line_point=_vec4_tmp2;m_vec3.copy(pline,_vec3_tmp);line_point.set(_vec3_tmp);line_point[3]=1;var numerator=m_vec4.dot(plane,line_point);var t=-numerator/denominator;dest[0]=pline[0]+t*pline[3];
dest[1]=pline[1]+t*pline[4];dest[2]=pline[2]+t*pline[5];return dest};exports.get_plane_normal=function(a,b,c,dest){var a12=b[0]-a[0];var a13=c[0]-a[0];var a22=b[1]-a[1];var a23=c[1]-a[1];var a32=b[2]-a[2];var a33=c[2]-a[2];dest[0]=a22*a33-a32*a23;dest[1]=a13*a32-a12*a33;dest[2]=a12*a23-a22*a13;return dest};exports.copy_array=function(a,out){for(var i=0;i<a.length;i++)out[i]=a[i];return out};exports.rotation_to_stable=function(a,b,out){var tmp=_vec3_tmp;var dot=m_vec3.dot(a,b);if(dot<-.9999999){m_vec3.cross(AXIS_X,
a,tmp);if(m_vec3.length(tmp)<1E-6)m_vec3.cross(AXIS_Y,a,tmp);m_vec3.normalize(tmp,tmp);m_quat.setAxisAngle(tmp,Math.PI,out)}else{m_vec3.cross(a,b,tmp);out.set(tmp);out[3]=1+dot;m_quat.normalize(out,out)}return out};exports.calc_returning_angle=function(angle,min_angle,max_angle){if(min_angle==max_angle)return max_angle-angle;angle=angle_wrap_0_2pi(angle);min_angle=angle_wrap_0_2pi(min_angle);max_angle=angle_wrap_0_2pi(max_angle);var rotation=2*Math.PI-min_angle;min_angle=0;max_angle+=rotation;max_angle=
angle_wrap_0_2pi(max_angle);angle+=rotation;angle=angle_wrap_0_2pi(angle);if(angle>max_angle){var delta_to_max=max_angle-angle;var delta_to_min=2*Math.PI-angle;return-delta_to_max>delta_to_min?delta_to_min:delta_to_max}return 0};exports.smooth_step=function(t,min,max){if(isFinite(min)&&isFinite(max))t=clamp(t,min,max);return t*t*(3-2*t)};exports.lerp=function(t,from,to){return from+t*(to-from)};exports.arrays_have_common=function(arr_1,arr_2){for(var i=0;i<arr_1.length;i++)for(var k=0;k<arr_2.length;k++)if(arr_2[k]==
arr_1[i])return true;return false};exports.create_zero_array=function(length){var array=new Array(length);for(var i=0;i<length;i++)array[i]=0;return array};exports.version_cmp=function(ver1,ver2){var max_len=Math.max(ver1.length,ver2.length);for(var i=0;i<max_len;i++){var n1=i>=ver1.length?0:ver1[i];var n2=i>=ver2.length?0:ver2[i];var s=sign(n1-n2);if(s)return s}return 0};exports.version_to_str=function(ver){return ver.join(".")};exports.str_to_version=function(str){return str.split(".").map(function(val){return val|
0})};exports.srgb_to_lin=function(color,dest){dest[0]=Math.pow(color[0],GAMMA);dest[1]=Math.pow(color[1],GAMMA);dest[2]=Math.pow(color[2],GAMMA);return dest};exports.lin_to_srgb=function(color,dest){dest[0]=Math.pow(color[0],1/GAMMA);dest[1]=Math.pow(color[1],1/GAMMA);dest[2]=Math.pow(color[2],1/GAMMA);return dest};exports.normpath_preserve_protocol=function(dir_path){var separated_str=dir_path.split("://",2);if(separated_str.length>1){separated_str[1]=normpath(separated_str[1]);return separated_str.join("://")}else return normpath(dir_path)};
function normpath(path){var sep="/";var empty="";var dot=".";var dotdot="..";if(path==empty)return dot;var initial_slashes=path.indexOf(sep)==0|0;if(initial_slashes&&path.indexOf(sep+sep)==0&&path.indexOf(sep+sep+sep)!=0)initial_slashes=2;var comps=path.split(sep);var new_comps=[];for(var i=0;i<comps.length;i++){var comp=comps[i];if(comp==empty||comp==dot)continue;if(comp!=dotdot||!initial_slashes&&!new_comps.length||new_comps.length&&new_comps[new_comps.length-1]==dotdot)new_comps.push(comp);else if(new_comps.length)new_comps.pop()}comps=
new_comps;path=comps.join(sep);for(var i=0;i<initial_slashes;i++)path=sep+path;return path||dot}exports.check_npot=function(num){return parseInt(num.toString(2).substr(1),2)!=0};exports.ellipsoid_axes_to_mat3=function(axis_x,axis_y,axis_z,dest){dest[0]=axis_x[0];dest[1]=axis_y[0];dest[2]=axis_z[0];dest[3]=axis_x[1];dest[4]=axis_y[1];dest[5]=axis_z[1];dest[6]=axis_x[2];dest[7]=axis_y[2];dest[8]=axis_z[2];return dest}};b4w.module["__sfx"]=function(exports,require){var m_cfg=require("__config");var m_print=require("__print");var m_time=require("__time");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_ani=m_cfg.animation;var cfg_def=m_cfg.defaults;var cfg_sfx=m_cfg.sfx;var SPEED_SMOOTH_PERIOD=.3;var SPKSTATE_UNDEFINED=10;var SPKSTATE_PLAY=20;var SPKSTATE_STOP=30;var SPKSTATE_PAUSE=40;var SPKSTATE_FINISH=50;var SCHED_PARAM_LOOPS=5;var SCHED_PARAM_ANTICIPATE_TIME=3;exports.AST_NONE=
10;exports.AST_ARRAY_BUFFER=20;exports.AST_HTML_ELEMENT=30;var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _supported_audio=[];var _supported_video=[];var _wa=null;var _active_scene=null;var _speaker_objects=[];var _seed_tmp=[1];var _playlist=null;exports.create_sfx=function(){var sfx={uuid:-1,filepath:"",behavior:"NONE",disable_doppler:false,muted:false,volume:1,pitch:1,attenuation:1,dist_ref:1,dist_max:1E4,cone_angle_inner:360,cone_angle_outer:360,
cone_volume_outer:1,cyclic:false,loop:false,delay:0,delay_random:0,volume_random:0,pitch_random:0,fade_in:0,fade_out:0,start_time:0,pause_time:0,buf_offset:0,duration:0,vp_rand_end_time:0,base_seed:1,src:null,state:SPKSTATE_UNDEFINED,last_position:new Float32Array(3),direction:new Float32Array(3),speed_avg:new Float32Array(3),bgm_start_timeout:-1,bgm_stop_timeout:-1,duck_time:0};return sfx};exports.init=function(){var audio=document.createElement("audio");var video=document.createElement("video");
if(audio.canPlayType){if(audio.canPlayType("audio/ogg")!=""){_supported_audio.push("ogg");_supported_audio.push("ogv")}if(audio.canPlayType("audio/mpeg")!="")_supported_audio.push("mp3");if(audio.canPlayType("audio/mp4")!=""){_supported_audio.push("mp4");_supported_audio.push("m4v")}if(audio.canPlayType("audio/webm")!="")_supported_audio.push("webm")}if(video.canPlayType){if(video.canPlayType("video/ogg")!="")_supported_video.push("ogv");if(video.canPlayType("video/mp4")!="")_supported_video.push("m4v");
if(video.canPlayType("video/webm")!="")_supported_video.push("webm")}_wa=cfg_sfx.webaudio?create_wa_context():null;if(_wa)m_print.log("%cINIT WEBAUDIO: "+_wa.sampleRate+"Hz","color: #00a")};exports.attach_scene_sfx=function(scene){var scene_sfx={listener_last_eye:new Float32Array(3),listener_direction:new Float32Array(3),listener_speed_avg:new Float32Array(3)};scene._sfx=scene_sfx;if(_wa){var gnode=_wa.createGain();var fade_gnode=_wa.createGain();scene_sfx.gain_node=gnode;scene_sfx.fade_gain_node=
fade_gnode;gnode.connect(fade_gnode);fade_gnode.connect(_wa.destination);if(scene["b4w_enable_dynamic_compressor"]){var compressor=_wa.createDynamicsCompressor();var dcs=scene["b4w_dynamic_compressor_settings"];compressor.threshold.value=dcs["threshold"];compressor.knee.value=dcs["knee"];compressor.ratio.value=dcs["ratio"];compressor.attack.value=dcs["attack"];compressor.release.value=dcs["release"];compressor.connect(gnode);scene_sfx.compressor_node=compressor;scene_sfx.proc_chain_in=compressor}else{scene_sfx.compressor_node=
null;scene_sfx.proc_chain_in=gnode}var listener=_wa.listener;scene_sfx.disable_doppler=cfg_def.disable_doppler_hack;if(!scene_sfx.disable_doppler){listener.dopplerFactor=scene["audio_doppler_factor"];listener.speedOfSound=scene["audio_doppler_speed"]}scene_sfx.muted=false;scene_sfx.volume=1;scene_sfx.duck_time=0}};function create_wa_context(){var AudioContext=window.AudioContext||window.webkitAudioContext;if(AudioContext){try{var ctx=new AudioContext}catch(e){m_print.error('Unable to initialize AudioContext: "'+
e+'". The audio is disabled.');return null}if(ctx.createGain)return ctx;else{m_print.warn("deprecated WebAudio implementation");return null}}else{m_print.warn("WebAudio is not supported");return null}}exports.set_active_scene=function(scene){_active_scene=scene};exports.detect_audio_container=function(hint){if(!hint)var hint="ogg";if(_supported_audio.indexOf(hint)>-1)return hint;else if(hint=="ogg"&&_supported_audio.indexOf("mp4")>-1)return"mp4";else if(hint=="mp3"&&_supported_audio.indexOf("ogg")>
-1)return"ogg";else if(hint=="mp4"&&_supported_audio.indexOf("ogg")>-1)return"ogg";else if(hint=="ogv"&&_supported_audio.indexOf("m4v")>-1)return"m4v";else if(hint=="webm"&&_supported_audio.indexOf("m4v")>-1)return"m4v";else if(hint=="m4v"&&_supported_audio.indexOf("webm")>-1)return"webm";else return""};exports.detect_video_container=function(hint){if(!hint)var hint="webm";if(_supported_video.indexOf(hint)>-1)return hint;else if(hint=="ogv"&&_supported_video.indexOf("m4v")>-1)return"m4v";else if(hint==
"webm"&&_supported_video.indexOf("m4v")>-1)return"m4v";else if(hint=="m4v"&&_supported_video.indexOf("webm")>-1)return"webm";else return""};exports.update_object=function(bpy_obj,obj){var speaker=bpy_obj["data"];var sfx=obj.sfx;sfx.uuid=bpy_obj["data"]["sound"]["uuid"];sfx.filepath=bpy_obj["data"]["sound"]["filepath"];switch(speaker["b4w_behavior"]){case "POSITIONAL":case "BACKGROUND_SOUND":sfx.behavior=_wa?speaker["b4w_behavior"]:"NONE";break;case "BACKGROUND_MUSIC":sfx.behavior=_wa?check_media_element_node()&&
!cfg_def.chrome_html_bkg_music_hack?"BACKGROUND_MUSIC":"BACKGROUND_SOUND":"NONE";break;default:throw"Wrong speaker behavior";break}if(!speaker["sound"])sfx.behavior="NONE";sfx.disable_doppler=speaker["b4w_disable_doppler"]||cfg_def.disable_doppler_hack;sfx.muted=speaker["muted"];sfx.volume=speaker["volume"];sfx.pitch=speaker["pitch"];sfx.attenuation=speaker["attenuation"];sfx.dist_ref=speaker["distance_reference"];sfx.dist_max=speaker["distance_max"]||1E4;sfx.cone_angle_inner=speaker["cone_angle_inner"];
sfx.cone_angle_outer=speaker["cone_angle_outer"];sfx.cone_volume_outer=speaker["cone_volume_outer"];sfx.cyclic=speaker["b4w_cyclic_play"];sfx.loop=speaker["b4w_loop"];sfx.delay=speaker["b4w_delay"];sfx.delay_random=speaker["b4w_delay_random"];sfx.volume_random=speaker["b4w_volume_random"];sfx.pitch_random=speaker["b4w_pitch_random"];sfx.fade_in=speaker["b4w_fade_in"];sfx.fade_out=speaker["b4w_fade_out"];_speaker_objects.push(obj)};function check_media_element_node(){if(window.MediaElementAudioSourceNode)return true;
else{m_print.warn("MediaElementAudioSourceNode not found");return false}}exports.source_type=function(obj){if(obj.type!="SPEAKER")throw"Wrong object type";switch(obj.sfx.behavior){case "POSITIONAL":return exports.AST_ARRAY_BUFFER;case "BACKGROUND_SOUND":return exports.AST_ARRAY_BUFFER;case "BACKGROUND_MUSIC":return exports.AST_HTML_ELEMENT;case "NONE":return exports.AST_NONE;default:throw"Wrong speaker behavior";}};exports.update_spkobj=function(obj,sound_data){var sfx=obj.sfx;switch(sfx.behavior){case "POSITIONAL":case "BACKGROUND_SOUND":case "BACKGROUND_MUSIC":sfx.src=
sound_data;break;case "NONE":break;default:throw"Wrong speaker behavior";}};exports.play_empty_sound=function(){var source=_wa.createBufferSource();source.buffer=_wa.createBuffer(1,22050,22050);source.connect(_wa.destination);source.start(0)};exports.decode_audio_data=function(arr_buf,decode_cb,fail_cb){if(_wa)_wa.decodeAudioData(arr_buf,decode_cb,fail_cb);else fail_cb()};exports.speaker_remove=function(obj){stop(obj);obj.sfx=null;_speaker_objects.splice(_speaker_objects.indexOf(obj),1)};exports.cleanup=
function(){for(var i=0;i<_speaker_objects.length;i++){var obj=_speaker_objects[i];var sfx=obj.sfx;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el)audio_el.pause()}else if(sfx.source_node)sfx.source_node.disconnect()}if(_active_scene&&_active_scene._sfx){var scene_sfx=_active_scene._sfx;scene_sfx.listener_last_eye[0]=0;scene_sfx.listener_last_eye[1]=0;scene_sfx.listener_last_eye[2]=0;scene_sfx.listener_speed_avg[0]=0;scene_sfx.listener_speed_avg[1]=0;scene_sfx.listener_speed_avg[2]=
0}_active_scene=null;_speaker_objects.splice(0);_playlist=null};exports.update=function(timeline,elapsed){if(!_wa||_speaker_objects.length==0)return;for(var i=0;i<_speaker_objects.length;i++){var obj=_speaker_objects[i];var sfx=obj.sfx;var source=sfx.source_node;var curr_time=_wa.currentTime;if(!sfx.loop&&sfx.state==SPKSTATE_PLAY&&sfx.duration&&sfx.start_time+sfx.duration<curr_time&&(sfx.behavior=="BACKGROUND_MUSIC"||source&&!m_util.isdef(source.onended)))sfx.state=SPKSTATE_FINISH;if(sfx.cyclic&&
sfx.state==SPKSTATE_FINISH)play_def(obj);if(sfx.state==SPKSTATE_PLAY&&sfx.vp_rand_end_time-curr_time<SCHED_PARAM_ANTICIPATE_TIME)schedule_volume_pitch_random(sfx)}if(_playlist&&_playlist.speakers.length&&(_playlist.active==-1||timeline>_playlist.active_start_time+_playlist.durations[_playlist.active]))playlist_switch_next(_playlist,timeline)};function playlist_switch_next(playlist,timeline){if(playlist.active>-1)stop(playlist.speakers[playlist.active]);if(playlist.active==-1&&playlist.random)var next=
Math.round(Math.random()*(playlist.speakers.length-1));else if(playlist.random){var advance=1+Math.round(Math.random()*(playlist.speakers.length-2));var next=(playlist.active+advance)%playlist.speakers.length}else var next=(playlist.active+1)%playlist.speakers.length;play_def(playlist.speakers[next]);playlist.active=next;playlist.active_start_time=timeline}exports.play=play;function play(obj,when,duration){var sfx=obj.sfx;if(sfx.behavior=="NONE")return;var loop=sfx.loop;var playrate=sfx.pitch;if(!(sfx.src&&
(loop||duration>=0)))return;sfx.base_seed=Math.floor(5E4*Math.random());var start_time=_wa.currentTime+when;start_time=Math.max(0,start_time);sfx.start_time=start_time;sfx.state=SPKSTATE_PLAY;update_proc_chain(obj);if(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND"){var source=_wa.createBufferSource();source.buffer=sfx.src;source.playbackRate.value=playrate;if(m_util.isdef(source.onended))source.onended=function(){sfx.state=SPKSTATE_FINISH};if(loop){if(sfx.source_node)sfx.source_node.disconnect();
source.loop=true;source.start(start_time);sfx.duration=0}else{var buf_dur=source.buffer?source.buffer.duration:0;if(duration>buf_dur){var to=start_time+duration+sfx.fade_out;source.loop=true;source.start(start_time);source.stop(to);sfx.duration=duration}else{source.loop=false;source.start(start_time);sfx.duration=buf_dur}}source.connect(sfx.proc_chain_in);sfx.source_node=source;reset_volume_pitch_random(sfx);schedule_volume_pitch_random(sfx)}else if(sfx.behavior=="BACKGROUND_MUSIC"){m_time.clear_timeout(sfx.bgm_start_timeout);
m_time.clear_timeout(sfx.bgm_stop_timeout);var start_cb=function(){fire_audio_element(obj)};if(when==0)start_cb();else sfx.bgm_start_timeout=m_time.set_timeout(start_cb,when*1E3);if(loop)sfx.duration=0;else{var el_dur=get_duration(obj);sfx.duration=el_dur}}schedule_fades(sfx,start_time)}function update_proc_chain(obj){var sfx=obj.sfx;if(sfx.proc_chain_in)return;var pos=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);if(cfg_sfx.mix_mode){var filter_node=
_wa.createBiquadFilter();filter_node.type="peaking"}else var filter_node=null;var fade_gnode=_wa.createGain();switch(sfx.behavior){case "POSITIONAL":var ap=_wa.createPanner();if(typeof ap.panningModel!="string"){ap.panningModel=ap.EQUALPOWER;ap.distanceModel=ap.INVERSE_DISTANCE}else{ap.panningModel="equalpower";ap.distanceModel="inverse"}ap.setPosition(pos[0],pos[1],pos[2]);m_vec3.copy(pos,sfx.last_position);var orient=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,orient);ap.setOrientation(orient[0],
orient[1],orient[2]);m_vec3.copy(orient,sfx.direction);ap.refDistance=sfx.dist_ref;ap.maxDistance=sfx.dist_max;ap.rolloffFactor=sfx.attenuation;ap.coneInnerAngle=sfx.cone_angle_inner;ap.coneOuterAngle=sfx.cone_angle_outer;ap.coneOuterGain=sfx.cone_volume_outer;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){ap.connect(filter_node);filter_node.connect(gnode)}else ap.connect(gnode);gnode.connect(fade_gnode);sfx.proc_chain_in=ap;if(sfx.volume_random){var rand_gnode=_wa.createGain();
fade_gnode.connect(rand_gnode);rand_gnode.connect(get_scene_dst_node(_active_scene))}else{var rand_gnode=null;fade_gnode.connect(get_scene_dst_node(_active_scene))}break;case "BACKGROUND_SOUND":var ap=null;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){sfx.proc_chain_in=filter_node;filter_node.connect(gnode)}else sfx.proc_chain_in=gnode;gnode.connect(fade_gnode);if(sfx.volume_random){var rand_gnode=_wa.createGain();fade_gnode.connect(rand_gnode);rand_gnode.connect(get_scene_dst_node(_active_scene))}else{var rand_gnode=
null;fade_gnode.connect(get_scene_dst_node(_active_scene))}break;case "BACKGROUND_MUSIC":var ap=null;var rand_gnode=null;var gnode=_wa.createGain();gnode.gain.value=calc_gain(sfx);if(filter_node){sfx.proc_chain_in=filter_node;filter_node.connect(gnode)}else sfx.proc_chain_in=gnode;gnode.connect(fade_gnode);fade_gnode.connect(get_scene_dst_node(_active_scene));break}sfx.panner_node=ap;sfx.filter_node=filter_node;sfx.gain_node=gnode;sfx.fade_gain_node=fade_gnode;sfx.rand_gain_node=rand_gnode}exports.play_def=
play_def;function play_def(obj){var sfx=obj.sfx;var duration=sfx.duration;var delay=sfx.delay+sfx.delay_random*Math.random();play(obj,delay,duration)}function get_scene_dst_node(scene){if(_wa)return scene._sfx.proc_chain_in;else return null}function get_gain_node(scene){if(_wa)return scene._sfx.gain_node;else return null}function get_fade_node(scene){if(_wa)return scene._sfx.fade_gain_node;else return null}function reset_volume_pitch_random(sfx){if(sfx.volume_random)sfx.rand_gain_node.gain.cancelScheduledValues(sfx.start_time);
if(sfx.pitch_random)sfx.source_node.playbackRate.cancelScheduledValues(sfx.start_time);sfx.vp_rand_end_time=sfx.start_time}function schedule_volume_pitch_random(sfx){if(!(sfx.volume_random||sfx.pitch_random))return;var rand_gnode=sfx.rand_gain_node;var source=sfx.source_node;var buf_dur=source.buffer?source.buffer.duration:0;if(!buf_dur)return;var time=sfx.start_time;_seed_tmp[0]=sfx.base_seed;for(var cnt=0;cnt<SCHED_PARAM_LOOPS;){var playrate=sfx.pitch+sfx.pitch_random*m_util.rand_r(_seed_tmp);if(time>=
sfx.vp_rand_end_time){if(sfx.volume_random){var gain=1-m_util.clamp(sfx.volume_random,0,1)*Math.random();rand_gnode.gain.setValueAtTime(gain,time)}if(sfx.pitch_random)source.playbackRate.setValueAtTime(playrate,time);cnt++}time+=buf_dur/playrate}sfx.vp_rand_end_time=time-.001}function schedule_fades(sfx,from_time){if(!(sfx.fade_in||sfx.fade_out))return;var fade_gnode=sfx.fade_gain_node;fade_gnode.gain.cancelScheduledValues(from_time);if(sfx.fade_in){fade_gnode.gain.setValueAtTime(0,from_time);fade_gnode.gain.linearRampToValueAtTime(1,
from_time+sfx.fade_in)}else fade_gnode.gain.setValueAtTime(1,from_time);if(sfx.fade_out&&!sfx.loop){var source=sfx.source_node;fade_gnode.gain.setValueAtTime(1,from_time+sfx.duration);fade_gnode.gain.linearRampToValueAtTime(0,from_time+sfx.duration+sfx.fade_out)}}function fire_audio_element(obj){var sfx=obj.sfx;var audio=sfx.src;if(audio){audio.volume=1;audio.loop=sfx.loop;sfx.source_node=sfx.source_node||_wa.createMediaElementSource(audio);sfx.source_node.connect(sfx.proc_chain_in);if(sfx.state==
SPKSTATE_PLAY){if(audio.currentTime)audio.currentTime=0;audio.play()}}}function stop_audio_element(obj){var sfx=obj.sfx;var audio=sfx.src;if(audio){if(audio.currentTime)audio.currentTime=0;audio.pause()}}exports.stop=stop;function stop(sobj){if(sobj.type!="SPEAKER")throw"Wrong object type";var sfx=sobj.sfx;if(sfx.state==SPKSTATE_FINISH){sfx.state=SPKSTATE_STOP;return}else if(sfx.state!=SPKSTATE_PLAY&&sfx.state!=SPKSTATE_PAUSE)return;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;
if(sfx.fade_out){fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(0,current_time+sfx.fade_out)}if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el){var stop_cb=function(){stop_audio_element(sobj)};m_time.clear_timeout(sfx.bgm_start_timeout);m_time.clear_timeout(sfx.bgm_stop_timeout);sfx.bgm_stop_timeout=m_time.set_timeout(stop_cb,sfx.fade_out*1E3)}}else{var source=sfx.source_node;if(sfx.duration<source.buffer.duration)if(sfx.fade_out&&
sfx.state==SPKSTATE_PLAY)source.stop(current_time+sfx.fade_out);else{if(sfx.state==SPKSTATE_PLAY){source.stop(0);source.disconnect()}}else source.disconnect();sfx.start_time=0;sfx.pause_time=0;sfx.buf_offset=0}sfx.state=SPKSTATE_STOP}exports.is_playing=is_playing;function is_playing(obj){return obj.sfx.state==SPKSTATE_PLAY}exports.speaker_pause=speaker_pause;function speaker_pause(obj){var sfx=obj.sfx;if(sfx.state!=SPKSTATE_PLAY)return;var current_time=_wa.currentTime;sfx.pause_time=current_time;
if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;if(audio_el)audio_el.pause()}else{var source=sfx.source_node;var playrate=source.playbackRate.value;var buf_dur=source.buffer.duration;if(current_time>sfx.start_time)sfx.buf_offset=calc_buf_offset(sfx,current_time);else sfx.buf_offset=0;sfx.source_node.stop(0);sfx.source_node.disconnect();reset_volume_pitch_random(sfx)}sfx.state=SPKSTATE_PAUSE}function calc_buf_offset(sfx,current_time){_seed_tmp[0]=sfx.base_seed;var buf_dur=sfx.source_node.buffer.duration;
var time=sfx.start_time;var playrate;while(time<current_time){playrate=sfx.pitch+sfx.pitch_random*m_util.rand_r(_seed_tmp);time+=buf_dur/playrate}return(buf_dur/playrate-(time-current_time))*playrate}exports.speaker_resume=speaker_resume;function speaker_resume(obj){var sfx=obj.sfx;if(sfx.state!=SPKSTATE_PAUSE)return;var current_time=_wa.currentTime;sfx.start_time+=current_time-sfx.pause_time;if(sfx.behavior=="BACKGROUND_MUSIC"){var audio_el=sfx.src;audio_el.play()}else{update_source_node(obj);sfx.vp_rand_end_time=
current_time;var source=sfx.source_node;var playrate=source.playbackRate.value;var buf_dur=source.buffer.duration;if(m_util.isdef(source.onended))source.onended=function(){sfx.state=SPKSTATE_FINISH};source.start(sfx.start_time,sfx.buf_offset);schedule_volume_pitch_random(sfx)}schedule_fades(sfx,sfx.start_time);sfx.state=SPKSTATE_PLAY}function update_source_node(obj){var sfx=obj.sfx;var source=_wa.createBufferSource();source.loop=sfx.source_node.loop;source.buffer=sfx.source_node.buffer;source.playbackRate.value=
sfx.source_node.playbackRate.value;if(sfx.panner_node)source.connect(sfx.panner_node);else source.connect(sfx.gain_node);sfx.source_node=source}exports.playrate=function(obj,playrate){var sfx=obj.sfx;sfx.pitch=playrate;if(spk_is_active(obj)&&(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND")){sfx.source_node.playbackRate.value=playrate;reset_volume_pitch_random(sfx);schedule_volume_pitch_random(sfx)}};exports.get_playrate=function(obj){return obj.sfx.pitch};exports.cyclic=function(obj,
cyclic){obj.sfx.cyclic=Boolean(cyclic)};exports.is_cyclic=is_cyclic;function is_cyclic(obj){return obj.sfx.cyclic}exports.listener_update_transform=function(scene,trans,quat,elapsed){if(!_wa)return;if(!scene._sfx)return;var front=_vec3_tmp;front[0]=0;front[1]=-1;front[2]=0;m_vec3.transformQuat(front,quat,front);var up=_vec3_tmp2;up[0]=0;up[1]=0;up[2]=-1;m_vec3.transformQuat(up,quat,up);var listener=_wa.listener;listener.setPosition(trans[0],trans[1],trans[2]);listener.setOrientation(front[0],front[1],
front[2],up[0],up[1],up[2]);m_vec3.copy(front,scene._sfx.listener_direction);if(!scene._sfx.disable_doppler&&elapsed){var speed=_vec3_tmp3;speed[0]=(trans[0]-scene._sfx.listener_last_eye[0])/elapsed;speed[1]=(trans[1]-scene._sfx.listener_last_eye[1])/elapsed;speed[2]=(trans[2]-scene._sfx.listener_last_eye[2])/elapsed;m_util.smooth_v(speed,scene._sfx.listener_speed_avg,elapsed,SPEED_SMOOTH_PERIOD,speed);listener.setVelocity(speed[0],speed[1],speed[2]);m_vec3.copy(speed,scene._sfx.listener_speed_avg)}m_vec3.copy(trans,
scene._sfx.listener_last_eye)};exports.listener_reset_speed=function(speed,dir){if(!_wa)return;if(!_active_scene._sfx||_active_scene._sfx.disable_doppler)return;var velocity=_vec3_tmp;if(dir)m_vec3.copy(dir,velocity);else m_vec3.copy(_active_scene._sfx.listener_direction,velocity);m_vec3.scale(velocity,speed,velocity);var listener=_wa.listener;listener.setVelocity(velocity[0],velocity[1],velocity[2]);m_vec3.copy(velocity,_active_scene._sfx.listener_speed_avg)};exports.speaker_update_transform=function(obj,
elapsed){var sfx=obj.sfx;if(!(spk_is_active(obj)&&sfx.behavior=="POSITIONAL"))return;var pos=m_tsr.get_trans_view(obj.render.world_tsr);var quat=m_tsr.get_quat_view(obj.render.world_tsr);var panner=sfx.panner_node;panner.setPosition(pos[0],pos[1],pos[2]);var orient=_vec3_tmp;m_util.quat_to_dir(quat,m_util.AXIS_MY,orient);panner.setOrientation(orient[0],orient[1],orient[2]);var lpos=sfx.last_position;if(!sfx.disable_doppler&&elapsed){var speed=_vec3_tmp2;speed[0]=(pos[0]-lpos[0])/elapsed;speed[1]=
(pos[1]-lpos[1])/elapsed;speed[2]=(pos[2]-lpos[2])/elapsed;m_util.smooth_v(speed,sfx.speed_avg,elapsed,SPEED_SMOOTH_PERIOD,speed);panner.setVelocity(speed[0],speed[1],speed[2]);m_vec3.copy(speed,sfx.speed_avg)}m_vec3.copy(pos,lpos)};exports.speaker_reset_speed=function(obj,speed,dir){var sfx=obj.sfx;if(!(spk_is_active(obj)&&sfx.behavior=="POSITIONAL")||sfx.disable_doppler)return;var velocity=_vec3_tmp;if(dir)m_vec3.copy(dir,velocity);else m_vec3.copy(sfx.direction,velocity);m_vec3.scale(velocity,
speed,velocity);var panner=sfx.panner_node;panner.setVelocity(velocity[0],velocity[1],velocity[2]);m_vec3.copy(velocity,sfx.speed_avg);var pos=m_tsr.get_trans_view(obj.render.world_tsr);m_vec3.copy(pos,sfx.last_position)};exports.get_spk_behavior=function(obj){return obj.sfx.behavior};exports.check_active_speakers=function(){for(var i=0;i<_speaker_objects.length;i++)if(spk_is_active(_speaker_objects[i]))return true;return false};function spk_is_active(obj){var sfx=obj.sfx;if(sfx&&(sfx.state==SPKSTATE_PLAY||
sfx.state==SPKSTATE_PAUSE||sfx.state==SPKSTATE_STOP||sfx.state==SPKSTATE_FINISH))return true;else return false}function calc_distance_gain(pos,pos_lis,dist_ref,dist_max,atten){var x=pos[0];var y=pos[1];var z=pos[2];var x0=pos_lis[0];var y0=pos_lis[1];var z0=pos_lis[2];var gain;var dist=Math.sqrt(Math.pow(x-x0,2)+Math.pow(y-y0,2)+Math.pow(z-z0,2));if(dist<dist_ref)gain=1;else if(dist>dist_max)gain=0;else var gain=dist_ref/(dist_ref+atten*(dist-dist_ref));return gain}function calc_gain(sfx){var volume=
sfx.muted?0:sfx.volume;return volume}exports.set_master_volume=function(volume){var scene_sfx=_active_scene._sfx;if(scene_sfx){scene_sfx.volume=volume;if(_wa)scene_sfx.gain_node.gain.value=calc_gain(scene_sfx)}};exports.get_master_volume=function(){var scene_sfx=_active_scene._sfx;if(scene_sfx)return scene_sfx.volume;else return 0};exports.set_volume=function(obj,volume){var sfx=obj.sfx;sfx.volume=volume;if(spk_is_active(obj))sfx.gain_node.gain.value=calc_gain(sfx)};exports.get_volume=function(obj){return obj.sfx.volume};
exports.mute=function(obj,muted){obj.sfx.muted=Boolean(muted);if(spk_is_active(obj))obj.sfx.gain_node.gain.value=calc_gain(obj.sfx)};exports.is_muted=function(obj){return obj.sfx.muted};exports.mute_master=function(muted){var scene_sfx=_active_scene._sfx;if(scene_sfx){scene_sfx.muted=Boolean(muted);if(_wa)scene_sfx.gain_node.gain.value=calc_gain(scene_sfx)}};exports.is_master_muted=function(){var scene_sfx=_active_scene._sfx;if(scene_sfx)return scene_sfx.muted;else return false};exports.get_speaker_objects=
function(){return _speaker_objects};exports.pause=function(){for(var i=0;i<_speaker_objects.length;i++)speaker_pause(_speaker_objects[i])};exports.resume=function(){for(var i=0;i<_speaker_objects.length;i++)speaker_resume(_speaker_objects[i])};exports.set_compressor_params=function(scene,params){if(!(scene._sfx&&scene._sfx.compressor_node))return;var compressor=scene._sfx.compressor_node;compressor.threshold.value=params["threshold"];compressor.knee.value=params["knee"];compressor.ratio.value=params["ratio"];
compressor.attack.value=params["attack"];compressor.release.value=params["release"]};exports.get_compressor_params=function(scene){if(!(scene._sfx&&scene._sfx.compressor_node))return null;var compressor=scene._sfx.compressor_node;var params={"threshold":compressor.threshold.value,"knee":compressor.knee.value,"ratio":compressor.ratio.value,"attack":compressor.attack.value,"release":compressor.release.value};return params};exports.duck=function(obj,value,time){if(!spk_is_active(obj))return;var sfx=
obj.sfx;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(value,current_time+time);sfx.duck_time=time};exports.unduck=function(obj){if(!spk_is_active(obj))return;var sfx=obj.sfx;var fade_gnode=sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(1,current_time+sfx.duck_time);
sfx.duck_time=0};exports.duck_master=function(value,time){if(!_wa)return;var scene_sfx=_active_scene._sfx;var fade_gnode=scene_sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,current_time);fade_gnode.gain.linearRampToValueAtTime(value,current_time+time);scene_sfx.duck_time=time};exports.unduck_master=function(){if(!_wa)return;var scene_sfx=_active_scene._sfx;var fade_gnode=scene_sfx.fade_gain_node;var current_time=_wa.currentTime;fade_gnode.gain.setValueAtTime(fade_gnode.gain.value,
current_time);fade_gnode.gain.linearRampToValueAtTime(1,current_time+scene_sfx.duck_time);scene_sfx.duck_time=0};exports.apply_playlist=function(objs,delay,random){_playlist={active:-1,active_start_time:0,random:random,speakers:[],durations:[]};for(var i=0;i<objs.length;i++){var obj=objs[i];var duration=get_duration(obj);if(duration==0){m_print.warn("Ignoring speaker with zero duration: "+obj.name);continue}stop(obj);var sfx=obj.sfx;sfx.cyclic=false;_playlist.speakers.push(obj);_playlist.durations.push(duration+
delay)}};exports.get_duration=get_duration;function get_duration(obj){var sfx=obj.sfx;if(sfx.behavior=="POSITIONAL"||sfx.behavior=="BACKGROUND_SOUND"){var buffer=sfx.src;if(buffer)return buffer.duration;else return 0}else{var audio=sfx.src;if(audio)return audio.duration;else return 0}}exports.clear_playlist=function(){if(_playlist){var spks=_playlist.speakers;for(var i=0;i<spks.length;i++)stop(spks[i])}_playlist=null};exports.get_positional_params=function(obj){var sfx=obj.sfx;if(!sfx||sfx.behavior!=
"POSITIONAL")return null;var pos_params={"dist_ref":sfx.dist_ref,"dist_max":sfx.dist_max,"attenuation":sfx.attenuation};return pos_params};exports.set_positional_params=function(obj,params){var sfx=obj.sfx;if(!sfx||sfx.behavior!="POSITIONAL")return;sfx.dist_ref=params["dist_ref"];sfx.dist_max=params["dist_max"];sfx.attenuation=params["attenuation"];var ap=sfx.panner_node;if(ap){ap.refDistance=sfx.dist_ref;ap.maxDistance=sfx.dist_max;ap.rolloffFactor=sfx.attenuation}};exports.set_filter_params=function(obj,
params){var sfx=obj.sfx;if(!sfx||!sfx.filter_node)return;sfx.filter_node.frequency.value=params["freq"];sfx.filter_node.Q.value=params["Q"];sfx.filter_node.gain.value=params["gain"]};exports.get_filter_params=function(obj){var sfx=obj.sfx;if(!sfx||!sfx.filter_node)return null;var params={"freq":sfx.filter_node.frequency.value,"Q":sfx.filter_node.Q.value,"gain":sfx.filter_node.gain.value};return params};exports.get_filter_freq_response=function(obj,freq_arr,mag_arr,phase_arr){var sfx=obj.sfx;if(!sfx||
!sfx.filter_node)return null;sfx.filter_node.getFrequencyResponse(freq_arr,mag_arr,phase_arr)}};b4w.module["__input"]=function(exports,require){var m_cont=require("__container");var m_cfg=require("__config");var m_print=require("__print");var m_quat=require("__quat");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");var cfg_ctl=m_cfg.controls;var cfg_def=m_cfg.defaults;var cfg_hmdp=m_cfg.hmd_params;var DEVICE_GYRO=10;var DEVICE_HMD=20;var DEVICE_MOUSE=30;var DEVICE_KEYBOARD=40;var DEVICE_TOUCH=50;var DEVICE_GAMEPAD0=60;var DEVICE_GAMEPAD1=70;var DEVICE_GAMEPAD2=
80;var DEVICE_GAMEPAD3=90;exports.DEVICE_GYRO=DEVICE_GYRO;exports.DEVICE_HMD=DEVICE_HMD;exports.DEVICE_MOUSE=DEVICE_MOUSE;exports.DEVICE_KEYBOARD=DEVICE_KEYBOARD;exports.DEVICE_TOUCH=DEVICE_TOUCH;exports.DEVICE_GAMEPAD0=DEVICE_GAMEPAD0;exports.DEVICE_GAMEPAD1=DEVICE_GAMEPAD1;exports.DEVICE_GAMEPAD2=DEVICE_GAMEPAD2;exports.DEVICE_GAMEPAD3=DEVICE_GAMEPAD3;var HMD_WEBVR_DESKTOP=0;var HMD_WEBVR_MOBILE=1;var HMD_NON_WEBVR=2;exports.HMD_WEBVR_DESKTOP=HMD_WEBVR_DESKTOP;exports.HMD_WEBVR_MOBILE=HMD_WEBVR_MOBILE;
exports.HMD_NON_WEBVR=HMD_NON_WEBVR;var HMD_WEBVR_TYPE=0;var HMD_ORIENTATION_QUAT=10;var HMD_POSITION=20;var HMD_FOV_LEFT=21;var HMD_FOV_RIGHT=22;var HMD_EYE_DISTANCE=23;var HMD_DISTORTION=24;var HMD_BASELINE_DIST=25;var HMD_SCREEN_LENSE_DIST=26;var HMD_SCREEN_WIDTH=27;var HMD_SCREEN_HEIGHT=28;var HMD_BEVEL_SIZE=29;var MOUSE_LOCATION=30;var MOUSE_DOWN_WHICH=40;var MOUSE_UP_WHICH=50;var MOUSE_WHEEL=60;var KEYBOARD_UP=70;var KEYBOARD_DOWN=80;var TOUCH_START=90;var TOUCH_MOVE=100;var TOUCH_END=110;var GYRO_ORIENTATION_QUAT=
120;var GYRO_ORIENTATION_ANGLES=130;var DEVICE_ORIENTATION=131;exports.HMD_WEBVR_TYPE=HMD_WEBVR_TYPE;exports.HMD_ORIENTATION_QUAT=HMD_ORIENTATION_QUAT;exports.HMD_POSITION=HMD_POSITION;exports.HMD_FOV_LEFT=HMD_FOV_LEFT;exports.HMD_FOV_RIGHT=HMD_FOV_RIGHT;exports.HMD_EYE_DISTANCE=HMD_EYE_DISTANCE;exports.HMD_DISTORTION=HMD_DISTORTION;exports.HMD_BASELINE_DIST=HMD_BASELINE_DIST;exports.HMD_SCREEN_LENSE_DIST=HMD_SCREEN_LENSE_DIST;exports.HMD_SCREEN_WIDTH=HMD_SCREEN_WIDTH;exports.HMD_SCREEN_HEIGHT=HMD_SCREEN_HEIGHT;
exports.HMD_BEVEL_SIZE=HMD_BEVEL_SIZE;exports.MOUSE_LOCATION=MOUSE_LOCATION;exports.MOUSE_DOWN_WHICH=MOUSE_DOWN_WHICH;exports.MOUSE_UP_WHICH=MOUSE_UP_WHICH;exports.MOUSE_WHEEL=MOUSE_WHEEL;exports.KEYBOARD_UP=KEYBOARD_UP;exports.KEYBOARD_DOWN=KEYBOARD_DOWN;exports.TOUCH_START=TOUCH_START;exports.TOUCH_MOVE=TOUCH_MOVE;exports.TOUCH_END=TOUCH_END;exports.GYRO_ORIENTATION_QUAT=GYRO_ORIENTATION_QUAT;exports.GYRO_ORIENTATION_ANGLES=GYRO_ORIENTATION_ANGLES;exports.GMPD_BUTTON_0=0;exports.GMPD_BUTTON_1=1;
exports.GMPD_BUTTON_2=2;exports.GMPD_BUTTON_3=3;exports.GMPD_BUTTON_4=4;exports.GMPD_BUTTON_5=5;exports.GMPD_BUTTON_6=6;exports.GMPD_BUTTON_7=7;exports.GMPD_BUTTON_8=8;exports.GMPD_BUTTON_9=9;exports.GMPD_BUTTON_10=10;exports.GMPD_BUTTON_11=11;exports.GMPD_BUTTON_12=12;exports.GMPD_BUTTON_13=13;exports.GMPD_BUTTON_14=14;exports.GMPD_BUTTON_15=15;exports.GMPD_BUTTON_16=16;exports.GMPD_BUTTON_17=17;exports.GMPD_BUTTON_18=18;exports.GMPD_BUTTON_19=19;exports.GMPD_BUTTON_20=20;exports.GMPD_BUTTON_21=
21;exports.GMPD_BUTTON_22=22;exports.GMPD_BUTTON_23=23;exports.GMPD_BUTTON_24=24;exports.GMPD_BUTTON_25=25;exports.GMPD_AXIS_0=26;exports.GMPD_AXIS_1=27;exports.GMPD_AXIS_2=28;exports.GMPD_AXIS_3=29;exports.GMPD_AXIS_4=30;exports.GMPD_AXIS_5=31;exports.GMPD_AXIS_6=32;exports.GMPD_AXIS_7=33;exports.GMPD_AXIS_8=34;exports.GMPD_AXIS_9=35;exports.GMPD_AXIS_10=36;exports.GMPD_AXIS_11=37;var GMPD_AXIS_OFFSET=26;var _quat_tmp=m_quat.create();var _quat_tmp2=m_quat.create();var _vec3_tmp=m_vec3.create();var _location=
new Float32Array(2);var _trans=m_vec3.create();var _angles=m_vec3.create();var _quat=m_quat.create();var _devices=[];exports.can_use_device=can_use_device;function can_use_device(type){if(type==DEVICE_HMD&&!navigator.getVRDevices&&!cfg_def.is_mobile_device||type==DEVICE_GYRO&&(!cfg_def.is_mobile_device||!window.DeviceOrientationEvent))return false;else return true}function init_device(type,element){if(!can_use_device(type))return null;var device={type:type,registered:false,orientation_quat_cb_list:[],
orientation_angles_cb_list:[],mouse_down_which_cb_list:[],mouse_location_cb_list:[],mouse_up_which_cb_list:[],mouse_wheel_cb_list:[],keyboard_down_cb_list:[],keyboard_up_cb_list:[],touch_start_cb_list:[],touch_move_cb_list:[],touch_end_cb_list:[],element:element,prevent_default:true,registered_event_listeners:[],mouse_location:new Float32Array(2),mouse_which:0,distortion_coefs:new Float32Array(2),chromatic_aberration_coefs:new Float32Array(4),webvr_hmd_device:null,webvr_sensor_devices:null,fov_left:new Float32Array(4),
fov_right:new Float32Array(4),inter_lens_dist:0,base_line_dist:0,screen_to_lens_dist:0,width_dist:0,height_dist:0,bevel_size:0,gamepad_btns:[],gamepad_axes:[0,0,0,0,0,0,0,0,0,0,0,0],gamepad_prev_axes:[0,0,0,0,0,0,0,0,0,0,0,0],gamepad_mapping:[]};device.fov_left[0]=device.fov_left[1]=device.fov_left[2]=device.fov_left[3]=45;device.fov_right[0]=device.fov_right[1]=device.fov_right[2]=device.fov_right[3]=45;if(type==DEVICE_MOUSE||type==DEVICE_KEYBOARD||type==DEVICE_TOUCH){device.registered=Boolean(element);
if(type==DEVICE_TOUCH)document.addEventListener("touchstart",function(){});else if(type==DEVICE_KEYBOARD)device.prevent_default=false}else if(type==DEVICE_GYRO)device.registered=true;else if(type==DEVICE_HMD)if(navigator.getVRDevices&&!cfg_def.is_mobile_device)setup_distortion_coef(device,cfg_hmdp["webvr"]);else{setup_nonwebvr_hmd_device(device);device.registered=true}return device}exports.get_device_by_type_element=get_device_by_type_element;function get_device_by_type_element(type,element){if(type==
DEVICE_GYRO||type==DEVICE_HMD)element=window;else if(!element)element=m_cont.get_container();for(var i=0;i<_devices.length;i++)if(_devices[i].type==type&&_devices[i].element==element)return _devices[i];var device=init_device(type,element);if(type==DEVICE_GAMEPAD0||type==DEVICE_GAMEPAD1||type==DEVICE_GAMEPAD2||type==DEVICE_GAMEPAD3)set_gamepad_mapping(device);if(device)_devices.push(device);return device}function set_gamepad_mapping(device){device.gamepad_mapping.push(exports.GMPD_BUTTON_0,exports.GMPD_BUTTON_1,
exports.GMPD_BUTTON_2,exports.GMPD_BUTTON_3,exports.GMPD_BUTTON_4,exports.GMPD_BUTTON_5,exports.GMPD_BUTTON_6,exports.GMPD_BUTTON_7,exports.GMPD_BUTTON_8,exports.GMPD_BUTTON_9,exports.GMPD_BUTTON_10,exports.GMPD_BUTTON_11,exports.GMPD_BUTTON_12,exports.GMPD_BUTTON_13,exports.GMPD_BUTTON_14,exports.GMPD_BUTTON_15,exports.GMPD_BUTTON_16,exports.GMPD_BUTTON_17,exports.GMPD_BUTTON_18,exports.GMPD_BUTTON_19,exports.GMPD_BUTTON_20,exports.GMPD_BUTTON_21,exports.GMPD_BUTTON_22,exports.GMPD_BUTTON_23,exports.GMPD_BUTTON_24,
exports.GMPD_BUTTON_25,exports.GMPD_AXIS_0,exports.GMPD_AXIS_1,exports.GMPD_AXIS_2,exports.GMPD_AXIS_3,exports.GMPD_AXIS_4,exports.GMPD_AXIS_5,exports.GMPD_AXIS_6,exports.GMPD_AXIS_7,exports.GMPD_AXIS_8,exports.GMPD_AXIS_9,exports.GMPD_AXIS_10,exports.GMPD_AXIS_11)}function get_devices_by_element(element){var devices=[];for(var i=0;i<_devices.length;i++)if(_devices[i].element==element)devices.push(_devices[i]);return devices}exports.switch_prevent_default=function(device,prevent_default){device.prevent_default=
prevent_default};function setup_nonwebvr_hmd_device(device){var device_params=cfg_hmdp["nonwebvr"];device.width_dist=device_params.width_dist;device.height_dist=device_params.height_dist;device.bevel_size=device_params.bevel_size;setup_distortion_coef(device,device_params);device.inter_lens_dist=device_params.inter_lens_dist;device.base_line_dist=device_params.base_line_dist;device.screen_to_lens_dist=device_params.screen_to_lens_dist;update_nonwebvr_fov(device)}function setup_distortion_coef(device,
device_params){device.distortion_coefs[0]=device_params.distortion_coefs[0],device.distortion_coefs[1]=device_params.distortion_coefs[1];device.chromatic_aberration_coefs[0]=device_params.chromatic_aberration_coefs[0];device.chromatic_aberration_coefs[1]=device_params.chromatic_aberration_coefs[1];device.chromatic_aberration_coefs[2]=device_params.chromatic_aberration_coefs[2];device.chromatic_aberration_coefs[3]=device_params.chromatic_aberration_coefs[3]}function get_distort_fact_radius(distortion_coefs,
radius){var rsq=radius*radius;return radius*(1+distortion_coefs[0]*rsq+distortion_coefs[1]*rsq*rsq)}function update_nonwebvr_fov(device){var bottom_dist=device.base_line_dist-device.bevel_size;var top_dist=device.height_dist-bottom_dist;var inner_dist=device.inter_lens_dist/2;var outer_dist=device.width_dist/2-device.inter_lens_dist;var distor_coef=device.distortion_coefs;var bottom_tang=get_distort_fact_radius(distor_coef,bottom_dist/device.screen_to_lens_dist);var bottom_angle=m_util.rad_to_deg(Math.atan(bottom_tang));
var top_tang=get_distort_fact_radius(distor_coef,top_dist/device.screen_to_lens_dist);var top_angle=m_util.rad_to_deg(Math.atan(top_tang));var inner_tang=get_distort_fact_radius(distor_coef,top_dist/device.screen_to_lens_dist);var inner_angle=m_util.rad_to_deg(Math.atan(inner_tang));var outer_tang=get_distort_fact_radius(distor_coef,top_dist/device.screen_to_lens_dist);var outer_angle=m_util.rad_to_deg(Math.atan(outer_tang));if(top_angle)device.fov_left[0]=device.fov_right[0]=Math.min(top_angle,60);
if(inner_angle)device.fov_left[1]=device.fov_right[3]=Math.min(inner_angle,60);if(bottom_angle)device.fov_left[2]=device.fov_right[2]=Math.min(bottom_angle,60);if(outer_angle)device.fov_left[3]=device.fov_right[1]=Math.min(outer_angle,60)}function setup_webvr_devices(device,webvr_devices){var webvr_hmd_devices=webvr_devices.filter(function(device){return device instanceof HMDVRDevice});var webvr_hmd_device=null;if(webvr_hmd_devices.length)webvr_hmd_device=webvr_hmd_devices[0];var webvr_sensor_devices=
null;if(webvr_hmd_device)webvr_sensor_devices=webvr_devices.filter(function(webvr_device){return webvr_device.deviceName.toLowerCase().indexOf("oculus")!==-1&&webvr_device.hardwareUnitId==webvr_hmd_device.hardwareUnitId&&webvr_device instanceof PositionSensorVRDevice});device.webvr_hmd_device=webvr_hmd_device;device.webvr_sensor_devices=webvr_sensor_devices}exports.reset_device=reset_device;function reset_device(device){switch(device.type){case DEVICE_HMD:if(device.registered&&device.webvr_sensor_devices)for(var i=
0;i<device.webvr_sensor_devices.length;i++){var webvr_device=device.webvr_sensor_devices[i];webvr_device.resetSensor()}break;default:m_print.error("reset_device() is undefined for device: ",device.type);return}}function get_fov(device,eye,dest){switch(device.type){case DEVICE_HMD:if(device.webvr_hmd_device){var param=device.webvr_hmd_device.getEyeParameters(eye);if(param&&param.currentFieldOfView){var distor_coef=device.distortion_coefs;var bottom_tang=get_distort_fact_radius(distor_coef,Math.tan(m_util.deg_to_rad(param.currentFieldOfView["downDegrees"])));
var bottom_angle=m_util.rad_to_deg(Math.atan(bottom_tang));var top_tang=get_distort_fact_radius(distor_coef,Math.tan(m_util.deg_to_rad(param.currentFieldOfView["upDegrees"])));var top_angle=m_util.rad_to_deg(Math.atan(top_tang));var left_tang=get_distort_fact_radius(distor_coef,Math.tan(m_util.deg_to_rad(param.currentFieldOfView["leftDegrees"])));var left_angle=m_util.rad_to_deg(Math.atan(left_tang));var right_tang=get_distort_fact_radius(distor_coef,Math.tan(m_util.deg_to_rad(param.currentFieldOfView["rightDegrees"])));
var right_angle=m_util.rad_to_deg(Math.atan(right_tang));dest[0]=top_angle;dest[1]=right_angle;dest[2]=bottom_angle;dest[3]=left_angle;return dest}}else{if(eye=="left")var fov=device.fov_left;else var fov=device.fov_right;m_vec4.copy(fov,dest)}break;default:m_print.error("fov is undefined for device: ",device.type);break}return dest}exports.get_vector_param=function(device,param,dest){switch(param){case HMD_ORIENTATION_QUAT:return get_orientation_quat(device,dest);case HMD_POSITION:return get_position(device,
dest);case HMD_FOV_LEFT:return get_fov(device,"left",dest);case HMD_FOV_RIGHT:return get_fov(device,"right",dest);case MOUSE_LOCATION:dest[0]=device.mouse_location[0];dest[1]=device.mouse_location[1];return dest}};exports.get_value_param=function(device,param){switch(param){case HMD_WEBVR_TYPE:if(device.type==DEVICE_HMD&&navigator.getVRDevices)if(cfg_def.is_mobile_device)return HMD_WEBVR_MOBILE;else return HMD_WEBVR_DESKTOP;else return HMD_NON_WEBVR;case HMD_EYE_DISTANCE:if(device.webvr_hmd_device){var param_left=
device.webvr_hmd_device.getEyeParameters("left");var param_right=device.webvr_hmd_device.getEyeParameters("right");return param_right.eyeTranslation["x"]-param_left.eyeTranslation["x"]}else return device.inter_lens_dist}};exports.set_config=function(device,config,value){switch(device.type){case DEVICE_HMD:switch(config){case HMD_DISTORTION:device.distortion_coefs[0]=value[0];device.distortion_coefs[1]=value[1];break;case HMD_EYE_DISTANCE:device.inter_lens_dist=value;update_nonwebvr_fov(device);break;
case HMD_BASELINE_DIST:device.base_line_dist=value;update_nonwebvr_fov(device);break;case HMD_SCREEN_LENSE_DIST:device.screen_to_lens_dist=value;update_nonwebvr_fov(device);break;case HMD_SCREEN_WIDTH:device.width_dist=value;update_nonwebvr_fov(device);break;case HMD_SCREEN_HEIGHT:device.height_dist=value;update_nonwebvr_fov(device);break;case HMD_BEVEL_SIZE:device.bevel_size=value;update_nonwebvr_fov(device);break}case DEVICE_GAMEPAD0:case DEVICE_GAMEPAD1:case DEVICE_GAMEPAD2:case DEVICE_GAMEPAD3:device.gamepad_mapping[config]=
value;break}};exports.get_gamepad_btn_value=function(device,btn){if(btn<device.gamepad_btns.length)return device.gamepad_btns[get_gamepad_btn_key(device,btn)];else return false};exports.get_gamepad_axis_value=function(device,btn){if(btn-GMPD_AXIS_OFFSET<device.gamepad_axes.length)return device.gamepad_axes[get_gamepad_btn_key(device,btn)-GMPD_AXIS_OFFSET];else return 0};exports.update=function(){var gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:
[];for(var i=0;i<_devices.length;i++){var device=_devices[i];switch(device.type){case DEVICE_GAMEPAD0:clear_gamepad_device(device);update_gamepad_device(gamepads[0],device);break;case DEVICE_GAMEPAD1:clear_gamepad_device(device);update_gamepad_device(gamepads[1],device);break;case DEVICE_GAMEPAD2:clear_gamepad_device(device);update_gamepad_device(gamepads[2],device);break;case DEVICE_GAMEPAD3:clear_gamepad_device(device);update_gamepad_device(gamepads[3],device);break;case DEVICE_HMD:update_hmd(device);
break}}};function update_hmd(device){if(navigator.getVRDevices)navigator.getVRDevices().then(function(webvr_devices){setup_webvr_devices(device,webvr_devices);if(webvr_devices.length)device.registered=true},function(error){m_print.error_once("WebVR devices are not found.");device.registered=false})}function update_gamepad_device(gamepad,device){if(gamepad){for(var i=0;i<gamepad["buttons"].length;i++)device.gamepad_btns[i]=gamepad["buttons"][i]["pressed"];if(gamepad["axes"]&&gamepad["axes"].length<=
12)for(var i=0;i<gamepad["axes"].length;i++)device.gamepad_axes[i]=gamepad["axes"][i]}}function clear_gamepad_device(device){for(var i=0;i<device.gamepad_btns;i++)device.gamepad_btns[i]=false;for(var i=0;i<device.gamepad_axes.length;i++){device.gamepad_prev_axes[i]=device.gamepad_axes[i];device.gamepad_axes[i]=0}}exports.attach_param_cb=function(device,param,cb){switch(param){case GYRO_ORIENTATION_QUAT:device.orientation_quat_cb_list.push(cb);param=DEVICE_ORIENTATION;break;case GYRO_ORIENTATION_ANGLES:device.orientation_angles_cb_list.push(cb);
param=DEVICE_ORIENTATION;break;case MOUSE_DOWN_WHICH:device.mouse_down_which_cb_list.push(cb);break;case MOUSE_LOCATION:device.mouse_location_cb_list.push(cb);break;case MOUSE_UP_WHICH:device.mouse_up_which_cb_list.push(cb);break;case MOUSE_WHEEL:device.mouse_wheel_cb_list.push(cb);break;case KEYBOARD_DOWN:device.keyboard_down_cb_list.push(cb);break;case KEYBOARD_UP:device.keyboard_up_cb_list.push(cb);break;case TOUCH_START:device.touch_start_cb_list.push(cb);break;case TOUCH_MOVE:device.touch_move_cb_list.push(cb);
break;case TOUCH_END:device.touch_end_cb_list.push(cb);break}if(device.registered_event_listeners.indexOf(param)==-1){device.registered_event_listeners.push(param);if(device.registered)register_event_listener(device,param)}};function replace_cb_with_null(cb_list,cb){var cb_index=cb_list.indexOf(cb);if(cb_index>=0)cb_list[cb_index]=null}function is_null(x){return x===null}exports.detach_param_cb=function(device,param,cb){unregister_event_listener(device,param,cb,false,false)};function unregister_event_listener(device,
param,cb,force){switch(param){case GYRO_ORIENTATION_QUAT:cb&&replace_cb_with_null(device.orientation_quat_cb_list,cb);if(force||device.orientation_angles_cb_list.every(is_null)&&device.orientation_quat_cb_list.every(is_null)){device.orientation_quat_cb_list.length=0;device.orientation_angles_cb_list.length=0;param=DEVICE_ORIENTATION;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("deviceorientation",
device_orientation_cb,false)}}break;case GYRO_ORIENTATION_ANGLES:cb&&replace_cb_with_null(device.orientation_angles_cb_list,cb);if(force||device.orientation_angles_cb_list.every(is_null)&&device.orientation_quat_cb_list.every(is_null)){device.orientation_quat_cb_list.length=0;device.orientation_angles_cb_list.length=0;param=DEVICE_ORIENTATION;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("deviceorientation",
device_orientation_cb,false)}}break;case MOUSE_DOWN_WHICH:cb&&replace_cb_with_null(device.mouse_down_which_cb_list,cb);if(force||device.mouse_down_which_cb_list.every(is_null)){device.mouse_down_which_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("mousedown",mouse_down_cb,false)}}break;case MOUSE_LOCATION:cb&&replace_cb_with_null(device.mouse_location_cb_list,
cb);if(force||device.mouse_location_cb_list.every(is_null)){device.mouse_location_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("mousemove",mouse_move_cb,false)}}break;case MOUSE_UP_WHICH:cb&&replace_cb_with_null(device.mouse_up_which_cb_list,cb);if(force||device.mouse_up_which_cb_list.every(is_null)){device.mouse_up_which_cb_list.length=0;var param_index=
device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("mouseout",mouse_out_cb,false);device.element.removeEventListener("mouseup",mouse_up_cb,false)}break}break;case MOUSE_WHEEL:cb&&replace_cb_with_null(device.mouse_wheel_cb_list,cb);if(force||device.mouse_wheel_cb_list.every(is_null)){device.mouse_wheel_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=
0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("wheel",mouse_wheel_cb,false)}}break;case KEYBOARD_DOWN:cb&&replace_cb_with_null(device.keyboard_down_cb_list,cb);if(force||device.keyboard_down_cb_list.every(is_null)){device.keyboard_down_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("keydown",keyboard_down_cb,
false)}}break;case KEYBOARD_UP:cb&&replace_cb_with_null(device.keyboard_up_cb_list,cb);if(force||device.keyboard_up_cb_list.every(is_null)){device.keyboard_up_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("keyup",keyboard_up_cb,false)}}break;case TOUCH_START:cb&&replace_cb_with_null(device.touch_start_cb_list,cb);if(force||device.touch_start_cb_list.every(is_null)){device.touch_start_cb_list.length=
0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("touchstart",touch_start_cb,false)}}break;case TOUCH_MOVE:cb&&replace_cb_with_null(device.touch_move_cb_list,cb);if(force||device.touch_move_cb_list.every(is_null)){device.touch_move_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,
1);device.element.removeEventListener("touchmove",touch_move_cb,false)}}break;case TOUCH_END:cb&&replace_cb_with_null(device.touch_end_cb_list,cb);if(force||device.touch_end_cb_list.every(is_null)){device.touch_end_cb_list.length=0;var param_index=device.registered_event_listeners.indexOf(param);if(param_index>=0){device.registered_event_listeners.splice(param_index,1);device.element.removeEventListener("touchend",touch_end_cb,false)}}break}}function register_event_listener(device,event_name){switch(event_name){case MOUSE_DOWN_WHICH:device.element.addEventListener("mousedown",
mouse_down_cb,false);break;case MOUSE_LOCATION:device.element.addEventListener("mousemove",mouse_move_cb,false);break;case MOUSE_UP_WHICH:if(device.element!=window)device.element.addEventListener("mouseout",mouse_up_cb,false);device.element.addEventListener("mouseup",mouse_up_cb,false);break;case MOUSE_WHEEL:device.element.addEventListener("wheel",mouse_wheel_cb,false);break;case KEYBOARD_DOWN:device.element.addEventListener("keydown",keyboard_down_cb,false);break;case KEYBOARD_UP:device.element.addEventListener("keyup",
keyboard_up_cb,false);break;case TOUCH_START:device.element.addEventListener("touchstart",touch_start_cb,false);break;case TOUCH_MOVE:device.element.addEventListener("touchmove",touch_move_cb,false);break;case TOUCH_END:device.element.addEventListener("touchend",touch_end_cb,false);break;case DEVICE_ORIENTATION:device.element.addEventListener("deviceorientation",device_orientation_cb,false);break}}function get_orientation_quat(device,dest){switch(device.type){case DEVICE_HMD:m_vec3.copy(m_util.VEC3_UNIT,
dest);if(device.webvr_sensor_devices)for(var i=0;i<device.webvr_sensor_devices.length;i++){var webvr_sensor_device=device.webvr_sensor_devices[i];var webvr_state=webvr_sensor_device.getState&&webvr_sensor_device.getState()||webvr_sensor_device.getImmediateState&&webvr_sensor_device.getImmediateState();if(webvr_state.orientation){dest[0]=webvr_state.orientation["x"];dest[1]=webvr_state.orientation["y"];dest[2]=webvr_state.orientation["z"];dest[3]=webvr_state.orientation["w"]}}m_quat.normalize(dest,
dest);var quat=m_quat.setAxisAngle(m_util.AXIS_X,Math.PI/2,_quat_tmp);m_quat.multiply(dest,quat,dest);return dest;default:m_print.error("orientation_quat is undefined for device: ",device.type);return dest}}function get_position(device,dest){switch(device.type){case DEVICE_HMD:if(device.webvr_sensor_devices)for(var i=0;i<device.webvr_sensor_devices.length;i++){var webvr_sensor_device=device.webvr_sensor_devices[i];var webvr_state=webvr_sensor_device.getState&&webvr_sensor_device.getState()||webvr_sensor_device.getImmediateState&&
webvr_sensor_device.getImmediateState();if(webvr_state.position){dest[0]=webvr_state.position["x"];dest[1]=webvr_state.position["y"];dest[2]=webvr_state.position["z"]}}return dest;default:m_print.error("position is undefined for device: ",device.type);return dest}}exports.gyro_angles_to_quat=gyro_angles_to_quat;function gyro_angles_to_quat(angles,dest){m_util.ordered_angles_to_quat(angles,m_util.ZXY,dest);if("orientation"in window)var screen_orient=m_util.deg_to_rad(window.orientation);else if("orientation"in
window.screen)var screen_orient=m_util.deg_to_rad(window.screen.orientation.angle);else var screen_orient=0;var screen_quat=m_quat.setAxisAngle(m_util.AXIS_Z,-screen_orient,_quat_tmp2);m_quat.multiply(dest,screen_quat,dest);var quat=m_quat.setAxisAngle(m_util.AXIS_X,-Math.PI/2,_quat_tmp2);m_quat.multiply(quat,dest,dest);var quat=m_quat.setAxisAngle(m_util.AXIS_X,Math.PI/2,_quat_tmp2);m_quat.multiply(dest,quat,dest);return dest}function device_orientation_cb(event){var euler_angles=_vec3_tmp;if(event.alpha===
null||event.beta===null||event.gamma===null)euler_angles[0]=euler_angles[1]=euler_angles[2]=0;else{euler_angles[0]=m_util.deg_to_rad(event.alpha);euler_angles[1]=m_util.deg_to_rad(event.beta);euler_angles[2]=m_util.deg_to_rad(event.gamma)}var device=get_device_by_type_element(DEVICE_GYRO,event.currentTarget);for(var i=0;i<device.orientation_angles_cb_list.length;i++){var cb=device.orientation_angles_cb_list[i];if(cb){m_vec3.copy(euler_angles,_angles);cb(_angles)}}if(device.orientation_quat_cb_list.length){var quaternion=
gyro_angles_to_quat(euler_angles,_quat_tmp);for(var i=0;i<device.orientation_quat_cb_list.length;i++){var cb=device.orientation_quat_cb_list[i];if(cb){m_quat.copy(quaternion,_quat);cb(_quat)}}}for(var i=0;i<device.orientation_quat_cb_list.length;i++)if(!device.orientation_quat_cb_list[i])device.orientation_quat_cb_list.splice(i,1);for(var i=0;i<device.orientation_angles_cb_list.length;i++)if(!device.orientation_angles_cb_list[i])device.orientation_angles_cb_list.splice(i,1)}function update_device(device,
event){switch(device.type){case DEVICE_MOUSE:device.mouse_location[0]=event.clientX;device.mouse_location[1]=event.clientY;device.mouse_which=event.which;break}}function mouse_move_cb(event){var device=get_device_by_type_element(DEVICE_MOUSE,event.currentTarget);update_device(device,event);for(var i=0;i<device.mouse_location_cb_list.length;i++){var cb=device.mouse_location_cb_list[i];if(cb){_location[0]=event.clientX;_location[1]=event.clientY;cb(_location)}}if(device.prevent_default)event.preventDefault();
for(var i=0;i<device.mouse_location_cb_list.length;i++)if(!device.mouse_location_cb_list[i])device.mouse_location_cb_list.splice(i,1)}function mouse_down_cb(event){var device=get_device_by_type_element(DEVICE_MOUSE,event.currentTarget);update_device(device,event);for(var i=0;i<device.mouse_down_which_cb_list.length;i++){var cb=device.mouse_down_which_cb_list[i];if(cb)cb(event.which)}if(device.prevent_default)event.preventDefault();for(var i=0;i<device.mouse_down_which_cb_list.length;i++)if(!device.mouse_down_which_cb_list[i])device.mouse_down_which_cb_list.splice(i,
1)}function mouse_out_cb(event){if(!m_cont.is_child(event.relatedTarget))mouse_up_cb(event)}function mouse_up_cb(event){var device=get_device_by_type_element(DEVICE_MOUSE,event.currentTarget);update_device(device,event);for(var i=0;i<device.mouse_up_which_cb_list.length;i++){var cb=device.mouse_up_which_cb_list[i];if(cb)cb(event.which)}if(device.prevent_default)event.preventDefault();for(var i=0;i<device.mouse_up_which_cb_list.length;i++)if(!device.mouse_up_which_cb_list[i])device.mouse_up_which_cb_list.splice(i,
1)}function mouse_wheel_cb(event){var device=get_device_by_type_element(DEVICE_MOUSE,event.currentTarget);for(var i=0;i<device.mouse_wheel_cb_list.length;i++){var cb=device.mouse_wheel_cb_list[i];if(cb)cb(-event.deltaY)}if(device.prevent_default)event.preventDefault();for(var i=0;i<device.mouse_wheel_cb_list.length;i++)if(!device.mouse_wheel_cb_list[i])device.mouse_wheel_cb_list.splice(i,1)}function keyboard_down_cb(event){var device=get_device_by_type_element(DEVICE_KEYBOARD,event.currentTarget);
for(var i=0;i<device.keyboard_down_cb_list.length;i++){var cb=device.keyboard_down_cb_list[i];if(cb)cb(event.keyCode)}if(device.prevent_default)event.preventDefault();for(var i=0;i<device.keyboard_down_cb_list.length;i++)if(!device.keyboard_down_cb_list[i])device.keyboard_down_cb_list.splice(i,1)}function keyboard_up_cb(event){var device=get_device_by_type_element(DEVICE_KEYBOARD,event.currentTarget);for(var i=0;i<device.keyboard_up_cb_list.length;i++){var cb=device.keyboard_up_cb_list[i];if(cb)cb(event.keyCode)}if(device.prevent_default)event.preventDefault();
for(var i=0;i<device.keyboard_up_cb_list.length;i++)if(!device.keyboard_up_cb_list[i])device.keyboard_up_cb_list.splice(i,1)}function touch_start_cb(event){var device=get_device_by_type_element(DEVICE_TOUCH,event.currentTarget);for(var i=0;i<device.touch_start_cb_list.length;i++){var cb=device.touch_start_cb_list[i];if(cb)cb(event.targetTouches)}for(var i=0;i<device.touch_start_cb_list.length;i++)if(!device.touch_start_cb_list[i])device.touch_start_cb_list.splice(i,1)}function touch_move_cb(event){var device=
get_device_by_type_element(DEVICE_TOUCH,event.currentTarget);for(var i=0;i<device.touch_move_cb_list.length;i++){var cb=device.touch_move_cb_list[i];if(cb)cb(event.targetTouches)}if(device.prevent_default)event.preventDefault();for(var i=0;i<device.touch_move_cb_list.length;i++)if(!device.touch_move_cb_list[i])device.touch_move_cb_list.splice(i,1)}function touch_end_cb(event){var device=get_device_by_type_element(DEVICE_TOUCH,event.currentTarget);for(var i=0;i<device.touch_end_cb_list.length;i++){var cb=
device.touch_end_cb_list[i];if(cb)cb(event.targetTouches)}for(var i=0;i<device.touch_end_cb_list.length;i++)if(!device.touch_end_cb_list[i])device.touch_end_cb_list.splice(i,1)}exports.cleanup=function(){for(var i=0;i<_devices.length;i++){var device=_devices[i];for(var j=0;j<device.registered_event_listeners.length;j++){var param=device.registered_event_listeners[j];unregister_event_listener(device,param,null,true)}}_devices.length=0};exports.get_pressed_gmpd_btn=function(gamepad_id){var type=get_gmpd_type_by_id(gamepad_id);
var device=get_device_by_type_element(type);for(var i=0;i<device.gamepad_btns.length;i++)if(device.gamepad_btns[i])return i;return-1};exports.get_moved_gmpd_axis=function(gamepad_id){var type=get_gmpd_type_by_id(gamepad_id);var device=get_device_by_type_element(type);for(var i=0;i<device.gamepad_axes.length;i++)if(device.gamepad_prev_axes[i]-device.gamepad_axes[i])return i+GMPD_AXIS_OFFSET;return-1};function get_gmpd_type_by_id(gamepad_id){switch(gamepad_id){case 0:var type=DEVICE_GAMEPAD0;break;
case 1:var type=DEVICE_GAMEPAD1;break;case 2:var type=DEVICE_GAMEPAD2;break;case 3:var type=DEVICE_GAMEPAD3;break;default:var type=DEVICE_GAMEPAD0}return type}function get_gamepad_btn_key(device,btn){return device.gamepad_mapping[btn]}exports.get_first_gmpd_id=function(){var gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];for(var i=0;i<gamepads.length;i++)if(gamepads[i])return i;return 0}};b4w.module["__vec3"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var vec3=exports;vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(a,
out){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(x,y,z,out){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(a,b,out){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(a,b,out){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(a,b,out){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(a,b,out){out[0]=a[0]/b[0];out[1]=
a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(a,b,out){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(a,b,out){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(a,b,out){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.scaleAndAdd=function(a,b,scale,out){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;return out};
vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(a,out){out[0]=-a[0];
out[1]=-a[1];out[2]=-a[2];return out};vec3.inverse=function(a,out){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];return out};vec3.normalize=function(a,out){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(a,b,out){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=
function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.hermite=function(a,b,c,d,t,out){var factorTimes2=t*t,factor1=factorTimes2*(2*t-3)+1,factor2=factorTimes2*(t-2)+t,factor3=factorTimes2*(t-1),factor4=factorTimes2*(3-2*t);out[0]=a[0]*factor1+b[0]*factor2+c[0]*factor3+d[0]*factor4;out[1]=a[1]*factor1+b[1]*factor2+c[1]*factor3+d[1]*factor4;out[2]=a[2]*factor1+b[2]*factor2+c[2]*factor3+d[2]*factor4;return out};vec3.bezier=
function(a,b,c,d,t,out){var inverseFactor=1-t,inverseFactorTimesTwo=inverseFactor*inverseFactor,factorTimes2=t*t,factor1=inverseFactorTimesTwo*inverseFactor,factor2=3*t*inverseFactorTimesTwo,factor3=3*factorTimes2*inverseFactor,factor4=factorTimes2*t;out[0]=a[0]*factor1+b[0]*factor2+c[0]*factor3+d[0]*factor4;out[1]=a[1]*factor1+b[1]*factor2+c[1]*factor3+d[1]*factor4;out[2]=a[2]*factor1+b[2]*factor2+c[2]*factor3+d[2]*factor4;return out};vec3.random=function(scale,out){scale=scale||1;var r=GLMAT_RANDOM()*
2*Math.PI;var z=GLMAT_RANDOM()*2-1;var zScale=Math.sqrt(1-z*z)*scale;out[0]=Math.cos(r)*zScale;out[1]=Math.sin(r)*zScale;out[2]=z*scale;return out};vec3.transformMat4=function(a,m,out){var x=a[0],y=a[1],z=a[2],w=m[3]*x+m[7]*y+m[11]*z+m[15];w=w||1;out[0]=(m[0]*x+m[4]*y+m[8]*z+m[12])/w;out[1]=(m[1]*x+m[5]*y+m[9]*z+m[13])/w;out[2]=(m[2]*x+m[6]*y+m[10]*z+m[14])/w;return out};vec3.transformMat3=function(a,m,out){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*
m[2]+y*m[5]+z*m[8];return out};vec3.transformQuat=function(a,q,out){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.rotateX=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0];r[1]=p[1]*Math.cos(c)-p[2]*Math.sin(c);r[2]=p[1]*Math.sin(c)+p[2]*Math.cos(c);out[0]=r[0]+
b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateY=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[2]*Math.sin(c)+p[0]*Math.cos(c);r[1]=p[1];r[2]=p[2]*Math.cos(c)-p[0]*Math.sin(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateZ=function(a,b,c,out){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0]*Math.cos(c)-p[1]*Math.sin(c);r[1]=p[0]*Math.sin(c)+p[1]*Math.cos(c);r[2]=p[2];out[0]=r[0]+b[0];out[1]=r[1]+
b[1];out[2]=r[2]+b[2];return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride)stride=3;if(!offset)offset=0;if(count)l=Math.min(count*stride+offset,a.length);else l=a.length;for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,arg,vec);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.angle=function(a,b){var tempA=vec3.fromValues(a[0],a[1],a[2]);var tempB=vec3.fromValues(b[0],b[1],b[2]);vec3.normalize(tempA,
tempA);vec3.normalize(tempB,tempB);var cosine=vec3.dot(tempA,tempB);if(cosine>1)return 0;else return Math.acos(cosine)};vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"}};b4w.module["vec3"]=b4w.module["__vec3"];
b4w.module["__vec4"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var vec4=exports;vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;
out[3]=w;return out};vec4.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(x,y,z,w,out){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(a,b,out){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(a,b,out){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(a,b,out){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=
a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(a,b,out){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(a,b,out){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(a,b,out){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(a,
b,out){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.scaleAndAdd=function(a,b,scale,out){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;
vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(a,out){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.inverse=function(a,out){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];out[3]=1/a[3];return out};vec4.normalize=function(a,out){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+
w*w;if(len>0){len=1/Math.sqrt(len);out[0]=x*len;out[1]=y*len;out[2]=z*len;out[3]=w*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.random=function(scale,out){scale=scale||1;out[0]=GLMAT_RANDOM();out[1]=GLMAT_RANDOM();out[2]=GLMAT_RANDOM();out[3]=GLMAT_RANDOM();vec4.normalize(out,out);vec4.scale(out,
scale,out);return out};vec4.transformMat4=function(a,m,out){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(a,q,out){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*
-qz+ix*-qy-iy*-qx;out[3]=a[3];return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride)stride=4;if(!offset)offset=0;if(count)l=Math.min(count*stride+offset,a.length);else l=a.length;for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,arg,vec);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"}};
b4w.module["vec4"]=b4w.module["__vec4"];
b4w.module["__quat"]=function(exports,require){var vec3=require("__vec3");var vec4=require("__vec4");var mat3=require("__mat3");var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var quat=exports;quat.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.rotationTo=function(){var tmpvec3=vec3.create();var xUnitVec3=vec3.fromValues(1,0,0);var yUnitVec3=vec3.fromValues(0,1,0);
return function(a,b,out){var dot=vec3.dot(a,b);if(dot<-.9999999){vec3.cross(xUnitVec3,a,tmpvec3);if(vec3.length(tmpvec3)<1E-6)vec3.cross(yUnitVec3,a,tmpvec3);vec3.normalize(tmpvec3,tmpvec3);quat.setAxisAngle(tmpvec3,Math.PI,out);return out}else if(dot>.9999999){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}else{vec3.cross(a,b,tmpvec3);out[0]=tmpvec3[0];out[1]=tmpvec3[1];out[2]=tmpvec3[2];out[3]=1+dot;return quat.normalize(out,out)}}}();quat.setAxes=function(){var matr=mat3.create();return function(view,
right,up,out){matr[0]=right[0];matr[3]=right[1];matr[6]=right[2];matr[1]=up[0];matr[4]=up[1];matr[7]=up[2];matr[2]=-view[0];matr[5]=-view[1];matr[8]=-view[2];return quat.normalize(quat.fromMat3(matr,out),out)}}();quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(axis,rad,out){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];
out[3]=Math.cos(rad);return out};quat.add=vec4.add;quat.multiply=function(a,b,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.mul=quat.multiply;quat.scale=vec4.scale;quat.rotateX=function(a,rad,out){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=
aw*bw-ax*bx;return out};quat.rotateY=function(a,rad,out){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(a,rad,out){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(a,out){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=
z;out[3]=Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(a,b,t,out){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw}if(1-cosom>1E-6){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom}else{scale0=1-t;scale1=t}out[0]=scale0*ax+scale1*bx;out[1]=scale0*
ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out};quat.sqlerp=function(){var temp1=quat.create();var temp2=quat.create();return function(a,b,c,d,t,out){quat.slerp(a,d,t,temp1);quat.slerp(b,c,t,temp2);quat.slerp(temp1,temp2,2*t*(1-t),out);return out}}();quat.invert=function(a,out){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(a,
out){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.length=vec4.length;quat.len=quat.length;quat.squaredLength=vec4.squaredLength;quat.sqrLen=quat.squaredLength;quat.normalize=vec4.normalize;quat.fromMat3=function(m,out){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=.5*fRoot;fRoot=.5/fRoot;out[0]=(m[5]-m[7])*fRoot;out[1]=(m[6]-m[2])*fRoot;out[2]=(m[1]-m[3])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=(i+1)%3;var k=(i+2)%3;
fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=.5*fRoot;fRoot=.5/fRoot;out[3]=(m[j*3+k]-m[k*3+j])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out};quat.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"}};b4w.module["quat"]=b4w.module["__quat"];
b4w.module["__mat3"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var mat3=exports;mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat4=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out};mat3.clone=function(a){var out=
new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(a,out){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=
a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det)return null;det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=
(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=
a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(a,b,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*
a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(a,v,out){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(a,rad,out){var a00=a[0],a01=a[1],a02=a[2],
a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(a,v,out){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromTranslation=function(v,out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=
1;out[5]=0;out[6]=v[0];out[7]=v[1];out[8]=1;return out};mat3.fromRotation=function(rad,out){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=-s;out[4]=c;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromScaling=function(v,out){out[0]=v[0];out[1]=0;out[2]=0;out[3]=0;out[4]=v[1];out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat2d=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=
function(q,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out};mat3.normalFromMat4=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*
a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det)return null;det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*
det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};mat3.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))}};b4w.module["mat3"]=b4w.module["__mat3"];
b4w.module["__mat4"]=function(exports,require){var GLMAT_EPSILON=1E-7;var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var GLMAT_RANDOM=Math.random;var mat4=exports;mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=
a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(a,out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=
0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(a,out){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];
out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*
b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det)return null;det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*
b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(a,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));
out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*
(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-
a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+
b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(a,b,out){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=
b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(a,v,out){var x=v[0],y=v[1],
z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*
x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(a,v,out){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(a,rad,axis,out){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,
a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON)return null;len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+
a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],
a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=
a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(a,rad,out){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=
a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromTranslation=function(v,out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromScaling=function(v,out){out[0]=v[0];out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=v[1];out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=v[2];out[11]=0;out[12]=
0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromRotation=function(rad,axis,out){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t;if(Math.abs(len)<GLMAT_EPSILON)return null;len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;out[0]=x*x*t+c;out[1]=y*x*t+z*s;out[2]=z*x*t-y*s;out[3]=0;out[4]=x*y*t-z*s;out[5]=y*y*t+c;out[6]=z*y*t+x*s;out[7]=0;out[8]=x*z*t+y*s;out[9]=y*z*t-x*s;out[10]=z*z*t+c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromXRotation=
function(rad,out){var s=Math.sin(rad),c=Math.cos(rad);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=c;out[6]=s;out[7]=0;out[8]=0;out[9]=-s;out[10]=c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromYRotation=function(rad,out){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=0;out[2]=-s;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=s;out[9]=0;out[10]=c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromZRotation=function(rad,out){var s=Math.sin(rad),
c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=0;out[4]=-s;out[5]=c;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.fromRotationTranslation=function(q,v,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=
0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromRotationTranslationScale=function(q,v,s,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2,sx=s[0],sy=s[1],sz=s[2];out[0]=(1-(yy+zz))*sx;out[1]=(xy+wz)*sx;out[2]=(xz-wy)*sx;out[3]=0;out[4]=(xy-wz)*sy;out[5]=(1-(xx+zz))*sy;out[6]=(yz+wx)*sy;out[7]=0;out[8]=(xz+wy)*sz;out[9]=(yz-wx)*sz;out[10]=(1-(xx+yy))*sz;out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=
v[2];out[15]=1;return out};mat4.fromRotationTranslationScaleOrigin=function(q,v,s,o,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2,sx=s[0],sy=s[1],sz=s[2],ox=o[0],oy=o[1],oz=o[2];out[0]=(1-(yy+zz))*sx;out[1]=(xy+wz)*sx;out[2]=(xz-wy)*sx;out[3]=0;out[4]=(xy-wz)*sy;out[5]=(1-(xx+zz))*sy;out[6]=(yz+wx)*sy;out[7]=0;out[8]=(xz+wy)*sz;out[9]=(yz-wx)*sz;out[10]=(1-(xx+yy))*sz;out[11]=0;out[12]=v[0]+ox-(out[0]*ox+out[4]*oy+
out[8]*oz);out[13]=v[1]+oy-(out[1]*ox+out[5]*oy+out[9]*oz);out[14]=v[2]+oz-(out[2]*ox+out[6]*oy+out[10]*oz);out[15]=1;return out};mat4.fromQuat=function(q,out){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=
function(left,right,bottom,top,near,far,out){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(fovy,aspect,near,far,out){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=
0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.perspectiveFromFieldOfView=function(fov,near,far,out){var upTan=Math.tan(fov.upDegrees*Math.PI/180),downTan=Math.tan(fov.downDegrees*Math.PI/180),leftTan=Math.tan(fov.leftDegrees*Math.PI/180),rightTan=Math.tan(fov.rightDegrees*Math.PI/180),xScale=2/(leftTan+rightTan),yScale=2/(upTan+downTan);out[0]=xScale;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=yScale;out[6]=0;out[7]=0;out[8]=
-((leftTan-rightTan)*xScale*.5);out[9]=(upTan-downTan)*yScale*.5;out[10]=far/(near-far);out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near/(near-far);out[15]=0;return out};mat4.ortho=function(left,right,bottom,top,near,far,out){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=
function(eye,center,up,out){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON)return mat4.identity(out);z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+
x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+
", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};mat4.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))}};b4w.module["mat4"]=b4w.module["__mat4"];b4w.module["__md5"]=function(exports,require){function md5cycle(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=ff(a,b,c,d,k[4],7,-176418897);d=ff(d,a,b,c,k[5],12,1200080426);c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);a=ff(a,b,c,d,k[8],7,1770035416);d=ff(d,a,b,c,k[9],12,-1958414417);c=ff(c,d,a,b,k[10],17,-42063);b=ff(b,c,d,a,k[11],22,-1990404162);a=ff(a,
b,c,d,k[12],7,1804603682);d=ff(d,a,b,c,k[13],12,-40341101);c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);a=gg(a,b,c,d,k[1],5,-165796510);d=gg(d,a,b,c,k[6],9,-1069501632);c=gg(c,d,a,b,k[11],14,643717713);b=gg(b,c,d,a,k[0],20,-373897302);a=gg(a,b,c,d,k[5],5,-701558691);d=gg(d,a,b,c,k[10],9,38016083);c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);a=gg(a,b,c,d,k[9],5,568446438);d=gg(d,a,b,c,k[14],9,-1019803690);c=gg(c,d,a,b,k[3],14,-187363961);b=gg(b,c,d,a,k[8],
20,1163531501);a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);c=gg(c,d,a,b,k[7],14,1735328473);b=gg(b,c,d,a,k[12],20,-1926607734);a=hh(a,b,c,d,k[5],4,-378558);d=hh(d,a,b,c,k[8],11,-2022574463);c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);a=hh(a,b,c,d,k[1],4,-1530992060);d=hh(d,a,b,c,k[4],11,1272893353);c=hh(c,d,a,b,k[7],16,-155497632);b=hh(b,c,d,a,k[10],23,-1094730640);a=hh(a,b,c,d,k[13],4,681279174);d=hh(d,a,b,c,k[0],11,-358537222);c=hh(c,d,a,b,k[3],16,-722521979);
b=hh(b,c,d,a,k[6],23,76029189);a=hh(a,b,c,d,k[9],4,-640364487);d=hh(d,a,b,c,k[12],11,-421815835);c=hh(c,d,a,b,k[15],16,530742520);b=hh(b,c,d,a,k[2],23,-995338651);a=ii(a,b,c,d,k[0],6,-198630844);d=ii(d,a,b,c,k[7],10,1126891415);c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);a=ii(a,b,c,d,k[12],6,1700485571);d=ii(d,a,b,c,k[3],10,-1894986606);c=ii(c,d,a,b,k[10],15,-1051523);b=ii(b,c,d,a,k[1],21,-2054922799);a=ii(a,b,c,d,k[8],6,1873313359);d=ii(d,a,b,c,k[15],10,-30611744);c=ii(c,d,
a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);a=ii(a,b,c,d,k[4],6,-145523070);d=ii(d,a,b,c,k[11],10,-1120210379);c=ii(c,d,a,b,k[2],15,718787259);b=ii(b,c,d,a,k[9],21,-343485551);x[0]=add32(a,x[0]);x[1]=add32(b,x[1]);x[2]=add32(c,x[2]);x[3]=add32(d,x[3])}function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32(a<<s|a>>>32-s,b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^
c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function md51(s){var n=s.length,state=[1732584193,-271733879,-1732584194,271733878],i;for(i=64;i<=s.length;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));s=s.substring(i-64);var tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<s.length;i++)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);tail[i>>2]|=128<<(i%4<<3);if(i>55){md5cycle(state,tail);for(i=0;i<16;i++)tail[i]=0}tail[14]=n*8;md5cycle(state,tail);return state}function md5blk(s){var md5blks=
[],i;for(i=0;i<64;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks}var hex_chr="0123456789abcdef".split("");function rhex(n){var s="",j=0;for(;j<4;j++)s+=hex_chr[n>>j*8+4&15]+hex_chr[n>>j*8&15];return s}function hex(x){for(var i=0;i<x.length;i++)x[i]=rhex(x[i]);return x.join("")}function add32(a,b){return a+b&4294967295}exports.hexdigest=function(msg){return hex(md51(msg))}};b4w.module["shader_texts"]=function(exports,require){exports["anchors.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["void","main","(",")","{","gl_FragColor","=","vec4","(","1.0",")",";","}"]}]},exports["anchors.glslv"]={type:"group",parts:[{type:"var",name:"ANCHOR_NUM",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"textline",tokens:["attribute","float","a_index",";","uniform","vec3","u_position","[","ANCHOR_NUM","]",";","uniform",
"mat4","u_view_proj_matrix",";","void","main","(",")","{","gl_Position","=","u_view_proj_matrix","*","vec4","(","u_position","[","int","(","a_index",")","]",",","1.0",")",";","gl_PointSize","=","4.0",";","}"]}]},exports["color_id.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",
name:"MAPPING_TRS_MATRIX",tokens:["mat4","(","0.0",")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",name:"RGB_IND",tokens:["0"]},{type:"var",name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",tokens:["0"]},
{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"precision_statement.glslf"},{type:"include",
file:"std_enums.glsl"},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"pack.glslf"},{type:"include",file:"procedural.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]},{type:"include",file:"color_util.glslf"},{type:"include",file:"math.glslv"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",
{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_time",";","uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";",
"uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","mat3","u_view_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","mat3","u_model_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform",
"vec3","u_zenith_color",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_sampler",";","uniform","float","u_alpha_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_OUTLINE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"vec3","u_color_id",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_CURVE_VEC","USE_NODE_CURVE_RGB","USE_NODE_VALTORGB",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_nodes_texture",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",
expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_lamp_light_positions",
"[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors","[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_RGB"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_OUTLINE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_outline_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bC",";","varying","vec4","bD",";"]},{type:"condition",
parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec4","bI",";","varying","vec4","bJ",";","varying","vec4","bK",";","varying","vec4","bL",";","uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","sampler2D","u_shadow_map0",";","uniform","sampler2D","u_shadow_map1",";","uniform","sampler2D","u_shadow_map2",";","uniform","sampler2D","u_shadow_map3",";","uniform","sampler2D","u_shadow_mask",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"},{type:"include",file:"mirror.glslf"},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],
group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]}]}}]},{type:"include",file:"nodes.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{","mat4","qR",",","qS",",","qT",",","qU",",","qV",";","float","qW",",","qX",";","vec4","qY",";","vec3","qZ",",","q_",",","ra",",","rb",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"textline",tokens:["qZ",
"=","u_camera_eye_frag","-","bC",";","qZ","=","normalize","(","qZ",")",";","qR","=","mat4","(","0.0",")",";","qS","=","mat4","(","0.0",")",";","qT","=","mat4","(","0.0",")",";","qU","=","mat4","(","0.0",")",";","qV","=","mat4","(","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["qR","=","O","(","u_view_tsr_frag",
")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["qS","=","O","(","u_view_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["qT","=","O","(","u_view_zup_tsr_inverse",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["qU",
"=","O","(","u_model_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["qV","=","O","(","u_model_zup_tsr_inverse",")",";"]}]}}]},{type:"textline",tokens:["qQ","(","qZ",",","qR",",","qS",",","qT",",","qU",",","qV",",","q_",",","ra",",","rb",",","qY",",","qW",")",";","qW","=","qW",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",
parts:[{type:"textline",tokens:["qW","=","(","texture2D","(","u_sampler",",","bM",")",")",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["qX","=","u_alpha_factor","*","qW",";","qX","+=","(","1.0","-","step","(","0.0",",","qX",")",")",";","qW","=","mix","(","qX",",","1.0",",","u_diffuse_color",".","a",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["qW","=","u_diffuse_color",".","a",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","qW","<","0.5",")","discard",";","qW","=","1.0",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_OUTLINE"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","u_outline_intensity",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["gl_FragColor","=","vec4","(","u_color_id",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["color_id.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",
file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],
group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER",
"float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",
parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],
group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",",
"1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"textline",tokens:["uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",
{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bC",";","varying","vec4","bD",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",
"WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]}]}}]},
{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","tz",";","float","tA",",","tB",",","tC",";","vec3","tD",",","tE",",","tF",",","tG",",","tH",",","tI",";","mat4","tJ",",","tK",",","tL",";","tJ","=","O","(","u_view_tsr",")",";","tD","=","a_position",
";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA","CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5},{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["tE","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["tF","=","vec3",
"(","a_tangent",")",";","tG","=","a_tangent","[","3","]","*","cross","(","tE",",","tF",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["tF","=","vec3","(","0.0",")",";","tG","=","vec3","(","0.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["tE","=","vec3","(","0.0",")",";","tF","=","vec3","(","0.0",")",";","tG","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",
tokens:["tD","=","mix","(","tD",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["tE","=","mix","(","tE",",","a_normal_next",",","VERTEX_ANIM_MIX_NORMALS_FACTOR",
")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["tH","=","vec3","(","a_tangent",")",";","tI","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","tH",")",";","tF","=","mix","(","tF",",","tH",",","u_va_frame_factor",")",";","tG","=","mix","(","tG",",","tI",",","u_va_frame_factor",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",
tokens:["sF","(","tD",",","tF",",","tG",",","tE",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tG","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["tG","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["tK","=","O","(","u_model_tsr",")",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",
parts:[{type:"textline",tokens:["tF","=","(","tK","*","vec4","(","tG",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tL","=","ry","(","u_camera_eye",",","tF",",","tJ",",","tK",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["tL","=","rs","(","u_camera_eye",",",
"tF",",","tJ",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tL","=","tL","*","rk","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","tF",")",";"]}]}}]},{type:"textline",tokens:["c","tM","=","rF","(","tD","-","tG",",","tG",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","tL",")",";","tM",".","b","=","tF",";"]}]}},
{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["c","tM","=","rF","(","tD",",","tG",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","tK",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tt","(","tM",".","a",",","tM",".","b",",","tE",")",";"]}]}},
{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tE","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["tE","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["tt","(","tM",".","a",",","tM",".","b",",","tE",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",
places:2},{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["bM","=","rI","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bC","=","tM",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["bE","=","tM",".","e",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["tA","=","(","dot","(","cross","(","tM",".","e",",","tM",".","c",")",",","tM",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bF",
"=","vec4","(","tM",".","c",",","tA",")",";"]}]}}]},{type:"textline",tokens:["bD","=","tJ","*","vec4","(","tM",".","a",",","1.0",")",";","tz","=","u_proj_matrix","*","bD",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["tz",".","xy","+=","u_subpixel_jitter","*","tz",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tA","=","tz",".","x",";","tB","=","tz",".","y",";","tC","=","tz",".","w",";","bG",".","x","=","(","tA","+","tC",")","/","2.0",";","bG",".","y","=","(","tB","+","tC",")","/","2.0",";","bG",".","z","=","tC",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bH","=","-","bD",".","z","/","u_view_max_depth",
";"]}]}}]},{type:"textline",tokens:["ty","(",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","u_proj_matrix","*","tJ","*","vec4","(","tM",".","a",",","1.0",")",";","}"]}]},exports["debug_view.glslf"]={type:"group",parts:[{type:"define",name:"DV_NONE",tokens:["0"]},{type:"define",name:"DV_OPAQUE_WIREFRAME",tokens:["1"]},{type:"define",name:"DV_TRANSPARENT_WIREFRAME",tokens:["2"]},{type:"define",name:"DV_FRONT_BACK_VIEW",tokens:["3"]},{type:"define",name:"DV_DEBUG_SPHERES",tokens:["4"]},{type:"define",
name:"DV_CLUSTERS_VIEW",tokens:["5"]},{type:"define",name:"DV_BATCHES_VIEW",tokens:["6"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","int","u_debug_view_mode",";","uniform","float","u_cluster_id",";","uniform","float","u_batch_debug_id",";","uniform","float","u_debug_colors_seed",";","uniform",
"vec3","u_wireframe_edge_color",";"]}]}}]},{type:"textline",tokens:["varying","vec3","tz",";","const","float","tA","=","1.0",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE_DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","tB","=","vec3","(","1.0",",","0.05",",","0.05",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","vec3",
"tB","=","vec3","(","0.05",",","0.05",",","1.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","vec3","tC","=","vec3","(","0.4",",","0.4",",","1.0",")",";","const","vec3","tD","=","vec3","(","1.0",",","0.4",",","0.4",")",";","const","vec3","tE","=","vec3","(","1.0",",","1.0",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["float",
"tH","(",")","{","vec3","tF",";","float","tG",";","tG","=","1.0",";"]},{type:"condition",parts:[{type:"if",expression:["WIREFRAME_QUALITY",0,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["tF","=","sign","(","tz","-","vec3","(","0.02","*","tA",")",")",";","if","(","tF",".","x","<","0.0","||","tF",".","y","<","0.0","||","tF",".","z","<","0.0",")","tG","=","0.0",";"]}]}},{type:"elif",expression:["WIREFRAME_QUALITY",1,{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"extension",tokens:["GL_OES_standard_derivatives",":","enable"]},{type:"textline",tokens:["tF","=","fwidth","(","tz",")",";","tF","=","smoothstep","(","vec3","(","0.0",")",",","tF","*","tA",",","tz",")",";","tG","=","min","(","min","(","tF",".","x",",","tF",".","y",")",",","tF",".","z",")",";","tG","=","clamp","(","tG",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["return","tG",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","float","tI",",","tJ",";","vec3",
"tK",",","tL",";","tK","=","vec3","(","0.0",")",";","tI","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["tL","=","sign","(","tz","-","vec3","(","0.02","*","tA",")",")",";","if","(","tL",".","x","<","0.0","||","tL",".","y","<","0.0","||","tL",".","z","<","0.0",")","{","tK","=","tB",";","tI","=","1.0",";","}","else","discard",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_debug_view_mode",
"==","DV_OPAQUE_WIREFRAME",")","{","tJ","=","tH","(",")",";","tK","=","vec3","(","mix","(","u_wireframe_edge_color",",","tE",",","tJ",")",")",";","tI","=","1.0",";","}","else","if","(","u_debug_view_mode","==","DV_TRANSPARENT_WIREFRAME",")","{","tJ","=","tH","(",")",";","tK","=","u_wireframe_edge_color",";","tI","=","mix","(","1.0",",","0.0",",","tJ",")",";","}","else","if","(","u_debug_view_mode","==","DV_FRONT_BACK_VIEW",")","{","tJ","=","tH","(",")",";","if","(","gl_FrontFacing",")","tK","=","mix",
"(","u_wireframe_edge_color",",","tC",",","tJ",")",";","else","tK","=","mix","(","u_wireframe_edge_color",",","tD",",","tJ",")",";","tI","=","1.0",";","}","else","if","(","u_debug_view_mode","==","DV_CLUSTERS_VIEW",")","{","tJ","=","u_cluster_id","+","u_debug_colors_seed","+","2.0",";","tK","=","vec3","(","fract","(","tJ","*","19.73",")",",","fract","(","tJ","*","6.34",")",",","fract","(","tJ","*","1.56",")",")",";","tI","=","1.0",";","}","else","if","(","u_debug_view_mode","==","DV_BATCHES_VIEW",
")","{","tJ","=","u_batch_debug_id","+","u_debug_colors_seed",";","tK","=","vec3","(","fract","(","tJ","*","19.73",")",",","fract","(","tJ","*","6.34",")",",","fract","(","tJ","*","1.56",")",")",";","tI","=","1.0",";","}"]}]}}]},{type:"textline",tokens:["bu","(","tK",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["bx","(","tK",",","tI",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","tK",",","tI",")",";",
"}"]}]},exports["debug_view.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","float","a_polyindex",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER",
"float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",
places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",
parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"textline",tokens:["uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS",
"BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[",
"MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION",
"sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec3","tz",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},
{type:"include",file:"dynamic_grass.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec3","uf",",","ug",",","uh",",","ui",",","uj",";","mat4","uk",",","ul",",","um",";","uk","=","O","(","u_view_tsr",")",";","ul","=","O","(","u_model_tsr",")",";","if","(","a_polyindex","==","0.0",")","tz","=","vec3","(","1.0",",","0.0",",","0.0",")",";","else","if","(","a_polyindex","==","1.0",")","tz","=","vec3","(","0.0",",","1.0",",","0.0",")",";","else","if","(","a_polyindex","==","2.0",")","tz",
"=","vec3","(","0.0",",","0.0",",","1.0",")",";","uf","=","a_position",";","ug","=","a_normal",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_SPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["c","un","=","rF","(","uf",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","ul",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",
tokens:["uf","=","mix","(","uf",",","a_position_next",",","u_va_frame_factor",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uh","=","vec3","(","0.0",")",";","ui","=","vec3","(","0.0",")",";","sF","(","uf",",","uh",",","ui",",","ug",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["ui",
"=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["ui","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["c","un","=","ue","(","uf",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","ui",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","uk",")",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uh","=","(","ul","*","vec4","(","ui",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["um","=","ry","(","u_camera_eye",",","uh",",",
"uk",",","ul",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["um","=","rs","(","u_camera_eye",",","uh",",","uk",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uj","=","(","ul","*","vec4","(","ui",",","1.0",")",")",".","xyz",";","um","=","um","*","rk","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","uj",")",";"]}]}}]},
{type:"textline",tokens:["c","un","=","rF","(","uf","-","ui",",","ui",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","um",")",";","un",".","b","=","uh",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["c","un","=","rF","(","uf",",","ui",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","ul",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",
tokens:["tt","(","un",".","a",",","un",".","b",",","ug",")",";"]}]}}]}]}}]},{type:"textline",tokens:["gl_Position","=","u_proj_matrix","*","uk","*","vec4","(","un",".","a",",","1.0",")",";","}"]}]},exports["grass_map.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec4","uf",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","float","uf",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","uf",";"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","uf",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","uf",",","vec3","(","1.0",")",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",",","uf",")",";"]}]}},
{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["}"]}]},exports["grass_map.glslv"]={type:"group",parts:[{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_grass_size",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_grass_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"mat3","u_model_tsr",";"]}]}}]},{type:"textline",tokens:["uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float",
"u_time",";","uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","uf",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","float","uf",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","uf",";"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","ug",";","vec3","uh",";","mat4","ui",",","uj",",","uk",";","ui","=","O","(","u_view_tsr",")",";","uj","=","O","(","u_model_tsr",")",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",tokens:["uh","=","(","uj","*","vec4","(","vec3","(","0.0",
")",",","1.0",")",")",".","xyz",";","uk","=","rs","(","u_camera_eye",",","uh",",","ui",")",";"]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uk","=","uk","*","rk","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","vec3","(","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["c","ul","=","rF","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",
",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","uk",")",";","ul",".","b","=","uh",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["c","ul","=","rF","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","uj",")",";"]}]}}]},{type:"textline",tokens:["ug","=","u_proj_matrix","*","ui","*","vec4","(","ul",".","a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_SIZE"],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uf","=","vec4","(","a_grass_size",",","a_grass_color",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uf","=","a_grass_size",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uf","=","a_grass_color",";"]}]}}]}]}}]},
{type:"textline",tokens:["gl_Position","=","ug",";","}"]}]},exports["halo.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LINES",tokens:["0"]},{type:"var",name:"NUM_RINGS",tokens:["0"]},{type:"var",name:"NUM_STARS",tokens:["0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec3","u_halo_rings_color",";","uniform","vec3","u_halo_lines_color",";","uniform","float","u_halo_hardness",
";","uniform","float","u_halo_size",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_halo_stars_blend",";","uniform","float","u_halo_stars_height",";","uniform","float",
"u_cam_water_depth",";","varying","vec4","ug",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","bM",";","varying","float","uh",";"]},{type:"include",file:"color_util.glslf"},{type:"include",file:"halo_color.glslf"},{type:"textline",tokens:["void","main","(",")","{","float","uT",";","vec3","uU",";","vec4","uV",";","uV","=","uS","(",")",";","uU","=","uV",".","rgb",";","uT","=","uV",".","a",";","bu","(","uU",")",";","bx","(","uU",",","uT",")",";","gl_FragColor","=","vec4","(","uU",",","uT",
")",";","}"]}]},exports["halo.glslv"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec2","a_halo_bb_vertex",";","attribute","float","a_random_vals",";","uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";","uniform","PRECISION","float","u_halo_size",";","varying","vec2","bM",";","varying","float","uh",";"]},{type:"condition",
parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","ug",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","uT",",","uU",";","vec3","uV",";","mat4","uW",",","uX",",","uY",";","uW","=","O","(","u_view_tsr",")",";","uX","=","O","(","u_model_tsr",")",";","uV","=","(","uX","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","bM","=","a_halo_bb_vertex","*","2.0",";","uh","=","a_random_vals",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",
tokens:["uX","=","qX","(","uV",",","uW",")",";","uY","=","uW",";","uY","[","3","]","[","0","]","=","0.0",";","uY","[","3","]","[","1","]","=","0.0",";","uY","[","3","]","[","2","]","=","0.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uX","=","qX","(","uV",",","uW",")",";"]}]}}]},{type:"textline",tokens:["uT","=","vec4","(","a_halo_bb_vertex","*","2.0","*","u_halo_size",",","0.0",",","1.0",")",";","uT","=","uX","*","uT",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],
group:{type:"group",parts:[{type:"textline",tokens:["uU","=","u_proj_matrix","*","uY","*","uT",";","uU",".","z","=","0.99999","*","uU",".","w",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ug","=","uT",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uU","=","u_proj_matrix","*","uW","*","uT",";"]}]}}]},{type:"textline",
tokens:["gl_Position","=","uU",";","}"]}]},exports["line.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","void","main","(",")","{","float","uT",";","vec3","uU",";","uU","=","u_diffuse_color",".","xyz",";","uT","=","u_diffuse_color",".","a",";","bu","(","uU",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",
tokens:["bx","(","uU",",","uT",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","uU",",","uT",")",";","}"]}]},exports["line.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_direction",";","uniform","mat3",
"u_model_tsr",";","uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";","uniform","float","u_height",";","uniform","float","u_line_width",";"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["void","main","(",")","{","mat2","uT",";","float","uU",";","vec2","uV",",","uW",";","vec4","uX",";","mat4","uY",",","uZ",";","uY","=","O","(","u_view_tsr",")",";","uZ","=","O","(","u_model_tsr",")",";","c","u_","=","rF","(","a_position",",","vec3","(","0.0",")",
",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","normalize","(","a_direction",")",",","uZ",")",";","uX","=","u_proj_matrix","*","uY","*","vec4","(","u_",".","a",",","1.0",")",";","uX",".","xyz","/=","uX",".","w",";","uV","=","(","u_proj_matrix","*","uY","*","vec4","(","u_",".","e",",","0.0",")",")",".","xy",";","uU","=","M_PI","/","2.0",";","uT","=","mat2","(","cos","(","uU",")",",","sin","(","uU",")",",","-","sin","(","uU",")",",","cos","(","uU",")",")",";","uV","=","uT","*","normalize","(",
"uV",")",";","uW","=","(","u_line_width","/","u_height",")","*","vec2","(","u_proj_matrix","[","0","]","[","0","]","/","u_proj_matrix","[","1","]","[","1","]",",","1.0",")",";","gl_Position","=","vec4","(","uX",".","xy","+","uV",".","xy","*","uW","/","2.0",",","uX",".","z",",","1.0",")",";","gl_Position","*=","uX",".","w",";","}"]}]},exports["main.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",
tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"PARALLAX_STEPS",tokens:["0.0"]},{type:"var",name:"PARALLAX_LOD_DIST",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",
tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"},
{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]}]}}]},{type:"include",file:"color_util.glslf"},{type:"include",file:"math.glslv"},{type:"textline",tokens:["uniform","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",
expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_sun_quaternion",
";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",";"]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_VECTOR_VIEW",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"mat3","u_view_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","mat3","u_model_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3",
"u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_direction",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_shadow_mask",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","PRECISION","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","PRECISION","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","PRECISION","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION","REFRACTIVE","USE_REFRACTION_CORRECTION",{type:"logical_and_expr",places:4}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_lamp_light_positions","[","NUM_LAMP_LIGHTS","]",";",
"uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors","[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_RGB"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_CURVE_VEC","USE_NODE_CURVE_RGB","USE_NODE_VALTORGB",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_nodes_texture",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND",
"MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",
places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bI",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec4","bK",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bL",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",
places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]},{type:"include",file:"mirror.glslf"},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",
parts:[{type:"include",file:"shadow.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]},{type:"include",file:"nodes.glslf"},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{",
"vec2","vz",";","mat4","vA",",","vB",",","vC",",","vD",",","vE",";","vec4","vF",";","vec3","vG",",","vH",",","vI",",","vJ",",","vK",";","float","vL",",","vM",",","vN",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",
{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vL","=","length","(","bD",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["vM","=","bC",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"CAUSTICS","WATER_EFFECTS",{type:"logical_and_expr",places:2},
{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vG","=","u_sun_intensity",";"]}]}}]},{type:"textline",tokens:["vH","=","normalize","(","u_camera_eye_frag","-","bC",")",";","vA","=","mat4","(","0.0",")",";","vB","=","mat4","(","0.0",")",";","vC","=","mat4","(","0.0",")",";","vD","=","mat4","(","0.0",")",";","vE","=","mat4","(","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",
places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vA","=","O","(","u_view_tsr_frag",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["vB","=","O","(","u_view_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["vC","=","O","(","u_view_zup_tsr_inverse",")",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["vD","=","O","(","u_model_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["vE","=","O","(","u_model_zup_tsr_inverse",")",";"]}]}}]},{type:"textline",tokens:["qQ","(","vH",",","vA",",","vB",",","vC",",","vD",",","vE",",","vI",",","vJ",",","vK",",","vF",",","vN",")",";",
"vI","=","vI",";","vN","=","vN",";","vK","=","vK",";","vF","=","vF",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WETTABLE"],group:{type:"group",parts:[{type:"textline",tokens:["vI","=","max","(","vI","-","sqrt","(","0.01","*","-","min","(","vM",",","0.0",")",")",",","0.5",
"*","vI",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["bp","(","vI",",","vM",",","u_time",",","vF",",","vK",",","u_sun_direction",",","vG",",","u_sun_quaternion",",","bC",",","vL",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","vN","<",
"0.5",")","discard",";","vN","=","1.0",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vN","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["vy","(","vI",",","length","(","bD",")",",","vH",",","vM",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["vy","(","vI",",","length","(","bD",")",",","vH",",","1.0",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SSAO_ONLY","SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vz","=","texture2DProj","(","u_shadow_mask",",","bG",")",".","rg",";","vM","=","vz",".","g",";","vI","=","vec3","(","vM",")",";"]}]}}]},{type:"textline",tokens:["bu","(","vI",")",";"]},{type:"condition",
parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bx","(","vI",",","vN",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","vI",",","vN",")",";","}"]}]},exports["main.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"NUM_CAST_LAMPS",tokens:["0"]},{type:"var",name:"PRECISION",
tokens:["lowp"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND",
"MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:7}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",
parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute",
"float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",
parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","USE_NODE_TEX_COORD_NO",
{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_color",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",
",","1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_PASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix",";","uniform","mat3","u_view_tsr",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_proj_matrix",";"]},
{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"BILLBOARD","DYNAMIC_GRASS",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_subpixel_jitter",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","PRECISION","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4",
"u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","PRECISION","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_normal_offset",";"]},{type:"condition",parts:[{type:"if",expression:["MAC_OS_SHADOW_HACK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_v_light_tsr","[","NUM_CAST_LAMPS","]",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec4","u_v_light_ts","[","NUM_CAST_LAMPS","]",";","uniform","vec4","u_v_light_r","[","NUM_CAST_LAMPS","]",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2",
"NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_NODE_B4W_REFRACTION",
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:7}],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","vz",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","vA",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bI",";"]},{type:"condition",
parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bK",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",
3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bL",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["REFRACTIVE","NODES",{type:"logic_negative_expr",places:1},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]},{type:"include",file:"dynamic_grass.glslv"},{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",
parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","vN",",","vO",";","float","vP",";","vec3","vQ",",","vR",",","vS",",","vT",",","vU",",","vV",",","vW",";","mat4","vX",",","vY",",","vZ",",","v_",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_PASS"],group:{type:"group",parts:[{type:"textline",tokens:["vX","=","u_view_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",
places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vY","=","O","(","u_view_tsr",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vX","=","O","(","u_view_tsr",
")",";"]}]}}]},{type:"textline",tokens:["vZ","=","O","(","u_model_tsr",")",";","vQ","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"NODES",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vR","=","a_normal",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["vR","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","NODES",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_UV_ORCO",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vS","=","vec3","(","a_tangent",")",";","vT","=","a_tangent","[","3","]","*","cross","(","vR",",","vS",")",";"]}]}},{type:"elif",
expression:["NODES",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vU","=","(","vZ","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","vV","=","normalize","(","(","vZ","*","vec4","(","a_normal",",","0.0",")",")",".","xyz",")",";","vU","=","vU","-","u_camera_eye",";","vT","=","cross","(","vU",",","vV",")",";","vS","=","cross","(","vV",",",
"vT",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vS","=","vec3","(","0.0",")",";","vT","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["vQ","=","mix","(","vQ",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS",
"CALC_TBN_SPACE",{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["vR","=","mix","(","vR",",","a_normal_next",",","VERTEX_ANIM_MIX_NORMALS_FACTOR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["vV","=","vec3","(","a_tangent",")",";","vU","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","vV",")",";","vS","=","mix","(","vS",",","vV",",","u_va_frame_factor",
")",";","vT","=","mix","(","vT",",","vU",",","u_va_frame_factor",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["sF","(","vQ",",","vS",",","vT",",","vR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vU","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["vU","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["c","wa","=","ue","(","vQ",",","vS",",","vT",",","vR",",","vU",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","vX",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",
tokens:["vV","=","(","vZ","*","vec4","(","vU",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["v_","=","ry","(","u_camera_eye",",","vV",",","vX",",","vZ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["v_","=","rs","(","u_camera_eye",",","vV",",","vX",")",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vW","=","(","vZ","*","vec4","(","vU",",","1.0",")",")",".","xyz",";","v_","=","v_","*","rk","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","vW",")",";"]}]}}]},{type:"textline",tokens:["c","wa","=","rF","(","vQ","-","vU",",","vU",",","vS",",","vT",",","vR",",","v_",")",";","wa",".","b","=","vV",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["c","wa","=","rF","(","vQ",",","vU",",","vS",",","vT",",","vR",",","vZ",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vP","=","(","dot","(","cross","(","wa",".","e",",","wa",".","c",")",",","wa",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bF","=","vec4","(","wa",".","c",",","vP",")",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["tt","(","wa",".","a",",","wa",".","b",",","vR",")",";"]}]}}]},{type:"textline",tokens:["bC","=","wa",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",
places:6}],group:{type:"group",parts:[{type:"textline",tokens:["bE","=","wa",".","e",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vz","=","u_camera_eye","-","wa",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["bM","=","rI","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["vA","=","wa",".","f",";"]}]}},{type:"elif",expression:["VERTEX_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["vA","=","a_color",";"]}]}}]}]}}]},{type:"textline",tokens:["vN","=","vX","*","vec4","(","wa",".","a",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS",
"CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_PASS"],group:{type:"group",parts:[{type:"textline",tokens:["vO","=","vY","*","vec4","(","wa",".","a",",","1.0",")",";","bD","=","vO",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["bD","=","vN",";"]}]}}]}]}}]},{type:"textline",tokens:["vO","=","u_proj_matrix","*","vN",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["vO",".","xy","+=","u_subpixel_jitter","*","vO",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",
places:4}],group:{type:"group",parts:[{type:"textline",tokens:["bG","=","L","(","vO",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vM","(","wa",".","a",",","wa",".","e",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","NODES",{type:"logic_negative_expr",places:1},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2},{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bH","=","-","vN",".","z","/","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"textline",tokens:["ty","(",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","vO",";","}"]}]},exports["main_stack.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},
{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"PARALLAX_STEPS",tokens:["0.0"]},{type:"var",name:"PARALLAX_LOD_DIST",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",
tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"},
{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]}]}}]},{type:"include",file:"color_util.glslf"},{type:"include",file:"math.glslv"},{type:"textline",tokens:["uniform","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",
expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_sun_quaternion",
";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",
parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",
";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_direction",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["TEXTURE_COLOR0_CO"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC","ALPHA_AS_SPEC",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_specmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_normalmap0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap1",";","uniform","sampler2D","u_stencil0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE",
"REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"sampler2D","u_shadow_mask",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","PRECISION","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","PRECISION","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","PRECISION","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","USE_REFRACTION_CORRECTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]},{type:"textline",tokens:["uniform",
"float","u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";","uniform","float","u_specular_alpha",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_normal_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR0_CO"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_diffuse_color_factor",";","uniform","float","u_alpha_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_specular_color_factor",";"]}]}}]},{type:"textline",
tokens:["uniform","vec3","u_specular_color",";","uniform","vec3","u_specular_params",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_parallax_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_refr_bump",";"]}]}}]},{type:"textline",tokens:["varying","vec3",
"bC",";","varying","vec3","bE",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec4","bD",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"textline",tokens:["varying","vec3","vz",";"]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","vA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bI",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec4","bJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bK",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bL",";"]}]}}]}]}}]},{type:"condition",
parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"}]}}]},{type:"include",file:"mirror.glslf"},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"lighting_nodes.glslf"}]}}]},{type:"condition",parts:[{type:"if",
expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","xS",",","xT",",","xU",",","xV",";","mat4","xW",";","mat3","xX",";","vec2","xY",",","xZ",",","x_",",","ya",";","vec3","yb",",","yc",",","yd",",","ye",",","yf",",","yg",",","yh",",","yi",",","yj",";","float","yk",",","yl",",","ym",",","yn",",","yo",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","DISABLE_FOG",
{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2},"WATER_EFFECTS","CAUSTICS",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["yk","=","length","(","bD",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",
parts:[{type:"textline",tokens:["yl","=","bC",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"CAUSTICS","WATER_EFFECTS",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["yb","=","u_sun_intensity",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["xY",
"=","bM",";"]}]}}]},{type:"textline",tokens:["yc","=","normalize","(","bE",")",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["INVERT_FRONTFACING"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","!","gl_FrontFacing",")"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")"]}]}}]},{type:"textline",tokens:["yc","=","yc",";","else","yc",
"=","-","yc",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:["yd","=","cross","(","yc",",","bF",".","xyz",")","*","bF",".","w",";","xX","=","mat3","(","bF",".","xyz",",","yd",",","yc",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD","REFRACTIVE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xW","=","O","(","u_view_tsr_frag",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["xZ","=","normalize","(","xW","*","vec4","(","bE",",","0.0",")",")",".","st",";","xZ","=","xZ","*","vec2","(","0.495",")","+","vec2","(","0.5",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","PARALLAX",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","yk","<","PARALLAX_LOD_DIST",")","{","ym","=","clamp","(","0.5","*",
"(","PARALLAX_LOD_DIST","-","yk",")",",","0.0",",","1.0",")",";","ym","=","u_parallax_scale","*","ym",";","yd","=","normalize","(","vz","*","xX",")",";","yn","=","1.0","/","PARALLAX_STEPS",";","x_","=","yd",".","xy","*","ym","/","(","PARALLAX_STEPS","*","yd",".","z",")",";","ym","=","1.0",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ya","=","xZ",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["ya","=","xY",";"]}]}}]},{type:"textline",tokens:["yo","=","texture2D","(","u_normalmap0",",","ya",")",".","a",";","for","(","float","yp","=","1.0",";","yp","<=","PARALLAX_STEPS",";","yp","++",")","{","if","(","yo","<","ym",")","{","ym","-=","yn",";","ya","-=","x_",";","yo","=","texture2D","(","u_normalmap0",",","ya",")",".","a",";","}","}","x_","=","ya","+","x_",";","yn","=","texture2D","(","u_normalmap0",",","x_",")",".","a","-","(","ym","+","yn",
")",";","ym","=","yo","-","ym",";","yn","=","ym","/","(","ym","-","yn",")",";","ya","=","yn","*","x_","+","(","1.0","-","yn",")","*","ya",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["xY","+=","ya","-","xZ",";"]}]}}]},{type:"textline",tokens:["xZ","=","ya",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["xZ","+=","ya","-","xY",";"]}]}}]},{type:"textline",tokens:["xY","=","ya",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO"],group:{type:"group",parts:[{type:"textline",tokens:[";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["xS","=","texture2D","(","u_normalmap0",",","xZ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["xS","=","texture2D","(","u_normalmap0",",","xY",")",";"]}]}}]},{type:"textline",tokens:["yd","=","xS",".","rgb","-","0.5",";","yd","=","mix","(","vec3","(","0.0",",","0.0",",","1.0",")",",","yd",",","u_normal_factor",")",";","yd","=","xX","*","yd",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yd","=","yc",";"]}]}}]},
{type:"textline",tokens:["yd","=","normalize","(","yd",")",";"]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["xZ","=","normalize","(","xW","*","vec4","(","yd",",","0.0",")",")",".","st",";","xZ","=","xZ","*","vec2","(","0.495",")","+","vec2","(","0.5",")",";"]}]}}]},{type:"textline",tokens:["yc","=","normalize","(","vz",")",";"]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ye","=","vA",";","br","(","ye",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_COLOR","DYNAMIC_GRASS",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xS","=","vec4","(","ye",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["xS","=","u_diffuse_color",";"]}]}}]},{type:"textline",tokens:["yn","=","1.0",";"]},{type:"condition",parts:[{type:"if",
expression:["TEXTURE_COLOR0_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xT","=","texture2D","(","u_colormap0",",","xZ",")",";"]}]}},{type:"elif",expression:["TEXTURE_COLOR0_CO","TEXTURE_COORDS_UV_ORCO",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xT","=","texture2D","(","u_colormap0",",","xY",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR0_CO"],group:{type:"group",
parts:[{type:"textline",tokens:["br","(","xT",".","rgb",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK"],group:{type:"group",parts:[{type:"textline",tokens:[";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR1_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xU","=","texture2D","(","u_colormap1",",","xZ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["xU",
"=","texture2D","(","u_colormap1",",","xY",")",";"]}]}}]},{type:"textline",tokens:["br","(","xU",".","rgb",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_STENCIL_ALPHA_MASK_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xV","=","texture2D","(","u_stencil0",",","xZ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["xV","=","texture2D","(","u_stencil0",",","xY",")",";"]}]}}]},{type:"textline",
tokens:["xT","=","mix","(","xT",",","xU",",","xV",".","r",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xS",".","rgb","=","mix","(","xS",".","rgb",",","xT",".","rgb",",","u_diffuse_color_factor",")",";","ym","=","u_alpha_factor","*","xT",".","a",";","ym","+=","(","1.0","-","step","(","0.0",",","ym",")",")",";","xS",".","a","=","mix","(","ym",",","1.0",",",
"u_diffuse_color",".","a",")",";","yn","=","xT",".","a",";"]}]}},{type:"elif",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["xS",".","rgb","*=","mix","(","vec3","(","1.0",")",",","xT",".","rgb",",","u_diffuse_color_factor",")",";","xS",".","a","=","xT",".","a",";","yn","=","xT",".","a",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADELESS"],group:{type:"group",parts:[{type:"textline",
tokens:["ye","=","xS",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yf","=","u_diffuse_intensity","*","xS",".","rgb",";","yg","=","u_environment_energy","*","dS","(","yd",")",";","yg","=","u_ambient","*","yg",";","xT","=","du","(","yf",")",";","yh","=","u_emit","*","xS",".","rgb",";","yi","=","u_specular_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_SPEC"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_AS_SPEC"],
group:{type:"group",parts:[{type:"textline",tokens:["yj","=","vec3","(","yn",")",";"]}]}},{type:"elif",expression:["TEXTURE_SPEC_CO","TEXTURE_COORDS_NORMAL",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["yj","=","texture2D","(","u_specmap0",",","xZ",")",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yj","=","texture2D","(","u_specmap0",",","xY",")",".","rgb",";"]}]}}]},{type:"textline",tokens:["br","(","yj",".","rgb",")",";",
"yi","=","mix","(","yi",",","yj",",","u_specular_color_factor",")",";"]}]}}]},{type:"textline",tokens:["yn","=","u_specular_params","[","0","]",";","xY","=","vec2","(","u_specular_params","[","1","]",",","u_specular_params","[","2","]",")",";","yi","=","yn","*","yi",";","xR","(","yh",",","yg",",","yf",",","yi",",","bC",",","yd",",","yc",",","xY",",","u_diffuse_params",",","xT",",","0.0",",","vec4","(","0.0",")",",","ye",",","yj",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE",
"REFL_PLANE",{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["dP","(","ye",",","yc",",","yd",",","u_reflect_factor",",","xW",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dP","(","ye",",","yc",",","yd",",","u_reflect_factor",",","mat4","(","0.0",")",
")",";"]}]}}]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD"],group:{type:"group",parts:[{type:"textline",tokens:["dP","(","ye",",","yc",",","yd",",","0.0",",","xW",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dP","(","ye",",","yc",",","yd",",","0.0",",","mat4","(","0.0",")",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["ye","+=","yj",";"]}]}}]},{type:"textline",tokens:["yn","=","xS",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WETTABLE"],group:{type:"group",parts:[{type:"textline",
tokens:["ye","=","max","(","ye","-","sqrt","(","0.01","*","-","min","(","yl",",","0.0",")",")",",","0.5","*","ye",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"textline",tokens:["bp","(","ye",",","yl",",","u_time",",","xT",",","yd",",","u_sun_direction",",","yb",",","u_sun_quaternion",",","bC",",","yk",")",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","yn","<","0.5",")","discard",";","yn","=","1.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["ym","=","max","(","max","(","yj",".","r",",","yj",".","g",")",",","yj",".","b",")","*","u_specular_alpha",";","yn","=","xS",".","a","*","(","1.0","-","ym",")","+","ym",
";"]}]}}]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yn","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["xY","=","-","(","xW","*","vec4","(","yd",",","0.0",")",")",".","xy",";","ye","=","mix","(","ef","(","bG",",","xY","*","u_refr_bump",")",",","ye",",","yn",")",";","yn","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["vy","(","ye",",","yk",",","yc",",","yl",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vy","(","ye",",","yk",",","yc",",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["bu","(","ye",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bx","(","ye",",","yn",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","ye",",","yn",")",";","}"]}]},exports["particle_system.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",
tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES","NODES",
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"pack.glslf"}]}}]},{type:"var",name:"PARTICLES_SHADELESS",tokens:["0"]},{type:"var",name:"SOFT_STRENGTH",tokens:["1.0"]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions",
"[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",
";","uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","float","u_time",";","uniform","vec3","u_camera_eye_frag",";"]},{type:"condition",parts:[{type:"if",
expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_lamp_light_positions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors","[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_RGB"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NORMAL_TEXCOORD","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_VECTOR_VIEW",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr_frag",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3",
"u_model_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";","uniform","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_CURVE_VEC","USE_NODE_CURVE_RGB","USE_NODE_VALTORGB",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_nodes_texture",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR","USE_NODE_TEX_COORD_UV","USE_NODE_UV_MERGED","USE_NODE_UVMAP","USE_NODE_GEOMETRY_UV","USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:7}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES","DISABLE_FOG",{type:"logic_negative_expr",places:1},
"NODES",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bE",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"include",file:"environment.glslf"},{type:"include",file:"math.glslv"},{type:"include",file:"particles_nodes.glslf"},{type:"textline",tokens:["void",
"main","(",")","{","mat4","Kr",",","Ks",",","Kt",",","Ku",",","Kv",";","float","Kw",",","Kx",",","Ky",";","vec4","Kz",";","vec3","KA",",","KB",",","KC",",","KD",";","KA","=","normalize","(","u_camera_eye_frag","-","bC",")",";","Kr","=","mat4","(","0.0",")",";","Ks","=","mat4","(","0.0",")",";","Kt","=","mat4","(","0.0",")",";","Ku","=","mat4","(","0.0",")",";","Kv","=","mat4","(","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",
{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Kr","=","O","(","u_view_tsr_frag",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["Ks","=","O","(","u_view_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["Kt","=","O","(","u_view_zup_tsr_inverse",
")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["Ku","=","O","(","u_model_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["Kv","=","O","(","u_model_zup_tsr_inverse",")",";"]}]}}]},{type:"textline",tokens:["Kq","(","KA",",","Kr",",","Ks",",","Kt",",","Ku",",","Kv",",","KB",",","KC",",","KD",",","Kz",",",
"Kw",")",";","KB","=","KB",";","Kw","=","Kw",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["ALPHA_CLIP"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","Kw","<","0.5",")","discard",";","Kw","=","1.0",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Kw","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vy","(","KB",",","length","(","bD",")",",","KA",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["Kx","=","-","bD",".","z","/","u_view_max_depth",";","Kz","=","texture2DProj","(","u_scene_depth",",","bG",")",";","Ky","=","Z","(","Kz",")",";","Kx","=","Ky","-","Kx",";","Kx","=","u_view_max_depth","/","SOFT_STRENGTH","*","Kx",";","Kw","=","Kw",
"*","min","(","Kx",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["bu","(","KB",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bx","(","KB",",","Kw",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","KB",",","Kw",")",";","}"]}]},exports["particle_system.glslv"]={type:"group",parts:[{type:"var",name:"BILLBOARD_ALIGN",tokens:["0"]},
{type:"var",name:"COLOR_RAMP_LENGTH",tokens:["0"]},{type:"var",name:"SIZE_RAMP_LENGTH",tokens:["0"]},{type:"define",name:"BILLBOARD_ALIGN_VIEW",tokens:["1"]},{type:"define",name:"BILLBOARD_ALIGN_XY",tokens:["2"]},{type:"define",name:"BILLBOARD_ALIGN_YZ",tokens:["3"]},{type:"define",name:"BILLBOARD_ALIGN_ZX",tokens:["4"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["attribute","vec3","a_position",";","attribute","vec3","a_normal",";","attribute","vec3","a_p_data",
";","attribute","vec4","a_p_vels",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"textline",tokens:["attribute","vec2","a_p_bb_vertex",";"]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_p_color_ramp","[",
"COLOR_RAMP_LENGTH","]",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_p_time",";","uniform","float","u_p_length",";","uniform","int","u_p_cyclic",";","uniform","float","u_p_fade_in",";","uniform","float","u_p_fade_out",";","uniform","float","u_p_nfactor",";","uniform","float","u_p_gravity",";","uniform","float","u_p_mass",";","uniform","float","u_p_wind_fac",";","uniform","float","u_p_max_lifetime",";","uniform","float","u_p_tilt",";","uniform","float","u_p_tilt_rand",";"]},{type:"condition",
parts:[{type:"if",expression:["REFLECTION_PASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_view_matrix",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_proj_matrix",";","uniform","vec3","u_wind",";","uniform","float","u_p_size",";","uniform","vec3","u_camera_eye",";"]},{type:"condition",parts:[{type:"if",expression:["WORLD_SPACE",{type:"logic_negative_expr",
places:1},"NODES","HALO_PARTICLES",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_COLOR_RAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_color_ramp_tex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES",
{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","Kr",";"]}]}}]},{type:"textline",tokens:["varying","vec3","vA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR","HALO_PARTICLES","USE_NODE_TEX_COORD_UV","USE_NODE_UV_MERGED",
"USE_NODE_UVMAP","USE_NODE_GEOMETRY_UV","USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:8}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1},"DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec3","vz",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"NODES",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","uh",";"]}]}}]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"particles.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"include",file:"std_enums.glsl"},{type:"include",file:"particles_nodes.glslv"}]}}]},{type:"textline",tokens:["float",
"Le","(","vec2","Lc",",","vec2","Ld",")","{","return","(","atan","(","Ld",".","y",",","Ld",".","x",")","-","atan","(","Lc",".","y",",","Lc",".","x",")",")",";","}","void","main","(",")","{","vec3","Lf",",","Lg",";","vec4","Lh",",","Li",",","Lj",";","float","Lk",",","Ll",",","Lm",";","mat4","Ln",",","Lo",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_PASS"],group:{type:"group",parts:[{type:"textline",tokens:["Ln","=","u_view_matrix",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["Ln","=","O","(","u_view_tsr",")",";"]}]}}]},{type:"textline",tokens:["Ks","Lp",";","Lp","=","KU","(",")",";","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_VIEW",")","{","Lk","=","Lp",".","e",";","Lo","=","qX","(","Lp",".","b",",","Ln",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_XY",")","{","Lk","=","Lp",".","e",";","Lo","=","w","(",")",";","Lo","[","3","]","=","vec4","(","Lp",".","b",",","1.0",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_YZ",
")","{","Lk","=","Lp",".","e",";","Lo","=","A","(","radians","(","90.0",")",")",";","Lo","[","3","]","=","vec4","(","Lp",".","b",",","1.0",")",";","}","else","if","(","BILLBOARD_ALIGN","==","BILLBOARD_ALIGN_ZX",")","{","Lk","=","Le","(","vec2","(","EPSILON",",","1.0",")",",","vec2","(","a_normal",".","x",",","a_normal",".","z",")",")","+","Lp",".","e",";","Lo","=","y","(","radians","(","-","90.0",")",")",";","Lo","[","3","]","=","vec4","(","Lp",".","b",",","1.0",")",";","}","Lh","=","vec4","(","a_p_bb_vertex",
"*","2.0","*","Lp",".","a","*","u_p_size",",","0.0",",","1.0",")",";","Ll","=","a_p_data","[","2","]",";","Lm","=","u_p_tilt","*","u_p_tilt_rand","*","(","2.0","*","Ll","-","1.0",")",";","Lm","=","(","Lm","+","u_p_tilt",")","*","M_PI",";","Lh","=","Lo","*","C","(","Lm","+","Lk",")","*","Lh",";","Li","=","Ln","*","Lh",";","Lj","=","u_proj_matrix","*","Li",";"]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["uh","=","Ll",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE","NODES",{type:"logic_negative_expr",places:1},"TEXTURE_NORM_CO","TEXTURE_COORDS_UV_ORCO",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lf","=","vec3","(","a_tangent",")",";","Lg","=","a_tangent","[","3","]","*","cross","(","a_normal",",","Lf",")",
";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lf","=","vec3","(","0.0",")",";","Lg","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["c","Lq","=","rF","(","vec3","(","0.0",")",",","vec3","(","0.0",")",",","Lf",",","Lg",",","vec3","(","0.0",")",",","Lo","*","C","(","Lk",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_NORM_CO","CALC_TBN_SPACE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lk","=",
"(","dot","(","cross","(","a_normal",",","Lq",".","c",")",",","Lq",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bF","=","vec4","(","Lq",".","c",",","Lk",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",{type:"logic_negative_expr",places:1},"USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",
tokens:["bE","=","a_normal",";"]}]}}]},{type:"textline",tokens:["Lb","(","Lp",".","b",",","Lp",".","f",",","Lp",".","g",",","Lp",".","h",",","Lp",".","a",",","a_p_bb_vertex",",","a_p_data","[","0","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["bM","=","a_p_bb_vertex","+","0.5",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES"],group:{type:"group",
parts:[{type:"textline",tokens:["bM","=","a_p_bb_vertex","*","2.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Kr","=","Lp",".","c",";"]}]}}]},{type:"textline",tokens:["vA","=","Lp",".","d",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["Lk","=","Lj",".","x",";","Ll","=","Lj",".","y",";","Lm","=","Lj",".","w",";","bG",".","x","=","(","Lk","+","Lm",")","/","2.0",";","bG",".","y","=","(",
"Ll","+","Lm",")","/","2.0",";","bG",".","z","=","Lm",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"NODES",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["bD","=","Li",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Lj",";","bC","=","Lh",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1},"DISABLE_FOG",
{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vz","=","u_camera_eye","-","Lh",".","xyz",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["particle_system_stack.glslf"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},
{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"NUM_LAMP_LIGHTS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"condition",parts:[{type:"if",
expression:["SOFT_PARTICLES","NODES",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"pack.glslf"}]}}]},{type:"var",name:"PARTICLES_SHADELESS",tokens:["0"]},{type:"var",name:"SOFT_STRENGTH",tokens:["1.0"]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D",
"u_sampler",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_diffuse_color_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",";","uniform","float","u_emit",";","uniform","float","u_ambient",";","uniform","vec3","u_specular_color",";","uniform","vec3","u_specular_params",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_halo_size",";","uniform","vec3","u_halo_rings_color",";","uniform",
"float","u_halo_hardness",";","uniform","vec3","u_halo_lines_color",";"]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";","uniform","float","u_halo_stars_blend",";","uniform","float","u_halo_stars_height",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_p_alpha_start",";","uniform","float","u_p_alpha_end",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";","uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";","uniform","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR","HALO_PARTICLES","USE_NODE_TEX_COORD_UV","USE_NODE_UV_MERGED","USE_NODE_UVMAP","USE_NODE_GEOMETRY_UV","USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:8}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["NODES",
{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","Kr",";"]}]}}]},{type:"textline",tokens:["varying","vec3","vA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1},"DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","vz",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SOFT_PARTICLES","DISABLE_FOG",{type:"logic_negative_expr",places:1},"NODES",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","uh",";"]},{type:"condition",parts:[{type:"if",
expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","ug",";"]}]}}]}]}}]},{type:"include",file:"lighting_nodes.glslf"},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"environment.glslf"}]}}]},
{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES"],group:{type:"group",parts:[{type:"include",file:"halo_color.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec2","Lc",";","float","Ld",",","Le",",","Lf",";","vec4","Lg",",","Lh",";","vec3","Li",",","Lj",",","Lk",",","Ll",",","Lm",",","Ln",",","Lo",",","Lp",";"]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",{type:"logic_negative_expr",places:1},"DISABLE_FOG",{type:"logic_negative_expr",places:1},
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Li","=","normalize","(","vz",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["HALO_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["Lg","=","uS","(",")",";","Lj","=","Lg",".","rgb","*","vA",";","Ld","=","0.9","*","length","(","bM",")",";","Ld","=","smoothstep","(","u_p_alpha_start",",","u_p_alpha_end",",","Ld",")",";","Ld","=","Lg",".","a","*","(","1.0","-","Ld",")",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["Lg","=","u_diffuse_color",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["Lh","=","texture2D","(","u_sampler",",","bM",")",";","br","(","Lh",".","rgb",")",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lg",".","rgb","=","mix","(","Lg",".",
"rgb",",","Lh",".","rgb",",","u_diffuse_color_factor",")",";"]}]}},{type:"elif",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lg",".","rgb","*=","mix","(","vec3","(","1.0",")",",","Lh",".","rgb",",","u_diffuse_color_factor",")",";"]}]}}]},{type:"textline",tokens:["Lg",".","a","=","Lh",".","a",";"]}]}}]},{type:"textline",tokens:["Lg",".","rgb","*=","vA",";"]},{type:"condition",parts:[{type:"if",expression:["PARTICLES_SHADELESS",
{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Lk","=","u_diffuse_intensity","*","Lg",".","rgb",";","Ll","=","u_emit","*","Lg",".","rgb",";","Lm","=","vec3","(","0.0",",","1.0",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logic_negative_expr",places:1},"SKY_COLOR",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["Ln","=","u_environment_energy","*",
"dS","(","vec3","(","0.0",")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Ln","=","u_environment_energy","*","dS","(","Lm",")",";"]}]}}]},{type:"textline",tokens:["Ln","=","u_ambient","*","Ln",";","Le","=","u_specular_params","[","0","]",";","Lc","=","vec2","(","u_specular_params","[","1","]",",","u_specular_params","[","2","]",")",";","Lo","=","Le","*","u_specular_color",";","xR","(","Ll",",","Ln",",","Lk",",","Lo",",","bC",",","Lm",",","Li",",","Lc",",","u_diffuse_params",
",","vec4","(","1.0",")",",","0.0",",","vec4","(","0.0",")",",","Lj",",","Lp",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lj","=","Lg",".","rgb",";"]}]}}]},{type:"textline",tokens:["Ld","=","Lg",".","a","*","Kr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vy","(","Lj",",","length","(","bD",")",",","Li",",","1.0",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SOFT_PARTICLES"],group:{type:"group",parts:[{type:"textline",tokens:["Le","=","-","bD",".","z","/","u_view_max_depth",";","Lg","=","texture2DProj","(","u_scene_depth",",","bG",")",";","Lf","=","Z","(","Lg",")",";","Le","=","Lf","-","Le",";","Le","=","u_view_max_depth","/","SOFT_STRENGTH","*","Le",";","Ld","=","Ld","*","min","(","Le",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["bu","(","Lj",")",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA","ALPHA_CLIP",
{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bx","(","Lj",",","Ld",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","Lj",",","Ld",")",";","}"]}]},exports["procedural_skydome.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"textline",tokens:["uniform","vec3","u_sky_color",";","uniform","vec3","u_sun_direction",";","uniform",
"float","u_rayleigh_brightness",";","uniform","float","u_mie_brightness",";","uniform","float","u_spot_brightness",";","uniform","float","u_scatter_strength",";","uniform","float","u_rayleigh_strength",";","uniform","float","u_mie_strength",";","uniform","float","u_rayleigh_collection_power",";","uniform","float","u_mie_collection_power",";","uniform","float","u_mie_distribution",";","varying","vec3","Lc",";","const","float","Ld","=","0.99",";","const","float","Le","=","1.8",";","const","int","Lf",
"=","8",";","float","Ll","(","vec3","Lg",",","vec3","Lh",")","{","float","Li",",","Lj",",","Lk",";","Li","=","dot","(","Lh",",","Lh",")",";","Lj","=","2.0","*","dot","(","Lh",",","Lg",")",";","Lk","=","dot","(","Lg",",","Lg",")","-","1.0",";","Li","=","Lj","*","Lj","-","4.0","*","Li","*","Lk",";","Li","=","sqrt","(","Li",")",";","Li","=","(","-","Lj","-","Li",")","/","2.0",";","Li","=","Lk","/","Li",";","return","Li",";","}","float","Ls","(","float","Lm",",","float","Ln",")","{","float","Lo",",",
"Lp",",","Lq",",","Lr",";","Lo","=","3.0","*","(","1.0","-","Ln","*","Ln",")",";","Lp","=","2.0","*","(","2.0","+","Ln","*","Ln",")",";","Lq","=","1.0","+","Lm","*","Lm",";","Lr","=","pow","(","1.0","+","Ln","*","Ln","-","2.0","*","Ln","*","Lm",",","1.5",")",";","Lr","=","max","(","Lr",",","0.00001",")",";","return","(","Lo","/","Lp",")","*","(","Lq","/","Lr",")",";","}","float","Ly","(","vec3","Lt",",","vec3","Lu",",","float","Lv",")","{","vec3","Lw",";","float","Lx",";","Lx","=","dot","(","Lu",
",","-","Lt",")",";","if","(","Lx","<","0.0",")","{","return","1.0",";","}","Lw","=","Lt","+","Lx","*","Lu",";","if","(","length","(","Lw",")","<","Lv",")","{","return","0.0",";","}","else","if","(","length","(","Lw",")",">=","Lv",")","{","Lw","=","normalize","(","Lw",")","*","Lv","-","Lt",";","Lx","=","acos","(","dot","(","normalize","(","Lw",")",",","Lu",")",")",";","return","smoothstep","(","0.0",",","1.0",",","pow","(","Lx","*","2.0",",","3.0",")",")",";","}","else","return","1.0",";","}","vec3",
"LC","(","float","Lz",",","vec3","LA",",","float","LB",")","{","return","LA","-","LA","*","pow","(","u_sky_color",",","vec3","(","LB","/","Lz",")",")",";","}","void","main","(",")","{","float","LD",",","LE",",","LF",",","LG",",","LH",",","LI",",","LJ",",","LK",",","LL",";","vec3","LM",",","LN",",","LO",",","LP",",","LQ",",","LR",",","LS",";","LM","=","normalize","(","Lc",")",";","LN","=","u_sun_direction",";","LD","=","dot","(","LM",",","LN",")",";","LE","=","Ls","(","LD",",","-","0.01",")","*","u_rayleigh_brightness",
"*","LN",".","y",";","LF","=","Ls","(","LD","-","0.5",",","u_mie_distribution",")","*","u_mie_brightness","*","(","1.0","-","LN",".","y",")",";","LD","=","smoothstep","(","0.0",",","100.0",",","Ls","(","LD",",","0.9995",")",")","*","u_spot_brightness",";","LO","=","vec3","(","0.0",",","Ld",",","0.0",")",";","LG","=","Ll","(","LO",",","LM",")",";","LH","=","LG","/","float","(","Lf",")",";","LI","=","Ly","(","LO",",","LM",",","Ld","-","0.3",")",";","LP","=","vec3","(","0.0",",","0.0",",","0.0",")",
";","LQ","=","vec3","(","0.0",",","0.0",",","0.0",")",";","for","(","int","LT","=","0",";","LT","<","Lf",";","LT","++",")","{","LJ","=","LH","*","float","(","LT",")",";","LR","=","LO","+","LM","*","LJ",";","LK","=","Ly","(","LR",",","LN",",","Ld","-","0.2",")",";","LL","=","Ll","(","LR",",","LN",")",";","LS","=","LC","(","LL",",","vec3","(","Le",")",",","u_scatter_strength",")","*","LK",";","LP","+=","LC","(","sqrt","(","LJ",")",",","u_sky_color","*","LS",",","u_rayleigh_strength",")",";","LQ","+=",
"LC","(","LJ",",","LS",",","u_mie_strength",")",";","}","LP","=","LP","*","LI","*","pow","(","LG",",","u_rayleigh_collection_power",")","/","float","(","Lf",")",";","LQ","=","(","LQ","*","LI","*","pow","(","LG",",","u_mie_collection_power",")",")","/","float","(","Lf",")",";","LP","=","vec3","(","LD","*","LQ","+","LF","*","LQ","+","LE","*","LP",")",";","bu","(","LP",")",";","gl_FragColor","=","vec4","(","LP",",","1.0",")",";","}"]}]},exports["procedural_skydome.glslv"]={type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_position",";","uniform","mat4","u_cube_view_matrix",";","varying","vec3","Lc",";","void","main","(",")","{","vec4","Ld",",","Le",";","Ld","=","vec4","(","a_position",".","xy",",","0.999999",",","1.0",")",";","Le","=","u_cube_view_matrix","*","Ld",";","Lc","=","Le",".","xyz",";","gl_Position","=","Ld",";","}"]}]},exports["shadow.glslf"]={type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"NUM_LAMP_LIGHTS",
tokens:["0"]},{type:"var",name:"NUM_VALUES",tokens:["0"]},{type:"var",name:"NUM_RGBS",tokens:["0"]},{type:"var",name:"MAPPING_TRS_MATRIX",tokens:["mat4","(","0.0",")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",
name:"RGB_IND",tokens:["0"]},{type:"var",name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",tokens:["0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},
{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1},"NODES","ALPHA",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"include",file:"procedural.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES",
"ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"pack.glslf"},{type:"condition",parts:[{type:"if",expression:["CAUSTICS"],group:{type:"group",parts:[{type:"include",file:"caustics.glslf"}]}}]},{type:"include",file:"color_util.glslf"},{type:"include",file:"math.glslv"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_time",";",
"uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",
";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_tsr_frag",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_view_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_zup_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_zup_tsr_inverse",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT",
"SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT","SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_cube_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_mirrormap",";"]}]}}]},{type:"textline",tokens:["uniform","float",
"u_emit",";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_refl_plane",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["USE_NODE_LAMP"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_lamp_light_positions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_directions","[","NUM_LAMP_LIGHTS","]",";","uniform","vec3","u_lamp_light_color_intensities","[","NUM_LAMP_LIGHTS","]",";","uniform","vec4","u_lamp_light_factors","[","NUM_LAMP_LIGHTS","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_VALUE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"float","u_node_values","[","NUM_VALUES","]",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_RGB"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_node_rgbs","[","NUM_RGBS","]",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_colormap0",";","uniform","float","u_alpha_factor",";"]}]}}]},{type:"textline",tokens:["uniform",
"vec4","u_diffuse_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_pcf_blur_radii",";","uniform","vec4","u_csm_center_dists",";","uniform","PRECISION","sampler2D","u_shadow_map0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map2",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_shadow_map3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shadow_mask",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]},{type:"condition",
parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_CURVE_VEC","USE_NODE_CURVE_RGB","USE_NODE_VALTORGB",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_nodes_texture",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bF",";"]}]}}]}]}},{type:"else",
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bI",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bK",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bL",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","USE_REFRACTION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADELESS",{type:"logic_negative_expr",places:1},
"NODES","ALPHA",{type:"logical_and_expr",places:2},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"include",file:"shadow.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"mirror.glslf"},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]}]}}]},{type:"include",file:"nodes.glslf"}]}}]},{type:"textline",tokens:["void","main","(",")","{","mat4","Ld",",","Le",",","Lf",",","Lg",",","Lh",";","float","Li",",","Lj",";","vec4","Lk",";","vec3","Ll",",","Lm",",","Ln",",","Lo",";"]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["NODES"],group:{type:"group",parts:[{type:"textline",tokens:["Ll","=","u_camera_eye_frag","-","bC",";","Ll","=","normalize","(","Ll",")",";","Ld","=","mat4","(","0.0",")",";","Le","=","mat4","(","0.0",")",";","Lf","=","mat4","(","0.0",")",";","Lg","=","mat4","(","0.0",")",";","Lh","=","mat4","(","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_VECTOR_VIEW","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ld","=","O","(","u_view_tsr_frag",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["Le","=","O","(","u_view_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_VIEW_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["Lf","=","O","(","u_view_zup_tsr_inverse",")",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["USE_ZUP_MODEL_MATRIX"],group:{type:"group",parts:[{type:"textline",tokens:["Lg","=","O","(","u_model_zup_tsr",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_ZUP_MODEL_MATRIX_INVERSE"],group:{type:"group",parts:[{type:"textline",tokens:["Lh","=","O","(","u_model_zup_tsr_inverse",")",";"]}]}}]},{type:"textline",tokens:["qQ","(","Ll",",","Ld",",","Le",",","Lf",",","Lg",",","Lh",",","Lm",",","Ln",",","Lo",",","Lk",",","Li",")",";","Li","=","Li",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["Li","=","(","texture2D","(","u_colormap0",",","bM",")",")",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lj","=","u_alpha_factor","*","Li",";","Lj","+=","(","1.0","-","step","(","0.0",",","Lj",")",")",";","Li","=",
"mix","(","Lj",",","1.0",",","u_diffuse_color",".","a",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Li","=","u_diffuse_color",".","a",";"]}]}}]}]}}]},{type:"textline",tokens:["if","(","Li","<","0.5",")","discard",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","NO_SHADOWS",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["gl_FragColor","=","vec4","(","1.0",")",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","dr","(","bD",".","z",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor",
".","a","*=","clamp","(","bF",".","r",",","0.999999999",",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["}"]}]},exports["shadow.glslv"]={type:"group",parts:[{type:"var",name:"AU_QUALIFIER",tokens:["uniform"]},{type:"var",name:"MAX_BONES",tokens:["0"]},{type:"var",name:"NUM_CAST_LAMPS",tokens:["0"]},{type:"var",name:"SHADOW_TEX_RES",tokens:["0.0"]},{type:"var",name:"VERTEX_ANIM_MIX_NORMALS_FACTOR",tokens:["u_va_frame_factor"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},
{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},"SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},{type:"logical_or_expr",places:6}],group:{type:"group",
parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA","CALC_TBN_SPACE",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_influence",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS",
"BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["AU_QUALIFIER","vec3","au_center_pos",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","float","a_bending_col_main",";"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_bending_col_detail",";","AU_QUALIFIER","float","au_detail_bending_amp",";","AU_QUALIFIER","float","au_branch_bending_amp",";","AU_QUALIFIER","float","au_detail_bending_freq",";"]}]}}]}]}}]},{type:"textline",tokens:["AU_QUALIFIER","float","au_wind_bending_amp",";","AU_QUALIFIER","float","au_wind_bending_freq",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_emitter_center",
";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position_next",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",
tokens:["attribute","vec3","a_normal_next",";"]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec4","a_tangent_next",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logic_negative_expr",places:1},"TEXTURE_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"vec2","u_subpixel_jitter",";"]}]}}]},{type:"textline",tokens:["uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD","SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","mat3","u_shadow_cast_billboard_view_tsr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_grass_map_depth",";","uniform","sampler2D","u_grass_map_color",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_grass_map_dim",";","uniform","float","u_grass_size",";","uniform","float","u_scale_threshold",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsb","[","MAX_BONES","]",";","uniform","vec4","u_transb","[","MAX_BONES","]",";","uniform","vec4","u_arm_rel_trans",";","uniform","vec4","u_arm_rel_quat",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_quatsa","[","MAX_BONES","]",";","uniform","vec4","u_transa","[","MAX_BONES","]",";","uniform","float","u_frame_factor",
";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_jitter_amp",";","uniform","float","u_jitter_freq",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_wind",";","uniform","float","u_time",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","float","u_va_frame_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logic_negative_expr",places:1},"TEXTURE_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_texture_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","float","u_normal_offset",";"]},{type:"condition",parts:[{type:"if",expression:["MAC_OS_SHADOW_HACK"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_v_light_tsr","[","NUM_CAST_LAMPS","]",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_v_light_ts","[","NUM_CAST_LAMPS","]",";","uniform","vec4","u_v_light_r","[","NUM_CAST_LAMPS","]",";"]}]}}]},{type:"textline",tokens:["uniform","mat4","u_p_light_matrix0",";"]},{type:"condition",
parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix1",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix2",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_p_light_matrix3",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec4","bF",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bD",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bI",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bJ",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",
2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bK",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","bL",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",
{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]}]}}]},{type:"include",file:"dynamic_grass.glslv"},
{type:"include",file:"shadow.glslv"},{type:"include",file:"skin.glslv"},{type:"include",file:"wind_bending.glslv"},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"nodes.glslv"}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec2","Ld",";","vec4","Le",",","Lf",";","float","Lg",";","vec3","Lh",",","Li",",","Lj",",","Lk",",","Ll",",","Lm",";","mat4","Ln",",","Lo",",","Lp",",","Lq",";","Ln",
"=","O","(","u_view_tsr",")",";","Lh","=","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"CALC_TBN_SPACE","USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["Li","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["Li","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA","CALC_TBN_SPACE",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["Lj","=","vec3","(","a_tangent",")",";","Lk","=","a_tangent","[","3","]","*","cross","(","Li",",","Lj",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lj","=","vec3","(","0.0",")",";","Lk","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["VERTEX_ANIM"],group:{type:"group",parts:[{type:"textline",tokens:["Lh","=","mix","(","Lh",",","a_position_next",",","u_va_frame_factor",")",";"]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE",{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["Li",
"=","mix","(","Li",",","a_normal_next",",","VERTEX_ANIM_MIX_NORMALS_FACTOR",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["Ll","=","vec3","(","a_tangent",")",";","Lm","=","a_tangent_next","[","3","]","*","cross","(","a_normal_next",",","Ll",")",";","Lj","=","mix","(","Lj",",","Ll",",","u_va_frame_factor",")",";","Lk","=","mix","(","Lk",",","Lm",",","u_va_frame_factor",")",";"]}]}}]}]}}]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"textline",tokens:["sF","(","Lh",",","Lj",",","Lk",",","Li",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","DYNAMIC_GRASS","BILLBOARD",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["Lk","=","au_center_pos",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lk","=","vec3","(","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],
group:{type:"group",parts:[{type:"textline",tokens:["c","Lr","=","ue","(","Lh",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","Li",",","Lk",",","u_grass_map_depth",",","u_grass_map_color",",","u_grass_map_dim",",","u_grass_size",",","u_camera_eye",",","u_camera_quat",",","Ln",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lo","=","O","(","u_model_tsr",")",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",
tokens:["Lj","=","(","Lo","*","vec4","(","Lk",",","1.0",")",")",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["HAIR_BILLBOARD",{type:"logic_negative_expr",places:1},"SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lp","=","O","(","u_shadow_cast_billboard_view_tsr",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lp","=","Ln",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lq","=","ry","(","u_camera_eye",",","Lj",",","Lp",",","Lo",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Lq","=","rs","(","u_camera_eye",",","Lj",",","Lp",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND","BILLBOARD_JITTERED",{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Lq","=","Lq","*","rk","(","u_wind",",","u_time",",","u_jitter_amp",",","u_jitter_freq",",","Lj",")",";"]}]}}]},{type:"textline",tokens:["c","Lr","=","rF","(","Lh","-","Lk",",","Lk",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","Li",",","Lq",")",";","Lr",".","b","=","Lj",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["c","Lr","=","rF","(","Lh",",","Lk",",","vec3","(","0.0",")",",","vec3","(","0.0",")",
",","Li",",","Lo",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Li","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Li","=","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["tt","(","Lr",".","a",",","Lr",".","b",",","Li",")",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bC","=","Lr",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","WIND_BEND","MAIN_BEND_COL","DETAIL_BEND",{type:"logical_and_expr",places:3},{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["bE","=","Lr",".","e",
";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["Lg","=","(","dot","(","cross","(","Lr",".","e",",","Lr",".","c",")",",","Lr",".","d",")","<","0.0",")","?","-","1.0",":","1.0",";","bF","=","vec4","(","Lr",".","c",",","Lg",")",";"]}]}}]}]}}]},{type:"textline",tokens:["Le","=","Ln","*","vec4","(","Lr",".","a",",","1.0",")",";","Lf","=","u_proj_matrix","*","Le",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_JITTER"],
group:{type:"group",parts:[{type:"textline",tokens:["Lf",".","xy","+=","u_subpixel_jitter","*","Lf",".","w",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NODES","ALPHA",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"USE_NODE_B4W_REFRACTION",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bG","=","L","(","Lf",")",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION","REFRACTIVE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bH","=","-","bD",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["ty","(",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["TEXTURE_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["bM","=","rI","(","a_texcoord",",","u_texture_scale",")",";"]}]}}]}]}}]},
{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vM","(","Lr",".","a",",","Lr",".","e",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"NODES","ALPHA",{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bD","=","Le",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_CASTING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ld","=","(","u_proj_matrix","*","Ln","[","3","]",")",".","xy",";","Lg","=","SHADOW_TEX_RES","/","2.0",";","Ld","=","floor","(","Ld","*","Lg","+","0.5",")","/","Lg","-","Ld",";","Lf",".","xy","+=","Ld",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Lf",";","}"]}]},exports["special_lens_flares.glslf"]={type:"group",parts:[{type:"include",
file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler",";","varying","vec2","bM",";","void","main","(",")","{","vec4","Ld",";","Ld","=","texture2D","(","u_sampler",",","bM",")",";","bu","(","Ld",".","rgb",")",";","bx","(","Ld",".","rgb",",","Ld",".","a",")",";","gl_FragColor","=","Ld",";","}"]}]},exports["special_lens_flares.glslv"]={type:"group",parts:[{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"define",name:"LIGHT_INDEX",
tokens:["0"]},{type:"include",file:"math.glslv"},{type:"textline",tokens:["attribute","float","a_lf_dist",";","attribute","vec2","a_lf_bb_vertex",";","attribute","vec2","a_texcoord",";","uniform","mat3","u_view_tsr",";","uniform","mat4","u_proj_matrix",";","uniform","vec3","u_light_directions","[","NUM_LIGHTS","]",";","varying","vec2","bM",";","void","main","(",")","{","vec2","Ld",";","float","Le",";","vec4","Lf",";","vec3","Lg",";","mat4","Lh",";","Lh","=","O","(","u_view_tsr",")",";","bM","=","a_texcoord",
";","Lg","=","normalize","(","u_light_directions","[","LIGHT_INDEX","]",")",";","Lf","=","u_proj_matrix","*","Lh","*","vec4","(","Lg",",","0.0",")",";","Lf",".","x","/=","Lf",".","w",";","Lf",".","y","/=","Lf",".","w",";","Lf","+=","99999.0","*","step","(","Lf",".","z",",","0.0",")",";","Lf","+=","100.0","*","(","step","(","1.0",",","abs","(","Lf",".","x",")",")","+","step","(","1.0",",","abs","(","Lf",".","y",")",")",")",";","Lf",".","x","=","-","a_lf_dist","*","Lf",".","x",";","Lf",".","y","=",
"-","a_lf_dist","*","Lf",".","y",";","Le","=","u_proj_matrix","[","1","]","[","1","]","/","u_proj_matrix","[","0","]","[","0","]",";","Ld","=","vec2","(","a_lf_bb_vertex",".","x","/","Le",",","a_lf_bb_vertex",".","y",")",";","if","(","a_lf_dist",">","-","0.999",")","{","const","float","Li","=","1.9",";","Ld","*=","(","1.0","+","Li","*","length","(","Lf",".","xy",")",")",";","}","gl_Position","=","vec4","(","Lf",".","xy","+","Ld",",","0.999999",",","1.0",")",";","}"]}]},exports["special_skydome.glslf"]=
{type:"group",parts:[{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"define",name:"INV_PI",tokens:["0.318309886"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"condition",parts:[{type:"if",expression:["WO_SKYTEX","PROCEDURAL_SKYDOME",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",
places:1},"WO_SKYTEX",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"include",file:"std_enums.glsl"},{type:"include",file:"blending.glslf"},{type:"textline",tokens:["uniform","vec4","u_sky_tex_fac",";","uniform","vec3","u_sky_tex_color",";","uniform","float","u_sky_tex_dvar",";","vec3","Nh","(","vec3","Nc",",","vec3","Nd",",","float","Ne",",","float","Nf",")","{","float","Ng",";","Ng","=","Ne","*","Nf",";"]},{type:"condition",parts:[{type:"if",expression:["BLENDTYPE","MIX",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Lr","(","Nd",",","Nc",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","ADD",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Lv","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SUBTRACT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Lz","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",
expression:["BLENDTYPE","MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LE","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SCREEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LJ","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","OVERLAY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LO","(","Nc",
",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIFFERENCE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LS","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIVIDE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LW","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DARKEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["return","L_","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","LIGHTEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Md","(","Nc",",","Nd",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","HUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Mj","(","Nd",",","Nc",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SATURATION",{type:"equal_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["return","Mp","(","Nd",",","Nc",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","VALUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Mv","(","Nd",",","Nc",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","COLOR",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","MB","(","Nd",",","Nc",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE",
"SOFT_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","MG","(","Nd",",","Nc",",","Ng",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","LINEAR_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","MK","(","Nd",",","Nc",",","Ng",")",";"]}]}}]},{type:"textline",tokens:["return","vec3","(","1.0",",","0.0",",","1.0",")",";","}","float","Np","(","float","Ni",",","float","Nj",",","float","Nk",",","float","Nl",
")","{","float","Nm",";","vec3","Nn",",","No",";","Nn","=","vec3","(","Ni",")",",","No","=","vec3","(","Nj",")",";","Nm","=","Nk","*","Nl",";"]},{type:"condition",parts:[{type:"if",expression:["BLENDTYPE","MIX",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Lr","(","No",",","Nn",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","ADD",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Lv","(","Nn",
",","No",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","SUBTRACT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Lz","(","Nn",",","No",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","MULTIPLY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","MQ","(","Ni",",","Nj",",","Nm",",","Nl",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","SCREEN",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["return","MW","(","Ni",",","Nj",",","Nm",",","Nl",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","OVERLAY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Nb","(","Ni",",","Nj",",","Nm",",","Nl",")",";"]}]}},{type:"elif",expression:["BLENDTYPE","DIFFERENCE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LS","(","Nn",",","No",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE",
"DIVIDE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","LW","(","Nn",",","No",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","DARKEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","L_","(","Nn",",","No",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","LIGHTEN",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","Md","(","Nn",",","No",
",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","SOFT_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","MG","(","No",",","Nn",",","Nm",")",".","x",";"]}]}},{type:"elif",expression:["BLENDTYPE","LINEAR_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","MK","(","No",",","Nn",",","Nm",")",".","x",";"]}]}}]},{type:"textline",tokens:["return","0.0",";","}"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"REFLECTION_PASS",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_camera_eye_frag",
";","uniform","vec4","u_underwater_fog_color_density",";"]}]}}]},{type:"textline",tokens:["varying","vec3","Lc",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1},"WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","Nq",";","float","Nr",",","Ns",",","Nt",
";","vec3","Nu",",","Nv",",","Nw",",","Nx",",","Ny",";","Nv","=","normalize","(","Lc",")",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME"],group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","textureCube","(","u_sky",",","Nv",")",".","rgb",";"]}]}},{type:"elif",expression:["WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","u_horizon_color",";","bu","(",
"Nu",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:[";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYPAPER"],group:{type:"group",parts:[{type:"textline",tokens:["Nw","=","vec3","(","bM",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nw","=","vec3","(","Lc",".","xy",",","0.0",")",";"]}]}}]},{type:"textline",tokens:["Nr","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYBLEND"],group:{type:"group",
parts:[{type:"condition",parts:[{type:"if",expression:["WO_SKYPAPER"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WO_SKYREAL"],group:{type:"group",parts:[{type:"textline",tokens:["Nr","=","abs","(","bM",".","y",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nr","=","(","bM",".","y","+","1.0",")","*","0.5",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","acos","(","Nv",".","y",")",";"]},{type:"condition",
parts:[{type:"if",expression:["WO_SKYREAL"],group:{type:"group",parts:[{type:"textline",tokens:["Nr","=","abs","(","Ns","*","INV_PI","-","0.5",")","*","2.0",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nr","=","1.0","-","Ns","*","INV_PI",";"]}]}}]}]}}]}]}}]},{type:"textline",tokens:["Nx","=","u_horizon_color",";","Ny","=","u_zenith_color",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYTEX"],group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","1.0",
";","Nq","=","textureCube","(","u_sky",",","Nv",")",";","br","(","Nq",".","rgb",")",";","Ns","=","Nq",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT"],group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","bB","(","Nq",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["MTEX_NEGATIVE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",
tokens:["Nq","=","vec4","(","vec3","(","1.0",")","-","Nq",".","rgb",",","Nq",".","a",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","1.0","-","Ns",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_HORIZ","WOMAP_ZENUP","WOMAP_ZENDOWN",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT"],group:{type:"group",parts:[{type:"textline",tokens:["Nq","=","vec4","(","u_sky_tex_color",
",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","Nq",".","a",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_HORIZ"],group:{type:"group",parts:[{type:"textline",tokens:["Nx","=","Nh","(","Nq",".","rgb",",","Nx",",","Ns",",","u_sky_tex_fac","[","1","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENUP","WOMAP_ZENDOWN",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nt",
"=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYREAL"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","dot","(","Nw",",","vec3","(","0.0",",","1.0",",","0.0",")",")",">=","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENUP"],group:{type:"group",parts:[{type:"textline",tokens:["Nt","=","u_sky_tex_fac","[","2","]",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:[";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",
parts:[{type:"if",expression:["WOMAP_ZENDOWN"],group:{type:"group",parts:[{type:"textline",tokens:["else","Nt","=","u_sky_tex_fac","[","3","]",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WOMAP_ZENUP"],group:{type:"group",parts:[{type:"textline",tokens:["Nt","=","u_sky_tex_fac","[","2","]",";"]}]}},{type:"elif",expression:["WOMAP_ZENDOWN"],group:{type:"group",parts:[{type:"textline",tokens:["Nt","=","u_sky_tex_fac","[","3","]",";"]}]}}]}]}}]},
{type:"textline",tokens:["if","(","Nt","!=","0.0",")","Ny","=","Nh","(","Nq",".","rgb",",","Ny",",","Ns",",","Nt",")",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WOMAP_BLEND"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MTEX_RGBTOINT",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","dot","(","Nq",".","rgb",",","vec3","(","0.2126",",","0.7152",",","0.0722",")",")",";"]}]}}]},{type:"textline",tokens:["Nr",
"=","Np","(","u_sky_tex_dvar",",","Nr",",","Ns",",","u_sky_tex_fac","[","0","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WO_SKYBLEND"],group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","mix","(","Nx",",","Ny",",","Nr",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","Nx",";"]}]}}]},{type:"textline",tokens:["bu","(","Nu",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["bu","(","Nx",")",";","bu","(",
"Ny",")",";"]},{type:"condition",parts:[{type:"if",expression:["WO_SKYBLEND"],group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","mix","(","Nx",",","Ny",",","Nr",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","Nx",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},"REFLECTION_PASS",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:3}],group:{type:"group",
parts:[{type:"textline",tokens:["br","(","Nu",")",";","Nr","=","WATER_LEVEL","-","u_camera_eye_frag",".","y",";","Nx","=","vec3","(","0.0",")",";","Nx","=","mix","(","u_underwater_fog_color_density",".","rgb",",","Nx",",","min","(","-","Nv",".","y",",","1.0",")",")",";","Nx","*=","min","(","1.0","-","min","(","0.03","*","Nr",",","0.8",")",",","1.0",")",";","Nr","=","clamp","(","sign","(","0.01","*","Nr","-","Nv",".","y",")",",","0.0",",","1.0",")",";","Nu","=","mix","(","Nu",",","Nx",",","Nr",")",
";","bu","(","Nu",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","vec4","(","Nu",",","1.0",")",";","}"]}]},exports["special_skydome.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_position",";","uniform","mat4","u_sky_vp_inverse",";","varying","vec3","Lc",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1},"WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","Nc",",","Nd",";","Nc","=","vec4","(","a_position",".","xy",",","0.9999999",",","1.0",")",";","Nd","=","u_sky_vp_inverse","*","Nc",";","Lc","=","Nd",".","xyz",";"]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_SKYDOME",{type:"logic_negative_expr",places:1},"WO_SKYTEX","WO_SKYBLEND",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["bM","=","a_position",".","xy",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Nc",";","}"]}]},exports["special_water.glslf"]={type:"group",parts:[{type:"var",name:"ABSORB",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},{type:"var",name:"SSS_STRENGTH",tokens:["6.0"]},{type:"var",name:"SSS_WIDTH",tokens:["0.0"]},{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",
tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NUM_LFACTORS",tokens:["0"]},{type:"include",file:"std_enums.glsl"},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"procedural.glslf"},{type:"include",
file:"pack.glslf"},{type:"include",file:"color_util.glslf"},{type:"include",file:"math.glslv"},{type:"define",name:"REFL_BUMP",tokens:["0.001"]},{type:"define",name:"REFR_BUMP",tokens:["0.0005"]},{type:"textline",tokens:["uniform","float","u_time",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT","SKY_TEXTURE",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","samplerCube","u_sky_texture",";"]}]}},{type:"elif",expression:["USE_ENVIRONMENT_LIGHT",
"SKY_COLOR",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_horizon_color",";","uniform","vec3","u_zenith_color",";"]}]}}]},{type:"textline",tokens:["uniform","float","u_environment_energy",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec3","u_light_positions","[","NUM_LIGHTS","]",";","uniform","vec3","u_light_directions","[",
"NUM_LIGHTS","]",";","uniform","vec3","u_light_color_intensities","[","NUM_LIGHTS","]",";","uniform","vec4","u_light_factors","[","NUM_LFACTORS","]",";"]}]}}]},{type:"textline",tokens:["uniform","vec3","u_sun_intensity",";","uniform","vec3","u_sun_direction",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHORE_SMOOTHING","WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2},{type:"logical_or_expr",
places:3}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_cam_water_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_color_density",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_underwater_fog_color_density",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat4","u_cube_fog",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_fog_params",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_normalmap0",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_refractmap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_plane_reflection",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"samplerCube","u_mirrormap",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","sampler2D","u_scene_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_foam",";"]}]}}]},{type:"textline",tokens:["uniform","vec4","u_diffuse_color",";","uniform","vec2","u_diffuse_params",";","uniform","float","u_diffuse_intensity",
";","uniform","float","u_ambient",";","uniform","vec4","u_fresnel_params",";","uniform","vec3","u_specular_color",";","uniform","vec3","u_specular_params",";","uniform","vec3","u_shallow_water_col",";","uniform","vec3","u_shore_water_col",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_water_norm_uv_velocity",";","uniform","vec2","u_normalmap0_scale",";"]},{type:"condition",
parts:[{type:"if",expression:["NUM_NORMALMAPS",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap1_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_normalmap2_scale",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform",
"vec2","u_normalmap3_scale",";"]}]}}]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_mirror_factor",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_reflect_factor",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_water_shallow_col_fac",";","uniform","float","u_water_shore_col_fac",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_foam_factor",";","uniform","vec2","u_foam_uv_freq",
";","uniform","vec2","u_foam_mag",";","uniform","vec2","u_foam_scale",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","float","u_refr_bump",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["const","float","Nc","=","1.0",";","uniform","vec3","u_wireframe_edge_color",";"]}]}}]},{type:"textline",tokens:["varying","vec3","vz",";","varying",
"vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bF",";","varying",
"vec3","Nd",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","NUM_NORMALMAPS",0,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH","DYNAMIC",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"vec3","Ne",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Nf",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE",
"REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","bH",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","tz",";"]}]}}]},{type:"include",file:"environment.glslf"},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE","SHORE_SMOOTHING",
"USE_REFRACTION_CORRECTION",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"include",file:"refraction.glslf"}]}}]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"include",file:"fog.glslf"}]}}]},{type:"textline",tokens:["vec3","Nr","(","in","vec2","Ng",",","in","vec3","Nh",",","in","vec3","Ni",",","in","vec3","Nj",",","out","float","Nk",")","{","float","Nl",",","Nm",",","Nn",";","vec2","No",
";","vec3","Np",",","Nq",";","Nk","=","0.0",";","Np","=","reflect","(","-","Ni",",","Nh",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["No","=","Ng",".","xy","+","Nh",".","xz","*","REFL_BUMP","/","bH",";","Nk","=","u_reflect_factor",";","if","(","u_cam_water_depth","<","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",
places:1},"WATER_EFFECTS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nq","=","u_underwater_fog_color_density",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nq","=","u_diffuse_color",".","rgb",";"]}]}}]},{type:"textline",tokens:["}","else","{","Nq","=","texture2D","(","u_plane_reflection",",","No",")",".","rgb",";","br","(","Nq",")",";","}"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nk","=","u_mirror_factor",";","Nq","=","Nj","*","textureCube","(","u_mirrormap",",","Np",")",".","rgb",";","br","(","Nq",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nk","=","u_reflect_factor",";","Nq","=","Nj","*","vec3","(","0.3",",","0.5",",","1.0",")",";","br","(","Nq",")",";"]}]}}]},{type:"textline",tokens:["Np","=","normalize","(","Np","+","Ni",")",";","Nl","=","1.0","-","dot","(","Ni",",","Np",
")",";","Nm","=","u_fresnel_params","[","3","]",";","Nn","=","u_fresnel_params","[","2","]",";","Nn","=","Nm","+","(","1.0","-","Nm",")","*","pow","(","Nl",",","Nn",")",";","Nk","=","min","(","Nk","*","Nn",",","1.0",")",";","return","Nq",";","}"]},{type:"include",file:"lighting_nodes.glslf"},{type:"textline",tokens:["void","main","(",")","{","vec4","Ns",";","vec2","Nt",",","Nu",",","Nv",";","float","Nw",",","Nx",",","Ny",",","Nz",",","NA",";","vec3","NB",",","NC",",","ND",",","NE",",","NF",",","NG",
",","NH",",","NI",",","NJ",";","mat3","NK",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["NK","=","mat3","(","bF",",","Nd",",","bE",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["NB","=","normalize","(","bE",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["NB","=","vec3","(","0.0",",",
"1.0",",","0.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","FOAM",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nw","=","bC",".","y","-","WATER_LEVEL",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["Nt","=","vec2","(","Ne",".","x",",","-","Ne",".","z",")","+","0.5",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nt","=","vec2","(","bC",".","x",",","-","bC",".","z",")","+","0.5",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nt","=","bM",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["NC","=","vec3","(","0.0",")",";","ND","=","texture2D","(","u_normalmap0",",","Nt","*","u_normalmap0_scale","+","vec2","(","0.3",",","0.5",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","NC","+=","ND",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["NE","=","vec3","(","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["NORM_FOAM0"],group:{type:"group",
parts:[{type:"textline",tokens:["NE","+=","ND",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ND","=","texture2D","(","u_normalmap0",",","Nt","*","u_normalmap1_scale","+","vec2","(","-","0.3",",","0.7",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","NC","+=","ND",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["NORM_FOAM1"],group:{type:"group",parts:[{type:"textline",tokens:["NE","+=","ND",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ND","=","texture2D","(","u_normalmap0",",","Nt","*","u_normalmap2_scale","+","vec2","(","0.0",",","1.1",")","*","u_water_norm_uv_velocity","*","u_time",")",".","xyz","-","0.5",";","NC","+=","ND",";"]},{type:"condition",parts:[{type:"if",
expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM2"],group:{type:"group",parts:[{type:"textline",tokens:["NE","+=","ND",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ND","=","texture2D","(","u_normalmap0",",","Nt","*","u_normalmap3_scale","+","vec2","(","-","0.66",",","-","0.3",")","*","u_water_norm_uv_velocity","*","u_time",
")",".","xyz","-","0.5",";","NC","+=","ND",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NORM_FOAM3"],group:{type:"group",parts:[{type:"textline",tokens:["NE","+=","ND",";"]}]}}]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",
tokens:["NE","=","NK","*","NE",";","if","(","!","f","(","NE",",","vec3","(","0.0",")",")",")","NE","=","normalize","(","NE",")",";","NE","=","mix","(","NB",",","NE",",","0.2",")",";","NE","=","normalize","(","NE",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["NB","=","mix","(","NB",",","normalize","(","NK","*","NC",")",",","0.3",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["NB","=","mix",
"(","NB",",","normalize","(","NK","*","NC",")",",","0.5",")",";"]}]}}]},{type:"textline",tokens:["NB","=","normalize","(","NB",")",";"]}]}}]},{type:"textline",tokens:["NC","=","normalize","(","vz",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","bG",".","xy","/","bG",".","z",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["Nv","=","Nu","+","NB",".","xz","*","u_refr_bump","/","bH",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["Nx","=","u_diffuse_color",".","a",";","Ns","=","texture2DProj","(","u_scene_depth",",","bG",")",";","Ny","=","Z","(","Ns",")",";","Nz","=","max","(","Ny","-","bH",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],
group:{type:"group",parts:[{type:"textline",tokens:["Ny","=","dY","(","Ny",",","Nv",",","Nu",")",";","Ny","=","max","(","Ny","-","bH",",","0.0",")",";","Ny","=","u_view_max_depth","/","ABSORB","*","Ny",";","Ny","=","min","(","Nx","*","Ny",",","1.0",")",";","Nx","=","min","(","15.0","*","Nx","*","u_view_max_depth","*","Nz",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["NA","=","u_view_max_depth","/","ABSORB","*","Nz",";","if","(","u_cam_water_depth",">","0.0",
")","Nx","=","min","(","Nx","*","NA",",","1.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nx","=","u_diffuse_color",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["Ny","=","Nx",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_cam_water_depth","<","0.0",")","Ny","=","0.0",";","ND","=","texture2D",
"(","u_refractmap",",","Nv",")",".","rgb",";","br","(","ND",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["NA","=","pow","(","min","(","Nf",".","b","/","u_water_shallow_col_fac",",","1.0",")",",","0.3",")",";","NF","=","mix","(","u_shallow_water_col",",","u_diffuse_color",".","rgb",",","NA",")",";","NA","=","pow","(","min","(","Nf",".","b","/","u_water_shore_col_fac",",","1.0",")",",","0.3",")",";","NF","=","mix",
"(","u_shore_water_col",",","NF",",","NA",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["NF","=","u_diffuse_color",".","rgb",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING"],group:{type:"group",parts:[{type:"textline",tokens:["Nz","=","max","(","1.0","-","u_view_max_depth","*","Nz",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["Nz","=","1.0","-","Nx",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["Nw","=","max","(","Nw","/","WAVES_HEIGHT","+","0.1",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["NG","=","normalize","(","vec3","(","Nf",".","r",",","0.0",",","Nf",".","g",")",")",";","NG","=","normalize","(","mix","(","vec3","(","0.0",",","1.0",",","0.0",
")",",","NG",",","0.8",")",")",";","NA","=","1.25","*","max","(","dot","(","NE",",","NG",")","-","0.2",",","0.0",")",";","NA","+=","max","(","dot","(","NE",",","vec3","(","0.0",",","-","1.0",",","0.0",")",")",",","0.0",")",";","Nz","+=","NA","*","(","1.0","-","Nf",".","b",")",";","Nw","*=","(","1.0","-","0.95","*","pow","(","Nf",".","b",",","0.1",")",")",";"]}]}}]},{type:"textline",tokens:["Nz","+=","Nw",";","Nz","=","min","(","u_foam_factor","*","Nz",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["Ns",
"=","texture2D","(","u_foam",",","u_foam_mag","*","sin","(","u_foam_uv_freq","*","u_time",")","+","Nt","*","u_foam_scale",")",";"]}]}}]},{type:"textline",tokens:["Nw","=","u_specular_params","[","0","]",";","Nt","=","vec2","(","u_specular_params","[","1","]",",","u_specular_params","[","2","]",")",";","NE","=","Nw","*","u_specular_color",";","NG","=","u_environment_energy","*","dS","(","NB",")",";","NG","=","u_ambient","*","NG",";","NG","=","NG","+","u_sun_intensity",";"]},{type:"condition",parts:[{type:"if",
expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["NH","=","Nr","(","Nu",",","NB",",","NC",",","NG",",","Nw",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["NH","=","Nr","(","vec2","(","0.0",")",",","NB",",","NC",",","NG",",","Nw",")",";"]}]}}]},{type:"textline",tokens:["NF","=","u_diffuse_intensity","*","NF",";","xR","(","vec3","(","0.0",")",",","vec3","(","0.0",")",",","NF",",","NE",",","bC",
",","NB",",","NC",",","Nt",",","u_diffuse_params",",","vec4","(","1.0",")",",","0.0",",","vec4","(","0.0",")",",","NI",",","NJ",")",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["NA","=","max","(","dot","(","u_sun_direction",",","-","bE",")","+","SSS_WIDTH",",","0.0",")","*","max","(","dot","(","-","NC",",","u_sun_direction",")","-","0.5",",","0.0",")","*","max","(","0.0",",","length","(","u_sun_intensity",")","-","0.1",")",";",
"NA","=","clamp","(","SSS_STRENGTH","*","NA",",","0.0",",","1.0",")",";","NI","=","mix","(","NI",",","u_shallow_water_col",",","NA",")",";","NI","=","mix","(","NI",",","u_shore_water_col",",","NA",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"textline",tokens:["NI","=","mix","(","ND",",","NI",",","Ny",")",";"]}]}}]},{type:"textline",tokens:["NI","=","mix","(","NI",",","NH",",","Nw",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOAM"],
group:{type:"group",parts:[{type:"textline",tokens:["Nw","=","mix","(","Ns",".","g",",","Ns",".","r",",","max","(","4.0","*","(","Nz","-","0.75",")",",","0.0",")",")",";","Nw","=","mix","(","Ns",".","b",",","Nw",",","max","(","2.0","*","Nz","-","1.0",",","0.0",")",")",";","Nw","=","mix","(","0.0",",","Nw",",","Nz",")",";","NI","=","mix","(","NI",",","NG",",","Nw",")",";"]}]}}]},{type:"textline",tokens:["NI","+=","NJ",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_FOG",{type:"logic_negative_expr",
places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Nz","=","bH","*","u_view_max_depth",";","Ny","=","1.0",";","if","(","u_cam_water_depth",">","1.0",")","Ny","=","2.0",";","vy","(","NI",",","Nz",",","NC",",","Ny",")",";"]}]}}]},{type:"textline",tokens:["bu","(","NI",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFRACTIVE",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Nx","=","max","(","Nx",",","NJ",".","r",")",";"]},{type:"condition",
parts:[{type:"if",expression:["FOAM"],group:{type:"group",parts:[{type:"textline",tokens:["Nx","+=","Nw",";"]}]}}]}]}},{type:"elif",expression:["SHORE_SMOOTHING",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Nx","=","1.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["bx","(","NI",",","Nx",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME",1,{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"extension",tokens:["GL_OES_standard_derivatives",":","enable"]},{type:"textline",tokens:["NJ","=","fwidth","(","tz",")",";","NJ","=","smoothstep","(","vec3","(","0.0",")",",","NJ","*","Nc",",","tz",")",";","Nw","=","min","(","min","(","NJ",".","x",",","NJ",".","y",")",",","NJ",".","z",")",";","Nw","=","clamp","(","Nw",",","0.0",",","1.0",")",";","NI","=","mix","(","u_wireframe_edge_color",",","NI",",","Nw",")",";","Nx","=","mix","(","1.0",",","Nx",",",
"Nw",")",";"]}]}},{type:"elif",expression:["DEBUG_WIREFRAME",2,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["NJ","=","sign","(","tz","-","vec3","(","0.02","*","Nc",")",")",";","Nw","=","1.0",";","if","(","NJ",".","x","<","0.0","||","NJ",".","y","<","0.0","||","NJ",".","z","<","0.0",")","Nw","=","0.0",";","NI","=","mix","(","u_wireframe_edge_color",",","NI",",","Nw",")",";","Nx","=","mix","(","1.0",",","Nx",",","Nw",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor",
"=","vec4","(","NI",",","Nx",")",";","}"]}]},exports["special_water.glslv"]={type:"group",parts:[{type:"var",name:"DIR_MIN_SHR_FAC",tokens:["0.0"]},{type:"var",name:"DIR_FREQ",tokens:["0.0"]},{type:"var",name:"DIR_NOISE_SCALE",tokens:["0.0"]},{type:"var",name:"DIR_NOISE_FREQ",tokens:["0.0"]},{type:"var",name:"DIR_MIN_NOISE_FAC",tokens:["0.0"]},{type:"var",name:"DST_NOISE_SCALE_0",tokens:["0.0"]},{type:"var",name:"DST_NOISE_FREQ_0",tokens:["0.0"]},{type:"var",name:"DST_NOISE_SCALE_1",tokens:["0.0"]},
{type:"var",name:"DST_NOISE_FREQ_1",tokens:["0.0"]},{type:"var",name:"DST_MIN_FAC",tokens:["0.0"]},{type:"var",name:"MAX_SHORE_DIST",tokens:["0.0"]},{type:"var",name:"PRECISION",tokens:["mediump"]},{type:"var",name:"SHORE_MAP_CENTER_X",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_SIZE_X",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_CENTER_Y",tokens:["0.0"]},{type:"var",name:"SHORE_MAP_SIZE_Y",tokens:["0.0"]},{type:"var",name:"WAVES_HOR_FAC",tokens:["0.0"]},{type:"var",name:"WATER_LEVEL",tokens:["0.0"]},
{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"var",name:"WAVES_LENGTH",tokens:["0.0"]},{type:"include",file:"math.glslv"},{type:"include",file:"to_world.glslv"},{type:"include",file:"scale_texcoord.glslv"},{type:"include",file:"procedural.glslf"},{type:"textline",tokens:["attribute","vec3","a_position",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"DYNAMIC",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["attribute","vec3","a_normal",";","attribute","vec3","a_tangent",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH",{type:"logic_negative_expr",places:1},"NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_texcoord",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",
parts:[{type:"textline",tokens:["attribute","float","a_polyindex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["STATIC_BATCH"],group:{type:"group",parts:[{type:"textline",tokens:["const","mat3","u_model_tsr","=","mat3","(","0.0",",","0.0",",","0.0",",","1.0",",","0.0",",","0.0",",","0.0",",","1.0",",","0.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["uniform","mat3","u_model_tsr",";"]}]}}]},{type:"textline",tokens:["uniform","mat3","u_view_tsr",";",
"uniform","mat4","u_proj_matrix",";","uniform","vec3","u_camera_eye",";"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_time",";","uniform","vec3","u_wind",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",
parts:[{type:"textline",tokens:["uniform","PRECISION","float","u_view_max_depth",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_shore_dist_map",";"]}]}}]},{type:"textline",tokens:["varying","vec3","vz",";","varying","vec3","bC",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH",{type:"logic_negative_expr",
places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","bM",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bF",";","varying","vec3","Nd",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC","NUM_NORMALMAPS",0,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["varying","vec3","bE",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2},"GENERATED_MESH","DYNAMIC",{type:"logical_and_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Ne",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","Nf",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","bG",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["varying",
"float","bH",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","tz",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","Nk","(","in","vec2","Nc",")","{","float","Ng",";","vec4","Nh",";","vec2","Ni",";","Ni","=","0.5","+","vec2","(","(","Nc",".","x","-","SHORE_MAP_CENTER_X",")","/","SHORE_MAP_SIZE_X",",","-","(","Nc",".",
"y","+","SHORE_MAP_CENTER_Y",")","/","SHORE_MAP_SIZE_Y",")",";","Nh","=","texture2D","(","u_shore_dist_map",",","Ni",")",";","const","vec2","Nj","=","vec2","(","1.0","/","255.0",",","1.0",")",";","Ng","=","dot","(","Nh",".","ba",",","Nj",")",";","Ni","=","normalize","(","Nh",".","rg","*","2.0","-","1.0",")",";","return","vec3","(","Ni",",","Ng",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"define",name:"M_PI",tokens:["3.14159265359"]},
{type:"define",name:"SMALL_WAVES_FAC",tokens:["0.3"]},{type:"textline",tokens:["void","Nw","(","inout","vec3","Nl",",","in","float","Nm",",","in","vec3","Nn",")","{","vec2","No",",","Np",",","Nq",";","float","Nr",",","Ns",",","Nt",",","Nu",",","Nv",";","Nr","=","aU","(","DST_NOISE_SCALE_0","*","(","Nl",".","xz","+","DST_NOISE_FREQ_0","*","Nm",")",")","*","aU","(","DST_NOISE_SCALE_1","*","(","Nl",".","zx","-","DST_NOISE_FREQ_1","*","Nm",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],
group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","WAVES_LENGTH","/","MAX_SHORE_DIST","/","M_PI",";","Nt","=","Nn",".","b",";","Nu","=","sqrt","(","Nt",")",";","Ns","=","max","(","Nt",",","DIR_MIN_SHR_FAC",")","*","sin","(","Nu","/","Ns","+","DIR_FREQ","*","Nm",")",";","Nv","=","max","(","aU","(","DIR_NOISE_SCALE","*","(","Nl",".","xz","+","DIR_NOISE_FREQ","*","Nm",")",")",",","DIR_MIN_NOISE_FAC",")",";","Ns","*=","Nv",";","Nu","=","WAVES_HEIGHT","*","mix","(","Ns",",","Nr",",","max","(",
"Nu",",","DST_MIN_FAC",")",")",";","No","=","Nn",".","rg",";","Ns","=","WAVES_HOR_FAC","*","Ns","*","max","(","MAX_SHORE_DIST","/","35.0","*","(","0.05","-","Nt",")",",","0.0",")",";","No","=","Ns","*","No",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nu","=","WAVES_HEIGHT","*","Nr",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["Np","=","2.0","*","(","Nl",".","xz","-","0.1","*","Nm",")",
";","Nq","=","1.3","*","(","Nl",".","zx","+","0.03","*","Nm",")",";","Nr","=","ay","(","0.5","*","(","Np","+","Nq",")",")",".","x","-","0.5",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["Nl",".","xz","+=","No",";","Nr","*=","Nt",";"]}]}}]},{type:"textline",tokens:["Nu","+=","SMALL_WAVES_FAC","*","Nr",";"]}]}}]},{type:"textline",tokens:["Nl",".","y","+=","Nu",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{",
"vec4","Nx",",","Ny",";","vec2","Nz",";","float","NA",",","NB",",","NC",";","vec3","ND",",","NE",",","NF",",","NG",",","NH",";","mat4","NI",",","NJ",";","NI","=","O","(","u_view_tsr",")",";","NJ","=","O","(","u_model_tsr",")",";"]},{type:"condition",parts:[{type:"if",expression:["DEBUG_WIREFRAME"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","a_polyindex","==","0.0",")","tz","=","vec3","(","1.0",",","0.0",",","0.0",")",";","else","if","(","a_polyindex","==","1.0",")","tz","=","vec3",
"(","0.0",",","1.0",",","0.0",")",";","else","if","(","a_polyindex","==","2.0",")","tz","=","vec3","(","0.0",",","0.0",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["ND","=","a_position",";","NA","=","abs","(","ND",".","y",")",";","Nz","=","u_camera_eye",".","xz","-","mod","(","u_camera_eye",".","xz",",","NA",")",";","ND",".","y","=","WATER_LEVEL",";","ND",".","xz","+=","Nz",";","ND","=","ND",";"]}]}},
{type:"else",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bM","=","a_texcoord",";"]}]}}]},{type:"textline",tokens:["c","NK","=","rF","(","a_position",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","NJ",")",";","ND","=","NK",".","a",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["Nf","=","Nk","(","ND",".","xz",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC"],group:{type:"group",parts:[{type:"textline",tokens:["NB","=","length","(","u_wind",")",";","NC","=","u_time",";","NC","*=","NB",";"]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["NA","=","NA",";","NE","=","ND","+","vec3","(","NA",",","0.0",",",
"0.0",")",";","NF","=","ND","+","vec3","(","0.0",",","0.0",",","NA",")",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2},"FOAM",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ne","=","ND",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["NE","=","ND","+","vec3","(","0.05",",","0.0",",","0.0",")",";","NF","=","ND","+","vec3","(","0.0",",","0.0",",","0.05",")",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SHORE_PARAMS"],group:{type:"group",parts:[{type:"textline",tokens:["NG","=","Nk","(","NE",".","xz",")",";","NH","=","Nk","(","NF",".","xz",")",";","Nw","(","NE",",","NC",",","NG",")",";","Nw","(","NF",",","NC",",","NH",")",";","Nw","(","ND",",","NC",",","Nf",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nw","(","NE",",","NC",",","vec3","(","0.0",")",")",";","Nw","(","NF",",","NC",",","vec3","(","0.0",")",")",";","Nw","(","ND",",","NC",
",","vec3","(","0.0",")",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["GENERATED_MESH"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","a_position",".","y","<","0.0",")","{","ND",".","y","=","WATER_LEVEL","-","1.0",";","NE",".","y","=","ND",".","y",";","NF",".","y","=","ND",".","y",";","}"]}]}}]},{type:"textline",tokens:["NE","=","normalize","(","NE","-","ND",")",";","NF","=","normalize","(","NF","-","ND",")",";","bE","=","normalize","(","cross","(","NF",",","NE",")",
")",";","NC","=","dot","(","bE",",","vec3","(","0.0",",","1.0",",","0.0",")",")",";","NC","=","clamp","(","0.8","-","NC",",","0.0",",","1.0",")",";","bE","=","mix","(","bE",",","vec3","(","0.0",",","1.0",",","0.0",")",",","NC",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_NORMALMAPS",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DYNAMIC",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",
tokens:["NF","=","a_tangent",";","bE","=","a_normal",";"]}]}}]},{type:"textline",tokens:["bF","=","NF",";","Nd","=","cross","(","bE",",","bF",")",";"]}]}}]},{type:"textline",tokens:["bC","=","ND",";","vz","=","u_camera_eye","-","ND",";","Nx","=","NI","*","vec4","(","ND",",","1.0",")",";","Ny","=","u_proj_matrix","*","Nx",";"]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE",{type:"logical_or_expr",places:3}],
group:{type:"group",parts:[{type:"textline",tokens:["NC","=","Ny",".","x",";","NA","=","Ny",".","y",";","NB","=","Ny",".","w",";","bG",".","x","=","(","NC","+","NB",")","/","2.0",";","bG",".","y","=","(","NA","+","NB",")","/","2.0",";","bG",".","z","=","NB",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SHORE_SMOOTHING","REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"REFRACTIVE","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_or_expr",places:4}],group:{type:"group",
parts:[{type:"textline",tokens:["bH","=","-","Nx",".","z","/","u_view_max_depth",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","Ny",";","}"]}]},exports["postprocessing/antialiasing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","vec2","u_texel_size",";","varying","vec2","bM",";"]},{type:"define",name:"AA_METHOD_FXAA_LIGHT",tokens:["1"]},{type:"define",
name:"AA_METHOD_FXAA_QUALITY",tokens:["2"]},{type:"define",name:"AA_QUALITY_LOW",tokens:["0"]},{type:"define",name:"AA_QUALITY_MEDIUM",tokens:["1"]},{type:"define",name:"AA_QUALITY_HIGH",tokens:["2"]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","AA_METHOD_FXAA_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_REDUCE_MIN",tokens:["(","1.0","/","128.0",")"]},{type:"define",name:"FXAA_REDUCE_MUL",tokens:["(","1.0","/","8.0",")"]},{type:"define",
name:"FXAA_SPAN_MAX",tokens:["8.0"]},{type:"textline",tokens:["vec4","Ni","(","float","Nc",",","float","Ng",")","{","vec2","Nh",";","Nh","=","bM","+","vec2","(","Nc",",","Ng",")","*","u_texel_size",";","return","texture2D","(","u_color",",","Nh",")",";","}","vec4","Nv","(",")","{","vec2","Nj",";","float","Nk",",","Nl",",","Nm",",","Nn",",","No",",","Np",";","vec4","Nq",",","Nr",",","Ns",",","Nt",",","Nu",";","Nq","=","Ni","(","-","1.0",",","-","1.0",")",";","Nr","=","Ni","(","1.0",",","-","1.0",")",
";","Ns","=","Ni","(","-","1.0",",","1.0",")",";","Nt","=","Ni","(","1.0",",","1.0",")",";","Nu","=","Ni","(","0.0",",","0.0",")",";","Nk","=","bB","(","Nu",")",";","Nl","=","bB","(","Nq",")",";","Nm","=","bB","(","Nr",")",";","Nn","=","bB","(","Ns",")",";","No","=","bB","(","Nt",")",";","Np","=","min","(","Nk",",","min","(","min","(","Nl",",","Nm",")",",","min","(","Nn",",","No",")",")",")",";","Nk","=","max","(","Nk",",","max","(","max","(","Nl",",","Nm",")",",","max","(","Nn",",","No",")",")",
")",";","Nj",".","x","=","-","(","(","Nl","+","Nm",")","-","(","Nn","+","No",")",")",";","Nj",".","y","=","(","(","Nl","+","Nn",")","-","(","Nm","+","No",")",")",";","No","=","max","(","(","Nl","+","Nm","+","Nn","+","No",")","*","(","0.25","*","FXAA_REDUCE_MUL",")",",","FXAA_REDUCE_MIN",")",";","No","=","1.0","/","(","min","(","abs","(","Nj",".","x",")",",","abs","(","Nj",".","y",")",")","+","No",")",";","Nj","=","min","(","vec2","(","FXAA_SPAN_MAX",",","FXAA_SPAN_MAX",")",",","max","(","vec2","(",
"-","FXAA_SPAN_MAX",",","-","FXAA_SPAN_MAX",")",",","Nj","*","No",")",")","*","u_texel_size",";","Nt","=","0.5","*","(","texture2D","(","u_color",",","bM","+","Nj","*","(","1.0","/","3.0","-","0.5",")",")","+","texture2D","(","u_color",",","bM","+","Nj","*","(","2.0","/","3.0","-","0.5",")",")",")",";","Ns","=","Nt","*","0.5","+","0.25","*","(","texture2D","(","u_color",",","bM","+","Nj","*","-","0.5",")","+","texture2D","(","u_color",",","bM","+","Nj","*","0.5",")",")",";","No","=","bB","(","Ns",
")",";","if","(","(","No","<","Np",")","||","(","No",">","Nk",")",")","return","Nt",";","else","return","Ns",";","}"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_FXAA_QUALITY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_GREEN_AS_LUMA",tokens:["1"]},{type:"define",name:"FXAA_BLEND4WEB",tokens:["1"]},{type:"include",file:"fxaa.glslf"},{type:"condition",parts:[{type:"if",expression:["AA_QUALITY","AA_QUALITY_HIGH",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"define",name:"FXAA_QUALITY_PRESET",tokens:["39"]},{type:"define",name:"FXAA_QUALITY_SUBPIX",tokens:["1.00"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD",tokens:["0.063"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD_MIN",tokens:["0.0312"]}]}},{type:"elif",expression:["AA_QUALITY","AA_QUALITY_MEDIUM",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PRESET",tokens:["20"]},{type:"define",name:"FXAA_QUALITY_SUBPIX",tokens:["0.65"]},{type:"define",
name:"FXAA_QUALITY_EDGE_THRESHOLD",tokens:["0.166"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD_MIN",tokens:["0.0625"]}]}},{type:"elif",expression:["AA_QUALITY","AA_QUALITY_LOW",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PRESET",tokens:["12"]},{type:"define",name:"FXAA_QUALITY_SUBPIX",tokens:["0.50"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD",tokens:["0.166"]},{type:"define",name:"FXAA_QUALITY_EDGE_THRESHOLD_MIN",tokens:["0.0833"]}]}}]}]}}]},
{type:"textline",tokens:["void","main","(",")","{","vec2","Om",";"]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","AA_METHOD_FXAA_LIGHT",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","Nv","(",")",";"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_FXAA_QUALITY",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Om","=","u_texel_size",";","gl_FragColor","=","Ol","(","bM",",","u_color",",","Om",
",","FXAA_QUALITY_SUBPIX",",","FXAA_QUALITY_EDGE_THRESHOLD",",","FXAA_QUALITY_EDGE_THRESHOLD_MIN",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/bloom_blur.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","vec2","u_texel_size",";","uniform","sampler2D","u_color",";","varying","vec2","bM",";","void","main","(",")","{","vec4","Nc",";","vec2","Ng",",","Nh",";","Ng","=","vec2","(","0.0",",","0.0",")",";","Nh","=",
"u_texel_size",";","Nc","=","texture2D","(","u_color",",","bM",")",";","gl_FragColor","=","Nc","*","0.0875447373698",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0858112354248",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",")","*","0.0858112354248",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0808139781061",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",
")","*","0.0808139781061",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0731235112908",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",")","*","0.0731235112908",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0635705267419",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",")","*","0.0635705267419",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",
",","bM","+","Ng",")","*","0.0530985673112",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",")","*","0.0530985673112",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0426125984122",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",")","*","0.0426125984122",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0328565115809",";","gl_FragColor","+=","texture2D","(","u_color",
",","bM","-","Ng",")","*","0.0328565115809",";","Ng","+=","Nh",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","+","Ng",")","*","0.0243407024472",";","gl_FragColor","+=","texture2D","(","u_color",",","bM","-","Ng",")","*","0.0243407024472",";","gl_FragColor","=","max","(","0.7","*","Nc",",","gl_FragColor",")",";","}"]}]},exports["postprocessing/bloom_combine.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",
";","uniform","sampler2D","u_bloom",";","varying","vec2","bM",";","void","main","(",")","{","vec4","Nc",",","Ng",";","Nc","=","texture2D","(","u_main",",","bM",")",";","Ng","=","texture2D","(","u_bloom",",","bM",")",";","Nc","=","Nc",";","Nc","+=","Ng",";","gl_FragColor","=","vec4","(","Nc",".","rgb",",","1.0",")",";","}"]}]},exports["postprocessing/compositing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"define",name:"PI_4",
tokens:["0.785398163"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","float","u_brightness",";","uniform","float","u_contrast",";","uniform","float","u_exposure",";","uniform","float","u_saturation",";","varying","vec2","bM",";","void","main","(",")","{","float","Nc",";","vec3","Ng",";","vec4","Nh",";","Nh","=","texture2D","(","u_color",",","bM",")",";","Ng","=","Nh",".","rgb",";","if","(","u_brightness","<","0.0",")","Ng","=","Ng","*","(","1.0","+","u_brightness",")",";",
"else","Ng","=","Ng","+","(","(","1.0","-","Ng",")","*","u_brightness",")",";","Ng","=","(","Ng","-","0.5",")","*","(","tan","(","(","u_contrast","+","1.0",")","*","PI_4",")",")","+","0.5",";","Ng","*=","u_exposure",";","Nc","=","bB","(","vec4","(","Ng",",","0.0",")",")",";","Ng","=","mix","(","vec3","(","Nc",")",",","Ng",",","u_saturation",")",";","gl_FragColor","=","vec4","(","Ng",",","Nh",".","a",")",";","}"]}]},exports["postprocessing/depth_pack.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",
tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"pack.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","vec2","u_camera_range",";","varying","vec2","bM",";","void","main","(",")","{","gl_FragColor","=","V","(","clamp","(","Os","(","u_depth",",","bM",",","u_camera_range",")",",","0.0",",","0.999999",")",")",";","}"]}]},exports["postprocessing/dof.glslf"]=
{type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sharp",";","uniform","sampler2D","u_blurred",";","uniform","sampler2D","u_depth",";","uniform","float","u_view_max_depth",";","uniform","float","u_dof_dist",";","uniform","float","u_dof_front",";","uniform","float","u_dof_rear",
";","uniform","vec2","u_camera_range",";","varying","vec2","bM",";","void","main","(",")","{","float","Nc",",","Ng",";","vec4","Nh",",","Ni",";","Nh","=","texture2D","(","u_sharp",",","bM",")",";","if","(","u_dof_dist",">","0.0",")","{","Nc","=","Os","(","u_depth",",","bM",",","u_camera_range",")",";","Nc","*=","u_view_max_depth",";","if","(","Nc","<","u_dof_dist",")","Ng","=","(","u_dof_dist","-","Nc",")","/","u_dof_front",";","else","Ng","=","(","Nc","-","u_dof_dist",")","/","u_dof_rear",";","Ng",
"=","clamp","(","Ng",",","0.0",",","1.0",")",";","Ni","=","texture2D","(","u_blurred",",","bM",")",";","gl_FragColor","=","mix","(","Nh",",","Ni",",","Ng",")",";","}","else","gl_FragColor","=","Nh",";","}"]}]},exports["postprocessing/glow.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_src_color",";","uniform","sampler2D","u_glow_mask_small",";","uniform","sampler2D","u_glow_mask_large",";","uniform","float","u_glow_mask_small_coeff",
";","uniform","float","u_glow_mask_large_coeff",";","varying","vec2","bM",";","void","main","(",")","{","float","Nc",";","vec4","Ng",",","Nh",",","Ni",";","Ng","=","texture2D","(","u_src_color",",","bM",")",";","Nh","=","texture2D","(","u_glow_mask_small",",","bM",")",";","Ni","=","texture2D","(","u_glow_mask_large",",","bM",")",";","gl_FragColor","=","Ng",";","if","(","Ni",".","a","!=","0.0",")","{","Nc","=","u_glow_mask_large_coeff","*","Ni",".","a",";","Nc","=","clamp","(","Nc",",","0.0",",","1.0",
")",";","gl_FragColor",".","rgb","=","mix","(","gl_FragColor",".","rgb",",","Ni",".","rgb","/","Ni",".","a",",","Nc",")",";","gl_FragColor",".","a","=","mix","(","gl_FragColor",".","a",",","1.0",",","Nc",")",";","}","if","(","Nh",".","a","!=","0.0",")","{","Nc","=","u_glow_mask_small_coeff","*","Nh",".","a",";","Nc","=","clamp","(","Nc",",","0.0",",","1.0",")",";","gl_FragColor",".","rgb","=","mix","(","gl_FragColor",".","rgb",",","Nh",".","rgb","/","Nh",".","a",",","Nc",")",";","gl_FragColor",".",
"a","=","mix","(","gl_FragColor",".","a",",","1.0",",","Nc",")",";","}","}"]}]},exports["postprocessing/god_rays.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"include",file:"procedural.glslf"},{type:"include",file:"pack.glslf"},{type:"var",name:"STEPS_PER_PASS",tokens:["0.0"]},{type:"textline",tokens:["uniform",
"float","u_time",";","uniform","float","u_radial_blur_step",";","uniform","sampler2D","u_input",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec2","u_camera_range",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["varying","float","Ot",";","varying","vec2","Ou",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","bM",";","varying","vec4",
"Ov",";","void","main","(",")","{","vec4","Ow",";","int","Ox",";","float","Oy",",","Oz",",","OA",",","OB",";","vec2","OC",",","OD",",","OE",";","OC","=","(","Ov",".","xy","-","bM",")",";","Oy","=","length","(","OC",")",";","OC","=","u_radial_blur_step","*","OC","/","Oy",";","Oz","=","Oy","/","u_radial_blur_step",";","OC","*=","min","(","Oz",",","STEPS_PER_PASS",")","/","STEPS_PER_PASS",";","Oz","=","max","(","Oz",",","STEPS_PER_PASS",")",";","OD","=","bM",";","OA","=","0.0",";","const","int","OF",
"=","int","(","STEPS_PER_PASS",")",";","Ox","=","int","(","Oz","+","0.5",")",";","for","(","int","OG","=","0",";","OG","<","OF",";","OG","+=","1",")","{","if","(","OG","<=","Ox",")","{"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"textline",tokens:["Oz","=","Os","(","u_input",",","OD",",","u_camera_range",")",";","OA","+=","max","(","(","1.0","-","pow","(","Oy",",","0.3",")",")","*","step","(","0.9",",","Oz",")",",","0.0",")",";"]}]}},{type:"else",
group:{type:"group",parts:[{type:"textline",tokens:["Ow","=","texture2D","(","u_input",",","OD",")",";","OA","+=","Z","(","Ow",")",";"]}]}}]},{type:"textline",tokens:["}","OD","+=","OC",";","}"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA","WATER_EFFECTS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["OE","=","bM","+","Ou",";","OB","=","ay","(","vec2","(","2.5","*","(","OE",".","x",")",",","2.5","*","(","OE",".","y",")","+","1.0","*","u_time",
")",")",".","x","+","0.75","*","ay","(","vec2","(","5.0","*","(","OE",".","x",")","-","0.66","*","u_time",",","5.0","*","(","OE",".","y",")","+","0.66","*","u_time",")",")",".","x","+","0.5","*","aU","(","vec2","(","7.5","*","(","OE",".","x",")","+","0.33","*","u_time",",","7.5","*","(","OE",".","y",")","-","0.33","*","u_time",")",")",";","OB","*=","clamp","(","1.2","-","sqrt","(","0.2","*","Oy",")",",","0.0",",","1.0",")","*","Ot",";","OA","=","max","(","OB",",","OA",")",";"]}]}}]},{type:"textline",
tokens:["gl_FragColor","=","V","(","OA","/","STEPS_PER_PASS",")",";","}"]}]},exports["postprocessing/god_rays.glslv"]={type:"group",parts:[{type:"include",file:"math.glslv"},{type:"textline",tokens:["attribute","vec2","a_bb_vertex",";","uniform","mat4","u_view_proj_matrix",";","uniform","vec3","u_sun_direction",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","vec4","u_camera_quat",";","uniform","float","u_cam_water_depth",";","varying","float","Ot",";","varying","vec2","Ou",";"]}]}}]}]}}]},{type:"textline",tokens:["varying","vec2","bM",";","varying","vec4","Ov",";","void","main","(",")","{","float","Nc",",","Ng",";","vec3","Nh",";","bM","=","a_bb_vertex","+","0.5",";","Nh","=","normalize","(","u_sun_direction",")",";","Ov","=","u_view_proj_matrix","*","vec4","(","Nh",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["DEPTH_RGBA",
"WATER_EFFECTS",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_cam_water_depth","<","0.0",")","{","Ot","=","1.0",";","Nh","=","vec3","(","0.0",",","1.0",",","0.0",")",";","Nh","=","i","(","u_camera_quat",",","Nh",")",";","Nh","=","normalize","(","Nh",")",";","Nc","=","dot","(","Nh",",","vec3","(","0.0",",","1.0",",","0.0",")",")",";","Ng","=","atan","(","Nh",".","x",",","Nh",".","z",")",";","Ou","=","vec2","(","-","Ng",",","acos","(","Nc",")",")",
";","}","else","{","Ot","=","0.0",";","}"]}]}}]},{type:"textline",tokens:["Ov",".","xy","=","0.5","*","(","Ov",".","xy","/","Ov",".","w","+","1.0",")",";","Ov","+=","99999.0","*","step","(","Ov",".","z",",","0.0",")",";","gl_Position","=","vec4","(","2.0","*","a_bb_vertex",".","xy",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/god_rays_combine.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"include",file:"pack.glslf"},
{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_god_rays",";","uniform","float","u_god_rays_intensity",";","uniform","vec3","u_sun_intensity",";","varying","vec2","bM",";","void","main","(",")","{","float","Nc",";","vec3","Ng",";","vec4","Nh",";","Nh","=","texture2D","(","u_main",",","bM",")",";","Ng","=","clamp","(","u_sun_intensity",",","0.4",",","0.8",")",";","br","(","Nh",".","rgb",")",";","Nc","=","Z","(","texture2D","(","u_god_rays",",","bM",")",")",";",
"Ng","=","Nh",".","rgb","+","u_god_rays_intensity","*","vec3","(","Nc",")","*","Ng",";","bu","(","Ng",")",";"]},{type:"condition",parts:[{type:"if",expression:["SAFARI_CANVAS_ALPHA_HACK"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","Ng",",","max","(","0.01",",","Nh",".","a",")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","Ng",",","Nh",".","a",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/luminance.glslf"]=
{type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_input",";","varying","vec2","bM",";","void","main","(",")","{","float","Nc",";","vec4","Ng",";","Ng","=","texture2D","(","u_input",",","bM",")",";","Nc","=","dot","(","Ng",".","rgb",",","vec3","(","0.2126",",","0.7152",",","0.0722",")",")",";","gl_FragColor","=","vec4","(","vec3","(","Nc",")",",","1.0",")",";","}"]}]},exports["postprocessing/luminance_av.glslf"]={type:"group",parts:[{type:"include",
file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_input",";","void","main","(",")","{","float","Nc",",","Ng",",","Nh",",","Ni",";","Ng","=","0.0",";","Nh","=","0.025",";","Ni","=","0.025",";","for","(","int","Nj","=","0",";","Nj","<","20",";","Nj","+=","1",")","{","Ni","=","0.025",";","for","(","int","Nk","=","0",";","Nk","<","20",";","Nk","+=","1",")","{","Nc","=","max","(","texture2D","(","u_input",",","vec2","(","Nh",",","Ni",")",")",".","r",",","0.01",")",";",
"Ng","+=","log","(","Nc",")",";","Ni","+=","0.05",";","}","Nh","+=","0.05",";","}","Ng","=","exp","(","Ng","/","400.0",")",";","gl_FragColor","=","vec4","(","vec3","(","Ng",")",",","1.0",")",";","}"]}]},exports["postprocessing/luminance_trunced.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_main",";","uniform","sampler2D","u_luminance",";","uniform","sampler2D","u_average_lum",";","uniform","float","u_bloom_edge_lum",
";","varying","vec2","bM",";","varying","float","Ow",";","void","main","(",")","{","vec4","Ox",";","float","Oy",",","Oz",";","Oy","=","texture2D","(","u_average_lum",",","vec2","(","0.5",")",")",".","r",";","Oz","=","texture2D","(","u_luminance",",","bM",")",".","r",";","Ox","=","texture2D","(","u_main",",","bM",")",";","Oy","=","Oz","/","Oy",";","Oz","=","u_bloom_edge_lum",";","gl_FragColor","=","Ox","*","max","(","Oy","-","Oz",",","0.0",")","*","Ow",";","}"]}]},exports["postprocessing/luminance_trunced.glslv"]=
{type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_position",";","uniform","vec4","u_camera_quat",";","uniform","vec3","u_sun_direction",";","uniform","float","u_bloom_key",";","varying","vec2","bM",";","varying","float","Ow",";","const","vec3","Nc","=","vec3","(","0.0",",","1.0",",","0.0",")",";","void","Nn","(","in","vec4","Ng",",","in","vec3","Nh",",","out","vec3","Ni",")","{","float","Nj",",","Nk",",","Nl",",","Nm",";","Nj","=","Ng",".","w","*","Nh",".","x","+","Ng",".","y","*",
"Nh",".","z","-","Ng",".","z","*","Nh",".","y",";","Nk","=","Ng",".","w","*","Nh",".","y","+","Ng",".","z","*","Nh",".","x","-","Ng",".","x","*","Nh",".","z",";","Nl","=","Ng",".","w","*","Nh",".","z","+","Ng",".","x","*","Nh",".","y","-","Ng",".","y","*","Nh",".","x",";","Nm","=","-","Ng",".","x","*","Nh",".","x","-","Ng",".","y","*","Nh",".","y","-","Ng",".","z","*","Nh",".","z",";","Ni",".","x","=","Nj","*","Ng",".","w","-","Nm","*","Ng",".","x","-","Nk","*","Ng",".","z","+","Nl","*","Ng",".",
"y",";","Ni",".","y","=","Nk","*","Ng",".","w","-","Nm","*","Ng",".","y","-","Nl","*","Ng",".","x","+","Nj","*","Ng",".","z",";","Ni",".","z","=","Nl","*","Ng",".","w","-","Nm","*","Ng",".","z","-","Nj","*","Ng",".","y","+","Nk","*","Ng",".","x",";","}","void","main","(",")","{","vec3","No",";","bM","=","2.0","*","a_position",";","Nn","(","u_camera_quat",",","Nc",",","No",")",";","Ow","=","dot","(","-","No",",","u_sun_direction",")","*","u_bloom_key",";","Ow","*=","max","(","sign","(","u_sun_direction",
".","y",")",",","0.0",")",";","gl_Position","=","vec4","(","4.0","*","(","a_position",".","xy","-","0.25",")",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/motion_blur.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_mb_tex_curr",";","uniform","sampler2D","u_mb_tex_accum",";","uniform","float","u_motion_blur_exp",";","uniform","float","u_motion_blur_decay_threshold",";","varying","vec2","bM",";","float",
"Nc","=","0.0042",";","void","main","(",")","{","vec4","Ng",",","Nh",",","Ni",",","Nj",";","Ng","=","texture2D","(","u_mb_tex_curr",",","bM",")",";","Nh","=","texture2D","(","u_mb_tex_accum",",","bM",")",";","if","(","length","(","Ng","-","Nh",")",">","u_motion_blur_decay_threshold",")","{","Ni","=","(","1.0","-","u_motion_blur_exp",")","*","Ng","+","u_motion_blur_exp","*","Nh",";","Ni","=","Ni","-","Nh",";","Nj","=","Ng","-","Nh",";","Ni","=","min","(","max","(","abs","(","Ni",")",",","vec4","(",
"Nc",")",")",",","abs","(","Nj",")",")","*","sign","(","Ni",")",";","gl_FragColor","=","Nh","+","Ni",";","}","else","{","gl_FragColor","=","Ng",";","}","}"]}]},exports["postprocessing/outline.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_outline_src",";","uniform","sampler2D","u_outline_mask",";","uniform","sampler2D","u_outline_mask_blurred",";","uniform","vec3","u_outline_color",
";","uniform","float","u_draw_outline",";","varying","vec2","bM",";","void","main","(",")","{","vec3","Nc",";","float","Ng",";","vec4","Nh",",","Ni",",","Nj",";","Nh","=","texture2D","(","u_outline_src",",","bM",")",";","gl_FragColor","=","Nh",";","if","(","u_draw_outline","!=","0.0",")","{","Ni","=","texture2D","(","u_outline_mask",",","bM",")",";","Nj","=","texture2D","(","u_outline_mask_blurred",",","bM",")",";","Ng","=","Nj",".","a","-","Ni",".","a",";","if","(","Ng","!=","0.0",")","{","Ng","=",
"smoothstep","(","0.0",",","1.0",",","Nj",".","a",")",";","if","(","Ni",".","a","==","0.0",")","{","Nc","=","u_outline_color",";","bu","(","Nc",")",";","Ni","=","vec4","(","clamp","(","Nc",",","0.0",",","1.0",")",",","1.0",")",";","gl_FragColor","=","mix","(","Nh",",","Ni",",","Ng",")",";","}","}","}","}"]}]},exports["postprocessing/performance.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_color",";","varying","vec2",
"bM",";","void","main","(",")","{","vec4","Nc",";","Nc","=","vec4","(","0.0",")",";","for","(","int","Ng","=","0",";","Ng","<","100",";","Ng","++",")","Nc","+=","0.001","*","texture2D","(","u_color",",","bM","+","vec2","(","0.001","*","vec2","(","Ng",")",")",")",";","gl_FragColor","=","Nc",";","}"]}]},exports["postprocessing/postprocessing.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"define",name:"POST_EFFECT_NONE",tokens:["1"]},{type:"define",name:"POST_EFFECT_GRAYSCALE",
tokens:["2"]},{type:"define",name:"POST_EFFECT_X_BLUR",tokens:["3"]},{type:"define",name:"POST_EFFECT_Y_BLUR",tokens:["4"]},{type:"define",name:"POST_EFFECT_X_EXTEND",tokens:["5"]},{type:"define",name:"POST_EFFECT_Y_EXTEND",tokens:["6"]},{type:"define",name:"FLIP_CUBEMAP_COORDS",tokens:["7"]},{type:"textline",tokens:["uniform","vec2","u_texel_size",";","uniform","sampler2D","u_color",";"]},{type:"condition",parts:[{type:"if",expression:["POST_EFFECT","FLIP_CUBEMAP_COORDS",{type:"equal_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["uniform","int","u_tex_number",";","uniform","vec2","u_delta",";"]}]}}]},{type:"textline",tokens:["varying","vec2","bM",";","void","main","(",")","{","float","Nc",",","Ng",",","Nh",",","Ni",";","vec2","Nj",",","Nk",";","vec4","Nl",";"]},{type:"condition",parts:[{type:"if",expression:["POST_EFFECT","POST_EFFECT_NONE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_color",",",
"bM",")",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_GRAYSCALE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nl","=","texture2D","(","u_color",",","bM",")",";","gl_FragColor",".","rgb","=","vec3","(","(","Nl",".","r","+","Nl",".","g","+","Nl",".","b",")","/","3.0",")",";","gl_FragColor",".","a","=","1.0",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_X_BLUR",{type:"equal_expr",places:2},"POST_EFFECT","POST_EFFECT_Y_BLUR",{type:"equal_expr",
places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nj","=","vec2","(","0.0",",","0.0",")",";","Nk","=","u_texel_size",";","Nl","=","texture2D","(","u_color",",","bM",")",";","gl_FragColor","=","Nl","*","0.2270270270",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","0.1945945946",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","0.1945945946",
";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","0.1216216216",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","0.1216216216",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","0.0540540541",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","0.0540540541",";","Nj","+=","Nk",";","Nl",
"=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","0.0162162162",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","0.0162162162",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_X_GLOW_BLUR",{type:"equal_expr",places:2},"POST_EFFECT","POST_EFFECT_Y_GLOW_BLUR",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nj","=","vec2","(","0.0",",","0.0",
")",";","Nk","=","u_texel_size",";","Nl","=","texture2D","(","u_color",",","bM",")",";","gl_FragColor","=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.152507",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.141763",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",
",","-","Nl",".","a",")",")","*","0.141763",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.113861",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.113861",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=",
"Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.079019",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.079019",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.047383",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",
";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.047383",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.024549",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.024549",";","Nj","+=","Nk",";","Nl","=","texture2D",
"(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.01099",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.01099",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.00425",";",
"Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.00425",";","Nj","+=","Nk",";","Nl","=","texture2D","(","u_color",",","bM","+","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",")","*","0.00142",";","Nl","=","texture2D","(","u_color",",","bM","-","Nj",")",";","gl_FragColor","+=","Nl","*","(","1.0","-","step","(","0.0",",","-","Nl",".","a",")",
")","*","0.00142",";","gl_FragColor","=","clamp","(","gl_FragColor",",","0.0",",","1.0",")",";"]}]}},{type:"elif",expression:["POST_EFFECT","POST_EFFECT_X_EXTEND",{type:"equal_expr",places:2},"POST_EFFECT","POST_EFFECT_Y_EXTEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nk","=","u_texel_size",";","Nl","=","texture2D","(","u_color",",","bM",")",";","gl_FragColor","=","Nl",";","if","(","Nl",".","a","==","0.0",")","{","Nl","=",
"texture2D","(","u_color",",","bM","+","Nk",")",";","if","(","Nl",".","a",">","0.0",")","gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","Nl",".","a",")",";","else","{","Nl","=","texture2D","(","u_color",",","bM","-","Nk",")",";","if","(","Nl",".","a",">","0.0",")","gl_FragColor","=","vec4","(","1.0",",","1.0",",","1.0",",","Nl",".","a",")",";","}","}"]}]}},{type:"elif",expression:["POST_EFFECT","FLIP_CUBEMAP_COORDS",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["Nc","=","u_delta","[","0","]",";","Ng","=","u_delta","[","1","]",";","Nh","=","1.0","/","3.0",";","Ni","=","0.5",";","Nk","=","vec2","(","Nh",",","Ni",")",";","if","(","u_tex_number","==","0",")","{","Nj","=","bM","*","Nk","+","vec2","(","2.0","*","Nh",",","0.0",")",";","Nj","[","0","]","=","min","(","Nj","[","0","]",",","1.0","-","Nc",")",";","Nj","[","1","]","=","min","(","Nj","[","1","]",",","0.5","-","Ng",")",";","gl_FragColor","=","texture2D","(","u_color",",","vec2","(","5.0","*","Nh",
"-","Nj","[","0","]",",","Nj","[","1","]",")",")",";","}","else","if","(","u_tex_number","==","1",")","{","Nj","=","bM","*","Nk",";","Nj","[","0","]","=","max","(","Nj","[","0","]",",","Nc",")",";","Nj","[","1","]","=","min","(","Nj","[","1","]",",","0.5","-","Ng",")",";","gl_FragColor","=","texture2D","(","u_color",",","vec2","(","Nh","-","Nj","[","0","]",",","Nj","[","1","]",")",")",";","}","else","if","(","u_tex_number","==","2",")","{","Nj","=","bM","*","Nk","+","vec2","(","Nh",",","Ni",")",";",
"Nj","[","0","]","=","max","(","Nj","[","0","]",",","Nh","+","Nc",")",";","Nj","[","0","]","=","min","(","Nj","[","0","]",",","2.0","*","Nh","-","Nc",")",";","Nj","[","1","]","=","min","(","Nj","[","1","]",",","1.0","-","Ng",")",";","gl_FragColor","=","texture2D","(","u_color",",","vec2","(","Nj","[","0","]",",","3.0","*","Ni","-","Nj","[","1","]",")",")",";","}","else","if","(","u_tex_number","==","3",")","{","Nj","=","bM","*","Nk","+","vec2","(","0.0",",","Ni",")",";","Nj","[","0","]","=","min",
"(","Nj","[","0","]",",","Nh","-","Nc",")",";","Nj","[","1","]","=","min","(","Nj","[","1","]",",","1.0","-","Ng",")",";","gl_FragColor","=","texture2D","(","u_color",",","vec2","(","Nj","[","0","]",",","3.0","*","Ni","-","Nj","[","1","]",")",")",";","}","else","if","(","u_tex_number","==","4",")","{","Nj","=","bM","*","Nk","+","vec2","(","Nh",",","0.0",")",";","Nj","[","0","]","=","max","(","Nj","[","0","]",",","Nh","+","Nc",")",";","Nj","[","0","]","=","min","(","Nj","[","0","]",",","2.0","*","Nh",
"-","Nc",")",";","Nj","[","1","]","=","min","(","Nj","[","1","]",",","0.5","-","Ng",")",";","gl_FragColor","=","texture2D","(","u_color",",","vec2","(","1.0","-","Nj","[","0","]",",","Nj","[","1","]",")",")",";","}","else","{","Nk","=","bM","*","Nk","+","vec2","(","2.0","*","Nh",",","Ni",")",";","Nk","[","0","]","=","min","(","Nk","[","0","]",",","1.0","-","Nc",")",";","Nk","[","1","]","=","max","(","Nk","[","1","]",",","0.5","+","Ng",")",";","gl_FragColor","=","texture2D","(","u_color",",","vec2",
"(","5.0","*","Nh","-","Nk","[","0","]",",","Nk","[","1","]",")",")",";","}"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/postprocessing.glslv"]={type:"group",parts:[{type:"textline",tokens:["attribute","vec2","a_position",";","varying","vec2","bM",";","void","main","(",")","{","bM","=","2.0","*","a_position",";","gl_Position","=","vec4","(","4.0","*","(","a_position",".","xy","-","0.25",")",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/smaa.glslf"]={type:"group",
parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"include",file:"pack.glslf"},{type:"define",name:"SMAA_RESOLVE",tokens:["1"]},{type:"define",name:"SMAA_EDGE_DETECTION",tokens:["2"]},{type:"define",name:"SMAA_BLENDING_WEIGHT_CALCULATION",tokens:["3"]},{type:"define",name:"SMAA_NEIGHBORHOOD_BLENDING",tokens:["4"]},{type:"define",name:"AA_METHOD_SMAA_LOW",tokens:["1"]},{type:"define",name:"AA_METHOD_SMAA_MEDIUM",tokens:["2"]},{type:"define",name:"AA_METHOD_SMAA_HIGH",
tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_ULTRA",tokens:["4"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_RESOLVE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_color_prev",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["uniform","sampler2D","u_blend",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_velocity_tex",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2},"SMAA_PREDICATION",{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_predication_tex",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_search_tex",";","uniform","sampler2D","u_area_tex",";","uniform","vec4","u_subsample_indices",";"]}]}}]},{type:"textline",tokens:["uniform","vec2","u_texel_size",";","varying","vec2","bM",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["varying","vec4","Ox",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","Oy",";","varying","vec4","Oz",";","varying","vec4","OA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","OB",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["AA_METHOD","AA_METHOD_SMAA_LOW",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.15"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_DISABLE_CORNER_DETECTION",tokens:["1"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_MEDIUM",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_DISABLE_CORNER_DETECTION",
tokens:["1"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_HIGH",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["0"]},{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["8"]},{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_ULTRA",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",
name:"SMAA_THRESHOLD",tokens:["0.05"]},{type:"define",name:"SMAA_DISABLE_DIAG_DETECTION",tokens:["0"]},{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["16"]},{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_THRESHOLD",group:{type:"group",parts:[{type:"define",name:"SMAA_THRESHOLD",tokens:["0.1"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_DEPTH_THRESHOLD",group:{type:"group",parts:[{type:"define",name:"SMAA_DEPTH_THRESHOLD",
tokens:["(","0.1","*","SMAA_THRESHOLD",")"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS_DIAG",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS_DIAG",tokens:["8"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_CORNER_ROUNDING",group:{type:"group",parts:[{type:"define",name:"SMAA_CORNER_ROUNDING",tokens:["25"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR",group:{type:"group",parts:[{type:"define",
name:"SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR",tokens:["2.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_THRESHOLD",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_THRESHOLD",tokens:["0.01"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_SCALE",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_SCALE",
tokens:["2.0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_PREDICATION_STRENGTH",group:{type:"group",parts:[{type:"define",name:"SMAA_PREDICATION_STRENGTH",tokens:["0.4"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_REPROJECTION",group:{type:"group",parts:[{type:"define",name:"SMAA_REPROJECTION",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_REPROJECTION_WEIGHT_SCALE",group:{type:"group",parts:[{type:"define",name:"SMAA_REPROJECTION_WEIGHT_SCALE",tokens:["30.0"]}]}}]},
{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}}]},{type:"define",name:"SMAA_AREATEX_MAX_DISTANCE",tokens:["16"]},{type:"define",name:"SMAA_AREATEX_MAX_DISTANCE_DIAG",tokens:["20"]},{type:"define",name:"SMAA_AREATEX_PIXEL_SIZE",tokens:["(","1.0","/","vec2","(","160.0",",","560.0",")",")"]},{type:"define",name:"SMAA_AREATEX_SUBTEX_SIZE",tokens:["(","1.0","/","7.0",")"]},{type:"define",name:"SMAA_SEARCHTEX_SIZE",
tokens:["vec2","(","66.0",",","33.0",")"]},{type:"define",name:"SMAA_SEARCHTEX_PACKED_SIZE",tokens:["vec2","(","64.0",",","16.0",")"]},{type:"define",name:"SMAA_CORNER_ROUNDING_NORM",tokens:["(","float","(","SMAA_CORNER_ROUNDING",")","/","100.0",")"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","OH","(","vec2","OC",",","sampler2D","OD",")","{","float","OE",",","OF",",","OG",
";","OE","=","texture2D","(","OD",",","OC",")",".","r",";","OF","=","texture2D","(","OD",",","Oy",".","xy",")",".","r",";","OG","=","texture2D","(","OD",",","Oy",".","zw",")",".","r",";","return","vec3","(","OE",",","OF",",","OG",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","OM","(","vec2","OI",",","sampler2D","OJ",")","{","vec2","OK",";","vec3","OL",";",
"OL","=","OH","(","OI",",","OJ",")",";","OK","=","abs","(","OL",".","xx","-","OL",".","yz",")",";","OK","=","step","(","SMAA_PREDICATION_THRESHOLD",",","OK",")",";","return","SMAA_PREDICATION_SCALE","*","SMAA_THRESHOLD","*","(","1.0","-","SMAA_PREDICATION_STRENGTH","*","OK",")",";","}"]}]}}]},{type:"textline",tokens:["void","OQ","(","bvec2","ON",",","inout","vec2","OO",",","vec2","OP",")","{","if","(","ON",".","x",")","OO",".","x","=","OP",".","x",";","if","(","ON",".","y",")","OO",".","y","=","OP",
".","y",";","}","void","OQ","(","bvec4","OR",",","inout","vec4","OS",",","vec4","OT",")","{","OQ","(","OR",".","xy",",","OS",".","xy",",","OT",".","xy",")",";","OQ","(","OR",".","zw",",","OS",".","zw",",","OT",".","zw",")",";","}","vec2","OV","(","vec2","OU",")","{","return","sign","(","OU",")","*","floor","(","abs","(","OU",")","+",".5",")",";","}","vec4","OV","(","vec4","OW",")","{","return","sign","(","OW",")","*","floor","(","abs","(","OW",")","+",".5",")",";","}"]},{type:"condition",parts:[{type:"if",
expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Pi","(","vec2","OX",",","sampler2D","OY"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","OZ"]}]}}]},{type:"textline",tokens:[")","{","vec4","O_",";","float","Pa",",","Pb",",","Pc",",","Pd",",","Pe",";","vec3","Pf",";","vec2","Pg",",","Ph",";"]},{type:"condition",parts:[{type:"if",
expression:["SMAA_PREDICATION"],group:{type:"group",parts:[{type:"textline",tokens:["Pg","=","OM","(","OX",",","OZ",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Pg","=","vec2","(","SMAA_THRESHOLD",",","SMAA_THRESHOLD",")",";"]}]}}]},{type:"textline",tokens:["Pf","=","vec3","(","0.2126",",","0.7152",",","0.0722",")",";","Pa","=","dot","(","texture2D","(","OY",",","OX",")",".","rgb",",","Pf",")",";","Pb","=","dot","(","texture2D","(","OY",",","Oy",".","xy",")",".",
"rgb",",","Pf",")",";","Pc","=","dot","(","texture2D","(","OY",",","Oy",".","zw",")",".","rgb",",","Pf",")",";","O_",".","xy","=","abs","(","Pa","-","vec2","(","Pb",",","Pc",")",")",";","Pg","=","step","(","Pg",",","O_",".","xy",")",";","if","(","dot","(","Pg",",","vec2","(","1.0",",","1.0",")",")","==","0.0",")","discard",";","Pd","=","dot","(","texture2D","(","OY",",","Oz",".","xy",")",".","rgb",",","Pf",")",";","Pe","=","dot","(","texture2D","(","OY",",","Oz",".","zw",")",".","rgb",",","Pf",")",
";","O_",".","zw","=","abs","(","Pa","-","vec2","(","Pd",",","Pe",")",")",";","Ph","=","max","(","O_",".","xy",",","O_",".","zw",")",";","Pe","=","dot","(","texture2D","(","OY",",","OA",".","xy",")",".","rgb",",","Pf",")",";","Pd","=","dot","(","texture2D","(","OY",",","OA",".","zw",")",".","rgb",",","Pf",")",";","O_",".","zw","=","abs","(","vec2","(","Pb",",","Pc",")","-","vec2","(","Pe",",","Pd",")",")",";","Ph","=","max","(","Ph",".","xy",",","O_",".","zw",")",";","Pd","=","max","(","Ph",".","x",
",","Ph",".","y",")",";","Pg",".","xy","*=","step","(","Pd",",","SMAA_LOCAL_CONTRAST_ADAPTATION_FACTOR","*","O_",".","xy",")",";","return","Pg",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_DIAG_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","Pk","(","vec2","Pj",")","{","Pj",".","r","=","Pj",".","r","*","abs","(","5.0","*","Pj",".","r","-","5.0","*","0.75",")",";","return","OV","(","Pj",")",";","}","vec4",
"Pk","(","vec4","Pl",")","{","Pl",".","rb","=","Pl",".","rb","*","abs","(","5.0","*","Pl",".","rb","-","5.0","*","0.75",")",";","return","OV","(","Pl",")",";","}","vec2","Pt","(","sampler2D","Pm",",","vec2","Pn",",","vec2","Po",",","out","vec2","Pp",")","{","vec3","Pq",";","vec4","Pr",";","Pr","=","vec4","(","Pn",",","-","1.0",",","1.0",")",";","Pq","=","vec3","(","u_texel_size",",","1.0",")",";","for","(","int","Ps","=","0",";","Ps","<","SMAA_MAX_SEARCH_STEPS_DIAG",";","Ps","++",")","{","if","(",
"Pr",".","z","<","float","(","SMAA_MAX_SEARCH_STEPS_DIAG","-","1",")","&&","Pr",".","w",">","0.9",")","{","Pr",".","xyz","+=","Pq","*","vec3","(","Po",",","1.0",")",";","Pp","=","texture2D","(","Pm",",","Pr",".","xy",",","0.0",")",".","rg",";","Pr",".","w","=","dot","(","Pp",",","vec2","(","0.5",",","0.5",")",")",";","}","}","return","Pr",".","zw",";","}","vec2","PB","(","sampler2D","Pu",",","vec2","Pv",",","vec2","Pw",",","out","vec2","Px",")","{","vec3","Py",";","vec4","Pz",";","Pz","=","vec4",
"(","Pv",",","-","1.0",",","1.0",")",";","Pz",".","x","+=","0.25","*","u_texel_size",".","x",";","Py","=","vec3","(","u_texel_size",",","1.0",")",";","for","(","int","PA","=","0",";","PA","<","SMAA_MAX_SEARCH_STEPS_DIAG",";","PA","++",")","{","if","(","Pz",".","z","<","float","(","SMAA_MAX_SEARCH_STEPS_DIAG","-","1",")","&&","Pz",".","w",">","0.9",")","{","Pz",".","xyz","=","Py","*","vec3","(","Pw",",","1.0",")","+","Pz",".","xyz",";","Px","=","texture2D","(","Pu",",","Pz",".","xy",",","0.0",")",
".","rg",";","Px","=","Pk","(","Px",")",";","Pz",".","w","=","dot","(","Px",",","vec2","(","0.5",",","0.5",")",")",";","}","}","return","Pz",".","zw",";","}","vec2","PH","(","sampler2D","PC",",","vec2","PD",",","vec2","PE",",","float","PF",")","{","vec2","PG",";","PG","=","vec2","(","SMAA_AREATEX_MAX_DISTANCE_DIAG",",","SMAA_AREATEX_MAX_DISTANCE_DIAG",")","*","PE","+","PD",";","PG","=","SMAA_AREATEX_PIXEL_SIZE","*","PG","+","0.5","*","SMAA_AREATEX_PIXEL_SIZE",";","PG",".","x","+=","0.5",";","PG",
".","y","+=","SMAA_AREATEX_SUBTEX_SIZE","*","PF",";","return","texture2D","(","PC",",","PG",",","0.0",")",".","rg",";","}","vec2","PT","(","sampler2D","PI",",","sampler2D","PJ",",","vec2","PK",",","vec2","PL",",","vec4","PM",")","{","vec4","PN",",","PO",",","PP",";","vec2","PQ",",","PR",",","PS",";","PQ","=","vec2","(","0.0",",","0.0",")",";","if","(","PL",".","r",">","0.0",")","{","PN",".","xz","=","Pt","(","PI",",","PK",",","vec2","(","-","1.0",",","1.0",")",",","PR",")",";","PN",".","x","+=","float",
"(","PR",".","y",">","0.9",")",";","}","else","PN",".","xz","=","vec2","(","0.0",",","0.0",")",";","PN",".","yw","=","Pt","(","PI",",","PK",",","vec2","(","1.0",",","-","1.0",")",",","PR",")",";","if","(","PN",".","x","+","PN",".","y",">","2.0",")","{","PO","=","vec4","(","-","PN",".","x","+","0.25",",","PN",".","x",",","PN",".","y",",","-","PN",".","y","-","0.25",")","*","u_texel_size",".","xyxy","+","PK",".","xyxy",";","PP",".","xy","=","texture2D","(","PI",",","PO",".","xy","+","u_texel_size",
"*","vec2","(","-","1",",","0",")",",","0.0",")",".","rg",";","PP",".","zw","=","texture2D","(","PI",",","PO",".","zw","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","rg",";","PP",".","yxwz","=","Pk","(","PP",".","xyzw",")",";","PS","=","vec2","(","2.0",",","2.0",")","*","PP",".","xz","+","PP",".","yw",";","OQ","(","bvec2","(","step","(","0.9",",","PN",".","zw",")",")",",","PS",",","vec2","(","0.0",",","0.0",")",")",";","PQ","+=","PH","(","PJ",",","PN",".","xy",",","PS",",","PM",
".","z",")",";","}","PN",".","xz","=","PB","(","PI",",","PK",",","vec2","(","-","1",",","-","1",")",",","PR",")",";","if","(","texture2D","(","PI",",","PK","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","r",">","0.0",")","{","PN",".","yw","=","PB","(","PI",",","PK",",","vec2","(","1",",","1",")",",","PR",")",";","PN",".","y","+=","float","(","PR",".","y",">","0.9",")",";","}","else","PN",".","yw","=","vec2","(","0.0",",","0.0",")",";","if","(","PN",".","x","+","PN",".","y",">",
"2.0",")","{","PP","=","vec4","(","-","PN",".","x",",","-","PN",".","x",",","PN",".","y",",","PN",".","y",")","*","u_texel_size",".","xyxy","+","PK",".","xyxy",";","PO",".","x","=","texture2D","(","PI",",","PP",".","xy","+","u_texel_size","*","vec2","(","-","1",",","0",")",",","0.0",")",".","g",";","PO",".","y","=","texture2D","(","PI",",","PP",".","xy","+","u_texel_size","*","vec2","(","0",",","-","1",")",",","0.0",")",".","r",";","PO",".","zw","=","texture2D","(","PI",",","PP",".","zw","+","u_texel_size",
"*","vec2","(","1",",","0",")",",","0.0",")",".","gr",";","PR","=","vec2","(","2.0",",","2.0",")","*","PO",".","xz","+","PO",".","yw",";","OQ","(","bvec2","(","step","(","0.9",",","PN",".","zw",")",")",",","PR",",","vec2","(","0",",","0",")",")",";","PQ","+=","PH","(","PJ",",","PN",".","xy",",","PR",",","PM",".","w",")",".","gr",";","}","return","PQ",";","}"]}]}}]},{type:"textline",tokens:["float","PZ","(","sampler2D","PU",",","vec2","PV",",","float","PW",")","{","vec2","PX",",","PY",";","PX","=",
"SMAA_SEARCHTEX_SIZE","*","vec2","(","0.5",",","-","1.0",")",";","PY","=","SMAA_SEARCHTEX_SIZE","*","vec2","(","PW",",","1.0",")",";","PX","+=","vec2","(","-","1.0",",","1.0",")",";","PY","+=","vec2","(","0.5",",","-","0.5",")",";","PX","*=","1.0","/","SMAA_SEARCHTEX_PACKED_SIZE",";","PY","*=","1.0","/","SMAA_SEARCHTEX_PACKED_SIZE",";","return","texture2D","(","PU",",","PX","*","PV","+","PY",",","0.0",")",".","r",";","}","float","Qg","(","sampler2D","P_",",","sampler2D","Qa",",","vec2","Qb",",","float",
"Qc",")","{","float","Qd",";","vec2","Qe",";","Qe","=","vec2","(","0.0",",","1.0",")",";","for","(","int","Qf","=","0",";","Qf","<","SMAA_MAX_SEARCH_STEPS",";","Qf","++",")","{","if","(","Qb",".","x",">","Qc","&&","Qe",".","g",">","0.8281","&&","Qe",".","r","==","0.0",")","{","Qe","=","texture2D","(","P_",",","Qb",",","0.0",")",".","rg",";","Qb","=","-","vec2","(","2.0",",","0.0",")","*","u_texel_size","+","Qb",";","}","}","Qd","=","-","(","255.0","/","127.0",")","*","PZ","(","Qa",",","Qe",",","0.0",
")","+","3.25",";","return","u_texel_size",".","x","*","Qd","+","Qb",".","x",";","}","float","Qo","(","sampler2D","Qh",",","sampler2D","Qi",",","vec2","Qj",",","float","Qk",")","{","float","Ql",";","vec2","Qm",";","Qm","=","vec2","(","0.0",",","1.0",")",";","for","(","int","Qn","=","0",";","Qn","<","SMAA_MAX_SEARCH_STEPS",";","Qn","++",")","{","if","(","Qj",".","x","<","Qk","&&","Qm",".","g",">","0.8281","&&","Qm",".","r","==","0.0",")","{","Qm","=","texture2D","(","Qh",",","Qj",",","0.0",")",".",
"rg",";","Qj","=","vec2","(","2.0",",","0.0",")","*","u_texel_size","+","Qj",";","}","}","Ql","=","-","(","255.0","/","127.0",")","*","PZ","(","Qi",",","Qm",",","0.5",")","+","3.25",";","return","-","u_texel_size",".","x","*","Ql","+","Qj",".","x",";","}","float","Qw","(","sampler2D","Qp",",","sampler2D","Qq",",","vec2","Qr",",","float","Qs",")","{","float","Qt",";","vec2","Qu",";","Qu","=","vec2","(","1.0",",","0.0",")",";","for","(","int","Qv","=","0",";","Qv","<","SMAA_MAX_SEARCH_STEPS",";","Qv",
"++",")","{","if","(","Qr",".","y",">","Qs","&&","Qu",".","r",">","0.8281","&&","Qu",".","g","==","0.0",")","{","Qu","=","texture2D","(","Qp",",","Qr",",","0.0",")",".","rg",";","Qr","=","-","vec2","(","0.0",",","2.0",")","*","u_texel_size","+","Qr",";","}","}","Qt","=","-","(","255.0","/","127.0",")","*","PZ","(","Qq",",","Qu",".","gr",",","0.0",")","+","3.25",";","return","u_texel_size",".","y","*","Qt","+","Qr",".","y",";","}","float","QE","(","sampler2D","Qx",",","sampler2D","Qy",",","vec2","Qz",
",","float","QA",")","{","float","QB",";","vec2","QC",";","QC","=","vec2","(","1.0",",","0.0",")",";","for","(","int","QD","=","0",";","QD","<","SMAA_MAX_SEARCH_STEPS",";","QD","++",")","{","if","(","Qz",".","y","<","QA","&&","QC",".","r",">","0.8281","&&","QC",".","g","==","0.0",")","{","QC","=","texture2D","(","Qx",",","Qz",",","0.0",")",".","rg",";","Qz","=","vec2","(","0.0",",","2.0",")","*","u_texel_size","+","Qz",";","}","}","QB","=","-","(","255.0","/","127.0",")","*","PZ","(","Qy",",","QC",
".","gr",",","0.5",")","+","3.25",";","return","-","u_texel_size",".","y","*","QB","+","Qz",".","y",";","}","vec2","QL","(","sampler2D","QF",",","vec2","QG",",","float","QH",",","float","QI",",","float","QJ",")","{","vec2","QK",";","QK","=","vec2","(","SMAA_AREATEX_MAX_DISTANCE",",","SMAA_AREATEX_MAX_DISTANCE",")","*","OV","(","4.0","*","vec2","(","QH",",","QI",")",")","+","QG",";","QK","=","SMAA_AREATEX_PIXEL_SIZE","*","QK","+","0.5","*","SMAA_AREATEX_PIXEL_SIZE",";","QK",".","y","=","SMAA_AREATEX_SUBTEX_SIZE",
"*","QJ","+","QK",".","y",";","return","texture2D","(","QF",",","QK",",","0.0",")",".","rg",";","}","void","QS","(","sampler2D","QM",",","inout","vec2","QN",",","vec4","QO",",","vec2","QP",")","{","vec2","QQ",",","QR",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_CORNER_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["QQ","=","step","(","QP",".","xy",",","QP",".","yx",")",";","QR","=","(","1.0","-","SMAA_CORNER_ROUNDING_NORM",
")","*","QQ",";","QR","/=","QQ",".","x","+","QQ",".","y",";","QQ","=","vec2","(","1.0",",","1.0",")",";","QQ",".","x","-=","QR",".","x","*","texture2D","(","QM",",","QO",".","xy","+","u_texel_size","*","vec2","(","0",",","1",")",",","0.0",")",".","r",";","QQ",".","x","-=","QR",".","y","*","texture2D","(","QM",",","QO",".","zw","+","u_texel_size","*","vec2","(","1",",","1",")",",","0.0",")",".","r",";","QQ",".","y","-=","QR",".","x","*","texture2D","(","QM",",","QO",".","xy","+","u_texel_size","*",
"vec2","(","0",",","-","2",")",",","0.0",")",".","r",";","QQ",".","y","-=","QR",".","y","*","texture2D","(","QM",",","QO",".","zw","+","u_texel_size","*","vec2","(","1",",","-","2",")",",","0.0",")",".","r",";","QN","*=","clamp","(","QQ",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}","void","QZ","(","sampler2D","QT",",","inout","vec2","QU",",","vec4","QV",",","vec2","QW",")","{","vec2","QX",",","QY",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_CORNER_DETECTION",
{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["QX","=","step","(","QW",".","xy",",","QW",".","yx",")",";","QY","=","(","1.0","-","SMAA_CORNER_ROUNDING_NORM",")","*","QX",";","QY","/=","QX",".","x","+","QX",".","y",";","QX","=","vec2","(","1.0",",","1.0",")",";","QX",".","x","-=","QY",".","x","*","texture2D","(","QT",",","QV",".","xy","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","g",";","QX",".","x","-=","QY",".","y","*","texture2D",
"(","QT",",","QV",".","zw","+","u_texel_size","*","vec2","(","1",",","1",")",",","0.0",")",".","g",";","QX",".","y","-=","QY",".","x","*","texture2D","(","QT",",","QV",".","xy","+","u_texel_size","*","vec2","(","-","2",",","0",")",",","0.0",")",".","g",";","QX",".","y","-=","QY",".","y","*","texture2D","(","QT",",","QV",".","zw","+","u_texel_size","*","vec2","(","-","2",",","1",")",",","0.0",")",".","g",";","QU","*=","clamp","(","QX",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]},
{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Rm","(","vec2","Q_",",","vec2","Ra",",","sampler2D","Rb",",","sampler2D","Rc",",","sampler2D","Rd",",","vec4","Re",")","{","float","Rf",",","Rg",";","vec3","Rh",";","vec2","Ri",",","Rj",",","Rk",";","vec4","Rl",";","Rl","=","vec4","(","0.0",",","0.0",",","0.0",",","0.0",")",";","Ri","=","texture2D","(","Rb",",","Q_",
")",".","rg",";","if","(","Ri",".","g",">","0.0",")","{"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_DIAG_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["Rl",".","rg","=","PT","(","Rb",",","Rc",",","Q_",",","Ri",",","Re",")",";","if","(","Rl",".","r","==","-","Rl",".","g",")","{"]}]}}]},{type:"textline",tokens:[";","Rh",".","x","=","Qg","(","Rb",",","Rd",",","Oy",".","xy",",","OA",".","x",")",";","Rh",".","y","=","Oz",".",
"y",";","Rj",".","x","=","Rh",".","x",";","Rf","=","texture2D","(","Rb",",","Rh",".","xy",",","0.0",")",".","r",";","Rh",".","z","=","Qo","(","Rb",",","Rd",",","Oy",".","zw",",","OA",".","y",")",";","Rj",".","y","=","Rh",".","z",";","Rj","=","abs","(","OV","(","Rj","/","u_texel_size",".","xx","-","Ra",".","xx",")",")",";","Rk","=","sqrt","(","Rj",")",";","Rg","=","texture2D","(","Rb",",","Rh",".","zy","+","u_texel_size","*","vec2","(","1",",","0",")",",","0.0",")",".","r",";","Rl",".","rg","=","QL",
"(","Rc",",","Rk",",","Rf",",","Rg",",","Re",".","y",")",";","Rh",".","y","=","Q_",".","y",";","QS","(","Rb",",","Rl",".","rg",",","Rh",".","xyzy",",","Rj",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_DISABLE_DIAG_DETECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["}","else","Ri",".","r","=","0.0",";"]}]}}]},{type:"textline",tokens:["}","if","(","Ri",".","r",">","0.0",")","{",";","Rh",".","y","=","Qw","(","Rb",",","Rd",",","Oz",
".","xy",",","OA",".","z",")",";","Rh",".","x","=","Oy",".","x",";","Ri",".","x","=","Rh",".","y",";","Rg","=","texture2D","(","Rb",",","Rh",".","xy",",","0.0",")",".","g",";","Rh",".","z","=","QE","(","Rb",",","Rd",",","Oz",".","zw",",","OA",".","w",")",";","Ri",".","y","=","Rh",".","z",";","Ri","=","abs","(","OV","(","Ri","/","u_texel_size",".","yy","-","Ra",".","yy",")",")",";","Rj","=","sqrt","(","Ri",")",";","Rf","=","texture2D","(","Rb",",","Rh",".","xz","+","u_texel_size","*","vec2","(","0",
",","1",")",",","0.0",")",".","g",";","Rl",".","ba","=","QL","(","Rc",",","Rj",",","Rg",",","Rf",",","Re",".","x",")",";","Rh",".","x","=","Q_",".","x",";","QZ","(","Rb",",","Rl",".","ba",",","Rh",".","xyxz",",","Ri",")",";","}","return","Rl",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","Ry","(","vec2","Rn",",","sampler2D","Ro",",","sampler2D","Rp"]},
{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","Rq"]}]}}]},{type:"textline",tokens:[")","{","bool","Rr",";","vec2","Rs",",","Rt",",","Ru",";","vec4","Rv",",","Rw",",","Rx",";","Rv",".","x","=","texture2D","(","Rp",",","Ox",".","xy",")",".","a",";","Rv",".","y","=","texture2D","(","Rp",",","Ox",".","zw",")",".","g",";","Rv",".","wz","=","texture2D","(","Rp",",","Rn",")",".","xz",";","if","(","dot","(","Rv",",",
"vec4","(","1.0",",","1.0",",","1.0",",","1.0",")",")","<","1e-5",")","{","Rw","=","texture2D","(","Ro",",","Rn",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["Rx","=","texture2D","(","Rq",",","bM",")",";","Rs","=","2.0","*","ag","(","Rx",")","-","1.0",";","Rw",".","a","=","sqrt","(","2.0","*","length","(","Rs",")",")",";"]}]}}]},{type:"textline",tokens:["return","Rw",";","}","else","{","Rr","=","max","(",
"Rv",".","x",",","Rv",".","z",")",">","max","(","Rv",".","y",",","Rv",".","w",")",";","Rw","=","vec4","(","0.0",",","Rv",".","y",",","0.0",",","Rv",".","w",")",";","Rs","=","Rv",".","yw",";","OQ","(","bvec4","(","Rr",",","Rr",",","Rr",",","Rr",")",",","Rw",",","vec4","(","Rv",".","x",",","0.0",",","Rv",".","z",",","0.0",")",")",";","OQ","(","bvec2","(","Rr",",","Rr",")",",","Rs",",","Rv",".","xz",")",";","Rs","/=","dot","(","Rs",",","vec2","(","1.0",",","1.0",")",")",";","Rw","=","Rw","*","vec4",
"(","u_texel_size",",","-","u_texel_size",")","+","Rn",".","xyxy",";","Rv","=","Rs",".","x","*","texture2D","(","Ro",",","Rw",".","xy",",","0.0",")",";","Rv","+=","Rs",".","y","*","texture2D","(","Ro",",","Rw",".","zw",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["Rx","=","texture2D","(","Rq",",","Rw",".","xy",")",";","Rt","=","2.0","*","ag","(","Rx",")","-","1.0",";","Ru","=","Rs",".","x","*","Rt",";",
"Rx","=","texture2D","(","Rq",",","Rw",".","zw",")",";","Rt","=","2.0","*","ag","(","Rx",")","-","1.0",";","Ru","+=","Rs",".","y","*","Rt",";","Rv",".","a","=","sqrt","(","2.0","*","length","(","Ru",")",")",";"]}]}}]},{type:"textline",tokens:["return","Rv",";","}","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_RESOLVE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","RI","(","vec2","Rz",",","sampler2D","RA",",","sampler2D","RB"]},
{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","sampler2D","RC"]}]}}]},{type:"textline",tokens:[")","{","float","RD",";","vec2","RE",";","vec4","RF",",","RG",",","RH",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:["RF","=","texture2D","(","RC",",","bM",")",";","RE","=","2.0","*","ag","(","RF",")","-","1.0",";","RF","=","texture2D","(","RA",",",
"Rz",")",";","RG","=","texture2D","(","RB",",","Rz","-","RE",")",";","RD","=","abs","(","RF",".","a","*","RF",".","a","-","RG",".","a","*","RG",".","a",")","/","2.0",";","RD","=","0.5","*","clamp","(","1.0","-","sqrt","(","RD",")","*","SMAA_REPROJECTION_WEIGHT_SCALE",",","0.0",",","1.0",")",";","RH","=","mix","(","RF",",","RG",",","RD",")",";","RH",".","a","=","1.0",";","return","RH",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["RF","=","texture2D","(","RA",",","Rz",")",
";","RG","=","texture2D","(","RB",",","Rz",")",";","return","mix","(","RF",",","RG",",","0.5",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec4","RJ",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["RJ","=","vec4","(","Pi","(","bM",",","u_color"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PREDICATION"],group:{type:"group",
parts:[{type:"textline",tokens:[",","u_predication_tex"]}]}}]},{type:"textline",tokens:[")",",","0.0",",","0.0",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["RJ","=","Rm","(","bM",",","OB",",","u_color",",","u_area_tex",",","u_search_tex",",","u_subsample_indices",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["RJ","=","Ry","(","bM",",","u_color",",","u_blend"]},{type:"condition",parts:[{type:"if",expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_velocity_tex"]}]}}]},{type:"textline",tokens:[")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_RESOLVE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["RJ","=","vec4","(","RI","(","bM",",","u_color",",","u_color_prev"]},{type:"condition",parts:[{type:"if",
expression:["SMAA_REPROJECTION"],group:{type:"group",parts:[{type:"textline",tokens:[",","u_velocity_tex"]}]}}]},{type:"textline",tokens:[")",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["RJ","=","texture2D","(","u_color",",","bM",")",";"]}]}}]},{type:"textline",tokens:["gl_FragColor","=","RJ",";","}"]}]},exports["postprocessing/smaa.glslv"]={type:"group",parts:[{type:"define",name:"SMAA_EDGE_DETECTION",tokens:["1"]},{type:"define",name:"SMAA_BLENDING_WEIGHT_CALCULATION",
tokens:["2"]},{type:"define",name:"SMAA_NEIGHBORHOOD_BLENDING",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_LOW",tokens:["1"]},{type:"define",name:"AA_METHOD_SMAA_MEDIUM",tokens:["2"]},{type:"define",name:"AA_METHOD_SMAA_HIGH",tokens:["3"]},{type:"define",name:"AA_METHOD_SMAA_ULTRA",tokens:["4"]},{type:"textline",tokens:["attribute","vec2","a_position",";","uniform","vec2","u_texel_size",";","varying","vec2","bM",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",
{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","Ox",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["varying","vec4","Oy",";","varying","vec4","Oz",";","varying","vec4","OA",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec2","OB",";"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["AA_METHOD","AA_METHOD_SMAA_LOW",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["4"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_MEDIUM",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["8"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_HIGH",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",
tokens:["16"]}]}},{type:"elif",expression:["AA_METHOD","AA_METHOD_SMAA_ULTRA",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["32"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"SMAA_MAX_SEARCH_STEPS",group:{type:"group",parts:[{type:"define",name:"SMAA_MAX_SEARCH_STEPS",tokens:["16"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["void","Ng","(","vec2","Nc",")","{","Oy","=","u_texel_size",".","xyxy","*","vec4","(","-","1.0",",","0.0",",","0.0",",","-","1.0",")","+","Nc",".","xyxy",";","Oz","=","u_texel_size",".","xyxy","*","vec4","(","1.0",",","0.0",",","0.0",",","1.0",")","+","Nc",".","xyxy",";","OA","=","u_texel_size",".","xyxy","*","vec4","(","-","2.0",",","0.0",",","0.0",",","-","2.0",")","+","Nc",".","xyxy",";","}"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","Nj","(","vec2","Nh",",","out","vec2","Ni",")","{","Ni","=","Nh","/","u_texel_size",";","Oy","=","u_texel_size",".","xyxy","*","vec4","(","-","0.25",",","-","0.125",",","1.25",",","-","0.125",")","+","Nh",".","xyxy",";","Oz","=","u_texel_size",".","xyxy","*","vec4","(","-","0.125",",","-","0.25",",","-","0.125",",","1.25",")","+","Nh",".","xyxy",";","OA","=","u_texel_size",".","xxyy","*","vec4","(","-","2.0",",","2.0",",","-","2.0",
",","2.0",")","*","float","(","SMAA_MAX_SEARCH_STEPS",")","+","vec4","(","Oy",".","xz",",","Oz",".","yw",")",";","}"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","Nl","(","vec2","Nk",")","{","Ox","=","u_texel_size",".","xyxy","*","vec4","(","1.0",",","0.0",",","0.0",",","1.0",")","+","Nk",".","xyxy",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","bM","=","2.0","*",
"a_position",";"]},{type:"condition",parts:[{type:"if",expression:["SMAA_PASS","SMAA_EDGE_DETECTION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ng","(","bM",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_BLENDING_WEIGHT_CALCULATION",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Nj","(","bM",",","OB",")",";"]}]}},{type:"elif",expression:["SMAA_PASS","SMAA_NEIGHBORHOOD_BLENDING",{type:"equal_expr",places:2}],group:{type:"group",
parts:[{type:"textline",tokens:["Nl","(","bM",")",";"]}]}}]},{type:"textline",tokens:["gl_Position","=","vec4","(","4.0","*","(","a_position",".","xy","-","0.25",")",",","0.0",",","1.0",")",";","}"]}]},exports["postprocessing/ssao.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},{type:"include",file:"depth_fetch.glslf"},{type:"include",file:"procedural.glslf"},
{type:"define",name:"SSAO_QUALITY_8",tokens:["1"]},{type:"define",name:"SSAO_QUALITY_16",tokens:["2"]},{type:"define",name:"SSAO_QUALITY_24",tokens:["3"]},{type:"define",name:"SSAO_QUALITY_32",tokens:["4"]},{type:"textline",tokens:["uniform","sampler2D","u_color",";","uniform","sampler2D","u_depth",";","uniform","sampler2D","u_ssao_special_tex",";","uniform","vec2","u_camera_range",";","uniform","vec2","u_texel_size",";","varying","vec2","bM",";","uniform","float","u_ssao_radius_increase",";","uniform",
"float","u_ssao_influence",";","uniform","float","u_ssao_dist_factor",";","float","Ng","(","in","vec2","Nc",")","{","return","Os","(","u_depth",",","Nc",",","u_camera_range",")",";","}","void","main","(",")","{","float","Nh",",","Ni",",","Nj",",","Nk",",","Nl",",","Nm",";","vec3","Nn",",","No",",","Np",",","Nq",";","Nn","=","texture2D","(","u_color",",","bM",")",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_WHITE"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor",
"=","vec4","(","Nn",",","1.0",")",";","return",";"]}]}}]},{type:"textline",tokens:["No","=","normalize","(","2.0","*","texture2D","(","u_ssao_special_tex",",","bM","*","0.25","/","u_texel_size",")",".","rgb","-","1.0",")",";","Nh","=","Ng","(","bM",")",";","Ni","=","Nh","*","(","u_camera_range",".","y","-","u_camera_range",".","x",")",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_QUALITY","SSAO_QUALITY_8",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const",
"float","Nr","=","8.0",";","const","int","Ns","=","1",";"]}]}},{type:"elif",expression:["SSAO_QUALITY","SSAO_QUALITY_16",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","Nr","=","16.0",";","const","int","Ns","=","2",";"]}]}},{type:"elif",expression:["SSAO_QUALITY","SSAO_QUALITY_24",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","Nr","=","24.0",";","const","int","Ns","=","3",";"]}]}},{type:"elif",expression:["SSAO_QUALITY",
"SSAO_QUALITY_32",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","float","Nr","=","32.0",";","const","int","Ns","=","4",";"]}]}}]},{type:"textline",tokens:["Nj","=","u_ssao_radius_increase","*","0.001",";","const","float","Nt","=","1.0","+","2.4","/","Nr",";","Nk","=","0.0",";","for","(","int","Nu","=","0",";","Nu","<","Ns",";","Nu","++",")","for","(","int","Nv","=","-","1",";","Nv","<=","1",";","Nv","+=","2",")","for","(","int","OC","=","-","1",";","OC",
"<=","1",";","OC","+=","2",")","for","(","int","OD","=","-","1",";","OD","<=","1",";","OD","+=","2",")","{","Np","=","reflect","(","normalize","(","vec3","(","Nv",",","OC",",","OD",")",")",",","No",")","*","(","Nj","*=","Nt",")",";","Nq","=","vec3","(","bM",",","Ni",")",";","Nq","+=","vec3","(","Np",".","xy",",","Np",".","z","*","Ni","*","2.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_HEMISPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["Nq",".","z","-=","1.4","*",
"(","Nq",".","z","-","Ni",")","*","step","(","Ni",",","Nq",".","z",")",";"]}]}}]},{type:"textline",tokens:["Nl","=","Ng","(","Nq",".","xy",")","*","(","u_camera_range",".","y","-","u_camera_range",".","x",")",";","Nm","=","clamp","(","(","Ni","-","Nl",")","/","Nl",",","0.0",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_HEMISPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["Nk","+=","mix","(","1.0",",","Nm",",","step","(","Nl",",","Nq",".","z",")",")",";"]}]}},
{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nk","+=","mix","(","step","(","Nq",".","z",",","Nl",")",",","0.5",",","Nm",")",";"]}]}}]},{type:"textline",tokens:["}","Nk","=","Nk","/","Nr",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_HEMISPHERE"],group:{type:"group",parts:[{type:"textline",tokens:["Nk","=","clamp","(","Nk","*","Nk","+","0.6","*","Nk",",","0.0",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nk","=","clamp",
"(","Nk","*","Nk","+","Nk",",","0.0",",","1.0",")",";"]}]}}]},{type:"textline",tokens:["Nh","=","u_ssao_influence","*","(","1.0","-","u_ssao_dist_factor","*","Nh",")",";","Nk","=","mix","(","1.0",",","Nk",",","Nh",")",";","gl_FragColor","=","vec4","(","Nn",",","Nk",")",";","}"]}]},exports["postprocessing/ssao_blur.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","sampler2D",";"]},{type:"include",file:"precision_statement.glslf"},
{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"include",file:"depth_fetch.glslf"}]}}]},{type:"textline",tokens:["uniform","sampler2D","u_ssao_mask",";","uniform","vec2","u_texel_size",";","varying","vec2","bM",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","vec2","u_camera_range",";","uniform","float","u_ssao_blur_discard_value",
";","float","Ng","(","in","vec2","Nc",")","{","return","Os","(","u_depth",",","Nc",",","u_camera_range",")",";","}"]}]}}]},{type:"textline",tokens:["void","main","(",")","{","vec2","Nh",",","Ni",";","float","Nj",",","Nk",",","Nl",",","Nm",",","Nn",",","No",",","Np",";","Nj","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["Nk","=","Ng","(","bM",")",";","Nl","=","0.0",";","Nm","=","u_ssao_blur_discard_value","*",
"100.0",";"]}]}}]},{type:"textline",tokens:["Nh","=","vec2","(","-","2.0",")",";","for","(","int","Nq","=","0",";","Nq","<","4",";","++","Nq",")","{","for","(","int","Nr","=","0",";","Nr","<","4",";","++","Nr",")","{","Ni","=","(","Nh","+","vec2","(","float","(","Nq",")",",","float","(","Nr",")",")",")","*","u_texel_size",";","Nn","=","texture2D","(","u_ssao_mask",",","bM","+","Ni",")",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",
tokens:["No","=","Ng","(","bM","+","Ni",")",";","Np","=","1.0","-","clamp","(","abs","(","No","-","Nk",")","*","Nm",",","0.0",",","1.0",")",";","Nj","+=","Nn","*","Np",";","Nl","+=","Np",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nj","+=","Nn",";"]}]}}]},{type:"textline",tokens:["}","}"]},{type:"condition",parts:[{type:"if",expression:["SSAO_BLUR_DEPTH"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","texture2D","(","u_ssao_mask",
",","bM",")",".","rgb",",","Nj","/","Nl",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","vec4","(","texture2D","(","u_ssao_mask",",","bM",")",".","rgb",",","Nj","/","16.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/stereo.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",file:"color_util.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_sampler_left",";","uniform","sampler2D",
"u_sampler_right",";","varying","vec2","bM",";"]},{type:"condition",parts:[{type:"if",expression:["ANAGLYPH",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","int","u_enable_hmd_stereo",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_DISTORTION_CORRECTION",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["uniform","vec4","u_distortion_params",";","uniform","vec4","u_chromatic_aberration_coefs",
";","void","Np","(","vec2","Nc",",","vec2","Ng",",","float","Nh",",","sampler2D","Ni",")","{","vec4","Nj",";","float","Nk",";","vec2","Nl",",","Nm",",","Nn",",","No",";","Nl","=","(","Nc","-","Ng",")","*","2.0",";","Nl","/=","Nh",";","Nk","=","Nl",".","x","*","Nl",".","x","+","Nl",".","y","*","Nl",".","y",";","Nl","=","Nl","*","(","1.0","+","u_distortion_params","[","0","]","*","Nk","+","u_distortion_params","[","1","]","*","Nk","*","Nk",")",";","Nl","=","Nl","*","0.5","/","(","1.0","+","u_distortion_params",
"[","0","]","+","u_distortion_params","[","1","]",")",";","if","(","length","(","u_chromatic_aberration_coefs",")",">","0.0",")","{","Nm","=","Nl","*","(","1.0","+","u_chromatic_aberration_coefs","[","0","]","+","Nk","*","u_chromatic_aberration_coefs","[","1","]",")","+","Ng",";","Nn","=","Nl","+","Ng",";","No","=","Nl","*","(","1.0","+","u_chromatic_aberration_coefs","[","2","]","+","Nk","*","u_chromatic_aberration_coefs","[","3","]",")","+","Ng",";","if","(","clamp","(","No",",","0.0",",","1.0",
")","!=","No",")","{","gl_FragColor","=","vec4","(","0.0",")",";","}","else","{","Nj","=","texture2D","(","Ni",",","Nn",")",";","gl_FragColor","[","0","]","=","texture2D","(","Ni",",","Nm",")",".","x",";","gl_FragColor","[","1","]","=","Nj",".","y",";","gl_FragColor","[","2","]","=","texture2D","(","Ni",",","No",")",".","z",";","gl_FragColor","[","3","]","=","Nj",".","w",";","}","}","else","{","Nl","=","Nl","*","Nh","+","Ng",";","if","(","clamp","(","Nl",",","0.0",",","1.0",")","!=","Nl",")","{",
"gl_FragColor","=","vec4","(","0.0",")",";","}","else","{","gl_FragColor","=","texture2D","(","Ni",",","Nl",")",";","}","}","}"]}]}}]}]}}]},{type:"textline",tokens:["void","main","(",")","{","float","Nq",";","vec2","Nr",",","Ns",";","mat3","Nt",",","Nu",";","vec3","Nv",",","OC",";","vec4","OD",",","OE",";"]},{type:"condition",parts:[{type:"if",expression:["ANAGLYPH"],group:{type:"group",parts:[{type:"textline",tokens:["OD","=","texture2D","(","u_sampler_left",",","bM",")",";","OE","=","texture2D",
"(","u_sampler_right",",","bM",")",";","Nv","=","vec3","(","OD","[","0","]",",","OD","[","1","]",",","OD","[","2","]",")",";","br","(","Nv",")",";","OC","=","vec3","(","OE","[","0","]",",","OE","[","1","]",",","OE","[","2","]",")",";","br","(","OC",")",";","Nt","=","mat3","(","0.437",",","-","0.062",",","-","0.048",",","0.449",",","-","0.062",",","-","0.050",",","0.164",",","-","0.024",",","-","0.017",")",";","Nu","=","mat3","(","-","0.011",",","0.377",",","-","0.026",",","-","0.032",",","0.761",
",","-","0.093",",","-","0.007",",","0.009",",","1.234",")",";","OC","=","clamp","(","Nt","*","Nv",",","0.0",",","1.0",")","+","clamp","(","Nu","*","OC",",","0.0",",","1.0",")",";","bu","(","OC",")",";","gl_FragColor","=","vec4","(","OC",",","OD","[","3","]","+","OE","[","3","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if","(","u_enable_hmd_stereo","!=","0",")","{","if","(","bM","[","0","]","<","0.5",")","{","Nr","=","vec2","(","2.0","*","bM","[","0","]",",",
"bM","[","1","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_DISTORTION_CORRECTION"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_sampler_left",",","Nr",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Ns","=","vec2","(","0.5","-","(","u_distortion_params","[","3","]","-","0.5",")","/","2.0",",","u_distortion_params","[","2","]",")",";","Nq","=","2.0","*","u_distortion_params","[","3","]",";","Np","(",
"Nr",",","Ns",",","Nq",",","u_sampler_left",")",";"]}]}}]},{type:"textline",tokens:["}","else","{","Ns","=","vec2","(","2.0","*","(","bM","[","0","]","-","0.5",")",",","bM","[","1","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_DISTORTION_CORRECTION"],group:{type:"group",parts:[{type:"textline",tokens:["gl_FragColor","=","texture2D","(","u_sampler_right",",","Ns",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Nr","=","vec2","(","0.5","+","(",
"u_distortion_params","[","3","]","-","0.5",")","/","2.0",",","u_distortion_params","[","2","]",")",";","Nq","=","2.0","*","u_distortion_params","[","3","]",";","Np","(","Ns",",","Nr",",","Nq",",","u_sampler_right",")",";"]}]}}]},{type:"textline",tokens:["}","}","else","{","gl_FragColor","=","texture2D","(","u_sampler_left",",","bM",")",";","}"]}]}}]},{type:"textline",tokens:["}"]}]},exports["postprocessing/velocity.glslf"]={type:"group",parts:[{type:"include",file:"precision_statement.glslf"},{type:"include",
file:"pack.glslf"},{type:"textline",tokens:["uniform","sampler2D","u_depth",";","uniform","mat4","u_view_proj_inverse",";","uniform","mat4","u_view_proj_prev",";","varying","vec2","bM",";","void","main","(",")","{","vec2","Nc",";","vec4","Ng",",","Nh",";","float","Ni",";","Ni","=","texture2D","(","u_depth",",","bM",")",".","x",";","Ng","=","vec4","(","bM","*","2.0","-","1.0",",","2.0","*","Ni","-","1.0",",","1.0",")",";","Nh","=","u_view_proj_inverse","*","Ng",";","Nh","=","Nh","/","Nh",".","w",";",
"Nh","=","u_view_proj_prev","*","Nh",";","Nh","/=","Nh",".","w",";","Nc","=","(","Ng",".","xy","-","Nh",".","xy",")","/","4.0","+","0.5",";","Nc","=","clamp","(","Nc",",","0.0",",","1.0",")",";","gl_FragColor","=","V","(","Nc",")",";","}"]}]},exports["include/precision_statement.glslf"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"textline",tokens:["precision","PRECISION","float",";"]}]},exports["include/math.glslv"]={type:"group",parts:[{type:"var",name:"EPSILON",tokens:["0.0001"]},
{type:"textline",tokens:["float","a","=","0.0",";","float","b","=","1.0",";","struct","c","{","vec3","a",";","vec3","b",";","vec3","c",";","vec3","d",";","vec3","e",";","vec3","f",";","}",";","bool","f","(","vec3","d",",","vec3","e",")","{","return","any","(","lessThan","(","abs","(","d","-","e",")",",","vec3","(","EPSILON",")",")",")",";","}","vec3","i","(","in","vec4","g",",","in","vec3","h",")","{","return","h","+","2.0","*","cross","(","g",".","xyz",",","cross","(","g",".","xyz",",","h",")","+",
"g",".","w","*","h",")",";","}","vec4","k","(","in","vec4","j",")","{","return","vec4","(","-","j",".","xyz",",","j",".","w",")","/","dot","(","j",",","j",")",";","}","vec3","p","(","vec4","l",",","vec4","m",",","vec4","n",")","{","vec3","o",";","o","=","n",".","xyz","*","l",".","w",";","o","=","i","(","m",",","o",")",";","o","+=","l",".","xyz","*","n",".","w",";","return","o",";","}","vec3","v","(","vec4","q",",","vec4","r",",","vec4","s",")","{","vec4","t",";","vec3","u",";","u","=","s",".","xyz",
"-","q",".","xyz","*","s",".","w",";","t","=","k","(","r",")",";","u","=","i","(","t",",","u",")",";","u","/=","q",".","w",";","return","u",";","}","mat4","w","(",")","{","return","mat4","(","b",",","a",",","a",",","a",",","a",",","b",",","a",",","a",",","a",",","a",",","b",",","a",",","a",",","a",",","a",",","b",")",";","}","mat4","y","(","float","x",")","{","return","mat4","(","b",",","a",",","a",",","a",",","a",",","cos","(","x",")",",","sin","(","x",")",",","a",",","a",",","-","sin","(","x",")",
",","cos","(","x",")",",","a",",","a",",","a",",","a",",","b",")",";","}","mat4","A","(","float","z",")","{","return","mat4","(","cos","(","z",")",",","a",",","-","sin","(","z",")",",","a",",","a",",","b",",","a",",","a",",","sin","(","z",")",",","a",",","cos","(","z",")",",","a",",","a",",","a",",","a",",","b",")",";","}","mat4","C","(","float","B",")","{","return","mat4","(","cos","(","B",")",",","sin","(","B",")",",","a",",","a",",","-","sin","(","B",")",",","cos","(","B",")",",","a",",","a",",",
"a",",","a",",","b",",","a",",","a",",","a",",","a",",","b",")",";","}","c","E","(","in","c","D",")","{","return","c","(","D",".","a",",","D",".","b",",","normalize","(","D",".","c",")",",","normalize","(","D",".","d",")",",","normalize","(","D",".","e",")",",","D",".","f",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2},"REFRACTIVE","USE_NODE_B4W_REFRACTION",
{type:"logical_or_expr",places:4}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","L","(","vec4","F",")","{","vec3","G",";","float","H",",","I",",","J",";","H","=","F",".","x",";","I","=","F",".","y",";","J","=","F",".","w",";","G",".","x","=","(","H","+","J",")","/","2.0",";","G",".","y","=","(","I","+","J",")","/","2.0",";","G",".","z","=","J",";","return","G",";","}"]}]}}]},{type:"textline",tokens:["mat4","O","(","mat3","M",")","{","mat4","N",";","N","[","0","]","[","0","]","=","(",
"b","-","(","M","[","1","]","[","2","]","*","(","M","[","1","]","[","2","]","+","M","[","1","]","[","2","]",")","+","M","[","2","]","[","0","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")",")",")","*","M","[","1","]","[","0","]",";","N","[","0","]","[","1","]","=","(","M","[","1","]","[","1","]","*","(","M","[","1","]","[","2","]","+","M","[","1","]","[","2","]",")","+","M","[","2","]","[","1","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")",")",
"*","M","[","1","]","[","0","]",";","N","[","0","]","[","2","]","=","(","M","[","1","]","[","1","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")","-","M","[","2","]","[","1","]","*","(","M","[","1","]","[","2","]","+","M","[","1","]","[","2","]",")",")","*","M","[","1","]","[","0","]",";","N","[","0","]","[","3","]","=","a",";","N","[","1","]","[","0","]","=","(","M","[","1","]","[","1","]","*","(","M","[","1","]","[","2","]","+","M","[","1","]","[","2","]",")","-","M","[",
"2","]","[","1","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")",")","*","M","[","1","]","[","0","]",";","N","[","1","]","[","1","]","=","(","b","-","(","M","[","1","]","[","1","]","*","(","M","[","1","]","[","1","]","+","M","[","1","]","[","1","]",")","+","M","[","2","]","[","0","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")",")",")","*","M","[","1","]","[","0","]",";","N","[","1","]","[","2","]","=","(","M","[","1","]","[","2","]","*","(","M",
"[","2","]","[","0","]","+","M","[","2","]","[","0","]",")","+","M","[","2","]","[","1","]","*","(","M","[","1","]","[","1","]","+","M","[","1","]","[","1","]",")",")","*","M","[","1","]","[","0","]",";","N","[","1","]","[","3","]","=","a",";","N","[","2","]","[","0","]","=","(","M","[","1","]","[","1","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")","+","M","[","2","]","[","1","]","*","(","M","[","1","]","[","2","]","+","M","[","1","]","[","2","]",")",")","*","M","[","1",
"]","[","0","]",";","N","[","2","]","[","1","]","=","(","M","[","1","]","[","2","]","*","(","M","[","2","]","[","0","]","+","M","[","2","]","[","0","]",")","-","M","[","2","]","[","1","]","*","(","M","[","1","]","[","1","]","+","M","[","1","]","[","1","]",")",")","*","M","[","1","]","[","0","]",";","N","[","2","]","[","2","]","=","(","b","-","(","M","[","1","]","[","1","]","*","(","M","[","1","]","[","1","]","+","M","[","1","]","[","1","]",")","+","M","[","1","]","[","2","]","*","(","M","[","1","]",
"[","2","]","+","M","[","1","]","[","2","]",")",")",")","*","M","[","1","]","[","0","]",";","N","[","2","]","[","3","]","=","a",";","N","[","3","]","[","0","]","=","M","[","0","]","[","0","]",";","N","[","3","]","[","1","]","=","M","[","0","]","[","1","]",";","N","[","3","]","[","2","]","=","M","[","0","]","[","2","]",";","N","[","3","]","[","3","]","=","1.0",";","return","N",";","}"]}]},exports["include/std_enums.glsl"]={type:"group",parts:[{type:"define",name:"TEXTURE_COORDS_UV_ORCO",tokens:["1"]},
{type:"define",name:"TEXTURE_COORDS_NORMAL",tokens:["2"]},{type:"define",name:"TEXTURE_BLEND_TYPE_MIX",tokens:["1"]},{type:"define",name:"TEXTURE_BLEND_TYPE_MULTIPLY",tokens:["2"]},{type:"define",name:"SHADOW_SRC_NONE",tokens:["1"]},{type:"define",name:"SHADOW_SRC_DEPTH",tokens:["2"]},{type:"define",name:"SHADOW_SRC_MASK",tokens:["3"]},{type:"define",name:"SHADOW_DST_NONE",tokens:["1"]},{type:"define",name:"SHADOW_DST_DEPTH",tokens:["2"]},{type:"define",name:"SHADOW_DST_MASK",tokens:["3"]},{type:"define",
name:"NO_SHADOWS",tokens:["1"]},{type:"define",name:"SHADOW_CASTING",tokens:["2"]},{type:"define",name:"SHADOW_MASK_GENERATION",tokens:["3"]},{type:"define",name:"SHADOW_MAPPING_OPAQUE",tokens:["4"]},{type:"define",name:"SHADOW_MAPPING_BLEND",tokens:["5"]},{type:"define",name:"SPECULAR_PHONG",tokens:["1"]},{type:"define",name:"SPECULAR_COOKTORR",tokens:["2"]},{type:"define",name:"SPECULAR_WARDISO",tokens:["3"]},{type:"define",name:"SPECULAR_BLINN",tokens:["4"]},{type:"define",name:"SPECULAR_TOON",
tokens:["5"]},{type:"define",name:"DIFFUSE_LAMBERT",tokens:["1"]},{type:"define",name:"DIFFUSE_OREN_NAYAR",tokens:["2"]},{type:"define",name:"DIFFUSE_FRESNEL",tokens:["3"]},{type:"define",name:"DIFFUSE_MINNAERT",tokens:["4"]},{type:"define",name:"DIFFUSE_TOON",tokens:["5"]},{type:"define",name:"MAPPING_TYPE_TEXTURE",tokens:["0.0"]},{type:"define",name:"MAPPING_TYPE_POINT",tokens:["1.0"]},{type:"define",name:"MAPPING_TYPE_VECTOR",tokens:["2.0"]},{type:"define",name:"MAPPING_TYPE_NORMAL",tokens:["3.0"]},
{type:"define",name:"MIX",tokens:["0"]},{type:"define",name:"ADD",tokens:["1"]},{type:"define",name:"SUBTRACT",tokens:["2"]},{type:"define",name:"MULTIPLY",tokens:["3"]},{type:"define",name:"SCREEN",tokens:["4"]},{type:"define",name:"OVERLAY",tokens:["5"]},{type:"define",name:"DIFFERENCE",tokens:["6"]},{type:"define",name:"DIVIDE",tokens:["7"]},{type:"define",name:"DARKEN",tokens:["8"]},{type:"define",name:"LIGHTEN",tokens:["9"]},{type:"define",name:"HUE",tokens:["10"]},{type:"define",name:"SATURATION",
tokens:["11"]},{type:"define",name:"VALUE",tokens:["12"]},{type:"define",name:"COLOR",tokens:["13"]},{type:"define",name:"SOFT_LIGHT",tokens:["14"]},{type:"define",name:"LINEAR_LIGHT",tokens:["15"]},{type:"define",name:"REFL_NONE",tokens:["0"]},{type:"define",name:"REFL_MIRRORMAP",tokens:["1"]},{type:"define",name:"REFL_PLANE",tokens:["2"]},{type:"define",name:"REFL_CUBE",tokens:["3"]},{type:"define",name:"INVERSE_QUADRATIC",tokens:["0"]},{type:"define",name:"LINEAR",tokens:["1"]},{type:"define",
name:"QUADRATIC",tokens:["2"]},{type:"define",name:"HEMI",tokens:["1"]},{type:"define",name:"SPOT",tokens:["2"]},{type:"define",name:"POINT",tokens:["3"]},{type:"define",name:"SUN",tokens:["4"]},{type:"define",name:"VT_WORLD_TO_WORLD",tokens:["0"]},{type:"define",name:"VT_WORLD_TO_OBJECT",tokens:["1"]},{type:"define",name:"VT_WORLD_TO_CAMERA",tokens:["2"]},{type:"define",name:"VT_OBJECT_TO_WORLD",tokens:["3"]},{type:"define",name:"VT_OBJECT_TO_OBJECT",tokens:["4"]},{type:"define",name:"VT_OBJECT_TO_CAMERA",
tokens:["5"]},{type:"define",name:"VT_CAMERA_TO_WORLD",tokens:["6"]},{type:"define",name:"VT_CAMERA_TO_OBJECT",tokens:["7"]},{type:"define",name:"VT_CAMERA_TO_CAMERA",tokens:["8"]},{type:"define",name:"VT_POINT",tokens:["0"]},{type:"define",name:"VT_VECTOR",tokens:["1"]},{type:"define",name:"VT_NORMAL",tokens:["2"]}]},exports["include/pack.glslf"]={type:"group",parts:[{type:"textline",tokens:["float","P","=","255.0",";","float","Q","=","0.0",";","float","R","=","1.0",";","vec4","V","(","const","in",
"float","S",")","{","vec4","T",",","U",";","T","=","vec4","(","P","*","P","*","P",",","P","*","P",",","P",",","R",")",";","U","=","vec4","(","Q",",","R","/","P",",","R","/","P",",","R","/","P",")",";","T","=","fract","(","S","*","T",")",";","T","-=","T",".","xxyz","*","U",";","return","T",";","}","float","Z","(","const","in","vec4","W",")","{","vec4","X",";","float","Y",";","X","=","vec4","(","R","/","(","P","*","P","*","P",")",",","R","/","(","P","*","P",")",",","R","/","P",",","R",")",";","Y","=",
"dot","(","W",",","X",")",";","return","Y",";","}","vec4","V","(","const","in","vec2","_",")","{","vec4","aa",";","vec2","ab",",","ac",";","ab","=","vec2","(","P",",","R",")",";","ac","=","vec2","(","Q",",","R","/","P",")",";","aa","=","fract","(","_",".","xxyy","*","ab",".","xyxy",")",";","aa","-=","aa",".","xxzz","*","ac",".","xyxy",";","if","(","_",".","r","==","R",")","aa",".","rg","=","vec2","(","Q",",","R",")",";","if","(","_",".","g","==","R",")","aa",".","ba","=","vec2","(","Q",",","R",")",
";","return","aa",";","}","vec2","ag","(","const","in","vec4","ad",")","{","vec2","ae",",","af",";","af","=","vec2","(","R","/","P",",","R",")",";","ae",".","r","=","dot","(","ad",".","rg",",","af",")",";","ae",".","g","=","dot","(","ad",".","ba",",","af",")",";","return","ae",";","}"]}]},exports["include/procedural.glslf"]={type:"group",parts:[{type:"textline",tokens:["float","ah","=","0.0",";","float","ai","=","1.0",";","vec4","ak","(","vec4","aj",")","{","return","aj","-","floor","(","aj","*",
"(","ai","/","289.0",")",")","*","289.0",";","}","vec3","ak","(","vec3","al",")","{","return","al","-","floor","(","al","*","(","ai","/","289.0",")",")","*","289.0",";","}","vec2","ak","(","vec2","am",")","{","return","am","-","floor","(","am","*","(","ai","/","289.0",")",")","*","289.0",";","}","vec4","ao","(","vec4","an",")","{","return","an","-","floor","(","an","*","(","ai","/","7.0",")",")","*","7.0",";","}","vec4","aq","(","vec4","ap",")","{","return","ak","(","(","34.0","*","ap","+","5.0",
")","*","ap",")",";","}"]},{type:"define",name:"K",tokens:["0.142857142857"]},{type:"define",name:"K2",tokens:["0.0714285714285"]},{type:"define",name:"JITTER",tokens:["0.7"]},{type:"textline",tokens:["vec2","ay","(","vec2","ar",")","{","vec4","as",",","at",",","au",",","av",";","vec2","aw",",","ax",";","aw","=","ak","(","floor","(","ar",")",")",";","ax","=","fract","(","ar",")",";","as","=","ax",".","x","+","vec4","(","-","0.5",",","-","1.5",",","-","0.5",",","-","1.5",")",";","at","=","ax",".",
"y","+","vec4","(","-","0.5",",","-","0.5",",","-","1.5",",","-","1.5",")",";","au","=","aq","(","aw",".","x","+","vec4","(","ah",",","ai",",","ah",",","ai",")",")",";","au","=","aq","(","au","+","aw",".","y","+","vec4","(","ah",",","ah",",","ai",",","ai",")",")",";","av","=","ao","(","au",")","*","K","+","K2",";","au","=","ao","(","floor","(","au","*","K",")",")","*","K","+","K2",";","av","=","as","+","JITTER","*","av",";","au","=","at","+","JITTER","*","au",";","au","=","av","*","av","+","au","*",
"au",";"]},{type:"condition",parts:[{type:"if",expression:[1],group:{type:"group",parts:[{type:"textline",tokens:["au",".","xy","=","min","(","au",".","xy",",","au",".","zw",")",";","au",".","x","=","min","(","au",".","x",",","au",".","y",")",";","return","au",".","xx",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["au",".","xy","=","(","au",".","x","<","au",".","y",")","?","au",".","xy",":","au",".","yx",";","au",".","xz","=","(","au",".","x","<","au",".","z",")","?","au",
".","xz",":","au",".","zx",";","au",".","xw","=","(","au",".","x","<","au",".","w",")","?","au",".","xw",":","au",".","wx",";","au",".","y","=","min","(","au",".","y",",","au",".","z",")",";","au",".","y","=","min","(","au",".","y",",","au",".","w",")",";","return","sqrt","(","au",".","xy",")",";"]}]}}]},{type:"textline",tokens:["}","vec3","aH","(","vec2","az",",","float","aA",")","{","vec4","aB",",","aC",",","aD",",","aE",";","vec2","aF",",","aG",";","aF","=","ak","(","floor","(","az",")",")",";",
"aG","=","fract","(","az",")",";","aB","=","aG",".","x","+","vec4","(","-","0.5",",","-","1.5",",","-","0.5",",","-","1.5",")",";","aC","=","aG",".","y","+","vec4","(","-","0.5",",","-","0.5",",","-","1.5",",","-","1.5",")",";","aD","=","aq","(","aF",".","x","+","vec4","(","ah",",","ai",",","ah",",","ai",")",")",";","aD","=","aq","(","aD","+","aF",".","y","+","vec4","(","ah",",","ah",",","ai",",","ai",")",")",";","aE","=","ao","(","aD",")","*","K","+","K2",";","aD","=","ao","(","floor","(","aD","*",
"K",")",")","*","K","+","K2",";","aE","=","aB","+","JITTER","*","aE",";","aD","=","aC","+","JITTER","*","aD",";","aC","=","aE","*","aE","+","aD","*","aD",";","aE","+=","aA",";","aD","+=","aA",";","aB","=","aE","*","aE","+","aD","*","aD",";","aE","+=","aA",";","aD","+=","aA",";","aD","=","aE","*","aE","+","aD","*","aD",";","aC",".","xy","=","min","(","aC",".","xy",",","aC",".","zw",")",";","aC",".","x","=","min","(","aC",".","x",",","aC",".","y",")",";","aB",".","xy","=","min","(","aB",".","xy",",",
"aB",".","zw",")",";","aB",".","x","=","min","(","aB",".","x",",","aB",".","y",")",";","aD",".","xy","=","min","(","aD",".","xy",",","aD",".","zw",")",";","aD",".","x","=","min","(","aD",".","x",",","aD",".","y",")",";","return","vec3","(","aC",".","x",",","aB",".","x",",","aD",".","x",")",";","}","vec3","aJ","(","vec3","aI",")","{","return","ak","(","(","(","aI","*","34.0",")","+","ai",")","*","aI",")",";","}","float","aU","(","vec2","aK",")","{","vec3","aL",",","aM",",","aN",",","aO",";","vec4",
"aP",";","vec2","aQ",",","aR",",","aS",";","const","vec4","aT","=","vec4","(","0.211324865405187",",","0.366025403784439",",","-","0.577350269189626",",","0.024390243902439",")",";","aQ","=","floor","(","aK","+","dot","(","aK",",","aT",".","yy",")",")",";","aR","=","aK","-","aQ","+","dot","(","aQ",",","aT",".","xx",")",";","aS","=","(","aR",".","x",">","aR",".","y",")","?","vec2","(","ai",",","ah",")",":","vec2","(","ah",",","ai",")",";","aP","=","aR",".","xyxy","+","aT",".","xxzz",";","aP",".","xy",
"-=","aS",";","aQ","=","ak","(","aQ",")",";","aL","=","aJ","(","aJ","(","aQ",".","y","+","vec3","(","ah",",","aS",".","y",",","ai",")",")","+","aQ",".","x","+","vec3","(","ah",",","aS",".","x",",","ai",")",")",";","aM","=","max","(","0.5","-","vec3","(","dot","(","aR",",","aR",")",",","dot","(","aP",".","xy",",","aP",".","xy",")",",","dot","(","aP",".","zw",",","aP",".","zw",")",")",",","ah",")",";","aM","=","aM","*","aM",";","aM","=","aM","*","aM",";","aL","=","2.0","*","fract","(","aL","*","aT",
".","www",")","-","ai",";","aN","=","abs","(","aL",")","-","0.5",";","aO","=","floor","(","aL","+","0.5",")",";","aO","=","aL","-","aO",";","aM","*=","1.79284291400159","-","0.85373472095314","*","(","aO","*","aO","+","aN","*","aN",")",";","aL",".","x","=","aO",".","x","*","aR",".","x","+","aN",".","x","*","aR",".","y",";","aL",".","yz","=","aO",".","yz","*","aP",".","xz","+","aN",".","yz","*","aP",".","yw",";","return","130.0","*","dot","(","aM",",","aL",")",";","}","vec2","aY","(","vec2","aV",")",
"{","float","aW",",","aX",";","aW","=","dot","(","aV",",","vec2","(","12.9898",",","78.233",")",")",";","aX","=","dot","(","aV",",","vec2","(","12.9898",",","78.233",")","*","2.0",")",";","aW","=","fract","(","sin","(","aW",")","*","43758.5453",")","*","2.0","-","ai",";","aX","=","fract","(","sin","(","aX",")","*","43758.5453",")","*","2.0","-","ai",";","return","vec2","(","aW",",","aX",")",";","}"]}]},exports["include/caustics.glslf"]={type:"group",parts:[{type:"var",name:"CAUST_SPEED",tokens:["vec2",
"(","0.0",")"]},{type:"var",name:"CAUST_SCALE",tokens:["0.0"]},{type:"var",name:"CAUST_BRIGHT",tokens:["0.0"]},{type:"var",name:"SUN_NUM",tokens:["0"]},{type:"define",name:"CAUSTICS_VIEW_DISTANCE",tokens:["100.0"]},{type:"textline",tokens:["void","bp","(","inout","vec3","aZ",",","float","a_",",","float","ba",",","vec4","bb",",","vec3","bc",",","vec3","bd",",","vec3","be",",","vec4","bf",",","vec3","bg",",","float","bh",")","{","float","bi",",","bj",",","bk",";","vec2","bl",",","bm",";","vec3","bn",
";","vec4","bo",";","if","(","bh",">","CAUSTICS_VIEW_DISTANCE",")","return",";","bo","=","bf",";","bn","=","bg","+","bc",";","bn",".","xz","=","10.0","*","sin","(","0.1","*","bn",".","xz",")",";","bn","=","bn","+","2.0","*","cross","(","-","bo",".","xyz",",","cross","(","-","bo",".","xyz",",","bn",")","+","bo",".","w","*","bn",")",";","bl","=","bn",".","xz",";","bn","=","bd",";","bi","=","max","(","dot","(","bc",",","bn",")",",","0.0",")",";","bj","=","0.025",";","bm","=","CAUST_SPEED","*","ba",";",
"bl",".","s","+=","0.25","*","sin","(","dot","(","bg","+","ba",",","vec3","(","1.0",")",")",")",";","bl",".","t","+=","0.35","*","(","-","sin","(","dot","(","bg","-","ba",",","vec3","(","-","0.7",")",")",")",")",";","bl",".","st","+=","0.15","*","cos","(","4.0","*","a_","-","bm",".","x",")","+","1.5","*","sin","(","a_","-","0.3","*","bm",".","y",")",";","bk","=","CAUST_SCALE","*","(","1.0","+","max","(","0.1","*","a_",",","0.0",")",")",";","bn","=","aH","(","(","bl","/","bk",")",",","bj",")",";",
"bn","*=","CAUST_BRIGHT",";","bn","*=","bn",";","bj","=","min","(","0.25","*","a_",",","-","a_",")","+","1.0",";","bj","=","max","(","bj",",","0.0",")",";","bi","=","bb","[","SUN_NUM","]","*","bi",";","bk","=","max","(","sign","(","a_",")",",","0.0",")",";","bi","=","bi","+","max","(","0.5","*","sign","(","-","bc",".","y",")","*","bk",",","0.0",")",";","bi","=","min","(","bi",",","1.0",")",";","aZ","+=","be","*","bn","*","bj","*","bi",";","}"]}]},exports["include/color_util.glslf"]={type:"group",
parts:[{type:"define",name:"GAMMA",tokens:["1"]},{type:"define",name:"PREMULTIPLY_ALPHA",tokens:["1"]},{type:"textline",tokens:["void","br","(","inout","vec3","bq",")","{"]},{type:"condition",parts:[{type:"if",expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["bq","=","max","(","vec3","(","0.0",")",",","bq",")",";","bq","=","pow","(","bq",",","vec3","(","2.2",")",")",";"]}]}}]},{type:"textline",tokens:["}","void","br","(","inout","float","bs",")","{"]},{type:"condition",parts:[{type:"if",
expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["bs","=","pow","(","max","(","0.0",",","bs",")",",","2.2",")",";"]}]}}]},{type:"textline",tokens:["}","void","bu","(","inout","vec3","bt",")","{"]},{type:"condition",parts:[{type:"if",expression:["GAMMA"],group:{type:"group",parts:[{type:"textline",tokens:["bt","=","max","(","vec3","(","0.0",")",",","bt",")",";","bt","=","pow","(","bt",",","vec3","(","1.0","/","2.2",")",")",";"]}]}}]},{type:"textline",tokens:["}","void","bx",
"(","inout","vec3","bv",",","in","float","bw",")","{"]},{type:"condition",parts:[{type:"if",expression:["PREMULTIPLY_ALPHA"],group:{type:"group",parts:[{type:"textline",tokens:["bv","=","bv","*","bw",";"]}]}}]},{type:"textline",tokens:["}","float","bB","(","vec4","by",")","{","float","bz",";","vec3","bA",";","bA","=","vec3","(","0.299",",","0.587",",","0.114",")",";","bz","=","dot","(","by",".","rgb",",","bA",")",";","return","bz",";","}"]}]},exports["include/shadow.glslf"]={type:"group",parts:[{type:"var",
name:"PRECISION",tokens:["lowp"]},{type:"var",name:"CSM_BLEND_BETWEEN_CASCADES",tokens:["1.0"]},{type:"var",name:"CSM_FADE_LAST_CASCADE",tokens:["1.0"]},{type:"var",name:"SHADOW_TEX_RES",tokens:["0.0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["const","float","bN","=","0.1",";","const","float","bO","=","0.1",";","const","float","bP","=","-","0.01",";","const","float","bQ","=","0.05",";","vec4","bR","=","vec4","(","0.14383161",",","0.34495938",",","-","0.38277543",",","-","0.26496911",")",";","vec4","bS","=","vec4","(","0.53742981",",","0.19984126",",","0.79197514",",","-","0.094184101",")",";","vec4","bT","=","vec4","(","-","0.94201624",",","-","0.91588581",",","-","0.2418884",",","0.44323325",")",";","vec4","bU","=","vec4","(",
"-","0.81544232",",","0.94558609",",","-","0.81409955",",","0.97484398",")",";","vec4","bV","=","vec4","(","-","0.1410079",",","0.2938776",",","0.27676845",",","-","0.41893023",")",";","vec4","bW","=","vec4","(","-","0.4737342",",","0.78641367",",","0.19090188",",","-","0.9293887",")",";","vec4","bX","=","vec4","(","-","0.39906216",",","0.45771432",",","0.99706507",",","-","0.97511554",")",";","vec4","bY","=","vec4","(","-","0.87912464",",","-","0.76890725",",","0.9143759",",","0.7564837",")",";",
"bool","ca","(","vec2","bZ",",","float","b_",")","{","return","all","(","lessThanEqual","(","bZ",",","vec2","(","1.0","+","b_",")",")",")","&&","all","(","greaterThanEqual","(","bZ",",","vec2","(","0.0","-","b_",")",")",")",";","}","float","cj","(","float","cb",",","float","cc",",","mat2","cd",",","vec3","ce",",","float","cf",",","PRECISION","sampler2D","cg",")","{","vec2","ch",",","ci",";","ci",".","x","=","cb",";","ci",".","y","=","cc",";","ci","=","cd","*","ci",";","ch","=","ce",".","xy","+","ci",
"*","cf","/","SHADOW_TEX_RES",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","!","ca","(","ch",",","bP",")",")","return","1.0",";","else"]}]}}]},{type:"textline",tokens:["return","step","(","ce",".","z",",","texture2D","(","cg",",","ch",")",".","r",")",";","}","float","cs","(","vec3","ck",",","PRECISION","sampler2D","cl",",","float","cm",")","{","mat2","cn",";","float","co",",",
"cp",",","cq",";","co","=","0.0",";","ck",".","z","=","clamp","(","ck",".","z",",","0.0",",","1.0",")",";","cp","=","aY","(","ck",".","xy",")",".","x","*","M_PI",";","cq","=","cos","(","cp",")",";","cp","=","sin","(","cp",")",";","cn","=","mat2","(","cq",",","cp",",","-","cp",",","cq",")",";","for","(","int","cr","=","0",";","cr","<","4",";","cr","++",")","{","co","+=","cj","(","bR","[","cr","]",",","bV","[","cr","]",",","cn",",","ck",",","cm",",","cl",")",";","co","+=","cj","(","bS","[","cr","]",
",","bW","[","cr","]",",","cn",",","ck",",","cm",",","cl",")",";","co","+=","cj","(","bT","[","cr","]",",","bX","[","cr","]",",","cn",",","ck",",","cm",",","cl",")",";","co","+=","cj","(","bU","[","cr","]",",","bY","[","cr","]",",","cn",",","ck",",","cm",",","cl",")",";","}","return","clamp","(","co","/","16.0",",","0.0",",","1.0",")",";","}","float","cH","(","vec3","ct",",","PRECISION","sampler2D","cu",",","vec3","cv",",","PRECISION","sampler2D","cw",",","float","cx",",","float","cy",",","float",
"cz",")","{","mat2","cA",";","float","cB",",","cC",",","cD",",","cE",";","ct",".","z","=","clamp","(","ct",".","z",",","0.0",",","1.0",")",";","cv",".","z","=","clamp","(","cv",".","z",",","0.0",",","1.0",")",";","cB","=","0.0",";","cC","=","0.0",";","cD","=","aY","(","ct",".","xy",")",".","x","*","M_PI",";","cE","=","cos","(","cD",")",";","cD","=","sin","(","cD",")",";","cA","=","mat2","(","cE",",","cD",",","-","cD",",","cE",")",";","for","(","int","cF","=","0",";","cF","<","4",";","cF","++",")",
"{","cB","+=","cj","(","bR","[","cF","]",",","bV","[","cF","]",",","cA",",","ct",",","cx",",","cu",")",";","cB","+=","cj","(","bS","[","cF","]",",","bW","[","cF","]",",","cA",",","ct",",","cx",",","cu",")",";","cB","+=","cj","(","bT","[","cF","]",",","bX","[","cF","]",",","cA",",","ct",",","cx",",","cu",")",";","cB","+=","cj","(","bU","[","cF","]",",","bY","[","cF","]",",","cA",",","ct",",","cx",",","cu",")",";","}","for","(","int","cG","=","0",";","cG","<","4",";","cG","++",")","{","cC","+=","cj",
"(","bR","[","cG","]",",","bV","[","cG","]",",","cA",",","cv",",","cy",",","cw",")",";","cC","+=","cj","(","bS","[","cG","]",",","bW","[","cG","]",",","cA",",","cv",",","cy",",","cw",")",";","cC","+=","cj","(","bT","[","cG","]",",","bX","[","cG","]",",","cA",",","cv",",","cy",",","cw",")",";","cC","+=","cj","(","bU","[","cG","]",",","bY","[","cG","]",",","cA",",","cv",",","cy",",","cw",")",";","}","cB","=","mix","(","cB",",","cC",",","cz",")",";","cB","/=","16.0",";","return","clamp","(","cB",",",
"0.0",",","1.0",")",";","}","float","cL","(","vec2","cI",")","{","float","cJ",",","cK",";","cJ","=","min","(","cI",".","x",",","cI",".","y",")",";","cK","=","min","(","1.0","-","cI",".","x",",","1.0","-","cI",".","y",")",";","return","min","(","cJ",",","cK",")",";","}","float","cO","(","float","cM",",","float","cN",")","{","if","(","cN",">=","0.0","&&","cN","<=","bO",")","cM","=","(","cM","-","1.0",")","/","bO","*","cN","+","1.0",";","return","cM",";","}","float","cZ","(","vec3","cP",",","vec3","cQ",
",","PRECISION","sampler2D","cR",",","PRECISION","sampler2D","cS",",","float","cT",",","float","cU",",","float","cV",",","float","cW",")","{","float","cX",",","cY",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_BLEND_BETWEEN_CASCADES"],group:{type:"group",parts:[{type:"textline",tokens:["cY","=","cL","(","cP",".","xy",")",";","if","(","-","cW",">","cV","&&","cY",">=","0.0","&&","cY","<=","bN","&&","ca","(","cQ",".","xy",",","0.0",")",")","{","cY","=","1.0","-","cY","/","bN",";","cX","=",
"cH","(","cP",",","cR",",","cQ",",","cS",",","cT",",","cU",",","cY",")",";","}","else"]}]}}]},{type:"textline",tokens:["cX","=","cs","(","cP",",","cR",",","cT",")",";","return","cX",";","}","float","dg","(","vec3","c_",",","PRECISION","sampler2D","da",",","float","db",",","float","dc",",","float","dd",")","{","float","de",",","df",";","de","=","cs","(","c_",",","da",",","db",")",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_FADE_LAST_CASCADE"],group:{type:"group",parts:[{type:"textline",
tokens:["if","(","-","dd",">","dc",")","{","df","=","cL","(","c_",".","xy",")",";","de","=","cO","(","de",",","df",")",";","}"]}]}}]},{type:"textline",tokens:["return","de",";","}","vec4","dr","(","float","dh",")","{","vec3","di",",","dj",",","dk",",","dl",";","float","dm",",","dn",",","dp",",","dq",";","dm","=","1.0",";","di","=","bI",".","xyz","/","bI",".","w",";","if","(","bI",".","w","<","0.0",")","di",".","z","=","0.0",";"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1","NUM_CAST_LAMPS",
1,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dj","=","bJ",".","xyz","/","bJ",".","w",";","if","(","bJ",".","w","<","0.0",")","dj",".","z","=","0.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2","NUM_CAST_LAMPS",2,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dk","=","bK",".","xyz","/","bK",".","w",";","if","(","bK",".","w","<","0.0",")",
"dk",".","z","=","0.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3","NUM_CAST_LAMPS",3,{type:"g_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dl","=","bL",".","xyz","/","bL",".","w",";","if","(","bL",".","w","<","0.0",")","dl",".","z","=","0.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","ca","(","di",".","xy",",","0.0",
")",")","{","dm","=","cZ","(","di",",","dj",",","u_shadow_map0",",","u_shadow_map1",",","u_pcf_blur_radii","[","0","]",",","u_pcf_blur_radii","[","1","]",",","u_csm_center_dists","[","0","]",",","dh",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if","(","ca","(","di",".","xy",",","bQ",")",")","{","dm","=","dg","(","di",",","u_shadow_map0",",","u_pcf_blur_radii","[","0","]",",","u_csm_center_dists","[","0","]",",","dh",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["else","{","if","(","ca","(","dj",".","xy",",","0.0",")",")","{"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["dm","=","cZ","(","dj",",","dk",",","u_shadow_map1",",","u_shadow_map2",",","u_pcf_blur_radii","[","1","]",",","u_pcf_blur_radii","[","2","]",",","u_csm_center_dists","[","1","]",",","dh",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["dm","=","dg","(","dj",",","u_shadow_map1",",","u_pcf_blur_radii","[","1","]",",","u_csm_center_dists","[","1","]",",","dh",")",";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["else","{","if","(","ca","(","dk",".","xy",",","0.0",")",")","{"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",tokens:["dm","=","cZ","(","dk",",",
"dl",",","u_shadow_map2",",","u_shadow_map3",",","u_pcf_blur_radii","[","2","]",",","u_pcf_blur_radii","[","3","]",",","u_csm_center_dists","[","2","]",",","dh",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dm","=","dg","(","dk",",","u_shadow_map2",",","u_pcf_blur_radii","[","2","]",",","u_csm_center_dists","[","2","]",",","dh",")",";"]}]}}]},{type:"textline",tokens:["}"]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],group:{type:"group",parts:[{type:"textline",
tokens:["else","{","if","(","ca","(","dl",".","xy",",","0.0",")",")","dm","=","dg","(","dl",",","u_shadow_map3",",","u_pcf_blur_radii","[","3","]",",","u_csm_center_dists","[","3","]",",","dh",")",";","}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dn","=","cs","(","dj",",","u_shadow_map1",",","u_pcf_blur_radii","[","0",
"]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dn","=","0.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dp","=","cs","(","dk",",","u_shadow_map2",",","u_pcf_blur_radii","[","0","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dp","=","0.0",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",3,
{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dq","=","cs","(","dl",",","u_shadow_map3",",","u_pcf_blur_radii","[","0","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dq","=","1.0",";"]}]}}]},{type:"textline",tokens:["return","vec4","(","dm",",","dn",",","dp",",","dq",")",";","}"]}]}}]},{type:"textline",tokens:["vec4","du","(","inout","vec3","ds",")","{","vec4","dt",";"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE",
"SHADOW_MAPPING_OPAQUE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dt","=","texture2DProj","(","u_shadow_mask",",","bG",")",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",3,{type:"l_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["ds","*=","dt",".","a",";"]}]}}]},{type:"textline",tokens:["return","dt",";"]}]}},{type:"elif",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE",
"SHADOW_MAPPING_BLEND",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dt","=","dr","(","bD",".","z",")",";","return","dt",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","vec4","(","1.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/mirror.glslf"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2},
"REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2},"REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"define",name:"REFL_BUMP",tokens:["0.1"]},{type:"textline",tokens:["float","dB","(","in","vec3","dv",",","vec3","dw",",","float","dx",",","float","dy",")","{","float","dz",";","vec3","dA",";","dA","=","normalize","(","dw","+","dv",")",";","dz","=","1.0","-","dot","(","dv",",","dA",")",";","dz","=","dy","+","(",
"1.0","-","dy",")","*","pow","(","dz",",","dx",")",";","return","dz",";","}","void","dP","(","inout","vec3","dC",",","vec3","dD",",","vec3","dE",",","float","dF",",","mat4","dG",")","{","vec2","dH",",","dI",";","float","dJ",",","dK",",","dL",";","vec3","dM",",","dN",",","dO",";","dM","=","reflect","(","-","dD",",","dE",")",";","dJ","=","u_fresnel_params","[","2","]",";","dK","=","u_fresnel_params","[","3","]",";","dL","=","1.0",";","if","(","dJ","!=","0.0",")","dL","=","dB","(","dD",",","dM",",",
"dJ",",","dK",")",";"]},{type:"condition",parts:[{type:"if",expression:["REFLECTION_TYPE","REFL_CUBE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dN","=","textureCube","(","u_cube_reflection",",","dM",")",".","xyz",";"]}]}},{type:"elif",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFLECTION_PASS",{type:"logic_negative_expr",places:1}],group:{type:"group",
parts:[{type:"textline",tokens:["dO","=","u_refl_plane",".","xyz","*","dot","(","dE",",","u_refl_plane",".","xyz",")",";","dO","=","dE","-","dO",";","dH","=","(","dG","*","vec4","(","dO",",","0.0",")",")",".","xy",";","dI","=","bG",".","xy","/","bG",".","z",";","dI","+=","dH","*","REFL_BUMP",";","dN","=","texture2D","(","u_plane_reflection",",","dI",")",".","rgb",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["dN","=","vec3","(","1.0",")",";","dF","=","0.0",";"]}]}}]}]}},
{type:"elif",expression:["REFLECTION_TYPE","REFL_MIRRORMAP",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["dN","=","textureCube","(","u_mirrormap",",","dM",")",".","xyz",";","dF","=","u_mirror_factor",";"]}]}}]},{type:"textline",tokens:["br","(","dN",".","rgb",")",";","dC","=","mix","(","dC",",","dN",",","dF","*","dL",")",";","}"]}]}}]}]},exports["include/environment.glslf"]={type:"group",parts:[{type:"textline",tokens:["vec3","dS","(","vec3","dQ",")","{","float",
"dR",";"]},{type:"condition",parts:[{type:"if",expression:["USE_ENVIRONMENT_LIGHT"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SKY_TEXTURE"],group:{type:"group",parts:[{type:"textline",tokens:["return","textureCube","(","u_sky_texture",",","dQ",")",".","rgb",";"]}]}},{type:"elif",expression:["SKY_COLOR"],group:{type:"group",parts:[{type:"textline",tokens:["dR","=","0.5","*","dQ",".","y","+","0.5",";","return","mix","(","u_horizon_color",",","u_zenith_color",",","dR",
")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","vec3","(","1.0",")",";"]}]}}]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","vec3","(","0.0",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/refraction.glslf"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["REFRACTIVE"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION_CORRECTION"],group:{type:"group",
parts:[{type:"textline",tokens:["float","dY","(","in","float","dT",",","inout","vec2","dU",",","in","vec2","dV",")","{","float","dW",";","vec4","dX",";","dX","=","texture2D","(","u_scene_depth",",","dU",")",";","dW","=","Z","(","dX",")",";","if","(","dW","<","bH",")","{","dU","=","dV",";","return","dT",";","}","else","{","return","dW",";","}","return","dT",";","}"]}]}}]},{type:"textline",tokens:["vec3","ef","(","in","vec3","dZ",",","in","vec2","d_",")","{","vec3","ea",";","float","eb",";","vec4",
"ec",";","vec2","ed",",","ee",";","ed","=","dZ",".","xy","/","dZ",".","z",";","ee","=","ed","+","d_",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION_CORRECTION"],group:{type:"group",parts:[{type:"textline",tokens:["ec","=","texture2DProj","(","u_scene_depth",",","dZ",")",";","eb","=","Z","(","ec",")",";","dY","(","eb",",","ee",",","ed",")",";"]}]}}]},{type:"textline",tokens:["ea","=","texture2D","(","u_refractmap",",","ee",")",".","rgb",";","br","(","ea",")",";","return","ea",
";","}"]}]}}]}]},exports["include/nodes.glslf"]={type:"group",parts:[{type:"var",name:"MAPPING_TRS_MATRIX",tokens:["mat4","(","0.0",")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",name:"RGB_IND",tokens:["0"]},{type:"var",
name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",tokens:["0"]},{type:"var",name:"NUM_LIGHTS",tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NODE_TEX_ROW",tokens:["0.0"]},
{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["varying","vec3","eg",";"]}]}}]},{type:"textline",tokens:["float","ZERO_VALUE_NODES","=","0.0",";","float","UNITY_VALUE_NODES","=","1.0",";","float","eh","=","0.5",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_B4W_REFRACTION"],group:{type:"group",parts:[{type:"textline",
tokens:["vec3","el","(","in","vec3","ei",",","in","float","ej",")","{","vec3","ek",";","ek","=","vec3","(","ZERO_VALUE_NODES",")",";"]},{type:"condition",parts:[{type:"if",expression:["USE_REFRACTION"],group:{type:"group",parts:[{type:"textline",tokens:["ek","=","ef","(","bG",",","ei",".","xy","*","ej",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["ek","=","texture2D","(","u_refractmap",",","bG",".","xy","/","bG",".","z",")",".","rgb",";","br","(","ek",")",";"]}]}}]},
{type:"textline",tokens:["return","ek",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","USE_NODE_MIX_RGB_HUE","USE_NODE_MIX_RGB_SATURATION","USE_NODE_MIX_RGB_VALUE","USE_NODE_MIX_RGB_COLOR","USE_NODE_SEPHSV",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eq","(","vec3","em",")","{","float","en",",","eo",";","vec4","ep",";","ep","=","vec4","(","ZERO_VALUE_NODES",",","-","UNITY_VALUE_NODES","/","3.0",",","2.0","/","3.0",
",","-","UNITY_VALUE_NODES",")",";","ep","=","mix","(","vec4","(","em",".","bg",",","ep",".","wz",")",",","vec4","(","em",".","gb",",","ep",".","xy",")",",","step","(","em",".","b",",","em",".","g",")",")",";","ep","=","mix","(","vec4","(","ep",".","xyw",",","em",".","r",")",",","vec4","(","em",".","r",",","ep",".","yzx",")",",","step","(","ep",".","x",",","em",".","r",")",")",";","en","=","ep",".","x","-","min","(","ep",".","w",",","ep",".","y",")",";","eo","=","1.0e-10",";","return","vec3","(",
"abs","(","ep",".","z","+","(","ep",".","w","-","ep",".","y",")","/","(","6.0","*","en","+","eo",")",")",",","en","/","(","ep",".","x","+","eo",")",",","ep",".","x",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","USE_NODE_MIX_RGB_HUE","USE_NODE_MIX_RGB_SATURATION","USE_NODE_MIX_RGB_VALUE","USE_NODE_MIX_RGB_COLOR","USE_NODE_COMBHSV",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","eu","(","vec3","er",")","{","vec3",
"es",";","vec4","et",";","et","=","vec4","(","UNITY_VALUE_NODES",",","2.0","/","3.0",",","UNITY_VALUE_NODES","/","3.0",",","3.0",")",";","es","=","abs","(","fract","(","vec3","(","er",".","r",",","er",".","r",",","er",".","r",")","+","et",".","xyz",")","*","6.0","-","et",".","www",")",";","return","er",".","b","*","mix","(","et",".","xxx",",","clamp","(","es","-","et",".","xxx",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",",","er",".","g",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["USE_NODE_GEOMETRY_UV","USE_NODE_B4W_PARALLAX","USE_NODE_UV_MERGED",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ew","(","vec2","ev",")","{","return","vec3","(","ev","*","2.0","-","vec2","(","UNITY_VALUE_NODES",",","UNITY_VALUE_NODES",")",",","ZERO_VALUE_NODES",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_TEXTURE_COLOR","USE_NODE_TEXTURE_NORMAL","USE_NODE_B4W_PARALLAX",{type:"logical_or_expr",places:3}],
group:{type:"group",parts:[{type:"textline",tokens:["vec2","ey","(","vec3","ex",")","{","return","vec2","(","ex",".","xy","*","eh","+","vec2","(","eh",",","eh",")",")",";","}"]}]}}]},{type:"node",name:"CAMERA",declarations:[{type:"node_out",name:"fq",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"fr",qualifier:["float"],is_optional:true},{type:"node_out",name:"fs",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_fq"],
statements:[{type:"textline",tokens:["fq","=","normalize","(","fh",".","xyz",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_fr"],statements:[{type:"textline",tokens:["fr","=","abs","(","fh",".","z",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_fs"],statements:[{type:"textline",tokens:["fs","=","length","(","fh",".","xyz",")",";"]}]}]}]},{type:"node",name:"COMBRGB",declarations:[{type:"node_in",name:"ft",qualifier:["float"],is_optional:false},
{type:"node_in",name:"fu",qualifier:["float"],is_optional:false},{type:"node_in",name:"fv",qualifier:["float"],is_optional:false},{type:"node_out",name:"fw",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fw","=","vec3","(","ft",",","fu",",","fv",")",";"]}]},{type:"node",name:"COMBHSV",declarations:[{type:"node_in",name:"fx",qualifier:["float"],is_optional:false},{type:"node_in",name:"fy",qualifier:["float"],is_optional:false},{type:"node_in",name:"fz",qualifier:["float"],
is_optional:false},{type:"node_out",name:"fA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fA","=","eu","(","vec3","(","fx",",","fy",",","fz",")",")",";"]}]},{type:"node",name:"EMPTY_UV",declarations:[{type:"node_out",name:"fB",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fB","=","vec3","(","-","UNITY_VALUE_NODES",",","-","UNITY_VALUE_NODES",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"EMPTY_VC",declarations:[{type:"node_out",
name:"fC",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fC","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"GEOMETRY_UV",declarations:[{type:"node_out",name:"fD",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"ez",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["fD","=","ew","(","ez",")",";"]}]},{type:"node",name:"GEOMETRY_OR",declarations:[{type:"node_out",name:"fE",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["fE","=","2.0","*","eg","-","vec3","(","UNITY_VALUE_NODES",")",";"]}]},{type:"node",name:"GEOMETRY_VC",declarations:[{type:"node_out",name:"fF",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"eA",qualifier:["varying","vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fF","=","eA",";","br","(","fF",")",";"]}]},{type:"node",name:"GEOMETRY_VC1",declarations:[{type:"node_out",name:"fG",qualifier:["float"],is_optional:false},{type:"node_param",
name:"eB",qualifier:["varying","float"],is_optional:false}],statements:[{type:"textline",tokens:["fG","=","eB",";","br","(","fG",")",";"]}]},{type:"node",name:"GEOMETRY_VC2",declarations:[{type:"node_out",name:"fH",qualifier:["float"],is_optional:false},{type:"node_out",name:"fI",qualifier:["float"],is_optional:false},{type:"node_param",name:"eC",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["fH","=","eC","[","0","]",";","fI","=","eC","[","1","]",";","br","(",
"fH",")",";","br","(","fI",")",";"]}]},{type:"node",name:"GEOMETRY_VC3",declarations:[{type:"node_out",name:"fJ",qualifier:["float"],is_optional:false},{type:"node_out",name:"fK",qualifier:["float"],is_optional:false},{type:"node_out",name:"fL",qualifier:["float"],is_optional:false},{type:"node_param",name:"eD",qualifier:["varying","vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fJ","=","eD","[","0","]",";","fK","=","eD","[","1","]",";","fL","=","eD","[","2","]",";","br","(","fJ",
")",";","br","(","fK",")",";","br","(","fL",")",";"]}]},{type:"node",name:"GEOMETRY_NO",declarations:[{type:"node_out",name:"fM",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fM","=","fk",";"]}]},{type:"node",name:"GEOMETRY_FB",declarations:[{type:"node_out",name:"fN",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["INVERT_FRONTFACING"],statements:[{type:"textline",tokens:["fN","=","(","gl_FrontFacing",")",
"?","ZERO_VALUE_NODES",":","UNITY_VALUE_NODES",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["fN","=","(","gl_FrontFacing",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]}]}]}]},{type:"node",name:"GEOMETRY_VW",declarations:[{type:"node_out",name:"fO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fO","=","eM",";"]}]},{type:"node",name:"GEOMETRY_LO",declarations:[{type:"node_out",name:"fP",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",
tokens:["fP","[","0","]","=","fh","[","0","]",";","fP","[","1","]","=","fh","[","1","]",";","fP","[","2","]","=","fh","[","2","]",";"]}]},{type:"node",name:"GEOMETRY_GL",declarations:[{type:"node_out",name:"fQ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fQ","=","vec3","(","fl",".","r",",","-","fl",".","b",",","fl",".","g",")",";"]}]},{type:"node",name:"NEW_GEOMETRY",declarations:[{type:"node_out",name:"fR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"fS",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"fT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"fU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"fV",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"fW",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"fX",qualifier:["float"],is_optional:false},{type:"node_out",name:"fY",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["fR","=","vec3","(","ZERO_VALUE_NODES",
")",";","fS","=","vec3","(","ZERO_VALUE_NODES",")",";","fT","=","vec3","(","ZERO_VALUE_NODES",")",";","fU","=","vec3","(","ZERO_VALUE_NODES",")",";","fV","=","vec3","(","ZERO_VALUE_NODES",")",";","fW","=","vec3","(","ZERO_VALUE_NODES",")",";","fX","=","ZERO_VALUE_NODES",";","fY","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"HUE_SAT",declarations:[{type:"node_in",name:"fZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"f_",qualifier:["float"],is_optional:false},{type:"node_in",name:"ga",
qualifier:["float"],is_optional:false},{type:"node_in",name:"gb",qualifier:["float"],is_optional:false},{type:"node_in",name:"gc",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gd",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fn","=","eq","(","gc",")",";","fn","[","0","]","+=","(","fZ","-","eh",")",";","if","(","fn","[","0","]",">","UNITY_VALUE_NODES",")","fn","[","0","]","-=","UNITY_VALUE_NODES",";","else","if","(","fn","[","0","]","<","ZERO_VALUE_NODES",
")","fn","[","0","]","+=","UNITY_VALUE_NODES",";","fn","*=","vec3","(","UNITY_VALUE_NODES",",","f_",",","ga",")",";","fn","=","mix","(","vec3","(","UNITY_VALUE_NODES",")",",","mix","(","vec3","(","ZERO_VALUE_NODES",")",",","fn",",","step","(","vec3","(","ZERO_VALUE_NODES",")",",","fn",")",")",",","step","(","fn",",","vec3","(","UNITY_VALUE_NODES",")",")",")",";","gd","=","mix","(","gc",",","eu","(","fn",")",",","gb",")",";"]}]},{type:"node",name:"INVERT",declarations:[{type:"node_in",name:"ge",qualifier:["float"],
is_optional:false},{type:"node_in",name:"gf",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gg",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gg","=","mix","(","gf",",","vec3","(","UNITY_VALUE_NODES",")","-","gf",",","ge",")",";"]}]},{type:"node",name:"LAMP",declarations:[{type:"node_out",name:"gh",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"gi",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gj",qualifier:["float"],is_optional:false},
{type:"node_out",name:"gk",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gh"],statements:[{type:"textline",tokens:["gh","=","u_lamp_light_color_intensities","[","LAMP_INDEX","]",";"]}]}]},{type:"textline",tokens:["fi","=","u_lamp_light_factors","[","LAMP_INDEX","]",";","fn","=","u_lamp_light_directions","[","LAMP_INDEX","]",";","fo","=","u_lamp_light_positions","[","LAMP_INDEX","]",";","fa","=","fi",".","z",";","if","(","fa",
"!=","-","UNITY_VALUE_NODES",")","{"]},{type:"textline",tokens:["gi","=","fo","-","bC",";","gj","=","length","(","gi",")",";","gi","=","normalize","(","gi",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gk"],statements:[{type:"textline",tokens:["gk","=","fa","/","(","fa","+","gj","*","gj",")",";","fa","=","fi",".","x",";","fb","=","fi",".","y",";","if","(","fa",">","-","UNITY_VALUE_NODES",")","{","fc","=","dot","(","gi",",","fn",")",";","fc","*=","smoothstep","(","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",",","(","fc","-","fa",")","/","fb",")",";","gk","*=","fc",";","}"]}]}]},{type:"textline",tokens:["}","else","{"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gi"],statements:[{type:"textline",tokens:["gi","=","fn",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gj"],statements:[{type:"textline",tokens:["gj","=","length","(","fo","-","bC",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gk"],
statements:[{type:"textline",tokens:["gk","=","UNITY_VALUE_NODES",";"]}]}]},{type:"textline",tokens:["}"]}]},{type:"node",name:"NORMAL",declarations:[{type:"node_in",name:"gl",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gm",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"gn",qualifier:["float"],is_optional:true},{type:"node_param",name:"eE",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gm"],statements:[{type:"textline",
tokens:["gm","=","eE",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_gn"],statements:[{type:"textline",tokens:["gn","=","-","dot","(","gl",",","eE",")",";"]}]}]}]},{type:"node",name:"B4W_VECTOR_VIEW",declarations:[{type:"node_in",name:"go",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gp",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gp","=","-","(","eN","*","vec4","(","go",",","ZERO_VALUE_NODES",")",")",".","xyz",";"]}]},
{type:"node",name:"BSDF_ANISOTROPIC",declarations:[{type:"node_in",name:"gq",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gr",qualifier:["float"],is_optional:false},{type:"node_in",name:"gs",qualifier:["float"],is_optional:false},{type:"node_in",name:"gt",qualifier:["float"],is_optional:false},{type:"node_in",name:"gu",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gv",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gw",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["gw","=","gq",";"]},{type:"textline",tokens:["gr",";","gs",";","gt",";","gu",";","gv",";"]}]},{type:"node",name:"BSDF_DIFFUSE",declarations:[{type:"node_in",name:"gx",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gy",qualifier:["float"],is_optional:false},{type:"node_in",name:"gz",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gA","=","gx",";"]},{type:"textline",
tokens:["gy",";","gz",";"]}]},{type:"node",name:"BSDF_GLASS",declarations:[{type:"node_in",name:"gB",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gC",qualifier:["float"],is_optional:false},{type:"node_in",name:"gD",qualifier:["float"],is_optional:false},{type:"node_in",name:"gE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gF",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gF","=","gB",";"]},{type:"textline",tokens:["gC",";","gD",";","gE",
";"]}]},{type:"node",name:"BSDF_GLOSSY",declarations:[{type:"node_in",name:"gG",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gH",qualifier:["float"],is_optional:false},{type:"node_in",name:"gI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gJ","=","gG",";"]},{type:"textline",tokens:["gH",";","gI",";"]}]},{type:"node",name:"BSDF_HAIR",declarations:[{type:"node_in",name:"gK",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"gL",qualifier:["float"],is_optional:false},{type:"node_in",name:"gM",qualifier:["float"],is_optional:false},{type:"node_in",name:"gN",qualifier:["float"],is_optional:false},{type:"node_out",name:"gO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gO","=","gK",";"]},{type:"textline",tokens:["gL",";","gM",";","gN",";"]}]},{type:"node",name:"BSDF_TRANSPARENT",declarations:[{type:"node_in",name:"gP",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"gQ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gQ","=","gP",";"]}]},{type:"node",name:"BSDF_TRANSLUCENT",declarations:[{type:"node_in",name:"gR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gS",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gT",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gT","=","gR",";"]},{type:"textline",tokens:["gS",";"]}]},{type:"node",name:"BSDF_REFRACTION",
declarations:[{type:"node_in",name:"gU",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"gV",qualifier:["float"],is_optional:false},{type:"node_in",name:"gW",qualifier:["float"],is_optional:false},{type:"node_in",name:"gX",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"gY",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["gY","[","0","]","=","gY","[","1","]","=","gY","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["gU",";","gV",
";","gW",";","gX",";"]}]},{type:"node",name:"BSDF_TOON",declarations:[{type:"node_in",name:"gZ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"g_",qualifier:["float"],is_optional:false},{type:"node_in",name:"ha",qualifier:["float"],is_optional:false},{type:"node_in",name:"hb",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hc",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hc","=","gZ",";"]},{type:"textline",tokens:["g_",";","ha",";","hb",";"]}]},
{type:"node",name:"BSDF_VELVET",declarations:[{type:"node_in",name:"hd",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"he",qualifier:["float"],is_optional:false},{type:"node_in",name:"hf",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hg",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hg","=","hd",";"]},{type:"textline",tokens:["he",";","hf",";"]}]},{type:"node",name:"SUBSURFACE_SCATTERING",declarations:[{type:"node_in",name:"hh",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"hi",qualifier:["float"],is_optional:false},{type:"node_in",name:"hj",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hk",qualifier:["float"],is_optional:false},{type:"node_in",name:"hl",qualifier:["float"],is_optional:false},{type:"node_in",name:"hm",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hn",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hn","[","0","]","=","hn","[","1","]","=","hn","[","2","]",
"=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hh",";","hj",";","hk",";","hl",";","hm",";","hi",";"]}]},{type:"node",name:"EMISSION",declarations:[{type:"node_in",name:"ho",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hp",qualifier:["float"],is_optional:false},{type:"node_out",name:"hq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hq","=","ho",";"]},{type:"textline",tokens:["hp",";"]}]},{type:"node",name:"AMBIENT_OCCLUSION",declarations:[{type:"node_in",
name:"hr",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hs",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hs","[","0","]","=","hs","[","1","]","=","hs","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hr",";"]}]},{type:"node",name:"HOLDOUT",declarations:[{type:"node_out",name:"ht",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ht","[","0","]","=","ht","[","1","]","=","ht","[","2","]","=","ZERO_VALUE_NODES",
";"]}]},{type:"node",name:"VOLUME_ABSORPTION",declarations:[{type:"node_in",name:"hu",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hv",qualifier:["float"],is_optional:false},{type:"node_out",name:"hw",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hw","[","0","]","=","hw","[","1","]","=","hw","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hu",";","hv",";"]}]},{type:"node",name:"VOLUME_SCATTER",declarations:[{type:"node_in",name:"hx",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hy",qualifier:["float"],is_optional:false},{type:"node_in",name:"hz",qualifier:["float"],is_optional:false},{type:"node_out",name:"hA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hA","[","0","]","=","hA","[","1","]","=","hA","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hx",";","hy",";","hz",";"]}]},{type:"node",name:"BUMP",declarations:[{type:"node_in",name:"hB",qualifier:["float"],is_optional:false},
{type:"node_in",name:"hC",qualifier:["float"],is_optional:false},{type:"node_in",name:"hD",qualifier:["float"],is_optional:false},{type:"node_in",name:"hE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hF",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hF","=","hE",";"]},{type:"textline",tokens:["hB",";","hC",";","hD",";"]}]},{type:"node",name:"NORMAL_MAP",declarations:[{type:"node_in",name:"hG",qualifier:["float"],is_optional:false},{type:"node_in",name:"hH",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hI",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hI","=","hH",";"]},{type:"textline",tokens:["hG",";"]}]},{type:"node",name:"VECT_TRANSFORM",declarations:[{type:"node_in",name:"hJ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hK",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["CONVERT_TYPE","VT_WORLD_TO_WORLD",{type:"equal_expr",
places:2},"CONVERT_TYPE","VT_OBJECT_TO_OBJECT",{type:"equal_expr",places:2},"CONVERT_TYPE","VT_CAMERA_TO_CAMERA",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],statements:[{type:"textline",tokens:["hK","=","hJ",";"]}]},{type:"node_else",statements:[{type:"node_condition",parts:[{type:"node_if",expression:["VECTOR_TYPE","VT_POINT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["fi","=","vec4","(","hJ",",","UNITY_VALUE_NODES",")",";"]}]},{type:"node_else",statements:[{type:"textline",
tokens:["fi","=","vec4","(","hJ",",","ZERO_VALUE_NODES",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["CONVERT_TYPE","VT_WORLD_TO_CAMERA",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","(","eO","*","fi",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_WORLD_TO_OBJECT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","(","eR","*","fi",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE",
"VT_OBJECT_TO_WORLD",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","(","eQ","*","fi",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_OBJECT_TO_CAMERA",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","(","eO","*","eQ","*","fi",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_CAMERA_TO_WORLD",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","(","eP","*","fi",")",".","xyz",
";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_CAMERA_TO_OBJECT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","(","eR","*","eP","*","fi",")",".","xyz",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["VECTOR_TYPE","VT_NORMAL",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["hK","=","normalize","(","hK",")",";"]}]}]}]}]}]},{type:"node",name:"BLACKBODY",declarations:[{type:"node_in",name:"hL",qualifier:["float"],is_optional:false},
{type:"node_out",name:"hM",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hM","[","0","]","=","hM","[","1","]","=","hM","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hL",";"]}]},{type:"node",name:"WAVELENGTH",declarations:[{type:"node_in",name:"hN",qualifier:["float"],is_optional:false},{type:"node_out",name:"hO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hO","[","0","]","=","hO","[","1","]","=","hO","[","2","]",
"=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["hN",";"]}]},{type:"node",name:"SEPXYZ",declarations:[{type:"node_in",name:"hP",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"hQ",qualifier:["float"],is_optional:false},{type:"node_out",name:"hR",qualifier:["float"],is_optional:false},{type:"node_out",name:"hS",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["hQ","=","hP","[","0","]",";","hR","=","hP","[","1","]",";","hS","=","hP","[","2","]",";"]}]},
{type:"node",name:"COMBXYZ",declarations:[{type:"node_in",name:"hT",qualifier:["float"],is_optional:false},{type:"node_in",name:"hU",qualifier:["float"],is_optional:false},{type:"node_in",name:"hV",qualifier:["float"],is_optional:false},{type:"node_out",name:"hW",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["hW","[","0","]","=","hT",";","hW","[","1","]","=","hU",";","hW","[","2","]","=","hV",";"]}]},{type:"node",name:"BRIGHTCONTRAST",declarations:[{type:"node_in",name:"hX",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"hY",qualifier:["float"],is_optional:false},{type:"node_in",name:"hZ",qualifier:["float"],is_optional:false},{type:"node_out",name:"h_",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fc","=","hY","-","hZ","*","eh",";","h_","=","max","(","(","UNITY_VALUE_NODES","+","hZ",")","*","hX","+","fc",",","vec3","(","ZERO_VALUE_NODES",")",")",";"]}]},{type:"node",name:"LIGHT_FALLOFF",declarations:[{type:"node_in",name:"ia",
qualifier:["float"],is_optional:false},{type:"node_in",name:"ib",qualifier:["float"],is_optional:false},{type:"node_out",name:"ic",qualifier:["float"],is_optional:false},{type:"node_out",name:"id",qualifier:["float"],is_optional:false},{type:"node_out",name:"ie",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ic","=","id","=","ie","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["ia",";","ib",";"]}]},{type:"node",name:"TEX_IMAGE",declarations:[{type:"node_in",name:"ig",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ih",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ii",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ih","[","0","]","=","ih","[","1","]","=","ih","[","2","]","=","ZERO_VALUE_NODES",";","ii","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["ig",";"]}]},{type:"node",name:"TEX_ENVIRONMENT",declarations:[{type:"node_in",name:"ij",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ik",
qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ik","[","0","]","=","ik","[","1","]","=","ik","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["ij",";"]}]},{type:"node",name:"TEX_SKY",declarations:[{type:"node_in",name:"il",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"im",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["im","[","0","]","=","im","[","1","]","=","im","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",
tokens:["il",";"]}]},{type:"node",name:"TEX_NOISE",declarations:[{type:"node_in",name:"io",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ip",qualifier:["float"],is_optional:false},{type:"node_in",name:"iq",qualifier:["float"],is_optional:false},{type:"node_in",name:"ir",qualifier:["float"],is_optional:false},{type:"node_out",name:"is",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"it",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["is","[",
"0","]","=","is","[","1","]","=","is","[","2","]","=","ZERO_VALUE_NODES",";","it","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["io",";","ip",";","iq",";","ir",";"]}]},{type:"node",name:"TEX_WAVE",declarations:[{type:"node_in",name:"iu",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iv",qualifier:["float"],is_optional:false},{type:"node_in",name:"iw",qualifier:["float"],is_optional:false},{type:"node_in",name:"ix",qualifier:["float"],is_optional:false},{type:"node_in",name:"iy",
qualifier:["float"],is_optional:false},{type:"node_out",name:"iz",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iA",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["iz","[","0","]","=","iz","[","1","]","=","iz","[","2","]","=","ZERO_VALUE_NODES",";","iA","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iu",";","iv",";","iw",";","ix",";","iy",";"]}]},{type:"node",name:"TEX_VORONOI",declarations:[{type:"node_in",name:"iB",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"iC",qualifier:["float"],is_optional:false},{type:"node_out",name:"iD",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iE",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["iD","[","0","]","=","iD","[","1","]","=","iD","[","2","]","=","ZERO_VALUE_NODES",";","iE","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iB",";","iC",";"]}]},{type:"node",name:"TEX_MUSGRAVE",declarations:[{type:"node_in",name:"iF",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"iG",qualifier:["float"],is_optional:false},{type:"node_in",name:"iH",qualifier:["float"],is_optional:false},{type:"node_in",name:"iI",qualifier:["float"],is_optional:false},{type:"node_in",name:"iJ",qualifier:["float"],is_optional:false},{type:"node_in",name:"iK",qualifier:["float"],is_optional:false},{type:"node_in",name:"iL",qualifier:["float"],is_optional:false},{type:"node_out",name:"iM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iN",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["iM","[","0","]","=","iM","[","1","]","=","iM","[","2","]","=","ZERO_VALUE_NODES",";","iN","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iF",";","iG",";","iH",";","iI",";","iJ",";","iK",";","iL",";"]}]},{type:"node",name:"TEX_GRADIENT",declarations:[{type:"node_in",name:"iO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iP",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"iQ",qualifier:["float"],is_optional:false}],
statements:[{type:"textline",tokens:["iP","[","0","]","=","iP","[","1","]","=","iP","[","2","]","=","ZERO_VALUE_NODES",";","iQ","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iO",";"]}]},{type:"node",name:"TEX_MAGIC",declarations:[{type:"node_in",name:"iR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iS",qualifier:["float"],is_optional:false},{type:"node_in",name:"iT",qualifier:["float"],is_optional:false},{type:"node_out",name:"iU",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"iV",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["iU","[","0","]","=","iU","[","1","]","=","iU","[","2","]","=","ZERO_VALUE_NODES",";","iV","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iR",";","iS",";","iT",";"]}]},{type:"node",name:"TEX_CHECKER",declarations:[{type:"node_in",name:"iW",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iX",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"iY",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"iZ",qualifier:["float"],is_optional:false},{type:"node_out",name:"i_",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ja",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["i_","[","0","]","=","i_","[","1","]","=","i_","[","2","]","=","ZERO_VALUE_NODES",";","ja","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["iW",";","iX",";","iY",";","iZ",";"]}]},{type:"node",name:"TEX_BRICK",declarations:[{type:"node_in",name:"jb",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"jc",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jd",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"je",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jf",qualifier:["float"],is_optional:false},{type:"node_in",name:"jg",qualifier:["float"],is_optional:false},{type:"node_in",name:"jh",qualifier:["float"],is_optional:false},{type:"node_in",name:"ji",qualifier:["float"],is_optional:false},{type:"node_in",name:"jj",qualifier:["float"],
is_optional:false},{type:"node_out",name:"jk",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jl",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jk","[","0","]","=","jk","[","1","]","=","jk","[","2","]","=","ZERO_VALUE_NODES",";","jl","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["jb",";","jc",";","jd",";","je",";","jf",";","jg",";","jh",";","ji",";","jj",";"]}]},{type:"node",name:"ADD_SHADER",declarations:[{type:"node_in",name:"jm",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"jn",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jo",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jo","=","clamp","(","jm","+","jn",",","vec3","(","ZERO_VALUE_NODES",")",",","vec3","(","UNITY_VALUE_NODES",")",")",";"]}]},{type:"node",name:"MIX_SHADER",declarations:[{type:"node_in",name:"jp",qualifier:["float"],is_optional:false},{type:"node_in",name:"jq",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"jr",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"js",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fc","=","clamp","(","jp",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","js","=","fc","*","jq","+","(","UNITY_VALUE_NODES","-","fc",")","*","jr",";"]}]},{type:"node",name:"UV_MERGED",declarations:[{type:"node_out",name:"jt",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ju",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"eF",
qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_jt"],statements:[{type:"textline",tokens:["jt","=","ew","(","eF",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_ju"],statements:[{type:"textline",tokens:["ju","=","vec3","(","eF",",","ZERO_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"TEX_COORD_UV",declarations:[{type:"node_out",name:"jv",qualifier:["vec3"],is_optional:false},{type:"node_param",
name:"eG",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["jv","=","vec3","(","eG",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"TEX_COORD_NO",declarations:[{type:"node_out",name:"jw",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jw","=","fm",";"]}]},{type:"node",name:"TEX_COORD_GE",declarations:[{type:"node_out",name:"jx",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jx","=","eg",";"]}]},{type:"node",
name:"TEX_COORD_OB",declarations:[{type:"node_out",name:"jy",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jy","[","0","]","=","jy","[","1","]","=","jy","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_CA",declarations:[{type:"node_out",name:"jz",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jz","[","0","]","=","fh","[","0","]",";","jz","[","1","]","=","fh","[","1","]",";","jz","[","2","]","=","UNITY_VALUE_NODES",
";"]}]},{type:"node",name:"TEX_COORD_WI",declarations:[{type:"node_out",name:"jA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jA","[","0","]","=","jA","[","1","]","=","jA","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_RE",declarations:[{type:"node_out",name:"jB",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jB","[","0","]","=","jB","[","1","]","=","jB","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",
name:"UVMAP",declarations:[{type:"node_out",name:"jC",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"eH",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["jC","=","vec3","(","eH",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"PARTICLE_INFO",declarations:[{type:"node_out",name:"jD",qualifier:["float"],is_optional:false},{type:"node_out",name:"jE",qualifier:["float"],is_optional:false},{type:"node_out",name:"jF",qualifier:["float"],is_optional:false},
{type:"node_out",name:"jG",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jH",qualifier:["float"],is_optional:false},{type:"node_out",name:"jI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jD","=","ZERO_VALUE_NODES",";","jE","=","ZERO_VALUE_NODES",";","jF","=","ZERO_VALUE_NODES",";","jG","=","vec3","(","ZERO_VALUE_NODES",")",";","jH","=","ZERO_VALUE_NODES",";","jI","=","jG",";","jJ","=",
"jG",";"]}]},{type:"node",name:"HAIR_INFO",declarations:[{type:"node_out",name:"jK",qualifier:["float"],is_optional:false},{type:"node_out",name:"jL",qualifier:["float"],is_optional:false},{type:"node_out",name:"jM",qualifier:["float"],is_optional:false},{type:"node_out",name:"jN",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jK","=","ZERO_VALUE_NODES",";","jL","=","ZERO_VALUE_NODES",";","jM","=","ZERO_VALUE_NODES",";","jN","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},
{type:"node",name:"OBJECT_INFO",declarations:[{type:"node_out",name:"jO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jP",qualifier:["float"],is_optional:false},{type:"node_out",name:"jQ",qualifier:["float"],is_optional:false},{type:"node_out",name:"jR",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jP","=","ZERO_VALUE_NODES",";","jQ","=","ZERO_VALUE_NODES",";","jR","=","ZERO_VALUE_NODES",";","jO","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",
name:"WIREFRAME",declarations:[{type:"node_in",name:"jS",qualifier:["float"],is_optional:false},{type:"node_out",name:"jT",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jT","=","jS",";"]}]},{type:"node",name:"TANGENT",declarations:[{type:"node_out",name:"jU",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["jU","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"LAYER_WEIGHT",declarations:[{type:"node_in",name:"jV",qualifier:["float"],
is_optional:false},{type:"node_in",name:"jW",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"jX",qualifier:["float"],is_optional:false},{type:"node_out",name:"jY",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jX","=","jY","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["jW",";","jV",";"]}]},{type:"node",name:"LIGHT_PATH",declarations:[{type:"node_out",name:"jZ",qualifier:["float"],is_optional:false},{type:"node_out",name:"j_",qualifier:["float"],
is_optional:false},{type:"node_out",name:"ka",qualifier:["float"],is_optional:false},{type:"node_out",name:"kb",qualifier:["float"],is_optional:false},{type:"node_out",name:"kc",qualifier:["float"],is_optional:false},{type:"node_out",name:"kd",qualifier:["float"],is_optional:false},{type:"node_out",name:"ke",qualifier:["float"],is_optional:false},{type:"node_out",name:"kf",qualifier:["float"],is_optional:false},{type:"node_out",name:"kg",qualifier:["float"],is_optional:false},{type:"node_out",name:"kh",
qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["jZ","=","j_","=","ka","=","ZERO_VALUE_NODES",";","kb","=","kc","=","kd","=","ZERO_VALUE_NODES",";","ke","=","ke","=","kg","=","kh","=","ZERO_VALUE_NODES",";","kf","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"ATTRIBUTE",declarations:[{type:"node_out",name:"ki",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kj",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kk",qualifier:["float"],is_optional:false}],
statements:[{type:"textline",tokens:["ki","=","kj","=","vec3","(","ZERO_VALUE_NODES",")",";","kk","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"SCRIPT",declarations:[],statements:[]},{type:"node",name:"CURVE_VEC",declarations:[{type:"node_in",name:"kl",qualifier:["float"],is_optional:false},{type:"node_in",name:"km",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kn",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kn","=","km",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["READ_R"],statements:[{type:"textline",tokens:["kn",".","r","=","(","texture2D","(","u_nodes_texture",",","vec2","(","0.5","*","km",".","r","+","0.5",",","NODE_TEX_ROW",")",")",".","r","-","0.5",")","*","2.0",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_G"],statements:[{type:"textline",tokens:["kn",".","g","=","(","texture2D","(","u_nodes_texture",",","vec2","(","0.5","*","km",".","g","+","0.5",",","NODE_TEX_ROW",")",")",".","g","-",
"0.5",")","*","2.0",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_B"],statements:[{type:"textline",tokens:["kn",".","b","=","(","texture2D","(","u_nodes_texture",",","vec2","(","0.5","*","km",".","b","+","0.5",",","NODE_TEX_ROW",")",")",".","b","-","0.5",")","*","2.0",";"]}]}]},{type:"textline",tokens:["kn","=","mix","(","km",",","kn",",","kl",")",";"]}]},{type:"node",name:"CURVE_RGB",declarations:[{type:"node_in",name:"ko",qualifier:["float"],is_optional:false},{type:"node_in",
name:"kp",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kq",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["READ_A"],statements:[{type:"textline",tokens:["fc","=","texture2D","(","u_nodes_texture",",","vec2","(","kp",".","r",",","NODE_TEX_ROW",")",")",".","a",";","fb","=","texture2D","(","u_nodes_texture",",","vec2","(","kp",".","g",",","NODE_TEX_ROW",")",")",".","a",";","fa","=","texture2D","(","u_nodes_texture",",","vec2",
"(","kp",".","b",",","NODE_TEX_ROW",")",")",".","a",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["fc","=","kp",".","r",";","fb","=","kp",".","g",";","fa","=","kp",".","b",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_R"],statements:[{type:"textline",tokens:["kq",".","r","=","texture2D","(","u_nodes_texture",",","vec2","(","fc",",","NODE_TEX_ROW",")",")",".","r",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["kq",".","r","=","fc",";"]}]}]},
{type:"node_condition",parts:[{type:"node_if",expression:["READ_G"],statements:[{type:"textline",tokens:["kq",".","g","=","texture2D","(","u_nodes_texture",",","vec2","(","fb",",","NODE_TEX_ROW",")",")",".","g",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["kq",".","g","=","fb",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_B"],statements:[{type:"textline",tokens:["kq",".","b","=","texture2D","(","u_nodes_texture",",","vec2","(","fa",",","NODE_TEX_ROW",
")",")",".","b",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["kq",".","b","=","fa",";"]}]}]},{type:"textline",tokens:["kq","=","mix","(","kp",",","kq",",","ko",")",";"]}]},{type:"node",name:"VALTORGB",declarations:[{type:"node_in",name:"kr",qualifier:["float"],is_optional:false},{type:"node_out",name:"ks",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kt",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["fi","=","texture2D","(","u_nodes_texture",
",","vec2","(","kr",",","NODE_TEX_ROW",")",")",";","ks","=","fi",".","rgb",";","kt","=","fi",".","a",";"]}]},{type:"node",name:"MAPPING",declarations:[{type:"node_in",name:"ku",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"kv",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["kv","=","ku",";"]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_TRS_MATRIX",statements:[{type:"textline",tokens:["kv","=","(","MAPPING_TRS_MATRIX","*","vec4","(","kv",
",","UNITY_VALUE_NODES",")",")",".","xyz",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_SCALE",statements:[{type:"textline",tokens:["kv","=","kv","*","MAPPING_SCALE",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_TRANSLATION",statements:[{type:"textline",tokens:["kv","=","kv","+","MAPPING_TRANSLATION",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_MIN_CLIP",statements:[{type:"textline",tokens:["kv","=","max","(","kv",",",
"MAPPING_MIN_CLIP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_MAX_CLIP",statements:[{type:"textline",tokens:["kv","=","min","(","kv",",","MAPPING_MAX_CLIP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MAPPING_IS_NORMAL"],statements:[{type:"textline",tokens:["kv","=","normalize","(","kv",")",";"]}]}]}]},{type:"node",name:"MATH_ADD",declarations:[{type:"node_in",name:"kw",qualifier:["float"],is_optional:false},{type:"node_in",name:"kx",qualifier:["float"],
is_optional:false},{type:"node_out",name:"ky",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ky","=","kw","+","kx",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["ky","=","clamp","(","ky",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_SUBTRACT",declarations:[{type:"node_in",name:"kz",qualifier:["float"],is_optional:false},{type:"node_in",name:"kA",qualifier:["float"],
is_optional:false},{type:"node_out",name:"kB",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kB","=","kz","-","kA",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kB","=","clamp","(","kB",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MULTIPLY",declarations:[{type:"node_in",name:"kC",qualifier:["float"],is_optional:false},{type:"node_in",name:"kD",qualifier:["float"],
is_optional:false},{type:"node_out",name:"kE",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kE","=","kC","*","kD",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kE","=","clamp","(","kE",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_DIVIDE",declarations:[{type:"node_in",name:"kF",qualifier:["float"],is_optional:false},{type:"node_in",name:"kG",qualifier:["float"],
is_optional:false},{type:"node_out",name:"kH",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kH","=","(","kG","!=","ZERO_VALUE_NODES",")","?","kF","/","kG",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kH","=","clamp","(","kH",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_SINE",declarations:[{type:"node_in",name:"kI",qualifier:["float"],
is_optional:false},{type:"node_in",name:"kJ",qualifier:["float"],is_optional:false},{type:"node_out",name:"kK",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kK","=","sin","(","kI",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kK","=","clamp","(","kK",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["kJ",";"]}]},{type:"node",name:"MATH_COSINE",declarations:[{type:"node_in",
name:"kL",qualifier:["float"],is_optional:false},{type:"node_in",name:"kM",qualifier:["float"],is_optional:false},{type:"node_out",name:"kN",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kN","=","cos","(","kL",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kN","=","clamp","(","kN",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["kM",";"]}]},{type:"node",
name:"MATH_TANGENT",declarations:[{type:"node_in",name:"kO",qualifier:["float"],is_optional:false},{type:"node_in",name:"kP",qualifier:["float"],is_optional:false},{type:"node_out",name:"kQ",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kQ","=","tan","(","kO",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kQ","=","clamp","(","kQ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},
{type:"textline",tokens:["kP",";"]}]},{type:"node",name:"MATH_ARCSINE",declarations:[{type:"node_in",name:"kR",qualifier:["float"],is_optional:false},{type:"node_in",name:"kS",qualifier:["float"],is_optional:false},{type:"node_out",name:"kT",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kT","=","(","kR","<=","UNITY_VALUE_NODES","&&","kR",">=","-","UNITY_VALUE_NODES",")","?","asin","(","kR",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",
expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kT","=","clamp","(","kT",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["kS",";"]}]},{type:"node",name:"MATH_ARCCOSINE",declarations:[{type:"node_in",name:"kU",qualifier:["float"],is_optional:false},{type:"node_in",name:"kV",qualifier:["float"],is_optional:false},{type:"node_out",name:"kW",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kW","=","(","kU","<=","UNITY_VALUE_NODES",
"&&","kU",">=","-","UNITY_VALUE_NODES",")","?","acos","(","kU",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kW","=","clamp","(","kW",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["kV",";"]}]},{type:"node",name:"MATH_ARCTANGENT",declarations:[{type:"node_in",name:"kX",qualifier:["float"],is_optional:false},{type:"node_in",name:"kY",qualifier:["float"],is_optional:false},
{type:"node_out",name:"kZ",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["kZ","=","atan","(","kX",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["kZ","=","clamp","(","kZ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["kY",";"]}]},{type:"node",name:"MATH_POWER",declarations:[{type:"node_in",name:"k_",qualifier:["float"],is_optional:false},{type:"node_in",
name:"la",qualifier:["float"],is_optional:false},{type:"node_out",name:"lb",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["if","(","k_","<","ZERO_VALUE_NODES","&&","la","!=","floor","(","la",")",")","lb","=","ZERO_VALUE_NODES",";","else","if","(","la","==","ZERO_VALUE_NODES",")"]},{type:"textline",tokens:["lb","=","UNITY_VALUE_NODES",";","else","if","(","k_","<","ZERO_VALUE_NODES",")","lb","=","mix","(","UNITY_VALUE_NODES",",","-","UNITY_VALUE_NODES",",","sign","(",
"mod","(","-","la",",","2.0",")",")",")","*","pow","(","-","k_",",","la",")",";","else","if","(","k_","==","ZERO_VALUE_NODES",")","lb","=","ZERO_VALUE_NODES",";","else","lb","=","pow","(","k_",",","la",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lb","=","clamp","(","lb",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_LOGARITHM",declarations:[{type:"node_in",name:"lc",qualifier:["float"],
is_optional:false},{type:"node_in",name:"ld",qualifier:["float"],is_optional:false},{type:"node_out",name:"le",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["le","=","(","lc",">","ZERO_VALUE_NODES","&&","ld",">","ZERO_VALUE_NODES",")","?","log2","(","lc",")","/","log2","(","ld",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["le","=","clamp","(","le",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MINIMUM",declarations:[{type:"node_in",name:"lf",qualifier:["float"],is_optional:false},{type:"node_in",name:"lg",qualifier:["float"],is_optional:false},{type:"node_out",name:"lh",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lh","=","min","(","lf",",","lg",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lh","=","clamp","(","lh",
",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MAXIMUM",declarations:[{type:"node_in",name:"li",qualifier:["float"],is_optional:false},{type:"node_in",name:"lj",qualifier:["float"],is_optional:false},{type:"node_out",name:"lk",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lk","=","max","(","li",",","lj",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lk",
"=","clamp","(","lk",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_ROUND",declarations:[{type:"node_in",name:"ll",qualifier:["float"],is_optional:false},{type:"node_in",name:"lm",qualifier:["float"],is_optional:false},{type:"node_out",name:"ln",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ln","=","floor","(","ll","+","eh",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",
tokens:["ln","=","clamp","(","ln",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["lm",";"]}]},{type:"node",name:"MATH_LESS_THAN",declarations:[{type:"node_in",name:"lo",qualifier:["float"],is_optional:false},{type:"node_in",name:"lp",qualifier:["float"],is_optional:false},{type:"node_out",name:"lq",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lq","=","(","lo","<","lp",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lq","=","clamp","(","lq",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_GREATER_THAN",declarations:[{type:"node_in",name:"lr",qualifier:["float"],is_optional:false},{type:"node_in",name:"ls",qualifier:["float"],is_optional:false},{type:"node_out",name:"lt",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lt","=","(","lr",">","ls",")","?","UNITY_VALUE_NODES",
":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lt","=","clamp","(","lt",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MODULO",declarations:[{type:"node_in",name:"lu",qualifier:["float"],is_optional:false},{type:"node_in",name:"lv",qualifier:["float"],is_optional:false},{type:"node_out",name:"lw",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["lw","=","abs","(","lv",")",">","0.000001","?","mod","(","lu",",","lv",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lw","=","clamp","(","lw",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_ABSOLUTE",declarations:[{type:"node_in",name:"lx",qualifier:["float"],is_optional:false},{type:"node_in",name:"ly",qualifier:["float"],is_optional:false},{type:"node_out",
name:"lz",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["lz","=","abs","(","lx",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["lz","=","clamp","(","lz",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["ly",";"]}]},{type:"node",name:"MIX_RGB_MIX",declarations:[{type:"node_in",name:"lA",qualifier:["float"],is_optional:false},{type:"node_in",name:"lB",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"lC",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"lD",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","lA",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","lD","=","mix","(","lB",",","lC",",","fa",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["lD","=","clamp","(","lD",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";"]}]}]}]},{type:"node",name:"MIX_RGB_ADD",declarations:[{type:"node_in",name:"lE",qualifier:["float"],is_optional:false},{type:"node_in",name:"lF",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"lG",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"lH",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","lE",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","lH","=","mix","(","lF",",","lF","+","lG",",","fa",")",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["lH","=","clamp","(","lH",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_MULTIPLY",declarations:[{type:"node_in",name:"lI",qualifier:["float"],is_optional:false},{type:"node_in",name:"lJ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"lK",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"lL",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",
tokens:["fa","=","clamp","(","lI",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","lL","=","mix","(","lJ",",","lJ","*","lK",",","fa",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["lL","=","clamp","(","lL",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SUBTRACT",declarations:[{type:"node_in",name:"lM",qualifier:["float"],is_optional:false},{type:"node_in",name:"lN",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"lO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"lP",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","lM",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","lP","=","mix","(","lN",",","lN","-","lO",",","fa",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["lP","=","clamp","(","lP",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SCREEN",declarations:[{type:"node_in",name:"lQ",qualifier:["float"],is_optional:false},{type:"node_in",name:"lR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"lS",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"lT",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","lQ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","UNITY_VALUE_NODES","-","fa",";","lT","=","vec3","(",
"UNITY_VALUE_NODES",")","-","(","vec3","(","fb",")","+","fa","*","(","vec3","(","UNITY_VALUE_NODES",")","-","lS",")",")","*","(","vec3","(","UNITY_VALUE_NODES",")","-","lR",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["lT","=","clamp","(","lT",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DIVIDE",declarations:[{type:"node_in",name:"lU",qualifier:["float"],is_optional:false},
{type:"node_in",name:"lV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"lW",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"lX",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","lU",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","UNITY_VALUE_NODES","-","fa",";","lW","+=","step","(","lW",",","vec3","(","ZERO_VALUE_NODES",")",")",";","lX","=","fb","*","lV","+","fa","*","lV","/","lW",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["lX","=","clamp","(","lX",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DIFFERENCE",declarations:[{type:"node_in",name:"lY",qualifier:["float"],is_optional:false},{type:"node_in",name:"lZ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"l_",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ma",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",
tokens:["fa","=","clamp","(","lY",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","ma","=","mix","(","lZ",",","abs","(","lZ","-","l_",")",",","fa",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["ma","=","clamp","(","ma",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DARKEN",declarations:[{type:"node_in",name:"mb",qualifier:["float"],is_optional:false},{type:"node_in",name:"mc",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"md",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"me",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mb",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","me","=","min","(","mc",".","rgb",",","md",".","rgb","*","fa",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["me","=","clamp","(","me",",",
"ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_LIGHTEN",declarations:[{type:"node_in",name:"mf",qualifier:["float"],is_optional:false},{type:"node_in",name:"mg",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mh",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mi",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mf",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mi","=","max",
"(","mg",".","rgb",",","mh",".","rgb","*","fa",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mi","=","clamp","(","mi",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_OVERLAY",declarations:[{type:"node_in",name:"mj",qualifier:["float"],is_optional:false},{type:"node_in",name:"mk",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ml",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"mm",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mj",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fo","=","vec3","(","UNITY_VALUE_NODES","-","fa",")",";","mm","=","mix","(","mk","*","(","fo","+","2.0","*","fa","*","ml",")",",","vec3","(","UNITY_VALUE_NODES",")","-","(","fo","+","2.0","*","fa","*","(","vec3","(","UNITY_VALUE_NODES",")","-","ml",")",")","*","(","vec3","(","UNITY_VALUE_NODES",")","-","mk",")",",",
"step","(","eh",",","mk",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mm","=","clamp","(","mm",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DODGE",declarations:[{type:"node_in",name:"mn",qualifier:["float"],is_optional:false},{type:"node_in",name:"mo",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mp",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"mq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mn",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fo","=","vec3","(","UNITY_VALUE_NODES",")","-","fa","*","mp",";","fn","=","clamp","(","mo","/","fo",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mq","=","mix","(","mix","(","fn",",","vec3","(","UNITY_VALUE_NODES",")",",","step","(","fo",",","vec3","(","ZERO_VALUE_NODES",")",")",")",",","mo",",","step","(","mo",",","vec3",
"(","ZERO_VALUE_NODES",")",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mq","=","clamp","(","mq",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_BURN",declarations:[{type:"node_in",name:"mr",qualifier:["float"],is_optional:false},{type:"node_in",name:"ms",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mt",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"mu",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mr",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fo","=","vec3","(","UNITY_VALUE_NODES","-","fa",")",";","fo","=","fo","+","fa","*","mt",";","fn","=","clamp","(","vec3","(","UNITY_VALUE_NODES",")","-","(","vec3","(","UNITY_VALUE_NODES",")","-","ms",")","/","fo",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mu","=","mix","(","fn",",","vec3","(","ZERO_VALUE_NODES",")",",",
"step","(","fo",",","vec3","(","ZERO_VALUE_NODES",")",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mu","=","clamp","(","mu",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_HUE",declarations:[{type:"node_in",name:"mv",qualifier:["float"],is_optional:false},{type:"node_in",name:"mw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mx",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"my",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mv",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","my","=","mw",";","fn","=","eq","(","mx",")",";","if","(","fn",".","y","!=","ZERO_VALUE_NODES",")","{","fo","=","eq","(","my",")",";","fo",".","x","=","fn",".","x",";","fp","=","eu","(","fo",")",";","my","=","mix","(","my",",","fp",",","fa",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],
statements:[{type:"textline",tokens:["my","=","clamp","(","my",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SATURATION",declarations:[{type:"node_in",name:"mz",qualifier:["float"],is_optional:false},{type:"node_in",name:"mA",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mB",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mC",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mz",
",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","UNITY_VALUE_NODES","-","fa",";","mC","=","mA",";","fp","=","eq","(","mC",")",";","if","(","fp",".","y","!=","ZERO_VALUE_NODES",")","{","fo","=","eq","(","mB",")",";","fp",".","y","=","fb","*","fp",".","y","+","fa","*","fo",".","y",";","mC","=","eu","(","fp",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mC","=","clamp","(","mC",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_VALUE",declarations:[{type:"node_in",name:"mD",qualifier:["float"],is_optional:false},{type:"node_in",name:"mE",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mF",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mG",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mD",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","UNITY_VALUE_NODES","-","fa",
";","fp","=","eq","(","mE",")",";","fo","=","eq","(","mF",")",";","fp",".","z","=","fb","*","fp",".","z","+","fa","*","fo",".","z",";","mG","=","eu","(","fp",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mG","=","clamp","(","mG",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_COLOR",declarations:[{type:"node_in",name:"mH",qualifier:["float"],is_optional:false},{type:"node_in",
name:"mI",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mJ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mK",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mH",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mK","=","mI",";","fo","=","eq","(","mJ",")",";","if","(","fo",".","y","!=","ZERO_VALUE_NODES",")","{","fp","=","eq","(","mK",")",";","fp",".","x","=","fo",".","x",";","fp",".","y","=","fo",".","y",";","fn",
"=","eu","(","fp",")",";","mK","=","mix","(","mK",",","fn",",","fa",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mK","=","clamp","(","mK",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SOFT_LIGHT",declarations:[{type:"node_in",name:"mL",qualifier:["float"],is_optional:false},{type:"node_in",name:"mM",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mN",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"mO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mL",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","UNITY_VALUE_NODES","-","fa",";","fn","=","mN","+","mM","-","mN","*","mM",";","mO","=","mM","*","(","vec3","(","fb",")","+","vec3","(","fa",")","*","(","(","vec3","(","UNITY_VALUE_NODES",")","-","mM",")","*","mN","+","fn",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],
statements:[{type:"textline",tokens:["mO","=","clamp","(","mO",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_LINEAR_LIGHT",declarations:[{type:"node_in",name:"mP",qualifier:["float"],is_optional:false},{type:"node_in",name:"mQ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"mS",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["fa","=","clamp","(","mP",
",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","mS","=","mQ","+","fa","*","(","2.0","*","mR","-","vec3","(","UNITY_VALUE_NODES",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["mS","=","clamp","(","mS",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"OUTPUT",declarations:[{type:"node_in",name:"mT",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mU",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["eS","=","mT",";","eW","=","mU",";"]}]},{type:"node",name:"MATERIAL_BEGIN",declarations:[{type:"node_in",name:"mV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mW",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"mX",qualifier:["float"],is_optional:false},{type:"node_in",name:"mY",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"mZ",qualifier:["float"],is_optional:true},{type:"node_out",name:"m_",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"na",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nb",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nc",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nd",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"ne",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"nf",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"ng",qualifier:["vec4"],is_optional:false},{type:"node_param",name:"eI",
qualifier:["const","vec2"],is_optional:false},{type:"node_param",name:"eJ",qualifier:["const","vec3"],is_optional:false}],statements:[{type:"textline",tokens:["nb","=","clamp","(","mV",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"textline",tokens:["nc","=","eJ","[","0","]","*","clamp","(","mW",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_NORMAL"],statements:[{type:"textline",tokens:["nd","=","normalize",
"(","mY",")",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["nd","=","fm",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["SHADELESS_MAT",{type:"logic_negative_expr",places:1}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT"],statements:[{type:"textline",tokens:["m_","=","mZ","*","nb",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["m_","=","eZ","*","nb",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_MATERIAL_DIFFUSE"],statements:[{type:"textline",tokens:["nb","*=","mX",";"]}]}]},{type:"textline",tokens:["na","=","e_","*","u_environment_energy","*","dS","(","nd",")",";","ng","=","du","(","nb",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],statements:[{type:"textline",tokens:["ne","=","vec2","(","eI","[","0","]",",","eI","[","1","]",")",";"]},{type:"textline",tokens:["nf","=","vec2","(","eJ","[","1","]",",","eJ","[",
"2","]",")",";"]}]}]},{type:"textline",tokens:["eV","=","ng",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["m_","=","vec3","(","ZERO_VALUE_NODES",")",";","na","=","vec3","(","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATERIAL_END",declarations:[{type:"node_in",name:"nh",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"ni",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nj",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nk",qualifier:["float"],
is_optional:true},{type:"node_in",name:"nl",qualifier:["float"],is_optional:true},{type:"node_in",name:"nm",qualifier:["float"],is_optional:true},{type:"node_out",name:"nn",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"no",qualifier:["float"],is_optional:true},{type:"node_out",name:"np",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"nq",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"nr",qualifier:["vec3"],is_optional:true},{type:"node_param",name:"eK",qualifier:["float"],
is_optional:false},{type:"node_param",name:"eL",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_nn"],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_DIFFUSE"],statements:[{type:"textline",tokens:["nn","=","nh",".","rgb",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["nn","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT",
"REFLECTION_TYPE","REFL_NONE",{type:"non_equal_expr",places:2},{type:"logical_and_expr",places:2}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["REFLECTION_TYPE","REFL_PLANE",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["dP","(","nn",",","eM",",","nj",",","nk",",","eN",")",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["dP","(","nn",",","eM",",","nj",",","nk",",","mat4","(","ZERO_VALUE_NODES",")",")",";"]}]}]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["nn","+=","ni",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_np"],statements:[{type:"textline",tokens:["np","=","nj",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT"],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_nq"],statements:[{type:"textline",tokens:["nq","=","nh",".","rgb",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_nr"],statements:[{type:"textline",tokens:["nr","=","ni",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_no"],statements:[{type:"textline",tokens:["no","=","clamp","(","nm",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["fa","=","max","(","max","(","ni",".","r",",","ni",".","g",")",",","ni",".","b",
")","*","nl",";","no","=","clamp","(","nm","*","(","UNITY_VALUE_NODES","-","fa",")","+","fa",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]}]}]},{type:"node_else",statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_no"],statements:[{type:"textline",tokens:["no","=","clamp","(","eK",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["fa",
"=","max","(","max","(","ni",".","r",",","ni",".","g",")",",","ni",".","b",")","*","eL",";","no","=","eK","*","(","UNITY_VALUE_NODES","-","fa",")","+","fa",";"]}]}]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["eT","=","ni",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["eT","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["eU","=","nj",";"]}]},{type:"node",name:"LIGHTING_AMBIENT",
declarations:[{type:"node_in",name:"ns",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nt",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nu",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nv",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"nw",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["nv","=","vec4","(","ns","+","nu","*","nt",",","ZERO_VALUE_NODES",")",";","nw","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",
name:"LIGHTING_LAMP",declarations:[{type:"node_in",name:"nx",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"ny",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nz",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"nA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"nB",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["nz","=","u_light_factors","[","LAMP_LIGHT_FACT_IND","]",".","LAMP_FAC_CHANNELS",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["LAMP_TYPE","HEMI",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["nB","=","eh",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["nB","=","ZERO_VALUE_NODES",";"]}]}]},{type:"textline",tokens:["nA","=","u_light_color_intensities","[","LAMP_IND","]",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_SHADOW_MAP_IND",1,{type:"negative_expr",places:1},{type:"non_equal_expr",places:2}],statements:[{type:"textline",tokens:["nA",
"*=","nx","[","LAMP_SHADOW_MAP_IND","]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2},"LAMP_TYPE","POINT",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],statements:[{type:"textline",tokens:["fn","=","u_light_positions","[","LAMP_IND","]",";","ny","=","fn","-","fl",";"]},{type:"textline",tokens:["fa","=","length","(","ny",")",";","nA","*=","LAMP_LIGHT_DIST","/","(","LAMP_LIGHT_DIST","+","fa","*","fa",")",";","ny",
"=","normalize","(","ny",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["fn","=","u_light_directions","[","LAMP_IND","]",";","fa","=","dot","(","ny",",","fn",")",";","fa","*=","smoothstep","(","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",",","(","fa","-","LAMP_SPOT_SIZE",")","/","LAMP_SPOT_BLEND",")",";","nA","*=","fa",";"]}]}]}]},{type:"node_else",statements:[{type:"textline",tokens:["ny","=",
"u_light_directions","[","LAMP_IND","]",";"]}]}]}]},{type:"node",name:"DIFFUSE_FRESNEL",declarations:[{type:"node_in",name:"nC",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nD",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"nE",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nF",qualifier:["float"],is_optional:false},{type:"node_in",name:"nG",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"nH",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["nH","=","ZERO_VALUE_NODES",";","if","(","nD",".","r","!=","ZERO_VALUE_NODES",")","{","fa","=","(","UNITY_VALUE_NODES","-","nF",")","*","dot","(","nE",",","nC",")","+","nF",";","if","(","nG","[","0","]","==","ZERO_VALUE_NODES",")","{","nH","=","UNITY_VALUE_NODES",";","}","else","{","fa","=","UNITY_VALUE_NODES","+","abs","(","fa",")",";","fa","=","nG","[","1","]","+","(","UNITY_VALUE_NODES","-","nG","[","1","]",")","*","pow","(","fa",",","nG","[","0","]",")",";","nH","=","clamp","(","fa",",",
"ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","}","nH","=","max","(","nH",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_LAMBERT",declarations:[{type:"node_in",name:"nI",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nJ",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"nK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nL",qualifier:["float"],is_optional:false},{type:"node_out",name:"nM",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["nM","=","ZERO_VALUE_NODES",";","if","(","nJ",".","r","!=","ZERO_VALUE_NODES",")","{","fa","=","(","UNITY_VALUE_NODES","-","nL",")","*","dot","(","nK",",","nI",")","+","nL",";","nM","=","max","(","fa",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_OREN_NAYAR",declarations:[{type:"node_in",name:"nN",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nO",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"nP",qualifier:["vec3"],is_optional:false},{type:"node_in",
name:"nQ",qualifier:["float"],is_optional:false},{type:"node_in",name:"nR",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"nS",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["nS","=","ZERO_VALUE_NODES",";","if","(","nO",".","r","!=","ZERO_VALUE_NODES",")","{","fa","=","(","UNITY_VALUE_NODES","-","nQ",")","*","dot","(","nP",",","nN",")","+","nQ",";","if","(","nR","[","0","]",">","ZERO_VALUE_NODES",")","{","fb","=","max","(","dot","(","nP",",","eM",")",",",
"ZERO_VALUE_NODES",")",";","fc","=","nR","[","0","]","*","nR","[","0","]",";","fd","=","UNITY_VALUE_NODES","-","eh","*","(","fc","/","(","fc","+","0.33",")",")",";","fn","=","nN","-","fa","*","nP",";","fp","=","eM","-","fb","*","nP",";"]},{type:"textline",tokens:["if","(","length","(","fn",")","==","ZERO_VALUE_NODES","||","length","(","fp",")","==","ZERO_VALUE_NODES","||","abs","(","fa",")",">","UNITY_VALUE_NODES","||","abs","(","fb",")",">","UNITY_VALUE_NODES",")"]},{type:"textline",tokens:["nS",
"=","fa","*","fd",";","else","{","fe","=","acos","(","fa",")",";","fb","=","acos","(","fb",")",";","fn","=","normalize","(","fn",")",";","fp","=","normalize","(","fp",")",";","ff","=","max","(","fe",",","fb",")",";","fg","=","min","(","fe",",","fb",")",";","fg","*=","0.95",";","fb","=","max","(","dot","(","fn",",","fp",")",",","ZERO_VALUE_NODES",")",";","fc","=","0.45","*","(","fc","/","(","fc","+","0.09",")",")",";","nS","=","fa","*","(","fd","+","(","fc","*","fb","*","sin","(","ff",")","*","tan",
"(","fg",")",")",")",";","}","}","else","nS","=","fa",";","nS","=","max","(","nS",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_MINNAERT",declarations:[{type:"node_in",name:"nT",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nU",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"nV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"nW",qualifier:["float"],is_optional:false},{type:"node_in",name:"nX",qualifier:["vec2"],is_optional:false},{type:"node_out",
name:"nY",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["nY","=","ZERO_VALUE_NODES",";","if","(","nU",".","r","!=","ZERO_VALUE_NODES",")","{","fa","=","(","UNITY_VALUE_NODES","-","nW",")","*","dot","(","nV",",","nT",")","+","nW",";","fg","=","max","(","dot","(","nV",",","eM",")",",","ZERO_VALUE_NODES",")",";","if","(","nX","[","0","]","<=","UNITY_VALUE_NODES",")","nY","=","fa","*","pow","(","max","(","fg","*","fa",",","0.1",")",",","nX","[","0","]","-","UNITY_VALUE_NODES",
")",";","else","nY","=","fa","*","pow","(","1.0001","-","fg",",","nX","[","0","]","-","UNITY_VALUE_NODES",")",";","nY","=","max","(","nY",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_TOON",declarations:[{type:"node_in",name:"nZ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"n_",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"oa",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ob",qualifier:["float"],is_optional:false},{type:"node_in",name:"oc",
qualifier:["vec2"],is_optional:false},{type:"node_out",name:"od",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["od","=","ZERO_VALUE_NODES",";","if","(","n_",".","r","!=","ZERO_VALUE_NODES",")","{","fg","=","(","UNITY_VALUE_NODES","-","ob",")","*","dot","(","oa",",","nZ",")","+","ob",";","fg","=","acos","(","fg",")",";","if","(","fg","<","oc","[","0","]",")","od","=","UNITY_VALUE_NODES",";","else","if","(","fg",">","(","oc","[","0","]","+","oc","[","1","]",")","||","oc",
"[","1","]","==","ZERO_VALUE_NODES",")","od","=","ZERO_VALUE_NODES",";","else","od","=","UNITY_VALUE_NODES","-","(","(","fg","-","oc","[","0","]",")","/","oc","[","1","]",")",";","od","=","max","(","od",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"SPECULAR_PHONG",declarations:[{type:"node_in",name:"oe",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"of",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"og",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oh",
qualifier:["float"],is_optional:false},{type:"node_in",name:"oi",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"oj",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["oj","=","ZERO_VALUE_NODES",";","if","(","of",".","g","==","UNITY_VALUE_NODES",")","{","fp","=","normalize","(","oe","+","eM",")",";","oj","=","(","UNITY_VALUE_NODES","-","oh",")","*","max","(","dot","(","og",",","fp",")",",","ZERO_VALUE_NODES",")","+","oh",";","oj","=","pow","(","oj",",","oi",
"[","0","]",")",";","}"]}]},{type:"node",name:"SPECULAR_WARDISO",declarations:[{type:"node_in",name:"ok",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ol",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"om",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"on",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"oo",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["oo","=","ZERO_VALUE_NODES",";","if","(","ol",".","g","==","UNITY_VALUE_NODES",
")","{","fp","=","normalize","(","ok","+","eM",")",";","fg","=","max","(","dot","(","om",",","fp",")",",","0.001",")",";"]},{type:"textline",tokens:["fa","=","max","(","dot","(","om",",","eM",")",",","0.01",")",";","ff","=","max","(","dot","(","om",",","ok",")",",","0.01",")",";","fg","=","tan","(","acos","(","fg",")",")",";","fb","=","max","(","on","[","0","]",",","0.001",")",";","oo","=","ff","*","(","UNITY_VALUE_NODES","/","(","4.0","*","M_PI","*","fb","*","fb",")",")","*","(","exp","(","-","(",
"fg","*","fg",")","/","(","fb","*","fb",")",")","/","(","sqrt","(","fa","*","ff",")",")",")",";","}"]}]},{type:"node",name:"SPECULAR_TOON",declarations:[{type:"node_in",name:"op",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oq",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"or",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"os",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"ot",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["ot","=","ZERO_VALUE_NODES",";","if","(","oq",".","g","==","UNITY_VALUE_NODES",")","{","fp","=","normalize","(","op","+","eM",")",";","ff","=","acos","(","dot","(","fp",",","or",")",")",";","if","(","ff","<","os","[","0","]",")","ot","=","UNITY_VALUE_NODES",";","else","if","(","ff",">=","os","[","0","]","+","os","[","1","]","||","os","[","1","]","==","ZERO_VALUE_NODES",")","ot","=","ZERO_VALUE_NODES",";","else","ot","=","UNITY_VALUE_NODES","-","(","ff","-","os","[","0","]",")","/","os","[",
"1","]",";","}"]}]},{type:"node",name:"SPECULAR_BLINN",declarations:[{type:"node_in",name:"ou",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ov",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"ow",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ox",qualifier:["float"],is_optional:false},{type:"node_in",name:"oy",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"oz",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["oz","=",
"ZERO_VALUE_NODES",";","if","(","ov",".","g","==","UNITY_VALUE_NODES",")","{","if","(","oy","[","0","]","<","UNITY_VALUE_NODES","||","oy","[","1","]","==","ZERO_VALUE_NODES",")","oz","=","ZERO_VALUE_NODES",";","else","{","if","(","oy","[","1","]","<","100.0",")","oy","[","1","]","=","sqrt","(","UNITY_VALUE_NODES","/","oy","[","1","]",")",";","else","oy","[","1","]","=","10.0","/","oy","[","1","]",";","fp","=","normalize","(","eM","+","ou",")",";","ff","=","(","UNITY_VALUE_NODES","-","ox",")","*",
"max","(","dot","(","ow",",","fp",")",",","ZERO_VALUE_NODES",")","+","ox",";","if","(","ff","<","ZERO_VALUE_NODES",")","oz","=","ZERO_VALUE_NODES",";","else","{","fa","=","max","(","dot","(","ow",",","eM",")",",","0.01",")",";","fb","=","dot","(","ow",",","ou",")",";","if","(","fb","<=","0.01",")","oz","=","ZERO_VALUE_NODES",";","else","{","fg","=","max","(","dot","(","eM",",","fp",")",",","0.01",")",";","fc","=","UNITY_VALUE_NODES",";","fa","=","(","2.0","*","ff","*","fa",")","/","fg",";","fb","=",
"(","2.0","*","ff","*","fb",")","/","fg",";","fb","=","min","(","min","(","fc",",","fa",")",",","fb",")",";","fa","=","sqrt","(","pow","(","oy","[","0","]",",","2.0",")","+","pow","(","fg",",","2.0",")","-","UNITY_VALUE_NODES",")",";","fg","=","pow","(","fa","-","fg",",","2.0",")","/","pow","(","fa","+","fg",",","2.0",")","*","(","UNITY_VALUE_NODES","+","pow","(","fg","*","(","fa","+","fg",")","-","UNITY_VALUE_NODES",",","2.0",")","/","pow","(","fg","*","(","fa","-","fg",")","+","UNITY_VALUE_NODES",
",","2.0",")",")",";","ff","=","acos","(","ff",")",";","oz","=","max","(","fg","*","fb","*","exp","(","-","pow","(","ff",",","2.0",")","/","(","2.0","*","pow","(","oy","[","1","]",",","2.0",")",")",")",",","ZERO_VALUE_NODES",")",";","}","}","}","}"]}]},{type:"node",name:"LIGHTING_APPLY",declarations:[{type:"node_in",name:"oA",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"oB",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oC",qualifier:["float"],is_optional:false},{type:"node_in",
name:"oD",qualifier:["float"],is_optional:false},{type:"node_in",name:"oE",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oF",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oG",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"oH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oI",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oJ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"oK",qualifier:["float"],is_optional:false},{type:"node_out",
name:"oL",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"oM",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_NODE_B4W_TRANSLUCENCY"],statements:[{type:"textline",tokens:["if","(","dot","(","oE",",","oF",")","*","dot","(","eM",",","oF",")","<","ZERO_VALUE_NODES",")","{","ff","=","oG",".","x",";","fb","=","oG",".","y",";","fg","=","oG",".","z",";","fa","=","oG",".","w",";"]},{type:"textline",tokens:["fc","=","clamp","(",
"abs","(","dot","(","oE",",","oF",")",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fd","=","clamp","(","dot","(","eM",",","-","oE",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","pow","(","fd",",","fb",")",";"]},{type:"textline",tokens:["oL","=","oA","+","oK","*","vec4","(","oJ","*","fc","*","pow","(","oH",",","vec3","(","ff",")",")",",","UNITY_VALUE_NODES",")",";"]},{type:"textline",tokens:["oL","+=","fg","*","mix","(","vec4","(","oH",",","UNITY_VALUE_NODES",")",
",","vec4","(","UNITY_VALUE_NODES",")",",","fa",")","*","oK","*","vec4","(","oJ","*","fc","*","vec3","(","fb",")",",","UNITY_VALUE_NODES",")",";","oM","=","oB",";","}","else","{"]},{type:"textline",tokens:["oM","=","oB","+","oJ","*","oI","*","oD",";","oL","=","oA","+","vec4","(","oJ","*","oH","*","oC",",","oD",")",";","}"]}]},{type:"node_else",statements:[{type:"textline",tokens:["oM","=","oB","+","oJ","*","oI","*","oD",";","oL","=","oA","+","vec4","(","oJ","*","oH","*","oC",",","oD",")",";"]}]}]}]},
{type:"node",name:"RGB",declarations:[{type:"node_out",name:"oN",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["oN","=","u_node_rgbs","[","RGB_IND","]",";"]}]},{type:"node",name:"RGBTOBW",declarations:[{type:"node_in",name:"oO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oP",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["oP","=","dot","(","oO",",","vec3","(","0.35",",","0.45",",","0.2",")",")",";"]}]},{type:"node",name:"SEPRGB",
declarations:[{type:"node_in",name:"oQ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oR",qualifier:["float"],is_optional:true},{type:"node_out",name:"oS",qualifier:["float"],is_optional:true},{type:"node_out",name:"oT",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oR"],statements:[{type:"textline",tokens:["oR","=","oQ",".","r",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oS"],statements:[{type:"textline",
tokens:["oS","=","oQ",".","g",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oT"],statements:[{type:"textline",tokens:["oT","=","oQ",".","b",";"]}]}]}]},{type:"node",name:"SEPHSV",declarations:[{type:"node_in",name:"oU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"oV",qualifier:["float"],is_optional:true},{type:"node_out",name:"oW",qualifier:["float"],is_optional:true},{type:"node_out",name:"oX",qualifier:["float"],is_optional:true}],statements:[{type:"textline",
tokens:["fp","=","eq","(","oU",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oV"],statements:[{type:"textline",tokens:["oV","=","fp",".","r",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oW"],statements:[{type:"textline",tokens:["oW","=","fp",".","g",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_oX"],statements:[{type:"textline",tokens:["oX","=","fp",".","b",";"]}]}]}]},{type:"node",name:"SQUEEZE",declarations:[{type:"node_in",
name:"oY",qualifier:["float"],is_optional:false},{type:"node_in",name:"oZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"o_",qualifier:["float"],is_optional:false},{type:"node_out",name:"pa",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pa","=","UNITY_VALUE_NODES","/","(","UNITY_VALUE_NODES","+","pow","(","2.71828183",",","-","(","oY","-","o_",")","*","oZ",")",")",";"]}]},{type:"node",name:"GAMMA",declarations:[{type:"node_in",name:"pb",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"pc",qualifier:["float"],is_optional:false},{type:"node_out",name:"pd",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["pd","=","pb",";","if","(","pd",".","x",">","ZERO_VALUE_NODES",")","pd",".","x","=","pow","(","pb",".","x",",","pc",")",";","if","(","pd",".","y",">","ZERO_VALUE_NODES",")","pd",".","y","=","pow","(","pb",".","y",",","pc",")",";","if","(","pd",".","z",">","ZERO_VALUE_NODES",")","pd",".","z","=","pow","(","pb",".",
"z",",","pc",")",";"]}]},{type:"node",name:"B4W_SRGB_TO_LINEAR",declarations:[{type:"node_in",name:"pe",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pf",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["pf","=","max","(","vec3","(","ZERO_VALUE_NODES",")",",","pe",")",";","pf","=","pow","(","pf",",","vec3","(","2.2",")",")",";"]}]},{type:"node",name:"B4W_LINEAR_TO_SRGB",declarations:[{type:"node_in",name:"pg",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"ph",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ph","=","max","(","vec3","(","ZERO_VALUE_NODES",")",",","pg",")",";","ph","=","pow","(","ph",",","vec3","(","UNITY_VALUE_NODES","/","2.2",")",")",";"]}]},{type:"node",name:"TEXTURE_EMPTY",declarations:[{type:"node_out",name:"pi",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pj",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pk",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_pi"],statements:[{type:"textline",tokens:["pi","[","2","]","=","pi","[","1","]","=","pi","[","0","]","=","ZERO_VALUE_NODES",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pj"],statements:[{type:"textline",tokens:["pj","[","2","]","=","pj","[","1","]","=","pj","[","0","]","=","ZERO_VALUE_NODES",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pk"],statements:[{type:"textline",tokens:["pk","=","ZERO_VALUE_NODES",
";"]}]}]}]},{type:"node",name:"TEXTURE_ENVIRONMENT",declarations:[{type:"node_in",name:"pl",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pm",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pn",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_ENVIRONMENT_var_texture",qualifier:["uniform","samplerCube"],is_optional:false}],statements:[{type:"textline",tokens:["fi","=","textureCube","(","node_TEXTURE_ENVIRONMENT_var_texture",",","pl",")",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_pm"],statements:[{type:"textline",tokens:["pm","=","fi",".","xyz",";","br","(","pm",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pn"],statements:[{type:"textline",tokens:["pn","=","fi",".","w",";"]}]}]}]},{type:"node",name:"TEXTURE_COLOR",declarations:[{type:"node_in",name:"po",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"pp",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"pq",qualifier:["vec3"],
is_optional:true},{type:"node_in",name:"pr",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"ps",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pt",qualifier:["float"],is_optional:true},{type:"node_out",name:"pu",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pv",qualifier:["float"],is_optional:true},{type:"node_out",name:"pw",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"px",qualifier:["float"],is_optional:true},{type:"node_out",name:"py",qualifier:["vec3"],
is_optional:true},{type:"node_out",name:"pz",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_COLOR_var_texture",qualifier:["uniform","sampler2D"],is_optional:false}],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ey","(","po",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_ps"],statements:[{type:"textline",tokens:["ps","=","fi",".","xyz",";","br","(","ps",")",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_pt"],statements:[{type:"textline",tokens:["pt","=","fi",".","w",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv2"],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ey","(","pp",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pu"],statements:[{type:"textline",tokens:["pu","=","fi",".","xyz",";","br","(","pu",")",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_pv"],statements:[{type:"textline",tokens:["pv","=","fi",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv3"],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ey","(","pq",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pw"],statements:[{type:"textline",tokens:["pw","=","fi",".","xyz",";","br","(","pw",")",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_px"],statements:[{type:"textline",tokens:["px","=","fi",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv4"],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ey","(","pr",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_py"],statements:[{type:"textline",tokens:["py","=","fi",".","xyz",";","br","(","py",")",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_pz"],statements:[{type:"textline",tokens:["pz","=","fi",".","w",";"]}]}]}]}]}]},{type:"node",name:"TEXTURE_NORMAL",declarations:[{type:"node_in",name:"pA",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"pB",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"pC",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"pD",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pE",qualifier:["vec3"],is_optional:true},{type:"node_out",
name:"pF",qualifier:["float"],is_optional:true},{type:"node_out",name:"pG",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pH",qualifier:["float"],is_optional:true},{type:"node_out",name:"pI",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pJ",qualifier:["float"],is_optional:true},{type:"node_out",name:"pK",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"pL",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_NORMAL_var_texture",qualifier:["uniform",
"sampler2D"],is_optional:false}],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ey","(","pA",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pE"],statements:[{type:"textline",tokens:["pE","=","normalize","(","fj","*","(","fi",".","xyz","-","eh",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pF"],statements:[{type:"textline",tokens:["pF","=","fi",".","w",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_uv2"],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ey","(","pB",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pG"],statements:[{type:"textline",tokens:["pG","=","normalize","(","fj","*","(","fi",".","xyz","-","eh",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pH"],statements:[{type:"textline",tokens:["pH","=","fi",".","w",";"]}]}]}]}]},
{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv3"],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ey","(","pC",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pI"],statements:[{type:"textline",tokens:["pI","=","normalize","(","fj","*","(","fi",".","xyz","-","eh",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pJ"],statements:[{type:"textline",tokens:["pJ","=",
"fi",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv4"],statements:[{type:"textline",tokens:["fi","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ey","(","pD",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pK"],statements:[{type:"textline",tokens:["pK","=","normalize","(","fj","*","(","fi",".","xyz","-","eh",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pL"],statements:[{type:"textline",
tokens:["pL","=","fi",".","w",";"]}]}]}]}]}]},{type:"node",name:"VALUE",declarations:[{type:"node_out",name:"pM",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["pM","=","u_node_values","[","VALUE_IND","]",";"]}]},{type:"node",name:"VECT_MATH_ADD",declarations:[{type:"node_in",name:"pN",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pP",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"pQ",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["pP","=","pN","+","pO",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pQ"],statements:[{type:"textline",tokens:["pQ","=","(","abs","(","pP","[","0","]",")","+","abs","(","pP","[","1","]",")","+","abs","(","pP","[","2","]",")",")","/","3.0",";"]}]}]}]},{type:"node",name:"VECT_MATH_SUBTRACT",declarations:[{type:"node_in",name:"pR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pS",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pU",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["pT","=","pR","-","pS",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pU"],statements:[{type:"textline",tokens:["pU","=","(","abs","(","pT","[","0","]",")","+","abs","(","pT","[","1","]",")","+","abs","(","pT","[","2","]",")",")","/","3.0",";"]}]}]}]},{type:"node",name:"VECT_MATH_AVERAGE",
declarations:[{type:"node_in",name:"pV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"pW",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pX",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"pY",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["pX","=","pV","+","pW",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_pY"],statements:[{type:"textline",tokens:["pY","=","length","(","pX",")",";"]}]}]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_pX"],statements:[{type:"textline",tokens:["pX","=","normalize","(","pX",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_DOT_PRODUCT",declarations:[{type:"node_in",name:"pZ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"p_",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qa",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qb",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["qa","=","vec3","(",
"ZERO_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_qb"],statements:[{type:"textline",tokens:["qb","=","dot","(","pZ",",","p_",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_CROSS_PRODUCT",declarations:[{type:"node_in",name:"qc",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qd",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qe",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qf",qualifier:["float"],is_optional:true}],
statements:[{type:"textline",tokens:["qe","=","cross","(","qc",",","qd",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_qf"],statements:[{type:"textline",tokens:["qf","=","length","(","qe",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_NORMALIZE",declarations:[{type:"node_in",name:"qg",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qh",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qi",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qj",
qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["qi","=","normalize","(","qg",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_qj"],statements:[{type:"textline",tokens:["qj","=","length","(","qg",")",";"]}]}]},{type:"textline",tokens:["qh",";"]}]},{type:"node",name:"B4W_REFLECT",declarations:[{type:"node_in",name:"qk",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ql",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qm",
qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["qm","=","reflect","(","-","qk",",","ql",")",";"]}]},{type:"node",name:"B4W_PARALLAX",declarations:[{type:"node_in",name:"qn",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qo",qualifier:["float"],is_optional:false},{type:"node_in",name:"qp",qualifier:["const","float"],is_optional:false},{type:"node_in",name:"qq",qualifier:["const","float"],is_optional:false},{type:"node_out",name:"qr",qualifier:["vec3"],is_optional:false},
{type:"node_param",name:"node_B4W_PARALLAX_var_texture",qualifier:["uniform","sampler2D"],is_optional:false}],statements:[{type:"textline",tokens:["fb","=","length","(","fh",")",";","if","(","fb","<","qq",")","{","eX","=","ey","(","qn",")",";","fb","=","clamp","(","eh","*","(","qq","-","fb",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","fb","=","qo","*","fb",";"]},{type:"textline",tokens:["fp","=","normalize","(","eM","*","fj",")",";"]},{type:"textline",tokens:["fc","=","UNITY_VALUE_NODES",
"/","qp",";"]},{type:"textline",tokens:["eY","=","fp",".","xy","*","fb","/","(","qp","*","fp",".","z",")",";","fb","=","UNITY_VALUE_NODES",";","fa","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","eX",")",".","a",";"]},{type:"textline",tokens:["for","(","float","qs","=","1.0",";","qs","<=","qp",";","qs","++",")","{","if","(","fa","<","fb",")","{","fb","-=","fc",";","eX","-=","eY",";","fa","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","eX",")",".","a",";","}","}"]},{type:"textline",
tokens:["eY","=","eX","+","eY",";","fc","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","eY",")",".","a","-","(","fb","+","fc",")",";","fb","=","fa","-","fb",";","fc","=","fb","/","(","fb","-","fc",")",";"]},{type:"textline",tokens:["eX","=","fc","*","eY","+","(","UNITY_VALUE_NODES","-","fc",")","*","eX",";","qr","=","ew","(","eX",")",";","}","else","qr","=","qn",";"]}]},{type:"node",name:"B4W_CLAMP",declarations:[{type:"node_in",name:"qt",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"qu",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["qu","=","clamp","(","qt",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]},{type:"node",name:"B4W_REFRACTION",declarations:[{type:"node_in",name:"qv",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qw",qualifier:["float"],is_optional:false},{type:"node_out",name:"qx",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["qx","=","el","(","qv",",","qw",")",";"]}]},{type:"node",
name:"B4W_TRANSLUCENCY",declarations:[{type:"node_in",name:"qy",qualifier:["float"],is_optional:false},{type:"node_in",name:"qz",qualifier:["float"],is_optional:false},{type:"node_in",name:"qA",qualifier:["float"],is_optional:false},{type:"node_in",name:"qB",qualifier:["float"],is_optional:false},{type:"node_in",name:"qC",qualifier:["float"],is_optional:false},{type:"node_out",name:"qD",qualifier:["float"],is_optional:true},{type:"node_out",name:"qE",qualifier:["vec4"],is_optional:true}],statements:[{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_qD"],statements:[{type:"textline",tokens:["qD","=","qy",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_qE"],statements:[{type:"textline",tokens:["qE","=","vec4","(","qz",",","qA",",","qB",",","qC",")",";"]}]}]}]},{type:"node",name:"B4W_TIME",declarations:[{type:"node_out",name:"qF",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["qF","=","u_time",";"]}]},{type:"node",name:"B4W_SMOOTHSTEP",declarations:[{type:"node_in",
name:"qG",qualifier:["float"],is_optional:false},{type:"node_in",name:"qH",qualifier:["float"],is_optional:false},{type:"node_in",name:"qI",qualifier:["float"],is_optional:false},{type:"node_out",name:"qJ",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["qJ","=","smoothstep","(","qH",",","qI",",","qG",")",";"]}]},{type:"node",name:"B4W_GLOW_OUTPUT",declarations:[{type:"node_in",name:"qK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"qL",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["eS","=","qK",";","eW","=","qL",";"]}]},{type:"node",name:"B4W_VECTOSCAL",declarations:[{type:"node_in",name:"qM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"qN",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["qN","=","(","qM",".","r","+","qM",".","g","+","qM",".","b",")","/","3.0",";"]}]},{type:"node",name:"B4W_SCALTOVEC",declarations:[{type:"node_in",name:"qO",qualifier:["float"],is_optional:false},
{type:"node_out",name:"qP",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["qP","[","0","]","=","qO",";","qP","[","1","]","=","qO",";","qP","[","2","]","=","qO",";"]}]},{type:"nodes_global"},{type:"textline",tokens:["void","qQ","(","in","vec3","eM",",","in","mat4","eN",",","in","mat4","eO",",","in","mat4","eP",",","in","mat4","eQ",",","in","mat4","eR",",","out","vec3","eS",",","out","vec3","eT",",","out","vec3","eU",",","out","vec4","eV",",","out","float","eW",")","{",
"vec2","eX",",","eY",";","float","eZ",",","e_",",","fa",",","fb",",","fc",",","fd",",","fe",",","ff",",","fg",";","vec4","fh",",","fi",";","mat3","fj",";","vec3","fk",",","fl",",","fm",",","fn",",","fo",",","fp",";","eS","=","vec3","(","ZERO_VALUE_NODES",")",";","eT","=","vec3","(","ZERO_VALUE_NODES",")",";","eU","=","vec3","(","ZERO_VALUE_NODES",")",";","eV","=","vec4","(","ZERO_VALUE_NODES",")",";","eW","=","ZERO_VALUE_NODES",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN",
"USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["fk","=","normalize","(","bE",")",";","fl","=","fk",";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING","USE_NODE_GEOMETRY_NO",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["INVERT_FRONTFACING"],group:{type:"group",parts:[{type:"textline",tokens:["if",
"(","!","gl_FrontFacing",")"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")"]}]}}]},{type:"textline",tokens:["fl","=","fl",";","else","fl","=","-","fl",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["fm","=","fl",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["fm","=","fk",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_NO"],
group:{type:"group",parts:[{type:"textline",tokens:["fk","=","fl",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["fn","=","cross","(","fl",",","bF",".","xyz",")","*","bF",".","w",";","fj","=","mat3","(","bF",".","xyz",",","fn",",","fl",")",";","fj","=","fj",";"]}]}}]},{type:"textline",tokens:["fl","=","bC",";","fh","=","bD",";","eZ","=","u_emit",";","e_","=","u_ambient",";"]},{type:"nodes_main"},{type:"textline",
tokens:["}"]}]},exports["include/to_world.glslv"]={type:"group",parts:[{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"define",name:"MAX_BILLBOARD_ANGLE",tokens:["(","M_PI","/","4.0",")"]},{type:"textline",tokens:["const","vec3","qR","=","vec3","(","0.0",",","1.0",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_SPHERICAL","BILLBOARD",{type:"logic_negative_expr",places:1},"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW",{type:"equal_expr",places:2},{type:"logical_and_expr",
places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","qX","(","vec3","qS",",","mat4","qT",")","{","vec3","qU",",","qV",",","qW",";","qU","=","vec3","(","qT","[","0","]","[","0","]",",","qT","[","1","]","[","0","]",",","qT","[","2","]","[","0","]",")",";","qV","=","vec3","(","qT","[","0","]","[","1","]",",","qT","[","1","]","[","1","]",",","qT","[","2","]","[","1","]",")",";","qW","=","vec3","(","qT","[","0","]","[","2","]",",","qT","[","1","]","[",
"2","]",",","qT","[","2","]","[","2","]",")",";","qV","=","cross","(","qW",",","qU",")",";","return","mat4","(","vec4","(","qU",",","0.0",")",",","vec4","(","qV",",","0.0",")",",","vec4","(","qW",",","0.0",")",",","vec4","(","qS",",","1.0",")",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["mat4","rc","(","vec3","qY",",","vec3","qZ",")","{","vec3","q_",",","ra",",","rb",";","q_","=","qY","-","qZ",";","q_",".","y","=","0.0",";","q_","=","normalize","(","q_",")",";",
"ra","=","normalize","(","cross","(","qR",",","q_",")",")",";","rb","=","normalize","(","cross","(","q_",",","ra",")",")",";","return","mat4","(","vec4","(","ra",",","0.0",")",",","vec4","(","rb",",","0.0",")",",","vec4","(","q_",",","0.0",")",",","vec4","(","qZ",",","1.0",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_JITTERED"],group:{type:"group",parts:[{type:"textline",tokens:["mat4","rk","(","in","vec3","rd",",","float","re",",","float","rf",",","float","rg",
",","vec3","rh",")","{","float","ri",",","rj",";","ri","=","fract","(","length","(","rh",")","/","0.17",")",";","rj","=","rg","+","ri","/","10.0",";","ri","=","ri",";","if","(","rg","!=","0.0",")","ri","/=","rg",";","rd","*=","1.0","+","0.5","*","sin","(","re",")",";","ri","=","length","(","rd",")","*","rf","*","sin","(","2.0","*","3.14","*","re","*","rj","+","ri",")",";","return","C","(","ri",")",";","}"]}]}}]},{type:"textline",tokens:["mat4","rs","(","in","vec3","rl",",","in","vec3","rm",",","in",
"mat4","rn",")","{","vec3","ro",";","float","rp",",","rq",";","mat4","rr",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_SPHERICAL","BILLBOARD",{type:"logic_negative_expr",places:1},"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW",{type:"equal_expr",places:2},{type:"logical_and_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["rr","=","qX","(","rm",",","rn",")",";"]}]}},{type:"elif",expression:["BILLBOARD_RANDOM"],group:{type:"group",
parts:[{type:"textline",tokens:["rp","=","fract","(","(","rm",".","x","*","1.43","+","rm",".","y","*","0.123","+","rm",".","z","*","6.1",")",")",";","rp","=","2.0","*","M_PI","*","rp",";","ro","=","normalize","(","vec3","(","rn","[","0","]","[","2","]",",","0.0",",","rn","[","2","]","[","2","]",")",")",";","rq","=","acos","(","ro","[","2","]",")",";","if","(","ro","[","0","]","<","0.0",")","rq","=","2.0","*","M_PI","-","rq",";","rq","=","rq","-","rp",";","if","(","rq","<","0.0",")","rq","=","2.0",
"*","M_PI","+","rq",";","rp","=","rp",";","if","(","rq","<=","MAX_BILLBOARD_ANGLE",")","rp","+=","rq",";","else","if","(","rq","<=","M_PI","-","MAX_BILLBOARD_ANGLE",")","rp","+=","MAX_BILLBOARD_ANGLE","*","(","2.0","*","rq","-","M_PI",")","/","(","2.0","*","MAX_BILLBOARD_ANGLE","-","M_PI",")",";","else","if","(","rq","<=","M_PI","+","MAX_BILLBOARD_ANGLE",")","rp","+=","rq","-","M_PI",";","else","if","(","rq","<=","2.0","*","M_PI","-","MAX_BILLBOARD_ANGLE",")","rp","+=","MAX_BILLBOARD_ANGLE","*","(",
"2.0","*","rq","-","M_PI",")","/","(","2.0","*","MAX_BILLBOARD_ANGLE","-","M_PI",")","+","M_PI",";","else","rp","+=","rq","-","2.0","*","M_PI",";","rr","=","A","(","rp",")",";","rr","[","3","]","=","vec4","(","rm",",","1.0",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["rr","=","rc","(","rl",",","rm",")",";"]}]}}]},{type:"textline",tokens:["return","rr",";","}"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD_PRES_GLOB_ORIENTATION","STATIC_BATCH",{type:"logic_negative_expr",
places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["mat4","ry","(","in","vec3","rt",",","in","vec3","ru",",","in","mat4","rv",",","mat4","rw",")","{","mat4","rx",";","rx","=","rs","(","rt",",","ru",",","rv",")",";","rw","[","3","]","=","vec4","(","0.0",",","0.0",",","0.0",",","1.0",")",";","rx","=","rx","*","rw",";","return","rx",";","}"]}]}}]},{type:"textline",tokens:["c","rF","(","in","vec3","rz",",","in","vec3","rA",",","in","vec3","rB",",","in","vec3",
"rC",",","in","vec3","rD",",","in","mat4","rE",")","{","rz","=","(","rE","*","vec4","(","rz",",","1.0",")",")",".","xyz",";","rA","=","(","rE","*","vec4","(","rA",",","1.0",")",")",".","xyz",";","rB","=","(","rE","*","vec4","(","rB",",","0.0",")",")",".","xyz",";","rC","=","(","rE","*","vec4","(","rC",",","0.0",")",")",".","xyz",";","rD","=","(","rE","*","vec4","(","rD",",","0.0",")",")",".","xyz",";","return","E","(","c","(","rz",",","rA",",","rB",",","rC",",","rD",",","vec3","(","0.0",")",")",")",
";","}"]}]},exports["include/scale_texcoord.glslv"]={type:"group",parts:[{type:"textline",tokens:["vec2","rI","(","vec2","rG",",","vec3","rH",")","{","return","(","rG","+","0.5",")","*","rH",".","xy","-","0.5",";","}"]}]},exports["include/skin.glslv"]={type:"group",parts:[{type:"define",name:"SKIN_SLERP",tokens:["0"]},{type:"condition",parts:[{type:"if",expression:["SKINNED"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",
tokens:["vec4","rP","(","in","vec4","rJ",",","in","vec4","rK",",","in","float","rL",")","{","float","rM",",","rN",",","rO",";","rM","=","rJ","[","0","]","*","rK","[","0","]","+","rJ","[","1","]","*","rK","[","1","]","+","rJ","[","2","]","*","rK","[","2","]","+","rJ","[","3","]","*","rK","[","3","]",";","if","(","rM","<","0.0",")","{","rK","*=","-","1.0",";","rM","=","-","rM",";","}","if","(","abs","(","rM",")",">=","1.0",")","return","rJ",";","rN","=","acos","(","rM",")",";","rM","=","sqrt","(","1.0",
"-","rM","*","rM",")",";","if","(","abs","(","rM",")","<","0.001",")","return","vec4","(","rJ","*","0.5","+","rK","*","0.5",")",";","rO","=","sin","(","(","1.0","-","rL",")","*","rN",")","/","rM",";","rM","=","sin","(","rL","*","rN",")","/","rM",";","return","rJ","*","rO","+","rK","*","rM",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","sa","(","in","vec3","rQ",",","in","vec4","rR",",","in","vec4","rS",",",
"in","vec4","rT",",","in","vec4","rU",",","in","float","rV",")","{","vec4","rW",",","rX",";","vec3","rY",",","rZ",",","r_",";","rY","=","p","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","rQ",",","1.0",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["rW","=","rP","(","rR",",","rS",",","rV",")",";","rX","=","mix","(","rT",",","rU",",","rV",")",";","rZ","=","i","(","rW",",","rY",")",";","rZ","=","rZ","*","rX",
".","w","+","rX",".","xyz",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["r_","=","i","(","rR",",","rY",")",";","rY","=","i","(","rS",",","rY",")",";","r_","=","r_","*","rT",".","w","+","rT",".","xyz",";","rY","=","rY","*","rU",".","w","+","rU",".","xyz",";","rZ","=","mix","(","r_",",","rY",",","rV",")",";"]}]}}]},{type:"textline",tokens:["return","v","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","rZ",",","1.0",")",")",";","}","vec3","sj","(","in","vec3","sb",
",","in","vec4","sc",",","in","vec4","sd",",","in","float","se",")","{","vec4","sf",";","vec3","sg",",","sh",",","si",";","sg","=","p","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","sb",",","0.0",")",")",";"]},{type:"condition",parts:[{type:"if",expression:["SKIN_SLERP"],group:{type:"group",parts:[{type:"textline",tokens:["sf","=","rP","(","sc",",","sd",",","se",")",";","sh","=","i","(","sf",",","sg",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["si","=",
"i","(","sc",",","sg",")",";","sg","=","i","(","sd",",","sg",")",";","sh","=","mix","(","si",",","sg",",","se",")",";"]}]}}]},{type:"textline",tokens:["return","v","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","sh",",","0.0",")",")",";","}"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vec3","sa","(","in","vec3","sk",",","in","vec4","sl",",","in","vec4","sm",")","{","vec3","sn",";","sn","=","p","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","sk",",",
"1.0",")",")",";","sn","=","i","(","sl",",","sn",")",";","sn","=","sn","*","sm",".","w","+","sm",".","xyz",";","return","v","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","sn",",","1.0",")",")",";","}","vec3","sj","(","in","vec3","so",",","in","vec4","sp",")","{","vec3","sq",";","sq","=","p","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","so",",","0.0",")",")",";","sq","=","i","(","sp",",","sq",")",";","return","v","(","u_arm_rel_trans",",","u_arm_rel_quat",",","vec4","(","sq",
",","0.0",")",")",";","}"]}]}}]},{type:"textline",tokens:["void","sF","(","inout","vec3","sr",",","inout","vec3","ss",",","inout","vec3","st",",","inout","vec3","su",")","{","int","sv",",","sw",";","vec4","sx",";","vec3","sy",",","sz",",","sA",",","sB",";","float","sC",",","sD",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["sC","=","u_frame_factor",";"]}]}}]},{type:"textline",tokens:["if","(","a_influence",".","y",">",
"0.0",")","{","sy","=","vec3","(","0.0",",","0.0",",","0.0",")",";","sz","=","vec3","(","0.0",",","0.0",",","0.0",")",";","sA","=","vec3","(","0.0",",","0.0",",","0.0",")",";","sB","=","vec3","(","0.0",",","0.0",",","0.0",")",";","sx","=","a_influence",";","for","(","int","sE","=","0",";","sE","<","4",";","sE","++",")","{","sv","=","int","(","sx","[","sE","]",")",";","sD","=","fract","(","sx","[","sE","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",
parts:[{type:"textline",tokens:["sy","+=","sD","*","sa","(","sr",",","u_quatsb","[","sv","]",",","u_quatsa","[","sv","]",",","u_transb","[","sv","]",",","u_transa","[","sv","]",",","sC",")",";","sz","+=","sD","*","sj","(","ss",",","u_quatsb","[","sv","]",",","u_quatsa","[","sv","]",",","sC",")",";","sA","+=","sD","*","sj","(","st",",","u_quatsb","[","sv","]",",","u_quatsa","[","sv","]",",","sC",")",";","sB","+=","sD","*","sj","(","su",",","u_quatsb","[","sv","]",",","u_quatsa","[","sv","]",",","sC",
")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["sy","+=","sD","*","sa","(","sr",",","u_quatsb","[","sv","]",",","u_transb","[","sv","]",")",";","sB","+=","sD","*","sj","(","su",",","u_quatsb","[","sv","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_TANGENT_SKINNING",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["sz","+=","sD","*","sj","(","ss",",","u_quatsb","[","sv","]",")",";","sA","+=","sD","*","sj",
"(","st",",","u_quatsb","[","sv","]",")",";"]}]}}]}]}}]},{type:"textline",tokens:["}","sr","=","sy",";","su","=","sB",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_TANGENT_SKINNING",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["ss","=","sz",";","st","=","sA",";"]}]}}]},{type:"textline",tokens:["}","if","(","!","(","a_influence",".","y",">","0.0",")",")","{","sw","=","int","(","a_influence","[","0","]","-","1.0",")",";","if","(","sw",">",
"-","1",")","{"]},{type:"condition",parts:[{type:"if",expression:["FRAMES_BLENDING"],group:{type:"group",parts:[{type:"textline",tokens:["sr","=","sa","(","sr",",","u_quatsb","[","sw","]",",","u_quatsa","[","sw","]",",","u_transb","[","sw","]",",","u_transa","[","sw","]",",","sC",")",";","ss","=","sj","(","ss",",","u_quatsb","[","sw","]",",","u_quatsa","[","sw","]",",","sC",")",";","st","=","sj","(","st",",","u_quatsb","[","sw","]",",","u_quatsa","[","sw","]",",","sC",")",";","su","=","sj","(","su",
",","u_quatsb","[","sw","]",",","u_quatsa","[","sw","]",",","sC",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["sr","=","sa","(","sr",",","u_quatsb","[","sw","]",",","u_transb","[","sw","]",")",";","su","=","sj","(","su",",","u_quatsb","[","sw","]",")",";"]},{type:"condition",parts:[{type:"if",expression:["DISABLE_TANGENT_SKINNING",{type:"logic_negative_expr",places:1}],group:{type:"group",parts:[{type:"textline",tokens:["ss","=","sj","(","ss",",","u_quatsb","[","sw",
"]",")",";","st","=","sj","(","st",",","u_quatsb","[","sw","]",")",";"]}]}}]}]}}]},{type:"textline",tokens:["}","}","}"]}]}}]}]},exports["include/wind_bending.glslv"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["WIND_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["void","sQ","(","inout","vec3","sG",",","in","vec3","sH",",","in","float","sI",",","in","float","sJ",",","in","float","sK",",","in","vec3","sL",",","in","float","sM",")","{","vec3","sN",";","float","sO",
",","sP",";","sO","=","length","(","sH",")",";","sP","=","sJ","*","(","1.0","+","0.1","*","fract","(","sO",")",")",";","sO","=","sI","*","sM","*","(","1.0","+","sin","(","2.0","*","3.14","*","sK","*","sP","+","sO",")",")",";","sP","=","(","sG",".","y","-","sH",".","y",")","*","abs","(","sO",")",";","sP","+=","1.0",";","sP","*=","sP",";","sP","=","sP","*","sP","-","sP",";","sN","=","sG",";","sN",".","xz","+=","sL",".","xz","*","sP","*","sign","(","sO",")",";","sN","=","sN","-","sH",";","if","(","all",
"(","equal","(","sN",",","vec3","(","0.0",")",")",")",")","sG","=","sH",";","else","{","sO","=","length","(","sG","-","sH",")",";","sG","=","sH","+","normalize","(","sN",")","*","sO",";","}","}"]},{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["vec4","sS","(","vec4","sR",")","{","return","sR","*","sR","*","(","3.0","-","2.0","*","sR",")",";","}","vec4","sU","(","vec4","sT",")","{","return","abs","(","fract","(","sT","+","0.5",")",
"*","2.0","-","1.0",")",";","}","vec4","sW","(","vec4","sV",")","{","return","sS","(","sU","(","sV",")",")",";","}","void","tm","(","inout","vec3","sX",",","in","float","sY",",","in","vec3","sZ",",","in","vec3","s_",",","in","vec3","ta",",","in","float","tb",",","in","float","tc",",","in","float","td",",","in","vec3","te",")","{","vec3","tf",";","vec4","tg",";","vec2","th",",","ti",";","float","tj",",","tk",",","tl",";","tj","=","dot","(","ta",",","vec3","(","1.0",")",")",";","tk","=","tj","+","te",
".","g",";","tl","=","dot","(","sX",",","vec3","(","te",".","g",")",")",";","th","=","(","sY","+","vec2","(","tl",",","tk",")",")",";","tg","=","(","(","fract","(","(","th",".","xxyy","*","vec4","(","1.975",",","0.793",",","0.375",",","0.193",")",")",")","*","2.0",")","-","1.0",")","*","length","(","s_",")","*","tb",";","tg","=","sW","(","tg",")",";","ti","=","tg",".","xz","+","tg",".","yw",";","ti",".","y","=","0.5","-","ti",".","y",";","tf","=","ti",".","xyx","*","te",".","rbr","*","vec3","(","tc",
"*","sZ",".","x",",","td",",","tc","*","sZ",".","z",")",";","sX","+=","tf",";","}"]}]}}]},{type:"textline",tokens:["void","tt","(","inout","vec3","tn",",","inout","vec3","to",",","in","vec3","tp",")","{","vec3","tq",",","tr",",","ts",";","tq","=","u_wind","*","1.0","+","0.7","*","sin","(","u_time",")",";"]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["tr","=","to",";","ts","=","a_emitter_center",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["tr","=","tn",";","ts","=","to",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["MAIN_BEND_COL"],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["DETAIL_BEND"],group:{type:"group",parts:[{type:"textline",tokens:["tm","(","tr",",","u_time",",","tp",",","tq",",","ts",",","au_detail_bending_freq",",","au_detail_bending_amp",",","au_branch_bending_amp",",","a_bending_col_detail",")",";"]}]}}]},{type:"textline",tokens:["sQ","(","tr",
",","ts",",","au_wind_bending_amp",",","au_wind_bending_freq",",","u_time",",","tq",",","a_bending_col_main",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["sQ","(","tr",",","ts",",","au_wind_bending_amp",",","au_wind_bending_freq",",","u_time",",","tq",",","1.0",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["BEND_CENTER_ONLY"],group:{type:"group",parts:[{type:"textline",tokens:["tn","+=","tr","-","to",";","to","=","tr",";"]}]}},{type:"else",group:{type:"group",
parts:[{type:"textline",tokens:["tn","=","tr",";","to","=","ts",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/nodes.glslv"]={type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2},"PARTICLE_BATCH",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["attribute","vec3","a_orco_tex_coord",";","varying","vec3","eg",
";"]}]}}]},{type:"node",name:"TEX_COORD_UV",declarations:[{type:"node_param",name:"node_TEX_COORD_UV_var_a_uv",qualifier:["attribute","vec2"],is_optional:false},{type:"node_param",name:"eG",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["eG","=","node_TEX_COORD_UV_var_a_uv",";"]}]},{type:"node",name:"UV_MERGED",declarations:[{type:"node_param",name:"node_UV_MERGED_var_a_uv",qualifier:["attribute","vec2"],is_optional:false},{type:"node_param",name:"eF",qualifier:["varying",
"vec2"],is_optional:false}],statements:[{type:"textline",tokens:["eF","=","node_UV_MERGED_var_a_uv",";"]}]},{type:"node",name:"UVMAP",declarations:[{type:"node_param",name:"node_UVMAP_var_a_uv",qualifier:["attribute","vec2"],is_optional:false},{type:"node_param",name:"eH",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["eH","=","node_UVMAP_var_a_uv",";"]}]},{type:"node",name:"GEOMETRY_UV",declarations:[{type:"node_param",name:"node_GEOMETRY_UV_var_a_uv",qualifier:["attribute",
"vec2"],is_optional:false},{type:"node_param",name:"ez",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["ez","=","node_GEOMETRY_UV_var_a_uv",";"]}]},{type:"node",name:"GEOMETRY_VC",declarations:[{type:"node_param",name:"node_GEOMETRY_VC_var_a_vertex_color",qualifier:["attribute","vec3"],is_optional:false},{type:"node_param",name:"tu",qualifier:["varying","vec3"],is_optional:false}],statements:[{type:"textline",tokens:["tu","=","node_GEOMETRY_VC_var_a_vertex_color",
";"]}]},{type:"node",name:"GEOMETRY_VC1",declarations:[{type:"node_param",name:"node_GEOMETRY_VC1_var_a_vertex_color",qualifier:["attribute","float"],is_optional:false},{type:"node_param",name:"tv",qualifier:["varying","float"],is_optional:false}],statements:[{type:"textline",tokens:["tv","=","node_GEOMETRY_VC1_var_a_vertex_color",";"]}]},{type:"node",name:"GEOMETRY_VC2",declarations:[{type:"node_param",name:"node_GEOMETRY_VC2_var_a_vertex_color",qualifier:["attribute","vec2"],is_optional:false},
{type:"node_param",name:"tw",qualifier:["varying","vec2"],is_optional:false}],statements:[{type:"textline",tokens:["tw","=","node_GEOMETRY_VC2_var_a_vertex_color",";"]}]},{type:"node",name:"GEOMETRY_VC3",declarations:[{type:"node_param",name:"node_GEOMETRY_VC3_var_a_vertex_color",qualifier:["attribute","vec3"],is_optional:false},{type:"node_param",name:"tx",qualifier:["varying","vec3"],is_optional:false}],statements:[{type:"textline",tokens:["tx","=","node_GEOMETRY_VC3_var_a_vertex_color",";"]}]},
{type:"nodes_global"},{type:"textline",tokens:["void","ty","(",")","{"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["eg","=","a_orco_tex_coord",";"]}]}}]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},exports["include/dynamic_grass.glslv"]={type:"group",parts:[{type:"var",name:"PRECISION",tokens:["lowp"]},{type:"condition",parts:[{type:"if",expression:["DYNAMIC_GRASS"],
group:{type:"group",parts:[{type:"textline",tokens:["vec2","tE","(","vec3","tA",",","float","tB",",","vec2","tC",")","{","vec2","tD",";","tD","=","vec2","(","(","tA",".","x","-","tC",".","x",")","/","tB",",","-","(","tA",".","z","-","tC",".","y",")","/","tB",")",";","return","fract","(","tD",")",";","}","vec2","tI","(","vec2","tF",",","float","tG",",","vec2","tH",")","{","return","vec2","(","tF",".","x","*","tG",",","-","tF",".","y","*","tG",")","+","tH",";","}","c","tJ","(",")","{","return","c",
"(","vec3","(","-","10000.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",",","vec3","(","0.0",")",")",";","}","c","ue","(","vec3","tK",",","vec3","tL",",","vec3","tM",",","vec3","tN",",","vec3","tO",",","PRECISION","sampler2D","tP",",","sampler2D","tQ",",","vec3","tR",",","float","tS",",","vec3","tT",",","vec4","tU",",","mat4","tV",")","{","mat4","tW",";","vec4","tX",";","vec2","tY",",","tZ",",","t_",";","float","ua",",","ub",";","vec3",
"uc",";","uc","=","i","(","tU",",","vec3","(","0.0",",","-","1.0",",","0.0",")",")",";","ua","=","-","uc",".","x",";","ub","=","-","uc",".","z",";","tY","=","vec2","(","tT",".","x","+","tS","*","(","-","1.0","-","ua",")","/","2.0",",","tT",".","z","+","tS","*","(","1.0","-","ub",")","/","2.0",")",";","tZ","=","tE","(","tO",",","tS",",","tY",")",";","ub","=","tS","/","2.0",";","t_","=","abs","(","tI","(","tZ","-","vec2","(","0.5",")",",","tS",",","vec2","(","0.0",")",")",")",";","ub","=","ub","*",
"(","1.0","+","sqrt","(","2.0",")",")","/","2.0",";","if","(","length","(","t_",")",">","ub",")","return","tJ","(",")",";","ub","=","tS","/","tR",".","z",";","t_","=","(","tZ","-","vec2","(","0.5",")",")","*","ub","+","vec2","(","0.5",")",";","uc","=","uc","*","(","tS","/","tR",".","z","-","1.0",")","/","2.0",";","t_",".","x","+=","uc",".","x",";","t_",".","y","-=","uc",".","z",";","tX","=","texture2D","(","tQ",",","t_",")",";","ub","=","tX",".","r",";","if","(","ub","<","u_scale_threshold",")","return",
"tJ","(",")",";","ua","=","tR",".","y","-","tR",".","x",";","ua","=","tR",".","y","-","texture2D","(","tP",",","t_",")",".","r","*","ua",";","t_","=","tK",".","xz","-","tO",".","xz",";","tO",".","xz","=","tI","(","tZ",",","tS",",","tY",")",";","tO",".","y","=","ua",";","tK",".","xz","=","tO",".","xz","+","t_",";","tK",".","y","*=","ub",";","tK",".","y","+=","ua",";","uc","=","tX",".","gba",";"]},{type:"condition",parts:[{type:"if",expression:["BILLBOARD"],group:{type:"group",parts:[{type:"textline",
tokens:["tK","-=","tO",";","tW","=","rs","(","tT",",","tO",",","tV",")",";","c","ud","=","rF","(","tK",",","tO",",","tL",",","tM",",","tN",",","tW",")",";","ud",".","b","=","tO",";","ud",".","f","=","uc",";","return","E","(","ud",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","E","(","c","(","tK",",","tO",",","tL",",","tM",",","tN",",","uc",")",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/halo_color.glslf"]={type:"group",parts:[{type:"var",
name:"NUM_LINES",tokens:["0"]},{type:"var",name:"NUM_RINGS",tokens:["0"]},{type:"var",name:"NUM_STARS",tokens:["0"]},{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS","NUM_LINES",{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["const","int","ui","=","NUM_RINGS",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["const","int","ui","=","NUM_LINES",";"]}]}}]},{type:"textline",tokens:["float",
"uk","(","float","uj",")","{","return","uj","-","floor","(","uj","*","(","1.0","/","0.01",")",")","*","0.01",";","}"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["void","ut","(","inout","float","ul",",","in","float","um","[","ui","]",",","in","float","un",")","{","float","uo",",","up",",","uq",",","ur",";","for","(","int","us","=","0",";","us","<","NUM_RINGS",";","us","++",")","{","uo","=","40.0","*","um","[","us","]",";","up",
"=","300.0","*","(","uk","(","uo",")","-","0.005",")",";","uq","=","uo",";","ur","=","abs","(","uq","*","(","u_halo_size","*","up","-","un",")",")",";","ul","+=","1.0","-","min","(","ur",",","1.0",")",";","}","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["void","uC","(","inout","float","uu",",","in","float","uv","[","ui","]",",","in","float","uw",")","{","float","ux",",","uy",",","uz",",","uA",";","for","(","int","uB","=",
"0",";","uB","<","NUM_LINES",";","uB","++",")","{","ux","=","uv","[","uB","]",";","uy","=","ux",";","uz","=","1000.0","*","(","uk","(","ux",")","-","0.005",")",";","uA","=","20.0","*","abs","(","uy","*","bM",".","x","+","uz","*","bM",".","y",")",";","uu","+=","1.0","-","min","(","uA",",","1.0",")",";","}","uu","*=","uw",";","}"]}]}}]},{type:"textline",tokens:["void","uJ","(","inout","float","uD",",","in","vec2","uE",")","{","float","uF",",","uG",",","uH",",","uI",";","uG","=","atan","(","uE",".",
"y",",","uE",".","x",")",";","uG","*=","(","1.0","+","0.25","*","float","(","NUM_STARS",")",")",";","uH","=","cos","(","uG",")",";","uI","=","sin","(","uG",")",";","uG","=","(","uH","*","uE",".","x","+","uI","*","uE",".","y",")","*","(","uH","*","uE",".","y","-","uI","*","uE",".","x",")",";","uF","=","abs","(","uG",")",";","if","(","uF","<","1.0",")","{","uF","=","(","0.01","*","u_halo_size",")","/","(","uF",")",";","uD","*=","sqrt","(","min","(","uF",",","1.0",")",")",";","}","}","vec4","uS","(",
")","{","vec4","uK",";","vec3","uL",";","float","uM",",","uN",",","uO",",","uP",";","uM","=","(","bM",".","x","*","bM",".","x","+","bM",".","y","*","bM",".","y",")",";","uN","=","sqrt","(","uM",")",";","uM","=","max","(","1.0","-","uM",",","0.0",")",";","uM","=","pow","(","uM",",","u_halo_hardness",")",";","uO","=","u_diffuse_color",".","a",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS","NUM_LINES",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["float",
"uQ","[","ui","]",";","for","(","int","uR","=","0",";","uR","<","ui",";","uR","++",")","{","uQ","[","uR","]","=","fract","(","uh","/","float","(","uR","+","1",")",")","-","1.0",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["uP","=","0.0",";","ut","(","uP",",","uQ",",","uN",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["uN","=","0.0",";",
"uC","(","uN",",","uQ",",","uM",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["uJ","(","uM",",","bM",")",";"]}]}}]},{type:"textline",tokens:["uM","*=","uO",";","uL","=","u_diffuse_color",".","rgb",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_RINGS"],group:{type:"group",parts:[{type:"textline",tokens:["uP","*=","uM",";","uL","+=","u_halo_rings_color","*","uP",";","uM","+=","uP",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["NUM_LINES"],group:{type:"group",parts:[{type:"textline",tokens:["uN","*=","uO",";","uL","+=","u_halo_lines_color","*","uN",";","uM","+=","uN",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["SKY_STARS"],group:{type:"group",parts:[{type:"textline",tokens:["uM","*=","max","(","1.0","-","2.0","*","u_sun_intensity",".","x",",","0.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS","DISABLE_FOG",{type:"logic_negative_expr",places:1},{type:"logical_and_expr",
places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uN","=","u_halo_stars_blend","*","(","ug",".","y","-","u_halo_stars_height",")",";","uM","*=","clamp","(","uN",",","0.0",",","1.0",")",";","uM","*=","min","(","u_cam_water_depth","+","2.0","*","WAVES_HEIGHT",",","1.0",")",";"]}]}}]}]}}]},{type:"textline",tokens:["uK","=","vec4","(","uL",",","uM",")",";","return","uK",";","}"]}]},exports["include/fog.glslf"]={type:"group",parts:[{type:"var",name:"WAVES_HEIGHT",tokens:["0.0"]},{type:"condition",
parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["void","uZ","(","inout","vec3","uT",",","in","float","uU",",","in","float","uV",",","in","vec4","uW",")","{","float","uX",",","uY",";","uX","=","clamp","(","(","uU","-","u_fog_params",".","z",")","/","u_fog_params",".","y",",","0.0",",","1.0",")",";"]},{type:"condition",parts:[{type:"if",expression:["FOG_TYPE","QUADRATIC",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uX",
"*=","uX",";"]}]}},{type:"elif",expression:["FOG_TYPE","LINEAR",{type:"equal_expr",places:2}],group:{type:"group",parts:[]}},{type:"elif",expression:["FOG_TYPE","INVERSE_QUADRATIC",{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["uX","=","sqrt","(","uX",")",";"]}]}}]},{type:"textline",tokens:["if","(","u_fog_params",".","w",">","0.0",")","{","if","(","uV",">","u_fog_params",".","w",")","uX","=","0.0",";","else","{","uY","=","(","u_fog_params",".","w","-","max","(",
"uV",",","0.0",")",")","/","u_fog_params",".","w",";","uX","*=","uY","*","uY",";","}","}","uW",".","a","=","1.0","-","(","1.0","-","uX",")","*","(","1.0","-","u_fog_params",".","x",")",";","uT","=","mix","(","uT",",","uW",".","rgb",",","uW",".","a",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ve","(","in","mat4","u_",",","in","vec3","va",")","{","vec3","vb",",","vc",",","vd",";","vb","=","mix","(",
"u_","[","0","]",".","rgb",",","u_","[","1","]",".","rgb",",","max","(","sign","(","va",".","x",")",",","0.0",")",")",";","vc","=","mix","(","u_","[","2","]",".","rgb",",","u_","[","3","]",".","rgb",",","max","(","sign","(","va",".","z",")",",","0.0",")",")",";","vd","=","vec3","(","u_","[","0","]",".","a",",","u_","[","1","]",".","a",",","u_","[","2","]",".","a",")",";","vc","=","mix","(","vb",",","vc",",","abs","(","va",".","z",")",")",";","vc","=","mix","(","vc",",","vd",",","abs","(","va",".",
"y",")",")",";","br","(","vc",")",";","return","vc",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["void","vg","(","inout","float","vf",")","{","vf","-=","0.5",";","vf","=","4.0","*","(","vf","*","vf","*","vf",")","+","0.5",";","}"]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",parts:[{type:"textline",tokens:["void","vr","(","inout","vec3","vh",",","in","float","vi",",","in",
"vec3","vj",",","in","float","vk",",","in","vec4","vl",",","in","float","vm",")","{","vec3","vn",",","vo",";","float","vp",",","vq",";","vp","=","max","(","vj",".","y",",","0.0",")",";","vq","=","max","(","vi","-","max","(","vk","/","vp",",","0.0",")",",","0.0",")",";","vq","=","vl",".","w","*","vq",";","vn","=","vec3","(","0.0",",","0.02",",","0.05",")",";","vo","=","vl",".","rgb",";","vq","=","min","(","vq",",","1.0",")",";","vg","(","vq",")",";","vq","*=","clamp","(","2.0","-","vm",",","0.0",",",
"1.0",")",";","vn","=","mix","(","vo",",","vn",",","min","(","vp",",","1.0",")",")",";","vk","=","clamp","(","-","vk","*","0.03",",","0.0",",","0.8",")",";","vn","*=","1.0","-","vk",";","vh","=","mix","(","vh",",","vn",",","vq",")",";","}"]}]}}]}]}}]},{type:"textline",tokens:["void","vy","(","inout","vec3","vs",",","float","vt",",","vec3","vu",",","float","vv",")","{","vec4","vw",";","vec3","vx",";"]},{type:"condition",parts:[{type:"if",expression:["USE_FOG"],group:{type:"group",parts:[{type:"condition",
parts:[{type:"if",expression:["PROCEDURAL_FOG"],group:{type:"group",parts:[{type:"textline",tokens:["vx","=","ve","(","u_cube_fog",",","vu",")",";","vw","=","vec4","(","vx",",","u_fog_color_density",".","a",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vw","=","u_fog_color_density",";"]}]}}]},{type:"textline",tokens:["uZ","(","vs",",","vt",",","bC",".","y",",","vw",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["WATER_EFFECTS"],group:{type:"group",
parts:[{type:"textline",tokens:["vr","(","vs",",","vt",",","vu",",","u_cam_water_depth",",","u_underwater_fog_color_density",",","vv",")",";"]}]}},{type:"else",group:{type:"group",parts:[]}}]},{type:"textline",tokens:["}"]}]},exports["include/shadow.glslv"]={type:"group",parts:[{type:"var",name:"SHADOW_TEX_RES",tokens:["0.0"]},{type:"condition",parts:[{type:"if",expression:["SHADOW_USAGE","SHADOW_MASK_GENERATION",{type:"equal_expr",places:2},"SHADOW_USAGE","SHADOW_MAPPING_BLEND",{type:"equal_expr",
places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","vH","(","mat4","vB",",","vec4","vC",",","mat4","vD",")","{","vec4","vE",";","float","vF",";","vec2","vG",";","vG","=","(","vB","*","vD","[","3","]",")",".","xy",";","vF","=","SHADOW_TEX_RES","/","2.0",";","vG","=","floor","(","vG","*","vF","+","0.5",")","/","vF","-","vG",";","vE","=","vB","*","vC",";","vE",".","xy","+=","vG",";","vE",".","xyz","=","0.5","*","(","vE",".","xyz","+","vE",".","w",
")",";","return","vE",";","}","void","vM","(","vec3","vI",",","vec3","vJ",")","{","vec4","vK",";","mat4","vL",";"]},{type:"condition",parts:[{type:"if",expression:["MAC_OS_SHADOW_HACK"],group:{type:"group",parts:[{type:"textline",tokens:["vL","=","O","(","u_v_light_tsr","[","0","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vL","=","O","(","mat3","(","u_v_light_ts","[","0","]",",","u_v_light_r","[","0","]",",","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["vK",
"=","vL","*","vec4","(","vI","+","u_normal_offset","*","vJ",",","1.0",")",";","bI","=","vH","(","u_p_light_matrix0",",","vK",",","vL",")",";"]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",1,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAC_OS_SHADOW_HACK"],group:{type:"group",parts:[{type:"textline",tokens:["vL","=","O","(","u_v_light_tsr","[","1","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",
tokens:["vL","=","O","(","mat3","(","u_v_light_ts","[","1","]",",","u_v_light_r","[","1","]",",","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["vK","=","vL","*","vec4","(","vI","+","u_normal_offset","*","vJ",",","1.0",")",";","bJ","=","vH","(","u_p_light_matrix1",",","vK",",","vL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAC_OS_SHADOW_HACK"],group:{type:"group",
parts:[{type:"textline",tokens:["vL","=","O","(","u_v_light_tsr","[","2","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vL","=","O","(","mat3","(","u_v_light_ts","[","2","]",",","u_v_light_r","[","2","]",",","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["vK","=","vL","*","vec4","(","vI","+","u_normal_offset","*","vJ",",","1.0",")",";","bK","=","vH","(","u_p_light_matrix2",",","vK",",","vL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["NUM_CAST_LAMPS",
3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["MAC_OS_SHADOW_HACK"],group:{type:"group",parts:[{type:"textline",tokens:["vL","=","O","(","u_v_light_tsr","[","3","]",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["vL","=","O","(","mat3","(","u_v_light_ts","[","3","]",",","u_v_light_r","[","3","]",",","0.0",")",")",";"]}]}}]},{type:"textline",tokens:["vK","=","vL","*","vec4","(","vI","+","u_normal_offset","*","vJ",
",","1.0",")",";","bL","=","vH","(","u_p_light_matrix3",",","vK",",","vL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION1"],group:{type:"group",parts:[{type:"textline",tokens:["bJ","=","vH","(","u_p_light_matrix1",",","vK",",","vL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION2"],group:{type:"group",parts:[{type:"textline",tokens:["bK","=","vH","(","u_p_light_matrix2",",","vK",",","vL",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["CSM_SECTION3"],
group:{type:"group",parts:[{type:"textline",tokens:["bL","=","vH","(","u_p_light_matrix3",",","vK",",","vL",")",";"]}]}}]},{type:"textline",tokens:["}"]}]}}]}]},exports["include/lighting_nodes.glslf"]={type:"group",parts:[{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},
{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["float","ZERO_VALUE_NODES","=","0.0",";","float","UNITY_VALUE_NODES","=","1.0",";","float","vN","=","0.5",";"]},{type:"node",name:"LIGHTING_BEGIN",declarations:[{type:"node_out",name:"wk",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"wl",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"wm",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"wn",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"wo",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"wp",qualifier:["vec2"],is_optional:true},{type:"node_out",name:"wq",qualifier:["vec2"],is_optional:true},{type:"node_out",name:"wr",qualifier:["vec4"],is_optional:true},{type:"node_out",name:"ws",qualifier:["float"],is_optional:true},{type:"node_out",name:"wt",qualifier:["vec4"],is_optional:true}],statements:[{type:"textline",tokens:["wk","=","vO",";","wl","=","vP",
";","wm","=","vQ",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_wn"],statements:[{type:"textline",tokens:["wn","=","vR",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_wo"],statements:[{type:"textline",tokens:["wo","=","vT",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_wq"],statements:[{type:"textline",tokens:["wq","=","vV",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_wp"],statements:[{type:"textline",
tokens:["wp","=","vW",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_wr"],statements:[{type:"textline",tokens:["wr","=","vX",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_ws"],statements:[{type:"textline",tokens:["ws","=","vY",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_wt"],statements:[{type:"textline",tokens:["wt","=","vZ",";"]}]}]}]},{type:"node",name:"LIGHTING_AMBIENT",declarations:[{type:"node_in",name:"wu",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wv",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ww",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"wx",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"wy",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["wx","=","vec4","(","wu","+","ww","*","wv",",","ZERO_VALUE_NODES",")",";","wy","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"LIGHTING_LAMP",declarations:[{type:"node_in",
name:"wz",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"wA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"wB",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"wC",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"wD",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["wB","=","u_light_factors","[","LAMP_LIGHT_FACT_IND","]",".","LAMP_FAC_CHANNELS",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE",
"HEMI",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["wD","=","vN",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["wD","=","ZERO_VALUE_NODES",";"]}]}]},{type:"textline",tokens:["wC","=","u_light_color_intensities","[","LAMP_IND","]",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_SHADOW_MAP_IND",1,{type:"negative_expr",places:1},{type:"non_equal_expr",places:2}],statements:[{type:"textline",tokens:["wC","*=","wz","[","LAMP_SHADOW_MAP_IND",
"]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2},"LAMP_TYPE","POINT",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],statements:[{type:"textline",tokens:["wi","=","u_light_positions","[","LAMP_IND","]",";","wA","=","wi","-","vS",";"]},{type:"textline",tokens:["wb","=","length","(","wA",")",";","wC","*=","LAMP_LIGHT_DIST","/","(","LAMP_LIGHT_DIST","+","wb","*","wb",")",";","wA","=","normalize","(","wA",")",";"]},
{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["wi","=","u_light_directions","[","LAMP_IND","]",";","wb","=","dot","(","wA",",","wi",")",";","wb","*=","smoothstep","(","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",",","(","wb","-","LAMP_SPOT_SIZE",")","/","LAMP_SPOT_BLEND",")",";","wC","*=","wb",";"]}]}]}]},{type:"node_else",statements:[{type:"textline",tokens:["wA","=","u_light_directions","[","LAMP_IND",
"]",";"]}]}]}]},{type:"node",name:"DIFFUSE_FRESNEL",declarations:[{type:"node_in",name:"wE",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wF",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"wG",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wH",qualifier:["float"],is_optional:false},{type:"node_in",name:"wI",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"wJ",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["wJ","=","ZERO_VALUE_NODES",
";","if","(","wF",".","r","!=","ZERO_VALUE_NODES",")","{","wb","=","(","UNITY_VALUE_NODES","-","wH",")","*","dot","(","wG",",","wE",")","+","wH",";","if","(","wI","[","0","]","==","ZERO_VALUE_NODES",")","{","wJ","=","UNITY_VALUE_NODES",";","}","else","{","wb","=","UNITY_VALUE_NODES","+","abs","(","wb",")",";","wb","=","wI","[","1","]","+","(","UNITY_VALUE_NODES","-","wI","[","1","]",")","*","pow","(","wb",",","wI","[","0","]",")",";","wJ","=","clamp","(","wb",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";","}","wJ","=","max","(","wJ",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_LAMBERT",declarations:[{type:"node_in",name:"wK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wL",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"wM",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wN",qualifier:["float"],is_optional:false},{type:"node_out",name:"wO",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["wO","=","ZERO_VALUE_NODES",
";","if","(","wL",".","r","!=","ZERO_VALUE_NODES",")","{","wb","=","(","UNITY_VALUE_NODES","-","wN",")","*","dot","(","wM",",","wK",")","+","wN",";","wO","=","max","(","wb",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_OREN_NAYAR",declarations:[{type:"node_in",name:"wP",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wQ",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"wR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wS",qualifier:["float"],
is_optional:false},{type:"node_in",name:"wT",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"wU",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["wU","=","ZERO_VALUE_NODES",";","if","(","wQ",".","r","!=","ZERO_VALUE_NODES",")","{","wb","=","(","UNITY_VALUE_NODES","-","wS",")","*","dot","(","wR",",","wP",")","+","wS",";","if","(","wT","[","0","]",">","ZERO_VALUE_NODES",")","{","wc","=","max","(","dot","(","wR",",","vU",")",",","ZERO_VALUE_NODES",")",";","wd",
"=","wT","[","0","]","*","wT","[","0","]",";","we","=","UNITY_VALUE_NODES","-","vN","*","(","wd","/","(","wd","+","0.33",")",")",";","wi","=","wP","-","wb","*","wR",";","wj","=","vU","-","wc","*","wR",";"]},{type:"textline",tokens:["if","(","length","(","wi",")","==","ZERO_VALUE_NODES","||","length","(","wj",")","==","ZERO_VALUE_NODES","||","abs","(","wb",")",">","UNITY_VALUE_NODES","||","abs","(","wc",")",">","UNITY_VALUE_NODES",")"]},{type:"textline",tokens:["wU","=","wb","*","we",";","else","{",
"wf","=","acos","(","wb",")",";","wc","=","acos","(","wc",")",";","wi","=","normalize","(","wi",")",";","wj","=","normalize","(","wj",")",";","wg","=","max","(","wf",",","wc",")",";","wh","=","min","(","wf",",","wc",")",";","wh","*=","0.95",";","wc","=","max","(","dot","(","wi",",","wj",")",",","ZERO_VALUE_NODES",")",";","wd","=","0.45","*","(","wd","/","(","wd","+","0.09",")",")",";","wU","=","wb","*","(","we","+","(","wd","*","wc","*","sin","(","wg",")","*","tan","(","wh",")",")",")",";","}","}",
"else","wU","=","wb",";","wU","=","max","(","wU",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_MINNAERT",declarations:[{type:"node_in",name:"wV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wW",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"wX",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"wY",qualifier:["float"],is_optional:false},{type:"node_in",name:"wZ",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"w_",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["w_","=","ZERO_VALUE_NODES",";","if","(","wW",".","r","!=","ZERO_VALUE_NODES",")","{","wb","=","(","UNITY_VALUE_NODES","-","wY",")","*","dot","(","wX",",","wV",")","+","wY",";","wh","=","max","(","dot","(","wX",",","vU",")",",","ZERO_VALUE_NODES",")",";","if","(","wZ","[","0","]","<=","UNITY_VALUE_NODES",")","w_","=","wb","*","pow","(","max","(","wh","*","wb",",","0.1",")",",","wZ","[","0","]","-","UNITY_VALUE_NODES",")",";","else","w_","=",
"wb","*","pow","(","1.0001","-","wh",",","wZ","[","0","]","-","UNITY_VALUE_NODES",")",";","w_","=","max","(","w_",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_TOON",declarations:[{type:"node_in",name:"xa",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xb",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"xc",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xd",qualifier:["float"],is_optional:false},{type:"node_in",name:"xe",qualifier:["vec2"],
is_optional:false},{type:"node_out",name:"xf",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["xf","=","ZERO_VALUE_NODES",";","if","(","xb",".","r","!=","ZERO_VALUE_NODES",")","{","wh","=","(","UNITY_VALUE_NODES","-","xd",")","*","dot","(","xc",",","xa",")","+","xd",";","wh","=","acos","(","wh",")",";","if","(","wh","<","xe","[","0","]",")","xf","=","UNITY_VALUE_NODES",";","else","if","(","wh",">","(","xe","[","0","]","+","xe","[","1","]",")","||","xe","[","1","]","==",
"ZERO_VALUE_NODES",")","xf","=","ZERO_VALUE_NODES",";","else","xf","=","UNITY_VALUE_NODES","-","(","(","wh","-","xe","[","0","]",")","/","xe","[","1","]",")",";","xf","=","max","(","xf",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"SPECULAR_PHONG",declarations:[{type:"node_in",name:"xg",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xh",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"xi",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xj",qualifier:["float"],
is_optional:false},{type:"node_in",name:"xk",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"xl",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["xl","=","ZERO_VALUE_NODES",";","if","(","xh",".","g","!=","ZERO_VALUE_NODES",")","{","wj","=","normalize","(","xg","+","vU",")",";","xl","=","(","UNITY_VALUE_NODES","-","xj",")","*","max","(","dot","(","xi",",","wj",")",",","ZERO_VALUE_NODES",")","+","xj",";","xl","=","pow","(","xl",",","xk","[","0","]",")",";",
"}"]}]},{type:"node",name:"SPECULAR_WARDISO",declarations:[{type:"node_in",name:"xm",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xn",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"xo",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xp",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"xq",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["xq","=","ZERO_VALUE_NODES",";","if","(","xn",".","g","!=","ZERO_VALUE_NODES",")",
"{","wj","=","normalize","(","xm","+","vU",")",";","wh","=","max","(","dot","(","xo",",","wj",")",",","0.001",")",";"]},{type:"textline",tokens:["wb","=","max","(","dot","(","xo",",","vU",")",",","0.01",")",";","wg","=","max","(","dot","(","xo",",","xm",")",",","0.01",")",";","wh","=","tan","(","acos","(","wh",")",")",";","wc","=","max","(","xp","[","0","]",",","0.001",")",";","xq","=","wg","*","(","UNITY_VALUE_NODES","/","(","4.0","*","M_PI","*","wc","*","wc",")",")","*","(","exp","(","-","(","wh",
"*","wh",")","/","(","wc","*","wc",")",")","/","(","sqrt","(","wb","*","wg",")",")",")",";","}"]}]},{type:"node",name:"SPECULAR_TOON",declarations:[{type:"node_in",name:"xr",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xs",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"xt",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xu",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"xv",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["xv",
"=","ZERO_VALUE_NODES",";","if","(","xs",".","g","!=","ZERO_VALUE_NODES",")","{","wj","=","normalize","(","xr","+","vU",")",";","wg","=","acos","(","dot","(","wj",",","xt",")",")",";","if","(","wg","<","xu","[","0","]",")","xv","=","UNITY_VALUE_NODES",";","else","if","(","wg",">=","xu","[","0","]","+","xu","[","1","]","||","xu","[","1","]","==","ZERO_VALUE_NODES",")","xv","=","ZERO_VALUE_NODES",";","else","xv","=","UNITY_VALUE_NODES","-","(","wg","-","xu","[","0","]",")","/","xu","[","1","]",";",
"}"]}]},{type:"node",name:"SPECULAR_BLINN",declarations:[{type:"node_in",name:"xw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xx",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"xy",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xz",qualifier:["float"],is_optional:false},{type:"node_in",name:"xA",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"xB",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["xB","=","ZERO_VALUE_NODES",
";","if","(","xx",".","g","!=","ZERO_VALUE_NODES",")","{","if","(","xA","[","0","]","<","1.0","||","xA","[","1","]","==","ZERO_VALUE_NODES",")","xB","=","ZERO_VALUE_NODES",";","else","{","if","(","xA","[","1","]","<","100.0",")","xA","[","1","]","=","sqrt","(","1.0","/","xA","[","1","]",")",";","else","xA","[","1","]","=","10.0","/","xA","[","1","]",";","wj","=","normalize","(","vU","+","xw",")",";","wg","=","(","UNITY_VALUE_NODES","-","xz",")","*","max","(","dot","(","xy",",","wj",")",",","ZERO_VALUE_NODES",
")","+","xz",";","if","(","wg","<","ZERO_VALUE_NODES",")","xB","=","ZERO_VALUE_NODES",";","else","{","wb","=","max","(","dot","(","xy",",","vU",")",",","0.01",")",";","wc","=","dot","(","xy",",","xw",")",";","if","(","wc","<=","0.01",")","xB","=","ZERO_VALUE_NODES",";","else","{","wh","=","max","(","dot","(","vU",",","wj",")",",","0.01",")",";","wd","=","UNITY_VALUE_NODES",";","wb","=","(","2.0","*","wg","*","wb",")","/","wh",";","wc","=","(","2.0","*","wg","*","wc",")","/","wh",";","wc","=","min",
"(","min","(","wd",",","wb",")",",","wc",")",";","wb","=","sqrt","(","pow","(","xA","[","0","]",",","2.0",")","+","pow","(","wh",",","2.0",")","-","UNITY_VALUE_NODES",")",";","wh","=","pow","(","wb","-","wh",",","2.0",")","/","pow","(","wb","+","wh",",","2.0",")","*","(","UNITY_VALUE_NODES","+","pow","(","wh","*","(","wb","+","wh",")","-","UNITY_VALUE_NODES",",","2.0",")","/","pow","(","wh","*","(","wb","-","wh",")","+","UNITY_VALUE_NODES",",","2.0",")",")",";","wg","=","acos","(","wg",")",";","xB",
"=","max","(","wh","*","wc","*","exp","(","-","pow","(","wg",",","2.0",")","/","(","2.0","*","pow","(","xA","[","1","]",",","2.0",")",")",")",",","ZERO_VALUE_NODES",")",";","}","}","}","}"]}]},{type:"node",name:"LIGHTING_APPLY",declarations:[{type:"node_in",name:"xC",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"xD",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xE",qualifier:["float"],is_optional:false},{type:"node_in",name:"xF",qualifier:["float"],is_optional:false},{type:"node_in",
name:"xG",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xI",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"xJ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xL",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"xM",qualifier:["float"],is_optional:false},{type:"node_out",name:"xN",qualifier:["vec4"],is_optional:false},{type:"node_out",
name:"xO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["xO","=","xD","+","xL","*","xK","*","xF",";","xN","=","xC","+","vec4","(","xL","*","xJ","*","xE",",","xF",")",";"]}]},{type:"node",name:"LIGHTING_END",declarations:[{type:"node_in",name:"xP",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"xQ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["v_","=","xP",".","rgb",";","wa","=","xQ",";"]}]},{type:"nodes_global"},{type:"textline",
tokens:["void","xR","(","vec3","vO",",","vec3","vP",",","vec3","vQ",",","vec3","vR",",","vec3","vS",",","vec3","vT",",","vec3","vU",",","vec2","vV",",","vec2","vW",",","vec4","vX",",","float","vY",",","vec4","vZ",",","out","vec3","v_",",","out","vec3","wa",")","{","float","wb",",","wc",",","wd",",","we",",","wf",",","wg",",","wh",";","vec3","wi",",","wj",";"]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},exports["include/particles_nodes.glslf"]={type:"group",parts:[{type:"var",name:"MAPPING_TRS_MATRIX",
tokens:["mat4","(","0.0",")"]},{type:"var",name:"MAPPING_SCALE",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_TRANSLATION",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MIN_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_MAX_CLIP",tokens:["vec3","(","0.0",")"]},{type:"var",name:"MAPPING_IS_NORMAL",tokens:["0.0"]},{type:"var",name:"RGB_IND",tokens:["0"]},{type:"var",name:"VALUE_IND",tokens:["0"]},{type:"var",name:"LAMP_INDEX",tokens:["0"]},{type:"var",name:"NUM_LIGHTS",
tokens:["0"]},{type:"var",name:"LAMP_IND",tokens:["0"]},{type:"var",name:"LAMP_SPOT_SIZE",tokens:["0"]},{type:"var",name:"LAMP_SPOT_BLEND",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_DIST",tokens:["0"]},{type:"var",name:"LAMP_LIGHT_FACT_IND",tokens:["0"]},{type:"var",name:"LAMP_FAC_CHANNELS",tokens:["rgb"]},{type:"var",name:"LAMP_SHADOW_MAP_IND",tokens:["0"]},{type:"var",name:"NODE_TEX_ROW",tokens:["0.0"]},{type:"define",name:"M_PI",tokens:["3.14159265359"]},{type:"textline",tokens:["float","ZERO_VALUE_NODES",
"=","0.0",";","float","UNITY_VALUE_NODES","=","1.0",";","float","xS","=","0.5",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","USE_NODE_MIX_RGB_HUE","USE_NODE_MIX_RGB_SATURATION","USE_NODE_MIX_RGB_VALUE","USE_NODE_MIX_RGB_COLOR","USE_NODE_SEPHSV",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","xX","(","vec3","xT",")","{","float","xU",",","xV",";","vec4","xW",";","xW","=","vec4","(","ZERO_VALUE_NODES",",","-","UNITY_VALUE_NODES",
"/","3.0",",","2.0","/","3.0",",","-","UNITY_VALUE_NODES",")",";","xW","=","mix","(","vec4","(","xT",".","bg",",","xW",".","wz",")",",","vec4","(","xT",".","gb",",","xW",".","xy",")",",","step","(","xT",".","b",",","xT",".","g",")",")",";","xW","=","mix","(","vec4","(","xW",".","xyw",",","xT",".","r",")",",","vec4","(","xT",".","r",",","xW",".","yzx",")",",","step","(","xW",".","x",",","xT",".","r",")",")",";","xU","=","xW",".","x","-","min","(","xW",".","w",",","xW",".","y",")",";","xV","=","1.0e-10",
";","return","vec3","(","abs","(","xW",".","z","+","(","xW",".","w","-","xW",".","y",")","/","(","6.0","*","xU","+","xV",")",")",",","xU","/","(","xW",".","x","+","xV",")",",","xW",".","x",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_HUE_SAT","USE_NODE_MIX_RGB_HUE","USE_NODE_MIX_RGB_SATURATION","USE_NODE_MIX_RGB_VALUE","USE_NODE_MIX_RGB_COLOR","USE_NODE_COMBHSV",{type:"logical_or_expr",places:6}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","ya","(","vec3",
"xY",")","{","vec3","xZ",";","vec4","x_",";","x_","=","vec4","(","UNITY_VALUE_NODES",",","2.0","/","3.0",",","UNITY_VALUE_NODES","/","3.0",",","3.0",")",";","xZ","=","abs","(","fract","(","vec3","(","xY",".","r",",","xY",".","r",",","xY",".","r",")","+","x_",".","xyz",")","*","6.0","-","x_",".","www",")",";","return","xY",".","b","*","mix","(","x_",".","xxx",",","clamp","(","xZ","-","x_",".","xxx",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",",","xY",".","g",")",";","}"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["USE_NODE_GEOMETRY_UV","USE_NODE_B4W_PARALLAX","USE_NODE_UV_MERGED",{type:"logical_or_expr",places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","yc","(","vec2","yb",")","{","return","vec3","(","yb","*","2.0","-","vec2","(","UNITY_VALUE_NODES",",","UNITY_VALUE_NODES",")",",","ZERO_VALUE_NODES",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_TEXTURE_COLOR","USE_NODE_TEXTURE_NORMAL","USE_NODE_B4W_PARALLAX",{type:"logical_or_expr",
places:3}],group:{type:"group",parts:[{type:"textline",tokens:["vec2","ye","(","vec3","yd",")","{","return","vec2","(","yd",".","xy","*","xS","+","vec2","(","xS",",","xS",")",")",";","}"]}]}}]},{type:"node",name:"CAMERA",declarations:[{type:"node_out",name:"yT",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"yU",qualifier:["float"],is_optional:true},{type:"node_out",name:"yV",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yT"],
statements:[{type:"textline",tokens:["yT","=","normalize","(","yK",".","xyz",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yU"],statements:[{type:"textline",tokens:["yU","=","abs","(","yK",".","z",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_yV"],statements:[{type:"textline",tokens:["yV","=","length","(","yK",".","xyz",")",";"]}]}]}]},{type:"node",name:"COMBRGB",declarations:[{type:"node_in",name:"yW",qualifier:["float"],is_optional:false},
{type:"node_in",name:"yX",qualifier:["float"],is_optional:false},{type:"node_in",name:"yY",qualifier:["float"],is_optional:false},{type:"node_out",name:"yZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yZ","=","vec3","(","yW",",","yX",",","yY",")",";"]}]},{type:"node",name:"COMBHSV",declarations:[{type:"node_in",name:"y_",qualifier:["float"],is_optional:false},{type:"node_in",name:"za",qualifier:["float"],is_optional:false},{type:"node_in",name:"zb",qualifier:["float"],
is_optional:false},{type:"node_out",name:"zc",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zc","=","ya","(","vec3","(","y_",",","za",",","zb",")",")",";"]}]},{type:"node",name:"EMPTY_UV",declarations:[{type:"node_out",name:"zd",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zd","=","vec3","(","-","UNITY_VALUE_NODES",",","-","UNITY_VALUE_NODES",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"EMPTY_VC",declarations:[{type:"node_out",
name:"ze",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["ze","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"GEOMETRY_UV",declarations:[{type:"node_out",name:"zf",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zf","=","yc","(","bM",")",";"]}]},{type:"node",name:"GEOMETRY_OR",declarations:[{type:"node_out",name:"zg",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zg","=","2.0","*","vec3","(","bM",
",","ZERO_VALUE_NODES",")","-","vec3","(","UNITY_VALUE_NODES",")",";"]}]},{type:"node",name:"GEOMETRY_VC",declarations:[{type:"node_out",name:"zh",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zh","=","vec3","(","UNITY_VALUE_NODES",")",";"]}]},{type:"node",name:"GEOMETRY_VC1",declarations:[{type:"node_out",name:"zi",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["zi","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"GEOMETRY_VC2",declarations:[{type:"node_out",
name:"zj",qualifier:["float"],is_optional:false},{type:"node_out",name:"zk",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["zj","=","UNITY_VALUE_NODES",";","zk","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"GEOMETRY_VC3",declarations:[{type:"node_out",name:"zl",qualifier:["float"],is_optional:false},{type:"node_out",name:"zm",qualifier:["float"],is_optional:false},{type:"node_out",name:"zn",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["zl",
"=","UNITY_VALUE_NODES",";","zm","=","UNITY_VALUE_NODES",";","zn","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"GEOMETRY_NO",declarations:[{type:"node_out",name:"zo",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zo","=","yN",";"]}]},{type:"node",name:"GEOMETRY_FB",declarations:[{type:"node_out",name:"zp",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["INVERT_FRONTFACING"],statements:[{type:"textline",
tokens:["zp","=","(","gl_FrontFacing",")","?","ZERO_VALUE_NODES",":","UNITY_VALUE_NODES",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["zp","=","(","gl_FrontFacing",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]}]}]}]},{type:"node",name:"GEOMETRY_VW",declarations:[{type:"node_out",name:"zq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zq","=","yo",";"]}]},{type:"node",name:"GEOMETRY_LO",declarations:[{type:"node_out",name:"zr",qualifier:["vec3"],
is_optional:false}],statements:[{type:"textline",tokens:["zr","[","0","]","=","yK","[","0","]",";","zr","[","1","]","=","yK","[","1","]",";","zr","[","2","]","=","yK","[","2","]",";"]}]},{type:"node",name:"GEOMETRY_GL",declarations:[{type:"node_out",name:"zs",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zs","=","vec3","(","yO",".","r",",","-","yO",".","b",",","yO",".","g",")",";"]}]},{type:"node",name:"NEW_GEOMETRY",declarations:[{type:"node_out",name:"zt",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"zu",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zv",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zw",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zx",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zy",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zz",qualifier:["float"],is_optional:false},{type:"node_out",name:"zA",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["zt","=","vec3","(","ZERO_VALUE_NODES",")",";","zu","=","vec3","(","ZERO_VALUE_NODES",")",";","zv","=","vec3","(","ZERO_VALUE_NODES",")",";","zw","=","vec3","(","ZERO_VALUE_NODES",")",";","zx","=","vec3","(","ZERO_VALUE_NODES",")",";","zy","=","vec3","(","ZERO_VALUE_NODES",")",";","zz","=","ZERO_VALUE_NODES",";","zA","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"HUE_SAT",declarations:[{type:"node_in",name:"zB",qualifier:["float"],is_optional:false},{type:"node_in",name:"zC",qualifier:["float"],
is_optional:false},{type:"node_in",name:"zD",qualifier:["float"],is_optional:false},{type:"node_in",name:"zE",qualifier:["float"],is_optional:false},{type:"node_in",name:"zF",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zG",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yQ","=","xX","(","zF",")",";","yQ","[","0","]","+=","(","zB","-","xS",")",";","if","(","yQ","[","0","]",">","UNITY_VALUE_NODES",")","yQ","[","0","]","-=","UNITY_VALUE_NODES",";","else",
"if","(","yQ","[","0","]","<","ZERO_VALUE_NODES",")","yQ","[","0","]","+=","UNITY_VALUE_NODES",";","yQ","*=","vec3","(","UNITY_VALUE_NODES",",","zC",",","zD",")",";","yQ","=","mix","(","vec3","(","UNITY_VALUE_NODES",")",",","mix","(","vec3","(","ZERO_VALUE_NODES",")",",","yQ",",","step","(","vec3","(","ZERO_VALUE_NODES",")",",","yQ",")",")",",","step","(","yQ",",","vec3","(","UNITY_VALUE_NODES",")",")",")",";","zG","=","mix","(","zF",",","ya","(","yQ",")",",","zE",")",";"]}]},{type:"node",name:"INVERT",
declarations:[{type:"node_in",name:"zH",qualifier:["float"],is_optional:false},{type:"node_in",name:"zI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zJ","=","mix","(","zI",",","vec3","(","UNITY_VALUE_NODES",")","-","zI",",","zH",")",";"]}]},{type:"node",name:"LAMP",declarations:[{type:"node_out",name:"zK",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"zL",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"zM",qualifier:["float"],is_optional:false},{type:"node_out",name:"zN",qualifier:["float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_zK"],statements:[{type:"textline",tokens:["zK","=","u_lamp_light_color_intensities","[","LAMP_INDEX","]",";"]}]}]},{type:"textline",tokens:["yL","=","u_lamp_light_factors","[","LAMP_INDEX","]",";","yQ","=","u_lamp_light_directions","[","LAMP_INDEX","]",";","yR","=","u_lamp_light_positions",
"[","LAMP_INDEX","]",";","yD","=","yL",".","z",";","if","(","yD","!=","-","UNITY_VALUE_NODES",")","{"]},{type:"textline",tokens:["zL","=","yR","-","bC",";","zM","=","length","(","zL",")",";","zL","=","normalize","(","zL",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_zN"],statements:[{type:"textline",tokens:["zN","=","yD","/","(","yD","+","zM","*","zM",")",";","yD","=","yL",".","x",";","yE","=","yL",".","y",";","if","(","yD",">","-","UNITY_VALUE_NODES",")","{","yF","=",
"dot","(","zL",",","yQ",")",";","yF","*=","smoothstep","(","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",",","(","yF","-","yD",")","/","yE",")",";","zN","*=","yF",";","}"]}]}]},{type:"textline",tokens:["}","else","{"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_zL"],statements:[{type:"textline",tokens:["zL","=","yQ",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_zM"],statements:[{type:"textline",tokens:["zM","=","length","(","yR","-","bC",")",";"]}]}]},
{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_zN"],statements:[{type:"textline",tokens:["zN","=","UNITY_VALUE_NODES",";"]}]}]},{type:"textline",tokens:["}"]}]},{type:"node",name:"NORMAL",declarations:[{type:"node_in",name:"zO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zP",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"zQ",qualifier:["float"],is_optional:true},{type:"node_param",name:"yf",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_zP"],statements:[{type:"textline",tokens:["zP","=","yf",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_zQ"],statements:[{type:"textline",tokens:["zQ","=","-","dot","(","zO",",","yf",")",";"]}]}]}]},{type:"node",name:"B4W_VECTOR_VIEW",declarations:[{type:"node_in",name:"zR",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"zS",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zS","=","-",
"(","yp","*","vec4","(","zR",",","ZERO_VALUE_NODES",")",")",".","xyz",";"]}]},{type:"node",name:"BSDF_ANISOTROPIC",declarations:[{type:"node_in",name:"zT",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zU",qualifier:["float"],is_optional:false},{type:"node_in",name:"zV",qualifier:["float"],is_optional:false},{type:"node_in",name:"zW",qualifier:["float"],is_optional:false},{type:"node_in",name:"zX",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"zY",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"zZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["zZ","=","zT",";"]},{type:"textline",tokens:["zU",";","zV",";","zW",";","zX",";","zY",";"]}]},{type:"node",name:"BSDF_DIFFUSE",declarations:[{type:"node_in",name:"z_",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Aa",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ab",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ac",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["Ac","=","z_",";"]},{type:"textline",tokens:["Aa",";","Ab",";"]}]},{type:"node",name:"BSDF_GLASS",declarations:[{type:"node_in",name:"Ad",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ae",qualifier:["float"],is_optional:false},{type:"node_in",name:"Af",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ag",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ah",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",
tokens:["Ah","=","Ad",";"]},{type:"textline",tokens:["Ae",";","Af",";","Ag",";"]}]},{type:"node",name:"BSDF_GLOSSY",declarations:[{type:"node_in",name:"Ai",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Aj",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ak",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Al",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Al","=","Ai",";"]},{type:"textline",tokens:["Aj",";","Ak",";"]}]},{type:"node",
name:"BSDF_HAIR",declarations:[{type:"node_in",name:"Am",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"An",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ao",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ap",qualifier:["float"],is_optional:false},{type:"node_out",name:"Aq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Aq","=","Am",";"]},{type:"textline",tokens:["An",";","Ao",";","Ap",";"]}]},{type:"node",name:"BSDF_TRANSPARENT",
declarations:[{type:"node_in",name:"Ar",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"As",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["As","=","Ar",";"]}]},{type:"node",name:"BSDF_TRANSLUCENT",declarations:[{type:"node_in",name:"At",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Au",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Av",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Av","=","At",";"]},
{type:"textline",tokens:["Au",";"]}]},{type:"node",name:"BSDF_REFRACTION",declarations:[{type:"node_in",name:"Aw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ax",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ay",qualifier:["float"],is_optional:false},{type:"node_in",name:"Az",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"AA",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AA","[","0","]","=","AA","[","1","]","=","AA","[","2",
"]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["Aw",";","Ax",";","Ay",";","Az",";"]}]},{type:"node",name:"BSDF_TOON",declarations:[{type:"node_in",name:"AB",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AC",qualifier:["float"],is_optional:false},{type:"node_in",name:"AD",qualifier:["float"],is_optional:false},{type:"node_in",name:"AE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"AF",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AF",
"=","AB",";"]},{type:"textline",tokens:["AC",";","AD",";","AE",";"]}]},{type:"node",name:"BSDF_VELVET",declarations:[{type:"node_in",name:"AG",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AH",qualifier:["float"],is_optional:false},{type:"node_in",name:"AI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"AJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AJ","=","AG",";"]},{type:"textline",tokens:["AH",";","AI",";"]}]},{type:"node",name:"SUBSURFACE_SCATTERING",
declarations:[{type:"node_in",name:"AK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AL",qualifier:["float"],is_optional:false},{type:"node_in",name:"AM",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AN",qualifier:["float"],is_optional:false},{type:"node_in",name:"AO",qualifier:["float"],is_optional:false},{type:"node_in",name:"AP",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"AQ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AQ",
"[","0","]","=","AQ","[","1","]","=","AQ","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["AK",";","AM",";","AN",";","AO",";","AP",";","AL",";"]}]},{type:"node",name:"EMISSION",declarations:[{type:"node_in",name:"AR",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AS",qualifier:["float"],is_optional:false},{type:"node_out",name:"AT",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AT","=","AR",";"]},{type:"textline",tokens:["AS",";"]}]},{type:"node",
name:"AMBIENT_OCCLUSION",declarations:[{type:"node_in",name:"AU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"AV",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AV","[","0","]","=","AV","[","1","]","=","AV","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["AU",";"]}]},{type:"node",name:"HOLDOUT",declarations:[{type:"node_out",name:"AW",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AW","[","0","]","=","AW",
"[","1","]","=","AW","[","2","]","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"VOLUME_ABSORPTION",declarations:[{type:"node_in",name:"AX",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"AY",qualifier:["float"],is_optional:false},{type:"node_out",name:"AZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["AZ","[","0","]","=","AZ","[","1","]","=","AZ","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["AX",";","AY",";"]}]},{type:"node",name:"VOLUME_SCATTER",
declarations:[{type:"node_in",name:"A_",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ba",qualifier:["float"],is_optional:false},{type:"node_in",name:"Bb",qualifier:["float"],is_optional:false},{type:"node_out",name:"Bc",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Bc","[","0","]","=","Bc","[","1","]","=","Bc","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["A_",";","Ba",";","Bb",";"]}]},{type:"node",name:"BUMP",declarations:[{type:"node_in",
name:"Bd",qualifier:["float"],is_optional:false},{type:"node_in",name:"Be",qualifier:["float"],is_optional:false},{type:"node_in",name:"Bf",qualifier:["float"],is_optional:false},{type:"node_in",name:"Bg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Bh",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Bh","=","Bg",";"]},{type:"textline",tokens:["Bd",";","Be",";","Bf",";"]}]},{type:"node",name:"NORMAL_MAP",declarations:[{type:"node_in",name:"Bi",qualifier:["float"],
is_optional:false},{type:"node_in",name:"Bj",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Bk",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Bk","=","Bj",";"]},{type:"textline",tokens:["Bi",";"]}]},{type:"node",name:"VECT_TRANSFORM",declarations:[{type:"node_in",name:"Bl",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Bm",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["CONVERT_TYPE",
"WORLD_TO_WORLD",{type:"equal_expr",places:2},"CONVERT_TYPE","OBJECT_TO_OBJECT",{type:"equal_expr",places:2},"CONVERT_TYPE","CAMERA_TO_CAMERA",{type:"equal_expr",places:2},{type:"logical_or_expr",places:3}],statements:[{type:"textline",tokens:["Bm","=","Bl",";"]}]},{type:"node_else",statements:[{type:"node_condition",parts:[{type:"node_if",expression:["VECTOR_TYPE","VT_POINT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["yL","=","vec4","(","Bl",",","UNITY_VALUE_NODES",")",";"]}]},
{type:"node_else",statements:[{type:"textline",tokens:["yL","=","vec4","(","Bl",",","ZERO_VALUE_NODES",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["CONVERT_TYPE","VT_WORLD_TO_CAMERA",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Bm","=","(","yq","*","yL",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_WORLD_TO_OBJECT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Bm","=","(","yt","*","yL",")",".","xyz",
";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_OBJECT_TO_WORLD",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Bm","=","(","ys","*","yL",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_OBJECT_TO_CAMERA",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Bm","=","(","yq","*","ys","*","yL",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_CAMERA_TO_WORLD",{type:"equal_expr",places:2}],statements:[{type:"textline",
tokens:["Bm","=","(","yr","*","yL",")",".","xyz",";"]}]},{type:"node_elif",expression:["CONVERT_TYPE","VT_CAMERA_TO_OBJECT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Bm","=","(","yt","*","yr","*","yL",")",".","xyz",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["VECTOR_TYPE","VT_NORMAL",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Bm","=","normalize","(","Bm",")",";"]}]}]}]}]}]},{type:"node",name:"BLACKBODY",declarations:[{type:"node_in",
name:"Bn",qualifier:["float"],is_optional:false},{type:"node_out",name:"Bo",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Bo","[","0","]","=","Bo","[","1","]","=","Bo","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["Bn",";"]}]},{type:"node",name:"WAVELENGTH",declarations:[{type:"node_in",name:"Bp",qualifier:["float"],is_optional:false},{type:"node_out",name:"Bq",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Bq","[","0",
"]","=","Bq","[","1","]","=","Bq","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["Bp",";"]}]},{type:"node",name:"SEPXYZ",declarations:[{type:"node_in",name:"Br",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Bs",qualifier:["float"],is_optional:false},{type:"node_out",name:"Bt",qualifier:["float"],is_optional:false},{type:"node_out",name:"Bu",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Bs","=","Br","[","0","]",";","Bt","=","Br","[",
"1","]",";","Bu","=","Br","[","2","]",";"]}]},{type:"node",name:"COMBXYZ",declarations:[{type:"node_in",name:"Bv",qualifier:["float"],is_optional:false},{type:"node_in",name:"Bw",qualifier:["float"],is_optional:false},{type:"node_in",name:"Bx",qualifier:["float"],is_optional:false},{type:"node_out",name:"By",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["By","[","0","]","=","Bv",";","By","[","1","]","=","Bw",";","By","[","2","]","=","Bx",";"]}]},{type:"node",name:"BRIGHTCONTRAST",
declarations:[{type:"node_in",name:"Bz",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"BA",qualifier:["float"],is_optional:false},{type:"node_in",name:"BB",qualifier:["float"],is_optional:false},{type:"node_out",name:"BC",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yF","=","BA","-","BB","*","xS",";","BC","=","max","(","(","UNITY_VALUE_NODES","+","BB",")","*","Bz","+","yF",",","vec3","(","ZERO_VALUE_NODES",")",")",";"]}]},{type:"node",name:"LIGHT_FALLOFF",
declarations:[{type:"node_in",name:"BD",qualifier:["float"],is_optional:false},{type:"node_in",name:"BE",qualifier:["float"],is_optional:false},{type:"node_out",name:"BF",qualifier:["float"],is_optional:false},{type:"node_out",name:"BG",qualifier:["float"],is_optional:false},{type:"node_out",name:"BH",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["BF","=","BG","=","BH","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["BD",";","BE",";"]}]},{type:"node",name:"TEX_IMAGE",
declarations:[{type:"node_in",name:"BI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"BJ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"BK",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["BJ","[","0","]","=","BJ","[","1","]","=","BJ","[","2","]","=","ZERO_VALUE_NODES",";","BK","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["BI",";"]}]},{type:"node",name:"TEX_ENVIRONMENT",declarations:[{type:"node_in",name:"BL",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"BM",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["BM","[","0","]","=","BM","[","1","]","=","BM","[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["BL",";"]}]},{type:"node",name:"TEX_SKY",declarations:[{type:"node_in",name:"BN",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"BO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["BO","[","0","]","=","BO","[","1","]","=","BO",
"[","2","]","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["BN",";"]}]},{type:"node",name:"TEX_NOISE",declarations:[{type:"node_in",name:"BP",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"BQ",qualifier:["float"],is_optional:false},{type:"node_in",name:"BR",qualifier:["float"],is_optional:false},{type:"node_in",name:"BS",qualifier:["float"],is_optional:false},{type:"node_out",name:"BT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"BU",qualifier:["float"],is_optional:false}],
statements:[{type:"textline",tokens:["BT","[","0","]","=","BT","[","1","]","=","BT","[","2","]","=","ZERO_VALUE_NODES",";","BU","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["BP",";","BQ",";","BR",";","BS",";"]}]},{type:"node",name:"TEX_WAVE",declarations:[{type:"node_in",name:"BV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"BW",qualifier:["float"],is_optional:false},{type:"node_in",name:"BX",qualifier:["float"],is_optional:false},{type:"node_in",name:"BY",qualifier:["float"],
is_optional:false},{type:"node_in",name:"BZ",qualifier:["float"],is_optional:false},{type:"node_out",name:"B_",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ca",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["B_","[","0","]","=","B_","[","1","]","=","B_","[","2","]","=","ZERO_VALUE_NODES",";","Ca","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["BV",";","BW",";","BX",";","BY",";","BZ",";"]}]},{type:"node",name:"TEX_VORONOI",declarations:[{type:"node_in",
name:"Cb",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Cc",qualifier:["float"],is_optional:false},{type:"node_out",name:"Cd",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ce",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Cd","[","0","]","=","Cd","[","1","]","=","Cd","[","2","]","=","ZERO_VALUE_NODES",";","Ce","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["Cb",";","Cc",";"]}]},{type:"node",name:"TEX_MUSGRAVE",declarations:[{type:"node_in",
name:"Cf",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Cg",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ch",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ci",qualifier:["float"],is_optional:false},{type:"node_in",name:"Cj",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ck",qualifier:["float"],is_optional:false},{type:"node_in",name:"Cl",qualifier:["float"],is_optional:false},{type:"node_out",name:"Cm",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"Cn",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Cm","[","0","]","=","Cm","[","1","]","=","Cm","[","2","]","=","ZERO_VALUE_NODES",";","Cn","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["Cf",";","Cg",";","Ch",";","Ci",";","Cj",";","Ck",";","Cl",";"]}]},{type:"node",name:"TEX_GRADIENT",declarations:[{type:"node_in",name:"Co",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Cp",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"Cq",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Cp","[","0","]","=","Cp","[","1","]","=","Cp","[","2","]","=","ZERO_VALUE_NODES",";","Cq","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["Co",";"]}]},{type:"node",name:"TEX_MAGIC",declarations:[{type:"node_in",name:"Cr",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Cs",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ct",qualifier:["float"],is_optional:false},{type:"node_out",
name:"Cu",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Cv",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Cu","[","0","]","=","Cu","[","1","]","=","Cu","[","2","]","=","ZERO_VALUE_NODES",";","Cv","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["Cr",";","Cs",";","Ct",";"]}]},{type:"node",name:"TEX_CHECKER",declarations:[{type:"node_in",name:"Cw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Cx",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"Cy",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Cz",qualifier:["float"],is_optional:false},{type:"node_out",name:"CA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"CB",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["CA","[","0","]","=","CA","[","1","]","=","CA","[","2","]","=","ZERO_VALUE_NODES",";","CB","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["Cw",";","Cx",";","Cy",";","Cz",";"]}]},{type:"node",name:"TEX_BRICK",
declarations:[{type:"node_in",name:"CC",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"CD",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"CE",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"CF",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"CG",qualifier:["float"],is_optional:false},{type:"node_in",name:"CH",qualifier:["float"],is_optional:false},{type:"node_in",name:"CI",qualifier:["float"],is_optional:false},{type:"node_in",name:"CJ",qualifier:["float"],
is_optional:false},{type:"node_in",name:"CK",qualifier:["float"],is_optional:false},{type:"node_out",name:"CL",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"CM",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["CL","[","0","]","=","CL","[","1","]","=","CL","[","2","]","=","ZERO_VALUE_NODES",";","CM","=","UNITY_VALUE_NODES",";"]},{type:"textline",tokens:["CC",";","CD",";","CE",";","CF",";","CG",";","CH",";","CI",";","CJ",";","CK",";"]}]},{type:"node",name:"ADD_SHADER",
declarations:[{type:"node_in",name:"CN",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"CO",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"CP",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["CP","=","clamp","(","CN","+","CO",",","vec3","(","ZERO_VALUE_NODES",")",",","vec3","(","UNITY_VALUE_NODES",")",")",";"]}]},{type:"node",name:"MIX_SHADER",declarations:[{type:"node_in",name:"CQ",qualifier:["float"],is_optional:false},{type:"node_in",name:"CR",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"CS",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"CT",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yF","=","clamp","(","CQ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","CT","=","yF","*","CR","+","(","UNITY_VALUE_NODES","-","yF",")","*","CS",";"]}]},{type:"node",name:"UV_MERGED",declarations:[{type:"node_out",name:"CU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"CV",
qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_CU"],statements:[{type:"textline",tokens:["CU","=","yc","(","bM",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_CV"],statements:[{type:"textline",tokens:["CV","=","vec3","(","bM",",","ZERO_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"TEX_COORD_UV",declarations:[{type:"node_out",name:"CW",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",
tokens:["CW","=","vec3","(","bM",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"TEX_COORD_NO",declarations:[{type:"node_out",name:"CX",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["CX","=","yP",";"]}]},{type:"node",name:"TEX_COORD_GE",declarations:[{type:"node_out",name:"CY",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["CY","=","vec3","(","bM",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"TEX_COORD_OB",declarations:[{type:"node_out",
name:"CZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["CZ","[","0","]","=","CZ","[","1","]","=","CZ","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_CA",declarations:[{type:"node_out",name:"C_",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["C_","[","0","]","=","yK","[","0","]",";","C_","[","1","]","=","yK","[","1","]",";","C_","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_WI",declarations:[{type:"node_out",
name:"Da",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Da","[","0","]","=","Da","[","1","]","=","Da","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"TEX_COORD_RE",declarations:[{type:"node_out",name:"Db",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Db","[","0","]","=","Db","[","1","]","=","Db","[","2","]","=","UNITY_VALUE_NODES",";"]}]},{type:"node",name:"UVMAP",declarations:[{type:"node_out",name:"Dc",qualifier:["vec3"],
is_optional:false}],statements:[{type:"textline",tokens:["Dc","=","vec3","(","bM",",","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"PARTICLE_INFO",declarations:[{type:"node_out",name:"Dd",qualifier:["float"],is_optional:false},{type:"node_out",name:"De",qualifier:["float"],is_optional:false},{type:"node_out",name:"Df",qualifier:["float"],is_optional:false},{type:"node_out",name:"Dg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Dh",qualifier:["float"],is_optional:false},{type:"node_out",
name:"Di",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Dj",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"yg",qualifier:["varying","vec4"],is_optional:true},{type:"node_param",name:"yh",qualifier:["varying","vec3"],is_optional:true},{type:"node_param",name:"yi",qualifier:["varying","vec3"],is_optional:true},{type:"node_param",name:"yj",qualifier:["varying","vec3"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["PARTICLE_BATCH"],
statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Dd"],statements:[{type:"textline",tokens:["Dd","=","yg","[","0","]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_De"],statements:[{type:"textline",tokens:["De","=","yg","[","1","]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Df"],statements:[{type:"textline",tokens:["Df","=","yg","[","2","]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Dg"],
statements:[{type:"textline",tokens:["Dg","=","vec3","(","yh",".","r",",","-","yh",".","b",",","yh",".","g",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Dh"],statements:[{type:"textline",tokens:["Dh","=","yg","[","3","]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Di"],statements:[{type:"textline",tokens:["Di","=","vec3","(","yi",".","r",",","-","yi",".","b",",","yi",".","g",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_OUT_Dj"],statements:[{type:"textline",tokens:["Dj","=","vec3","(","yj",".","r",",","-","yj",".","b",",","yj",".","g",")",";"]}]}]}]},{type:"node_else",statements:[{type:"textline",tokens:["Dd","=","ZERO_VALUE_NODES",";","De","=","ZERO_VALUE_NODES",";","Df","=","ZERO_VALUE_NODES",";","Dg","=","vec3","(","ZERO_VALUE_NODES",")",";","Dh","=","ZERO_VALUE_NODES",";","Di","=","Dg",";","Dj","=","Dg",";"]}]}]}]},{type:"node",name:"HAIR_INFO",declarations:[{type:"node_out",name:"Dk",qualifier:["float"],
is_optional:false},{type:"node_out",name:"Dl",qualifier:["float"],is_optional:false},{type:"node_out",name:"Dm",qualifier:["float"],is_optional:false},{type:"node_out",name:"Dn",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Dk","=","ZERO_VALUE_NODES",";","Dl","=","ZERO_VALUE_NODES",";","Dm","=","ZERO_VALUE_NODES",";","Dn","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"OBJECT_INFO",declarations:[{type:"node_out",name:"Do",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"Dp",qualifier:["float"],is_optional:false},{type:"node_out",name:"Dq",qualifier:["float"],is_optional:false},{type:"node_out",name:"Dr",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Dp","=","ZERO_VALUE_NODES",";","Dq","=","ZERO_VALUE_NODES",";","Dr","=","ZERO_VALUE_NODES",";","Do","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"WIREFRAME",declarations:[{type:"node_in",name:"Ds",qualifier:["float"],is_optional:false},{type:"node_out",
name:"Dt",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Dt","=","Ds",";"]}]},{type:"node",name:"TANGENT",declarations:[{type:"node_out",name:"Du",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Du","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"LAYER_WEIGHT",declarations:[{type:"node_in",name:"Dv",qualifier:["float"],is_optional:false},{type:"node_in",name:"Dw",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Dx",
qualifier:["float"],is_optional:false},{type:"node_out",name:"Dy",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Dx","=","Dy","=","ZERO_VALUE_NODES",";"]},{type:"textline",tokens:["Dw",";","Dv",";"]}]},{type:"node",name:"LIGHT_PATH",declarations:[{type:"node_out",name:"Dz",qualifier:["float"],is_optional:false},{type:"node_out",name:"DA",qualifier:["float"],is_optional:false},{type:"node_out",name:"DB",qualifier:["float"],is_optional:false},{type:"node_out",name:"DC",
qualifier:["float"],is_optional:false},{type:"node_out",name:"DD",qualifier:["float"],is_optional:false},{type:"node_out",name:"DE",qualifier:["float"],is_optional:false},{type:"node_out",name:"DF",qualifier:["float"],is_optional:false},{type:"node_out",name:"DG",qualifier:["float"],is_optional:false},{type:"node_out",name:"DH",qualifier:["float"],is_optional:false},{type:"node_out",name:"DI",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Dz","=","DA","=","DB","=","ZERO_VALUE_NODES",
";","DC","=","DD","=","DE","=","ZERO_VALUE_NODES",";","DF","=","DF","=","DH","=","DI","=","ZERO_VALUE_NODES",";","DG","=","ZERO_VALUE_NODES",";"]}]},{type:"node",name:"ATTRIBUTE",declarations:[{type:"node_out",name:"DJ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"DK",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"DL",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["DJ","=","DK","=","vec3","(","ZERO_VALUE_NODES",")",";","DL","=","ZERO_VALUE_NODES",
";"]}]},{type:"node",name:"SCRIPT",declarations:[],statements:[]},{type:"node",name:"CURVE_VEC",declarations:[{type:"node_in",name:"DM",qualifier:["float"],is_optional:false},{type:"node_in",name:"DN",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"DO",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["DO","=","DN",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_R"],statements:[{type:"textline",tokens:["DO",".","r","=","(","texture2D","(",
"u_nodes_texture",",","vec2","(","0.5","*","DN",".","r","+","0.5",",","NODE_TEX_ROW",")",")",".","r","-","0.5",")","*","2.0",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_G"],statements:[{type:"textline",tokens:["DO",".","g","=","(","texture2D","(","u_nodes_texture",",","vec2","(","0.5","*","DN",".","g","+","0.5",",","NODE_TEX_ROW",")",")",".","g","-","0.5",")","*","2.0",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_B"],statements:[{type:"textline",
tokens:["DO",".","b","=","(","texture2D","(","u_nodes_texture",",","vec2","(","0.5","*","DN",".","b","+","0.5",",","NODE_TEX_ROW",")",")",".","b","-","0.5",")","*","2.0",";"]}]}]},{type:"textline",tokens:["DO","=","mix","(","DN",",","DO",",","DM",")",";"]}]},{type:"node",name:"CURVE_RGB",declarations:[{type:"node_in",name:"DP",qualifier:["float"],is_optional:false},{type:"node_in",name:"DQ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"DR",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",
parts:[{type:"node_if",expression:["READ_A"],statements:[{type:"textline",tokens:["yF","=","texture2D","(","u_nodes_texture",",","vec2","(","DQ",".","r",",","NODE_TEX_ROW",")",")",".","a",";","yE","=","texture2D","(","u_nodes_texture",",","vec2","(","DQ",".","g",",","NODE_TEX_ROW",")",")",".","a",";","yD","=","texture2D","(","u_nodes_texture",",","vec2","(","DQ",".","b",",","NODE_TEX_ROW",")",")",".","a",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["yF","=","DQ",".","r",";","yE",
"=","DQ",".","g",";","yD","=","DQ",".","b",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_R"],statements:[{type:"textline",tokens:["DR",".","r","=","texture2D","(","u_nodes_texture",",","vec2","(","yF",",","NODE_TEX_ROW",")",")",".","r",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["DR",".","r","=","yF",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_G"],statements:[{type:"textline",tokens:["DR",".","g","=","texture2D","(","u_nodes_texture",
",","vec2","(","yE",",","NODE_TEX_ROW",")",")",".","g",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["DR",".","g","=","yE",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["READ_B"],statements:[{type:"textline",tokens:["DR",".","b","=","texture2D","(","u_nodes_texture",",","vec2","(","yD",",","NODE_TEX_ROW",")",")",".","b",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["DR",".","b","=","yD",";"]}]}]},{type:"textline",tokens:["DR","=","mix","(","DQ",
",","DR",",","DP",")",";"]}]},{type:"node",name:"VALTORGB",declarations:[{type:"node_in",name:"DS",qualifier:["float"],is_optional:false},{type:"node_out",name:"DT",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"DU",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["yL","=","texture2D","(","u_nodes_texture",",","vec2","(","DS",",","NODE_TEX_ROW",")",")",";","DT","=","yL",".","rgb",";","DU","=","yL",".","a",";"]}]},{type:"node",name:"MAPPING",declarations:[{type:"node_in",
name:"DV",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"DW",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["DW","=","DV",";"]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_TRS_MATRIX",statements:[{type:"textline",tokens:["DW","=","(","MAPPING_TRS_MATRIX","*","vec4","(","DW",",","UNITY_VALUE_NODES",")",")",".","xyz",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_SCALE",statements:[{type:"textline",tokens:["DW",
"=","DW","*","MAPPING_SCALE",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_TRANSLATION",statements:[{type:"textline",tokens:["DW","=","DW","+","MAPPING_TRANSLATION",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_MIN_CLIP",statements:[{type:"textline",tokens:["DW","=","max","(","DW",",","MAPPING_MIN_CLIP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_ifdef",name:"MAPPING_MAX_CLIP",statements:[{type:"textline",tokens:["DW","=","min","(",
"DW",",","MAPPING_MAX_CLIP",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MAPPING_IS_NORMAL"],statements:[{type:"textline",tokens:["DW","=","normalize","(","DW",")",";"]}]}]}]},{type:"node",name:"MATH_ADD",declarations:[{type:"node_in",name:"DX",qualifier:["float"],is_optional:false},{type:"node_in",name:"DY",qualifier:["float"],is_optional:false},{type:"node_out",name:"DZ",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["DZ","=","DX","+","DY",
";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["DZ","=","clamp","(","DZ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_SUBTRACT",declarations:[{type:"node_in",name:"D_",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ea",qualifier:["float"],is_optional:false},{type:"node_out",name:"Eb",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Eb","=","D_",
"-","Ea",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Eb","=","clamp","(","Eb",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MULTIPLY",declarations:[{type:"node_in",name:"Ec",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ed",qualifier:["float"],is_optional:false},{type:"node_out",name:"Ee",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Ee",
"=","Ec","*","Ed",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Ee","=","clamp","(","Ee",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_DIVIDE",declarations:[{type:"node_in",name:"Ef",qualifier:["float"],is_optional:false},{type:"node_in",name:"Eg",qualifier:["float"],is_optional:false},{type:"node_out",name:"Eh",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Eh",
"=","(","Eg","!=","ZERO_VALUE_NODES",")","?","Ef","/","Eg",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Eh","=","clamp","(","Eh",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_SINE",declarations:[{type:"node_in",name:"Ei",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ej",qualifier:["float"],is_optional:false},{type:"node_out",name:"Ek",qualifier:["float"],
is_optional:false}],statements:[{type:"textline",tokens:["Ek","=","sin","(","Ei",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Ek","=","clamp","(","Ek",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["Ej",";"]}]},{type:"node",name:"MATH_COSINE",declarations:[{type:"node_in",name:"El",qualifier:["float"],is_optional:false},{type:"node_in",name:"Em",qualifier:["float"],is_optional:false},
{type:"node_out",name:"En",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["En","=","cos","(","El",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["En","=","clamp","(","En",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["Em",";"]}]},{type:"node",name:"MATH_TANGENT",declarations:[{type:"node_in",name:"Eo",qualifier:["float"],is_optional:false},{type:"node_in",
name:"Ep",qualifier:["float"],is_optional:false},{type:"node_out",name:"Eq",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Eq","=","tan","(","Eo",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Eq","=","clamp","(","Eq",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["Ep",";"]}]},{type:"node",name:"MATH_ARCSINE",declarations:[{type:"node_in",name:"Er",qualifier:["float"],
is_optional:false},{type:"node_in",name:"Es",qualifier:["float"],is_optional:false},{type:"node_out",name:"Et",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Et","=","(","Er","<=","UNITY_VALUE_NODES","&&","Er",">=","-","UNITY_VALUE_NODES",")","?","asin","(","Er",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Et","=","clamp","(","Et",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";"]}]}]},{type:"textline",tokens:["Es",";"]}]},{type:"node",name:"MATH_ARCCOSINE",declarations:[{type:"node_in",name:"Eu",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ev",qualifier:["float"],is_optional:false},{type:"node_out",name:"Ew",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Ew","=","(","Eu","<=","UNITY_VALUE_NODES","&&","Eu",">=","-","UNITY_VALUE_NODES",")","?","acos","(","Eu",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",
expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Ew","=","clamp","(","Ew",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["Ev",";"]}]},{type:"node",name:"MATH_ARCTANGENT",declarations:[{type:"node_in",name:"Ex",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ey",qualifier:["float"],is_optional:false},{type:"node_out",name:"Ez",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Ez","=","atan","(","Ex",
")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["Ez","=","clamp","(","Ez",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["Ey",";"]}]},{type:"node",name:"MATH_POWER",declarations:[{type:"node_in",name:"EA",qualifier:["float"],is_optional:false},{type:"node_in",name:"EB",qualifier:["float"],is_optional:false},{type:"node_out",name:"EC",qualifier:["float"],is_optional:false}],statements:[{type:"textline",
tokens:["if","(","EA","<","ZERO_VALUE_NODES","&&","EB","!=","floor","(","EB",")",")","EC","=","ZERO_VALUE_NODES",";","else","if","(","EB","==","ZERO_VALUE_NODES",")"]},{type:"textline",tokens:["EC","=","UNITY_VALUE_NODES",";","else","if","(","EA","<","ZERO_VALUE_NODES",")","EC","=","mix","(","UNITY_VALUE_NODES",",","-","UNITY_VALUE_NODES",",","sign","(","mod","(","-","EB",",","2.0",")",")",")","*","pow","(","-","EA",",","EB",")",";","else","if","(","EA","==","ZERO_VALUE_NODES",")","EC","=","ZERO_VALUE_NODES",
";","else","EC","=","pow","(","EA",",","EB",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["EC","=","clamp","(","EC",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_LOGARITHM",declarations:[{type:"node_in",name:"ED",qualifier:["float"],is_optional:false},{type:"node_in",name:"EE",qualifier:["float"],is_optional:false},{type:"node_out",name:"EF",qualifier:["float"],is_optional:false}],
statements:[{type:"textline",tokens:["EF","=","(","ED",">","ZERO_VALUE_NODES","&&","EE",">","ZERO_VALUE_NODES",")","?","log2","(","ED",")","/","log2","(","EE",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["EF","=","clamp","(","EF",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MINIMUM",declarations:[{type:"node_in",name:"EG",qualifier:["float"],is_optional:false},
{type:"node_in",name:"EH",qualifier:["float"],is_optional:false},{type:"node_out",name:"EI",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["EI","=","min","(","EG",",","EH",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["EI","=","clamp","(","EI",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MAXIMUM",declarations:[{type:"node_in",name:"EJ",qualifier:["float"],
is_optional:false},{type:"node_in",name:"EK",qualifier:["float"],is_optional:false},{type:"node_out",name:"EL",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["EL","=","max","(","EJ",",","EK",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["EL","=","clamp","(","EL",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_ROUND",declarations:[{type:"node_in",name:"EM",
qualifier:["float"],is_optional:false},{type:"node_in",name:"EN",qualifier:["float"],is_optional:false},{type:"node_out",name:"EO",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["EO","=","floor","(","EM","+","xS",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["EO","=","clamp","(","EO",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["EN",";"]}]},{type:"node",
name:"MATH_LESS_THAN",declarations:[{type:"node_in",name:"EP",qualifier:["float"],is_optional:false},{type:"node_in",name:"EQ",qualifier:["float"],is_optional:false},{type:"node_out",name:"ER",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["ER","=","(","EP","<","EQ",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["ER","=","clamp","(","ER",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_GREATER_THAN",declarations:[{type:"node_in",name:"ES",qualifier:["float"],is_optional:false},{type:"node_in",name:"ET",qualifier:["float"],is_optional:false},{type:"node_out",name:"EU",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["EU","=","(","ES",">","ET",")","?","UNITY_VALUE_NODES",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",
tokens:["EU","=","clamp","(","EU",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_MODULO",declarations:[{type:"node_in",name:"EV",qualifier:["float"],is_optional:false},{type:"node_in",name:"EW",qualifier:["float"],is_optional:false},{type:"node_out",name:"EX",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["EX","=","abs","(","EW",")",">","0.000001","?","mod","(","EV",",","EW",")",":","ZERO_VALUE_NODES",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["EX","=","clamp","(","EX",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MATH_ABSOLUTE",declarations:[{type:"node_in",name:"EY",qualifier:["float"],is_optional:false},{type:"node_in",name:"EZ",qualifier:["float"],is_optional:false},{type:"node_out",name:"E_",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["E_","=","abs","(","EY",")",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["MATH_USE_CLAMP"],statements:[{type:"textline",tokens:["E_","=","clamp","(","E_",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["EZ",";"]}]},{type:"node",name:"MIX_RGB_MIX",declarations:[{type:"node_in",name:"Fa",qualifier:["float"],is_optional:false},{type:"node_in",name:"Fb",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Fc",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Fd",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["yD","=","clamp","(","Fa",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","Fd","=","mix","(","Fb",",","Fc",",","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Fd","=","clamp","(","Fd",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_ADD",declarations:[{type:"node_in",name:"Fe",qualifier:["float"],is_optional:false},{type:"node_in",
name:"Ff",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Fg",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Fh",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Fe",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","Fh","=","mix","(","Ff",",","Ff","+","Fg",",","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Fh","=","clamp","(","Fh",",",
"ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_MULTIPLY",declarations:[{type:"node_in",name:"Fi",qualifier:["float"],is_optional:false},{type:"node_in",name:"Fj",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Fk",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Fl",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Fi",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","Fl","=","mix",
"(","Fj",",","Fj","*","Fk",",","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Fl","=","clamp","(","Fl",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SUBTRACT",declarations:[{type:"node_in",name:"Fm",qualifier:["float"],is_optional:false},{type:"node_in",name:"Fn",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Fo",qualifier:["vec3"],is_optional:false},{type:"node_out",
name:"Fp",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Fm",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","Fp","=","mix","(","Fn",",","Fn","-","Fo",",","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Fp","=","clamp","(","Fp",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SCREEN",declarations:[{type:"node_in",name:"Fq",
qualifier:["float"],is_optional:false},{type:"node_in",name:"Fr",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Fs",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ft",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Fq",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yE","=","UNITY_VALUE_NODES","-","yD",";","Ft","=","vec3","(","UNITY_VALUE_NODES",")","-","(","vec3","(","yE",")","+","yD","*","(","vec3","(","UNITY_VALUE_NODES",
")","-","Fs",")",")","*","(","vec3","(","UNITY_VALUE_NODES",")","-","Fr",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Ft","=","clamp","(","Ft",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DIVIDE",declarations:[{type:"node_in",name:"Fu",qualifier:["float"],is_optional:false},{type:"node_in",name:"Fv",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Fw",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"Fx",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Fu",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yE","=","UNITY_VALUE_NODES","-","yD",";","Fw","+=","step","(","Fw",",","vec3","(","ZERO_VALUE_NODES",")",")",";","Fx","=","yE","*","Fv","+","yD","*","Fv","/","Fw",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Fx","=","clamp",
"(","Fx",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DIFFERENCE",declarations:[{type:"node_in",name:"Fy",qualifier:["float"],is_optional:false},{type:"node_in",name:"Fz",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"FB",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Fy",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";",
"FB","=","mix","(","Fz",",","abs","(","Fz","-","FA",")",",","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["FB","=","clamp","(","FB",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DARKEN",declarations:[{type:"node_in",name:"FC",qualifier:["float"],is_optional:false},{type:"node_in",name:"FD",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FE",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"FF",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","FC",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","FF","=","min","(","FD",".","rgb",",","FE",".","rgb","*","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["FF","=","clamp","(","FF",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_LIGHTEN",
declarations:[{type:"node_in",name:"FG",qualifier:["float"],is_optional:false},{type:"node_in",name:"FH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"FJ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","FG",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","FJ","=","max","(","FH",".","rgb",",","FI",".","rgb","*","yD",")",";"]},{type:"node_condition",parts:[{type:"node_if",
expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["FJ","=","clamp","(","FJ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_OVERLAY",declarations:[{type:"node_in",name:"FK",qualifier:["float"],is_optional:false},{type:"node_in",name:"FL",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"FN",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD",
"=","clamp","(","FK",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yR","=","vec3","(","UNITY_VALUE_NODES","-","yD",")",";","FN","=","mix","(","FL","*","(","yR","+","2.0","*","yD","*","FM",")",",","vec3","(","UNITY_VALUE_NODES",")","-","(","yR","+","2.0","*","yD","*","(","vec3","(","UNITY_VALUE_NODES",")","-","FM",")",")","*","(","vec3","(","UNITY_VALUE_NODES",")","-","FL",")",",","step","(","xS",",","FL",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],
statements:[{type:"textline",tokens:["FN","=","clamp","(","FN",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_DODGE",declarations:[{type:"node_in",name:"FO",qualifier:["float"],is_optional:false},{type:"node_in",name:"FP",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FQ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"FR",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","FO",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";","yR","=","vec3","(","UNITY_VALUE_NODES",")","-","yD","*","FQ",";","yQ","=","clamp","(","FP","/","yR",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","FR","=","mix","(","mix","(","yQ",",","vec3","(","UNITY_VALUE_NODES",")",",","step","(","yR",",","vec3","(","ZERO_VALUE_NODES",")",")",")",",","FP",",","step","(","FP",",","vec3","(","ZERO_VALUE_NODES",")",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",
tokens:["FR","=","clamp","(","FR",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_BURN",declarations:[{type:"node_in",name:"FS",qualifier:["float"],is_optional:false},{type:"node_in",name:"FT",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"FV",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","FS",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";","yR","=","vec3","(","UNITY_VALUE_NODES","-","yD",")",";","yR","=","yR","+","yD","*","FU",";","yQ","=","clamp","(","vec3","(","UNITY_VALUE_NODES",")","-","(","vec3","(","UNITY_VALUE_NODES",")","-","FT",")","/","yR",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","FV","=","mix","(","yQ",",","vec3","(","ZERO_VALUE_NODES",")",",","step","(","yR",",","vec3","(","ZERO_VALUE_NODES",")",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",
tokens:["FV","=","clamp","(","FV",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_HUE",declarations:[{type:"node_in",name:"FW",qualifier:["float"],is_optional:false},{type:"node_in",name:"FX",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"FY",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"FZ",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","FW",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";","FZ","=","FX",";","yQ","=","xX","(","FY",")",";","if","(","yQ",".","y","!=","ZERO_VALUE_NODES",")","{","yR","=","xX","(","FZ",")",";","yR",".","x","=","yQ",".","x",";","yS","=","ya","(","yR",")",";","FZ","=","mix","(","FZ",",","yS",",","yD",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["FZ","=","clamp","(","FZ",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SATURATION",
declarations:[{type:"node_in",name:"F_",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ga",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gb",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Gc",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","F_",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yE","=","UNITY_VALUE_NODES","-","yD",";","Gc","=","Ga",";","yS","=","xX","(","Gc",")",";","if","(","yS",".","y",
"!=","ZERO_VALUE_NODES",")","{","yR","=","xX","(","Gb",")",";","yS",".","y","=","yE","*","yS",".","y","+","yD","*","yR",".","y",";","Gc","=","ya","(","yS",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Gc","=","clamp","(","Gc",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_VALUE",declarations:[{type:"node_in",name:"Gd",qualifier:["float"],is_optional:false},{type:"node_in",
name:"Ge",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gf",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Gg",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Gd",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yE","=","UNITY_VALUE_NODES","-","yD",";","yS","=","xX","(","Ge",")",";","yR","=","xX","(","Gf",")",";","yS",".","z","=","yE","*","yS",".","z","+","yD","*","yR",".","z",";","Gg","=","ya","(","yS",")",";"]},
{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Gg","=","clamp","(","Gg",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_COLOR",declarations:[{type:"node_in",name:"Gh",qualifier:["float"],is_optional:false},{type:"node_in",name:"Gi",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gj",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Gk",qualifier:["vec3"],is_optional:false}],
statements:[{type:"textline",tokens:["yD","=","clamp","(","Gh",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","Gk","=","Gi",";","yR","=","xX","(","Gj",")",";","if","(","yR",".","y","!=","ZERO_VALUE_NODES",")","{","yS","=","xX","(","Gk",")",";","yS",".","x","=","yR",".","x",";","yS",".","y","=","yR",".","y",";","yQ","=","ya","(","yS",")",";","Gk","=","mix","(","Gk",",","yQ",",","yD",")",";","}"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",
tokens:["Gk","=","clamp","(","Gk",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_SOFT_LIGHT",declarations:[{type:"node_in",name:"Gl",qualifier:["float"],is_optional:false},{type:"node_in",name:"Gm",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gn",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Go",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Gl",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",
")",";","yE","=","UNITY_VALUE_NODES","-","yD",";","yQ","=","Gn","+","Gm","-","Gn","*","Gm",";","Go","=","Gm","*","(","vec3","(","yE",")","+","vec3","(","yD",")","*","(","(","vec3","(","UNITY_VALUE_NODES",")","-","Gm",")","*","Gn","+","yQ",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Go","=","clamp","(","Go",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"MIX_RGB_LINEAR_LIGHT",declarations:[{type:"node_in",
name:"Gp",qualifier:["float"],is_optional:false},{type:"node_in",name:"Gq",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gr",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Gs",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["yD","=","clamp","(","Gp",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","Gs","=","Gq","+","yD","*","(","2.0","*","Gr","-","vec3","(","UNITY_VALUE_NODES",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",
expression:["MIX_RGB_USE_CLAMP"],statements:[{type:"textline",tokens:["Gs","=","clamp","(","Gs",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]},{type:"node",name:"OUTPUT",declarations:[{type:"node_in",name:"Gt",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gu",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["yu","=","Gt",";","yy","=","Gu",";"]}]},{type:"node",name:"MATERIAL_BEGIN",declarations:[{type:"node_in",name:"Gv",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"Gw",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Gx",qualifier:["float"],is_optional:false},{type:"node_in",name:"Gy",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"Gz",qualifier:["float"],is_optional:true},{type:"node_out",name:"GA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"GB",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"GC",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"GD",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"GE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"GF",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"GG",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"GH",qualifier:["vec4"],is_optional:false},{type:"node_param",name:"yk",qualifier:["const","vec2"],is_optional:true},{type:"node_param",name:"yl",qualifier:["const","vec3"],is_optional:false}],statements:[{type:"textline",tokens:["GC","=","clamp","(","Gv",",","ZERO_VALUE_NODES",
",","UNITY_VALUE_NODES",")",";"]},{type:"textline",tokens:["GD","=","yl","[","0","]","*","clamp","(","Gw",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_NORMAL"],statements:[{type:"textline",tokens:["GE","=","normalize","(","Gy",")",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["GE","=","yP",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["SHADELESS_MAT",{type:"logic_negative_expr",
places:1}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT"],statements:[{type:"textline",tokens:["GA","=","Gz","*","GC",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["GA","=","yB","*","GC",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_DIFFUSE"],statements:[{type:"textline",tokens:["GC","*=","Gx",";"]}]}]},{type:"textline",tokens:["GB","=","yC","*","u_environment_energy","*","dS","(","GE",")",";","GH","=","vec4",
"(","1.0",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["NUM_LIGHTS",0,{type:"g_expr",places:2}],statements:[{type:"textline",tokens:["GF","=","vec2","(","yk","[","0","]",",","yk","[","1","]",")",";"]},{type:"textline",tokens:["GG","=","vec2","(","yl","[","1","]",",","yl","[","2","]",")",";"]}]}]},{type:"textline",tokens:["yx","=","GH",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["GA","=","vec3","(","ZERO_VALUE_NODES",")",";","GB","=","vec3","(","UNITY_VALUE_NODES",
")",";"]}]}]}]},{type:"node",name:"MATERIAL_END",declarations:[{type:"node_in",name:"GI",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"GJ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"GK",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"GL",qualifier:["float"],is_optional:true},{type:"node_in",name:"GM",qualifier:["float"],is_optional:true},{type:"node_in",name:"GN",qualifier:["float"],is_optional:true},{type:"node_out",name:"GO",qualifier:["vec3"],is_optional:true},
{type:"node_out",name:"GP",qualifier:["float"],is_optional:true},{type:"node_out",name:"GQ",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"GR",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"GS",qualifier:["vec3"],is_optional:true},{type:"node_param",name:"ym",qualifier:["float"],is_optional:false},{type:"node_param",name:"yn",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["GL",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_GO"],
statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_DIFFUSE"],statements:[{type:"textline",tokens:["GO","=","GI",".","rgb",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["GO","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["GO","+=","GJ",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_GQ"],statements:[{type:"textline",
tokens:["GQ","=","GK",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["MATERIAL_EXT"],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_GR"],statements:[{type:"textline",tokens:["GR","=","GI",".","rgb",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_GS"],statements:[{type:"textline",tokens:["GS","=","GJ",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_GP"],statements:[{type:"textline",tokens:["GP",
"=","clamp","(","GN",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["yD","=","max","(","max","(","GJ",".","r",",","GJ",".","g",")",",","GJ",".","b",")","*","GM",";","GP","=","clamp","(","GN","*","(","UNITY_VALUE_NODES","-","yD",")","+","yD",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]}]}]}]}]},{type:"node_else",statements:[{type:"node_condition",parts:[{type:"node_if",
expression:["USE_OUT_GP"],statements:[{type:"textline",tokens:["GP","=","clamp","(","ym",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],statements:[{type:"textline",tokens:["yD","=","max","(","max","(","GJ",".","r",",","GJ",".","g",")",",","GJ",".","b",")","*","yn",";","GP","=","ym","*","(","UNITY_VALUE_NODES","-","yD",")","+","yD",";"]}]}]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_MATERIAL_SPECULAR"],
statements:[{type:"textline",tokens:["yv","=","GJ",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["yv","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]}]},{type:"textline",tokens:["yw","=","GK",";"]}]},{type:"node",name:"LIGHTING_AMBIENT",declarations:[{type:"node_in",name:"GT",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"GU",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"GV",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"GW",qualifier:["vec4"],
is_optional:false},{type:"node_out",name:"GX",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["GW","=","vec4","(","GT","+","GV","*","GU",",","ZERO_VALUE_NODES",")",";","GX","=","vec3","(","ZERO_VALUE_NODES",")",";"]}]},{type:"node",name:"LIGHTING_LAMP",declarations:[{type:"node_in",name:"GY",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"GZ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"G_",qualifier:["vec2"],is_optional:false},{type:"node_out",
name:"Ha",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Hb",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["G_","=","u_light_factors","[","LAMP_LIGHT_FACT_IND","]",".","LAMP_FAC_CHANNELS",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","HEMI",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["Hb","=","xS",";"]}]},{type:"node_else",statements:[{type:"textline",tokens:["Hb","=","ZERO_VALUE_NODES",";"]}]}]},{type:"textline",
tokens:["Ha","=","u_light_color_intensities","[","LAMP_IND","]",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_SHADOW_MAP_IND",1,{type:"negative_expr",places:1},{type:"non_equal_expr",places:2}],statements:[{type:"textline",tokens:["Ha","*=","GY","[","LAMP_SHADOW_MAP_IND","]",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2},"LAMP_TYPE","POINT",{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],statements:[{type:"textline",
tokens:["yQ","=","u_light_positions","[","LAMP_IND","]",";","GZ","=","yQ","-","yO",";"]},{type:"textline",tokens:["yD","=","length","(","GZ",")",";","Ha","*=","LAMP_LIGHT_DIST","/","(","LAMP_LIGHT_DIST","+","yD","*","yD",")",";","GZ","=","normalize","(","GZ",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["LAMP_TYPE","SPOT",{type:"equal_expr",places:2}],statements:[{type:"textline",tokens:["yQ","=","u_light_directions","[","LAMP_IND","]",";","yD","=","dot","(","GZ",",","yQ",")",
";","yD","*=","smoothstep","(","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",",","(","yD","-","LAMP_SPOT_SIZE",")","/","LAMP_SPOT_BLEND",")",";","Ha","*=","yD",";"]}]}]}]},{type:"node_else",statements:[{type:"textline",tokens:["GZ","=","u_light_directions","[","LAMP_IND","]",";"]}]}]}]},{type:"node",name:"DIFFUSE_FRESNEL",declarations:[{type:"node_in",name:"Hc",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Hd",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"He",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"Hf",qualifier:["float"],is_optional:false},{type:"node_in",name:"Hg",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"Hh",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Hh","=","ZERO_VALUE_NODES",";","if","(","Hd",".","r","!=","ZERO_VALUE_NODES",")","{","yD","=","(","UNITY_VALUE_NODES","-","Hf",")","*","dot","(","He",",","Hc",")","+","Hf",";","if","(","Hg","[","0","]","==","ZERO_VALUE_NODES",")","{","Hh","=","UNITY_VALUE_NODES",
";","}","else","{","yD","=","UNITY_VALUE_NODES","+","abs","(","yD",")",";","yD","=","Hg","[","1","]","+","(","UNITY_VALUE_NODES","-","Hg","[","1","]",")","*","pow","(","yD",",","Hg","[","0","]",")",";","Hh","=","clamp","(","yD",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","}","Hh","=","max","(","Hh",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_LAMBERT",declarations:[{type:"node_in",name:"Hi",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Hj",qualifier:["vec2"],
is_optional:false},{type:"node_in",name:"Hk",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Hl",qualifier:["float"],is_optional:false},{type:"node_out",name:"Hm",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Hm","=","ZERO_VALUE_NODES",";","if","(","Hj",".","r","!=","ZERO_VALUE_NODES",")","{","yD","=","(","UNITY_VALUE_NODES","-","Hl",")","*","dot","(","Hk",",","Hi",")","+","Hl",";","Hm","=","max","(","yD",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",
name:"DIFFUSE_OREN_NAYAR",declarations:[{type:"node_in",name:"Hn",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ho",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"Hp",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Hq",qualifier:["float"],is_optional:false},{type:"node_in",name:"Hr",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"Hs",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Hs","=","ZERO_VALUE_NODES",";","if",
"(","Ho",".","r","!=","ZERO_VALUE_NODES",")","{","yD","=","(","UNITY_VALUE_NODES","-","Hq",")","*","dot","(","Hp",",","Hn",")","+","Hq",";","if","(","Hr","[","0","]",">","ZERO_VALUE_NODES",")","{","yE","=","max","(","dot","(","Hp",",","yo",")",",","ZERO_VALUE_NODES",")",";","yF","=","Hr","[","0","]","*","Hr","[","0","]",";","yG","=","UNITY_VALUE_NODES","-","xS","*","(","yF","/","(","yF","+","0.33",")",")",";","yQ","=","Hn","-","yD","*","Hp",";","yS","=","yo","-","yE","*","Hp",";"]},{type:"textline",
tokens:["if","(","length","(","yQ",")","==","ZERO_VALUE_NODES","||","length","(","yS",")","==","ZERO_VALUE_NODES","||","abs","(","yD",")",">","UNITY_VALUE_NODES","||","abs","(","yE",")",">","UNITY_VALUE_NODES",")"]},{type:"textline",tokens:["Hs","=","yD","*","yG",";","else","{","yH","=","acos","(","yD",")",";","yE","=","acos","(","yE",")",";","yQ","=","normalize","(","yQ",")",";","yS","=","normalize","(","yS",")",";","yI","=","max","(","yH",",","yE",")",";","yJ","=","min","(","yH",",","yE",")",";",
"yJ","*=","0.95",";","yE","=","max","(","dot","(","yQ",",","yS",")",",","ZERO_VALUE_NODES",")",";","yF","=","0.45","*","(","yF","/","(","yF","+","0.09",")",")",";","Hs","=","yD","*","(","yG","+","(","yF","*","yE","*","sin","(","yI",")","*","tan","(","yJ",")",")",")",";","}","}","else","Hs","=","yD",";","Hs","=","max","(","Hs",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_MINNAERT",declarations:[{type:"node_in",name:"Ht",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Hu",
qualifier:["vec2"],is_optional:false},{type:"node_in",name:"Hv",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Hw",qualifier:["float"],is_optional:false},{type:"node_in",name:"Hx",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"Hy",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Hy","=","ZERO_VALUE_NODES",";","if","(","Hu",".","r","!=","ZERO_VALUE_NODES",")","{","yD","=","(","UNITY_VALUE_NODES","-","Hw",")","*","dot","(","Hv",",","Ht",")","+",
"Hw",";","yJ","=","max","(","dot","(","Hv",",","yo",")",",","ZERO_VALUE_NODES",")",";","if","(","Hx","[","0","]","<=","UNITY_VALUE_NODES",")","Hy","=","yD","*","pow","(","max","(","yJ","*","yD",",","0.1",")",",","Hx","[","0","]","-","UNITY_VALUE_NODES",")",";","else","Hy","=","yD","*","pow","(","1.0001","-","yJ",",","Hx","[","0","]","-","UNITY_VALUE_NODES",")",";","Hy","=","max","(","Hy",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"DIFFUSE_TOON",declarations:[{type:"node_in",name:"Hz",
qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HA",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"HB",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HC",qualifier:["float"],is_optional:false},{type:"node_in",name:"HD",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"HE",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["HE","=","ZERO_VALUE_NODES",";","if","(","HA",".","r","!=","ZERO_VALUE_NODES",")","{","yJ","=","(","UNITY_VALUE_NODES",
"-","HC",")","*","dot","(","HB",",","Hz",")","+","HC",";","yJ","=","acos","(","yJ",")",";","if","(","yJ","<","HD","[","0","]",")","HE","=","UNITY_VALUE_NODES",";","else","if","(","yJ",">","(","HD","[","0","]","+","HD","[","1","]",")","||","HD","[","1","]","==","ZERO_VALUE_NODES",")","HE","=","ZERO_VALUE_NODES",";","else","HE","=","UNITY_VALUE_NODES","-","(","(","yJ","-","HD","[","0","]",")","/","HD","[","1","]",")",";","HE","=","max","(","HE",",","ZERO_VALUE_NODES",")",";","}"]}]},{type:"node",name:"SPECULAR_PHONG",
declarations:[{type:"node_in",name:"HF",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HG",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"HH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HI",qualifier:["float"],is_optional:false},{type:"node_in",name:"HJ",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"HK",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["HK","=","ZERO_VALUE_NODES",";","if","(","HG",".","g","==","UNITY_VALUE_NODES",
")","{","yS","=","normalize","(","HF","+","yo",")",";","HK","=","(","UNITY_VALUE_NODES","-","HI",")","*","max","(","dot","(","HH",",","yS",")",",","ZERO_VALUE_NODES",")","+","HI",";","HK","=","pow","(","HK",",","HJ","[","0","]",")",";","}"]}]},{type:"node",name:"SPECULAR_WARDISO",declarations:[{type:"node_in",name:"HL",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HM",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"HN",qualifier:["vec3"],is_optional:false},{type:"node_in",
name:"HO",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"HP",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["HP","=","ZERO_VALUE_NODES",";","if","(","HM",".","g","==","UNITY_VALUE_NODES",")","{","yS","=","normalize","(","HL","+","yo",")",";","yJ","=","max","(","dot","(","HN",",","yS",")",",","0.001",")",";"]},{type:"textline",tokens:["yD","=","max","(","dot","(","HN",",","yo",")",",","0.01",")",";","yI","=","max","(","dot","(","HN",",","HL",")",",","0.01",
")",";","yJ","=","tan","(","acos","(","yJ",")",")",";","yE","=","max","(","HO","[","0","]",",","0.001",")",";","HP","=","yI","*","(","UNITY_VALUE_NODES","/","(","4.0","*","M_PI","*","yE","*","yE",")",")","*","(","exp","(","-","(","yJ","*","yJ",")","/","(","yE","*","yE",")",")","/","(","sqrt","(","yD","*","yI",")",")",")",";","}"]}]},{type:"node",name:"SPECULAR_TOON",declarations:[{type:"node_in",name:"HQ",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HR",qualifier:["vec2"],is_optional:false},
{type:"node_in",name:"HS",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HT",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"HU",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["HU","=","ZERO_VALUE_NODES",";","if","(","HR",".","g","==","UNITY_VALUE_NODES",")","{","yS","=","normalize","(","HQ","+","yo",")",";","yI","=","acos","(","dot","(","yS",",","HS",")",")",";","if","(","yI","<","HT","[","0","]",")","HU","=","UNITY_VALUE_NODES",";","else",
"if","(","yI",">=","HT","[","0","]","+","HT","[","1","]","||","HT","[","1","]","==","ZERO_VALUE_NODES",")","HU","=","ZERO_VALUE_NODES",";","else","HU","=","UNITY_VALUE_NODES","-","(","yI","-","HT","[","0","]",")","/","HT","[","1","]",";","}"]}]},{type:"node",name:"SPECULAR_BLINN",declarations:[{type:"node_in",name:"HV",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"HW",qualifier:["vec2"],is_optional:false},{type:"node_in",name:"HX",qualifier:["vec3"],is_optional:false},{type:"node_in",
name:"HY",qualifier:["float"],is_optional:false},{type:"node_in",name:"HZ",qualifier:["vec2"],is_optional:false},{type:"node_out",name:"H_",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["H_","=","ZERO_VALUE_NODES",";","if","(","HW",".","g","==","UNITY_VALUE_NODES",")","{","if","(","HZ","[","0","]","<","UNITY_VALUE_NODES","||","HZ","[","1","]","==","ZERO_VALUE_NODES",")","H_","=","ZERO_VALUE_NODES",";","else","{","if","(","HZ","[","1","]","<","100.0",")","HZ","[","1",
"]","=","sqrt","(","UNITY_VALUE_NODES","/","HZ","[","1","]",")",";","else","HZ","[","1","]","=","10.0","/","HZ","[","1","]",";","yS","=","normalize","(","yo","+","HV",")",";","yI","=","(","UNITY_VALUE_NODES","-","HY",")","*","max","(","dot","(","HX",",","yS",")",",","ZERO_VALUE_NODES",")","+","HY",";","if","(","yI","<","ZERO_VALUE_NODES",")","H_","=","ZERO_VALUE_NODES",";","else","{","yD","=","max","(","dot","(","HX",",","yo",")",",","0.01",")",";","yE","=","dot","(","HX",",","HV",")",";","if","(",
"yE","<=","0.01",")","H_","=","ZERO_VALUE_NODES",";","else","{","yJ","=","max","(","dot","(","yo",",","yS",")",",","0.01",")",";","yF","=","UNITY_VALUE_NODES",";","yD","=","(","2.0","*","yI","*","yD",")","/","yJ",";","yE","=","(","2.0","*","yI","*","yE",")","/","yJ",";","yE","=","min","(","min","(","yF",",","yD",")",",","yE",")",";","yD","=","sqrt","(","pow","(","HZ","[","0","]",",","2.0",")","+","pow","(","yJ",",","2.0",")","-","UNITY_VALUE_NODES",")",";","yJ","=","pow","(","yD","-","yJ",",","2.0",
")","/","pow","(","yD","+","yJ",",","2.0",")","*","(","UNITY_VALUE_NODES","+","pow","(","yJ","*","(","yD","+","yJ",")","-","UNITY_VALUE_NODES",",","2.0",")","/","pow","(","yJ","*","(","yD","-","yJ",")","+","UNITY_VALUE_NODES",",","2.0",")",")",";","yI","=","acos","(","yI",")",";","H_","=","max","(","yJ","*","yE","*","exp","(","-","pow","(","yI",",","2.0",")","/","(","2.0","*","pow","(","HZ","[","1","]",",","2.0",")",")",")",",","ZERO_VALUE_NODES",")",";","}","}","}","}"]}]},{type:"node",name:"LIGHTING_APPLY",
declarations:[{type:"node_in",name:"Ia",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"Ib",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ic",qualifier:["float"],is_optional:false},{type:"node_in",name:"Id",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ie",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"If",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ig",qualifier:["vec4"],is_optional:false},{type:"node_in",name:"Ih",qualifier:["vec3"],
is_optional:false},{type:"node_in",name:"Ii",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ij",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Ik",qualifier:["float"],is_optional:false},{type:"node_out",name:"Il",qualifier:["vec4"],is_optional:false},{type:"node_out",name:"Im",qualifier:["vec3"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_NODE_B4W_TRANSLUCENCY"],statements:[{type:"textline",tokens:["if","(","dot","(","Ie",
",","If",")","*","dot","(","yo",",","If",")","<","ZERO_VALUE_NODES",")","{","yI","=","Ig",".","x",";","yE","=","Ig",".","y",";","yJ","=","Ig",".","z",";","yD","=","Ig",".","w",";"]},{type:"textline",tokens:["yF","=","clamp","(","abs","(","dot","(","Ie",",","If",")",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yG","=","clamp","(","dot","(","yo",",","-","Ie",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yE","=","pow","(","yG",",","yE",")",";"]},{type:"textline",tokens:["Il",
"=","Ia","+","Ik","*","vec4","(","Ij","*","yF","*","pow","(","Ih",",","vec3","(","yI",")",")",",","UNITY_VALUE_NODES",")",";"]},{type:"textline",tokens:["Il","+=","yJ","*","mix","(","vec4","(","Ih",",","UNITY_VALUE_NODES",")",",","vec4","(","UNITY_VALUE_NODES",")",",","yD",")","*","Ik","*","vec4","(","Ij","*","yF","*","vec3","(","yE",")",",","UNITY_VALUE_NODES",")",";","Im","=","Ib",";","}","else","{"]},{type:"textline",tokens:["Im","=","Ib","+","Ij","*","Ii","*","Id",";","Il","=","Ia","+","vec4",
"(","Ij","*","Ih","*","Ic",",","Id",")",";","}"]}]},{type:"node_else",statements:[{type:"textline",tokens:["Im","=","Ib","+","Ij","*","Ii","*","Id",";","Il","=","Ia","+","vec4","(","Ij","*","Ih","*","Ic",",","Id",")",";"]}]}]}]},{type:"node",name:"RGB",declarations:[{type:"node_out",name:"In",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["In","=","u_node_rgbs","[","RGB_IND","]",";"]}]},{type:"node",name:"RGBTOBW",declarations:[{type:"node_in",name:"Io",qualifier:["vec3"],
is_optional:false},{type:"node_out",name:"Ip",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Ip","=","dot","(","Io",",","vec3","(","0.35",",","0.45",",","0.2",")",")",";"]}]},{type:"node",name:"SEPRGB",declarations:[{type:"node_in",name:"Iq",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ir",qualifier:["float"],is_optional:true},{type:"node_out",name:"Is",qualifier:["float"],is_optional:true},{type:"node_out",name:"It",qualifier:["float"],is_optional:true}],
statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Ir"],statements:[{type:"textline",tokens:["Ir","=","Iq",".","r",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Is"],statements:[{type:"textline",tokens:["Is","=","Iq",".","g",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_It"],statements:[{type:"textline",tokens:["It","=","Iq",".","b",";"]}]}]}]},{type:"node",name:"SEPHSV",declarations:[{type:"node_in",name:"Iu",
qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Iv",qualifier:["float"],is_optional:true},{type:"node_out",name:"Iw",qualifier:["float"],is_optional:true},{type:"node_out",name:"Ix",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["yS","=","xX","(","Iu",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Iv"],statements:[{type:"textline",tokens:["Iv","=","yS",".","r",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Iw"],
statements:[{type:"textline",tokens:["Iw","=","yS",".","g",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Ix"],statements:[{type:"textline",tokens:["Ix","=","yS",".","b",";"]}]}]}]},{type:"node",name:"SQUEEZE",declarations:[{type:"node_in",name:"Iy",qualifier:["float"],is_optional:false},{type:"node_in",name:"Iz",qualifier:["float"],is_optional:false},{type:"node_in",name:"IA",qualifier:["float"],is_optional:false},{type:"node_out",name:"IB",qualifier:["float"],is_optional:false}],
statements:[{type:"textline",tokens:["IB","=","UNITY_VALUE_NODES","/","(","UNITY_VALUE_NODES","+","pow","(","2.71828183",",","-","(","Iy","-","IA",")","*","Iz",")",")",";"]}]},{type:"node",name:"GAMMA",declarations:[{type:"node_in",name:"IC",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"ID",qualifier:["float"],is_optional:false},{type:"node_out",name:"IE",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["IE","=","IC",";","if","(","IE",".","x",">","ZERO_VALUE_NODES",
")","IE",".","x","=","pow","(","IC",".","x",",","ID",")",";","if","(","IE",".","y",">","ZERO_VALUE_NODES",")","IE",".","y","=","pow","(","IC",".","y",",","ID",")",";","if","(","IE",".","z",">","ZERO_VALUE_NODES",")","IE",".","z","=","pow","(","IC",".","z",",","ID",")",";"]}]},{type:"node",name:"B4W_SRGB_TO_LINEAR",declarations:[{type:"node_in",name:"IF",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"IG",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["IG",
"=","max","(","vec3","(","ZERO_VALUE_NODES",")",",","IF",")",";","IG","=","pow","(","IG",",","vec3","(","2.2",")",")",";"]}]},{type:"node",name:"B4W_LINEAR_TO_SRGB",declarations:[{type:"node_in",name:"IH",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"II",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["II","=","max","(","vec3","(","ZERO_VALUE_NODES",")",",","IH",")",";","II","=","pow","(","II",",","vec3","(","UNITY_VALUE_NODES","/","2.2",")",")",";"]}]},
{type:"node",name:"TEXTURE_EMPTY",declarations:[{type:"node_out",name:"IJ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"IK",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"IL",qualifier:["float"],is_optional:false}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IL"],statements:[{type:"textline",tokens:["IJ","[","2","]","=","IJ","[","1","]","=","IJ","[","0","]","=","ZERO_VALUE_NODES",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_OUT_IL"],statements:[{type:"textline",tokens:["IK","[","2","]","=","IK","[","1","]","=","IK","[","0","]","=","ZERO_VALUE_NODES",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IL"],statements:[{type:"textline",tokens:["IL","=","ZERO_VALUE_NODES",";"]}]}]}]},{type:"node",name:"TEXTURE_ENVIRONMENT",declarations:[{type:"node_in",name:"IM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"IN",qualifier:["vec3"],is_optional:true},{type:"node_out",
name:"IO",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_ENVIRONMENT_var_texture",qualifier:["uniform","samplerCube"],is_optional:false}],statements:[{type:"textline",tokens:["yL","=","textureCube","(","node_TEXTURE_ENVIRONMENT_var_texture",",","IM",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IN"],statements:[{type:"textline",tokens:["IN","=","yL",".","xyz",";","br","(","IN",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IO"],
statements:[{type:"textline",tokens:["IO","=","yL",".","w",";"]}]}]}]},{type:"node",name:"TEXTURE_COLOR",declarations:[{type:"node_in",name:"IP",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"IQ",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"IR",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"IS",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"IT",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"IU",qualifier:["float"],is_optional:true},{type:"node_out",
name:"IV",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"IW",qualifier:["float"],is_optional:true},{type:"node_out",name:"IX",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"IY",qualifier:["float"],is_optional:true},{type:"node_out",name:"IZ",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"I_",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_COLOR_var_texture",qualifier:["uniform","sampler2D"],is_optional:false}],statements:[{type:"textline",
tokens:["yL","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ye","(","IP",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IT"],statements:[{type:"textline",tokens:["IT","=","yL",".","xyz",";","br","(","IT",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IU"],statements:[{type:"textline",tokens:["IU","=","yL",".","w",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv2"],statements:[{type:"textline",
tokens:["yL","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ye","(","IQ",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IV"],statements:[{type:"textline",tokens:["IV","=","yL",".","xyz",";","br","(","IV",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IW"],statements:[{type:"textline",tokens:["IW","=","yL",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv3"],statements:[{type:"textline",
tokens:["yL","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ye","(","IR",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IX"],statements:[{type:"textline",tokens:["IX","=","yL",".","xyz",";","br","(","IX",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IY"],statements:[{type:"textline",tokens:["IY","=","yL",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv4"],statements:[{type:"textline",
tokens:["yL","=","texture2D","(","node_TEXTURE_COLOR_var_texture",",","ye","(","IS",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_IZ"],statements:[{type:"textline",tokens:["IZ","=","yL",".","xyz",";","br","(","IZ",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_I_"],statements:[{type:"textline",tokens:["I_","=","yL",".","w",";"]}]}]}]}]}]},{type:"node",name:"TEXTURE_NORMAL",declarations:[{type:"node_in",name:"Ja",qualifier:["vec3"],
is_optional:true},{type:"node_in",name:"Jb",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"Jc",qualifier:["vec3"],is_optional:true},{type:"node_in",name:"Jd",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"Je",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"Jf",qualifier:["float"],is_optional:true},{type:"node_out",name:"Jg",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"Jh",qualifier:["float"],is_optional:true},{type:"node_out",name:"Ji",qualifier:["vec3"],
is_optional:true},{type:"node_out",name:"Jj",qualifier:["float"],is_optional:true},{type:"node_out",name:"Jk",qualifier:["vec3"],is_optional:true},{type:"node_out",name:"Jl",qualifier:["float"],is_optional:true},{type:"node_param",name:"node_TEXTURE_NORMAL_var_texture",qualifier:["uniform","sampler2D"],is_optional:false}],statements:[{type:"textline",tokens:["yL","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ye","(","Ja",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Je"],
statements:[{type:"textline",tokens:["Je","=","normalize","(","yM","*","(","yL",".","xyz","-","xS",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jf"],statements:[{type:"textline",tokens:["Jf","=","yL",".","w",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv2"],statements:[{type:"textline",tokens:["yL","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ye","(","Jb",")",")",";"]},{type:"node_condition",parts:[{type:"node_if",
expression:["USE_OUT_Jg"],statements:[{type:"textline",tokens:["Jg","=","normalize","(","yM","*","(","yL",".","xyz","-","xS",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jh"],statements:[{type:"textline",tokens:["Jh","=","yL",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv3"],statements:[{type:"textline",tokens:["yL","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ye","(","Jc",")",")",";"]},{type:"node_condition",
parts:[{type:"node_if",expression:["USE_OUT_Ji"],statements:[{type:"textline",tokens:["Ji","=","normalize","(","yM","*","(","yL",".","xyz","-","xS",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jj"],statements:[{type:"textline",tokens:["Jj","=","yL",".","w",";"]}]}]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_uv4"],statements:[{type:"textline",tokens:["yL","=","texture2D","(","node_TEXTURE_NORMAL_var_texture",",","ye","(","Jd",")",")",
";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jk"],statements:[{type:"textline",tokens:["Jk","=","normalize","(","yM","*","(","yL",".","xyz","-","xS",")",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jl"],statements:[{type:"textline",tokens:["Jl","=","yL",".","w",";"]}]}]}]}]}]},{type:"node",name:"VALUE",declarations:[{type:"node_out",name:"Jm",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Jm","=","u_node_values",
"[","VALUE_IND","]",";"]}]},{type:"node",name:"VECT_MATH_ADD",declarations:[{type:"node_in",name:"Jn",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Jo",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Jp",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Jq",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["Jp","=","Jn","+","Jo",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jq"],statements:[{type:"textline",
tokens:["Jq","=","(","abs","(","Jp","[","0","]",")","+","abs","(","Jp","[","1","]",")","+","abs","(","Jp","[","2","]",")",")","/","3.0",";"]}]}]}]},{type:"node",name:"VECT_MATH_SUBTRACT",declarations:[{type:"node_in",name:"Jr",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Js",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Jt",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Ju",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["Jt",
"=","Jr","-","Js",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Ju"],statements:[{type:"textline",tokens:["Ju","=","(","abs","(","Jt","[","0","]",")","+","abs","(","Jt","[","1","]",")","+","abs","(","Jt","[","2","]",")",")","/","3.0",";"]}]}]}]},{type:"node",name:"VECT_MATH_AVERAGE",declarations:[{type:"node_in",name:"Jv",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Jw",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"Jx",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"Jy",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["Jx","=","Jv","+","Jw",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jy"],statements:[{type:"textline",tokens:["Jy","=","length","(","Jx",")",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Jx"],statements:[{type:"textline",tokens:["Jx","=","normalize","(","Jx",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_DOT_PRODUCT",declarations:[{type:"node_in",
name:"Jz",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"JA",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JB",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JC",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["JB","=","vec3","(","ZERO_VALUE_NODES",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_JC"],statements:[{type:"textline",tokens:["JC","=","dot","(","Jz",",","JA",")",";"]}]}]}]},{type:"node",name:"VECT_MATH_CROSS_PRODUCT",
declarations:[{type:"node_in",name:"JD",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"JE",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JF",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JG",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["JF","=","cross","(","JD",",","JE",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_JG"],statements:[{type:"textline",tokens:["JG","=","length","(","JF",")",";"]}]}]}]},
{type:"node",name:"VECT_MATH_NORMALIZE",declarations:[{type:"node_in",name:"JH",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"JI",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JJ",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JK",qualifier:["float"],is_optional:true}],statements:[{type:"textline",tokens:["JJ","=","normalize","(","JH",")",";"]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_JK"],statements:[{type:"textline",tokens:["JK",
"=","length","(","JH",")",";"]}]}]},{type:"textline",tokens:["JI",";"]}]},{type:"node",name:"B4W_REFLECT",declarations:[{type:"node_in",name:"JL",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"JM",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JN",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["JN","=","reflect","(","-","JL",",","JM",")",";"]}]},{type:"node",name:"B4W_PARALLAX",declarations:[{type:"node_in",name:"JO",qualifier:["vec3"],is_optional:false},
{type:"node_in",name:"JP",qualifier:["float"],is_optional:false},{type:"node_in",name:"JQ",qualifier:["const","float"],is_optional:false},{type:"node_in",name:"JR",qualifier:["const","float"],is_optional:false},{type:"node_out",name:"JS",qualifier:["vec3"],is_optional:false},{type:"node_param",name:"node_B4W_PARALLAX_var_texture",qualifier:["uniform","sampler2D"],is_optional:false}],statements:[{type:"textline",tokens:["yE","=","length","(","yK",")",";","if","(","yE","<","JR",")","{","yz","=","ye",
"(","JO",")",";","yE","=","clamp","(","xS","*","(","JR","-","yE",")",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";","yE","=","JP","*","yE",";"]},{type:"textline",tokens:["yS","=","normalize","(","yo","*","yM",")",";"]},{type:"textline",tokens:["yF","=","UNITY_VALUE_NODES","/","JQ",";"]},{type:"textline",tokens:["yA","=","yS",".","xy","*","yE","/","(","JQ","*","yS",".","z",")",";","yE","=","UNITY_VALUE_NODES",";","yD","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","yz",")",".","a",
";"]},{type:"textline",tokens:["for","(","float","JT","=","1.0",";","JT","<=","JQ",";","JT","++",")","{","if","(","yD","<","yE",")","{","yE","-=","yF",";","yz","-=","yA",";","yD","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","yz",")",".","a",";","}","}"]},{type:"textline",tokens:["yA","=","yz","+","yA",";","yF","=","texture2D","(","node_B4W_PARALLAX_var_texture",",","yA",")",".","a","-","(","yE","+","yF",")",";","yE","=","yD","-","yE",";","yF","=","yE","/","(","yE","-","yF",")",";"]},{type:"textline",
tokens:["yz","=","yF","*","yA","+","(","UNITY_VALUE_NODES","-","yF",")","*","yz",";","JS","=","yc","(","yz",")",";","}","else","JS","=","JO",";"]}]},{type:"node",name:"B4W_CLAMP",declarations:[{type:"node_in",name:"JU",qualifier:["vec3"],is_optional:false},{type:"node_out",name:"JV",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["JV","=","clamp","(","JU",",","ZERO_VALUE_NODES",",","UNITY_VALUE_NODES",")",";"]}]},{type:"node",name:"B4W_REFRACTION",declarations:[{type:"node_in",
name:"JW",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"JX",qualifier:["float"],is_optional:false},{type:"node_out",name:"JY",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["JY","=","JW",";","JX",";"]}]},{type:"node",name:"B4W_TRANSLUCENCY",declarations:[{type:"node_in",name:"JZ",qualifier:["float"],is_optional:false},{type:"node_in",name:"J_",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ka",qualifier:["float"],is_optional:false},{type:"node_in",
name:"Kb",qualifier:["float"],is_optional:false},{type:"node_in",name:"Kc",qualifier:["float"],is_optional:false},{type:"node_out",name:"Kd",qualifier:["float"],is_optional:true},{type:"node_out",name:"Ke",qualifier:["vec4"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Kd"],statements:[{type:"textline",tokens:["Kd","=","JZ",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["USE_OUT_Ke"],statements:[{type:"textline",tokens:["Ke",
"=","vec4","(","J_",",","Ka",",","Kb",",","Kc",")",";"]}]}]}]},{type:"node",name:"B4W_TIME",declarations:[{type:"node_out",name:"Kf",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Kf","=","u_time",";"]}]},{type:"node",name:"B4W_SMOOTHSTEP",declarations:[{type:"node_in",name:"Kg",qualifier:["float"],is_optional:false},{type:"node_in",name:"Kh",qualifier:["float"],is_optional:false},{type:"node_in",name:"Ki",qualifier:["float"],is_optional:false},{type:"node_out",name:"Kj",
qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Kj","=","smoothstep","(","Kh",",","Ki",",","Kg",")",";"]}]},{type:"node",name:"B4W_GLOW_OUTPUT",declarations:[{type:"node_in",name:"Kk",qualifier:["vec3"],is_optional:false},{type:"node_in",name:"Kl",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["yu","=","Kk",";","yy","=","Kl",";"]}]},{type:"node",name:"B4W_VECTOSCAL",declarations:[{type:"node_in",name:"Km",qualifier:["vec3"],is_optional:false},
{type:"node_out",name:"Kn",qualifier:["float"],is_optional:false}],statements:[{type:"textline",tokens:["Kn","=","(","Km",".","r","+","Km",".","g","+","Km",".","b",")","/","3.0",";"]}]},{type:"node",name:"B4W_SCALTOVEC",declarations:[{type:"node_in",name:"Ko",qualifier:["float"],is_optional:false},{type:"node_out",name:"Kp",qualifier:["vec3"],is_optional:false}],statements:[{type:"textline",tokens:["Kp","[","0","]","=","Ko",";","Kp","[","1","]","=","Ko",";","Kp","[","2","]","=","Ko",";"]}]},{type:"nodes_global"},
{type:"textline",tokens:["void","Kq","(","in","vec3","yo",",","in","mat4","yp",",","in","mat4","yq",",","in","mat4","yr",",","in","mat4","ys",",","in","mat4","yt",",","out","vec3","yu",",","out","vec3","yv",",","out","vec3","yw",",","out","vec4","yx",",","out","float","yy",")","{","vec2","yz",",","yA",";","float","yB",",","yC",",","yD",",","yE",",","yF",",","yG",",","yH",",","yI",",","yJ",";","vec4","yK",",","yL",";","mat3","yM",";","vec3","yN",",","yO",",","yP",",","yQ",",","yR",",","yS",";","yu",
"=","vec3","(","ZERO_VALUE_NODES",")",";","yv","=","vec3","(","ZERO_VALUE_NODES",")",";","yw","=","vec3","(","ZERO_VALUE_NODES",")",";","yx","=","vec4","(","ZERO_VALUE_NODES",")",";","yy","=","ZERO_VALUE_NODES",";"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_MATERIAL_BEGIN","USE_NODE_GEOMETRY_NO","CAUSTICS","CALC_TBN_SPACE","USE_NODE_TEX_COORD_NO",{type:"logical_or_expr",places:5}],group:{type:"group",parts:[{type:"textline",tokens:["yN","=","normalize","(","bE",")",";","yO","=","yN",
";"]},{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING","USE_NODE_GEOMETRY_NO",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["INVERT_FRONTFACING"],group:{type:"group",parts:[{type:"textline",tokens:["if","(","!","gl_FrontFacing",")"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["if","(","gl_FrontFacing",")"]}]}}]},{type:"textline",tokens:["yO","=","yO",";","else","yO","=","-","yO",";"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["DOUBLE_SIDED_LIGHTING"],group:{type:"group",parts:[{type:"textline",tokens:["yP","=","yO",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["yP","=","yN",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_NO"],group:{type:"group",parts:[{type:"textline",tokens:["yN","=","yO",";"]}]}}]}]}}]},{type:"condition",parts:[{type:"if",expression:["CALC_TBN_SPACE"],group:{type:"group",parts:[{type:"textline",
tokens:["yQ","=","cross","(","yO",",","bF",".","xyz",")","*","bF",".","w",";","yM","=","mat3","(","bF",".","xyz",",","yQ",",","yO",")",";","yM","=","yM",";"]}]}}]},{type:"textline",tokens:["yO","=","bC",";","yK","=","bD",";","yB","=","u_emit",";","yC","=","u_ambient",";"]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},exports["include/particles.glslv"]={type:"group",parts:[{type:"var",name:"EPSILON",tokens:["0.0001"]},{type:"textline",tokens:["struct","Ks","{","float","a",";","vec3","b",";",
"float","c",";","vec3","d",";","float","e",";","vec3","f",";","vec3","g",";","float","h",";","}",";"]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["void","Ky","(","inout","vec3","Kt",",","float","Ku",",","vec4","Kv",",","vec4","Kw",")","{","float","Kx",";","Kx","=","Kw",".","x","-","Kv",".","x",";","Kx","=","(","Ku","-","Kv",".","x",")","/","Kx",";","Kt","=","mix","(","Kt",",","Kw",".","yzw",",",
"clamp","(","Kx",",","0.0",",","1.0",")",")",";","}"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec3","KE","(","float","Kz",",","float","KA",",","vec4","KB","[","COLOR_RAMP_LENGTH","]",")","{","vec3","KC",";","float","KD",";","KD","=","Kz","/","KA",";","KC","=","KB","[","0","]",".","yzw",";"]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",1,{type:"g_expr",places:2}],
group:{type:"group",parts:[{type:"textline",tokens:["Ky","(","KC",",","KD",",","KB","[","0","]",",","KB","[","1","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",2,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ky","(","KC",",","KD",",","KB","[","1","]",",","KB","[","2","]",")",";"]}]}}]},{type:"condition",parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["Ky",
"(","KC",",","KD",",","KB","[","2","]",",","KB","[","3","]",")",";"]}]}}]},{type:"textline",tokens:["return","KC",";","}"]}]}}]},{type:"textline",tokens:["float","KM","(","float","KF",",","float","KG",",","float","KH",",","float","KI",")","{","float","KJ",",","KK",",","KL",";","KJ","=","max","(","0.01",",","min","(","KG",",","KH",")",")",";","KK","=","max","(","0.01",",","min","(","KG",",","KI",")",")",";","KL","=","KG","-","KK",";","KK","=","clamp","(","KF","/","KJ",",","0.0",",","1.0",")","-","step",
"(","KL",",","KF",")","*","(","KF","-","KL",")","/","KK",";","return","KK",";","}","Ks","KU","(",")","{","mat4","KN",";","vec3","KO",",","KP",";","float","KQ",",","KR",",","KS",";","Ks","KT",";","KR","=","a_p_data","[","0","]",";","KS","=","a_p_data","[","1","]",";","if","(","u_p_cyclic","==","1",")","{","KQ","=","mod","(","u_p_time",",","u_p_length",")","-","KS",";","if","(","KQ","<","0.0",")","KQ","+=","u_p_length",";","}","if","(","u_p_cyclic","!=","1",")","{","KQ","=","u_p_time","-","KS",";",
"}","if","(","KQ","<","0.0","||","KQ",">=","KR",")","{","KT",".","a","=","0.0001",";","KT",".","b","=","vec3","(","99999.0",",","0.0",",","0.0",")",";","}","if","(","!","(","KQ","<","0.0","||","KQ",">=","KR",")",")","{"]},{type:"condition",parts:[{type:"if",expression:["WORLD_SPACE"],group:{type:"group",parts:[{type:"textline",tokens:["KO","=","a_position",";","KP","=","a_normal",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["KN","=","O","(","u_model_tsr",")",";","KO",
"=","(","KN","*","vec4","(","a_position",",","1.0",")",")",".","xyz",";","KP","=","(","KN","*","vec4","(","a_normal",",","0.0",")",")",".","xyz",";"]}]}}]},{type:"textline",tokens:["KP","=","u_p_nfactor","*","KP",";","KP","+=","a_p_vels",".","xyz",";","KP",".","y","-=","u_p_gravity","*","KQ","/","2.0",";","KR","=","max","(","u_p_mass",",","EPSILON",")",";","KP","+=","(","u_p_wind_fac","*","u_wind","/","KR",")","*","KQ","/","2.0",";","KT",".","h","=","KQ",";","KT",".","f","=","KP",";","KT",".","g",
"=","a_normal","*","a_p_vels",".","w",";","KT",".","b","=","KO","+","KP","*","KQ",";","KT",".","e","=","a_p_vels",".","w","*","KQ",";"]},{type:"condition",parts:[{type:"if",expression:["USE_COLOR_RAMP"],group:{type:"group",parts:[{type:"textline",tokens:["KT",".","a","=","texture2D","(","u_color_ramp_tex",",","vec2","(","KQ","/","u_p_max_lifetime",",","0.5",")",")",".","g",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["KT",".","a","=","1.0",";"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["COLOR_RAMP_LENGTH",0,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["KT",".","d","=","KE","(","KQ",",","u_p_max_lifetime",",","u_p_color_ramp",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["KT",".","d","=","vec3","(","1.0",")",";"]}]}}]},{type:"textline",tokens:["KT",".","c","=","KM","(","KQ",",","a_p_data","[","0","]",",","u_p_fade_in",",","u_p_fade_out",")",";","}","return","KT",";","}"]}]},exports["include/particles_nodes.glslv"]=
{type:"group",parts:[{type:"node",name:"TEX_COORD_UV",declarations:[],statements:[{type:"textline",tokens:["bM","=","K_","+","0.5",";"]}]},{type:"node",name:"UV_MERGED",declarations:[],statements:[{type:"textline",tokens:["bM","=","K_","+","0.5",";"]}]},{type:"node",name:"UVMAP",declarations:[],statements:[{type:"textline",tokens:["bM","=","K_","+","0.5",";"]}]},{type:"node",name:"GEOMETRY_UV",declarations:[],statements:[{type:"textline",tokens:["bM","=","K_","+","0.5",";"]}]},{type:"node",name:"PARTICLE_INFO",
declarations:[{type:"node_param",name:"yg",qualifier:["varying","vec4"],is_optional:true},{type:"node_param",name:"yh",qualifier:["varying","vec3"],is_optional:true},{type:"node_param",name:"yi",qualifier:["varying","vec3"],is_optional:true},{type:"node_param",name:"yj",qualifier:["varying","vec3"],is_optional:true},{type:"node_param",name:"node_PARTICLE_INFO_var_a_p_indices",qualifier:["attribute","float"],is_optional:true}],statements:[{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_SIZE"],
statements:[{type:"textline",tokens:["yg","[","3","]","=","KZ",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_AGE"],statements:[{type:"textline",tokens:["yg","[","1","]","=","KY",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_LT"],statements:[{type:"textline",tokens:["yg","[","2","]","=","La",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_LOC"],statements:[{type:"textline",tokens:["yh","=","KV",";"]}]}]},
{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_IND"],statements:[{type:"textline",tokens:["yg","[","0","]","=","node_PARTICLE_INFO_var_a_p_indices",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_VEL"],statements:[{type:"textline",tokens:["yi","=","KW",";"]}]}]},{type:"node_condition",parts:[{type:"node_if",expression:["PART_INFO_A_VEL"],statements:[{type:"textline",tokens:["yj","=","KX",";"]}]}]}]},{type:"nodes_global"},{type:"textline",tokens:["void",
"Lb","(","in","vec3","KV",",","in","vec3","KW",",","in","vec3","KX",",","in","float","KY",",","in","float","KZ",",","in","vec2","K_",",","in","float","La",")","{"]},{type:"condition",parts:[{type:"if",expression:["USE_NODE_GEOMETRY_OR","USE_NODE_TEX_COORD_GE",{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["bM","=","K_","+","0.5",";"]}]}}]},{type:"nodes_main"},{type:"textline",tokens:["}"]}]},exports["include/blending.glslf"]={type:"group",parts:[{type:"textline",
tokens:["float","Ld","=","0.0",";","float","Le","=","1.0",";","vec3","Lj","(","vec3","Lf",")","{","float","Lg",",","Lh",";","vec4","Li",";","Li","=","vec4","(","Ld",",","-","Le","/","3.0",",","2.0","/","3.0",",","-","Le",")",";","Li","=","mix","(","vec4","(","Lf",".","bg",",","Li",".","wz",")",",","vec4","(","Lf",".","gb",",","Li",".","xy",")",",","step","(","Lf",".","b",",","Lf",".","g",")",")",";","Li","=","mix","(","vec4","(","Li",".","xyw",",","Lf",".","r",")",",","vec4","(","Lf",".","r",",",
"Li",".","yzx",")",",","step","(","Li",".","x",",","Lf",".","r",")",")",";","Lg","=","Li",".","x","-","min","(","Li",".","w",",","Li",".","y",")",";","Lh","=","1.0e-10",";","return","vec3","(","abs","(","Li",".","z","+","(","Li",".","w","-","Li",".","y",")","/","(","6.0","*","Lg","+","Lh",")",")",",","Lg","/","(","Li",".","x","+","Lh",")",",","Li",".","x",")",";","}","vec3","Ln","(","vec3","Lk",")","{","vec3","Ll",";","vec4","Lm",";","Lm","=","vec4","(","Le",",","2.0","/","3.0",",","Le","/","3.0",
",","3.0",")",";","Ll","=","abs","(","fract","(","vec3","(","Lk",".","r",",","Lk",".","r",",","Lk",".","r",")","+","Lm",".","xyz",")","*","6.0","-","Lm",".","www",")",";","return","Lk",".","b","*","mix","(","Lm",".","xxx",",","clamp","(","Ll","-","Lm",".","xxx",",","Ld",",","Le",")",",","Lk",".","g",")",";","}","vec3","Lr","(","vec3","Lo",",","vec3","Lp",",","float","Lq",")","{","return","mix","(","Lo",",","Lp",",","Lq",")",";","}","vec3","Lv","(","vec3","Ls",",","vec3","Lt",",","float","Lu",")",
"{","return","Lu","*","Ls","+","Lt",";","}","vec3","Lz","(","vec3","Lw",",","vec3","Lx",",","float","Ly",")","{","return","Lx","-","Ly","*","Lw",";","}","vec3","LE","(","vec3","LA",",","vec3","LB",",","float","LC",")","{","float","LD",";","LD","=","Le","-","LC",";","return","(","vec3","(","LD",")","+","LC","*","LA",")","*","LB",";","}","vec3","LJ","(","vec3","LF",",","vec3","LG",",","float","LH",")","{","vec3","LI",";","LI","=","vec3","(","Le","-","LH",")",";","return","vec3","(","Le",")","-","(",
"LI","+","LH","*","(","vec3","(","Le",")","-","LF",")",")","*","(","vec3","(","Le",")","-","LG",")",";","}","vec3","LO","(","vec3","LK",",","vec3","LL",",","float","LM",")","{","vec3","LN",";","LN","=","vec3","(","Le","-","LM",")",";","return","mix","(","LL","*","(","LN","+","2.0","*","LM","*","LK",")",",","vec3","(","Le",")","-","(","LN","+","2.0","*","LM","*","(","vec3","(","Le",")","-","LK",")",")","*","(","vec3","(","Le",")","-","LL",")",",","step","(","0.5",",","LL",")",")",";","}","vec3","LS",
"(","vec3","LP",",","vec3","LQ",",","float","LR",")","{","return","mix","(","LQ",",","abs","(","LP","-","LQ",")",",","LR",")",";","}","vec3","LW","(","vec3","LT",",","vec3","LU",",","float","LV",")","{","return","mix","(","LU",",","LU","/","(","LT","+","step","(","LT",",","vec3","(","Ld",")",")",")",",","LV",")",";","}","vec3","L_","(","vec3","LX",",","vec3","LY",",","float","LZ",")","{","return","mix","(","LY",",","min","(","LX",",","LY",")",",","LZ",")",";","}","vec3","Md","(","vec3","Ma",",","vec3",
"Mb",",","float","Mc",")","{","return","max","(","Mc","*","Ma",",","Mb",")",";","}","vec3","Mj","(","vec3","Me",",","vec3","Mf",",","float","Mg",")","{","vec3","Mh",",","Mi",";","Mh","=","Lj","(","Mf",")",";","if","(","Mh",".","y","!=","Ld",")","{","Mi","=","Lj","(","Me",")",";","Mi","=","Ln","(","vec3","(","Mh",".","x",",","Mi",".","yz",")",")",";","return","mix","(","Me",",","Mi",",","Mg",")",";","}","return","Me",";","}","vec3","Mp","(","vec3","Mk",",","vec3","Ml",",","float","Mm",")","{","vec3",
"Mn",",","Mo",";","Mn","=","Lj","(","Mk",")",";","if","(","Mn",".","y","!=","Ld",")","{","Mo","=","Lj","(","Ml",")",";","return","Ln","(","vec3","(","Mn",".","x",",","mix","(","Mn",".","y",",","Mo",".","y",",","Mm",")",",","Mn",".","z",")",")",";","}","return","Mk",";","}","vec3","Mv","(","vec3","Mq",",","vec3","Mr",",","float","Ms",")","{","vec3","Mt",",","Mu",";","Mt","=","Lj","(","Mq",")",";","Mu","=","Lj","(","Mr",")",";","return","Ln","(","vec3","(","Mt",".","xy",",","mix","(","Mt",".","z",",",
"Mu",".","z",",","Ms",")",")",")",";","}","vec3","MB","(","vec3","Mw",",","vec3","Mx",",","float","My",")","{","vec3","Mz",",","MA",";","Mz","=","Lj","(","Mx",")",";","if","(","Mz",".","y","!=","Ld",")","{","MA","=","Lj","(","Mw",")",";","MA","=","Ln","(","vec3","(","Mz",".","xy",",","MA",".","z",")",")",";","return","mix","(","Mw",",","MA",",","My",")",";","}","return","Mw",";","}","vec3","MG","(","vec3","MC",",","vec3","MD",",","float","ME",")","{","vec3","MF",";","MF","=","vec3","(","Le",")","-",
"(","vec3","(","Le",")","-","MD",")","*","(","vec3","(","Le",")","-","MC",")",";","return","mix","(","MC",",","(","(","vec3","(","Le",")","-","MC",")","*","MD","*","MC",")","+","MC","*","MF",",","ME",")",";","}","vec3","MK","(","vec3","MH",",","vec3","MI",",","float","MJ",")","{","return","MH","+","MJ","*","(","2.0","*","MI","-","Le",")",";","}","float","MQ","(","float","ML",",","float","MM",",","float","MN",",","float","MO",")","{","float","MP",";","MP","=","Le","-","MO",";","return","(","MP","+",
"MN","*","ML",")","*","MM",";","}","float","MW","(","float","MR",",","float","MS",",","float","MT",",","float","MU",")","{","float","MV",";","MV","=","Le","-","MU",";","return","Le","-","(","MV","+","MT","*","(","Le","-","MR",")",")","*","(","Le","-","MS",")",";","}","float","Nb","(","float","MX",",","float","MY",",","float","MZ",",","float","M_",")","{","float","Na",";","Na","=","Le","-","M_",";","return","mix","(","MY","*","(","Na","+","2.0","*","MZ","*","MX",")",",","Le","-","(","Na","+","2.0",
"*","MZ","*","(","Le","-","MX",")",")","*","(","Le","-","MY",")",",","step","(","0.5",",","MY",")",")",";","}"]}]},exports["include/fxaa.glslf"]={type:"group",parts:[{type:"condition",parts:[{type:"ifndef",name:"FXAA_PS3",group:{type:"group",parts:[{type:"define",name:"FXAA_PS3",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_360",group:{type:"group",parts:[{type:"define",name:"FXAA_360",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_360_OPT",group:{type:"group",
parts:[{type:"define",name:"FXAA_360_OPT",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_PC",group:{type:"group",parts:[{type:"define",name:"FXAA_PC",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_PC_CONSOLE",group:{type:"group",parts:[{type:"define",name:"FXAA_PC_CONSOLE",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_GLSL_120",group:{type:"group",parts:[{type:"define",name:"FXAA_GLSL_120",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",
name:"FXAA_GLSL_130",group:{type:"group",parts:[{type:"define",name:"FXAA_GLSL_130",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_HLSL_3",group:{type:"group",parts:[{type:"define",name:"FXAA_HLSL_3",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_HLSL_4",group:{type:"group",parts:[{type:"define",name:"FXAA_HLSL_4",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_HLSL_5",group:{type:"group",parts:[{type:"define",name:"FXAA_HLSL_5",
tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_GREEN_AS_LUMA",group:{type:"group",parts:[{type:"define",name:"FXAA_GREEN_AS_LUMA",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_EARLY_EXIT",group:{type:"group",parts:[{type:"define",name:"FXAA_EARLY_EXIT",tokens:["1"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_DISCARD",group:{type:"group",parts:[{type:"define",name:"FXAA_DISCARD",tokens:["0"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_FAST_PIXEL_OFFSET",
group:{type:"group",parts:[{type:"condition",parts:[{type:"ifdef",name:"GL_EXT_gpu_shader4",group:{type:"group",parts:[{type:"define",name:"FXAA_FAST_PIXEL_OFFSET",tokens:["1"]}]}}]},{type:"condition",parts:[{type:"ifdef",name:"GL_NV_gpu_shader5",group:{type:"group",parts:[{type:"define",name:"FXAA_FAST_PIXEL_OFFSET",tokens:["1"]}]}}]},{type:"condition",parts:[{type:"ifdef",name:"GL_ARB_gpu_shader5",group:{type:"group",parts:[{type:"define",name:"FXAA_FAST_PIXEL_OFFSET",tokens:["1"]}]}}]},{type:"condition",
parts:[{type:"ifndef",name:"FXAA_FAST_PIXEL_OFFSET",group:{type:"group",parts:[{type:"define",name:"FXAA_FAST_PIXEL_OFFSET",tokens:["0"]}]}}]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_GATHER4_ALPHA",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:["FXAA_HLSL_5",1,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_GATHER4_ALPHA",tokens:["1"]}]}}]},{type:"condition",parts:[{type:"ifdef",name:"GL_ARB_gpu_shader5",group:{type:"group",
parts:[{type:"define",name:"FXAA_GATHER4_ALPHA",tokens:["1"]}]}}]},{type:"condition",parts:[{type:"ifdef",name:"GL_NV_gpu_shader5",group:{type:"group",parts:[{type:"define",name:"FXAA_GATHER4_ALPHA",tokens:["1"]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_GATHER4_ALPHA",group:{type:"group",parts:[{type:"define",name:"FXAA_GATHER4_ALPHA",tokens:["0"]}]}}]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_CONSOLE_PS3_EDGE_SHARPNESS",group:{type:"group",parts:[{type:"condition",parts:[{type:"if",
expression:[1],group:{type:"group",parts:[{type:"define",name:"FXAA_CONSOLE_PS3_EDGE_SHARPNESS",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:[0],group:{type:"group",parts:[{type:"define",name:"FXAA_CONSOLE_PS3_EDGE_SHARPNESS",tokens:["4.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:[0],group:{type:"group",parts:[{type:"define",name:"FXAA_CONSOLE_PS3_EDGE_SHARPNESS",tokens:["2.0"]}]}}]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_CONSOLE_PS3_EDGE_THRESHOLD",
group:{type:"group",parts:[{type:"condition",parts:[{type:"if",expression:[1],group:{type:"group",parts:[{type:"define",name:"FXAA_CONSOLE_PS3_EDGE_THRESHOLD",tokens:["0.125"]}]}},{type:"else",group:{type:"group",parts:[{type:"define",name:"FXAA_CONSOLE_PS3_EDGE_THRESHOLD",tokens:["0.25"]}]}}]}]}}]},{type:"condition",parts:[{type:"ifndef",name:"FXAA_QUALITY_PRESET",group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PRESET",tokens:["12"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",
10,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["3"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["3.0"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["12.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",11,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["4"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},
{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["3.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["12.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",12,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["5"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},
{type:"define",name:"FXAA_QUALITY_P3",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["12.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",13,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["6"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},
{type:"define",name:"FXAA_QUALITY_P4",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["12.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",14,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["7"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},
{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["12.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",15,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["8"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},
{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["12.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",20,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["3"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.5"]},
{type:"define",name:"FXAA_QUALITY_P1",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",21,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["4"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["8.0"]}]}}]},
{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",22,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["5"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",
23,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["6"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",
24,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["7"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["3.0"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["8.0"]}]}}]},{type:"condition",
parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",25,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["8"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["2.0"]},{type:"define",
name:"FXAA_QUALITY_P6",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",26,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["9"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",
name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P8",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",27,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["10"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",
name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P8",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P9",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",
expression:["FXAA_QUALITY_PRESET",28,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["11"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P6",
tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P8",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P9",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P10",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",29,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["12"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",
tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P5",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P8",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P9",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P10",tokens:["4.0"]},
{type:"define",name:"FXAA_QUALITY_P11",tokens:["8.0"]}]}}]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PRESET",39,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"define",name:"FXAA_QUALITY_PS",tokens:["12"]},{type:"define",name:"FXAA_QUALITY_P0",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P1",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P2",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P3",tokens:["1.0"]},{type:"define",name:"FXAA_QUALITY_P4",tokens:["1.0"]},
{type:"define",name:"FXAA_QUALITY_P5",tokens:["1.5"]},{type:"define",name:"FXAA_QUALITY_P6",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P7",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P8",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P9",tokens:["2.0"]},{type:"define",name:"FXAA_QUALITY_P10",tokens:["4.0"]},{type:"define",name:"FXAA_QUALITY_P11",tokens:["8.0"]}]}}]},{type:"var",name:"FXAA_QUALITY_P12",tokens:["0.0"]},{type:"textline",tokens:["float","Nx","(","float","Nw",")","{","return",
"clamp","(","Nw",",","0.0",",","1.0",")",";","}"]},{type:"condition",parts:[{type:"if",expression:["FXAA_BLEND4WEB",1,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["vec4","NA","(","sampler2D","Ny",",","vec2","Nz",")","{","return","texture2D","(","Ny",",","Nz",")",";","}","vec4","NF","(","sampler2D","NB",",","vec2","NC",",","vec2","ND",",","vec2","NE",")","{","return","texture2D","(","NB",",","NC","+","(","ND","*","NE",")",")",";","}"]}]}}]},{type:"textline",tokens:["vec4",
"Ol","(","vec2","NG",",","sampler2D","NH",",","vec2","NI",",","float","NJ",",","float","NK",",","float","NL",")","{","bool","NM",",","NN",",","NO",",","NP",",","NQ",";","float","NR",",","NS",",","NT",",","NU",",","NV",",","NW",",","NX",",","NY",",","NZ",",","N_",",","Oa",",","Ob",",","Oc",",","Od",",","Oe",";","vec4","Of",";","vec2","Og",",","Oh",",","Oi",",","Oj",",","Ok",";","Og",".","x","=","NG",".","x",";","Og",".","y","=","NG",".","y",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_GATHER4_ALPHA",
1,{type:"equal_expr",places:2}],group:{type:"group",parts:[]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["Of","=","NA","(","NH",",","Og",")",";","NR","=","bB","(","Of",")",";","NS","=","bB","(","NF","(","NH",",","Og",",","vec2","(","0",",","1",")",",","NI",".","xy",")",")",";","NT","=","bB","(","NF","(","NH",",","Og",",","vec2","(","1",",","0",")",",","NI",".","xy",")",")",";","NU","=","bB","(","NF","(","NH",",","Og",",","vec2","(","0",",","-","1",")",",","NI",".","xy",")",
")",";","NV","=","bB","(","NF","(","NH",",","Og",",","vec2","(","-","1",",","0",")",",","NI",".","xy",")",")",";"]}]}}]},{type:"textline",tokens:["NW","=","max","(","NS",",","NR",")",";","NX","=","min","(","NS",",","NR",")",";","NW","=","max","(","NT",",","NW",")",";","NX","=","min","(","NT",",","NX",")",";","NY","=","max","(","NU",",","NV",")",";","NZ","=","min","(","NU",",","NV",")",";","NW","=","max","(","NY",",","NW",")",";","NX","=","min","(","NZ",",","NX",")",";","NZ","=","NW","*","NK",";",
"NX","=","NW","-","NX",";","NZ","=","max","(","NL",",","NZ",")",";","NM","=","NX","<","NZ",";","if","(","NM",")","return","Of",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_GATHER4_ALPHA",0,{type:"equal_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["NZ","=","bB","(","NF","(","NH",",","Og",",","vec2","(","-","1",",","-","1",")",",","NI",".","xy",")",")",";","NW","=","bB","(","NF","(","NH",",","Og",",","vec2","(","1",",","1",")",",","NI",".","xy",")",")",";","NY",
"=","bB","(","NF","(","NH",",","Og",",","vec2","(","1",",","-","1",")",",","NI",".","xy",")",")",";","N_","=","bB","(","NF","(","NH",",","Og",",","vec2","(","-","1",",","1",")",",","NI",".","xy",")",")",";"]}]}},{type:"else",group:{type:"group",parts:[]}}]},{type:"textline",tokens:["Oa","=","NU","+","NS",";","Ob","=","NV","+","NT",";","NX","=","1.0","/","NX",";","Oc","=","Oa","+","Ob",";","Oa","=","(","-","2.0","*","NR",")","+","Oa",";","Ob","=","(","-","2.0","*","NR",")","+","Ob",";","Od","=","NY",
"+","NW",";","NY","=","NZ","+","NY",";","Oe","=","(","-","2.0","*","NT",")","+","Od",";","NY","=","(","-","2.0","*","NU",")","+","NY",";","NZ","=","NZ","+","N_",";","NW","=","N_","+","NW",";","Oe","=","(","abs","(","Oa",")","*","2.0",")","+","abs","(","Oe",")",";","NY","=","(","abs","(","Ob",")","*","2.0",")","+","abs","(","NY",")",";","Ob","=","(","-","2.0","*","NV",")","+","NZ",";","NW","=","(","-","2.0","*","NS",")","+","NW",";","Oe","=","abs","(","Ob",")","+","Oe",";","NY","=","abs","(","NW",
")","+","NY",";","Od","=","NZ","+","Od",";","NZ","=","NI",".","x",";","NM","=","Oe",">=","NY",";","Od","=","Oc","*","2.0","+","Od",";","if","(","!","NM",")","NU","=","NV",";","if","(","!","NM",")","NS","=","NT",";","if","(","NM",")","NZ","=","NI",".","y",";","Od","=","(","Od","*","(","1.0","/","12.0",")",")","-","NR",";","NT","=","NU","-","NR",";","NV","=","NS","-","NR",";","NU","=","NU","+","NR",";","NS","=","NS","+","NR",";","NN","=","abs","(","NT",")",">=","abs","(","NV",")",";","NV","=","max",
"(","abs","(","NT",")",",","abs","(","NV",")",")",";","if","(","NN",")","NZ","=","-","NZ",";","NX","=","Nx","(","abs","(","Od",")","*","NX",")",";","Oh",".","x","=","Og",".","x",";","Oh",".","y","=","Og",".","y",";","Oi",".","x","=","(","!","NM",")","?","0.0",":","NI",".","x",";","Oi",".","y","=","(","NM",")","?","0.0",":","NI",".","y",";","if","(","!","NM",")","Oh",".","x","+=","NZ","*","0.5",";","if","(","NM",")","Oh",".","y","+=","NZ","*","0.5",";","Oj",".","x","=","Oh",".","x","-","Oi",".","x",
"*","FXAA_QUALITY_P0",";","Oj",".","y","=","Oh",".","y","-","Oi",".","y","*","FXAA_QUALITY_P0",";","Ok",".","x","=","Oh",".","x","+","Oi",".","x","*","FXAA_QUALITY_P0",";","Ok",".","y","=","Oh",".","y","+","Oi",".","y","*","FXAA_QUALITY_P0",";","Od","=","(","(","-","2.0",")","*","NX",")","+","3.0",";","NT","=","bB","(","NA","(","NH",",","Oj",")",")",";","NX","=","NX","*","NX",";","Oc","=","bB","(","NA","(","NH",",","Ok",")",")",";","if","(","!","NN",")","NU","=","NS",";","NV","=","NV","*","1.0","/",
"4.0",";","NS","=","NR","-","NU","*","0.5",";","NX","=","Od","*","NX",";","NN","=","NS","<","0.0",";","NT","-=","NU","*","0.5",";","Oc","-=","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P1",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P1",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".",
"x","*","FXAA_QUALITY_P1",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P1",";","if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";",
"if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P2",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P2",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P2",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P2",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",3,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P3",";","if","(","!","NO",")",
"Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P3",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P3",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P3",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",4,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".",
"xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P4",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P4",";","NQ","=","(","!","NO",")","||","(","!","NP",
")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P4",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P4",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",5,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";",
"if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P5",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P5",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P5",";","if","(","!",
"NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P5",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",6,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-",
"NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P6",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P6",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P6",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P6",";"]},{type:"condition",parts:[{type:"if",
expression:["FXAA_QUALITY_PS",7,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";",
"if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P7",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P7",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P7",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P7",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",8,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",
tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P8",";","if","(","!","NO",")",
"Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P8",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P8",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P8",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",9,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".",
"xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P9",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P9",";","NQ","=","(","!","NO",")","||","(","!","NP",
")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P9",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P9",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",10,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",
";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P10",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P10",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P10",";","if",
"(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P10",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_QUALITY_PS",11,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=",
"Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P11",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P11",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P11",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P11",";"]},{type:"condition",
parts:[{type:"if",expression:["FXAA_QUALITY_PS",12,{type:"g_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["if","(","NQ",")","{","if","(","!","NO",")","NT","=","bB","(","NA","(","NH",",","Oj",".","xy",")",")",";","if","(","!","NP",")","Oc","=","bB","(","NA","(","NH",",","Ok",".","xy",")",")",";","if","(","!","NO",")","NT","=","NT","-","NU","*","0.5",";","if","(","!","NP",")","Oc","=","Oc","-","NU","*","0.5",";","NO","=","abs","(","NT",")",">=","NV",";","NP","=","abs","(","Oc",
")",">=","NV",";","if","(","!","NO",")","Oj",".","x","-=","Oi",".","x","*","FXAA_QUALITY_P12",";","if","(","!","NO",")","Oj",".","y","-=","Oi",".","y","*","FXAA_QUALITY_P12",";","NQ","=","(","!","NO",")","||","(","!","NP",")",";","if","(","!","NP",")","Ok",".","x","+=","Oi",".","x","*","FXAA_QUALITY_P12",";","if","(","!","NP",")","Ok",".","y","+=","Oi",".","y","*","FXAA_QUALITY_P12",";","}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},
{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}"]}]}}]},{type:"textline",tokens:["}","NV","=","Og",".","x","-","Oj",".","x",";","NU","=","Ok",".","x","-","Og",".","x",";","if","(","!","NM",")","NV","=","Og",".","y","-","Oj",".","y",";","if","(","!","NM",")","NU","=","Ok",".","y","-","Og",".","y",";","NP","=","(","NT","<","0.0",")","!=","NN",
";","NT","=","(","NU","+","NV",")",";","NN","=","(","Oc","<","0.0",")","!=","NN",";","NT","=","1.0","/","NT",";","NO","=","NV","<","NU",";","NU","=","min","(","NV",",","NU",")",";","NN","=","NO","?","NP",":","NN",";","NX","=","NX","*","NX",";","NT","=","(","NU","*","(","-","NT",")",")","+","0.5",";","NX","=","NX","*","NJ",";","NT","=","NN","?","NT",":","0.0",";","NX","=","max","(","NT",",","NX",")",";","if","(","!","NM",")","Og",".","x","+=","NX","*","NZ",";","if","(","NM",")","Og",".","y","+=","NX",
"*","NZ",";"]},{type:"condition",parts:[{type:"if",expression:["FXAA_DISCARD",1,{type:"equal_expr",places:2},"FXAA_BLEND4WEB",1,{type:"equal_expr",places:2},{type:"logical_or_expr",places:2}],group:{type:"group",parts:[{type:"textline",tokens:["return","NA","(","NH",",","Og",")",";"]}]}},{type:"else",group:{type:"group",parts:[{type:"textline",tokens:["return","vec4","(","NA","(","NH",",","Og",")",".","xyz",",","NR",")",";"]}]}}]},{type:"textline",tokens:["}"]}]},exports["include/depth_fetch.glslf"]=
{type:"group",parts:[{type:"textline",tokens:["float","Os","(","in","sampler2D","Om",",","in","vec2","On",",","in","vec2","Oo",")","{","float","Op",",","Oq",",","Or",";","Op","=","texture2D","(","Om",",","On",")",".","r",";","Oq","=","Oo",".","x",";","Or","=","Oo",".","y",";","Oq","=","2.0","*","Oq","/","(","Oq","+","Or","-","(","2.0","*","Op","-","1.0",")","*","(","Or","-","Oq",")",")",";","return","Oq",";","}"]}]}};b4w.module["animation"]=function(exports,require){var m_anim=require("__animation");var m_armat=require("__armature");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_tsr=require("__tsr");exports.SLOT_0=m_anim.SLOT_0;exports.SLOT_1=m_anim.SLOT_1;exports.SLOT_2=m_anim.SLOT_2;exports.SLOT_3=m_anim.SLOT_3;exports.SLOT_4=m_anim.SLOT_4;exports.SLOT_5=m_anim.SLOT_5;exports.SLOT_6=m_anim.SLOT_6;exports.SLOT_7=m_anim.SLOT_7;exports.SLOT_ALL=m_anim.SLOT_ALL;exports.OBJ_ANIM_TYPE_NONE=
m_anim.OBJ_ANIM_TYPE_NONE;exports.OBJ_ANIM_TYPE_ARMATURE=m_anim.OBJ_ANIM_TYPE_ARMATURE;exports.OBJ_ANIM_TYPE_OBJECT=m_anim.OBJ_ANIM_TYPE_OBJECT;exports.OBJ_ANIM_TYPE_VERTEX=m_anim.OBJ_ANIM_TYPE_VERTEX;exports.OBJ_ANIM_TYPE_SOUND=m_anim.OBJ_ANIM_TYPE_SOUND;exports.OBJ_ANIM_TYPE_PARTICLES=m_anim.OBJ_ANIM_TYPE_PARTICLES;exports.OBJ_ANIM_TYPE_MATERIAL=m_anim.OBJ_ANIM_TYPE_MATERIAL;exports.AB_CYCLIC=m_anim.AB_CYCLIC;exports.AB_FINISH_RESET=m_anim.AB_FINISH_RESET;exports.AB_FINISH_STOP=m_anim.AB_FINISH_STOP;
var _tsr_tmp=m_tsr.create();exports.is_animated=function(obj){return m_anim.is_animated(obj)};exports.get_anim_names=function(obj){if(!m_anim.obj_is_animatable(obj))return[];return m_anim.get_anim_names(obj)};exports.get_current_anim_name=function(obj,slot_num){if(!m_anim.is_animated(obj))return null;slot_num=slot_num||m_anim.SLOT_0;return m_anim.get_anim_by_slot_num(obj,slot_num)};exports.apply=function(obj,name,slot_num){if(slot_num>m_anim.SLOT_7){m_print.error("Can't apply animation to slot "+
slot_num+' for object "'+obj.name+'". Object can have maximum of 8 animation slots');return}slot_num=slot_num||m_anim.SLOT_0;if(m_anim.is_animated(obj)){var applied_slot=m_anim.get_slot_num_by_anim(obj,name);if(applied_slot!=-1&&applied_slot!=slot_num){m_print.error('Animation "'+name+'" is already applied to object "'+obj.name+'" (slot "'+applied_slot+'").');return}}if(!m_anim.validate_action_by_name(obj,name)){m_print.error('No fcurves in action "'+name+'"');return}m_anim.apply(obj,name,slot_num)};
exports.remove=function(obj){m_anim.remove(obj)};exports.remove_slot_animation=function(obj,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;m_anim.remove_slot_animation(obj,slot_num)};exports.apply_def=function(obj){m_anim.apply_def(obj)};exports.play=function(obj,finish_callback,slot_num){if(!m_anim.is_animated(obj)){m_print.error('Object "'+obj.name+'" has no applied animation');return}slot_num=slot_num||m_anim.SLOT_0;m_anim.play(obj,finish_callback,slot_num);m_anim.update_object_animation(obj,
0,slot_num,true)};exports.stop=function(obj,slot_num){if(m_anim.is_animated(obj)){slot_num=slot_num||m_anim.SLOT_0;m_anim.stop(obj,slot_num)}};exports.is_play=function(obj,slot_num){if(!m_anim.is_animated(obj))return false;slot_num=slot_num||m_anim.SLOT_0;return m_anim.is_play(obj,slot_num)};exports.set_frame=function(obj,frame,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;m_anim.set_frame(obj,frame,slot_num)};exports.set_first_frame=function(obj,slot_num){if(!m_anim.is_animated(obj))return;
m_anim.set_first_frame(obj,slot_num)};exports.set_last_frame=function(obj,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;var start=m_anim.get_anim_start_frame(obj,slot_num);var len=m_anim.get_anim_length(obj,slot_num);m_anim.set_frame(obj,start+len-m_anim.LAST_FRAME_EPSILON,slot_num)};exports.get_frame=function(obj,slot_num){if(!m_anim.is_animated(obj))return 0;slot_num=slot_num||m_anim.SLOT_0;return m_anim.get_current_frame_float(obj,slot_num)};exports.set_speed=function(obj,
speed,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;speed=speed||1;m_anim.set_speed(obj,speed,slot_num)};exports.get_speed=function(obj,slot_num){if(!m_anim.is_animated(obj))return 0;slot_num=slot_num||m_anim.SLOT_0;if(!obj.anim_slots[slot_num])return 0;return m_anim.get_speed(obj,slot_num)};exports.get_anim_start_frame=function(obj,slot_num){if(m_anim.is_animated(obj)){slot_num=slot_num||m_anim.SLOT_0;if(!obj.anim_slots[slot_num])return-1;else return m_anim.get_anim_start_frame(obj,
slot_num)}return-1};exports.get_anim_length=function(obj,slot_num){if(m_anim.is_animated(obj)){slot_num=slot_num||m_anim.SLOT_0;if(!obj.anim_slots[slot_num])return-1;else return m_anim.get_anim_length(obj,slot_num)}return-1};exports.set_behavior=function(obj,behavior,slot_num){if(!m_anim.is_animated(obj))return;slot_num=slot_num||m_anim.SLOT_0;m_anim.set_behavior(obj,behavior,slot_num)};exports.get_behavior=function(obj,slot_num){if(!m_anim.is_animated(obj))return null;slot_num=slot_num||m_anim.SLOT_0;
return m_anim.get_behavior(obj,slot_num)};exports.apply_smoothing=function(obj,trans_period,quat_period,slot_num){slot_num=slot_num||m_anim.SLOT_0;if(m_anim.is_animated(obj))m_anim.apply_smoothing(obj,trans_period,quat_period,slot_num)};exports.frame_to_sec=function(frame){return m_anim.frame_to_sec(frame)};exports.get_bone_translation=function(armobj,bone_name,dest){m_print.error_deprecated("get_bone_translation","armature.get_bone_tsr");if(!m_obj_util.is_armature(armobj))return null;if(!m_armat.check_bone(armobj,
bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return null}if(!dest)var dest=new Float32Array(3);var tsr=_tsr_tmp;m_armat.get_bone_tsr(armobj,bone_name,false,false,tsr);dest[0]=tsr[0];dest[1]=tsr[1];dest[2]=tsr[2];return dest};exports.get_first_armature_object=function(obj){m_print.error_once("get_first_armature_object() deprecated");return null};exports.get_slot_num_by_anim=function(obj,anim_name){if(!m_anim.is_animated(obj)||!anim_name)return null;return m_anim.get_slot_num_by_anim(obj,
anim_name)};exports.get_anim_type=function(obj,slot_num){if(!m_anim.is_animated(obj))return null;return m_anim.get_anim_type(obj,slot_num)};exports.apply_to_first_empty_slot=function(obj,name){return m_anim.apply_to_first_empty_slot(obj,name)};exports.get_skel_mix_factor=function(armobj){return armobj.render.anim_mix_factor};exports.set_skel_mix_factor=function(armobj,factor,time){if(!m_obj_util.is_armature(armobj)){m_print.error("Can't blend animation. Object \""+armobj.name+'" is not armature');
return}factor=Math.min(Math.max(factor,0),1);if(armobj.render.anim_mix_factor==factor)return;time=time||0;m_anim.set_skel_mix_factor(armobj,factor,time)}};b4w.module["anchors"]=function(exports,require){var m_anchors=require("__anchors");var m_print=require("__print");exports.attach_move_cb=m_anchors.attach_move_cb;exports.detach_move_cb=m_anchors.detach_move_cb;exports.is_anchor=m_anchors.is_anchor;exports.get_element_id=m_anchors.get_element_id};b4w.module["armature"]=function(exports,require){var m_armat=require("__armature");var m_obj_util=require("__obj_util");var m_trans=require("__transform");var m_print=require("__print");exports.get_bone_tsr=function(armobj,bone_name,dest){if(!m_obj_util.is_armature(armobj))return null;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return null}if(!dest)var dest=new Float32Array(8);m_armat.get_bone_tsr(armobj,bone_name,false,false,
dest);return dest};exports.get_bone_tsr_rel=function(armobj,bone_name,dest){if(!m_obj_util.is_armature(armobj))return null;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return null}if(!dest)var dest=new Float32Array(8);m_armat.get_bone_tsr(armobj,bone_name,false,true,dest);return dest};exports.set_bone_tsr=function(armobj,bone_name,tsr){if(!m_obj_util.is_armature(armobj))return;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',
bone_name,'" in "',armobj.name,'".');return}m_armat.set_bone_tsr(armobj,bone_name,tsr,false);m_trans.update_transform(armobj)};exports.set_bone_tsr_rel=function(armobj,bone_name,tsr){if(!m_obj_util.is_armature(armobj))return;if(!m_armat.check_bone(armobj,bone_name)){m_print.error('There is no bone: "',bone_name,'" in "',armobj.name,'".');return}m_armat.set_bone_tsr(armobj,bone_name,tsr,true);m_trans.update_transform(armobj)}};b4w.module["assets"]=function(exports,require){var m_assets=require("__assets");exports.AT_ARRAYBUFFER=m_assets.AT_ARRAYBUFFER;exports.AT_JSON=m_assets.AT_JSON;exports.AT_TEXT=m_assets.AT_TEXT;exports.AT_AUDIOBUFFER=m_assets.AT_AUDIOBUFFER;exports.AT_IMAGE_ELEMENT=m_assets.AT_IMAGE_ELEMENT;exports.AT_AUDIO_ELEMENT=m_assets.AT_AUDIO_ELEMENT;exports.enqueue=function(assets_pack,asset_cb,pack_cb,progress_cb){if(assets_pack.length)if(assets_pack["id"])m_assets.enqueue(assets_pack,asset_cb,pack_cb,progress_cb);
else{var new_asset_pack=[];for(var i=0;i<assets_pack.length;i++){var pack_elem=assets_pack[i];new_asset_pack.push({id:pack_elem[0],type:pack_elem[1],url:pack_elem[2],request:pack_elem.request?pack_elem.request:"GET",post_type:null,post_data:null,param:pack_elem[3]})}m_assets.enqueue(new_asset_pack,asset_cb,pack_cb,progress_cb)}}};b4w.module["camera"]=function(exports,require){var m_cam=require("__camera");var m_cfg=require("__config");var m_cons=require("__constraints");var m_cont=require("__container");var m_mat4=require("__mat4");var m_math=require("__math");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_scs=require("__scenes");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var m_vec4=require("__vec4");
var cfg_ctl=m_cfg.controls;var _vec2_tmp=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec4_tmp=new Float32Array(4);var _mat3_tmp=new Float32Array(9);var _limits_tmp={};var _limits_tmp2={};exports.MS_STATIC=m_cam.MS_STATIC;exports.MS_TARGET_CONTROLS=m_cam.MS_TARGET_CONTROLS;exports.MS_EYE_CONTROLS=m_cam.MS_EYE_CONTROLS;exports.MS_HOVER_CONTROLS=m_cam.MS_HOVER_CONTROLS;exports.static_setup=function(camobj,params){if(!m_obj_util.is_camera(camobj)){m_print.error("static_setup(): Wrong camera object");
return}m_cam.wipe_move_style(camobj);camobj.render.move_style=m_cam.MS_STATIC;if(params){var pos=params.pos||m_tsr.get_trans_view(camobj.render.world_tsr);if(params.look_at)m_cam.set_look_at(camobj,pos,params.look_at);else m_trans.set_translation(camobj,pos)}m_trans.update_transform(camobj);m_phy.sync_transform(camobj);m_cam.init_ortho_props(camobj)};exports.static_set_look_at=function(camobj,pos,look_at){if(!m_cam.is_static_camera(camobj)){m_print.error("static_set_look_at(): Wrong camera object or camera move style");
return}pos=pos||m_tsr.get_trans_view(camobj.render.world_tsr);if(look_at)m_cam.set_look_at(camobj,pos,look_at);else m_trans.set_translation(camobj,pos);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.static_set_rotation=function(camobj,quat){if(!m_cam.is_static_camera(camobj)){m_print.error("static_set_rotation(): Wrong camera object or camera move style");return}m_trans.set_rotation(camobj,quat);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.static_get_rotation=
function(camobj,dest){if(!m_cam.is_static_camera(camobj)){m_print.error("static_get_rotation(): Wrong camera object or camera move style");return null}dest=dest||new Float32Array(4);return m_trans.get_rotation(camobj,dest)};exports.eye_setup=function(camobj,params){if(!m_obj_util.is_camera(camobj)){m_print.error("eye_setup(): Wrong camera object");return}if(params&&params.horiz_rot_lim)if(typeof params.horiz_rot_lim.left!="number"||typeof params.horiz_rot_lim.right!="number"){m_print.error("eye_setup(): Wrong horizontal limits object.");
return}if(params&&params.vert_rot_lim)if(typeof params.vert_rot_lim.down!="number"||typeof params.vert_rot_lim.up!="number"){m_print.error("eye_setup(): Wrong vertical limits object.");return}m_cam.wipe_move_style(camobj);camobj.render.move_style=m_cam.MS_EYE_CONTROLS;if(params){var pos=params.pos||m_tsr.get_trans_view(camobj.render.world_tsr);m_cam.setup_eye_model(camobj,pos,params.look_at,params.horiz_rot_lim,params.vert_rot_lim)}m_trans.update_transform(camobj);m_phy.sync_transform(camobj);m_cam.init_ortho_props(camobj)};
exports.eye_set_look_at=function(camobj,pos,look_at){if(!m_cam.is_eye_camera(camobj)){m_print.error("eye_set_look_at(): Wrong camera object or camera move style");return}pos=pos||m_tsr.get_trans_view(camobj.render.world_tsr);if(look_at)m_cam.set_look_at_corrected(camobj,pos,look_at);else m_trans.set_translation(camobj,pos);m_cons.correct_up(camobj,camobj.render.vertical_axis,true);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.eye_rotate=function(camobj,phi,theta,phi_is_abs,
theta_is_abs){if(!m_cam.is_eye_camera(camobj)){m_print.error("eye_rotate(): Wrong camera object or camera move style");return}phi_is_abs=phi_is_abs||false;theta_is_abs=theta_is_abs||false;m_cam.rotate_eye_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.eye_set_vertical_limits=function(camobj,limits){if(!m_cam.is_eye_camera(camobj)){m_print.error("eye_set_vertical_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.down!=
"number"||typeof limits.up!="number"){m_print.error("eye_set_vertical_limits(): Incorrect limits object.");return}m_cam.set_vertical_rot_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.eye_get_vertical_limits=function(camobj,dest,local){if(!m_cam.is_eye_camera(camobj)){m_print.error("eye_get_vertical_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;if(render.vertical_limits){dest=dest||{};if(local){dest.down=render.vertical_limits.down_local;
dest.up=render.vertical_limits.up_local}else{dest.down=render.vertical_limits.down;dest.up=render.vertical_limits.up}dest.camera_space=local||false;return dest}else return null};exports.eye_set_horizontal_limits=function(camobj,limits){if(!m_cam.is_eye_camera(camobj)){m_print.error("eye_set_horizontal_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.left!="number"||typeof limits.right!="number"){m_print.error("eye_set_horizontal_limits(): Incorrect limits object.");
return}m_cam.set_horizontal_rot_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.eye_get_horizontal_limits=function(camobj,dest,local){if(!m_cam.is_eye_camera(camobj)){m_print.error("eye_get_horizontal_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;if(render.horizontal_limits){dest=dest||{};if(local){dest.left=render.horizontal_limits.left_local;dest.right=render.horizontal_limits.right_local}else{dest.left=render.horizontal_limits.left;
dest.right=render.horizontal_limits.right}dest.camera_space=local||false;return dest}else return null};exports.target_setup=function(camobj,params){if(!m_obj_util.is_camera(camobj)){m_print.error("target_setup(): Wrong camera object");return}if(params.horiz_rot_lim)if(typeof params.horiz_rot_lim.left!="number"||typeof params.horiz_rot_lim.right!="number"){m_print.error("target_setup(): Wrong horizontal limits object");return}if(params.vert_rot_lim)if(typeof params.vert_rot_lim.down!="number"||typeof params.vert_rot_lim.up!=
"number"){m_print.error("target_setup(): Wrong vertical limits object");return}if(params.dist_lim){if(typeof params.dist_lim.min!="number"||typeof params.dist_lim.max!="number"||params.dist_lim.min>params.dist_lim.max){m_print.error("target_setup(): Wrong distance limits object");return}params.dist_lim.min=Math.max(params.dist_lim.min,0);params.dist_lim.max=Math.max(params.dist_lim.max,0)}if(params.pivot_lim)if(typeof params.pivot_lim.min_y!="number"||typeof params.pivot_lim.max_y!="number"||params.pivot_lim.min_y>
params.pivot_lim.max_y){m_print.error("target_setup(): Wrong pivot limits object");return}m_cam.wipe_move_style(camobj);camobj.render.move_style=m_cam.MS_TARGET_CONTROLS;var pos=params.pos||m_tsr.get_trans_view(camobj.render.world_tsr);m_cam.setup_target_model(camobj,pos,params.pivot,params.horiz_rot_lim,params.vert_rot_lim,params.dist_lim,params.pivot_lim,params.use_panning||false);m_trans.update_transform(camobj);m_phy.sync_transform(camobj);m_cam.init_ortho_props(camobj)};exports.target_rotate=
function(camobj,phi,theta,phi_is_abs,theta_is_abs){if(!m_cam.is_target_camera(camobj)){m_print.error("target_rotate(): Wrong camera object or camera move style");return}phi_is_abs=phi_is_abs||false;theta_is_abs=theta_is_abs||false;m_cam.rotate_target_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_set_trans_pivot=function(camobj,trans,pivot){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_trans_pivot(): Wrong camera object or camera move style");
return}trans=trans||m_tsr.get_trans_view(camobj.render.world_tsr);pivot=pivot||camobj.render.pivot;m_cam.set_trans_pivot(camobj,trans,pivot);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_set_pivot_translation=function(camobj,trans){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_pivot_translation(): Wrong camera object or camera move style");return}m_cam.set_target_pivot(camobj,trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_set_distance=
function(camobj,distance){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_distance(): Wrong camera object or camera move style");return}var dist_curr=m_trans.obj_point_distance(camobj,camobj.render.pivot);var dist_needed=Math.max(0,distance);m_trans.move_local(camobj,0,dist_needed-dist_curr,0);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_get_distance=function(camobj){if(!m_cam.is_target_camera(camobj)){m_print.error("target_get_distance(): Wrong camera object or camera move style");
return 0}return m_trans.obj_point_distance(camobj,camobj.render.pivot)};exports.target_zoom_object=function(camobj,obj){if(!m_cam.is_target_camera(camobj)){m_print.error("target_zoom_object(): Wrong camera object or camera move style");return}var center=m_trans.get_object_center(obj,false,_vec3_tmp);var radius=m_trans.get_object_size(obj);var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var main_camera=cam_scene_data.cameras[0];var ang_radius=m_cam.get_angular_diameter(main_camera)/
2;var dist_need=radius/Math.sin(ang_radius);var dist_current=m_trans.obj_point_distance(camobj,center);m_cam.set_trans_pivot(camobj,m_tsr.get_trans_view(camobj.render.world_tsr),center);m_trans.update_transform(camobj);m_trans.move_local(camobj,0,dist_need-dist_current,0);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_get_pivot=function(camobj,dest){if(!m_cam.is_target_camera(camobj)){m_print.error("target_get_pivot(): Wrong camera object or camera move style");return null}dest=
dest||new Float32Array(3);m_vec3.copy(camobj.render.pivot,dest);return dest};exports.target_set_distance_limits=function(camobj,limits){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_distance_limits(): Wrong camera object or camera move style");return}if(limits){if(typeof limits.min!="number"||typeof limits.max!="number"||limits.min>limits.max){m_print.error("target_set_distance_limits(): Wrong limits object");return}limits.min=Math.max(limits.min,0);limits.max=Math.max(limits.max,
0)}m_cam.set_distance_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_get_distance_limits=function(camobj,dest){if(!m_cam.is_target_camera(camobj)){m_print.error("target_get_distance_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;if(render.distance_limits){dest=dest||{};dest.min=render.distance_limits.min;dest.max=render.distance_limits.max;return dest}else return null};exports.target_set_vertical_limits=
function(camobj,limits){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_vertical_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.down!="number"||typeof limits.up!="number"){m_print.error("target_set_vertical_limits(): Wrong limits object");return}m_cam.set_vertical_rot_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_get_vertical_limits=function(camobj,dest,local){if(!m_cam.is_target_camera(camobj)){m_print.error("target_get_vertical_limits(): Wrong camera object or camera move style");
return null}var render=camobj.render;if(render.vertical_limits){dest=dest||{};if(local){dest.down=render.vertical_limits.down_local;dest.up=render.vertical_limits.up_local}else{dest.down=render.vertical_limits.down;dest.up=render.vertical_limits.up}dest.camera_space=local||false;return dest}else return null};exports.target_set_horizontal_limits=function(camobj,limits){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_horizontal_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.left!=
"number"||typeof limits.right!="number"){m_print.error("target_set_horizontal_limits(): Wrong limits object");return}m_cam.set_horizontal_rot_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_get_horizontal_limits=function(camobj,dest,local){if(!m_cam.is_target_camera(camobj)){m_print.error("target_get_horizontal_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;if(render.horizontal_limits){dest=dest||{};if(local){dest.left=
render.horizontal_limits.left_local;dest.right=render.horizontal_limits.right_local}else{dest.left=render.horizontal_limits.left;dest.right=render.horizontal_limits.right}dest.camera_space=local||false;return dest}else return null};exports.target_set_pivot_limits=function(camobj,limits){if(!m_cam.is_target_camera(camobj)){m_print.error("target_set_pivot_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.min_y!="number"||typeof limits.max_y!="number"||limits.min_y>
limits.max_y){m_print.error("target_set_pivot_limits(): Wrong limits object");return}m_cam.set_pivot_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.target_get_pivot_limits=function(camobj,dest){if(!m_cam.is_target_camera(camobj)){m_print.error("target_get_pivot_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;if(render.pivot_limits){dest=dest||{};dest.min_y=render.pivot_limits.min_y;dest.max_y=render.pivot_limits.max_y;
return dest}else return null};exports.target_pan_pivot=function(camobj,trans_h_delta,trans_v_delta){if(!m_cam.is_target_camera(camobj)){m_print.error("target_pan_pivot(): wrong object");return}var render=camobj.render;if(render.use_panning){var trans_vector=_vec3_tmp;trans_vector[0]=trans_h_delta;trans_vector[1]=0;trans_vector[2]=trans_v_delta;m_tsr.transform_dir_vec3(trans_vector,render.world_tsr,trans_vector);m_vec3.add(render.pivot,trans_vector,render.pivot);var cam_trans=m_tsr.get_trans_view(render.world_tsr);
m_vec3.add(cam_trans,trans_vector,cam_trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}};exports.target_switch_panning=function(camobj,enable){if(!m_cam.is_target_camera(camobj)){m_print.error("target_switch_panning(): Wrong camera object or camera move style");return null}camobj.render.use_panning=enable};exports.hover_setup_rel=function(camobj,params){exports.hover_setup(camobj,{pos:params.pos,pivot:params.pivot});if(typeof params.dist_interval=="undefined")var dist_interval=
0;else var dist_interval=Math.max(params.dist_interval,0);if(typeof params.angle_interval=="undefined")var angle_interval=0;else var angle_interval=Math.max(params.angle_interval,0);if(typeof params.t=="undefined")var t=.5;else var t=m_util.clamp(params.t,0,1);var dist_lim=exports.hover_get_distance_limits(camobj,_limits_tmp);dist_lim.min=Math.max(dist_lim.min-t*dist_interval,0);dist_lim.max=dist_lim.max+(1-t)*dist_interval;var ha_lim=exports.hover_get_vertical_limits(camobj,_limits_tmp2);ha_lim.down=
m_util.clamp(ha_lim.down+t*angle_interval,-Math.PI/2,0);ha_lim.up=m_util.clamp(ha_lim.up-(1-t)*angle_interval,-Math.PI/2,0);m_cam.hover_set_distance_limits(camobj,dist_lim);m_cam.hover_set_vertical_limits(camobj,ha_lim);m_trans.update_transform(camobj);m_phy.sync_transform(camobj);m_cam.init_ortho_props(camobj)};exports.hover_setup=function(camobj,params){if(!m_obj_util.is_camera(camobj)){m_print.error("hover_setup(): Wrong camera object");return}if(params.dist_lim){if(typeof params.dist_lim.min!=
"number"||typeof params.dist_lim.max!="number"||params.dist_lim.min>params.dist_lim.max){m_print.error("hover_setup(): Wrong distance limits object");return}params.dist_lim.min=Math.max(params.dist_lim.min,0);params.dist_lim.max=Math.max(params.dist_lim.max,0)}if(params.hover_angle_lim)if(typeof params.hover_angle_lim.down!="number"||typeof params.hover_angle_lim.up!="number"||params.hover_angle_lim.down<params.hover_angle_lim.up){m_print.error("hover_setup(): Wrong hover angle limits object");return}if(params.horiz_trans_lim)if(typeof params.horiz_trans_lim.min!=
"number"||typeof params.horiz_trans_lim.max!="number"||params.horiz_trans_lim.min>params.horiz_trans_lim.max){m_print.error("hover_setup(): Wrong horizontal translation limits object");return}if(params.vert_trans_lim)if(typeof params.vert_trans_lim.min!="number"||typeof params.vert_trans_lim.max!="number"||params.vert_trans_lim.min>params.vert_trans_lim.max){m_print.error("hover_setup(): Wrong vertical translation limits object");return}m_cam.wipe_move_style(camobj);camobj.render.move_style=m_cam.MS_HOVER_CONTROLS;
var pos=params.pos||m_tsr.get_trans_view(camobj.render.world_tsr);m_cam.setup_hover_model(camobj,pos,params.pivot,params.dist_lim,params.hover_angle_lim,params.horiz_trans_lim,params.vert_trans_lim,params.enable_horiz_rot||false);m_trans.update_transform(camobj);m_phy.sync_transform(camobj);m_cam.init_ortho_props(camobj)};exports.hover_rotate=function(camobj,phi,theta,phi_is_abs,theta_is_abs){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_rotate(): Wrong camera object or camera move style");
return}phi_is_abs=phi_is_abs||false;theta_is_abs=theta_is_abs||false;m_cam.rotate_hover_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.hover_set_pivot_translation=function(camobj,trans){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_set_pivot_translation(): Wrong camera object or camera move style");return}m_cam.set_hover_pivot(camobj,trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.hover_get_pivot=
function(camobj,dest){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_get_pivot(): Wrong camera object or camera move style");return null}dest=dest||new Float32Array(3);m_vec3.copy(camobj.render.hover_pivot,dest);return dest};exports.hover_get_distance=function(camobj){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_get_distance(): Wrong camera object or camera move style");return 0}return m_trans.obj_point_distance(camobj,camobj.render.hover_pivot)};exports.hover_set_vertical_limits=
function(camobj,limits){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_set_vertical_limits(): Wrong camera object or camera move style");return}if(typeof limits.down!="number"||typeof limits.up!="number"||limits.down<limits.up){m_print.error("hover_set_vertical_limits(): Wrong limits object");return}m_cam.hover_set_vertical_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.hover_get_vertical_limits=function(camobj,dest){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_get_vertical_limits(): Wrong camera object or camera move style");
return null}var render=camobj.render;dest=dest||{};dest.down=render.vertical_limits.down;dest.up=render.vertical_limits.up;return dest};exports.hover_set_distance_limits=function(camobj,limits){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_set_distance_limits(): Wrong camera object or camera move style");return}if(typeof limits.min!="number"||typeof limits.max!="number"||limits.min>limits.max){m_print.error("hover_set_distance_limits(): Wrong limits object");return}limits.min=Math.max(limits.min,
0);limits.max=Math.max(limits.max,0);m_cam.hover_set_distance_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.hover_get_distance_limits=function(camobj,dest){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_get_distance_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;dest=dest||{};dest.min=render.distance_limits.min;dest.max=render.distance_limits.max;return dest};exports.hover_set_vert_trans_limits=function(camobj,
limits){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_set_vert_trans_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.min!="number"||typeof limits.max!="number"||limits.min>limits.max){m_print.error("hover_set_vert_trans_limits(): Wrong limits object");return}m_cam.set_vert_trans_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.hover_get_vert_trans_limits=function(camobj,dest){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_get_vert_trans_limits(): Wrong camera object or camera move style");
return null}var render=camobj.render;if(render.hover_vert_trans_limits){dest=dest||{};dest.min=render.hover_vert_trans_limits.min;dest.max=render.hover_vert_trans_limits.max;return dest}else return null};exports.hover_set_horiz_trans_limits=function(camobj,limits){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_set_horiz_trans_limits(): Wrong camera object or camera move style");return}if(limits)if(typeof limits.min!="number"||typeof limits.max!="number"||limits.min>limits.max){m_print.error("hover_set_horiz_trans_limits(): Wrong limits object");
return}m_cam.set_hor_trans_limits(camobj,limits);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.hover_get_horiz_trans_limits=function(camobj,dest){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_get_horiz_trans_limits(): Wrong camera object or camera move style");return null}var render=camobj.render;if(render.hover_horiz_trans_limits){dest=dest||{};dest.min=render.hover_horiz_trans_limits.min;dest.max=render.hover_horiz_trans_limits.max;return dest}else return null};
exports.hover_switch_horiz_rotation=function(camobj,enable){if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_switch_horiz_rotation(): Wrong camera object or camera move style");return null}camobj.render.enable_hover_hor_rotation=enable};exports.is_static_camera=m_cam.is_static_camera;exports.is_target_camera=m_cam.is_target_camera;exports.is_eye_camera=m_cam.is_eye_camera;exports.is_hover_camera=m_cam.is_hover_camera;function is_hmd_camera(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("is_hmd_camera(): Wrong camera object");
return false}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==m_cam.TYPE_HMD_LEFT||cam.type==m_cam.TYPE_HMD_RIGHT)return true}return false}exports.set_move_style=function(camobj,move_style){if(!m_obj_util.is_camera(camobj)){m_print.error("set_move_style(): Wrong camera object");return false}if(move_style!=m_cam.MS_STATIC&&move_style!=m_cam.MS_EYE_CONTROLS&&
move_style!=m_cam.MS_TARGET_CONTROLS&&move_style!=m_cam.MS_HOVER_CONTROLS){m_print.error("set_move_style(): Wrong move style");return false}m_cam.set_move_style(camobj,move_style);m_trans.update_transform(camobj);m_phy.sync_transform(camobj);return true};exports.get_move_style=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("get_move_style(): Wrong camera object");return null}return m_cam.get_move_style(camobj)};exports.set_translation=function(camobj,trans){if(!m_obj_util.is_camera(camobj)){m_print.error("set_translation(): Wrong camera object");
return}var render=camobj.render;if(m_cam.is_target_camera(camobj)){var cam_trans=m_tsr.get_trans_view(render.world_tsr);var trans_delta=m_vec3.subtract(trans,cam_trans,_vec3_tmp);m_vec3.add(trans_delta,render.pivot,render.pivot)}else if(m_cam.is_hover_camera(camobj)){var cam_trans=m_tsr.get_trans_view(render.world_tsr);var trans_delta=m_vec3.subtract(trans,cam_trans,_vec3_tmp);m_vec3.add(trans_delta,render.hover_pivot,render.hover_pivot)}m_trans.set_translation(camobj,trans);m_trans.update_transform(camobj);
m_phy.sync_transform(camobj)};exports.get_translation=function(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_translation(): Wrong camera object");return null}dest=dest||new Float32Array(3);return m_trans.get_translation(camobj,dest)};exports.rotate_camera=function(camobj,phi,theta,phi_is_abs,theta_is_abs){if(!m_obj_util.is_camera(camobj)){m_print.error("rotate_camera(): Wrong camera object");return}phi_is_abs=phi_is_abs||false;theta_is_abs=theta_is_abs||false;if(m_cam.is_target_camera(camobj))m_cam.rotate_target_camera(camobj,
phi,theta,phi_is_abs,theta_is_abs);else if(m_cam.is_eye_camera(camobj))m_cam.rotate_eye_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);else if(m_cam.is_hover_camera(camobj))m_cam.rotate_hover_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);else if(m_cam.is_static_camera(camobj))m_print.warn("rotate_camera(): not supported for STATIC cameras");else m_print.error("rotate_camera(): Wrong camera move style");m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.set_velocities=function(camobj,
velocity){if(!m_obj_util.is_camera(camobj)){m_print.error("set_velocities(): Wrong camera object");return}var render=camobj.render;if(typeof velocity.trans=="number")render.velocity_trans=m_util.clamp(velocity.trans,0,Infinity);if(typeof velocity.rot=="number")render.velocity_rot=m_util.clamp(velocity.rot,0,Infinity);if(typeof velocity.zoom=="number")render.velocity_zoom=m_util.clamp(velocity.zoom,0,.99)};exports.get_velocities=function(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_velocities(): Wrong camera object");
return null}var render=camobj.render;dest=dest||{};dest.trans=render.velocity_trans;dest.rot=render.velocity_rot;dest.zoom=render.velocity_zoom;return dest};exports.is_look_up=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("is_look_up(): Wrong camera object");return false}var quat=m_tsr.get_quat_view(camobj.render.world_tsr);var dir=m_util.quat_to_dir(quat,m_util.AXIS_MY,_vec3_tmp);return dir[1]>=0};exports.get_camera_angles=function(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_camera_angles(): Wrong camera object");
return null}dest=dest||new Float32Array(2);m_cam.get_camera_angles(camobj,dest);return dest};exports.get_camera_angles_char=function(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_camera_angles_char(): Wrong camera object");return null}dest=dest||new Float32Array(2);m_cam.get_camera_angles_char(camobj,dest);return dest};exports.set_stereo_distance=function(camobj,conv_dist){if(!m_obj_util.is_camera(camobj)){m_print.error("set_stereo_distance(): Wrong camera object");return}var active_scene=
m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==m_cam.TYPE_STEREO_LEFT||cam.type==m_cam.TYPE_STEREO_RIGHT)m_cam.set_stereo_params(cam,conv_dist,cam.stereo_eye_dist)}};exports.get_stereo_distance=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("get_stereo_distance(): Wrong camera object");return 0}var active_scene=m_scs.get_active();var cam_scene_data=
m_obj_util.get_scene_data(camobj,active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==m_cam.TYPE_STEREO_LEFT||cam.type==m_cam.TYPE_STEREO_RIGHT)return cam.stereo_conv_dist}return 0};exports.set_eye_distance=function(camobj,eye_dist){if(!m_obj_util.is_camera(camobj)){m_print.error("set_eye_distance(): Wrong camera object");return}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=
cam_scene_data.cameras;m_cam.set_eye_distance(cameras,eye_dist)};exports.get_eye_distance=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("get_eye_distance(): Wrong camera object");return 0}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(cam.type==m_cam.TYPE_STEREO_LEFT||cam.type==m_cam.TYPE_STEREO_RIGHT||cam.type==m_cam.TYPE_HMD_LEFT||cam.type==
m_cam.TYPE_HMD_RIGHT)return cam.stereo_eye_dist}return 0};exports.set_vertical_axis=function(camobj,axis){if(!m_obj_util.is_camera(camobj)){m_print.error("set_vertical_axis(): Wrong camera object");return}var render=camobj.render;m_vec3.copy(axis,render.vertical_axis);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.get_vertical_axis=function(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_vertical_axis(): Wrong camera object");return}if(!dest)dest=m_vec3.create();
var render=camobj.render;m_vec3.copy(render.vertical_axis,dest);return dest};exports.translate_view=function(camobj,x,y,angle){if(!m_obj_util.is_camera(camobj)){m_print.error("translate_view(): Wrong camera object");return}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];if(!cam.reflection_plane)m_cam.set_projection(cam,cam.aspect);var vec3_tmp=_vec3_tmp;vec3_tmp[0]=
-x;vec3_tmp[1]=-y;vec3_tmp[2]=0;m_mat4.translate(cam.proj_matrix,vec3_tmp,cam.proj_matrix);m_mat4.rotateZ(cam.proj_matrix,angle,cam.proj_matrix);m_cam.calc_view_proj_inverse(cam);m_cam.calc_sky_vp_inverse(cam)}};exports.get_view_vector=function(camobj,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("get_view_vector(): Wrong camera object");return null}dest=dest||new Float32Array(3);var quat=m_tsr.get_quat_view(camobj.render.world_tsr);m_util.quat_to_dir(quat,m_util.AXIS_MY,dest);return dest};
exports.get_fov=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("get_fov(): Wrong camera object");return 0}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=cam_scene_data.cameras;return m_util.deg_to_rad(cameras[0].fov)};exports.set_fov=function(camobj,fov){if(!m_obj_util.is_camera(camobj)){m_print.error("set_fov(): Wrong camera object");return}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,
active_scene);var cameras=cam_scene_data.cameras;for(var i=0;i<cameras.length;i++){var cam=cameras[i];cam.fov=m_util.rad_to_deg(fov);if(!cam.reflection_plane)m_cam.set_projection(cam,cam.aspect);m_cam.calc_view_proj_inverse(cam);m_cam.calc_sky_vp_inverse(cam)}};exports.set_hmd_fov=function(camobj,hmd_left_fov,hmd_right_fov){if(!m_obj_util.is_camera(camobj)&&!is_hmd_camera(camobj)){m_print.error("set_hmd_fov(): Wrong camera object");return}if(!hmd_left_fov||!hmd_right_fov)return;m_cam.set_hmd_fov(camobj,
hmd_left_fov,hmd_right_fov)};exports.correct_up=function(camobj,y_axis,strict){if(!m_obj_util.is_camera(camobj)){m_print.error("correct_up(): Wrong camera object");return}y_axis=y_axis||camobj.render.vertical_axis;m_cons.correct_up(camobj,y_axis,strict||false);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.set_ortho_scale=function(camobj,ortho_scale){if(!m_obj_util.is_camera(camobj)||!m_cam.is_ortho_camera(camobj)){m_print.error("set_ortho_scale(): Wrong camera object");return}var render=
camobj.render;if(m_cam.is_target_camera(camobj)){var trans=m_tsr.get_trans_view(render.world_tsr);var dir_dist=m_vec3.dist(trans,render.pivot);render.init_top=ortho_scale/2*render.init_dist/dir_dist}else if(m_cam.is_hover_camera(camobj)){var trans=m_tsr.get_trans_view(render.world_tsr);var dir_dist=m_vec3.distance(trans,render.hover_pivot);render.init_top=ortho_scale/2*render.init_dist/dir_dist}else{var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);
cam_scene_data.cameras[0].top=ortho_scale/2}m_cam.update_ortho_scale(camobj)};exports.get_ortho_scale=function(camobj){if(!m_obj_util.is_camera(camobj)||!m_cam.is_ortho_camera(camobj)){m_print.error("get_ortho_scale(): Wrong camera object");return 0}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);return cam_scene_data.cameras[0].top*2};exports.is_ortho_camera=function(camobj){if(!m_obj_util.is_camera(camobj)){m_print.error("is_ortho_camera(): Wrong camera object");
return false}return m_cam.is_ortho_camera(camobj)};exports.calc_ray=function(camobj,canvas_x,canvas_y,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("calc_ray(): Wrong camera object");return null}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cam=cam_scene_data.cameras[0];if(dest&&dest.length==3)m_print.error_once('dest parameter in the function "calc_ray" '+"should be type of parametric line.");else dest=dest||new Float32Array(6);
switch(cam.type){case m_cam.TYPE_PERSP:case m_cam.TYPE_PERSP_ASPECT:case m_cam.TYPE_STEREO_LEFT:case m_cam.TYPE_STEREO_RIGHT:var top_1m=Math.tan(cam.fov*Math.PI/360);var right_1m=top_1m*cam.aspect;var dir=_vec3_tmp;var viewport_xy=m_cont.canvas_to_viewport_coords(canvas_x,canvas_y,_vec2_tmp,cam);dir[0]=(2*viewport_xy[0]/cam.width-1)*right_1m;dir[1]=-1;dir[2]=(2*viewport_xy[1]/cam.height-1)*top_1m;m_tsr.transform_dir_vec3(dir,camobj.render.world_tsr,dir);m_vec3.normalize(dir,dir);if(dest.length==3)m_vec3.copy(dir,
dest);else{var cam_eye=m_trans.get_translation(camobj,_vec3_tmp2);m_math.set_pline_initial_point(dest,cam_eye);m_math.set_pline_directional_vec(dest,dir)}return dest;case m_cam.TYPE_ORTHO:var dir=_vec3_tmp;var viewport_xy=m_cont.canvas_to_viewport_coords(canvas_x,canvas_y,_vec2_tmp,cam);dir[0]=(2*viewport_xy[0]/cam.width-1)*cam.top*cam.aspect;dir[1]=0;dir[2]=(2*viewport_xy[1]/cam.height-1)*cam.top;m_tsr.transform_vec3(dir,camobj.render.world_tsr,dir);m_vec3.copy(dir,dest);var quat=m_tsr.get_quat_view(camobj.render.world_tsr,
_vec4_tmp);m_vec3.transformQuat(m_util.AXIS_MY,quat,dir);m_math.set_pline_directional_vec(dest,dir);return dest;default:m_print.error("calc_ray(): Non-compatible camera");return dest}};exports.project_point=function(camobj,point,dest){if(!m_obj_util.is_camera(camobj)){m_print.error("project_point(): Wrong camera object");return null}dest=dest||new Float32Array(2);return m_cam.project_point(camobj,point,dest)};exports.has_distance_limits=function(camobj){return(m_cam.is_target_camera(camobj)||m_cam.is_hover_camera(camobj))&&
camobj.render.distance_limits!==null};exports.has_vertical_rot_limits=function(camobj){return(m_cam.is_eye_camera(camobj)||m_cam.is_target_camera(camobj)||m_cam.is_hover_camera(camobj))&&camobj.render.vertical_limits!==null};exports.has_vertical_limits=function(camobj){m_print.error_deprecated("has_vertical_limits","has_vertical_rot_limits");if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)){m_print.error("has_vertical_limits(): Wrong camera object");return false}return camobj.render.vertical_limits!==
null};exports.has_horizontal_rot_limits=function(camobj){return(m_cam.is_target_camera(camobj)||m_cam.is_eye_camera(camobj))&&camobj.render.horizontal_limits!==null};exports.has_horizontal_limits=function(camobj){m_print.error_deprecated("has_horizontal_limits","has_horizontal_rot_limits");if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)){m_print.error("has_horizontal_limits(): Wrong camera object");return false}return camobj.render.horizontal_limits!==null};exports.has_vertical_trans_limits=
function(camobj){return m_cam.is_hover_camera(camobj)&&camobj.render.hover_vert_trans_limits!==null};exports.has_horizontal_trans_limits=function(camobj){return m_cam.is_hover_camera(camobj)&&camobj.render.hover_horiz_trans_limits!==null};exports.move_pivot=function(camobj,trans_h_delta,trans_v_delta){m_print.error_deprecated("move_pivot","target_pan_pivot");if(!m_cam.is_target_camera(camobj)){m_print.error("move_pivot(): wrong object");return}var render=camobj.render;if(render.use_panning){var cam_trans=
m_tsr.get_trans_view(render.world_tsr);var dist_vector=m_vec3.subtract(cam_trans,render.pivot,_vec3_tmp2);var trans_vector=_vec3_tmp;trans_vector[0]=trans_h_delta;trans_vector[1]=0;trans_vector[2]=trans_v_delta;m_vec3.scale(trans_vector,m_vec3.len(dist_vector),trans_vector);m_tsr.transform_dir_vec3(trans_vector,render.world_tsr,trans_vector);m_vec3.add(render.pivot,trans_vector,render.pivot);m_vec3.add(cam_trans,trans_vector,cam_trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}};
exports.set_velocity_params=function(camobj,velocity){m_print.error_deprecated("set_velocity_params","set_velocities");if(!m_obj_util.is_camera(camobj)){m_print.error("set_velocity_params(): Wrong camera object");return}var render=camobj.render;render.velocity_trans=m_util.clamp(velocity[0],0,Infinity);render.velocity_rot=m_util.clamp(velocity[1],0,Infinity);render.velocity_zoom=m_util.clamp(velocity[2],0,.99)};exports.get_velocity_params=function(camobj,dest){m_print.error_deprecated("get_velocity_params",
"get_velocities");if(!m_obj_util.is_camera(camobj)){m_print.error("get_velocity_params(): Wrong camera object");return null}dest=dest||new Float32Array(3);var render=camobj.render;dest[0]=render.velocity_trans;dest[1]=render.velocity_rot;dest[2]=render.velocity_zoom;return dest};exports.clear_horizontal_limits=function(camobj){m_print.error_once("camera.clear_horizontal_limits() deprecated, use "+"camera.target_set_horizontal_limits(), camera.eye_set_horizontal_limits() "+'or camera.hover_set_horiz_trans_limits() with passing null as the "limits" argument.');
if(!m_obj_util.is_camera(camobj)){m_print.error("clear_horizontal_limits(): Wrong camera object");return}if(m_cam.is_target_camera(camobj)||m_cam.is_eye_camera(camobj))camobj.render.horizontal_limits=null;else if(m_cam.is_hover_camera(camobj))camobj.render.hover_horiz_trans_limits=null};exports.clear_vertical_limits=function(camobj){m_print.error_once("camera.clear_vertical_limits() deprecated, use "+"camera.target_set_vertical_limits(), camera.eye_set_vertical_limits() "+'or camera.hover_set_vert_trans_limits() with passing null as the "limits" argument.');
if(!m_obj_util.is_camera(camobj)){m_print.error("clear_vertical_limits(): Wrong camera object");return}if(m_cam.is_target_camera(camobj)||m_cam.is_eye_camera(camobj))camobj.render.vertical_limits=null;else if(m_cam.is_hover_camera(camobj))camobj.render.hover_vert_trans_limits=null};exports.clear_hover_angle_limits=function(camobj){m_print.error_once("camera.clear_hover_angle_limits() deprecated, HOVER camera always has hover angle limits")};exports.set_look_at=function(camobj,eye,target,up){m_print.error_deprecated_arr("camera.set_look_at",
["camera.static_set_look_at","camera.eye_set_look_at"]);up=up||camobj.render.vertical_axis;m_cam.set_look_at(camobj,eye,target);m_cons.correct_up(camobj,up,true);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.rotate_eye_camera=function(camobj,phi,theta,phi_is_abs,theta_is_abs){m_print.error_deprecated_arr("camera.rotate_eye_camera",["camera.eye_rotate","camera.rotate_camera"]);if(!m_cam.is_eye_camera(camobj)){m_print.error("rotate_eye_camera(): wrong object");return}m_cam.rotate_eye_camera(camobj,
phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.rotate_target_camera=function(camobj,phi,theta,phi_is_abs,theta_is_abs){m_print.error_deprecated_arr("camera.rotate_target_camera",["camera.target_rotate","camera.rotate_camera"]);if(!m_cam.is_target_camera(camobj)){m_print.error("rotate_target_camera(): wrong object");return}m_cam.rotate_target_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};
exports.set_trans_pivot=function(camobj,trans,pivot){m_print.error_deprecated("camera.set_trans_pivot","camera.target_set_trans_pivot");if(!m_cam.is_target_camera(camobj)){m_print.error("set_trans_pivot(): Wrong object or camera move style");return}m_cam.set_trans_pivot(camobj,trans,pivot);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.zoom_object=function(camobj,obj){m_print.error_deprecated("camera.zoom_object","camera.target_zoom_object");if(!m_cam.is_target_camera(camobj)){m_print.error("zoom_object(): wrong object");
return}var calc_bs_center=false;var center=_vec3_tmp;m_trans.get_object_center(obj,calc_bs_center,center);set_pivot(camobj,center);m_trans.update_transform(camobj);var radius=m_trans.get_object_size(obj);var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var main_camera=cam_scene_data.cameras[0];var ang_radius=m_cam.get_angular_diameter(main_camera)/2;var dist_need=radius/Math.sin(ang_radius);var dist_current=m_trans.obj_point_distance(camobj,center);
m_trans.move_local(camobj,0,dist_need-dist_current,0);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.set_pivot=set_pivot;function set_pivot(camobj,coords){m_print.error_deprecated("camera.set_pivot","camera.target_set_trans_pivot");if(!m_cam.is_target_camera(camobj)){m_print.error("set_pivot(): Wrong object or camera move style");return}m_vec3.copy(coords,camobj.render.pivot);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)}exports.rotate_hover_camera=function(camobj,
phi,theta,phi_is_abs,theta_is_abs){m_print.error_deprecated("camera.rotate_hover_camera","camera.hover_rotate");if(!m_cam.is_hover_camera(camobj)){m_print.error("rotate_hover_camera(): wrong object");return}m_cam.rotate_hover_camera(camobj,phi,theta,phi_is_abs,theta_is_abs);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.get_hover_cam_pivot=function(camobj,dest){m_print.error_deprecated("camera.get_hover_cam_pivot","camera.hover_get_pivot");if(!m_cam.is_hover_camera(camobj)){m_print.error("get_hover_cam_pivot(): wrong object");
return null}if(!dest)dest=new Float32Array(3);m_vec3.copy(camobj.render.hover_pivot,dest);return dest};exports.get_eye=function(camobj,dest){m_print.error_deprecated("camera.get_eye","camera.get_translation");if(!m_obj_util.is_camera(camobj)){m_print.error("get_eye(): Wrong object");return null}return m_cam.get_eye(camobj,dest)};exports.get_pivot=function(camobj,dest){m_print.error_deprecated("camera.get_pivot","camera.target_get_pivot");if(!m_cam.is_target_camera(camobj)){m_print.error("get_pivot(): Wrong object or camera move style");
return null}if(!dest)var dest=new Float32Array(3);var render=camobj.render;m_vec3.copy(render.pivot,dest);return dest};exports.hover_cam_set_translation=function(camobj,trans){m_print.error_deprecated("camera.hover_cam_set_translation","camera.set_translation");if(!m_cam.is_hover_camera(camobj)){m_print.error("hover_cam_set_translation(): wrong object");return}var render=camobj.render;var cam_trans=m_tsr.get_trans_view(render.world_tsr);var trans_delta=m_vec3.subtract(trans,cam_trans,_vec3_tmp);m_vec3.add(trans_delta,
render.hover_pivot,render.hover_pivot);m_trans.set_translation(camobj,trans);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.set_hover_pivot=function(camobj,coords){m_print.error_deprecated("camera.set_hover_pivot","camera.hover_set_pivot_translation");if(!m_cam.is_hover_camera(camobj)){m_print.error("set_hover_pivot(): Wrong object or camera move style");return}m_cam.set_hover_pivot(camobj,coords);m_trans.update_transform(camobj);m_phy.sync_transform(camobj)};exports.get_hover_angle_limits=
function(camobj,angles){m_print.error_deprecated("camera.get_hover_angle_limits","camera.hover_get_vertical_limits");if(!m_cam.is_hover_camera(camobj)){m_print.error("get_hover_angle_limits(): wrong object");return null}angles=angles||new Float32Array(2);angles[0]=camobj.render.vertical_limits.down;angles[1]=camobj.render.vertical_limits.up;return angles};exports.get_cam_dist_limits=function(camobj,dist){m_print.error_deprecated_arr("camera.get_cam_dist_limits",["camera.hover_get_distance_limits",
"camera.target_get_distance_limits"]);if(!m_cam.is_hover_camera(camobj)&&!m_cam.is_target_camera(camobj)){m_print.error("get_cam_dist_limits(): wrong object");return null}if(camobj.render.distance_limits){dist=dist||new Float32Array(2);dist[0]=camobj.render.distance_limits.max;dist[1]=camobj.render.distance_limits.min}else return null;return dist};exports.apply_vertical_limits=function(camobj,down_value,up_value,space){m_print.error_deprecated_arr("camera.apply_vertical_limits",["camera.eye_set_vertical_limits",
"camera.target_set_vertical_limits","camera.hover_set_vert_trans_limits"]);if(m_cam.is_target_camera(camobj)){var limits=_limits_tmp;limits.down=down_value;limits.up=up_value;limits.camera_space=space==m_trans.SPACE_LOCAL;exports.target_set_vertical_limits(camobj,limits)}else if(m_cam.is_eye_camera(camobj)){var limits=_limits_tmp;limits.down=down_value;limits.up=up_value;limits.camera_space=space==m_trans.SPACE_LOCAL;exports.eye_set_vertical_limits(camobj,limits)}else if(m_cam.is_hover_camera(camobj)){var limits=
_limits_tmp;limits.min=down_value;limits.max=up_value;exports.hover_set_vert_trans_limits(camobj,limits)}else m_print.error("apply_vertical_limits(): wrong object")};exports.apply_hover_angle_limits=function(camobj,down_angle,up_angle){m_print.error_deprecated("camera.apply_hover_angle_limits","camera.hover_set_vertical_limits");var limits=_limits_tmp;limits.down=down_angle;limits.up=up_angle;exports.hover_set_vertical_limits(camobj,limits)};exports.apply_distance_limits=function(camobj,min,max){m_print.error_deprecated_arr("camera.apply_distance_limits",
["camera.target_set_distance_limits","camera.hover_set_distance_limits"]);if(m_cam.is_target_camera(camobj)){var limits=_limits_tmp;limits.min=min;limits.max=max;exports.target_set_distance_limits(camobj,limits)}else if(m_cam.is_hover_camera(camobj)){var limits=_limits_tmp;limits.min=min;limits.max=max;exports.hover_set_distance_limits(camobj,limits)}else m_print.error("apply_distance_limits(): wrong object")};exports.clear_distance_limits=function(camobj){m_print.error_deprecated("camera.clear_distance_limits",
"camera.target_set_distance_limits");exports.target_set_distance_limits(camobj,null)};exports.get_vertical_limits=function(camobj,dest){m_print.error_deprecated_arr("camera.get_vertical_limits",["camera.eye_get_vertical_limits","camera.target_get_vertical_limits","camera.hover_get_vert_trans_limits"]);if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&!m_cam.is_hover_camera(camobj)){m_print.error("get_vertical_limits(): wrong object");return null}var render=camobj.render;dest=dest||
new Float32Array(2);if(m_cam.is_eye_camera(camobj)||m_cam.is_target_camera(camobj)){if(render.vertical_limits){dest[0]=render.vertical_limits.down;dest[1]=render.vertical_limits.up;return dest}}else if(m_cam.is_hover_camera(camobj))if(render.hover_vert_trans_limits){dest[0]=render.hover_vert_trans_limits.min;dest[1]=render.hover_vert_trans_limits.max;return dest}return null};exports.apply_horizontal_limits=function(camobj,left_value,right_value,space){m_print.error_deprecated_arr("camera.apply_horizontal_limits",
["camera.eye_set_horizontal_limits","camera.target_set_horizontal_limits","camera.hover_set_horiz_trans_limits"]);if(m_cam.is_target_camera(camobj)){var limits=_limits_tmp;limits.left=left_value;limits.right=right_value;limits.camera_space=space==m_trans.SPACE_LOCAL;exports.target_set_horizontal_limits(camobj,limits)}else if(m_cam.is_eye_camera(camobj)){var limits=_limits_tmp;limits.left=left_value;limits.right=right_value;limits.camera_space=space==m_trans.SPACE_LOCAL;exports.eye_set_horizontal_limits(camobj,
limits)}else if(m_cam.is_hover_camera(camobj)){var limits=_limits_tmp;limits.min=left_value;limits.max=right_value;exports.hover_set_horiz_trans_limits(camobj,limits)}else m_print.error("apply_horizontal_limits(): wrong object")};exports.get_horizontal_limits=function(camobj,dest){m_print.error_deprecated_arr("camera.get_horizontal_limits",["camera.eye_get_horizontal_limits","camera.target_get_horizontal_limits","camera.hover_get_horiz_trans_limits"]);if(!m_cam.is_target_camera(camobj)&&!m_cam.is_eye_camera(camobj)&&
!m_cam.is_hover_camera(camobj)){m_print.error("get_horizontal_limits(): wrong object");return null}var render=camobj.render;dest=dest||new Float32Array(2);if(m_cam.is_eye_camera(camobj)||m_cam.is_target_camera(camobj)){if(render.horizontal_limits){dest[0]=render.horizontal_limits.left;dest[1]=render.horizontal_limits.right;return dest}}else if(m_cam.is_hover_camera(camobj))if(render.hover_horiz_trans_limits){dest[0]=render.hover_horiz_trans_limits.min;dest[1]=render.hover_horiz_trans_limits.max;return dest}return null};
exports.get_frustum_planes=function(camobj,planes){if(!m_obj_util.is_camera(camobj)){m_print.error("get_frustum_planes(): Wrong camera object");return null}var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var fr_planes=cam_scene_data.cameras[0].frustum_planes;m_vec4.copy(fr_planes.left,planes.left);m_vec4.copy(fr_planes.right,planes.right);m_vec4.copy(fr_planes.top,planes.top);m_vec4.copy(fr_planes.bottom,planes.bottom);m_vec4.copy(fr_planes.near,
planes.near);m_vec4.copy(fr_planes.far,planes.far);return planes}};b4w.module["config"]=function(exports,require){var m_cfg=require("__config");exports.P_LOW=m_cfg.P_LOW;exports.P_HIGH=m_cfg.P_HIGH;exports.P_ULTRA=m_cfg.P_ULTRA;exports.P_CUSTOM=m_cfg.P_CUSTOM;exports.set=m_cfg.set;exports.get=m_cfg.get;exports.reset=m_cfg.reset;exports.get_std_assets_path=m_cfg.get_std_assets_path};b4w.module["controls"]=function(exports,require){var m_ctl=require("__controls");var m_print=require("__print");exports.CT_POSITIVE=m_ctl.CT_POSITIVE;exports.CT_CONTINUOUS=m_ctl.CT_CONTINUOUS;exports.CT_TRIGGER=m_ctl.CT_TRIGGER;exports.CT_SHOT=m_ctl.CT_SHOT;exports.CT_LEVEL=m_ctl.CT_LEVEL;exports.CT_CHANGE=m_ctl.CT_CHANGE;exports.KEY_BACKSPACE=8;exports.KEY_TAB=9;exports.KEY_ENTER=13;exports.KEY_SHIFT=16;exports.KEY_CTRL=17;exports.KEY_ALT=18;exports.KEY_PAUSE=19;exports.KEY_CAPSLOCK=20;exports.KEY_ESC=
27;exports.KEY_SPACE=32;exports.KEY_LEFT=37;exports.KEY_UP=38;exports.KEY_RIGHT=39;exports.KEY_DOWN=40;exports.KEY_1=49;exports.KEY_2=50;exports.KEY_3=51;exports.KEY_4=52;exports.KEY_5=53;exports.KEY_6=54;exports.KEY_7=55;exports.KEY_8=56;exports.KEY_9=57;exports.KEY_A=65;exports.KEY_B=66;exports.KEY_C=67;exports.KEY_D=68;exports.KEY_E=69;exports.KEY_F=70;exports.KEY_G=71;exports.KEY_H=72;exports.KEY_I=73;exports.KEY_J=74;exports.KEY_K=75;exports.KEY_L=76;exports.KEY_M=77;exports.KEY_N=78;exports.KEY_O=
79;exports.KEY_P=80;exports.KEY_Q=81;exports.KEY_R=82;exports.KEY_S=83;exports.KEY_T=84;exports.KEY_U=85;exports.KEY_V=86;exports.KEY_W=87;exports.KEY_X=88;exports.KEY_Y=89;exports.KEY_Z=90;exports.KEY_NUM0=96;exports.KEY_NUM1=97;exports.KEY_NUM2=98;exports.KEY_NUM3=99;exports.KEY_NUM4=100;exports.KEY_NUM5=101;exports.KEY_NUM6=102;exports.KEY_NUM7=103;exports.KEY_NUM8=104;exports.KEY_NUM9=105;exports.KEY_DEC_POINT=110;exports.KEY_SEMI_COLON=186;exports.KEY_EQUAL_SIGN=187;exports.KEY_COMMA=188;exports.KEY_DASH=
189;exports.KEY_PERIOD=190;exports.KEY_FORWARD_SLASH=191;exports.KEY_GRAVE_ACCENT=192;exports.KEY_LEFT_SQ_BRACKET=219;exports.KEY_BACK_SLASH=220;exports.KEY_RIGHT_SQ_BRACKET=221;exports.KEY_SINGLE_QUOTE=222;exports.PL_SINGLE_TOUCH_MOVE=m_ctl.PL_SINGLE_TOUCH_MOVE;exports.PL_MULTITOUCH_MOVE_ZOOM=m_ctl.PL_MULTITOUCH_MOVE_ZOOM;exports.PL_MULTITOUCH_MOVE_PAN=m_ctl.PL_MULTITOUCH_MOVE_PAN;exports.PL_MULTITOUCH_MOVE_ROTATE=m_ctl.PL_MULTITOUCH_MOVE_ROTATE;exports.create_gamepad_btn_sensor=m_ctl.create_gamepad_btn_sensor;
exports.create_gamepad_axis_sensor=m_ctl.create_gamepad_axis_sensor;exports.create_custom_sensor=m_ctl.create_custom_sensor;exports.create_keyboard_sensor=m_ctl.create_keyboard_sensor;exports.create_collision_sensor=function(obj_src,collision_id,calc_pos_norm){collision_id=collision_id||"ANY";calc_pos_norm=calc_pos_norm||false;return m_ctl.create_collision_sensor(obj_src,collision_id,calc_pos_norm)};exports.create_collision_impulse_sensor=m_ctl.create_collision_impulse_sensor;exports.create_ray_sensor=
function(obj_src,from,to,collision_id,is_binary_value,calc_pos_norm,ign_src_rot){collision_id=collision_id||"ANY";is_binary_value=is_binary_value||false;calc_pos_norm=calc_pos_norm||false;ign_src_rot=ign_src_rot||false;return m_ctl.create_ray_sensor(obj_src,from,to,collision_id,is_binary_value,calc_pos_norm,ign_src_rot)};exports.create_mouse_click_sensor=m_ctl.create_mouse_click_sensor;exports.create_mouse_wheel_sensor=m_ctl.create_mouse_wheel_sensor;exports.create_mouse_move_sensor=m_ctl.create_mouse_move_sensor;
exports.create_touch_move_sensor=m_ctl.create_touch_move_sensor;exports.create_touch_zoom_sensor=m_ctl.create_touch_zoom_sensor;exports.create_touch_rotate_sensor=m_ctl.create_touch_rotate_sensor;exports.create_touch_click_sensor=m_ctl.create_touch_click_sensor;exports.create_motion_sensor=m_ctl.create_motion_sensor;exports.create_vertical_velocity_sensor=m_ctl.create_vertical_velocity_sensor;exports.create_gyro_angles_sensor=m_ctl.create_gyro_angles_sensor;exports.create_gyro_quat_sensor=m_ctl.create_gyro_quat_sensor;
exports.create_gyro_delta_sensor=m_ctl.create_gyro_delta_sensor;exports.create_hmd_quat_sensor=m_ctl.create_hmd_quat_sensor;exports.create_hmd_position_sensor=m_ctl.create_hmd_position_sensor;exports.create_timer_sensor=function(period,do_repeat){return m_ctl.create_timer_sensor(period,do_repeat||false)};exports.reset_timer_sensor=m_ctl.reset_timer_sensor;exports.create_elapsed_sensor=m_ctl.create_elapsed_sensor;exports.create_timeline_sensor=m_ctl.create_timeline_sensor;exports.create_selection_sensor=
function(obj,auto_release){return m_ctl.create_selection_sensor(obj,auto_release||false)};exports.create_callback_sensor=function(callback,value){return m_ctl.create_callback_sensor(callback,value||0)};exports.set_custom_sensor=function(sensor,value){m_ctl.sensor_set_value(sensor,value)};exports.get_custom_sensor=function(sensor){return sensor.value};exports.get_sensor_value=m_ctl.get_sensor_value;exports.get_sensor_payload=m_ctl.get_sensor_payload;exports.create_sensor_manifold=function(obj,id,type,
sensors,logic_fun,callback,callback_param){callback_param=callback_param===undefined?null:callback_param;var logic_fun=logic_fun||m_ctl.default_AND_logic_fun;m_ctl.create_sensor_manifold(obj,id,type,sensors,logic_fun,callback,callback_param)};exports.create_kb_sensor_manifold=function(obj,id,type,key,callback,callback_param){var kb_sensor=m_ctl.create_keyboard_sensor(key);callback_param=callback_param===undefined?null:callback_param;var logic_fun=m_ctl.default_AND_logic_fun;m_ctl.create_sensor_manifold(obj,
id,type,[kb_sensor],logic_fun,callback,callback_param)};exports.check_sensor_manifolds=function(obj){return m_ctl.check_sensor_manifold(obj,null)};exports.check_sensor_manifold=m_ctl.check_sensor_manifold;exports.remove_sensor_manifold=m_ctl.remove_sensor_manifold;exports.reset=m_ctl.reset;exports.register_keyboard_events=function(){m_print.error_once("controls.register_keyboard_events() deprecated")};exports.register_mouse_events=function(){m_print.error_once("controls.register_mouse_events() deprecated")};
exports.register_wheel_events=function(){m_print.error_once("controls.register_wheel_events() deprecated")};exports.register_touch_events=function(){m_print.error_once("controls.register_touch_events() deprecated")};exports.register_device_orientation=function(){m_print.error_once("controls.register_device_orientation() deprecated")};exports.unregister_keyboard_events=function(){m_print.error_once("controls.unregister_keyboard_events() deprecated")};exports.unregister_mouse_events=function(){m_print.error_once("controls.unregister_mouse_events() deprecated")};
exports.unregister_wheel_events=function(){m_print.error_once("controls.unregister_wheel_events() deprecated")};exports.unregister_touch_events=function(){m_print.error_once("controls.unregister_touch_events() deprecated")};exports.unregister_device_orientation=function(){m_print.error_once("controls.unregister_device_orientation() deprecated")}};b4w.module["constraints"]=function(exports,require){var m_cam=require("__camera");var m_cons=require("__constraints");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_trans=require("__transform");exports.append_stiff=function(obj,target,offset,rotation_offset,scale_offset){scale_offset=scale_offset||1;if(target instanceof Array&&target.length==2)m_cons.append_stiff_bone(obj,target[0],target[1],offset,rotation_offset,scale_offset);else m_cons.append_stiff_obj(obj,
target,offset,rotation_offset,scale_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_semi_stiff=function(obj,target,offset,rotation_offset){m_cons.append_semi_stiff_obj(obj,target,offset,rotation_offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_semi_stiff_cam=function(obj,target,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down){if(!m_cam.is_eye_camera(obj)){m_print.error("append_semi_stiff_cam(): wrong object type, only EYE"+
" camera objects can be parented.");return}clamp_left=clamp_left||-Math.PI/2;clamp_right=clamp_right||Math.PI/2;clamp_up=clamp_up||Math.PI/2;clamp_down=clamp_down||-Math.PI/2;m_cons.append_semi_stiff_cam_obj(obj,target,offset,rotation_offset,clamp_left,clamp_right,clamp_up,clamp_down);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_semi_soft_cam=function(obj,target,offset,softness){if(!m_cam.is_eye_camera(obj)){m_print.error("append_semi_soft_cam(): wrong object type, only EYE"+
" camera objects can be parented.");return}if(!softness||softness<0)softness=.25;m_cons.append_semi_soft_cam_obj(obj,target,offset,softness);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_stiff_trans=function(obj,target,offset){m_cons.append_stiff_trans_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_copy_trans=function(obj,target,offset){m_cons.append_copy_trans_obj(obj,target,offset);m_trans.update_transform(obj);m_phy.sync_transform(obj)};
exports.append_stiff_trans_rot=function(obj,target,offset,rotation_offset){m_cons.append_stiff_trans_rot_obj(obj,target,offset,rotation_offset,1);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_track=function(obj,target){if(target.length==3)m_cons.append_track_point(obj,target);else m_cons.append_track_obj(obj,target);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_follow=function(obj,target,dist_min,dist_max){if(target.length==3)m_cons.append_follow_point(obj,
target,dist_min,dist_max);else m_cons.append_follow_obj(obj,target,dist_min,dist_max);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.append_stiff_viewport=function(obj,camobj,positioning){m_cons.append_stiff_viewport(obj,camobj,positioning);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.remove=function(obj){if(obj.constraint)m_cons.remove(obj)};exports.get_parent=function(obj){m_print.error_deprecated("constraints.get_parent","objects.get_parent");return m_obj_util.get_parent(obj)}};b4w.module["container"]=function(exports,require){var m_cont=require("__container");var m_print=require("__print");exports.get_canvas=m_cont.get_canvas;exports.get_canvas_hud=m_cont.get_canvas_hud;exports.get_container=m_cont.get_container;exports.insert_to_container=function(elem,stack_order){if(arguments.length!=2){m_print.error("insert_to_container(): two arguments required");return}if(!elem||!stack_order)return;m_cont.insert_to_container(elem,stack_order)};exports.set_canvas_offsets=m_cont.set_canvas_offsets;
exports.update_canvas_offsets=m_cont.update_canvas_offsets;exports.client_to_canvas_coords=m_cont.client_to_canvas_coords;exports.force_offsets_updating=m_cont.force_offsets_updating;exports.resize=function(width,height,update_canvas_css){if(!width||!height)m_print.warn("Wrong canvas container dimensions: "+width+"x"+height+". Zero dimensions aren't allowed. Resized to: "+m_cont.DEFAULT_CANVAS_W+"x"+m_cont.DEFAULT_CANVAS_H+".");m_cont.resize(width,height,update_canvas_css)}};b4w.module["data"]=function(exports,require){var m_data=require("__data");var m_loader=require("__loader");var m_print=require("__print");exports.load=m_data.load;exports.unload=function(data_id){data_id=data_id|0;m_data.unload(data_id)};exports.set_debug_resources_root=m_data.set_debug_resources_root;exports.is_primary_loaded=m_data.is_primary_loaded;exports.is_idle=m_loader.is_finished;exports.load_and_add_new=m_data.load;exports.cleanup=exports.unload;exports.activate_media=m_data.activate_media};b4w.module["debug"]=function(exports,require){var m_cfg=require("__config");var m_ctl=require("__controls");var m_cont=require("__container");var m_debug=require("__debug");var m_ext=require("__extensions");var m_load=require("__loader");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_scgraph=require("__scenegraph");var m_sfx=require("__sfx");
var m_shaders=require("__shaders");var m_textures=require("__textures");var m_util=require("__util");var m_vec3=require("__vec3");var cfg_def=m_cfg.defaults;var PERF_NUM_CALLS=10;var EPS=1E-6;var _called_funcs=[];var _tested_func_name="";var _test_result=true;var _vec2_tmp=new Float32Array(2);exports.DV_NONE=m_debug.DV_NONE;exports.DV_OPAQUE_WIREFRAME=m_debug.DV_OPAQUE_WIREFRAME;exports.DV_TRANSPARENT_WIREFRAME=m_debug.DV_TRANSPARENT_WIREFRAME;exports.DV_FRONT_BACK_VIEW=m_debug.DV_FRONT_BACK_VIEW;
exports.DV_DEBUG_SPHERES=m_debug.DV_DEBUG_SPHERES;exports.DV_CLUSTERS_VIEW=m_debug.DV_CLUSTERS_VIEW;exports.DV_BATCHES_VIEW=m_debug.DV_BATCHES_VIEW;exports.physics_stats=function(){m_phy.debug_workers()};exports.physics_id=function(id){m_print.log("O",m_phy.find_obj_by_body_id(id));var bundles=m_phy.get_active_scene()._physics.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];var phy=bundle.physics;if(phy.body_id==id)m_print.log("B",bundle)}};exports.visible_objects=function(){var scene=
m_scenes.get_active();var objs=m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL);var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND"),m_scenes.get_subs(scene,"MAIN_GLOW")];for(var i=0;i<main_subscenes.length;i++){var subs_main=main_subscenes[i];var bundles=subs_main.bundles;if(!bundles.length)continue;m_print.group(subs_main.type,"DYNAMIC");for(var j=0;j<objs.length;j++){var obj=objs[j];var render=obj.render;if(render.type!="DYNAMIC")continue;for(var k=
0;k<bundles.length;k++){var bundle=bundles[k];if(bundle.do_render&&bundle.obj_render==render){m_print.log_raw(obj.name,obj);break}}}m_print.groupEnd();m_print.groupCollapsed(subs_main.type,"STATIC");for(var j=0;j<objs.length;j++){var obj=objs[j];var render=obj.render;if(render.type=="DYNAMIC")continue;for(var k=0;k<bundles.length;k++){var bundle=bundles[k];if(bundle.do_render&&bundle.obj_render==render){m_print.log_raw(obj.name,obj);break}}}m_print.groupEnd()}};exports.object_info=function(name){var scene=
m_scenes.get_active();var objs=m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL);for(var i=0;i<objs.length;i++){var obj=objs[i];if(obj.name!=name)continue;m_print.log("Object",obj);var subscenes=m_scenes.get_all_subscenes(scene);for(var j=0;j<subscenes.length;j++){var subs=subscenes[j];var bundles=subs.bundles;var print_bundles=[];for(var k=0;k<bundles.length;k++)if(bundles[k].obj_render==obj.render)print_bundles.push(bundles[k]);m_print.log("Subscene "+subs.type,print_bundles)}}};exports.objects_stat=
function(){var scene=m_scenes.get_active();console.log("Armatures: "+m_obj.get_scene_objs(scene,"ARMATURE",m_obj.DATA_ID_ALL).length);console.log("Cameras: "+m_obj.get_scene_objs(scene,"CAMERA",m_obj.DATA_ID_ALL).length);console.log("Curves: "+m_obj.get_scene_objs(scene,"CURVE",m_obj.DATA_ID_ALL).length);console.log("Empties: "+m_obj.get_scene_objs(scene,"EMPTY",m_obj.DATA_ID_ALL).length);console.log("Lamps: "+m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL).length);console.log("Meshes: "+m_obj.get_scene_objs(scene,
"MESH",m_obj.DATA_ID_ALL).length);console.log("Speakers: "+m_obj.get_scene_objs(scene,"SPEAKER",m_obj.DATA_ID_ALL).length)};exports.num_vertices=function(){var num=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND"),m_scenes.get_subs(scene,"MAIN_GLOW")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;
if(batch)num+=batch.num_vertices}}return num};exports.num_triangles=function(){var num=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND"),m_scenes.get_subs(scene,"MAIN_GLOW")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch)num+=batch.num_triangles}}return num};exports.num_draw_calls=function(){var scene=
m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND"),m_scenes.get_subs(scene,"MAIN_GLOW")];var number=0;for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(subs)number+=subs.bundles.length}var reflect_subs=m_scenes.subs_array(scene,["MAIN_PLANE_REFLECT","MAIN_PLANE_REFLECT_BLEND","MAIN_CUBE_REFLECT","MAIN_CUBE_REFLECT_BLEND"]);for(var i=0;i<reflect_subs.length;i++){var subs=reflect_subs[i];if(subs.type=="MAIN_PLANE_REFLECT"||
subs.type=="MAIN_PLANE_REFLECT_BLEND")number+=subs.bundles.length;else number+=6*subs.bundles.length}return number};exports.num_shaders=function(){var compiled_shaders=m_shaders.get_compiled_shaders();return m_util.get_dict_length(compiled_shaders)};exports.geometry_stats=function(){var scene=m_scenes.get_active();var subscenes=m_scenes.get_all_subscenes(scene);var unique_batches={};for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.type=="SINK"||subs.type=="DEBUG_VIEW")continue;var bundles=
subs.bundles;for(var j=0;j<bundles.length;j++){var batch=bundles[j].batch;var render=bundles[j].obj_render;if(batch)if(subs.type!="COLOR_PICKING"&&subs.type!="OUTLINE_MASK"||render.origin_selectable||render.origin_outlining)unique_batches[batch.id]=batch}}var vbo_number=0;var vbo_memory=0;var ibo_number=0;var ibo_memory=0;for(var id in unique_batches){var batch=unique_batches[id];var bufs_data=batch.bufs_data;if(bufs_data.debug_ibo_bytes){ibo_number++;ibo_memory+=bufs_data.debug_ibo_bytes/(1024*1024)}vbo_number++;
vbo_memory+=bufs_data.debug_vbo_bytes/(1024*1024)}return{"vbo_number":vbo_number,"vbo_memory":vbo_memory,"ibo_number":ibo_number,"ibo_memory":ibo_memory}};exports.num_textures=function(){var tex_list=[];var memory=0;var scene=m_scenes.get_active();var main_subscenes=[m_scenes.get_subs(scene,"MAIN_OPAQUE"),m_scenes.get_subs(scene,"MAIN_BLEND"),m_scenes.get_subs(scene,"MAIN_GLOW")];for(var i=0;i<main_subscenes.length;i++){var subs=main_subscenes[i];if(!subs)continue;var bundles=subs.bundles;for(var j=
0;j<bundles.length;j++){var batch=bundles[j].batch;if(batch){var batch_texs=batch.textures;for(var k=0;k<batch_texs.length;k++){var batch_tex=batch_texs[k];if(batch_tex.source==="IMAGE"||batch_tex.source==="ENVIRONMENT_MAP"){var tex=batch_tex.w_texture;if(tex_list.indexOf(tex)===-1){tex_list.push(tex);var mem=batch_tex.width*batch_tex.height*4/(1024*1024)/batch_tex.compress_ratio;mem*=1.3333;memory+=mem}}}}}}return{"number":tex_list.length,"memory":memory}};exports.num_render_targets=function(){var list=
[];var memory=0;var scene=m_scenes.get_active();var subscenes=m_scenes.get_all_subscenes(scene);for(var i=0;i<subscenes.length;i++){var subs=subscenes[i];if(subs.type=="SINK")continue;var cam=subs.camera;var c_at=cam.color_attachment;var d_at=cam.depth_attachment;var subs_textures=[cam.color_attachment,cam.depth_attachment];subs_textures.push.apply(subs_textures,subs.textures_internal);for(var j=0;j<subs_textures.length;j++){var tex=subs_textures[j];if(m_textures.is_texture(tex)&&list.indexOf(tex)==
-1){list.push(tex);memory+=cam.width*cam.height*m_textures.get_texture_texel_size(tex)}}}return{"number":list.length,"memory":memory/1024/1024}};exports.make_camera_frustum_shot=function(){var active_scene=m_scenes.get_active();var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");if(!subs_main)return;m_scenes.make_frustum_shot(subs_main.camera,subs_main,[1,1,0])};exports.make_light_frustum_shot=function(){var active_scene=m_scenes.get_active();var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");
var subscenes_shadow=m_scenes.subs_array(active_scene,["SHADOW_CAST"]);if(!subs_main)return;for(var i=0;i<subscenes_shadow.length;i++){var subs_shadow=subscenes_shadow[i];var color;switch(i){case 0:color=[1,0,0];break;case 1:color=[0,1,0];break;case 2:color=[0,0,1];break;default:color=[1,0,1]}m_scenes.make_frustum_shot(subs_shadow.camera,subs_main,color)}};exports.scenegraph_to_dot=function(){var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];var graph=m_scenes.get_graph(scene);
m_print.log("\n"+m_scgraph.debug_convert_to_dot(graph))}};exports.scenes_to_dot=function(){};exports.loading_graph_to_dot=function(data_id){data_id=data_id|0;m_print.log("\n"+m_load.graph_to_dot(data_id))};exports.controls_info=m_ctl.debug;exports.object_distance=function(obj,obj2){var trans=m_tsr.get_trans_view(obj.render.world_tsr);var trans2=m_tsr.get_trans_view(obj2.render.world_tsr);var dist=m_vec3.dist(trans,trans2);return dist};exports.msg=m_debug.msg;exports.fbmsg=m_debug.fbmsg;exports.print_telemetry=
m_debug.print_telemetry;exports.plot_telemetry=m_debug.plot_telemetry;exports.fbres=function(fun,timeout){if(!timeout)timeout=16;var cb=function(){m_debug.fbmsg("FBRES",fun());setTimeout(cb,timeout)};cb()};exports.assert_constants=function(){var VEC3_IDENT=new Float32Array(3);var QUAT4_IDENT=new Float32Array([0,0,0,1]);var AXIS_X=new Float32Array([1,0,0]);var AXIS_Y=new Float32Array([0,1,0]);var AXIS_Z=new Float32Array([0,0,1]);var AXIS_MX=new Float32Array([-1,0,0]);var AXIS_MY=new Float32Array([0,
-1,0]);var AXIS_MZ=new Float32Array([0,0,-1]);if(!m_util.cmp_arr(VEC3_IDENT,m_util.VEC3_IDENT))throw"Wrong VEC3_IDENT";if(!m_util.cmp_arr(QUAT4_IDENT,m_util.QUAT4_IDENT))throw"Wrong QUAT4_IDENT";if(!m_util.cmp_arr(AXIS_X,m_util.AXIS_X))throw"Wrong AXIS_X";if(!m_util.cmp_arr(AXIS_Y,m_util.AXIS_Y))throw"Wrong AXIS_Y";if(!m_util.cmp_arr(AXIS_Z,m_util.AXIS_Z))throw"Wrong AXIS_Z";if(!m_util.cmp_arr(AXIS_MX,m_util.AXIS_MX))throw"Wrong AXIS_MX";if(!m_util.cmp_arr(AXIS_MY,m_util.AXIS_MY))throw"Wrong AXIS_MY";
if(!m_util.cmp_arr(AXIS_MZ,m_util.AXIS_MZ))throw"Wrong AXIS_MZ";};exports.mute_music=function(){var spks=m_sfx.get_speaker_objects();for(var i=0;i<spks.length;i++){var spk=spks[i];if(m_sfx.get_spk_behavior(spk)=="BACKGROUND_MUSIC")m_sfx.mute(spk,true)}};exports.check_finite=function(o){m_debug.check_finite(o)};exports.set_debug_params=function(params){var active_scene=m_scenes.get_active();var subs_debug_view=m_scenes.get_subs(active_scene,"DEBUG_VIEW");if(subs_debug_view){if(typeof params.debug_view_mode==
"number")switch(params.debug_view_mode){case m_debug.DV_NONE:case m_debug.DV_OPAQUE_WIREFRAME:case m_debug.DV_TRANSPARENT_WIREFRAME:case m_debug.DV_FRONT_BACK_VIEW:case m_debug.DV_DEBUG_SPHERES:case m_debug.DV_CLUSTERS_VIEW:case m_debug.DV_BATCHES_VIEW:m_scenes.set_debug_view_mode(subs_debug_view,params.debug_view_mode);break;default:m_print.error("set_debug_params(): Wrong debug view mode");break}if(typeof params.debug_colors_seed=="number")m_scenes.set_debug_colors_seed(subs_debug_view,params.debug_colors_seed);
if(typeof params.wireframe_edge_color=="object")m_scenes.set_wireframe_edge_color(subs_debug_view,params.wireframe_edge_color)}else throw"Debug view subscene not found.";};exports.get_error_quantity=function(){return m_print.get_error_count()};exports.get_warning_quantity=function(){return m_print.get_warning_count()};exports.clear_errors_warnings=function(){return m_print.clear_errors_warnings()};exports.analyze_shaders=function(opt_shader_id_part){var compiled_shaders=m_shaders.get_compiled_shaders();
var count=0;for(var shader_id in compiled_shaders){if(opt_shader_id_part&&shader_id.indexOf(opt_shader_id_part)===-1)continue;count++}var msg="of "+count+" analyzing...";var rslts={};for(var shader_id in compiled_shaders){if(opt_shader_id_part&&shader_id.indexOf(opt_shader_id_part)===-1)continue;var cshader=compiled_shaders[shader_id];var stat=get_shaders_stat(cshader.vshader,cshader.fshader);var shaders_info=cshader.shaders_info;var title=shaders_info.vert+" + "+shaders_info.frag;stat.cshader=cshader;
stat.shaders_info=shaders_info;var stats=rslts[title]=rslts[title]||[];stats.push(stat);m_print.log(msg)}for(var title in rslts){m_print.group("%c"+title,"color: #800");var stats=rslts[title];print_shader_stats_nvidia(stats);m_print.groupEnd()}};exports.fake_load=m_debug.fake_load;function get_shaders_stat(vshader,fshader){var ext_ds=m_ext.get_debug_shaders();if(!ext_ds){m_print.error("WEBGL_debug_shaders not found"+" (run Chrome with --enable-privileged-webgl-extensions)");return}var vsrc=ext_ds.getTranslatedShaderSource(vshader);
var fsrc=ext_ds.getTranslatedShaderSource(fshader);vsrc=vsrc.replace("#version","#version 400 //");fsrc=fsrc.replace("#version","#version 400 //");var vout=post_sync("/nvidia_vert",vsrc);var vstats=parse_shader_assembly(vout);var fout=post_sync("/nvidia_frag",fsrc);var fstats=parse_shader_assembly(fout);return{vsrc:vsrc,vout:vout,vstats:vstats,fsrc:fsrc,fout:fout,fstats:fstats}}function parse_shader_assembly(data){var stats={};if(!data)return stats;var lines=data.split("\n");for(var i=0;i<lines.length;i++){var line=
lines[i];if(line.search(new RegExp(/^[A-Z.]+ /))==-1)continue;var op=line.split(" ")[0];if(!(op in stats))stats[op]=0;stats[op]++}var alu_ops=0;var tex_ops=0;for(var op in stats)switch(op){case "KIL":case "TEX":case "TXB":case "TXP":case "KIL.F":case "TEX.F":case "TXB.F":case "TXD.F":case "TXL.F":case "TXQ.F":case "TXP.F":tex_ops+=stats[op];break;default:alu_ops+=stats[op];break}stats["ALU_OPS"]=alu_ops;stats["TEX_OPS"]=tex_ops;return stats}function post_sync(path,data){var req=new XMLHttpRequest;
req.open("POST",path,false);req.send(data);if(req.status==200)return req.responseText;else throw"Error POST XHR: "+req.status;}function print_shader_stats_nvidia(stats){stats.sort(function(a,b){return b.fstats["ALU_OPS"]-a.fstats["ALU_OPS"]});for(var j=0;j<stats.length;j++){var stat=stats[j];var fstats=stat.fstats;var vstats=stat.vstats;var mat_names=find_material_names_by_comp_shader(stat.cshader);mat_names=mat_names?"\t\t("+mat_names.join(", ")+")":"\t\t(NA)";m_print.groupCollapsed("FRAG --\x3e",
"ALU",fstats["ALU_OPS"],"TEX",fstats["TEX_OPS"],"\t\tVERT --\x3e","ALU",vstats["ALU_OPS"],"TEX",vstats["TEX_OPS"],mat_names);m_print.groupCollapsed("directives");var dirs=stat.shaders_info.directives;for(var i=0;i<dirs.length;i++){var dir=dirs[i];m_print.log(dir[0],dir[1])}m_print.groupEnd();m_print.groupCollapsed("vert src");m_print.log(stat.vsrc);m_print.groupEnd();m_print.groupCollapsed("vert stats");for(var op in vstats)if(op!="ALU_OPS"&&op!="TEX_OPS")m_print.log(op,vstats[op]);m_print.groupEnd();
m_print.groupCollapsed("frag src");m_print.log(stat.fsrc);m_print.groupEnd();m_print.groupCollapsed("frag stats");for(var op in fstats)if(op!="ALU_OPS"&&op!="TEX_OPS")m_print.log(op,fstats[op]);m_print.groupEnd();m_print.groupEnd()}}function find_material_names_by_comp_shader(cshader){var scenes=m_scenes.get_all_scenes();for(var i=0;i<scenes.length;i++){var scene=scenes[i];var objects=m_obj.get_scene_objs(scene,"MESH",m_obj.DATA_ID_ALL);for(var j=0;j<objects.length;j++){var obj=objects[j];var scene_data=
m_obj_util.get_scene_data(obj,scene);if(!scene_data||!scene_data.batches.length)continue;var batches=scene_data.batches;for(var k=0;k<batches.length;k++){var batch=batches[k];if(batch.shader==cshader&&batch.material_names.length)return batch.material_names}}}return null}exports.test_performance=function(callback){var ext=m_ext.get_disjoint_timer_query();if(!ext){callback(-1);return}var graph=m_scgraph.create_performance_graph();m_scenes.generate_auxiliary_batches(graph);var subs=m_scgraph.find_subs(graph,
"PERFORMANCE");for(var i=0;i<PERF_NUM_CALLS;i++)m_render.draw(subs);window.setTimeout(function(){m_debug.process_timer_queries(subs);callback(subs.debug_render_time)},100)};function call(func,name){var decor_func=function(){_called_funcs.push(decor_func);_tested_func_name=name;return func.apply(func,arguments)};return decor_func}exports.start_debug=function(module_name){_called_funcs=[];_test_result=true;var module=require(module_name);for(var name in module)if(typeof module[name]==="function")module[name]=
call(module[name],name)};exports.check_debug_result=function(){return _test_result};exports.test=function(test_name,callback){try{callback();return true}catch(e){_test_result=false;console.error(test_name+" test was failed. ",e);return false}};exports.pix=function(ref_color){var canvas_w=m_cont.get_viewport_width();var canvas_h=m_cont.get_viewport_height();var canvas_x=canvas_w/2;var canvas_y=canvas_h/2;m_cont.resize(canvas_w,canvas_h,false);var scene=m_scenes.get_active();var graph=scene._render.graph;
var subs=m_scgraph.find_on_screen(graph);if(!subs)m_util.panic("Couldn't find onscreen subscene");var cam=subs.camera;var viewport_xy=m_cont.canvas_to_viewport_coords(canvas_x,canvas_y,_vec2_tmp,subs.camera);viewport_xy[1]=cam.height-viewport_xy[1];var color=m_render.read_pixels(cam.framebuffer,viewport_xy[0],viewport_xy[1]);eqv(ref_color,color)};exports.eqs=function(result,exp_result){if(JSON.stringify(result)!=JSON.stringify(exp_result))throw"Wrong result. Function: "+_tested_func_name;};exports.eqv=
eqv;function eqv(result,exp_result,eps){if(typeof exp_result!=typeof result)throw"Wrong expected data type.";if(result.length!=exp_result.length)throw"Wrong expected vector length.";var eps=eps?eps:EPS;for(var i=0;i<result.length;i++)if(exp_result[i]>result[i]+eps||exp_result[i]<result[i]-eps)throw"Wrong result.";}exports.eqf=function(result,exp_result,eps){if(typeof exp_result!="number")throw"Wrong expected data type.";var eps=eps?eps:EPS;if(exp_result>result+eps||exp_result<result-eps)throw"Wrong result.";
};exports.eq=function(result,exp_result){if(result!==exp_result)throw"Wrong result.";};exports.stat=function(module_name){var module=require(module_name);for(var name in module)if(_called_funcs.indexOf(module[name])==-1)console.warn(name+" function wasn't called.")};exports.ok=function(exp){if(!Boolean(exp))throw"Wrong result. Function: "+_tested_func_name;}};b4w.module["geometry"]=function(exports,require){var m_batch=require("__batch");var m_geom=require("__geometry");var m_print=require("__print");var m_render=require("__renderer");exports.extract_vertex_array=function(obj,mat_name,attrib_name){if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return null}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers&&bufs_data.pointers[attrib_name])return m_geom.extract_array(bufs_data,
attrib_name);else{m_print.error("Attribute not found:"+attrib_name);return null}}else{m_print.error("Wrong material:",mat_name);return null}};exports.extract_index_array=function(obj,mat_name){if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return null}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers)return bufs_data.ibo_array;else{m_print.error("Buffer data not found");return null}}else{m_print.error("Wrong material:",
mat_name);return null}};exports.update_vertex_array=function(obj,mat_name,attrib_name,array){var types=["MAIN","SHADOW","COLOR_ID"];if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return}for(var i=0;i<types.length;i++){var type=types[i];var batch=m_batch.find_batch_material(obj,mat_name,type);if(batch){var bufs_data=batch.bufs_data;if(bufs_data&&bufs_data.pointers&&bufs_data.pointers[attrib_name])m_geom.update_bufs_data_array(bufs_data,attrib_name,0,array)}}};exports.override_geometry=
function(obj,mat_name,ibo_array,positions_array,smooth_normals){var types=["MAIN","SHADOW","COLOR_ID"];if(!m_geom.has_dyn_geom(obj)){m_print.error("Wrong object:",obj.name);return}if(!(ibo_array instanceof Uint16Array)&&!(ibo_array instanceof Uint32Array)){m_print.error("Wrong ibo_array type");return}if(!(positions_array instanceof Float32Array)){m_print.error("Wrong positions_array type");return}for(var i=0;i<types.length;i++){var type=types[i];var batch=m_batch.find_batch_material(obj,mat_name,
type);if(batch){var bufs_data=batch.bufs_data;if(bufs_data){m_geom.update_bufs_data_index_array(bufs_data,batch.draw_mode,ibo_array);var new_vbo_size=0;for(var attr in bufs_data.pointers){var pointer=bufs_data.pointers[attr];new_vbo_size+=positions_array.length/3*pointer.num_comp}bufs_data.vbo_array=new Float32Array(new_vbo_size);var vbo_array=bufs_data.vbo_array;var offset=0;for(var attr in bufs_data.pointers){var pointer=bufs_data.pointers[attr];switch(attr){case "a_position":vbo_array.set(positions_array,
offset);pointer.offset=offset;pointer.length=positions_array.length;offset+=pointer.length;break;case "a_normal":var shared_indices;if(smooth_normals)shared_indices=m_geom.calc_shared_indices(ibo_array,positions_array,positions_array);var normals=m_geom.calc_normals(ibo_array,positions_array,shared_indices);vbo_array.set(normals,offset);pointer.offset=offset;pointer.length=positions_array.length;offset+=pointer.length;break;case "a_tangent":pointer.offset=offset;pointer.length=positions_array.length/
3*pointer.num_comp;var new_tangent_array=new Float32Array(pointer.length);for(var j=0;j<new_tangent_array.length;j+=4){new_tangent_array[j]=1;new_tangent_array[j+3]=1}vbo_array.set(new_tangent_array,offset);offset+=pointer.length;break;default:pointer.offset=offset;pointer.length=positions_array.length/3*pointer.num_comp;var new_array=new Float32Array(pointer.length);vbo_array.set(new_array,offset);offset+=pointer.length;break}}m_geom.update_gl_buffers(bufs_data);m_render.assign_attribute_setters(batch);
var child_batch=m_batch.find_batch_material_forked(obj,batch);if(child_batch&&child_batch.bufs_data)child_batch.bufs_data=bufs_data}}}};exports.set_shape_key_value=function(obj,key_name,value){if(!m_geom.check_shape_keys(obj)){m_print.error("Wrong object:",obj.name);return}if(!m_geom.has_shape_key(obj,key_name)){m_print.error("Wrong key name:",key_name);return}var float_value=parseFloat(value);m_geom.apply_shape_key(obj,key_name,float_value)};exports.check_shape_keys=function(obj){return m_geom.check_shape_keys(obj)};
exports.get_shape_keys_names=function(obj){if(!m_geom.check_shape_keys(obj)){m_print.error("Wrong object:",obj.name);return null}return m_geom.get_shape_keys_names(obj)};exports.get_shape_key_value=function(obj,key_name){if(!m_geom.check_shape_keys(obj)){m_print.error("Wrong object:",obj.name);return null}if(!m_geom.has_shape_key(obj,key_name)){m_print.error("Wrong key name:",key_name);return null}return m_geom.get_shape_key_value(obj,key_name)};exports.draw_line=function(obj,positions,is_split){is_split=
is_split||false;if(!(positions instanceof Float32Array)){m_print.error("Wrong positions type");return}var batch=m_batch.get_first_batch(obj);if(batch){m_geom.draw_line(batch,positions,is_split);m_render.assign_attribute_setters(batch)}}};b4w.module["hud"]=function(exports,require){var m_hud=require("__hud");var m_print=require("__print");exports.draw_mixer_strip=m_hud.draw_mixer_strip;exports.plot_array=m_hud.plot_array};b4w.module["input"]=function(exports,require){var m_input=require("__input");var m_cam=require("__camera");var m_cont=require("__container");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scs=require("__scenes");var m_vec4=require("__vec4");var _vec4_tmp=m_vec4.create();var _vec4_tmp2=m_vec4.create();var _splited_screen=false;exports.GMPD_BUTTON_12=m_input.GMPD_BUTTON_12;exports.GMPD_BUTTON_13=m_input.GMPD_BUTTON_13;exports.GMPD_BUTTON_15=m_input.GMPD_BUTTON_15;exports.GMPD_BUTTON_14=
m_input.GMPD_BUTTON_14;exports.GMPD_BUTTON_3=m_input.GMPD_BUTTON_3;exports.GMPD_BUTTON_0=m_input.GMPD_BUTTON_0;exports.GMPD_BUTTON_1=m_input.GMPD_BUTTON_1;exports.GMPD_BUTTON_2=m_input.GMPD_BUTTON_2;exports.GMPD_BUTTON_5=m_input.GMPD_BUTTON_5;exports.GMPD_BUTTON_7=m_input.GMPD_BUTTON_7;exports.GMPD_BUTTON_4=m_input.GMPD_BUTTON_4;exports.GMPD_BUTTON_6=m_input.GMPD_BUTTON_6;exports.GMPD_BUTTON_8=m_input.GMPD_BUTTON_8;exports.GMPD_BUTTON_9=m_input.GMPD_BUTTON_9;exports.GMPD_BUTTON_10=m_input.GMPD_BUTTON_10;
exports.GMPD_BUTTON_11=m_input.GMPD_BUTTON_11;exports.GMPD_BUTTON_16=m_input.GMPD_BUTTON_16;exports.GMPD_BUTTON_17=m_input.GMPD_BUTTON_17;exports.GMPD_BUTTON_18=m_input.GMPD_BUTTON_18;exports.GMPD_BUTTON_19=m_input.GMPD_BUTTON_19;exports.GMPD_BUTTON_20=m_input.GMPD_BUTTON_20;exports.GMPD_BUTTON_21=m_input.GMPD_BUTTON_21;exports.GMPD_BUTTON_22=m_input.GMPD_BUTTON_22;exports.GMPD_BUTTON_23=m_input.GMPD_BUTTON_23;exports.GMPD_BUTTON_24=m_input.GMPD_BUTTON_24;exports.GMPD_BUTTON_25=m_input.GMPD_BUTTON_25;
exports.GMPD_AXIS_0=m_input.GMPD_AXIS_0;exports.GMPD_AXIS_1=m_input.GMPD_AXIS_1;exports.GMPD_AXIS_2=m_input.GMPD_AXIS_2;exports.GMPD_AXIS_3=m_input.GMPD_AXIS_3;exports.GMPD_AXIS_4=m_input.GMPD_AXIS_4;exports.GMPD_AXIS_5=m_input.GMPD_AXIS_5;exports.GMPD_AXIS_6=m_input.GMPD_AXIS_6;exports.GMPD_AXIS_7=m_input.GMPD_AXIS_7;exports.GMPD_AXIS_8=m_input.GMPD_AXIS_8;exports.GMPD_AXIS_9=m_input.GMPD_AXIS_9;exports.GMPD_AXIS_10=m_input.GMPD_AXIS_10;exports.GMPD_AXIS_11=m_input.GMPD_AXIS_11;exports.HMD_ORIENTATION_QUAT=
m_input.HMD_ORIENTATION_QUAT;exports.HMD_POSITION=m_input.HMD_POSITION;exports.HMD_WEBVR_TYPE=m_input.HMD_WEBVR_TYPE;exports.HMD_WEBVR_DESKTOP=m_input.HMD_WEBVR_DESKTOP;exports.HMD_WEBVR_MOBILE=m_input.HMD_WEBVR_MOBILE;exports.HMD_NON_WEBVR=m_input.HMD_NON_WEBVR;var HMD_EYE_DISTANCE=m_input.HMD_EYE_DISTANCE;exports.HMD_EYE_DISTANCE=HMD_EYE_DISTANCE;exports.HMD_DISTORTION=m_input.HMD_DISTORTION;exports.HMD_BASELINE_DIST=m_input.HMD_BASELINE_DIST;exports.HMD_SCREEN_LENSE_DIST=m_input.HMD_SCREEN_LENSE_DIST;
exports.HMD_SCREEN_WIDTH=m_input.HMD_SCREEN_WIDTH;exports.HMD_SCREEN_HEIGHT=m_input.HMD_SCREEN_HEIGHT;exports.HMD_BEVEL_SIZE=m_input.HMD_BEVEL_SIZE;exports.MOUSE_LOCATION=m_input.MOUSE_LOCATION;exports.MOUSE_DOWN_WHICH=m_input.MOUSE_DOWN_WHICH;exports.MOUSE_UP_WHICH=m_input.MOUSE_UP_WHICH;exports.MOUSE_WHEEL=m_input.MOUSE_WHEEL;exports.KEYBOARD_UP=m_input.KEYBOARD_UP;exports.KEYBOARD_DOWN=m_input.KEYBOARD_DOWN;exports.TOUCH_START=m_input.TOUCH_START;exports.TOUCH_MOVE=m_input.TOUCH_MOVE;exports.TOUCH_END=
m_input.TOUCH_END;exports.GYRO_ORIENTATION_QUAT=m_input.GYRO_ORIENTATION_QUAT;exports.GYRO_ORIENTATION_ANGLES=m_input.GYRO_ORIENTATION_ANGLES;var SYNC_VECTOR_PARAMS={};SYNC_VECTOR_PARAMS[m_input.DEVICE_HMD]=[m_input.HMD_ORIENTATION_QUAT,m_input.HMD_POSITION];SYNC_VECTOR_PARAMS[m_input.DEVICE_MOUSE]=[m_input.MOUSE_LOCATION];var SYNC_VALUE_PARAMS={};SYNC_VALUE_PARAMS[m_input.DEVICE_HMD]=[m_input.HMD_WEBVR_TYPE];var ASYNC_PARAMS={};ASYNC_PARAMS[m_input.DEVICE_MOUSE]=[m_input.MOUSE_LOCATION,m_input.MOUSE_DOWN_WHICH,
m_input.MOUSE_UP_WHICH,m_input.MOUSE_WHEEL];ASYNC_PARAMS[m_input.DEVICE_KEYBOARD]=[m_input.KEYBOARD_UP,m_input.KEYBOARD_DOWN];ASYNC_PARAMS[m_input.DEVICE_TOUCH]=[m_input.TOUCH_START,m_input.TOUCH_MOVE,m_input.TOUCH_END];ASYNC_PARAMS[m_input.DEVICE_GYRO]=[m_input.GYRO_ORIENTATION_QUAT,m_input.GYRO_ORIENTATION_ANGLES];var CONF={};CONF[m_input.DEVICE_HMD]=[m_input.HMD_DISTORTION,m_input.HMD_EYE_DISTANCE,m_input.HMD_BASELINE_DIST,m_input.HMD_SCREEN_LENSE_DIST,m_input.HMD_SCREEN_WIDTH,m_input.HMD_SCREEN_HEIGHT,
m_input.HMD_BEVEL_SIZE];exports.DEVICE_GYRO=m_input.DEVICE_GYRO;exports.DEVICE_HMD=m_input.DEVICE_HMD;exports.DEVICE_MOUSE=m_input.DEVICE_MOUSE;exports.DEVICE_KEYBOARD=m_input.DEVICE_KEYBOARD;exports.DEVICE_TOUCH=m_input.DEVICE_TOUCH;exports.can_use_device=m_input.can_use_device;exports.get_device_by_type_element=m_input.get_device_by_type_element;exports.switch_prevent_default=function(device,prevent_default){if(device)m_input.switch_prevent_default(device,prevent_default)};exports.register_device=
function(){m_print.error_once("input.register_device() deprecated")};exports.reset_device=function(device){if(!device||device.type!=m_input.DEVICE_HMD){m_print.error("reset_device is undefined for device.");return}m_input.reset_device(device)};exports.get_vector_param=function(device,param,dest){if(device&&device.type in SYNC_VECTOR_PARAMS&&SYNC_VECTOR_PARAMS[device.type].indexOf(param)>=0)return m_input.get_vector_param(device,param,dest);else m_print.error("device hasn't param: ",param)};exports.get_value_param=
function(device,param){if(device&&device.type in SYNC_VALUE_PARAMS&&SYNC_VALUE_PARAMS[device.type].indexOf(param)>=0)return m_input.get_value_param(device,param);else m_print.error("device hasn't param: ",param)};exports.attach_param_cb=function(device,param,cb){if(device&&device.type in ASYNC_PARAMS&&ASYNC_PARAMS[device.type].indexOf(param)>=0)return m_input.attach_param_cb(device,param,cb);else m_print.error("device hasn't param: ",param)};exports.detach_param_cb=function(device,param,cb){if(device&&
device.type in ASYNC_PARAMS&&ASYNC_PARAMS[device.type].indexOf(param)>=0)return m_input.detach_param_cb(device,param,cb);else m_print.error("device hasn't param: ",param)};exports.set_config=function(device,config,value){if(device&&device.type in CONF&&CONF[device.type].indexOf(config)>=0)return m_input.set_config(device,config,value);else m_print.error("device hasn't config: ",config)};exports.enable_split_screen=function(camobj){var hmd_device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);
if(!hmd_device||!hmd_device.registered)return false;var hmd_left_fov=m_input.get_vector_param(hmd_device,m_input.HMD_FOV_LEFT,_vec4_tmp);var hmd_right_fov=m_input.get_vector_param(hmd_device,m_input.HMD_FOV_RIGHT,_vec4_tmp2);if(hmd_left_fov&&hmd_left_fov)m_cam.set_hmd_fov(camobj,hmd_left_fov,hmd_right_fov);var eye_distance=m_input.get_value_param(hmd_device,HMD_EYE_DISTANCE);if(eye_distance){var active_scene=m_scs.get_active();var cam_scene_data=m_obj_util.get_scene_data(camobj,active_scene);var cameras=
cam_scene_data.cameras;m_cam.set_eye_distance(cameras,eye_distance)}var hmd_params={};hmd_params.distortion_coefs=[hmd_device.distortion_coefs[0],hmd_device.distortion_coefs[1]];hmd_params.chromatic_aberration_coefs=[hmd_device.chromatic_aberration_coefs[0],hmd_device.chromatic_aberration_coefs[1],hmd_device.chromatic_aberration_coefs[2],hmd_device.chromatic_aberration_coefs[3]];hmd_params.enable_hmd_stereo=true;hmd_params.base_line_factor=.5;if(!hmd_device.webvr_hmd_device)if(hmd_device.base_line_dist&&
hmd_device.height_dist&&hmd_device.bevel_size)hmd_params.base_line_factor=(hmd_device.base_line_dist-hmd_device.bevel_size)/hmd_device.height_dist;else if(!hmd_device.bevel_size)hmd_params.base_line_factor=hmd_device.base_line_dist/hmd_device.height_dist;hmd_params.inter_lens_factor=.5;if(hmd_device.inter_lens_dist&&hmd_device.width_dist&&!hmd_device.webvr_hmd_device)hmd_params.inter_lens_factor=hmd_device.inter_lens_dist/hmd_device.width_dist;m_scs.set_hmd_params(hmd_params);var distortion_scale=
1+hmd_device.distortion_coefs[0]+hmd_device.distortion_coefs[1];m_scs.multiply_size_mult(distortion_scale,distortion_scale);var canvas_container_elem=m_cont.get_container();var ccw=canvas_container_elem.clientWidth;var cch=canvas_container_elem.clientHeight;m_cont.resize(ccw,cch,true);m_input.reset_device(hmd_device);_splited_screen=true;return true};exports.disable_split_screen=function(){var hmd_device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(!_splited_screen&&(!hmd_device||!hmd_device.registered))return false;
var hmd_params={};hmd_params.enable_hmd_stereo=false;m_scs.set_hmd_params(hmd_params);var distortion_scale=1/(1+hmd_device.distortion_coefs[0]+hmd_device.distortion_coefs[1]);m_scs.multiply_size_mult(distortion_scale,distortion_scale);var canvas_container_elem=m_cont.get_container();var ccw=canvas_container_elem.clientWidth;var cch=canvas_container_elem.clientHeight;m_cont.resize(ccw,cch,true);return true};exports.set_gamepad_key=function(gamepad_id,btn,key){var gmps_num=check_enable_gamepad_indices().length;
switch(gamepad_id){case 0:var type=m_input.DEVICE_GAMEPAD0;break;case 1:var type=m_input.DEVICE_GAMEPAD1;break;case 2:var type=m_input.DEVICE_GAMEPAD2;break;case 3:var type=m_input.DEVICE_GAMEPAD3;break;default:var type=m_input.DEVICE_GAMEPAD0}var device=m_input.get_device_by_type_element(type);m_input.set_config(device,btn,key)};exports.get_pressed_gmpd_btn=m_input.get_pressed_gmpd_btn;exports.get_moved_gmpd_axis=m_input.get_moved_gmpd_axis;exports.check_enable_gamepad_indices=check_enable_gamepad_indices;
function check_enable_gamepad_indices(){var gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];var indices=[];for(var i=0;i<gamepads.length;i++)if(gamepads[i])indices.push(i);return indices}};b4w.module["lights"]=function(exports,require){var m_lights=require("__lights");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scenes=require("__scenes");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var m_vec3=require("__vec3");var _sun_pos=new Float32Array(3);var _date={};var _julian_date=0;var _max_sun_angle=60;exports.get_lamps=function(lamps_type){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,
"LAMP",m_obj.DATA_ID_ALL);if(!lamps_type)return lamps;var rslt=[];for(var i=0;i<lamps.length;i++){var lamp=lamps[i];if(lamp.light.type===lamps_type)rslt.push(lamp)}return rslt};exports.get_sun_params=get_sun_params;function get_sun_params(){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);var sun=null;for(var i=0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp.light;if(light.type=="SUN"){sun=lamp;break}}if(sun){var cur_dir=sun.light.direction;var angle_hor=
m_util.rad_to_deg(Math.atan2(cur_dir[2],cur_dir[0]))+90;if(angle_hor>180)angle_hor-=360;var angle_vert=m_util.rad_to_deg(Math.atan2(cur_dir[1],Math.sqrt(cur_dir[0]*cur_dir[0]+cur_dir[2]*cur_dir[2])));var sun_params={};sun_params.hor_position=angle_hor;sun_params.vert_position=angle_vert;return sun_params}else return null}exports.set_sun_params=set_sun_params;function set_sun_params(sun_params){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);for(var i=
0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp.light;if(light.type=="SUN"){var sun=lamp;break}}if(!sun){m_print.error("There is no sun on the scene");return}if(typeof sun_params.hor_position=="number"&&typeof sun_params.vert_position=="number"){var angle_hor=m_util.deg_to_rad(180-sun_params.hor_position);var angle_vert=m_util.deg_to_rad(90-sun_params.vert_position);var sun_render=sun.render;m_trans.set_rotation_euler(sun,[angle_vert,angle_hor,0]);var dir=new Float32Array(3);var sun_quat=m_tsr.get_quat_view(sun_render.world_tsr);
m_util.quat_to_dir(sun_quat,m_util.AXIS_Y,dir);var trans=m_tsr.get_trans_view(sun_render.world_tsr);var dist_to_center=m_vec3.length(trans);m_vec3.copy(dir,_sun_pos);m_vec3.scale(_sun_pos,dist_to_center,_sun_pos);m_trans.set_translation(sun,_sun_pos);m_trans.update_transform(sun);var sun_light=sun.light;if(sun_light.dynamic_intensity){var def_env_color=scene["world"]["light_settings"]["environment_energy"];var def_horizon_color=scene["world"]["horizon_color"];var def_zenith_color=scene["world"]["zenith_color"];
var energy=Math.cos(Math.abs(angle_vert));var sun_energy=Math.max(Math.min(3*energy,1),0)*sun_light.default_energy;var env_energy=Math.max(energy,.1)*def_env_color;m_lights.set_light_energy(sun_light,sun_energy);m_scenes.set_environment_colors(scene,env_energy,def_horizon_color,def_zenith_color)}m_scenes.update_lamp_scene(sun,scene)}}exports.set_day_time=set_day_time;function set_day_time(time){var scene=m_scenes.get_active();var lamps=m_obj.get_scene_objs(scene,"LAMP",m_obj.DATA_ID_ALL);for(var i=
0;i<lamps.length;i++){var lamp=lamps[i];var light=lamp.light;if(light.type=="SUN"){var sun=lamp;break}}if(!sun){m_print.error("There is no sun on the scene");return}update_sun_position(time)}exports.set_date=function(date){_date.y=date.getDate();_date.m=date.getMonth();_date.d=date.getFullYear();if(!_date.y){m_print.error("There is no year 0 in the Julian system!");return}if(_date.y==1582&&date.m==10&&date.d>4&&date.d<15){m_print.error("The dates 5 through 14 October, 1582, do not exist in the Gregorian system!");
return}_julian_date=calendar_to_julian(_date)};exports.set_max_sun_angle=function(angle){_max_sun_angle=Math.min(Math.max(angle,0),90)};exports.get_light_params=function(lamp_obj){if(m_obj_util.is_lamp(lamp_obj))var light=lamp_obj.light;else{m_print.error("get_light_params(): Wrong object");return null}var type=get_light_type(lamp_obj);if(type)switch(type){case "SPOT":var rslt={"light_type":type,"light_color":light.color,"light_energy":light.energy,"light_spot_blend":light.spot_blend,"light_spot_size":light.spot_size,
"light_distance":light.distance};break;case "POINT":var rslt={"light_type":type,"light_color":light.color,"light_energy":light.energy,"light_distance":light.distance};break;default:var rslt={"light_type":type,"light_color":light.color,"light_energy":light.energy};break}if(rslt)return rslt;else return null};exports.get_light_type=get_light_type;function get_light_type(lamp_obj){if(m_obj_util.is_lamp(lamp_obj))return lamp_obj.light.type;else m_print.error("get_light_type(): Wrong object");return false}
exports.set_light_params=function(lamp_obj,light_params){if(m_obj_util.is_lamp(lamp_obj))var light=lamp_obj.light;else{m_print.error("set_light_params(): Wrong object");return}var scene=m_scenes.get_active();if(typeof light_params.light_energy=="number")m_lights.set_light_energy(light,light_params.light_energy);if(typeof light_params.light_color=="object")m_lights.set_light_color(light,light_params.light_color);if(typeof light_params.light_spot_blend=="number")m_lights.set_light_spot_blend(light,
light_params.light_spot_blend);if(typeof light_params.light_spot_size=="number")m_lights.set_light_spot_size(light,light_params.light_spot_size);if(typeof light_params.light_distance=="number")m_lights.set_light_distance(light,light_params.light_distance);m_scenes.update_lamp_scene(lamp_obj,scene);m_obj.update_all_mesh_shaders(scene)};function update_sun_position(time){var day=_date.d;var month=_date.m;var year=_date.y;var angle_hor=time<12?time*15:(time-24)*15;var angle_vert=-Math.cos(time/12*Math.PI)*
_max_sun_angle;var sun_params={};sun_params.hor_position=angle_hor;sun_params.vert_position=angle_vert;set_sun_params(sun_params)}function get_sun_coordinates(jul_date,days){var n=jul_date-2451545;var l=280.46+.9856474*n;l=l%360;var g=357.528+.9856003*n;g=g%360;g=m_util.deg_to_rad(g);var e_longitude=l+1.915*Math.sin(g)+.02*Math.sin(2*g);var r=1.00014-.01671*Math.cos(g)-1.4E-4*Math.cos(2*g);var oblique=23.439-4E-7*n;return oblique}function calendar_to_julian(date){var y=date.y;var m=date.m;var d=date.d;
var jy,ja,jm;if(m>2){jy=y;jm=m+1}else{jy=y-1;jm=m+13}var intgr=Math.floor(Math.floor(365.25*jy)+Math.floor(30.6001*jm)+d+1720995);var gregcal=15+31*(10+12*1582);if(d+31*(m+12*y)>=gregcal){ja=Math.floor(.01*jy);intgr+=2-ja+Math.floor(.25*ja)}var jd0=intgr*1E5;var jd=Math.floor(jd0);if(jd0-jd>.5)++jd;return jd/1E5}};b4w.module["logic_nodes"]=function(exports,require){var m_logn=require("__logic_nodes");exports.append_custom_callback=function(cb_id,cb){m_logn.append_custom_cb(cb_id,cb)};exports.remove_custom_callback=function(cb_id){m_logn.remove_custom_cb(cb_id)};exports.run_entrypoint=function(scene_name,ep_name){m_logn.run_ep(scene_name,ep_name)}};b4w.module["material"]=function(exports,require){var m_batch=require("__batch");var m_cfg=require("__config");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_shaders=require("__shaders");var m_util=require("__util");var cfg_def=m_cfg.defaults;exports.inherit_material=function(obj_from,mat_from_name,obj_to,mat_to_name){if(!m_obj_util.is_dynamic_mesh(obj_to)||!m_obj_util.is_dynamic_mesh(obj_from)){m_print.error("Wrong or batched object(s)");return}m_batch.inherit_material(obj_from,
mat_from_name,obj_to,mat_to_name)};function check_batch_material(obj,mat_name){var scenes_data=obj.scenes_data;var batches=scenes_data[0].batches;for(var i=0;i<batches.length;i++){var batch=batches[i];if(batch.material_names.indexOf(mat_name)>-1)return batch.type=="MAIN"}return false}exports.get_materials_names=function(obj){var mat_names=new Array;var scenes_data=obj.scenes_data;for(var i=0;i<scenes_data.length;i++){var batches=scenes_data[i].batches;for(var j=0;j<batches.length;j++)for(var k=0;k<
batches[j].material_names.length;k++)if(mat_names.indexOf(batches[j].material_names[k])==-1)mat_names.push(batches[j].material_names[k])}return mat_names};exports.set_diffuse_color=function(obj,mat_name,color){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.diffuse_color.set(color);var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.diffuse_color.set(color)}else m_print.error('Couldn\'t set property "diffuse_color"!')};
exports.get_diffuse_color=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var color=new Float32Array(4);color.set(batch.diffuse_color);return color}else m_print.error('Couldn\'t get property "diffuse_color"!')};exports.set_diffuse_intensity=function(obj,mat_name,intensity){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.diffuse_intensity=intensity;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.diffuse_intensity=
intensity}else m_print.error('Couldn\'t set property "diffuse_color"!')};exports.get_diffuse_intensity=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.diffuse_intensity;else m_print.error('Couldn\'t get property "diffuse_intensity"!')};exports.set_specular_color=function(obj,mat_name,color){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.specular_color.set(color);var reflect_batch=m_batch.find_batch_material_forked(obj,
mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_color.set(color)}else m_print.error('Couldn\'t set property "specular_color"!')};exports.get_specular_color=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){var color=new Array(3);color[0]=batch.specular_color[0];color[1]=batch.specular_color[1];color[2]=batch.specular_color[2];return color}else m_print.error('Couldn\'t get property "specular_color"!')};exports.set_specular_color_factor=function(obj,
mat_name,factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.specular_color_factor=factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_color_factor=factor}else m_print.error('Couldn\'t set property "specular_color_factor"!')};exports.get_specular_color_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.specular_color_factor;else m_print.error('Couldn\'t get property "specular_color_factor"!')};
exports.set_specular_intensity=function(obj,mat_name,intensity){if(!check_specular_intensity(obj,mat_name))m_print.error('Property "specular_intensity" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");batch.specular_params[0]=intensity;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_params[0]=intensity};exports.get_specular_intensity=function(obj,mat_name){if(!check_specular_intensity(obj,mat_name))m_print.error('Property "specular_intensity" is missing!');
var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.specular_params[0]};exports.check_specular_intensity=check_specular_intensity;function check_specular_intensity(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.specular_params[0])}exports.set_specular_hardness=function(obj,mat_name,hardness){if(!check_specular_hardness(obj,mat_name))m_print.error('Property "specular_hardness" is missing!');var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");batch.specular_params[1]=hardness;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.specular_params[1]=hardness};exports.get_specular_hardness=function(obj,mat_name){if(!check_specular_hardness(obj,mat_name))m_print.error('Property "specular_hardness" is missing!');var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return batch.specular_params[1]};exports.check_specular_hardness=check_specular_hardness;function check_specular_hardness(obj,
mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");return Boolean(batch&&batch.specular_params[1])}exports.set_emit_factor=function(obj,mat_name,emit_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.emit=emit_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.emit=emit_factor}else m_print.error('Couldn\'t set property "emit_factor"!')};exports.get_emit_factor=function(obj,mat_name){var batch=
m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.emit;else m_print.error('Couldn\'t get property "emit_factor"!')};exports.set_ambient_factor=function(obj,mat_name,ambient_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.ambient=ambient_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.ambient=ambient_factor}else m_print.error('Couldn\'t set property "ambient_factor"!')};exports.get_ambient_factor=
function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.ambient;else m_print.error('Couldn\'t get property "ambient_factor"!')};exports.set_diffuse_color_factor=function(obj,mat_name,diffuse_color_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.diffuse_color_factor=diffuse_color_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.diffuse_color_factor=diffuse_color_factor}else m_print.error('Couldn\'t set property "diffuse_color_factor"!')};
exports.get_diffuse_color_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.diffuse_color_factor;else m_print.error('Couldn\'t get property "diffuse_color_factor"!')};exports.set_alpha_factor=function(obj,mat_name,alpha_factor){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch){batch.alpha_factor=alpha_factor;var reflect_batch=m_batch.find_batch_material_forked(obj,mat_name,"MAIN");if(reflect_batch)reflect_batch.alpha_factor=
alpha_factor}else m_print.error('Couldn\'t set property "alpha_factor"!')};exports.get_alpha_factor=function(obj,mat_name){var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(batch)return batch.alpha_factor;else m_print.error('Couldn\'t get property "alpha_factor"!')};exports.get_material_extended_params=function(obj,mat_name){if(!obj||!mat_name){m_print.error("missing arguments in get_material_params");return null}if(!check_batch_material(obj,mat_name))return null;var batch=m_batch.find_batch_material(obj,
mat_name,"MAIN");if(!batch)return null;var mat_params={};if(batch.type=="MAIN"){mat_params.reflect_factor=batch.reflect_factor;mat_params.fresnel=batch.fresnel_params[2];mat_params.fresnel_factor=5*(1-batch.fresnel_params[3]);mat_params.parallax_scale=batch.parallax_scale;mat_params.parallax_steps=m_batch.get_batch_directive(batch,"PARALLAX_STEPS")[1]}return mat_params};exports.get_water_material_params=function(obj,water_mat_name){if(!obj||!water_mat_name){m_print.error("missing arguments in get_water_material_params");
return null}if(!check_batch_material(obj,water_mat_name))return null;var batch=m_batch.find_batch_material(obj,water_mat_name,"MAIN");if(!batch||!batch.water)return null;if(!batch){m_print.error("material not found");return null}var water_mat_params={};if(batch.type=="MAIN"){if(cfg_def.shore_distance){var shlwc=water_mat_params.shallow_water_col=new Array(3);shlwc[0]=batch.shallow_water_col[0];shlwc[1]=batch.shallow_water_col[1];shlwc[2]=batch.shallow_water_col[2];var shrwc=water_mat_params.shore_water_col=
new Array(3);shrwc[0]=batch.shore_water_col[0];shrwc[1]=batch.shore_water_col[1];shrwc[2]=batch.shore_water_col[2];water_mat_params.shallow_water_col_fac=batch.shallow_water_col_fac;water_mat_params.shore_water_col_fac=batch.shore_water_col_fac}water_mat_params.foam_factor=batch.foam_factor;water_mat_params.norm_uv_velocity=batch.water_norm_uv_velocity;water_mat_params.absorb_factor=m_batch.get_batch_directive(batch,"ABSORB")[1];water_mat_params.sss_strength=m_batch.get_batch_directive(batch,"SSS_STRENGTH")[1];
water_mat_params.sss_width=m_batch.get_batch_directive(batch,"SSS_WIDTH")[1];water_mat_params.dst_noise_scale0=m_batch.get_batch_directive(batch,"DST_NOISE_SCALE_0")[1];water_mat_params.dst_noise_scale1=m_batch.get_batch_directive(batch,"DST_NOISE_SCALE_1")[1];water_mat_params.dst_noise_freq0=m_batch.get_batch_directive(batch,"DST_NOISE_FREQ_0")[1];water_mat_params.dst_noise_freq1=m_batch.get_batch_directive(batch,"DST_NOISE_FREQ_1")[1];water_mat_params.dir_min_shore_fac=m_batch.get_batch_directive(batch,
"DIR_MIN_SHR_FAC")[1];water_mat_params.dir_freq=m_batch.get_batch_directive(batch,"DIR_FREQ")[1];water_mat_params.dir_noise_scale=m_batch.get_batch_directive(batch,"DIR_NOISE_SCALE")[1];water_mat_params.dir_noise_freq=m_batch.get_batch_directive(batch,"DIR_NOISE_FREQ")[1];water_mat_params.dir_min_noise_fac=m_batch.get_batch_directive(batch,"DIR_MIN_NOISE_FAC")[1];water_mat_params.dst_min_fac=m_batch.get_batch_directive(batch,"DST_MIN_FAC")[1];water_mat_params.waves_hor_fac=m_batch.get_batch_directive(batch,
"WAVES_HOR_FAC")[1]}return water_mat_params};exports.set_material_extended_params=function(obj,mat_name,mat_params){if(!obj||!mat_name||!mat_params){m_print.error("missing arguments in set_material_params");return}if(!check_batch_material(obj,mat_name)){m_print.error("setting material params is not possible");return}var batch=m_batch.find_batch_material(obj,mat_name,"MAIN");if(!batch){m_print.error("material not found");return}var batches=[batch];var reflect_batch=m_batch.find_batch_material_forked(obj,
mat_name,"MAIN");if(reflect_batch)batches.push(reflect_batch);for(var i=0;i<batches.length;i++){var batch=batches[i];if(typeof mat_params.material_reflectivity=="number"){var refl=mat_params.material_reflectivity;batch.reflect_factor=refl}if(typeof mat_params.material_fresnel=="number"){var fresnel=mat_params.material_fresnel;batch.fresnel_params[2]=fresnel}if(typeof mat_params.material_fresnel_factor=="number"){var fresnel_factor=1-mat_params.material_fresnel_factor/5;batch.fresnel_params[3]=fresnel_factor}if(typeof mat_params.material_parallax_scale==
"number"){var parallax_scale=mat_params.material_parallax_scale;batch.parallax_scale=parallax_scale}if(typeof mat_params.material_parallax_steps=="number"){var parallax_steps=m_shaders.glsl_value(parseFloat(mat_params.material_parallax_steps));m_batch.set_batch_directive(batch,"PARALLAX_STEPS",parallax_steps);m_batch.update_shader(batch,true)}}};exports.set_water_material_params=function(obj,water_mat_name,water_mat_params){if(!obj||!water_mat_name||!water_mat_params){m_print.error("missing arguments in set_water_material_params");
return}if(!check_batch_material(obj,water_mat_name)){m_print.error("setting water material params is not possible");return}var batch=m_batch.find_batch_material(obj,water_mat_name,"MAIN");if(!batch){m_print.error("material not found");return}var batches=[batch];var reflect_batch=m_batch.find_batch_material_forked(obj,water_mat_name,"MAIN");if(reflect_batch)batches.push(reflect_batch);for(var i=0;i<batches.length;i++){var batch=batches[i];if(cfg_def.shore_distance){if(typeof water_mat_params.shallow_water_col==
"object")batch.shallow_water_col.set(water_mat_params.shallow_water_col);if(typeof water_mat_params.shallow_water_col_fac=="number")batch.shallow_water_col_fac=water_mat_params.shallow_water_col_fac;if(typeof water_mat_params.shore_water_col=="object")batch.shore_water_col.set(water_mat_params.shore_water_col);if(typeof water_mat_params.shore_water_col_fac=="number")batch.shore_water_col_fac=water_mat_params.shore_water_col_fac}if(cfg_def.shore_smoothing&&batch.water_shore_smoothing){if(typeof water_mat_params.shore_smoothing==
"boolean")if(water_mat_params.shore_smoothing)m_batch.set_batch_directive(batch,"SHORE_SMOOTHING",1);else m_batch.set_batch_directive(batch,"SHORE_SMOOTHING",0);if(typeof water_mat_params.absorb_factor=="number"){var absorb_factor=m_shaders.glsl_value(parseFloat(water_mat_params.absorb_factor));m_batch.set_batch_directive(batch,"ABSORB",absorb_factor)}}if(typeof water_mat_params.foam_factor=="number"&&cfg_def.foam)batch.foam_factor=water_mat_params.foam_factor;if(typeof water_mat_params.norm_uv_velocity==
"number")batch.water_norm_uv_velocity=water_mat_params.norm_uv_velocity;if(cfg_def.water_dynamic&&batch.water_dynamic){if(typeof water_mat_params.water_dynamic=="boolean")if(water_mat_params.water_dynamic)m_batch.set_batch_directive(batch,"DYNAMIC",1);else m_batch.set_batch_directive(batch,"DYNAMIC",0);if(typeof water_mat_params.waves_height=="number"){var waves_height=m_shaders.glsl_value(parseFloat(water_mat_params.waves_height));m_batch.set_batch_directive(batch,"WAVES_HEIGHT",waves_height)}if(typeof water_mat_params.waves_length==
"number"){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params.waves_length));m_batch.set_batch_directive(batch,"WAVES_LENGTH",waves_length)}if(typeof water_mat_params.sss_strength=="number"){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params.sss_strength));m_batch.set_batch_directive(batch,"SSS_STRENGTH",waves_length)}if(typeof water_mat_params.sss_width=="number"){var waves_length=m_shaders.glsl_value(parseFloat(water_mat_params.sss_width));m_batch.set_batch_directive(batch,
"SSS_WIDTH",waves_length)}if(typeof water_mat_params.dst_noise_scale0=="number"){var dst_noise_scale0=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_scale0));m_batch.set_batch_directive(batch,"DST_NOISE_SCALE_0",dst_noise_scale0)}if(typeof water_mat_params.dst_noise_scale1=="number"){var dst_noise_scale1=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_scale1));m_batch.set_batch_directive(batch,"DST_NOISE_SCALE_1",dst_noise_scale1)}if(typeof water_mat_params.dst_noise_freq0==
"number"){var dst_noise_freq0=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_freq0));m_batch.set_batch_directive(batch,"DST_NOISE_FREQ_0",dst_noise_freq0)}if(typeof water_mat_params.dst_noise_freq1=="number"){var dst_noise_freq1=m_shaders.glsl_value(parseFloat(water_mat_params.dst_noise_freq1));m_batch.set_batch_directive(batch,"DST_NOISE_FREQ_1",dst_noise_freq1)}if(typeof water_mat_params.dir_min_shore_fac=="number"){var dir_min_shore_fac=m_shaders.glsl_value(parseFloat(water_mat_params.dir_min_shore_fac));
m_batch.set_batch_directive(batch,"DIR_MIN_SHR_FAC",dir_min_shore_fac)}if(typeof water_mat_params.dir_freq=="number"){var dir_freq=m_shaders.glsl_value(parseFloat(water_mat_params.dir_freq));m_batch.set_batch_directive(batch,"DIR_FREQ",dir_freq)}if(typeof water_mat_params.dir_noise_scale=="number"){var dir_noise_scale=m_shaders.glsl_value(parseFloat(water_mat_params.dir_noise_scale));m_batch.set_batch_directive(batch,"DIR_NOISE_SCALE",dir_noise_scale)}if(typeof water_mat_params.dir_noise_freq=="number"){var dir_noise_freq=
m_shaders.glsl_value(parseFloat(water_mat_params.dir_noise_freq));m_batch.set_batch_directive(batch,"DIR_NOISE_FREQ",dir_noise_freq)}if(typeof water_mat_params.dir_min_noise_fac=="number"){var dir_min_noise_fac=m_shaders.glsl_value(parseFloat(water_mat_params.dir_min_noise_fac));m_batch.set_batch_directive(batch,"DIR_MIN_NOISE_FAC",dir_min_noise_fac)}if(typeof water_mat_params.dst_min_fac=="number"){var dst_min_fac=m_shaders.glsl_value(parseFloat(water_mat_params.dst_min_fac));m_batch.set_batch_directive(batch,
"DST_MIN_FAC",dst_min_fac)}if(typeof water_mat_params.waves_hor_fac=="number"){var waves_hor_fac=m_shaders.glsl_value(parseFloat(water_mat_params.waves_hor_fac));m_batch.set_batch_directive(batch,"WAVES_HOR_FAC",waves_hor_fac)}}m_batch.update_shader(batch,true)}};exports.set_line_params=function(obj,line_params){var batch=m_batch.get_first_batch(obj);if(batch){if(m_util.isdef(line_params.color))batch.diffuse_color.set(line_params.color);if(m_util.isdef(line_params.width))batch.line_width=line_params.width}else m_print.error("Couldn't set line params!")};
exports.get_line_params=function(obj){var batch=m_batch.get_first_batch(obj);if(batch){var line_params={color:new Float32Array(batch.diffuse_color),width:batch.line_width};return line_params}else{m_print.error("Couldn't get line params");return null}}};b4w.module["math"]=function(exports,require){var m_vec3=require("__vec3");var m_util=require("__util");var m_math=require("__math");var _vec3_tmp=new Float32Array(3);exports.create_pline_from_points=function(point1,point2){var dest=new Float32Array(6);m_math.set_pline_point(dest,point1);m_vec3.subtract(point2,point1,_vec3_tmp);m_math.set_pline_directional_vec(dest,_vec3_tmp);return dest};exports.create_pline_from_point_vec=function(point,vec){var dest=new Float32Array(6);m_math.set_pline_point(dest,
point);m_math.set_pline_directional_vec(dest,vec);return dest};exports.create_pline=function(){return new Float32Array(6)};exports.get_pline_directional_vec=m_math.get_pline_directional_vec;exports.get_pline_initial_point=m_math.get_pline_initial_point;exports.set_pline_initial_point=m_math.set_pline_initial_point;exports.set_pline_directional_vec=m_math.set_pline_directional_vec;exports.line_plane_intersect=m_util.line_plane_intersect;exports.calc_pline_point=m_math.calc_pline_point;exports.point_plane_dist=
m_math.point_plane_dist};b4w.module["particles"]=function(exports,require){var m_particles=require("__particles");var m_print=require("__print");exports.set_size=function(obj,psys_name,size){if(!m_particles.obj_has_particles(obj)){m_print.error('"',obj.name,'" has no particle systems');return}m_particles.set_size(obj,psys_name,size)};exports.set_normal_factor=function(obj,psys_name,nfactor){if(!m_particles.obj_has_particles(obj)){m_print.error('"',obj.name,'" has no particle systems');return}m_particles.set_normal_factor(obj,
psys_name,nfactor)};exports.set_factor=function(obj,psys_name,factor){if(!m_particles.obj_has_particles(obj)){m_print.error('"',obj.name,'" has no particle systems');return}factor=Math.min(factor,1);factor=Math.max(factor,0);m_particles.set_factor(obj,psys_name,factor)}};b4w.module["physics"]=function(exports,require){var m_cfg=require("__config");var m_ipc=require("__ipc");var m_phy=require("__physics");var m_print=require("__print");var m_util=require("__util");var cfg_phy=m_cfg.physics;exports.CM_WALK=0;exports.CM_RUN=1;exports.CM_CLIMB=2;exports.CM_FLY=3;exports.enable_simulation=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.enable_simulation(obj)};exports.disable_simulation=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.disable_simulation(obj)};exports.has_physics=function(obj){return m_phy.obj_has_physics(obj)};exports.has_simulated_physics=function(obj){return m_phy.has_simulated_physics(obj)};exports.has_dynamic_physics=function(obj){return m_phy.has_dynamic_physics(obj)};exports.set_gravity=function(obj,gravity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_gravity(obj,gravity)};exports.set_damping=function(obj,damping,rotation_damping){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}var body_id=obj.physics.body_id;m_phy.post_msg("set_damping",body_id,damping,rotation_damping)};exports.reset_damping=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}var phy_set=obj.physics_settings;var damping=phy_set.damping;var rdamping=phy_set.rotation_damping;var body_id=obj.physics.body_id;m_phy.post_msg("set_damping",body_id,damping,rdamping)};exports.set_transform=function(obj,trans,quat){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_transform(obj,trans,quat)};exports.sync_transform=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.sync_transform(obj)};exports.apply_velocity=function(obj,vx_local,vy_local,vz_local){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_velocity(obj,vx_local,vy_local,vz_local)};exports.apply_velocity_world=function(obj,vx,vy,vz){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.apply_velocity_world(obj,vx,vy,vz)};exports.apply_force=function(obj,fx_local,fy_local,fz_local){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_force(obj,fx_local,fy_local,fz_local,false)};exports.apply_force_world=function(obj,fx_world,fy_world,fz_world){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_force(obj,fx_world,fy_world,fz_world,true)};exports.apply_torque=function(obj,
tx_local,ty_local,tz_local){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_torque(obj,tx_local,ty_local,tz_local)};exports.vehicle_throttle=function(obj,engine_force){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");m_phy.vehicle_throttle(obj,m_util.clamp(engine_force,-1,1))};exports.vehicle_throttle_inc=function(obj,
engine_force_inc,dir){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");engine_force_inc=m_util.clamp(engine_force_inc,0,1);var vehicle=obj.vehicle;var force=vehicle.engine_force;if(dir==-1||dir==1){force+=dir*engine_force_inc;force=Math.max(-1,Math.min(force,1))}else if(dir==0&&force>=0){force-=engine_force_inc;force=Math.max(0,force)}else if(dir==0&&force<0){force+=
engine_force_inc;force=Math.min(0,force)}else m_print.error("Wrong steering direction");m_phy.vehicle_throttle(obj,m_util.clamp(force,-1,1))};exports.vehicle_steer=function(obj,steering_value){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");m_phy.vehicle_steer(obj,m_util.clamp(steering_value,-1,1))};exports.vehicle_steer_inc=function(obj,steering_value_inc,dir){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");steering_value_inc=m_util.clamp(steering_value_inc,0,1);var vehicle=obj.vehicle;var steering=vehicle.steering;if(dir==-1||dir==1){steering+=dir*steering_value_inc;steering=Math.max(-1,Math.min(steering,1))}else if(dir==0&&steering>=0){steering-=steering_value_inc;steering=Math.max(0,steering)}else if(dir==0&&steering<0){steering+=steering_value_inc;steering=Math.min(0,steering)}else m_print.error("Wrong steering direction");
m_phy.vehicle_steer(obj,m_util.clamp(steering,-1,1))};exports.vehicle_brake=function(obj,brake_force){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");m_phy.vehicle_brake(obj,m_util.clamp(brake_force,0,1))};exports.vehicle_brake_inc=function(obj,brake_force_inc){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}if(!m_phy.is_vehicle_chassis(obj)&&
!m_phy.is_vehicle_hull(obj))m_print.error("Wrong object");brake_force_inc=m_util.clamp(brake_force_inc,-1,1);var vehicle=obj.vehicle;var brake_force=vehicle.brake_force;brake_force+=brake_force*brake_force_inc;m_phy.vehicle_brake(obj,m_util.clamp(brake_force,0,1))};exports.is_vehicle_chassis=function(obj){return m_phy.is_vehicle_chassis(obj)};exports.is_vehicle_hull=function(obj){return m_phy.is_vehicle_hull(obj)};exports.get_vehicle_name=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle_settings.name;else{m_print.error("Wrong object");return null}};exports.get_vehicle_throttle=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle.engine_force;else{m_print.error("Wrong object");return null}};exports.get_vehicle_steering=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle.steering;else m_print.error("Wrong object")};exports.get_vehicle_brake=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return obj.vehicle.brake_force;else m_print.error("Wrong object")};exports.get_vehicle_speed=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return null}if(m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj))return m_phy.get_vehicle_speed(obj);else m_print.error("Wrong object")};exports.is_character=function(obj){return m_phy.is_character(obj)};exports.set_character_move_dir=function(obj,forw,side){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_move_dir(obj,forw,side)};exports.set_character_move_type=function(obj,type){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_character_move_type(obj,type)};exports.set_character_walk_velocity=function(obj,velocity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_walk_velocity(obj,velocity)};exports.set_character_run_velocity=function(obj,velocity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_run_velocity(obj,velocity)};exports.set_character_fly_velocity=function(obj,velocity){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_character_fly_velocity(obj,velocity)};exports.character_jump=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.character_jump(obj)};exports.character_rotation_inc=function(obj,h_angle,v_angle){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.character_rotation_inc(obj,h_angle,v_angle)};exports.set_character_rotation=function(obj,angle_h,angle_v){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+
obj.name);return}m_phy.set_character_rotation(obj,angle_h,angle_v)};exports.set_character_rotation_v=function(obj,angle){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_rotation_v(obj,angle)};exports.set_character_rotation_h=function(obj,angle){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.set_character_rotation_h(obj,angle)};exports.append_collision_test=function(obj_src,collision_id,callback,
calc_pos_norm){if(!m_phy.obj_has_physics(obj_src)){m_print.error("No physics for object "+obj_src.name);return}calc_pos_norm=calc_pos_norm||false;m_phy.append_collision_test(obj_src,collision_id,callback,calc_pos_norm)};exports.remove_collision_test=function(obj,collision_id,callback){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}var collision_id=collision_id||"ANY";m_phy.remove_collision_test(obj,collision_id,callback)};exports.apply_collision_impulse_test=
function(obj,callback){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.apply_collision_impulse_test(obj,callback)};exports.clear_collision_impulse_test=function(obj){if(!m_phy.obj_has_physics(obj)){m_print.error("No physics for object "+obj.name);return}m_phy.clear_collision_impulse_test(obj)};exports.append_ray_test=function(obj_src,from,to,collision_id,callback,autoremove){obj_src=obj_src||null;if(obj_src!=null&&!m_phy.obj_has_physics(obj_src)){m_print.error("No physics for object "+
obj_src.name);return}autoremove=autoremove||false;var calc_all_hits=false;var calc_pos_norm=false;var ign_src_rot=false;return m_phy.append_ray_test(obj_src,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot)};exports.append_ray_test_ext=function(obj_src,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot){obj_src=obj_src||null;if(obj_src!=null&&!m_phy.obj_has_physics(obj_src)){m_print.error("No physics for object "+obj_src.name);return}autoremove=
autoremove||false;calc_all_hits=calc_all_hits||false;calc_pos_norm=calc_pos_norm||false;ign_src_rot=ign_src_rot||false;return m_phy.append_ray_test(obj_src,from,to,collision_id,callback,autoremove,calc_all_hits,calc_pos_norm,ign_src_rot)};exports.remove_ray_test=function(id){if(!m_phy.is_ray_test(id)){m_print.error("Wrong ray test ID");return}m_phy.remove_ray_test(id)};exports.change_ray_test_from_to=function(id,from,to){if(!m_phy.is_ray_test(id)){m_print.error("Wrong ray test ID");return}m_phy.change_ray_test_from_to(id,
from,to)};exports.apply_constraint=function(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping){if(!m_phy.obj_has_physics(obj_a)||!m_phy.obj_has_physics(obj_b)){m_print.error("Wrong objects");return}m_phy.apply_constraint(pivot_type,obj_a,trans_a,quat_a,obj_b,trans_b,quat_b,limits,stiffness,damping)};exports.clear_constraint=function(obj_a){if(!m_phy.obj_has_physics(obj_a)||!m_phy.has_constraint(obj_a)){m_print.error("Wrong object");return}m_phy.clear_constraint(obj_a)};
exports.pull_to_constraint_pivot=function(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b){if(!m_phy.obj_has_physics(obj_a)||!m_phy.obj_has_physics(obj_b)){m_print.error("Wrong objects");return}m_phy.pull_to_constraint_pivot(obj_a,trans_a,quat_a,obj_b,trans_b,quat_b)};exports.get_worker_listeners=m_ipc.get_worker_listeners};b4w.module["rgb"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var _rgb_tmp=new Float32Array(3);exports.create=function(){var dest=new Float32Array(3);return dest};exports.from_values=function(r,g,b){var dest=new Float32Array(3);dest[0]=r;dest[1]=g;dest[2]=b;return dest};exports.set=function(r,g,b,dest){dest[0]=r;dest[1]=g;dest[2]=b;return dest};exports.css_to_rgb=function(css_red,css_green,css_blue,dest){dest=dest||new Float32Array(3);dest[0]=css_red/255;
dest[1]=css_green/255;dest[2]=css_blue/255;m_util.srgb_to_lin(dest,dest);return dest};exports.rgb_to_css=function(rgb){var srgb=m_util.lin_to_srgb(rgb,_rgb_tmp);return[Math.round(255*srgb[0]),Math.round(255*srgb[1]),Math.round(255*srgb[2])]};exports.rgb_to_css_hex=function(rgb){var col_to_hex=function(num){var s=Math.round(255*num).toString(16);return s.length==1?"0"+s:s};var srgb=m_util.lin_to_srgb(rgb,_rgb_tmp);return"#"+col_to_hex(srgb[0])+col_to_hex(srgb[1])+col_to_hex(srgb[2])}};
b4w.module["rgba"]=function(exports,require){var m_print=require("__print");var m_util=require("__util");var _rgb_tmp=new Float32Array(3);exports.create=function(){var dest=new Float32Array(4);dest[3]=1;return dest};exports.from_values=function(r,g,b,a){var dest=new Float32Array(4);dest[0]=r;dest[1]=g;dest[2]=b;dest[3]=a;return dest};exports.set=function(r,g,b,a,dest){dest[0]=r;dest[1]=g;dest[2]=b;dest[3]=a;return dest};exports.css_to_rgba=function(css_red,css_green,css_blue,css_alpha,dest){dest=
dest||new Float32Array(4);dest[0]=css_red/255;dest[1]=css_green/255;dest[2]=css_blue/255;dest[3]=css_alpha;m_util.srgb_to_lin(dest,dest);return dest};exports.rgba_to_css=function(rgba){var srgb=m_util.lin_to_srgb(rgba,_rgb_tmp);return[Math.round(255*srgb[0]),Math.round(255*srgb[1]),Math.round(255*srgb[2]),rgba[3]]}};b4w.module["scenes"]=function(exports,require){var m_batch=require("__batch");var m_cam=require("__camera");var m_data=require("__data");var m_graph=require("__graph");var m_obj=require("__objects");var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_scenes=require("__scenes");var m_util=require("__util");exports.DATA_ID_ALL=m_obj.DATA_ID_ALL;exports.set_active=function(scene_name){var scenes=m_scenes.get_all_scenes();m_scenes.set_active(m_util.keysearch("name",
scene_name,scenes))};exports.get_active=function(){if(!m_scenes.check_active())return"";else return m_scenes.get_active()["name"]};exports.get_scenes=function(){var scenes=m_scenes.get_all_scenes();var scene_names=[];for(var i=0;i<scenes.length;i++)scene_names.push(scenes[i]["name"]);return scene_names};exports.get_active_camera=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}else return m_scenes.get_camera(m_scenes.get_active())};exports.get_object_by_name=function(name,
data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_NAME,name,data_id|0);if(obj)return obj;else m_print.error("get object "+name+": not found")};exports.get_object_by_dupli_name=function(empty_name,dupli_name,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME,empty_name,dupli_name,data_id|0);if(obj)return obj;else m_print.error("get object "+dupli_name+": not found")};exports.get_object_by_dupli_name_list=function(name_list,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,
name_list,data_id|0);if(obj)return obj;else m_print.error("get object "+name_list+": not found")};exports.get_world_by_name=function(name,data_id){var wrd=m_obj.get_world_by_name(name,data_id|0);if(wrd)return wrd;else m_print.error("get object "+name+": not found")};exports.get_object_data_id=function(obj){return m_scenes.get_object_data_id(obj)};exports.pick_object=m_obj.pick_object;exports.outlining_is_enabled=function(obj){return obj&&obj.render&&obj.render.outlining};exports.set_outline_intensity=
function(obj,value){if(obj&&obj.render&&obj.render.outlining)m_obj.set_outline_intensity(obj,value);else m_print.error("set_outline_intensity(): wrong object")};exports.get_outline_intensity=function(obj){if(obj&&obj.render&&obj.render.outlining)return obj.render.outline_intensity;else m_print.error("get_outline_intensity(): wrong object")};exports.apply_outline_anim=function(obj,tau,T,N){if(obj&&obj.render&&obj.render.outlining)m_obj.apply_outline_anim(obj,tau,T,N);else m_print.error("apply_outline_anim(): wrong object")};
exports.apply_outline_anim_def=function(obj){if(obj&&obj.render&&obj.render.outlining){var oa_set=obj.render.outline_anim_settings_default;m_obj.apply_outline_anim(obj,oa_set.outline_duration,oa_set.outline_period,oa_set.outline_relapses)}else m_print.error("apply_outline_anim_def(): wrong object")};exports.clear_outline_anim=function(obj){if(obj&&obj.render&&obj.render.outlining)m_obj.clear_outline_anim(obj);else m_print.error("clear_outline_anim(): wrong object")};exports.set_outline_color=m_scenes.set_outline_color;
exports.get_outline_color=function(dest){var scene=m_scenes.get_active();var subs=m_scenes.get_subs(scene,"OUTLINE");if(subs){dest=dest||new Float32Array(3);dest.set(subs.outline_color);return dest}};exports.set_hmd_params=function(hmd_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}if(!hmd_params)return;if(hmd_params.distortion_coefs&&!(hmd_params.distortion_coefs instanceof Array))hmd_params.distortion_coefs=null;if(hmd_params.chromatic_aberration_coefs&&!(hmd_params.chromatic_aberration_coefs instanceof
Array))hmd_params.chromatic_aberration_coefs=null;if(typeof hmd_params.base_line_factor!="number")hmd_params.base_line_factor=null;if(typeof hmd_params.inter_lens_factor!="number")hmd_params.inter_lens_factor=null;if(typeof hmd_params.enable_hmd_stereo!="boolean")hmd_params.enable_hmd_stereo=null;m_scenes.set_hmd_params(hmd_params)};exports.get_shadow_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var shadow_cast=
m_scenes.get_subs(active_scene,"SHADOW_CAST");if(!shadow_cast)return null;var shs=active_scene._render.shadow_params;var subs_main=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");var subs_shadow_receive=m_scenes.get_subs(active_scene,"SHADOW_RECEIVE");var shadow_params={};shadow_params.csm_resolution=shs.csm_resolution;shadow_params.self_shadow_polygon_offset=shadow_cast.self_shadow_polygon_offset;if(subs_shadow_receive)shadow_params.self_shadow_normal_offset=subs_shadow_receive.self_shadow_normal_offset;
shadow_params.enable_csm=shs.enable_csm;shadow_params.csm_num=shs.csm_num;shadow_params.csm_first_cascade_border=shs.csm_first_cascade_border;shadow_params.first_cascade_blur_radius=shs.first_cascade_blur_radius;shadow_params.csm_last_cascade_border=shs.csm_last_cascade_border;shadow_params.last_cascade_blur_radius=shs.last_cascade_blur_radius;shadow_params.fade_last_cascade=shs.fade_last_cascade;shadow_params.blend_between_cascades=shs.blend_between_cascades;if(shs.enable_csm){shadow_params.csm_borders=
m_scenes.get_csm_borders(active_scene,subs_main.camera);shadow_params.blur_radii=new Float32Array(shs.csm_num);shadow_params.blur_radii.set(subs_main.camera.pcf_blur_radii.subarray(0,shs.csm_num))}else{shadow_params.csm_borders=null;shadow_params.blur_radii=null}return shadow_params};exports.set_shadow_params=function(shadow_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();if(typeof shadow_params.self_shadow_polygon_offset=="number")m_graph.traverse(active_scene._render.graph,
function(node,attr){if(attr.type==="SHADOW_CAST")attr.self_shadow_polygon_offset=shadow_params.self_shadow_polygon_offset});var subs_shadow_receive=m_scenes.get_subs(active_scene,"SHADOW_RECEIVE");if(subs_shadow_receive){if(typeof shadow_params.self_shadow_normal_offset=="number")subs_shadow_receive.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;if(typeof shadow_params.pcf_blur_radius=="number")subs_shadow_receive.pcf_blur_radius=shadow_params.pcf_blur_radius}var subs_main_blend=
m_scenes.get_subs(active_scene,"MAIN_BLEND");if(subs_main_blend){if(typeof shadow_params.self_shadow_normal_offset=="number")subs_main_blend.self_shadow_normal_offset=shadow_params.self_shadow_normal_offset;if(typeof shadow_params.pcf_blur_radius=="number")subs_main_blend.pcf_blur_radius=shadow_params.pcf_blur_radius;subs_main_blend.need_perm_uniforms_update=true}var shs=active_scene._render.shadow_params;if(typeof shadow_params.csm_first_cascade_border=="number")shs.csm_first_cascade_border=shadow_params.csm_first_cascade_border;
if(typeof shadow_params.first_cascade_blur_radius=="number")shs.first_cascade_blur_radius=shadow_params.first_cascade_blur_radius;if(typeof shadow_params.csm_last_cascade_border=="number")shs.csm_last_cascade_border=shadow_params.csm_last_cascade_border;if(typeof shadow_params.last_cascade_blur_radius=="number")shs.last_cascade_blur_radius=shadow_params.last_cascade_blur_radius;if(subs_shadow_receive){var bundles=subs_shadow_receive.bundles;for(var i=0;i<bundles.length;i++){var bundle=bundles[i];
if(!bundle.obj_render.shadow_receive)continue;var batch=bundle.batch;m_batch.assign_shadow_receive_dirs(batch,shs);m_batch.update_shader(batch)}subs_shadow_receive.need_perm_uniforms_update=true}var cam_scene_data=m_obj_util.get_scene_data(active_scene._camera,active_scene);var upd_cameras=cam_scene_data.cameras;for(var i=0;i<upd_cameras.length;i++)m_cam.update_camera_shadows(upd_cameras[i],shs);m_scenes.schedule_shadow_update(active_scene)};exports.get_environment_colors=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}var active_scene=m_scenes.get_active();return m_scenes.get_environment_colors(active_scene)};exports.set_environment_colors=function(opt_environment_energy,opt_horizon_color,opt_zenith_color){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"MAIN_OPAQUE");var energy=opt_environment_energy||opt_environment_energy==0?parseFloat(opt_environment_energy):subs.environment_energy;var horizon_color=
opt_horizon_color||opt_horizon_color==0?opt_horizon_color:subs.horizon_color;var zenith_color=opt_zenith_color||opt_zenith_color==0?opt_zenith_color:subs.zenith_color;m_scenes.set_environment_colors(active_scene,energy,horizon_color,zenith_color)};exports.get_fog_color_density=function(dest){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_fog_color_density(active_scene,dest)};exports.set_fog_color_density=function(val){if(!m_scenes.check_active()){m_print.error("No active scene");
return}var active_scene=m_scenes.get_active();m_scenes.set_fog_color_density(active_scene,val)};exports.get_ssao_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_ssao_params(active_scene)};exports.set_ssao_params=function(ssao_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_ssao_params(active_scene,ssao_params)};exports.get_color_correction_params=
function(){if(!m_scenes.check_active()){m_print.error("No active scene");return null}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"COMPOSITING");if(!subs)return null;var compos_params={};compos_params.brightness=subs.brightness;compos_params.contrast=subs.contrast;compos_params.exposure=subs.exposure;compos_params.saturation=subs.saturation;return compos_params};exports.set_color_correction_params=function(color_corr_params){if(!m_scenes.check_active()){m_print.error("No active scene");
return}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"COMPOSITING");if(!subs)return;if(typeof color_corr_params.brightness=="number")subs.brightness=color_corr_params.brightness;if(typeof color_corr_params.contrast=="number")subs.contrast=color_corr_params.contrast;if(typeof color_corr_params.exposure=="number")subs.exposure=color_corr_params.exposure;if(typeof color_corr_params.saturation=="number")subs.saturation=color_corr_params.saturation;subs.need_perm_uniforms_update=
true};exports.get_sky_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_sky_params(active_scene)};exports.set_sky_params=function(sky_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_sky_params(active_scene,sky_params)};exports.get_dof_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=
m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"DOF");if(subs)return m_scenes.get_dof_params(active_scene);else return null};exports.set_dof_params=function(dof_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_dof_params(active_scene,dof_params)};exports.get_god_rays_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=
m_scenes.get_subs(active_scene,"GOD_RAYS");if(subs)return m_scenes.get_god_rays_params(active_scene);else return null};exports.set_god_rays_params=function(god_rays_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_god_rays_params(active_scene,god_rays_params)};exports.get_bloom_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,
"BLOOM");if(subs)return m_scenes.get_bloom_params(active_scene);else return null};exports.set_bloom_params=function(bloom_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_bloom_params(active_scene,bloom_params)};exports.get_glow_material_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();var subs=m_scenes.get_subs(active_scene,"GLOW_COMBINE");
if(subs)return m_scenes.get_glow_material_params(active_scene);else return null};exports.set_glow_material_params=function(glow_material_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_glow_material_params(active_scene,glow_material_params)};exports.get_wind_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_wind_params(active_scene)};
exports.set_wind_params=function(wind_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_obj.set_wind_params(active_scene,wind_params)};exports.get_water_surface_level=function(pos_x,pos_z){if(!m_scenes.check_active()){m_print.error("No active scene");return 0}var active_scene=m_scenes.get_active();if(!active_scene._render.water_params){m_print.error("No water parameters on the active scene");return 0}return m_scenes.get_water_surface_level(active_scene,
pos_x,pos_z)};exports.set_water_params=function(water_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.set_water_params(active_scene,water_params)};exports.get_water_mat_params=function(water_params){if(!m_scenes.check_active()){m_print.error("No active scene");return}var active_scene=m_scenes.get_active();m_scenes.get_water_mat_params(active_scene,water_params)};exports.update_scene_materials_params=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return}var active_scene=m_scenes.get_active();m_scenes.update_scene_permanent_uniforms(active_scene)};exports.hide_object=function(obj,ignore_children){ignore_children=ignore_children||false;if((m_obj_util.is_mesh(obj)||m_obj_util.is_empty(obj))&&!m_obj_util.is_dynamic(obj))m_print.error("show/hide is only supported for dynamic objects.");else if(ignore_children)m_scenes.change_visibility(obj,true);else m_scenes.change_visibility_rec(obj,true)};exports.show_object=function(obj,ignore_children){ignore_children=
ignore_children||false;if((m_obj_util.is_mesh(obj)||m_obj_util.is_empty(obj))&&!m_obj_util.is_dynamic(obj))m_print.error("show/hide is only supported for dynamic objects.");else if(ignore_children)m_scenes.change_visibility(obj,false);else m_scenes.change_visibility_rec(obj,false)};exports.is_hidden=function(obj){if(m_obj_util.is_dynamic_mesh(obj)||m_obj_util.is_empty(obj)||m_obj_util.is_lamp(obj))return m_scenes.is_hidden(obj);else{m_print.error("show/hide is only supported for dynamic meshes/empties and lamps");
return false}};exports.is_visible=function(obj){return obj.render.is_visible};exports.check_object=function(obj){m_print.error_deprecated("scenes.check_object","scenes.check_object_by_name");if(!m_scenes.check_active()){m_print.error("No active scene");return false}return m_obj.objects_storage_check(obj,m_scenes.get_active())};exports.check_object_by_name=function(name,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_NAME,name,data_id|0);if(obj)return true;else return false};exports.check_object_by_dupli_name=
function(empty_name,dupli_name,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME,empty_name,dupli_name,data_id|0);if(obj)return true;else return false};exports.check_object_by_dupli_name_list=function(name_list,data_id){var obj=m_obj.get_object(m_obj.GET_OBJECT_BY_DUPLI_NAME_LIST,name_list,data_id|0);if(obj)return true;else return false};exports.get_all_objects=function(type,data_id){var scene=m_scenes.get_active();if(!type)type="ALL";if(!data_id&&data_id!==0)data_id=m_obj.DATA_ID_ALL;
return m_obj.get_scene_objs(scene,type,data_id)};exports.get_object_name=function(obj){if(!obj){m_print.error("Wrong object name");return""}return obj.origin_name};exports.get_object_name_hierarchy=function(obj){if(!obj){m_print.error("Wrong object name");return null}var names=[];var curr_obj=obj;while(curr_obj){names.push(curr_obj.origin_name);curr_obj=m_obj_util.get_dg_parent(curr_obj)}return names.reverse()};exports.get_object_type=function(obj){if(!(obj&&obj.type)){m_print.error("Wrong object");
return"UNDEFINED"}return obj.type};exports.get_object_dg_parent=function(obj){m_print.error_deprecated("scenes.get_object_dg_parent","objects.get_dg_parent");return m_obj_util.get_dg_parent(obj)};exports.get_object_children=function(obj){return obj.cons_descends.slice(0)};exports.get_first_character=function(){var sobjs=m_obj.get_scene_objs(m_scenes.get_active(),"MESH",m_obj.DATA_ID_ALL);for(var i=0;i<sobjs.length;i++){var obj=sobjs[i];if(m_phy.is_character(obj))return obj}return null};exports.get_shore_dist=
function(trans,v_dist_mult){if(!v_dist_mult&&v_dist_mult!==0)v_dist_mult=1;if(!m_scenes.check_active()){m_print.error("No active scene");return false}var active_scene=m_scenes.get_active();return m_scenes.get_shore_dist(active_scene,trans,v_dist_mult)};exports.get_cam_water_depth=function(){return m_scenes.get_cam_water_depth()};exports.get_type_mesh_object=function(obj){if(m_obj_util.is_mesh(obj))return obj.render.type;return null};exports.get_meta_tags=function(){if(!m_scenes.check_active()){m_print.error("No active scene");
return false}var active_scene=m_scenes.get_active();return m_scenes.get_meta_tags(active_scene)};exports.append_object=function(obj,scene_name){if(!obj.render.is_copied){m_print.error('object "'+obj.name+'" has been created not by coping.');return}if(scene_name){var scenes=m_scenes.get_all_scenes();var scene=m_util.keysearch("name",scene_name,scenes)}else var scene=m_scenes.get_active();m_scenes.append_object(scene,obj,true)};exports.remove_object=function(obj){if(!m_obj_util.is_mesh(obj)&&!m_obj_util.is_empty(obj)||
!m_obj_util.is_dynamic(obj)){m_print.error("Can't remove object \""+obj.name+'". It must be '+"dynamic and type of MESH or EMPTY.");return}var scenes_data=obj.scenes_data;for(var j=0;j<scenes_data.length;j++){var scene=scenes_data[j].scene;m_data.prepare_object_unloading(scene,obj,false)}m_obj.remove_object(obj)};exports.marker_frame=function(name){var active_scene=m_scenes.get_active();if(active_scene["timeline_markers"]&&name in active_scene["timeline_markers"])return m_scenes.marker_frame(active_scene,
name);else{m_print.error('"'+name+'" marker not found.');return 0}};exports.get_mb_params=function(){var scene=m_scenes.get_active();var mb_subs=m_scenes.get_subs(scene,"MOTION_BLUR");if(mb_subs){var mb_params={mb_factor:mb_subs.mb_factor,mb_decay_threshold:mb_subs.mb_decay_threshold};return mb_params}else return null};exports.set_mb_params=function(mb_params){var scene=m_scenes.get_active();var mb_subs=m_scenes.get_subs(scene,"MOTION_BLUR");if(mb_subs){if(typeof mb_params.mb_decay_threshold=="number")mb_subs.mb_decay_threshold=
mb_params.mb_decay_threshold;if(typeof mb_params.mb_factor=="number")mb_subs.mb_factor=mb_params.mb_factor}else m_print.error("The motion blur subscene doesn't exist.")};exports.can_select_objects=function(){var scene=m_scenes.get_active();return Boolean(m_scenes.get_subs(scene,"COLOR_PICKING"))}};b4w.module["sfx"]=function(exports,require){var m_obj_util=require("__obj_util");var m_scs=require("__scenes");var m_sfx=require("__sfx");var m_print=require("__print");exports.play=function(obj,when,duration){when=when||0;duration=duration||0;m_sfx.play(obj,when,duration)};exports.play_def=function(obj){m_sfx.play_def(obj)};exports.is_play=function(obj){return m_sfx.is_playing(obj)};exports.is_playing=function(obj){return m_sfx.is_playing(obj)};exports.stop=function(obj){m_sfx.stop(obj)};exports.pause=
function(obj){m_sfx.speaker_pause(obj)};exports.resume=function(obj){m_sfx.speaker_resume(obj)};exports.playrate=function(obj,playrate){m_sfx.playrate(obj,playrate)};exports.get_playrate=function(obj){return m_sfx.get_playrate(obj)};exports.cyclic=function(obj,cyclic){m_sfx.cyclic(obj,cyclic)};exports.is_cyclic=function(obj){return m_sfx.is_cyclic(obj)};exports.listener_reset_speed=function(speed,dir){m_sfx.listener_reset_speed(speed,dir)};exports.speaker_reset_speed=function(obj,speed,dir){m_sfx.speaker_reset_speed(obj,
speed,dir)};exports.get_volume=function(obj){if(obj&&typeof obj==="object")return m_sfx.get_volume(obj);else return m_sfx.get_master_volume()};exports.set_volume=function(obj,volume){if(obj&&typeof obj==="object")m_sfx.set_volume(obj,volume);else m_sfx.set_master_volume(volume)};exports.mute=function(obj,muted){if(obj&&typeof obj==="object")m_sfx.mute(obj,muted);else m_sfx.mute_master(muted)};exports.is_muted=function(obj){if(obj&&typeof obj==="object")return m_sfx.is_muted(obj);else return m_sfx.is_master_muted()};
exports.get_speaker_objects=function(){return m_sfx.get_speaker_objects().slice(0)};exports.check_active_speakers=m_sfx.check_active_speakers;exports.set_compressor_params=function(params){m_sfx.set_compressor_params(m_scs.get_active(),params)};exports.get_compressor_params=function(){return m_sfx.get_compressor_params(m_scs.get_active())};exports.duck=function(obj,value,time){if(obj&&typeof obj==="object")m_sfx.duck(obj,value,time);else m_sfx.duck_master(value,time)};exports.unduck=function(obj){if(obj&&
typeof obj==="object")m_sfx.unduck(obj);else m_sfx.unduck_master()};exports.apply_playlist=m_sfx.apply_playlist;exports.clear_playlist=m_sfx.clear_playlist;exports.detect_audio_container=m_sfx.detect_audio_container;exports.detect_video_container=m_sfx.detect_video_container;exports.set_positional_params=m_sfx.set_positional_params;exports.get_positional_params=m_sfx.get_positional_params;exports.set_filter_params=m_sfx.set_filter_params;exports.get_filter_params=m_sfx.get_filter_params;exports.get_filter_freq_response=
m_sfx.get_filter_freq_response;exports.get_duration=function(obj){if(!obj||!m_obj_util.is_speaker(obj)){m_print.error('Object "'+(obj?obj.name:undefined)+'" is not a valid speaker');return}return m_sfx.get_duration(obj)}};b4w.module["textures"]=function(exports,require){var m_print=require("__print");var m_scenes=require("__scenes");var m_textures=require("__textures");var m_obj_util=require("__obj_util");var m_assets=require("__assets");exports.get_canvas_texture_context=function(id,data_id){m_print.error_deprecated("get_canvas_texture_context","get_canvas_ctx");if(!data_id)data_id=0;var canvas_context=m_textures.get_canvas_context(id,data_id);if(canvas_context)return canvas_context;else m_print.error('Canvas texture with ID "'+
id+'" not found!')};exports.update_canvas_texture_context=function(id,data_id){m_print.error_deprecated("update_canvas_texture_context","update_canvas_ctx");if(!data_id)data_id=0;if(!m_textures.update_canvas_context(id,data_id))m_print.error('Canvas texture with ID "'+id+'" not found!')};exports.play_video=function(texture_name,data_id){if(!data_id)data_id=0;var scene=m_scenes.get_active();if(scene["b4w_use_nla"]&&m_textures.video_allow_nla(texture_name,data_id)){m_print.error("NLA texture can't be controlled directly through API.");
return}if(!m_textures.play_video(texture_name,data_id))m_print.error('Texture with name "'+texture_name+'" not found!')};exports.pause_video=function(texture_name,data_id){if(!data_id)data_id=0;var scene=m_scenes.get_active();if(scene["b4w_use_nla"]&&m_textures.video_allow_nla(texture_name,data_id)){m_print.error("NLA texture can't be controlled directly through API.");return}if(!m_textures.pause_video(texture_name,data_id))m_print.error('Texture with name "'+texture_name+'" not found!')};exports.reset_video=
function(texture_name,data_id){if(!data_id)data_id=0;var scene=m_scenes.get_active();if(scene["b4w_use_nla"]&&m_textures.video_allow_nla(texture_name,data_id)){m_print.error("NLA texture can't be controlled directly through API.");return}if(!m_textures.reset_video(texture_name,data_id))m_print.error('Texture with name "'+texture_name+'" not found!')};exports.get_canvas_ctx=function(obj,text_name){if(!m_obj_util.is_mesh(obj))m_print.error("Object must be type of mesh.");else{var canvas_context=m_textures.get_canvas_context_by_object(obj,
text_name);if(canvas_context)return canvas_context;m_print.error("Couldn't find canvas texture with this name: "+text_name)}return null};exports.update_canvas_ctx=function(obj,text_name){if(!m_obj_util.is_mesh(obj))m_print.error("Object must be type of mesh.");else{if(m_textures.update_canvas_context_by_object(obj,text_name))return true;m_print.error("Couldn't find canvas texture with this name: "+text_name)}return false};exports.change_image=function(obj,text_name,image_path,callback){callback=callback||
function(){};var asset={id:image_path,type:m_assets.AT_IMAGE_ELEMENT,url:image_path,request:"GET",post_type:null,post_data:null,optional_param:null};var asset_cb=function(data,iru,type,filepath,optional_param){if(data)if(m_textures.change_image(obj,text_name,data))callback();else m_print.error("Couldn't find texture with this name: "+text_name)};m_assets.enqueue([asset],asset_cb,null,null)}};b4w.module["time"]=function(exports,require){var m_time=require("__time");exports.set_timeout=m_time.set_timeout;exports.clear_timeout=m_time.clear_timeout;exports.get_timeline=m_time.get_timeline;exports.animate=m_time.animate;exports.clear_animation=m_time.clear_animation};b4w.module["transform"]=function(exports,require){var m_obj_util=require("__obj_util");var m_phy=require("__physics");var m_print=require("__print");var m_quat=require("__quat");var m_trans=require("__transform");var m_tsr=require("__tsr");var m_util=require("__util");var _tsr_tmp=new Float32Array(4);var _vec3_tmp=new Float32Array(3);var _quat4_tmp=new Float32Array(4);exports.SPACE_LOCAL=m_trans.SPACE_LOCAL;exports.SPACE_WORLD=m_trans.SPACE_WORLD;exports.set_translation=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=
x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_translation(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_rel=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_translation_rel(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_v=
function(obj,trans){if(m_obj_util.is_dynamic(obj)){m_trans.set_translation(obj,trans);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_rel_v=function(obj,trans){if(m_obj_util.is_dynamic(obj)){m_trans.set_translation_rel(obj,trans);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_translation_obj_rel=function(obj,x,
y,z,obj_ref){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;var trans=m_tsr.get_trans_view(obj_ref.render.world_tsr);var quat=m_tsr.get_quat_view(obj_ref.render.world_tsr);m_util.transform_vec3(_vec3_tmp,1,quat,trans,_vec3_tmp);m_trans.set_translation(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_translation=function(obj,dest){if(!dest)var dest=new Float32Array(3);
m_trans.get_translation(obj,dest);return dest};exports.get_translation_rel=function(obj,dest){if(!dest)var dest=new Float32Array(3);m_trans.get_translation_rel(obj,dest);return dest};exports.set_rotation=function(obj,x,y,z,w){if(m_obj_util.is_dynamic(obj)){_quat4_tmp[0]=x;_quat4_tmp[1]=y;_quat4_tmp[2]=z;_quat4_tmp[3]=w;m_trans.set_rotation(obj,_quat4_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_rel=
function(obj,x,y,z,w){if(m_obj_util.is_dynamic(obj)){_quat4_tmp[0]=x;_quat4_tmp[1]=y;_quat4_tmp[2]=z;_quat4_tmp[3]=w;m_trans.set_rotation_rel(obj,_quat4_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_v=function(obj,quat){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};
exports.set_rotation_rel_v=function(obj,quat){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation_rel(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_rotation=function(obj,opt_dest){if(!opt_dest)var opt_dest=new Float32Array(4);m_trans.get_rotation(obj,opt_dest);return opt_dest};exports.get_rotation_rel=function(obj,opt_dest){if(!opt_dest)var opt_dest=new Float32Array(4);m_trans.get_rotation_rel(obj,
opt_dest);return opt_dest};exports.set_rotation_euler=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_rotation_euler(obj,_vec3_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_euler_rel=function(obj,x,y,z){if(m_obj_util.is_dynamic(obj)){_vec3_tmp[0]=x;_vec3_tmp[1]=y;_vec3_tmp[2]=z;m_trans.set_rotation_euler_rel(obj,_vec3_tmp);m_trans.update_transform(obj);
m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_euler_v=function(obj,euler){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation_euler(obj,euler);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_rotation_euler_rel_v=function(obj,euler){if(m_obj_util.is_dynamic(obj)){m_trans.set_rotation_euler_rel(obj,euler);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+
obj.name+'" is not dynamic.')};exports.set_scale=function(obj,scale){if(m_obj_util.is_dynamic(obj)){m_trans.set_scale(obj,scale);m_trans.update_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_scale_rel=function(obj,scale){if(m_obj_util.is_dynamic(obj)){m_trans.set_scale_rel(obj,scale);m_trans.update_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_scale=function(obj){return m_trans.get_scale(obj)};exports.get_scale_rel=
function(obj){return m_trans.get_scale_rel(obj)};exports.empty_reset_transform=function(obj){if(obj.type!="EMPTY"){m_print.error("Wrong object: "+obj.name);return}for(var i=0;i<obj.cons_descends.length;i++)if(!m_obj_util.is_dynamic(obj.cons_descends[i])){m_print.error('Wrong object: "'+obj.cons_descends[i].name+'" is not dynamic.');return}m_trans.set_translation(obj,[0,0,0]);m_trans.set_rotation(obj,[0,0,0,1]);m_trans.set_scale(obj,1);m_trans.update_transform(obj);m_phy.sync_transform(obj)};exports.get_object_size=
function(obj){if(!m_obj_util.is_mesh(obj)){m_print.error("Wrong object: "+obj.name);return 0}return m_trans.get_object_size(obj)};exports.get_object_center=function(obj,calc_bs_center,dest){if(!m_obj_util.is_mesh(obj)){m_print.error("Wrong object: "+obj.name);return null}return m_trans.get_object_center(obj,calc_bs_center,dest)};exports.move_local=function(obj,dx,dy,dz){if(m_obj_util.is_dynamic(obj)){m_trans.move_local(obj,dx,dy,dz);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+
obj.name+'" is not dynamic.')};exports.rotate_x_local=function(obj,angle){if(m_obj_util.is_dynamic(obj)){var quat=m_quat.setAxisAngle(m_util.AXIS_X,angle,_quat4_tmp);m_trans.rotate_local(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.rotate_y_local=function(obj,angle){if(m_obj_util.is_dynamic(obj)){var quat=m_quat.setAxisAngle(m_util.AXIS_Y,angle,_quat4_tmp);m_trans.rotate_local(obj,quat);m_trans.update_transform(obj);
m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.rotate_z_local=function(obj,angle){if(m_obj_util.is_dynamic(obj)){var quat=m_quat.setAxisAngle(m_util.AXIS_Z,angle,_quat4_tmp);m_trans.rotate_local(obj,quat);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_object_bounding_box=function(obj){return m_trans.get_object_bounding_box(obj)};exports.set_tsr=function(obj,
tsr){if(m_obj_util.is_dynamic(obj)){m_trans.set_tsr(obj,tsr);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_tsr_rel=function(obj,tsr){if(m_obj_util.is_dynamic(obj)){m_trans.set_tsr_rel(obj,tsr);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_tsr=function(obj,dest){if(!dest)var dest=new Float32Array(8);m_trans.get_tsr(obj,dest);
return dest};exports.get_tsr_rel=function(obj,dest){if(!dest)var dest=new Float32Array(8);m_trans.get_tsr_rel(obj,dest);return dest};exports.distance=function(obj1,obj2){return m_trans.distance(obj1,obj2)};exports.set_matrix=function(obj,mat){if(m_obj_util.is_dynamic(obj)){m_tsr.from_mat4(mat,_tsr_tmp);m_trans.set_tsr(obj,_tsr_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.set_matrix_rel=function(obj,mat){if(m_obj_util.is_dynamic(obj)){m_tsr.from_mat4(mat,
_tsr_tmp);m_trans.set_tsr_rel(obj,_tsr_tmp);m_trans.update_transform(obj);m_phy.sync_transform(obj)}else m_print.error('Wrong object: "'+obj.name+'" is not dynamic.')};exports.get_matrix=function(obj,dest){if(!dest)var dest=new Float32Array(16);m_trans.get_tsr(obj,_tsr_tmp);m_tsr.to_mat4(_tsr_tmp,dest);return dest};exports.get_matrix_rel=function(obj,dest){if(!dest)var dest=new Float32Array(16);m_trans.get_tsr_rel(obj,_tsr_tmp);m_tsr.to_mat4(_tsr_tmp,dest);return dest}};b4w.module["tsr"]=function(exports,require){var m_mat4=require("__mat4");var m_print=require("__print");var m_tsr=require("__tsr");exports.create=m_tsr.create;exports.from_values=m_tsr.from_values;exports.copy=m_tsr.copy;exports.identity=m_tsr.identity;exports.create_sep=create_sep;function create_sep(trans,scale,quat,dest){m_print.error_deprecated("create_sep","set_sep");return set_sep(trans,scale,quat,dest)}exports.set_sep=m_tsr.set_sep;function set_sep(trans,scale,quat,dest){if(!dest)var dest=
m_tsr.create();set_sep(trans,scale,quat,dest);return dest}exports.set_trans=m_tsr.set_trans;exports.set_scale=m_tsr.set_scale;exports.set_transcale=m_tsr.set_transcale;exports.set_quat=m_tsr.set_quat;exports.get_trans_view=m_tsr.get_trans_view;exports.get_scale=m_tsr.get_scale;exports.get_quat_view=m_tsr.get_quat_view;exports.invert=m_tsr.invert;exports.to_mat4=function(tsr,dest){if(!dest)var dest=m_mat4.create();m_tsr.to_mat4(tsr,dest);return dest};exports.from_mat4=m_tsr.from_mat4;exports.multiply=
m_tsr.multiply;exports.transform_vec3=m_tsr.transform_vec3;exports.transform_vec3_inv=m_tsr.transform_vec3_inv;exports.transform_vectors=m_tsr.transform_vectors;exports.transform_dir_vectors=m_tsr.transform_dir_vectors;exports.transform_dir_vec3=m_tsr.transform_dir_vec3;exports.transform_tangents=m_tsr.transform_tangents;exports.translate=m_tsr.translate;exports.interpolate=function(tsr,tsr2,factor,dest){if(!dest)var dest=m_tsr.create();m_tsr.interpolate(tsr,tsr2,factor,dest);return dest}};b4w.module["util"]=function(exports,require){var m_compat=require("__compat");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_quat=require("__quat");var m_util=require("__util");var m_vec3=require("__vec3");var _pline_tmp=new Float32Array(6);exports.AXIS_X=new Float32Array([1,0,0]);exports.AXIS_Y=new Float32Array([0,1,0]);exports.AXIS_Z=new Float32Array([0,0,1]);exports.AXIS_MX=new Float32Array([-1,0,0]);exports.AXIS_MY=new Float32Array([0,-1,0]);exports.AXIS_MZ=new Float32Array([0,
0,-1]);exports.XYX=m_util.XYX;exports.YZY=m_util.YZY;exports.ZXZ=m_util.ZXZ;exports.XZX=m_util.XZX;exports.YXY=m_util.YXY;exports.ZYZ=m_util.ZYZ;exports.XYZ=m_util.XYZ;exports.YZX=m_util.YZX;exports.ZXY=m_util.ZXY;exports.XZY=m_util.XZY;exports.YXZ=m_util.YXZ;exports.ZYX=m_util.ZYX;exports.f32=function(param){param=param||0;return new Float32Array(param)};exports.assert=m_util.assert;exports.keyfind=m_util.keyfind;exports.keysearch=m_util.keysearch;exports.matrix_to_quat=function(matrix){return m_util.matrix_to_quat(matrix)};
exports.euler_to_quat=function(euler,quat){if(!quat)quat=new Float32Array(4);return m_util.euler_to_quat(euler,quat)};exports.ordered_angles_to_quat=function(angles,order,quat){if(!quat)quat=m_quat.create();return m_util.ordered_angles_to_quat(angles,order,quat)};exports.quat_to_ordered_angles=function(quat,order,angles){if(!angles)angles=m_vec3.create();return m_util.quat_to_ordered_angles(quat,order,angles)};exports.quat_to_euler=function(quat,euler){if(!euler)euler=new Float32Array(3);return m_util.quat_to_euler(quat,
euler)};exports.sign=m_util.sign;exports.clamp=m_util.clamp;exports.quat_to_dir=m_util.quat_to_dir;exports.ground_project_quat=function(quat,dest){return m_util.quat_project(quat,m_util.AXIS_MY,m_util.AXIS_Y,m_util.AXIS_MZ,dest)};exports.cam_quat_to_mesh_quat=function(cam_quat,dest){return m_util.cam_quat_to_mesh_quat(cam_quat,dest)};exports.quat_project=function(quat,quat_ident_dir,plane,plane_ident_dir,dest){if(m_vec3.dot(plane,plane_ident_dir)!=0){m_print.error("Wrong in-plane direction");return null}return m_util.quat_project(quat,
quat_ident_dir,plane,plane_ident_dir,dest)};exports.hash_code=m_util.hash_code;exports.smooth=m_util.smooth;exports.smooth_v=m_util.smooth_v;exports.is_vector=m_util.is_vector;exports.correct_cam_quat_up=m_util.correct_cam_quat_up;exports.quat_to_angle_axis=m_util.quat_to_angle_axis;exports.random_from_array=m_util.random_from_array;exports.xz_direction=m_util.xz_direction;exports.line_plane_intersect=function(pn,p_dist,lp,l_dir,dest){m_print.error_deprecated("util.line_plane_intersect","math.line_plane_intersect");
_pline_tmp[0]=lp[0];_pline_tmp[1]=lp[1];_pline_tmp[2]=lp[2];_pline_tmp[3]=l_dir[0];_pline_tmp[4]=l_dir[1];_pline_tmp[5]=l_dir[2];return m_util.line_plane_intersect(pn,p_dist,_pline_tmp,dest)};exports.is_mesh=function(obj){m_print.error_deprecated("util.is_mesh","objects.is_mesh");return m_obj_util.is_mesh(obj)};exports.is_armature=function(obj){m_print.error_deprecated("util.is_armature","objects.is_armature");return m_obj_util.is_armature(obj)};exports.angle_wrap_0_2pi=m_util.angle_wrap_0_2pi;exports.angle_wrap_periodic=
m_util.angle_wrap_periodic;exports.smooth_step=m_util.smooth_step;exports.lerp=m_util.lerp;exports.deg_to_rad=m_util.deg_to_rad;exports.rad_to_deg=m_util.rad_to_deg;exports.dir_to_quat=m_util.dir_to_quat;exports.is_ie11=m_compat.is_ie11};if(typeof module=="object"&&module.exports)GLOBAL.b4w={module:{}};b4w.module["version"]=function(exports,require){var m_print=require("__print");var m_version=require("__version");exports.version=m_version.version;exports.version_str=m_version.version_str;exports.type=m_version.type;exports.date=m_version.date;exports.date_str=m_version.date_str};if(typeof module=="object"&&module.exports)b4w.module["version"](exports);b4w.module["objects"]=function(exports,require){var m_geom=require("__geometry");var m_obj=require("__objects");var m_batch=require("__batch");var m_obj_util=require("__obj_util");var m_print=require("__print");var m_scenes=require("__scenes");exports.get_meta_tags=function(obj){if(obj)return m_obj.get_meta_tags(obj)};exports.copy=function(obj,name,deep_copy){if(!m_obj_util.is_mesh(obj)){m_print.error('object "'+obj.name+'" is not of type "MESH".');return false}if(!m_obj_util.is_dynamic(obj)){m_print.error('object "'+
obj.name+'" is not dynamic.');return false}if(!(m_geom.has_dyn_geom(obj)||m_geom.check_shape_keys(obj))&&deep_copy){m_print.error('object "'+obj.name+'" has not dynamic '+"geometry for deep copying.");return false}var objs=m_obj.get_scene_objs(m_scenes.get_active(),"MESH",m_obj.DATA_ID_ALL);if(objs.indexOf(obj)==-1){m_print.error('object "'+obj.name+'" does not belong to the '+"active scene.");return false}name=name||"";return m_obj.copy(obj,name,deep_copy)};exports.set_nodemat_value=function(obj,
name_list,value){if(!m_obj_util.is_dynamic_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH" or it is not dynamic.');return}m_batch.set_nodemat_value(obj,name_list,value)};exports.get_nodemat_value=function(obj,name_list){if(!m_obj_util.is_dynamic_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH" or it is not dynamic.');return null}return m_batch.get_nodemat_value(obj,name_list)};exports.set_nodemat_rgb=function(obj,name_list,r,g,b){if(!m_obj_util.is_dynamic_mesh(obj)){m_print.error('The type of the object "'+
obj.name+'" is not "MESH" or it is not dynamic.');return}m_batch.set_nodemat_rgb(obj,name_list,r,g,b)};exports.get_nodemat_rgb=function(obj,name_list,dest){if(!m_obj_util.is_dynamic_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH" or it is not dynamic.');return null}if(!dest)dest=new Float32Array(3);return m_batch.get_nodemat_rgb(obj,name_list,dest)};exports.update_boundings=function(obj){if(!m_obj_util.is_mesh(obj)){m_print.error('The type of the object "'+obj.name+'" is not "MESH".');
return}if(!(m_geom.has_dyn_geom(obj)||m_geom.check_shape_keys(obj))){m_print.error('object "'+obj.name+'" has not dynamic '+"geometry.");return}m_obj.update_boundings(obj)};exports.get_parent=m_obj_util.get_parent;exports.get_dg_parent=m_obj_util.get_dg_parent;exports.is_mesh=m_obj_util.is_mesh;exports.is_armature=m_obj_util.is_armature;exports.is_speaker=m_obj_util.is_speaker;exports.is_camera=m_obj_util.is_camera;exports.is_lamp=m_obj_util.is_lamp;exports.is_empty=m_obj_util.is_empty;exports.is_line=
m_obj_util.is_line;exports.is_world=m_obj_util.is_world;exports.get_selectable_objects=function(){return m_obj.get_selectable_objects()};exports.get_outlining_objects=function(){return m_obj.get_outlining_objects()}};b4w.module["main"]=function(exports,require){var m_anchors=require("__anchors");var m_anim=require("__animation");var m_assets=require("__assets");var m_cfg=require("__config");var m_compat=require("__compat");var m_cont=require("__container");var m_ctl=require("__controls");var m_data=require("__data");var m_debug=require("__debug");var m_ext=require("__extensions");var m_geom=require("__geometry");var m_input=require("__input");var m_hud=require("__hud");var m_nla=require("__nla");var m_lnodes=
require("__logic_nodes");var m_obj=require("__objects");var m_phy=require("__physics");var m_print=require("__print");var m_render=require("__renderer");var m_scenes=require("__scenes");var m_sfx=require("__sfx");var m_shaders=require("__shaders");var m_textures=require("__textures");var m_time=require("__time");var m_trans=require("__transform");var m_util=require("__util");var m_version=require("__version");var m_particles=require("__particles");var cfg_ctx=m_cfg.context;var cfg_def=m_cfg.defaults;
var _elem_canvas_webgl=null;var _elem_canvas_hud=null;var _last_abs_time=0;var _pause_time=0;var _resume_time=0;var _loop_cb=[];var _fps_callback=function(){};var _fps_counter=function(){};var _render_callback=function(){};var _canvas_data_url_callback=null;var WEBGL_CTX_IDS=["webgl","experimental-webgl"];var WEBGL2_CTX_IDS=["webgl2","experimental-webgl2"];var _gl=null;var _requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||
window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return window.setTimeout(callback,1E3/cfg_def.max_fps)}}();exports.init=function(elem_canvas_webgl,elem_canvas_hud){m_cfg.set_paths();m_print.set_verbose(cfg_def.console_verbose);var ver_str=m_version.version_str()+" "+m_version.type()+" ("+m_version.date_str()+")";m_print.log("%cINIT ENGINE","color: #00a",ver_str);if(!window["WebGLRenderingContext"])return null;setup_clock();_elem_canvas_webgl=elem_canvas_webgl;if(elem_canvas_hud){m_hud.init(elem_canvas_hud);
_elem_canvas_hud=elem_canvas_hud}else{m_cfg.defaults.show_hud_debug_info=false;m_cfg.sfx.mix_mode=false}m_compat.apply_context_alpha_hack();if(!(m_compat.check_user_agent("Chrome")||m_compat.check_user_agent("Firefox")))cfg_def.webgl2=false;var gl=get_context(elem_canvas_webgl,cfg_def.webgl2);if(!gl&&cfg_def.webgl2){cfg_def.webgl2=false;gl=get_context(elem_canvas_webgl,false)}if(!gl)return null;m_print.log("%cINIT WEBGL "+(cfg_def.webgl2?"2":"1"),"color: #00a");_gl=gl;init_context(_elem_canvas_webgl,
_elem_canvas_hud,gl);m_cfg.apply_quality();m_compat.set_hardware_defaults(gl);m_shaders.load_shaders();if(cfg_def.ie11_edge_touchscreen_hack)elem_canvas_webgl.style["touch-action"]="none";m_print.log("%cSET PRECISION:","color: #00a",cfg_def.precision);return gl};function setup_clock(){if(!window.performance){m_print.log("Apply performance workaround");window.performance={}}var curr_time=Date.now();if(!window.performance.now){m_print.log("Apply performance.now() workaround");window.performance.now=
function(){return Date.now()-curr_time}}m_time.set_timeline(0)}function get_context(canvas,init_webgl2){var ctx=null;var ctx_ids=init_webgl2?WEBGL2_CTX_IDS:WEBGL_CTX_IDS;for(var i=0;i<ctx_ids.length;i++){var name=ctx_ids[i];try{ctx=canvas.getContext(name,cfg_ctx)}catch(e){}if(ctx)break}if(ctx)m_compat.detect_tegra_invalid_enum_issue(ctx);return ctx}function init_context(canvas,canvas_hud,gl){canvas.addEventListener("webglcontextlost",function(event){event.preventDefault();m_print.error("WebGL context lost");
pause()},false);m_ext.setup_context(gl);var rinfo=m_ext.get_renderer_info();if(rinfo)m_print.log("%cRENDERER INFO:","color: #00a",gl.getParameter(rinfo.UNMASKED_VENDOR_WEBGL)+", "+gl.getParameter(rinfo.UNMASKED_RENDERER_WEBGL));m_render.setup_context(gl);m_geom.setup_context(gl);m_textures.setup_context(gl);m_shaders.setup_context(gl);m_debug.setup_context(gl);m_cont.setup_context(gl);m_data.setup_canvas(canvas);m_cont.init(canvas,canvas_hud);m_scenes.setup_dim(canvas.width,canvas.height,1);m_sfx.init();
_fps_counter=init_fps_counter();loop()}exports.resize=resize;function resize(width,height,update_canvas_css){m_print.error_deprecated("main.resize","container.resize");m_cont.resize(width,height,update_canvas_css)}exports.set_fps_callback=function(fps_cb){_fps_callback=fps_cb};exports.clear_fps_callback=function(){_fps_callback=function(){}};exports.set_render_callback=function(callback){set_render_callback(callback)};function set_render_callback(callback){_render_callback=callback}exports.clear_render_callback=
function(){clear_render_callback()};function clear_render_callback(){_render_callback=function(){}}exports.global_timeline=function(){m_print.error_deprecated("main.global_timeline","time.get_timeline");return m_time.get_timeline()};exports.pause=pause;function pause(){if(is_paused())return;_pause_time=performance.now()/1E3;m_sfx.pause();m_phy.pause();m_textures.pause();m_anchors.pause()}exports.resume=function(){if(!is_paused())return;_resume_time=performance.now()/1E3;m_sfx.resume();m_phy.resume();
m_textures.play(true);m_anchors.resume()};exports.is_paused=is_paused;function is_paused(){return _resume_time<_pause_time}function loop(){_requestAnimFrame(loop);var abstime=performance.now()/1E3;if(!_last_abs_time)_last_abs_time=abstime;var delta=abstime-_last_abs_time;if(delta<1/cfg_def.max_fps)return;var timeline=m_time.get_timeline();for(var i=0;i<_loop_cb.length;i++)_loop_cb[i](timeline,delta);if(!is_paused()){if(_resume_time>_last_abs_time)delta-=_resume_time-Math.max(_pause_time,_last_abs_time);
timeline+=delta;m_time.set_timeline(timeline);m_debug.update();m_assets.update();m_data.update();frame(timeline,delta);_fps_counter(delta)}_last_abs_time=abstime}function frame(timeline,delta){if(!m_data.is_primary_loaded())return;m_hud.reset();m_trans.update(delta);m_lnodes.update(timeline,delta);m_nla.update(timeline,delta);m_sfx.update(timeline,delta);if(delta)m_anim.update(delta);if(!m_data.is_primary_loaded())return;m_phy.update(timeline,delta);if(!m_data.is_primary_loaded())return;m_input.update();
m_ctl.update(timeline,delta);if(!m_data.is_primary_loaded())return;m_anchors.update();m_obj.update(timeline,delta);m_particles.update();_render_callback(delta,timeline);if(!m_data.is_primary_loaded())return;m_scenes.update(timeline,delta);m_anchors.update_visibility();if(_canvas_data_url_callback){_canvas_data_url_callback(_elem_canvas_webgl.toDataURL());_canvas_data_url_callback=null}}function init_fps_counter(){var fps_avg=60;var fps_frame_counter=0;var interval=cfg_def.fps_measurement_interval;
var interval_cb=cfg_def.fps_callback_interval;var fps_counter=function(delta){if(delta<1/cfg_def.max_fps)return;fps_avg=m_util.smooth(1/delta,fps_avg,delta,interval);var phy_fps_avg=m_phy.get_fps();fps_frame_counter=(fps_frame_counter+1)%interval_cb;if(fps_frame_counter==0)_fps_callback(Math.round(fps_avg),phy_fps_avg)};return fps_counter}exports.reset=function(){m_data.unload(0);_elem_canvas_webgl=null;_elem_canvas_hud=null;_last_abs_time=0;_pause_time=0;_resume_time=0;_fps_callback=function(){};
_fps_counter=function(){};_render_callback=function(){};_loop_cb.length=0;_gl=null;m_time.reset()};exports.canvas_data_url=function(callback){_canvas_data_url_callback=callback};exports.get_canvas_elem=function(){m_print.error_deprecated("main.get_canvas_elem","container.get_canvas");return _elem_canvas_webgl};exports.detect_mobile=function(){return m_compat.detect_mobile()};exports.append_loop_cb=function(callback){for(var i=0;i<_loop_cb.length;i++)if(_loop_cb[i]==callback)return;_loop_cb.push(callback)};
exports.remove_loop_cb=function(callback){for(var i=0;i<_loop_cb.length;i++)if(_loop_cb[i]==callback){_loop_cb.splice(i,1);break}}};b4w.module["nla"]=function(exports,require){var m_nla=require("__nla");var m_time=require("__time");var m_print=require("__print");var m_util=require("__util");exports.set_frame=function(frame){frame=m_util.clamp(frame,m_nla.get_frame_start(),m_nla.get_frame_end());if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.set_frame(frame,m_time.get_timeline())};exports.get_frame=function(){return m_nla.get_frame(m_time.get_timeline())};exports.stop=function(){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");
return}m_nla.stop_nla()};exports.play=function(callback){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.play_nla(callback)};exports.is_play=function(){return m_nla.is_play()};exports.get_frame_start=function(){return m_nla.get_frame_start()};exports.get_frame_end=function(){return m_nla.get_frame_end()};exports.check_nla=function(){return m_nla.check_nla()};exports.check_nla_scripts=function(){return m_nla.check_logic_nodes()};exports.check_logic_nodes=
function(){return m_nla.check_logic_nodes()};exports.set_range=function(start_frame,end_frame){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}end_frame=parseFloat(end_frame)||m_nla.get_frame_end();start_frame=parseFloat(start_frame)||m_nla.get_frame_end();end_frame=m_util.clamp(end_frame,m_nla.get_frame_start(),m_nla.get_frame_end());start_frame=m_util.clamp(start_frame,m_nla.get_frame_start(),end_frame);m_nla.set_range(start_frame,end_frame)};exports.reset_range=
function(){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.reset_range()};exports.set_cyclic=function(is_cyclic){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.set_cyclic(is_cyclic)};exports.clear_callback=function(){if(m_nla.check_logic_nodes()){m_print.error("The active scene is using NLA script.");return}m_nla.clear_callback()}};b4w.module["app"]=function(exports,require){var m_anim=require("animation");var m_cam=require("camera");var m_cfg=require("config");var m_cons=require("constraints");var m_cont=require("container");var m_ctl=require("controls");var m_data=require("data");var m_dbg=require("debug");var m_input=require("input");var m_main=require("main");var m_phy=require("physics");var m_print=require("print");var m_scs=require("scenes");var m_trans=require("transform");var m_util=require("util");var m_vec3=require("vec3");
var TARGET_KEY_ZOOM_POW1=1;var TARGET_KEY_ZOOM_POW2=.15;var TARGET_TOUCH_ZOOM_FACTOR=.03;var EYE_KEY_TRANS_FACTOR=5;var EYE_ROTATION_DECREMENT=.5;var TARGET_EYE_MOUSE_ROT_MULT_PX=.003;var TARGET_EYE_MOUSE_PAN_MULT_PX=7.5E-4;var TARGET_EYE_TOUCH_ROT_MULT_PX=.003;var TARGET_EYE_TOUCH_PAN_MULT_PX=7.5E-4;var TARGET_EYE_KEY_ROT_FACTOR=.75;var HOVER_MOUSE_PAN_MULT_PX=.003;var HOVER_MOUSE_ROT_MULT_PX=7.5E-4;var HOVER_TOUCH_PAN_MULT_PX=.003;var HOVER_TOUCH_ROT_MULT_PX=.003;var HOVER_KEY_TRANS_FACTOR=.5;var HOVER_KEY_ZOOM_FACTOR=
30;var HOVER_MOUSE_TOUCH_TRANS_FACTOR=.2;var HOVER_MOUSE_ZOOM_FACTOR=2;var HOVER_TOUCH_ZOOM_FACTOR=2;var HOVER_ZOOM_FACTOR_MIN=2;var HOVER_SPEED_MIN=1;var _smooth_factor=1;var CAM_SMOOTH_ZOOM_MOUSE=.1;var CAM_SMOOTH_ZOOM_TOUCH=.15;var CAM_SMOOTH_ROT_TRANS_MOUSE=.08;var CAM_SMOOTH_ROT_TRANS_TOUCH=.12;var COLL_RESPONSE_NORMAL_FACTOR=.01;var CHAR_HEAD_POSITION=.5;var EPSILON_DISTANCE=.001;var EPSILON_DELTA=1E-5;var FRAME_WAITING_PER=10;var AXIS_THRESHOLD=.1;var TRANS_GMPD_KOEF=.002;var ZOOM_GMPD_KOEF=
.05;var _fps_logger_elem=null;var _disable_default_pivot=false;var _disable_letter_controls=false;var _disable_zoom=false;var _vec2_tmp=new Float32Array(2);var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _velocity_tmp={};var _limits_tmp={};exports.init=function(options){options=options||{};var autoresize=false;var canvas_container_id=null;var callback=function(){};var error_purge_elements=
null;var fps_elem_id=null;var force_container_ratio=0;var fps_wrapper_id=null;var key_pause_enabled=true;var pause_invisible=true;var report_init_failure=true;var sfx_mix_mode=false;var show_fps=false;var show_hud_debug_info=false;var track_container_position=false;for(var opt in options)switch(opt){case "canvas_container_id":canvas_container_id=options.canvas_container_id;break;case "callback":callback=options.callback;break;case "autoresize":autoresize=options.autoresize;break;case "do_not_use_onload":break;
case "show_hud_debug_info":show_hud_debug_info=options.show_hud_debug_info;break;case "sfx_mix_mode":sfx_mix_mode=options.sfx_mix_mode;break;case "show_fps":show_fps=options.show_fps;break;case "track_container_position":track_container_position=options.track_container_position;break;case "fps_wrapper_id":fps_wrapper_id=options.fps_wrapper_id;break;case "fps_elem_id":fps_elem_id=options.fps_elem_id;break;case "error_purge_elements":error_purge_elements=options.error_purge_elements;break;case "report_init_failure":report_init_failure=
options.report_init_failure;break;case "pause_invisible":pause_invisible=options.pause_invisible;break;case "key_pause_enabled":key_pause_enabled=options.key_pause_enabled;break;case "force_container_ratio":force_container_ratio=options.force_container_ratio;break;default:m_cfg.set(opt,options[opt]);break}var on_key_pause=function(e){if(e.keyCode==m_ctl.KEY_P)if(m_main.is_paused())m_main.resume();else m_main.pause()};if(key_pause_enabled)document.addEventListener("keydown",on_key_pause,false);m_cfg.set("show_hud_debug_info",
show_hud_debug_info);m_cfg.set("sfx_mix_mode",sfx_mix_mode);var init_hud_canvas=show_hud_debug_info||sfx_mix_mode||null;var onload_cb=function(){var init_ok=setup_canvas(canvas_container_id,init_hud_canvas,report_init_failure,error_purge_elements);var canvas_elem=m_cont.get_canvas();if(!init_ok){callback(canvas_elem,false);return}var canvas_container_elem=m_cont.get_container();resize_to_container();if(show_fps){create_fps_logger_elem(fps_elem_id,fps_wrapper_id);m_main.set_fps_callback(fps_callback)}if(pause_invisible){handle_page_visibility();
handle_position_visibility()}if(force_container_ratio)m_main.append_loop_cb(function(){canvas_container_elem.style.height=canvas_container_elem.clientWidth/force_container_ratio+"px"});if(autoresize)m_main.append_loop_cb(function(){var ccw=canvas_container_elem.clientWidth;var cch=canvas_container_elem.clientHeight;if(ccw!=canvas_elem.clientWidth||cch!=canvas_elem.clientHeight)m_cont.resize(ccw,cch,true)});if(track_container_position)m_main.append_loop_cb(function(){m_cont.force_offsets_updating()});
callback(canvas_elem,true)};var onunload_cb=function(){m_data.cleanup()};if(document.readyState=="complete")window.setTimeout(onload_cb,0);else window.addEventListener("load",onload_cb,false);window.addEventListener("unload",onunload_cb,false)};function handle_page_visibility(){var was_paused=m_main.is_paused();var visibility_change=function(){if(document.hidden){was_paused=m_main.is_paused();m_main.pause()}else if(!was_paused)m_main.resume()};document.addEventListener("visibilitychange",visibility_change,
false)}function handle_position_visibility(){var frame_counter=0;var container=m_cont.get_container();var was_paused=m_main.is_paused();var check_paused=true;var visibility_change=function(){if(frame_counter%FRAME_WAITING_PER==0){var coords=container.getBoundingClientRect();if(coords.top>window.innerHeight||coords.bottom<0){if(check_paused)was_paused=m_main.is_paused();m_main.pause();check_paused=false}else if(!was_paused&&!check_paused){m_main.resume();check_paused=true}}frame_counter++};m_main.append_loop_cb(visibility_change)}
function setup_canvas(canvas_container_id,init_hud_canvas,report_init_failure,purge_elements){var canvas_elem=document.createElement("canvas");var append_to=document.getElementById(canvas_container_id);canvas_elem.style.position="absolute";canvas_elem.style.left=0;canvas_elem.style.top=0;canvas_elem.style.width=append_to.offsetWidth+"px";canvas_elem.style.height=append_to.offsetHeight+"px";canvas_elem.width=append_to.offsetWidth*window.devicePixelRatio;canvas_elem.height=append_to.offsetHeight*window.devicePixelRatio;
if(init_hud_canvas){var canvas_elem_hud=document.createElement("canvas");canvas_elem_hud.style.position="absolute";canvas_elem.style.left=0;canvas_elem.style.top=0;canvas_elem_hud.style.pointerEvents="none"}else var canvas_elem_hud=null;if(!append_to){m_print.error('Warning: canvas container "'+canvas_container_id+'" not found, appending to body');append_to=document.body}append_to.appendChild(canvas_elem);if(!m_main.init(canvas_elem,canvas_elem_hud)){if(report_init_failure)report_app_error("Browser could not initialize WebGL",
"For more info visit","https://www.blend4web.com/doc/en/problems_and_solutions.html",purge_elements);return false}if(canvas_elem_hud)m_cont.insert_to_container(canvas_elem_hud,"LAST");return true}function create_fps_logger_elem(fps_elem_id,fps_wrapper_id){if(fps_elem_id){if(fps_wrapper_id)document.getElementById(fps_wrapper_id).style.display="block";_fps_logger_elem=document.getElementById(fps_elem_id)}else{_fps_logger_elem=document.createElement("div");_fps_logger_elem.innerHTML=0;_fps_logger_elem.style.cssText=
"position:absolute;"+"top: 23px;"+"right: 20px;"+"font-size: 45px;"+"line-height: 50px;"+"font-weight: bold;"+"color: #000;";m_cont.insert_to_container(_fps_logger_elem,"JUST_AFTER_CANVAS")}}function fps_callback(fps,phy_fps){var fps_str=String(fps);if(phy_fps)fps_str+="/"+String(phy_fps);_fps_logger_elem.innerHTML=fps_str}function elem_cloned(elem_id){var target=document.getElementById(elem_id);var new_element=target.cloneNode(true);target.parentNode.replaceChild(new_element,target);return new_element}
exports.resize_to_container=resize_to_container;function resize_to_container(){var canvas_container_elem=m_cont.get_container();var w=canvas_container_elem.clientWidth;var h=canvas_container_elem.clientHeight;m_cont.resize(w,h,true)}exports.set_onclick=function(elem_id,callback){var elem=elem_cloned(elem_id);elem.addEventListener("mouseup",function(e){callback(elem.value)},false)};exports.set_onchange=function(elem_id,callback){var elem=elem_cloned(elem_id);elem.addEventListener("change",function(e){var checked=
elem.checked;var rslt=checked!=undefined?checked:elem.value;callback(rslt)},false)};exports.set_onkeypress=function(elem_id,callback){var elem=elem_cloned(elem_id);elem.addEventListener("keypress",function(e){callback(e.keyCode,elem.value)},false)};function trans_hover_cam_horiz_local(camobj,dir,fact){var dist=Math.max(m_cam.hover_get_distance(camobj),HOVER_SPEED_MIN);var obj_quat=m_trans.get_rotation(camobj,_quat4_tmp);var abs_dir=m_util.quat_to_dir(obj_quat,dir,_vec3_tmp);abs_dir[1]=0;m_vec3.normalize(abs_dir,
abs_dir);m_vec3.scale(abs_dir,dist*fact,abs_dir);var obj_trans=m_trans.get_translation(camobj,_vec3_tmp2);m_vec3.add(obj_trans,abs_dir,obj_trans);m_cam.set_translation(camobj,obj_trans)}function zoom_hover_cam(camobj,fact){var limits=m_cam.hover_get_vertical_limits(camobj,_limits_tmp);if(limits.up!=limits.down){var y_angle=m_cam.get_camera_angles(camobj,_vec2_tmp2)[1];var angle_factor=(limits.down-y_angle)/(limits.down-limits.up);var dist_limits=m_cam.hover_get_distance_limits(camobj,_limits_tmp);
angle_factor=Math.max(angle_factor,HOVER_ZOOM_FACTOR_MIN/dist_limits.max);m_cam.hover_rotate(camobj,0,angle_factor*fact)}}function trans_eye_cam_local(camobj,fact_x,fact_y,fact_z){fact_x*=EYE_KEY_TRANS_FACTOR;fact_y*=EYE_KEY_TRANS_FACTOR;fact_z*=EYE_KEY_TRANS_FACTOR;m_trans.move_local(camobj,fact_x,fact_y,fact_z)}function calc_fact_from(fact_to){return fact_to/(1-fact_to)}function trans_targ_cam_local(camobj,fact_view,elapsed){var dist=m_cam.target_get_distance(camobj);var abs_fact_view=Math.abs(fact_view);
var fact=Math.pow(abs_fact_view*elapsed,TARGET_KEY_ZOOM_POW1-Math.pow(abs_fact_view*elapsed,TARGET_KEY_ZOOM_POW2));if(fact_view<0)if(dist>EPSILON_DISTANCE)fact_view=-dist*fact;else fact_view=0;else fact_view=dist*calc_fact_from(fact);m_trans.move_local(camobj,0,fact_view,0)}function get_dest_mouse_touch(obj,value,fact,dist,dest_value){var t_mult=dist*fact;for(var i=value;i>0;--i){dist+=t_mult;dest_value+=t_mult;t_mult=dist*fact}return dest_value}function get_dest_zoom(obj,value,velocity_zoom,dest_value,
dev_fact,use_pivot){if(use_pivot){var cam_pivot=m_cam.target_get_pivot(obj,_vec3_tmp);var cam_eye=m_cam.get_translation(obj);var dist=m_vec3.dist(cam_pivot,cam_eye)+dest_value;if(value>0)dest_value=get_dest_mouse_touch(obj,value,-velocity_zoom,dist,dest_value);else dest_value=get_dest_mouse_touch(obj,-value,calc_fact_from(velocity_zoom),dist,dest_value)}else dest_value-=value*dev_fact*velocity_zoom;return dest_value}exports.enable_camera_controls=enable_camera_controls;function enable_camera_controls(disable_default_pivot,
disable_letter_controls,disable_zoom,element,allow_element_exit){_disable_default_pivot=disable_default_pivot;_disable_letter_controls=disable_letter_controls;_disable_zoom=disable_zoom;var obj=m_scs.get_active_camera();enable_cam_controls_resetting(obj);var use_pivot=false;var character=null;var use_hover=false;switch(m_cam.get_move_style(obj)){case m_cam.MS_TARGET_CONTROLS:var use_pivot=!disable_default_pivot;break;case m_cam.MS_EYE_CONTROLS:var character=m_scs.get_first_character();break;case m_cam.MS_STATIC:return;
case m_cam.MS_HOVER_CONTROLS:var use_hover=true;break}var velocity=m_cam.get_velocities(obj,_velocity_tmp);var elapsed=m_ctl.create_elapsed_sensor();if(m_phy.has_simulated_physics(obj)){var collision=m_ctl.create_collision_sensor(obj,null,true);var collision_cb=function(obj,id,pulse){var coll_dist=m_ctl.get_sensor_payload(obj,id,0).coll_dist;if(coll_dist<0){var coll_norm=m_ctl.get_sensor_payload(obj,id,0).coll_norm;var recover_offset=_vec3_tmp;m_vec3.scale(coll_norm,-.25*coll_dist,recover_offset);
var trans=m_trans.get_translation(obj,_vec3_tmp2);m_vec3.add(trans,recover_offset,trans);m_trans.set_translation_v(obj,trans)}};m_ctl.create_sensor_manifold(obj,"CAMERA_COLLISION",m_ctl.CT_POSITIVE,[collision],null,collision_cb)}if(character){var trans=m_trans.get_translation(obj);var quat=m_trans.get_rotation(obj);var char_quat=m_util.cam_quat_to_mesh_quat(quat);trans[1]-=CHAR_HEAD_POSITION;m_phy.set_transform(character,trans,char_quat);m_cons.append_stiff_trans(obj,character,[0,.5,0]);var char_dir=
new Float32Array(2);var is_fly=true;m_phy.set_character_move_type(character,m_phy.CM_FLY);var move_type_cb=function(){is_fly=!is_fly;m_phy.set_character_move_type(character,is_fly?m_phy.CM_FLY:m_phy.CM_WALK)};m_ctl.create_kb_sensor_manifold(obj,"TOGGLE_CHAR_MOVE_TYPE",m_ctl.CT_SHOT,m_ctl.KEY_C,move_type_cb)}var key_cb=function(obj,id,pulse){if(pulse==1){var elapsed=m_ctl.get_sensor_value(obj,id,0);m_cam.get_velocities(obj,velocity);switch(id){case "FORWARD":if(character)char_dir[0]=1;else if(use_hover){var hover_angle=
m_cam.get_camera_angles(obj,_vec2_tmp2)[1];var axis=Math.abs(hover_angle)>=Math.PI/4?m_util.AXIS_MZ:m_util.AXIS_MY;trans_hover_cam_horiz_local(obj,axis,velocity.trans*HOVER_KEY_TRANS_FACTOR*elapsed)}else if(use_pivot)trans_targ_cam_local(obj,-velocity.zoom,elapsed);else trans_eye_cam_local(obj,0,-velocity.trans*elapsed,0);break;case "BACKWARD":if(character)char_dir[0]=-1;else if(use_hover){var hover_angle=m_cam.get_camera_angles(obj,_vec2_tmp2)[1];var axis=Math.abs(hover_angle)>=Math.PI/4?m_util.AXIS_Z:
m_util.AXIS_Y;trans_hover_cam_horiz_local(obj,axis,velocity.trans*HOVER_KEY_TRANS_FACTOR*elapsed)}else if(use_pivot)trans_targ_cam_local(obj,velocity.zoom,elapsed);else trans_eye_cam_local(obj,0,velocity.trans*elapsed,0);break;case "UP":if(use_hover)zoom_hover_cam(obj,-velocity.zoom*HOVER_KEY_ZOOM_FACTOR*elapsed);else if(!character)trans_eye_cam_local(obj,0,0,-velocity.trans*elapsed);break;case "DOWN":if(use_hover)zoom_hover_cam(obj,velocity.zoom*HOVER_KEY_ZOOM_FACTOR*elapsed);else if(!character)trans_eye_cam_local(obj,
0,0,velocity.trans*elapsed);break;case "LEFT":if(character)char_dir[1]=1;else if(use_hover)trans_hover_cam_horiz_local(obj,m_util.AXIS_MX,velocity.trans*HOVER_KEY_TRANS_FACTOR*elapsed);else trans_eye_cam_local(obj,-velocity.trans*elapsed,0,0);break;case "RIGHT":if(character)char_dir[1]=-1;else if(use_hover)trans_hover_cam_horiz_local(obj,m_util.AXIS_X,velocity.trans*HOVER_KEY_TRANS_FACTOR*elapsed);else trans_eye_cam_local(obj,velocity.trans*elapsed,0,0);break;case "ROT_LEFT":if(use_pivot)m_cam.target_rotate(obj,
-velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);else m_cam.eye_rotate(obj,velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);break;case "ROT_RIGHT":if(use_pivot)m_cam.target_rotate(obj,velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);else m_cam.eye_rotate(obj,-velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed,0);break;case "ROT_UP":if(use_pivot)m_cam.target_rotate(obj,0,-velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed);else m_cam.eye_rotate(obj,0,velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed);break;
case "ROT_DOWN":if(use_pivot)m_cam.target_rotate(obj,0,velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed);else m_cam.eye_rotate(obj,0,-velocity.rot*TARGET_EYE_KEY_ROT_FACTOR*elapsed);break;default:break}}else switch(id){case "FORWARD":case "BACKWARD":if(character)char_dir[0]=0;break;case "LEFT":case "RIGHT":if(character)char_dir[1]=0;break}if(character){m_phy.set_character_move_dir(character,char_dir[0],char_dir[1]);var angles=m_cam.get_camera_angles_char(obj,_vec2_tmp);m_phy.set_character_rotation(character,
angles[0],angles[1])}};var gmpd_indices=m_input.check_enable_gamepad_indices();if(gmpd_indices.length)var gamepad_id=gmpd_indices[gmpd_indices.length-1];else var gamepad_id=0;var key_w,key_s,key_a,key_d,key_r,key_f,gmpd_btn_6,gmpd_btn_7;if(!disable_letter_controls){key_w=m_ctl.create_keyboard_sensor(m_ctl.KEY_W);key_s=m_ctl.create_keyboard_sensor(m_ctl.KEY_S);key_a=m_ctl.create_keyboard_sensor(m_ctl.KEY_A);key_d=m_ctl.create_keyboard_sensor(m_ctl.KEY_D);key_r=m_ctl.create_keyboard_sensor(m_ctl.KEY_R);
key_f=m_ctl.create_keyboard_sensor(m_ctl.KEY_F);gmpd_btn_6=m_ctl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_6,gamepad_id);gmpd_btn_7=m_ctl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_7,gamepad_id)}else key_w=key_s=key_a=key_d=key_r=key_f=gmpd_btn_6=gmpd_btn_7=m_ctl.create_custom_sensor(0);var key_up=m_ctl.create_keyboard_sensor(m_ctl.KEY_UP);var key_down=m_ctl.create_keyboard_sensor(m_ctl.KEY_DOWN);var key_left=m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT);var key_right=m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT);
var lh_axis=m_ctl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_0,gmpd_indices);var lv_axis=m_ctl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_1,gmpd_indices);var rh_axis=m_ctl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_2,gmpd_indices);var rv_axis=m_ctl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_3,gmpd_indices);var key_single_logic=null;var key_double_logic=function(s){return s[0]&&(s[1]||s[2])};var key_triple_logic=function(s){return s[0]&&(s[1]||s[2]||s[3])};var key_double_pos_logic=function(s){return s[0]&&
(s[1]||s[2]>AXIS_THRESHOLD)};var key_double_neg_logic=function(s){return s[0]&&(s[1]||s[2]<-AXIS_THRESHOLD)};var key_triple_pos_logic=function(s){return s[0]&&(s[1]||s[2]||s[3]>AXIS_THRESHOLD)};var key_triple_neg_logic=function(s){return s[0]&&(s[1]||s[2]||s[3]<-AXIS_THRESHOLD)};if(!use_hover){m_ctl.create_sensor_manifold(obj,"FORWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_w,lv_axis],key_double_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"BACKWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_s,lv_axis],key_double_pos_logic,
key_cb)}if(use_pivot){m_ctl.create_sensor_manifold(obj,"ROT_UP",m_ctl.CT_CONTINUOUS,[elapsed,key_up,key_r,rv_axis],key_triple_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_down,key_f,rv_axis],key_triple_pos_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_left,key_a,rh_axis],key_triple_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_right,key_d,rh_axis],key_triple_pos_logic,
key_cb)}else if(use_hover){m_ctl.create_sensor_manifold(obj,"LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_left,key_a,lh_axis],key_triple_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_right,key_d,lh_axis],key_triple_pos_logic,key_cb);m_ctl.create_sensor_manifold(obj,"FORWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_up,key_w,lv_axis],key_triple_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"BACKWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_down,key_s,lv_axis],key_triple_pos_logic,
key_cb);m_ctl.create_sensor_manifold(obj,"UP",m_ctl.CT_CONTINUOUS,[elapsed,key_f,rv_axis],key_double_pos_logic,key_cb);m_ctl.create_sensor_manifold(obj,"DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_r,rv_axis],key_double_neg_logic,key_cb)}else{m_ctl.create_sensor_manifold(obj,"UP",m_ctl.CT_CONTINUOUS,[elapsed,key_r,gmpd_btn_6],key_triple_logic,key_cb);m_ctl.create_sensor_manifold(obj,"DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_f,gmpd_btn_7],key_triple_logic,key_cb);m_ctl.create_sensor_manifold(obj,"LEFT",m_ctl.CT_CONTINUOUS,
[elapsed,key_a,lh_axis],key_double_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_d,lh_axis],key_double_pos_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_UP",m_ctl.CT_CONTINUOUS,[elapsed,key_up,rv_axis],key_double_neg_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_DOWN",m_ctl.CT_CONTINUOUS,[elapsed,key_down,rv_axis],key_double_pos_logic,key_cb);m_ctl.create_sensor_manifold(obj,"ROT_LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_left,rh_axis],key_double_neg_logic,
key_cb);m_ctl.create_sensor_manifold(obj,"ROT_RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_right,rh_axis],key_double_pos_logic,key_cb)}if(!disable_zoom){var dest_zoom_mouse=0;var mouse_wheel=m_ctl.create_mouse_wheel_sensor(element);var dest_zoom_touch=0;var touch_zoom=m_ctl.create_touch_zoom_sensor(element);var mouse_wheel_cb=function(obj,id,pulse){if(pulse==1){var value=m_ctl.get_sensor_value(obj,id,0);m_cam.get_velocities(obj,velocity);if(use_pivot||use_hover)dest_zoom_mouse=get_dest_zoom(obj,value,
velocity.zoom,dest_zoom_mouse,HOVER_MOUSE_ZOOM_FACTOR,use_pivot);else{var factor=value*velocity.zoom;velocity.trans*=1+factor;m_cam.set_velocities(obj,velocity)}}};m_ctl.create_sensor_manifold(obj,"MOUSE_WHEEL",m_ctl.CT_LEVEL,[mouse_wheel],null,mouse_wheel_cb);var touch_zoom_cb=function(obj,id,pulse,param){if(pulse==1){var value=m_ctl.get_sensor_value(obj,id,0);m_cam.get_velocities(obj,velocity);if(m_ctl.get_sensor_payload(obj,id,0)===m_ctl.PL_MULTITOUCH_MOVE_ZOOM)dest_zoom_touch=get_dest_zoom(obj,
value,velocity.zoom*TARGET_TOUCH_ZOOM_FACTOR,dest_zoom_touch,HOVER_TOUCH_ZOOM_FACTOR,use_pivot)}};m_ctl.create_sensor_manifold(obj,"TOUCH_ZOOM",m_ctl.CT_LEVEL,[touch_zoom],null,touch_zoom_cb);var zoom_interp_cb=function(obj,id,pulse){if(use_pivot||use_hover)if(Math.abs(dest_zoom_mouse)>EPSILON_DELTA||Math.abs(dest_zoom_touch)>EPSILON_DELTA){var value=m_ctl.get_sensor_value(obj,id,0);var zoom_mouse=m_util.smooth(dest_zoom_mouse,0,value,smooth_coeff_zoom_mouse());dest_zoom_mouse-=zoom_mouse;var zoom_touch=
m_util.smooth(dest_zoom_touch,0,value,smooth_coeff_zoom_touch());dest_zoom_touch-=zoom_touch;if(use_hover)zoom_hover_cam(obj,-(zoom_mouse+zoom_touch));else{var res_dist=m_cam.target_get_distance(obj)+zoom_mouse+zoom_touch;res_dist=Math.max(res_dist,EPSILON_DISTANCE);m_cam.target_set_distance(obj,res_dist)}}else{dest_zoom_mouse=0;dest_zoom_touch=0}};m_ctl.create_sensor_manifold(obj,"ZOOM_INTERPOL",m_ctl.CT_POSITIVE,[elapsed],null,zoom_interp_cb)}var dest_x_mouse=0;var dest_y_mouse=0;var dest_pan_x_mouse=
0;var dest_pan_y_mouse=0;var mouse_cb=function(obj,id,pulse,param){if(pulse==1){var value=m_ctl.get_sensor_value(obj,id,1);m_cam.get_velocities(obj,velocity);if(!use_hover){var left_mult=TARGET_EYE_MOUSE_ROT_MULT_PX*velocity.rot;var right_mult=TARGET_EYE_MOUSE_PAN_MULT_PX*velocity.trans}else{var left_mult=HOVER_MOUSE_PAN_MULT_PX*velocity.trans;var right_mult=HOVER_MOUSE_ROT_MULT_PX*velocity.rot}if(m_ctl.get_sensor_payload(obj,id,0)===1){dest_x_mouse+=param=="X"?-value*left_mult:0;dest_y_mouse+=param==
"Y"?-value*left_mult:0}else if(m_ctl.get_sensor_payload(obj,id,0)===2||m_ctl.get_sensor_payload(obj,id,0)===3){dest_pan_x_mouse+=param=="X"?-value*right_mult:0;dest_pan_y_mouse+=param=="Y"?-value*right_mult:0}}};var dest_pan_x_gmpd=0;var dest_pan_y_gmpd=0;var gmpd_panning_x_pos_cb=function(obj,id,pulse){m_cam.get_velocities(obj,velocity);dest_pan_x_gmpd+=velocity.trans*TRANS_GMPD_KOEF};var gmpd_panning_y_pos_cb=function(obj,id,pulse){m_cam.get_velocities(obj,velocity);dest_pan_y_gmpd+=velocity.zoom*
ZOOM_GMPD_KOEF};var gmpd_panning_x_neg_cb=function(obj,id,pulse){m_cam.get_velocities(obj,velocity);dest_pan_x_gmpd-=velocity.trans*TRANS_GMPD_KOEF};var gmpd_panning_y_neg_cb=function(obj,id,pulse){m_cam.get_velocities(obj,velocity);dest_pan_y_gmpd-=velocity.zoom*ZOOM_GMPD_KOEF};if(use_pivot){m_ctl.create_sensor_manifold(obj,"GMPD_PAN_Y_POS",m_ctl.CT_CONTINUOUS,[gmpd_btn_6],null,gmpd_panning_y_pos_cb);m_ctl.create_sensor_manifold(obj,"GMPD_PAN_Y_NEG",m_ctl.CT_CONTINUOUS,[gmpd_btn_7],null,gmpd_panning_y_neg_cb);
m_ctl.create_sensor_manifold(obj,"GMPD_PAN_X_POS",m_ctl.CT_CONTINUOUS,[lh_axis],function(s){return s[0]<-AXIS_THRESHOLD},gmpd_panning_x_neg_cb);m_ctl.create_sensor_manifold(obj,"GMPD_PAN_X_NEG",m_ctl.CT_CONTINUOUS,[lh_axis],function(s){return s[0]>AXIS_THRESHOLD},gmpd_panning_x_pos_cb)}else if(use_hover){m_ctl.create_sensor_manifold(obj,"GMPD_PAN_X_POS",m_ctl.CT_CONTINUOUS,[rh_axis],function(s){return s[0]<-AXIS_THRESHOLD},gmpd_panning_x_neg_cb);m_ctl.create_sensor_manifold(obj,"GMPD_PAN_X_NEG",m_ctl.CT_CONTINUOUS,
[rh_axis],function(s){return s[0]>AXIS_THRESHOLD},gmpd_panning_x_pos_cb)}if(allow_element_exit){var mouse_move_x=m_ctl.create_mouse_move_sensor("X",window);var mouse_move_y=m_ctl.create_mouse_move_sensor("Y",window);var mouse_down_c=m_ctl.create_mouse_click_sensor(element);var mouse_down_w=m_ctl.create_mouse_click_sensor(window);var element_exit_state=false;var element_exit_logic=function(s){if(s[2])element_exit_state=true;else if(!s[0])element_exit_state=false;return element_exit_state&&s[0]};m_ctl.create_sensor_manifold(obj,
"MOUSE_X",m_ctl.CT_POSITIVE,[mouse_down_w,mouse_move_x,mouse_down_c],element_exit_logic,mouse_cb,"X");m_ctl.create_sensor_manifold(obj,"MOUSE_Y",m_ctl.CT_POSITIVE,[mouse_down_w,mouse_move_y,mouse_down_c],element_exit_logic,mouse_cb,"Y");var device=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,window);m_input.switch_prevent_default(device,false)}else{var mouse_move_x=m_ctl.create_mouse_move_sensor("X",element);var mouse_move_y=m_ctl.create_mouse_move_sensor("Y",element);var mouse_down=m_ctl.create_mouse_click_sensor(element);
m_ctl.create_sensor_manifold(obj,"MOUSE_X",m_ctl.CT_LEVEL,[mouse_down,mouse_move_x],null,mouse_cb,"X");m_ctl.create_sensor_manifold(obj,"MOUSE_Y",m_ctl.CT_LEVEL,[mouse_down,mouse_move_y],null,mouse_cb,"Y")}var dest_x_touch=0;var dest_y_touch=0;var dest_pan_x_touch=0;var dest_pan_y_touch=0;var touch_move_x=m_ctl.create_touch_move_sensor("X",element);var touch_move_y=m_ctl.create_touch_move_sensor("Y",element);var touch_cb=function(obj,id,pulse,param){if(pulse==1){m_cam.get_velocities(obj,velocity);
if(use_hover)var r_mult=HOVER_TOUCH_PAN_MULT_PX*velocity.trans;else var r_mult=TARGET_EYE_TOUCH_ROT_MULT_PX*velocity.rot;var value=m_ctl.get_sensor_value(obj,id,0);if(m_ctl.get_sensor_payload(obj,id,0)===m_ctl.PL_SINGLE_TOUCH_MOVE){dest_x_touch+=param=="X"?-value*r_mult:0;dest_y_touch+=param=="Y"?-value*r_mult:0}else if(m_ctl.get_sensor_payload(obj,id,0)===m_ctl.PL_MULTITOUCH_MOVE_PAN){if(!use_hover)var pan_mult=TARGET_EYE_TOUCH_PAN_MULT_PX*velocity.trans;else var pan_mult=HOVER_TOUCH_ROT_MULT_PX*
velocity.rot;dest_pan_x_touch+=param=="X"?-value*pan_mult:0;dest_pan_y_touch+=param=="Y"?-value*pan_mult:0}}};m_ctl.create_sensor_manifold(obj,"TOUCH_X",m_ctl.CT_LEVEL,[touch_move_x],null,touch_cb,"X");m_ctl.create_sensor_manifold(obj,"TOUCH_Y",m_ctl.CT_LEVEL,[touch_move_y],null,touch_cb,"Y");var rot_trans_interp_cb=function(obj,id,pulse){if(Math.abs(dest_x_mouse)>EPSILON_DELTA||Math.abs(dest_y_mouse)>EPSILON_DELTA||Math.abs(dest_x_touch)>EPSILON_DELTA||Math.abs(dest_y_touch)>EPSILON_DELTA||Math.abs(dest_pan_x_mouse)>
EPSILON_DELTA||Math.abs(dest_pan_y_mouse)>EPSILON_DELTA||Math.abs(dest_pan_x_touch)>EPSILON_DELTA||Math.abs(dest_pan_y_touch)>EPSILON_DELTA||Math.abs(dest_pan_x_gmpd)>EPSILON_DELTA||Math.abs(dest_pan_y_gmpd)>EPSILON_DELTA){var value=m_ctl.get_sensor_value(obj,id,0);var x_mouse=m_util.smooth(dest_x_mouse,0,value,smooth_coeff_rot_trans_mouse());var y_mouse=m_util.smooth(dest_y_mouse,0,value,smooth_coeff_rot_trans_mouse());dest_x_mouse-=x_mouse;dest_y_mouse-=y_mouse;var x_touch=m_util.smooth(dest_x_touch,
0,value,smooth_coeff_rot_trans_touch());var y_touch=m_util.smooth(dest_y_touch,0,value,smooth_coeff_rot_trans_touch());dest_x_touch-=x_touch;dest_y_touch-=y_touch;var trans_x_mouse=m_util.smooth(dest_pan_x_mouse,0,value,smooth_coeff_rot_trans_mouse());var trans_y_mouse=m_util.smooth(dest_pan_y_mouse,0,value,smooth_coeff_rot_trans_mouse());dest_pan_x_mouse-=trans_x_mouse;dest_pan_y_mouse-=trans_y_mouse;var trans_x_touch=m_util.smooth(dest_pan_x_touch,0,value,smooth_coeff_rot_trans_touch());var trans_y_touch=
m_util.smooth(dest_pan_y_touch,0,value,smooth_coeff_rot_trans_touch());dest_pan_x_touch-=trans_x_touch;dest_pan_y_touch-=trans_y_touch;var trans_x_gmpd=m_util.smooth(dest_pan_x_gmpd,0,value,smooth_coeff_rot_trans_mouse());var trans_y_gmpd=m_util.smooth(dest_pan_y_gmpd,0,value,smooth_coeff_rot_trans_mouse());dest_pan_x_gmpd-=trans_x_gmpd;dest_pan_y_gmpd-=trans_y_gmpd;if(use_pivot){m_cam.target_rotate(obj,x_mouse+x_touch,y_mouse+y_touch);var dist=m_cam.target_get_distance(obj);m_cam.target_pan_pivot(obj,
dist*(trans_x_mouse+trans_x_touch+trans_x_gmpd),dist*(trans_y_mouse+trans_y_touch+trans_y_gmpd))}else if(use_hover){if(x_mouse+x_touch)trans_hover_cam_horiz_local(obj,m_util.AXIS_X,(x_mouse+x_touch)*HOVER_MOUSE_TOUCH_TRANS_FACTOR);if(y_mouse+y_touch){var hover_angle=m_cam.get_camera_angles(obj,_vec2_tmp2)[1];var axis=Math.abs(hover_angle)>Math.PI/4?m_util.AXIS_Z:m_util.AXIS_Y;trans_hover_cam_horiz_local(obj,axis,(y_mouse+y_touch)*HOVER_MOUSE_TOUCH_TRANS_FACTOR)}m_cam.hover_rotate(obj,trans_x_mouse+
trans_x_touch+trans_x_gmpd,0)}else{m_cam.eye_rotate(obj,(x_mouse+x_touch)*EYE_ROTATION_DECREMENT,(y_mouse+y_touch)*EYE_ROTATION_DECREMENT);if(character){var angles=m_cam.get_camera_angles_char(obj,_vec2_tmp);m_phy.set_character_rotation(character,angles[0],angles[1])}}}};m_ctl.create_sensor_manifold(obj,"ROT_TRANS_INTERPOL",m_ctl.CT_POSITIVE,[elapsed],null,rot_trans_interp_cb);m_ctl.create_kb_sensor_manifold(obj,"DEC_STEREO_DIST",m_ctl.CT_SHOT,m_ctl.KEY_LEFT_SQ_BRACKET,function(obj,id,pulse){var dist=
m_cam.get_stereo_distance(obj);m_cam.set_stereo_distance(obj,.9*dist)});m_ctl.create_kb_sensor_manifold(obj,"INC_STEREO_DIST",m_ctl.CT_SHOT,m_ctl.KEY_RIGHT_SQ_BRACKET,function(obj,id,pulse){var dist=m_cam.get_stereo_distance(obj);m_cam.set_stereo_distance(obj,1.1*dist)})}function enable_cam_controls_resetting(cam){var prev_ms=m_cam.get_move_style(cam);var move_style_cb=function(){var curr_ms=m_cam.get_move_style(cam);var is_changed=curr_ms!=prev_ms;prev_ms=curr_ms;return is_changed};var cb_sensor=
m_ctl.create_callback_sensor(move_style_cb);function reset_controls_cb(cam,id,pulse){disable_camera_controls();enable_camera_controls(_disable_default_pivot,_disable_letter_controls,_disable_zoom)}m_ctl.create_sensor_manifold(cam,"CHANGE_MOVE_STYLE",m_ctl.CT_POSITIVE,[cb_sensor],null,reset_controls_cb)}exports.disable_camera_controls=disable_camera_controls;function disable_camera_controls(){var cam=m_scs.get_active_camera();var cam_std_manifolds=["FORWARD","BACKWARD","ROT_UP","ROT_DOWN","ROT_LEFT",
"ROT_RIGHT","UP","DOWN","LEFT","RIGHT","MOUSE_WHEEL","TOUCH_ZOOM","ZOOM_INTERPOL","MOUSE_X","MOUSE_Y","TOUCH_X","TOUCH_Y","ROT_TRANS_INTERPOL","CHANGE_MOVE_STYLE"];for(var i=0;i<cam_std_manifolds.length;i++)m_ctl.remove_sensor_manifold(cam,cam_std_manifolds[i]);if(m_cam.get_move_style(cam)==m_cam.MS_EYE_CONTROLS&&m_scs.get_first_character())m_cons.remove(cam)}exports.set_camera_move_style=function(move_style){m_print.error_deprecated_arr("app.set_camera_move_style",["camera.static_setup","camera.eye_setup",
"camera.target_setup","camera.hover_setup","camera.hover_setup_rel"]);var camera=m_scs.get_active_camera();m_cam.set_move_style(camera,move_style)};exports.enable_object_controls=function(obj,element){var trans_speed=1;var is_vehicle=m_phy.is_vehicle_chassis(obj)||m_phy.is_vehicle_hull(obj);var key_cb=function(obj,id,pulse){if(pulse==1){var elapsed=m_ctl.get_sensor_value(obj,id,0);switch(id){case "FORWARD":if(is_vehicle)m_phy.vehicle_throttle(obj,1);else m_trans.move_local(obj,0,0,trans_speed*elapsed);
break;case "BACKWARD":if(is_vehicle)m_phy.vehicle_throttle(obj,-1);else m_trans.move_local(obj,0,0,-trans_speed*elapsed);break;case "LEFT":if(is_vehicle)m_phy.vehicle_steer(obj,-1);else m_trans.move_local(obj,trans_speed*elapsed,0,0);break;case "RIGHT":if(is_vehicle)m_phy.vehicle_steer(obj,1);else m_trans.move_local(obj,-trans_speed*elapsed,0,0);break;default:break}}else switch(id){case "FORWARD":case "BACKWARD":if(is_vehicle)m_phy.vehicle_throttle(obj,0);break;case "LEFT":case "RIGHT":if(is_vehicle)m_phy.vehicle_steer(obj,
0);break;default:break}};var elapsed=m_ctl.create_elapsed_sensor();var key_w=m_ctl.create_keyboard_sensor(m_ctl.KEY_W);var key_s=m_ctl.create_keyboard_sensor(m_ctl.KEY_S);var key_a=m_ctl.create_keyboard_sensor(m_ctl.KEY_A);var key_d=m_ctl.create_keyboard_sensor(m_ctl.KEY_D);var key_up=m_ctl.create_keyboard_sensor(m_ctl.KEY_UP);var key_down=m_ctl.create_keyboard_sensor(m_ctl.KEY_DOWN);var key_left=m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT);var key_right=m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT);
var key_logic=function(s){return s[0]&&(s[1]||s[2])};m_ctl.create_sensor_manifold(obj,"FORWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_w,key_up],key_logic,key_cb);m_ctl.create_sensor_manifold(obj,"BACKWARD",m_ctl.CT_CONTINUOUS,[elapsed,key_s,key_down],key_logic,key_cb);m_ctl.create_sensor_manifold(obj,"LEFT",m_ctl.CT_CONTINUOUS,[elapsed,key_a,key_left],key_logic,key_cb);m_ctl.create_sensor_manifold(obj,"RIGHT",m_ctl.CT_CONTINUOUS,[elapsed,key_d,key_right],key_logic,key_cb)};exports.disable_object_controls=
function(obj){var obj_std_manifolds=["FORWARD","BACKWARD","LEFT","RIGHT"];for(var i=0;i<obj_std_manifolds.length;i++)m_ctl.remove_sensor_manifold(obj,obj_std_manifolds[i])};exports.enable_controls=function(allow_element_exit){m_print.error_once("app.enable_controls() deprecated")};exports.disable_controls=function(){m_print.error_once("app.disable_controls() deprecated")};exports.enable_debug_controls=function(){m_ctl.create_kb_sensor_manifold(null,"CAMERA_SHOT",m_ctl.CT_SHOT,m_ctl.KEY_K,function(){m_dbg.make_camera_frustum_shot()});
m_ctl.create_kb_sensor_manifold(null,"LIGHT_SHOT",m_ctl.CT_SHOT,m_ctl.KEY_L,function(){m_dbg.make_light_frustum_shot()});m_ctl.create_kb_sensor_manifold(null,"TELEMETRY",m_ctl.CT_SHOT,m_ctl.KEY_T,function(){m_dbg.plot_telemetry()})};exports.request_fullscreen=request_fullscreen;function request_fullscreen(elem,enabled_cb,disabled_cb){enabled_cb=enabled_cb||function(){};disabled_cb=disabled_cb||function(){};function on_fullscreen_change(){if(document.fullscreenElement===elem||document.webkitFullScreenElement===
elem||document.mozFullScreenElement===elem||document.webkitIsFullScreen||document.msFullscreenElement===elem)enabled_cb();else{document.removeEventListener("fullscreenchange",on_fullscreen_change,false);document.removeEventListener("webkitfullscreenchange",on_fullscreen_change,false);document.removeEventListener("mozfullscreenchange",on_fullscreen_change,false);document.removeEventListener("MSFullscreenChange",on_fullscreen_change,false);disabled_cb()}}document.addEventListener("fullscreenchange",
on_fullscreen_change,false);document.addEventListener("webkitfullscreenchange",on_fullscreen_change,false);document.addEventListener("mozfullscreenchange",on_fullscreen_change,false);document.addEventListener("MSFullscreenChange",on_fullscreen_change,false);elem.requestFullScreen=elem.requestFullScreen||elem.webkitRequestFullScreen||elem.mozRequestFullScreen||elem.msRequestFullscreen;elem.requestFullScreen()}exports.exit_fullscreen=exit_fullscreen;function exit_fullscreen(){var exit_fs=document.exitFullscreen||
document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;if(typeof exit_fs!="function")throw"B4W App: exit fullscreen method is not supported";exit_fs.apply(document)}exports.check_fullscreen=check_fullscreen;function check_fullscreen(){var fullscreenEnabled=window.document.fullscreenEnabled||window.document.mozFullScreenEnabled||window.document.msFullscreenEnabled||window.document.webkitFullscreenEnabled;if(fullscreenEnabled)return true;return false}function toggle_camera_collisions_usage(){var camobj=
m_scs.get_active_camera();if(m_anim.is_detect_collisions_used(camobj))m_anim.detect_collisions(camobj,false);else m_anim.detect_collisions(camobj,true)}exports.report_app_error=report_app_error;function report_app_error(text_message,link_message,link,purge_elements){var elem=document.createElement("div");var top_elem=document.createElement("div");var bottom_elem=document.createElement("div");if(purge_elements)for(var i=0;i<purge_elements.length;i++){var purge_elem=document.getElementById(purge_elements[i]);
if(purge_elem)purge_elem.parentNode.removeChild(purge_elem)}elem.style.cssText="z-index:10;width:100%;height:auto;position:absolute;top:50%;margin-top:150px;text-align:center;";top_elem.style.cssText="color:#fff;font-size:24px;";bottom_elem.style.cssText="color:#fff;font-size:20px;";top_elem.innerHTML=text_message;bottom_elem.innerHTML=link_message+"   "+'<a style="color:#fff;font-size:20px;width:100%;" href="'+link+'">'+link.replace("https://www.","")+"</a>";elem.appendChild(top_elem);elem.appendChild(bottom_elem);
document.body.appendChild(elem)}exports.get_url_params=function(allow_param_array){allow_param_array=!!allow_param_array;var url=decodeURIComponent(location.href.toString());if(url.indexOf("?")==-1)return null;var params=url.split("?")[1].split("&");var out={};for(var i=0;i<params.length;i++){var param=params[i].split("=");var prop_name=param[0];if(param.length>1){var prop_val=param[1];if(allow_param_array)if(prop_name in out)out[prop_name].push(prop_val);else out[prop_name]=[prop_val];else out[prop_name]=
prop_val}else if(allow_param_array){if(!(prop_name in out))out[prop_name]=[]}else out[prop_name]=""}return out};exports.css_animate=function(elem,prop,from,to,timeout,opt_prefix,opt_suffix,opt_callback){if(!elem||!prop||!isFinite(from)||!isFinite(to)||!isFinite(timeout))return;opt_prefix=opt_prefix||"";opt_suffix=opt_suffix||"";opt_callback=opt_callback||function(){};var elem_style=elem.style;var vendor_prop=prop.charAt(0).toUpperCase()+prop.slice(1);if(elem_style[prop]!=undefined);else if(elem_style["webkit"+
vendor_prop]!=undefined)prop="webkit"+vendor_prop;else if(elem_style["ms"+vendor_prop]!=undefined)prop="ms"+vendor_prop;else if(elem_style["moz"+vendor_prop]!=undefined)prop="moz"+vendor_prop;else return;function css_anim_cb(val){if(!elem)return;elem_style[prop]=opt_prefix+val+opt_suffix;if(from>to&&val<=to||from<to&&val>=to){elem_style[prop]=opt_prefix+to+opt_suffix;opt_callback()}}animate(elem,from,to,timeout,css_anim_cb)};exports.attr_animate=function(elem,attr_name,from,to,timeout,opt_callback){if(!elem||
!attr_name||!isFinite(from)||!isFinite(to)||!isFinite(timeout))return;opt_callback=opt_callback||function(){};function attr_anim_cb(val){if(!elem)return;if(val>=0)elem.setAttribute(attr_name,val);if(from>to&&val<=to||from<to&&val>=to){elem.setAttribute(attr_name,to);opt_callback()}}animate(elem,from,to,timeout,attr_anim_cb)};function animate(elem,from,to,timeout,anim_cb){var start=performance.now();function cb(){var elapsed_total=performance.now()-start;var value=from+elapsed_total*(to-from)/timeout;
anim_cb(value);if(elapsed_total>=timeout||!elem.parentNode)m_main.remove_loop_cb(cb)}m_main.append_loop_cb(cb)}exports.queue_animate=function(queue){if(!queue.length)return;var queue_obj=queue.shift();var elem=queue_obj.elem;var prop=queue_obj.prop;var from=queue_obj.from;var to=queue_obj.to;var duration=queue_obj.duration;var prefix=queue_obj.opt_prefix;var suffix=queue_obj.opt_suffix;var cb=function(){if(queue_obj.cb)queue_obj.cb();exports.queue_animate(queue)};if(queue_obj.type=="css")exports.css_animate(elem,
prop,from,to,duration,prefix,suffix,cb);else if(queue_obj.type=="attr")exports.attr_animate(elem,prop,from,to,duration,cb)};function smooth_coeff_zoom_mouse(){return CAM_SMOOTH_ZOOM_MOUSE*_smooth_factor}function smooth_coeff_zoom_touch(){return CAM_SMOOTH_ZOOM_TOUCH*_smooth_factor}function smooth_coeff_rot_trans_mouse(){return CAM_SMOOTH_ROT_TRANS_MOUSE*_smooth_factor}function smooth_coeff_rot_trans_touch(){return CAM_SMOOTH_ROT_TRANS_TOUCH*_smooth_factor}exports.set_camera_smooth_factor=function(value){_smooth_factor=
value};exports.get_camera_smooth_factor=function(){return _smooth_factor}};b4w.module["camera_anim"]=function(exports,require){var m_cam=require("camera");var m_ctl=require("controls");var m_print=require("print");var m_scs=require("scenes");var m_time=require("time");var m_trans=require("transform");var m_tsr=require("tsr");var m_util=require("util");var m_vec3=require("vec3");var m_quat=require("quat");var ROTATION_OFFSET=.2;var ROTATION_LIMITS_EPS=1E-6;var DEFAULT_CAM_LIN_SPEED=1;var DEFAULT_CAM_ANGLE_SPEED=.01;var DEFAULT_CAM_ROTATE_TIME=1E3;var _vec2_tmp=new Float32Array(2);
var _vec2_tmp2=new Float32Array(2);var _vec3_tmp=new Float32Array(3);var _vec3_tmp2=new Float32Array(3);var _vec3_tmp3=new Float32Array(3);var _quat4_tmp=new Float32Array(4);var _tsr_tmp=m_tsr.create();var _tsr_tmp2=m_tsr.create();var _tsr_tmp3=m_tsr.create();var _limits_tmp={};var _is_camera_moving=false;var _is_camera_rotating=false;var _is_camera_stop_moving=false;var _is_camera_stop_rotating=false;exports.track_to_target=function(cam_obj,target,rot_speed,zoom_mult,zoom_time,zoom_delay,callback,
zoom_cb){if(!m_cam.is_eye_camera(cam_obj)){m_print.error("track_to_target(): wrong object");return}if(!cam_obj)return;if(!target)return;else if(m_util.is_vector(target))var obj_pos=target;else{var obj_pos=_vec3_tmp3;m_trans.get_object_center(target,false,obj_pos)}var rot_sp=rot_speed||1;var zoom_m=zoom_mult||2;var zoom_t=zoom_time||1;var zoom_d=zoom_delay||1;var def_dir=_vec3_tmp2;def_dir[0]=0;def_dir[1]=-1;def_dir[2]=0;var cam_quat=m_trans.get_rotation(cam_obj);var cam_dir=m_util.quat_to_dir(cam_quat,
def_dir);var cam_angles=m_cam.get_camera_angles(cam_obj,_vec2_tmp);var dir_to_obj=_vec3_tmp;var cam_pos=m_trans.get_translation(cam_obj);m_vec3.subtract(obj_pos,cam_pos,dir_to_obj);m_vec3.normalize(dir_to_obj,dir_to_obj);var rot_quat=m_quat.rotationTo(cam_dir,dir_to_obj,m_quat.create());var quat=_quat4_tmp;m_quat.multiply(rot_quat,cam_quat,quat);m_util.correct_cam_quat_up(quat,false);var sub_vec=_vec3_tmp2;m_vec3.subtract(obj_pos,cam_pos,sub_vec);var zoom_distance=m_vec3.length(sub_vec)*(1-1/zoom_m);
var angle_to_obj_y=Math.asin(dir_to_obj[1]);var angle_to_obj_x=Math.acos(-dir_to_obj[2]/Math.abs(Math.cos(angle_to_obj_y)));if(dir_to_obj[0]>0)angle_to_obj_x=2*Math.PI-angle_to_obj_x;var angle_x=angle_to_obj_x-cam_angles[0];var angle_y=angle_to_obj_y-cam_angles[1];var cam_dir_z=_vec3_tmp3;cam_dir_z[0]=0;cam_dir_z[1]=0;cam_dir_z[2]=-1;var cam_rot_quat=m_trans.get_rotation(cam_obj);var cam_rot_dir=m_util.quat_to_dir(cam_rot_quat,cam_dir_z);if(cam_rot_dir[1]<0){if(cam_dir[1]>0)angle_y=angle_to_obj_y-
Math.PI+cam_angles[1];else angle_y=angle_to_obj_y+Math.PI+cam_angles[1];if(angle_x>0)angle_x=-Math.PI+angle_x;else angle_x=Math.PI+angle_x}else if(Math.abs(angle_x)>Math.PI)if(angle_x>0)angle_x=angle_x-2*Math.PI;else angle_x=angle_x+2*Math.PI;var cur_time=0;var elapsed=m_ctl.create_elapsed_sensor();var rot_end_time_x=Math.abs(angle_x/rot_sp);var rot_end_time_y=Math.abs(angle_y/rot_sp);var rot_end_time=rot_end_time_x>rot_end_time_y?rot_end_time_x:rot_end_time_y;var zoom_end_time=rot_end_time+zoom_t;
var zoom_end_delay=zoom_end_time+zoom_d;var finish_time=zoom_end_delay+zoom_t;var dest_ang_x=angle_x;var dest_ang_y=angle_y;var dest_trans_x=zoom_distance;var smooth_function=function(x){var f=6*x*(1-x);return f};var track_cb=function(obj,id,pulse){if(pulse){if(!m_cam.is_eye_camera(obj)){disable_cb();return}var value=m_ctl.get_sensor_value(obj,id,0);cur_time+=value;if(cur_time<rot_end_time){var delta_x=angle_x/rot_end_time*value;var delta_y=angle_y/rot_end_time*value;var time_ratio=cur_time/rot_end_time;
var slerp=smooth_function(time_ratio);delta_x*=slerp;delta_y*=slerp;dest_ang_x-=delta_x;dest_ang_y-=delta_y;m_cam.eye_rotate(obj,delta_x,delta_y)}else if(cur_time<zoom_end_time){if(dest_ang_x){m_cam.eye_rotate(obj,dest_ang_x,dest_ang_y);dest_ang_x=0;if(zoom_cb)zoom_cb()}var time_ratio=(cur_time-rot_end_time)/zoom_t;var delta=-zoom_distance*value/zoom_t;dest_trans_x-=delta_x;delta*=smooth_function(time_ratio);m_trans.move_local(obj,0,delta,0)}else if(cur_time<zoom_end_delay){if(dest_trans_x){m_trans.move_local(obj,
0,dest_trans_x,0);dest_trans_x=0}}else if(cur_time<finish_time){var time_ratio=(cur_time-zoom_end_delay)/zoom_t;var delta=zoom_distance*value/zoom_t;delta*=smooth_function(time_ratio);m_trans.move_local(obj,0,delta,0)}else{m_trans.set_translation_v(obj,cam_pos);disable_cb()}}};var disable_cb=function(){m_ctl.remove_sensor_manifold(cam_obj,"TRACK_TO_TARGET");if(callback)callback()};m_ctl.create_sensor_manifold(cam_obj,"TRACK_TO_TARGET",m_ctl.CT_CONTINUOUS,[elapsed],null,track_cb)};function init_limited_rotation_ratio(obj,
limits,auto_rotate_ratio){var phi=m_cam.get_camera_angles(obj,_vec2_tmp)[0];var delts=get_delta_to_limits(obj,phi,limits.left,limits.right,_vec2_tmp2);return auto_rotate_ratio*Math.min(1,delts[0]/ROTATION_OFFSET,delts[1]/ROTATION_OFFSET)}function get_delta_to_limits(obj,angle,limit_left,limit_right,dest){var diff_left=m_util.angle_wrap_0_2pi(angle-limit_left);var delta_to_left=Math.min(diff_left,2*Math.PI-diff_left);var diff_right=m_util.angle_wrap_0_2pi(limit_right-angle);var delta_to_right=Math.min(diff_right,
2*Math.PI-diff_right);if(Math.abs(delta_to_left)<ROTATION_LIMITS_EPS||2*Math.PI-Math.abs(delta_to_left)<ROTATION_LIMITS_EPS)delta_to_left=0;if(Math.abs(delta_to_right)<ROTATION_LIMITS_EPS||2*Math.PI-Math.abs(delta_to_right)<ROTATION_LIMITS_EPS)delta_to_right=0;if(m_cam.is_eye_camera(obj)){dest[0]=delta_to_right;dest[1]=delta_to_left}else{dest[0]=delta_to_left;dest[1]=delta_to_right}return dest}exports.auto_rotate=function(auto_rotate_ratio,callback,disable_on_mouse_wheel){callback=callback||function(){};
var obj=m_scs.get_active_camera();if(m_cam.is_static_camera(obj)){m_print.error("auto_rotate(): Wrong camera move style");return}var angle_limits={};var rot_offset=0;var cur_rotate_ratio=0;function update_limited_rotation_params(curr_limits){angle_limits=angle_limits||{};angle_limits.left=curr_limits.left;angle_limits.right=curr_limits.right;rot_offset=Math.min(ROTATION_OFFSET,m_util.angle_wrap_0_2pi(angle_limits.right-angle_limits.left)/2);cur_rotate_ratio=init_limited_rotation_ratio(obj,angle_limits,
auto_rotate_ratio)}function elapsed_cb(obj,id,pulse){if(pulse==1){var move_style=m_cam.get_move_style(obj);if(move_style==m_cam.MS_STATIC)disable_cb();else if((move_style==m_cam.MS_TARGET_CONTROLS||move_style==m_cam.MS_EYE_CONTROLS)&&m_cam.has_horizontal_rot_limits(obj)){var curr_limits=move_style==m_cam.MS_EYE_CONTROLS?m_cam.eye_get_horizontal_limits(obj,_limits_tmp):m_cam.target_get_horizontal_limits(obj,_limits_tmp);if(angle_limits===null||curr_limits.left!=angle_limits.left||curr_limits.right!=
angle_limits.right)update_limited_rotation_params(curr_limits);limited_auto_rotate(obj,id)}else{angle_limits=null;unlimited_auto_rotate(obj,id)}}}function limited_auto_rotate(obj,id){var value=m_ctl.get_sensor_value(obj,id,0);var phi=m_cam.get_camera_angles(obj,_vec2_tmp)[0];var delts=get_delta_to_limits(obj,phi,angle_limits.left,angle_limits.right,_vec2_tmp2);if(delts[1]>rot_offset&&delts[0]>rot_offset)cur_rotate_ratio=m_util.sign(cur_rotate_ratio)*auto_rotate_ratio;else if(delts[1]<rot_offset)cur_rotate_ratio=
cur_rotate_ratio-Math.pow(auto_rotate_ratio,2)/(2*ROTATION_OFFSET)*value;else if(delts[0]<rot_offset)cur_rotate_ratio=cur_rotate_ratio+Math.pow(auto_rotate_ratio,2)/(2*ROTATION_OFFSET)*value;m_cam.rotate_camera(obj,value*cur_rotate_ratio,0)}function unlimited_auto_rotate(obj,id){var value=m_ctl.get_sensor_value(obj,id,0);m_cam.rotate_camera(obj,value*auto_rotate_ratio,0)}function disable_cb(){m_ctl.remove_sensor_manifold(obj,"AUTO_ROTATE");m_ctl.remove_sensor_manifold(obj,"DISABLE_AUTO_ROTATE");callback()}
if(!m_ctl.check_sensor_manifold(obj,"AUTO_ROTATE")){var mouse_move_x=m_ctl.create_mouse_move_sensor("X");var mouse_move_y=m_ctl.create_mouse_move_sensor("Y");var mouse_down=m_ctl.create_mouse_click_sensor();var touch_move=m_ctl.create_touch_move_sensor();var touch_zoom=m_ctl.create_touch_zoom_sensor();var elapsed=m_ctl.create_elapsed_sensor();if(disable_on_mouse_wheel)var wheel_zoom=m_ctl.create_mouse_wheel_sensor();else var wheel_zoom=m_ctl.create_custom_sensor(0);var logic_func=function(s){return s[0]&&
s[2]||s[1]&&s[2]||s[3]||s[4]||s[5]};m_ctl.create_sensor_manifold(obj,"DISABLE_AUTO_ROTATE",m_ctl.CT_LEVEL,[mouse_move_x,mouse_move_y,mouse_down,touch_move,touch_zoom,wheel_zoom],logic_func,disable_cb);m_ctl.create_sensor_manifold(obj,"AUTO_ROTATE",m_ctl.CT_CONTINUOUS,[elapsed],function(s){return s[0]},elapsed_cb)}else disable_cb()};exports.is_auto_rotate=function(){var obj=m_scs.get_active_camera();return m_ctl.check_sensor_manifold(obj,"AUTO_ROTATE")};exports.check_auto_rotate=function(){var obj=
m_scs.get_active_camera();var cam_type=m_cam.get_move_style(obj);if(cam_type==m_cam.MS_STATIC)return false;return true};exports.move_camera_to_point=function(cam_obj,point_obj,cam_lin_speed,cam_angle_speed,cb){if(m_cam.get_move_style(cam_obj)!=m_cam.MS_STATIC){m_print.error("move_camera_to_point(): wrong camera type");return}if(_is_camera_moving)return;if(!cam_obj){m_print.error("move_camera_to_point(): you must specify the camera object");return}if(!point_obj){m_print.error("move_camera_to_point(): you must specify the point object");
return}cam_lin_speed=cam_lin_speed||DEFAULT_CAM_LIN_SPEED;cam_angle_speed=cam_angle_speed||DEFAULT_CAM_ANGLE_SPEED;if(m_util.is_vector(cam_obj))var cam_tsr=cam_obj;else var cam_tsr=m_trans.get_tsr(cam_obj,_tsr_tmp);if(m_util.is_vector(point_obj))var point_tsr=point_obj;else var point_tsr=m_trans.get_tsr(point_obj,_tsr_tmp2);var distance=m_vec3.distance(m_tsr.get_trans_view(cam_tsr),m_tsr.get_trans_view(point_tsr));var move_time=distance/cam_lin_speed;var current_cam_dir=m_util.quat_to_dir(m_tsr.get_quat_view(cam_tsr),
m_util.AXIS_MY,_vec3_tmp);var target_cam_dir=m_util.quat_to_dir(m_tsr.get_quat_view(point_tsr),m_util.AXIS_MY,_vec3_tmp2);var vec_dot=Math.min(Math.abs(m_vec3.dot(current_cam_dir,target_cam_dir)),1);var angle=Math.acos(vec_dot);var rotate_time=angle/cam_angle_speed;var time=Math.max(move_time,rotate_time)*1E3;_is_camera_moving=true;var cur_animator=m_time.animate(0,1,time,function(e){var new_tsr=m_tsr.interpolate(cam_tsr,point_tsr,m_util.smooth_step(e),_tsr_tmp3);if(_is_camera_stop_moving){m_time.clear_animation(cur_animator);
_is_camera_stop_moving=false;_is_camera_moving=false;return}m_trans.set_tsr(cam_obj,new_tsr);if(e==1){_is_camera_moving=false;if(cb)cb()}})};exports.rotate_camera=function(cam_obj,angle_phi,angle_theta,time,cb){if(m_cam.get_move_style(cam_obj)==m_cam.MS_STATIC){m_print.error("rotate_camera(): not supported for STATIC cameras");return}if(_is_camera_rotating)return;if(!cam_obj){m_print.error("rotate_camera(): you must specify the camera object");return}if(!angle_phi&&!angle_theta){m_print.error("rotate_camera(): you must specify the rotation angle");
return}time=time||DEFAULT_CAM_ROTATE_TIME;_is_camera_rotating=true;var delta_phi=0;var delta_theta=0;var angle=angle_phi!=0?angle_phi:angle_theta;var cur_animator=m_time.animate(0,angle,time,function(e){if(_is_camera_stop_rotating){m_time.clear_animation(cur_animator);_is_camera_stop_rotating=false;_is_camera_rotating=false;return}delta_phi-=e;delta_theta-=e;if(angle_theta&&angle_phi)m_cam.rotate_camera(cam_obj,delta_phi,delta_theta);else if(angle_theta)m_cam.rotate_camera(cam_obj,0,delta_theta);
else if(angle_phi)m_cam.rotate_camera(cam_obj,delta_phi,0);delta_phi=e;delta_theta=e;if(e==angle){_is_camera_rotating=false;if(cb)cb()}})};exports.stop_cam_moving=function(){_is_camera_stop_moving=true};exports.stop_cam_rotating=function(){_is_camera_stop_rotating=true};exports.is_moving=function(){return _is_camera_moving};exports.is_rotating=function(){return _is_camera_rotating}};b4w.module["gp_conf"]=function(exports,require){var m_cfg=require("config");var m_cont=require("container");var m_ctrl=require("controls");var m_input=require("input");var m_storage=require("storage");var SVG_BASE64="url('data:image/svg+xml;base64,";var BLUE_COLOR_REGEXP=new RegExp("#5276cf","g");var BLUE_COLOR="#5276cf";var RED_COLOR="#ff0000";var GREEN_COLOR="#00ff00";var GREY_COLOR="#e6e6e6";var SELECT_BTN_CAPTION="Click on the buttons & arrows to setup your controller";var PRESS_BTN_CAPTION="Now press the button on the device";
var MOVE_AXIS_CAPTION="Now move the axis on the device";var MAIN_DEVICE_CAPTION="Select a device";var AXIS_STEP=20;var GMPD_DFLT_STNGS={};GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_12]=m_input.GMPD_BUTTON_12;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_13]=m_input.GMPD_BUTTON_13;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_15]=m_input.GMPD_BUTTON_15;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_14]=m_input.GMPD_BUTTON_14;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_3]=m_input.GMPD_BUTTON_3;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_0]=m_input.GMPD_BUTTON_0;
GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_1]=m_input.GMPD_BUTTON_1;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_2]=m_input.GMPD_BUTTON_2;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_5]=m_input.GMPD_BUTTON_5;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_7]=m_input.GMPD_BUTTON_7;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_4]=m_input.GMPD_BUTTON_4;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_6]=m_input.GMPD_BUTTON_6;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_8]=m_input.GMPD_BUTTON_8;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_9]=m_input.GMPD_BUTTON_9;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_10]=
m_input.GMPD_BUTTON_10;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_11]=m_input.GMPD_BUTTON_11;GMPD_DFLT_STNGS[m_input.GMPD_BUTTON_16]=m_input.GMPD_BUTTON_16;var VIEWER_MODE=0;var BTN_EDIT_MODE=1;var AXIS_EDIT_MODE=2;var gamepad_svg='<svg id="svg26627" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="128.51mm" viewBox="0 0 636.63517 455.33329" width="179.67mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/"><defs id="defs26629"><linearGradient id="linearGradient4691"><stop id="stop4693" offset="0"/><stop id="stop4695" stop-opacity="0" offset="1"/></linearGradient><linearGradient id="linearGradient4358"><stop id="stop4360" stop-color="#2e2e2e" offset="0"/><stop id="stop4362" stop-color="#2e2e2e" stop-opacity="0" offset="1"/></linearGradient><linearGradient id="linearGradient4364" x1="1141.5" xlink:href="#linearGradient4358" gradientUnits="userSpaceOnUse" y1="255.95" gradientTransform="matrix(-1 0 0 1 1531.4 560.1)" x2="1165.2" y2="309.88"/><linearGradient id="linearGradient4368" x1="1141.5" xlink:href="#linearGradient4358" gradientUnits="userSpaceOnUse" y1="255.95" gradientTransform="translate(-896.37 560.1)" x2="1165.2" y2="309.88"/><linearGradient id="linearGradient4430" x1="959.32" gradientUnits="userSpaceOnUse" y1="653.07" gradientTransform="matrix(-1 0 0 1 1531.4 70.097)" x2="1467.6" y2="653.07"><stop id="stop4426" stop-color="#4f4f4f" offset="0"/><stop id="stop4428" stop-color="#4f4f4f" stop-opacity="0" offset="1"/></linearGradient><linearGradient id="linearGradient4701" x1="529.91" xlink:href="#linearGradient4691" gradientUnits="userSpaceOnUse" y1="111.1" gradientTransform="translate(-52.276 546.89)" x2="481.49" y2="85.746"/><linearGradient id="linearGradient4713" x1="529.91" xlink:href="#linearGradient4691" gradientUnits="userSpaceOnUse" y1="111.1" gradientTransform="matrix(-1 0 0 1 689.01 546.89)" x2="481.49" y2="85.746"/><linearGradient id="linearGradient4725" x1="367.39" xlink:href="#linearGradient4691" gradientUnits="userSpaceOnUse" y1="125.6" gradientTransform="matrix(-1.3272 0 0 .68317 806.95 579.14)" x2="367.39" y2="116.11"/></defs><metadata id="metadata26632"><rdf:RDF><cc:Work rdf:about="">    <dc:format>image/svg+xml</dc:format>    <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>    <dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -597.03)"><g id="g20" fill-rule="evenodd"><path id="path4209" fill="#434343" d="m576.71 1052.4c42.015-1.9097 64.296-46.468 59.204-122.86-5.0928-76.387-27.374-175.69-44.562-224.7-17.188-49.015-25.501-62.531-26.737-65.565-3.7697-9.2504-11.278-19.949-62.379-27.691-28.97-4.3891-16.697-7.9577-27.084-9.4696-17.96-2.6141-43.609-1.229-52.203 1.6354-8.594 2.8645-12.709 29.16-24.486 35.207-11.777 6.0473-19.416 10.185-80.149 10.185s-68.372-4.1376-80.149-10.185c-11.777-6.0473-18.113-32.099-25.736-36.993-11.183-7.1796-26.985-5.6722-54.891-0.57481-5.64 1.0302-1.1304 7.6212-18.165 12.509-32.913 9.4438-52.094 3.7056-65.087 20.831-1.9807 2.6106-11.822 21.096-29.01 70.111-17.179 48.95-39.46 148.25-44.553 224.64-5.0929 76.39 17.188 120.99 59.204 122.89 73.339-1.7 55.219-116.53 258.4-116.53s185.05 114.82 258.4 116.49z"/><path id="path4366" fill="url(#linearGradient4368)" d="m249.77 838.51c-107.76 0-171.55 96.288-176.84 121.23-5.2294 24.634-17.658 55.705 3.8195 53.789 9.6996-0.8655 18.053-15.713 37.559-38.193 18.78-21.643 41.379-54.425 96.763-54.425s73.209-44.877 75.119-53.152c1.9098-8.2752 2.4146-27.976-36.418-29.25z"/><path id="path4217" fill="url(#linearGradient4364)" d="m385.23 838.51c107.76 0 171.55 96.288 176.84 121.23 5.2293 24.634 17.658 55.705-3.8195 53.789-9.6996-0.8655-18.053-15.713-37.559-38.193-18.78-21.643-41.379-54.425-96.763-54.425s-73.209-44.877-75.119-53.152c-1.9098-8.2752-2.4146-27.976 36.418-29.25z"/><path id="path4370" fill="url(#linearGradient4430)" d="m572.06 654.81c-60.48-19.09-76.79-18.6-89.84-17.96-13.05 0.63657-22.638 16.617-45.237 49.4s-67.48 125.27-116.23 125.27c-48.746 0-93.626-92.491-116.23-125.27-22.599-32.783-32.008-48.942-45.059-49.579-13.05-0.63648-35.251 1.8354-95.728 20.932l1.1161-2.3404c60.494-19.1 81.754-20.83 94.804-20.19 13.05 0.63657 22.281 13.049 44.88 45.832s67.48 123.49 116.23 123.49c48.746 0 93.626-90.709 116.23-123.49 22.599-32.783 31.83-45.195 44.88-45.832 13.05-0.63648 28.783-1.6248 89.26 17.472"/><path id="path4315" fill="#343434" d="m570.99 652.48c-60.477-19.097-76.074-18.269-89.124-17.633-13.05 0.63658-22.281 14.832-44.88 47.614-22.599 32.783-67.48 125.27-116.23 125.27-48.746 0-93.626-92.491-116.23-125.27-22.599-32.783-31.83-46.978-44.88-47.614-13.05-0.63648-34.715 1.2996-95.192 20.396l1.1161-2.3404c60.474-19.1 81.024-22.26 94.074-21.62 13.05 0.63658 22.281 13.049 44.88 45.832s67.48 123.49 116.23 123.49c48.746 0 93.626-90.709 116.23-123.49 22.599-32.783 31.83-45.195 44.88-45.832 13.05-0.63647 27.71-0.17274 88.186 18.924"/></g><g id="g15645" transform="matrix(.75439 0 0 1 1558.5 -6638.3)" fill-rule="evenodd"><rect id="rect15584" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="2" ry="1.8461" height="44.307" width="570" y="6558.3" x="100.71" fill="#4164bb"/><rect id="rect15331" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="2" ry="1.8461" height="44.307" width="570" y="6554.6" x="100.71" fill="#5276cf"/></g><text id="text15623-9" style="word-spacing:0px;letter-spacing:0px" font-weight="300" xml:space="preserve" font-size="22px" line-height="430.99999428%" y="-53.755863" x="1792.7805" font-family="&apos;Noto Sans CJK TC&apos;" fill="#ffffff"><tspan id="tspan15625-5" y="-53.755863" x="1792.7805"/></text><text id="text15657" style="word-spacing:0px;letter-spacing:0px" font-weight="300" xml:space="preserve" font-size="13px" line-height="430.99999428%" y="-3.7607465" x="1670.2437" font-family="&apos;Noto Sans CJK TC&apos;" fill="#828282"><tspan id="tspan15659" y="-3.7607465" x="1670.2437"/></text><g id="g34" fill-rule="evenodd"><path id="path4675" fill="#303030" d="m551.75 628.4c9.3003 4.1796 8.2375 11.558 2.1302 9.9581-6.1073-1.6003-33.792-9.1405-46.239-11.577-12.446-2.4363-34.904-3.0623-36.951-4.0165-2.0474-0.95416 0.93313-7.7247 5.491-7.3449 23.258 0.91012 59.905 6.0339 75.569 12.98z"/><path id="path4677" fill="#303030" d="m474.88 602.61c3.6488 0.63684 4.1169 1.3708 2.4115 5.2499-0.80967 1.8416-1.261 3.904-3.4715 3.7336-4.456-0.34344-16.578-1.2846-25.692-1.3764-9.1139-0.0918-23.83 1.217-25.307 0.79399-1.4771-0.42301-1.8834-4.9141 1.7769-6.7458 4.6221-1.3593 38.698-3.2021 50.281-1.6553z"/><path id="path4699" opacity=".384" fill="url(#linearGradient4701)" d="m475.53 611.7c-11.693-0.63604-8.4597-0.73151-44.068 54.448-6.5182 8.6489-22.874 37.231-36.865 35.326-6.7491-1.4177 15.436-67.299 22.724-75.767 11.112-12.911 19.255-16.122 58.209-14.007z"/><path id="path4703" fill="#303030" d="m84.068 628.4c-9.3003 4.1796-8.2375 11.558-2.1302 9.9581 6.1073-1.6003 33.792-9.1405 46.239-11.577 12.446-2.4363 34.904-3.0623 36.951-4.0165 2.0474-0.95416-0.93313-7.7247-5.491-7.3449-23.258 0.91012-59.905 6.0339-75.569 12.98z"/><path id="path4705" fill="#303030" d="m161.86 602.61c-3.6488 0.63684-4.1169 1.3708-2.4115 5.2499 0.80967 1.8416 1.261 3.904 3.4715 3.7336 4.456-0.34344 16.578-1.2846 25.692-1.3764 9.1139-0.0918 23.83 1.217 25.307 0.79399 1.4771-0.42301 1.8834-4.9141-1.7769-6.7458-4.6221-1.3593-38.698-3.2021-50.281-1.6553z"/><path id="path4711" opacity=".384" fill="url(#linearGradient4713)" d="m161.2 611.7c11.693-0.63604 8.4597-0.73151 44.068 54.448 6.5182 8.6489 22.874 37.231 36.865 35.326 6.7491-1.4177-15.436-67.299-22.724-75.767-11.112-12.911-19.255-16.122-58.209-14.007z"/><path id="path4717" opacity=".115" fill="url(#linearGradient4725)" d="m413.37 645.84c-9.0496 10.007-29.401 19.937-36.775 19.937h-52.205c-31.171 0-37.359 0.34506-47.75 0.51758-10.39 0.17253-18.682 0.65628-23.653-3.278-5.0513-3.9977-24-15.425-24-15.425 53.346 4.1464 144.49 4.3368 184.38-1.7523z"/></g></g><g id="layer1-0" fill-rule="evenodd" transform="translate(159.08 -720.76)"><g id="g4527-3" transform="translate(-961.22,330.69)"><ellipse id="circle4233-8" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="circle4235-8" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="circle4237-7" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g><g id="g4523-1" transform="translate(-961.22,330.69)"><ellipse id="circle4239-4" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="40.057" ry="40.054" cy="655.39" cx="1027.5" fill="#3b63c9"/><ellipse id="circle4243-3" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="36.23" ry="36.228" cy="655.39" cx="1027.5" fill="#5276cf"/></g><g id="g3506" transform="translate(-961.22,330.69)"><ellipse id="ellipse3508" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="ellipse3510" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="ellipse3512" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g></g><g id="layer1-7" fill-rule="evenodd" transform="translate(352.57 -719.72)"><g id="g4527-3-4" transform="translate(-961.22,330.69)"><ellipse id="circle4233-8-8" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="circle4235-8-9" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="circle4237-7-3" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g><g id="g4523-1-1" transform="translate(-961.22,330.69)"><ellipse id="circle4239-4-4" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="40.057" ry="40.054" cy="655.39" cx="1027.5" fill="#3b63c9"/><ellipse id="circle4243-3-5" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="36.23" ry="36.228" cy="655.39" cx="1027.5" fill="#5276cf"/></g><g id="g3506-2" transform="translate(-961.22,330.69)"><ellipse id="ellipse3508-1" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="66.284" ry="66.279" cy="655.39" cx="1027.5" fill="#303030"/><ellipse id="ellipse3510-1" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="62.007" ry="62.003" cy="655.39" cx="1027.5" fill="#4c4c4c"/><ellipse id="ellipse3512-4" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="43.41" ry="43.408" cy="655.39" cx="1027.5" fill="#303030"/></g></g></svg>';
var dpad_svg='<svg id="svg3904" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="35.924mm" width="35.926mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 127.29808 127.28933"><metadata id="metadata3909"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" fill-rule="evenodd" transform="translate(0 -925.07)"><ellipse id="circle4330" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="63.649" ry="63.645" cy="988.72" cx="63.649" fill="#303030"/><ellipse id="circle4223" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="59.705" ry="59.701" cy="988.72" cx="63.649" fill="#4c4c4c"/></g></svg>';
var dpad_up_svg='<svg id="svg3754" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.711mm" width="9.9653mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 35.3101 37.950677"><metadata id="metadata3759"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1014.4)"><path id="path4326" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m34.81 1017.1c-15.254-3.8172-24.634-1.7612-34.31 0v16.247h0.015c-0.013 0.097-0.013 0.1951-0.015 0.2928 0.0006 9.4753 7.6813 18.256 17.156 18.256 9.4739-0.0005 17.154-8.7813 17.154-18.256 0-0.097-0.014-0.1952-0.014-0.2928h0.014z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>';
var dpad_right_svg='<svg id="svg3790" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.9646mm" width="10.711mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 37.953175 35.3077"><metadata id="metadata3795"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1017.1)"><path id="path4324" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m35.298 1017.6c3.8175 15.253 1.7611 24.633 0 34.308h-16.248v-0.015c-0.098 0.01-0.1952 0.01-0.2928 0.015-9.476-0.0006-18.258-7.6807-18.257-17.154 0.0005-9.4733 8.7818-17.153 18.257-17.153 0.098 0 0.1952 0.01 0.2928 0.011v-0.011z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>';
var dpad_down_svg='<svg id="svg3754" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.711mm" width="9.9653mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 35.3101 37.950677"><metadata id="metadata3759"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1014.4)"><path id="path4328" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m34.81 1049.7c-15.254 3.8172-24.634 1.7612-34.31 0v-16.247h0.015c-0.013-0.097-0.013-0.1951-0.015-0.2928 0.0006-9.4753 7.6813-18.256 17.156-18.256 9.4739 0.0005 17.154 8.7813 17.154 18.256 0 0.097-0.014 0.1952-0.014 0.2928h0.014z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>';
var dpad_left_svg='<svg id="svg3790" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.9646mm" width="10.711mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 37.953175 35.3077"><metadata id="metadata3795"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1017.1)"><path id="path4324" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" d="m2.6552 1051.9c-3.8175-15.253-1.7611-24.633 0-34.308h16.248v0.015c0.098-0.01 0.1952-0.01 0.2928-0.015 9.476 0.0006 18.258 7.6807 18.257 17.154-0.0005 9.4733-8.7818 17.153-18.257 17.153-0.098 0-0.1952-0.01-0.2928-0.011v0.011z" fill-rule="evenodd" stroke="#4364b2" stroke-linecap="round" fill="#5276cf"/></g></svg>';
var face_btn_svg='<svg id="svg3548" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="13.417mm" width="13.418mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 47.543997 47.542"><metadata id="metadata3553"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1004.8)"><ellipse id="circle4271" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="23.772" ry="23.771" cy="1028.6" cx="23.772" fill="#303030"/><ellipse id="circle4273" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" stroke-linecap="round" rx="18.668" ry="18.667" stroke="#3b63c9" cy="1028.6" cx="23.772" fill="#5276cf"/></g></svg>';
var analog_btn_svg='<svg id="svg3461" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="22.608mm" width="22.61mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 80.114398 80.108405"><metadata id="metadata3466"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(.0000019915 -972.25)"><g id="g3514-7" fill-rule="evenodd" transform="translate(-987.45 356.91)"><ellipse id="ellipse3516-7" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="40.057" ry="40.054" cy="655.39" cx="1027.5" fill="#3b63c9"/><ellipse id="ellipse3518-7" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="36.23" ry="36.228" cy="655.39" cx="1027.5" fill="#5276cf"/></g></g></svg>';
var start_btn_svg='<svg id="svg3699" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.2811mm" width="9.2817mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 32.8879 32.88565"><metadata id="metadata3704"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" fill-rule="evenodd" transform="translate(0 -1019.5)"><ellipse id="ellipse4575" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="16.444" ry="16.443" cy="1035.9" cx="16.444" fill="#2e2e2e"/><ellipse id="ellipse4577" stroke-linejoin="round" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" stroke-linecap="round" rx="15.112" ry="15.11" stroke="#4364b2" cy="1035.9" cx="16.444" fill="#5276cf"/><ellipse id="ellipse4579" style="color-rendering:auto;color:#000000;isolation:auto;mix-blend-mode:normal;shape-rendering:auto;solid-color:#000000;image-rendering:auto" rx="11.867" ry="11.866" cy="1035.9" cx="16.444" fill="#434343"/></g></svg>';
var trigger_btn_svg='<svg id="svg3560" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="4.7796mm" width="13.57mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 48.082162 16.935645"><metadata id="metadata3565"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1035.4)"><path id="path4727" d="m42.857 1052.2c4.7071 0.4081 4.7981 0.6563 5.1414-4.9139 0.16344-2.6517 0.16699-6.1108-0.72615-8.0342-0.59471-1.2808-1.7793-2.049-3.7642-2.4662-2.5264-0.531-16.253-1.4345-26.685-1.3241-15.118 0.16-15.362 1.4769-15.855 4.1522-0.35071 1.9018-0.5016 3.5056-0.74837 5.5967-0.55261 7.0693-0.44908 7.0921 5.0452 6.5411 11.661-1.1062 25.929-0.7359 37.592 0.4484z" fill-rule="evenodd" fill="#5276cf"/></g></svg>';
var bumper_left_svg='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="21.241671mm" height="8.8544388mm" viewBox="0 0 75.265762 31.373996" id="svg3447" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="l1.svg"><defs id="defs3449" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="1.4" inkscape:cx="-254.57869" inkscape:cy="228.81952" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3452"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(1.5000945e-8,-1020.9882)"><path style="fill:#5276cf;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999994px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="m 11.026383,1051.1651 c -7.4440599,1.9144 -7.5133499,2.2466 -9.7963799,-4.4934 -1.81058997,-5.3452 -2.44278,-8.8152 4.01547,-12.116 2.74038,-1.4007 13.7365799,-5.877 38.4768299,-10.72 24.26031,-4.749 25.16653,-2.7967 26.79132,0.3418 1.15503,2.2311 1.8961,4.1561 2.94279,6.651 3.08552,8.5188 2.92609,8.5778 -6.08214,9.5501 -19.09891,2.1414 -37.95723,5.8307 -56.34789,10.7865 z" id="path4289" inkscape:connector-curvature="0" sodipodi:nodetypes="cssssccc" /></g></svg>';
var bumper_right_svg='<svg id="svg3447" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="8.8544mm" width="21.242mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 75.265762 31.373996"><metadata id="metadata3452"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(1.5001e-8 -1021)"><path id="path4715" d="m64.239 1051.2c7.4441 1.9144 7.5134 2.2466 9.7964-4.4934 1.8106-5.3452 2.4428-8.8152-4.0155-12.116-2.7404-1.4007-13.737-5.877-38.477-10.72-24.26-4.749-25.167-2.7967-26.791 0.3418-1.155 2.2311-1.8961 4.1561-2.9428 6.651-3.0855 8.5188-2.9261 8.5778 6.0822 9.5501 19.099 2.1414 37.957 5.8307 56.348 10.786z" fill-rule="evenodd" fill="#5276cf"/></g></svg>';
var main_svg='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="24.603382mm" height="24.601696mm" viewBox="0 0 87.177338 87.171363" id="svg3640" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="main.svg"><defs id="defs3642" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="1.979899" inkscape:cx="61.113463" inkscape:cy="69.71796" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3645"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(0,-965.19093)"><ellipse ry="43.585682" rx="43.588669" style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#2e2e2e;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999994;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" id="ellipse4372" cx="43.588669" cy="1008.7766" /><ellipse cy="1008.7766" cx="43.588669" id="circle4239-1" style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#5276cf;fill-opacity:1;fill-rule:evenodd;stroke:#4364b2;stroke-width:0.99999994;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" rx="40.056705" ry="40.053959" /><ellipse style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#434343;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999994;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" id="circle4243-0" cx="43.588669" cy="1008.7766" rx="31.455994" ry="31.453836" /></g></svg>';
var axis_setting_svg='<svg id="svg3407" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="41.787mm" width="41.786mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 148.0624 148.06251"><metadata id="metadata3412"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -904.3)" fill="#e6e6e6"><path id="rect4545" d="m74.031 904.3-14.469 22.156h8.0313v8.2187h12.875v-8.2187h8.0625l-14.5-22.156z"/><path id="rect4603" d="m125.94 963.86v8.0313h-8.25v12.906h8.25v8.0313l22.125-14.5-22.125-14.469z"/><path id="rect4609" d="m67.594 1022v8.25h-8.0313l14.469 22.125 14.5-22.125h-8.0625v-8.25h-12.875z"/><path id="rect4615" d="m22.156 963.86-22.156 14.47l22.156 14.5v-8.2188h8.2188v-12.906h-8.2188v-7.8438z"/><path id="path4619" style="color:#000000;text-indent:0;block-progression:tb;text-decoration-line:none;text-transform:none" d="m54.393 924.58c-15.821 5.7885-28.404 18.385-34.188 34.219h11.156c4.6667-10.175 12.865-18.361 23.031-23.031v-11.188zm39.219 0.031v11.156c10.167 4.6713 18.361 12.86 23.031 23.031h11.156c-5.7846-15.821-18.379-28.393-34.188-34.188zm-73.375 73.438c5.7899 15.816 18.348 28.403 34.156 34.188v-11.156c-10.163-4.6691-18.364-12.861-23.031-23.031h-11.125zm96.406 0c-4.6712 10.167-12.868 18.361-23.031 23.031v11.125c15.796-5.7901 28.366-18.352 34.156-34.156h-11.125z"/></g></svg>';
var wheel_svg='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="112.08413mm" height="128.46834mm" viewBox="0 0 397.14849 455.20277" id="svg3440" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="wheel.svg"><defs id="defs3442" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="0.98994949" inkscape:cx="421.01508" inkscape:cy="52.510802" inkscape:document-units="px" inkscape:current-layer="g87" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3445"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title /></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(-2.3645008e-8,-597.15942)"><path inkscape:connector-curvature="0" style="fill:#4d4d4d;stroke:#6e6e6e;stroke-width:2.99125171;stroke-miterlimit:4;stroke-dasharray:none" id="path4140" d="m 307.84153,715.52552 c -4.35995,43.11849 -2.78952,86.66385 -15.90234,128.54337 -10.85452,25.86023 -13.33477,47.2976 6.91492,61.09536 7.23778,50.7442 78.38013,47.39232 82.20535,0 23.06079,-14.19054 13.49405,-42.79138 6.91492,-61.09536 -17.40045,-40.83001 -4.82581,-86.43019 -15.90235,-128.54337 -8.3177,-20.33228 -56.75348,-20.7661 -64.22927,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#cccccc;stroke:#1a1a1a;stroke-width:2.09465766;stroke-miterlimit:4;stroke-dasharray:none" id="path4266" d="m 313.11812,724.1957 -3.84514,68.80568 c 4.64168,13.40814 62.19981,10.8172 61.83082,0 l -3.84515,-68.80568 c -4.46942,-24.00369 -52.58756,-18.95946 -54.13979,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#353535;stroke:#2c2c2c;stroke-width:2.11880326;stroke-miterlimit:4;stroke-dasharray:none" id="path4156" d="m 304.91419,870.673 c -12.36924,67.40381 80.42804,69.69607 70.55134,0 -6.57605,-36.5947 -65.0964,-34.8253 -70.55134,0 z m 60.53812,3.9862 c 8.65841,48.24354 -57.58987,49.86644 -50.52489,0 4.7009,-26.27069 46.6394,-24.84292 50.52489,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#e6e6e6;stroke:#969696;stroke-width:2.99125171;stroke-miterlimit:4;stroke-dasharray:none" id="path4011" d="m 106.04576,696.97906 c -11.197076,4.25792 -17.123706,8.24834 -17.123706,8.24834 l -66.18493,16.33946 1.40291,30.64619 46.54715,-7.67623 c 17.00932,-1.6438 32.551896,8.94676 38.302026,23.34506 l 2.78663,65.4778 27.6363,0 2.78663,-65.4778 c 8.0428,-15.3291 20.46247,-27.10803 38.30202,-23.34506 l 46.54716,7.67623 1.40291,-30.64619 -66.18493,-16.33946 c 0,0 -5.92627,-3.99074 -17.12371,-8.24834 -13.45408,-4.31874 -26.62772,-4.20804 -39.08982,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#252525;stroke:#6e6e6e;stroke-width:2.99125171;stroke-miterlimit:4;stroke-dasharray:none" id="path2996" d="m 38.311064,931.09899 c -8.01574,5.05649 -22.76006,21.74743 -26.34852,58.0567 -4.1290804,35.18581 -4.8394604,60.59901 28.55878,61.68771 l 162.934726,0 c 39.19437,1.1693 30.46155,-41.5992 28.55878,-61.68771 -3.58839,-36.30927 -18.33277,-52.99983 -26.34851,-58.0567 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#373737;stroke:#6e6e6e;stroke-width:2.83429575;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none" id="path3019" d="m 26.230254,979.1291 c -11.50334,14.44882 -11.98241,47.3999 -0.33519,57.1202 l 191.802226,0 c 12.10111,-12.3068 9.93082,-46.99573 -0.33518,-57.1202 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#808080;stroke:#1a1a1a;stroke-width:2.14882827;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0" id="path4133" d="m 360.82498,854.6914 a 20.634815,21.265151 0 1 1 -41.269,0 20.634815,21.265151 0 1 1 41.269,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#333333;stroke:#000000;stroke-width:2.11880326;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0" id="path4280" d="m 351.64051,761.132 a 11.444622,11.75148 0 1 1 -22.88896,0 11.444622,11.75148 0 1 1 22.88896,0 z" stroke-miterlimit="4" /><path inkscape:connector-curvature="0" style="fill:#313131;stroke:#565656;stroke-width:2.93434715;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0" id="path3993" d="m 125.52855,598.62659 c -68.528026,0 -124.0613764,57.81925 -124.0613764,129.13695 0,71.31265 55.5370404,129.13696 124.0613764,129.13696 68.52804,0 124.07984,-57.81926 124.07984,-129.13696 0,-71.31264 -55.55611,-129.13695 -124.07984,-129.13695 z m -1.00095,23.63932 c 10.01261,0.0734 20.238,1.32074 28.95237,3.51006 11.62203,3.80301 21.53624,8.52304 31.01135,16.15381 26.21752,19.0207 43.36275,50.36277 43.36275,85.83029 0,58.01564 -45.80548,105.05244 -102.30928,105.05244 -56.500726,0 -102.309276,-47.03364 -102.309276,-105.05244 0,-32.14848 14.06783,-60.91918 36.22336,-80.19121 11.45168,-11.11714 23.14136,-17.13322 37.3943,-21.79731 7.855846,-2.48302 17.655666,-3.5835 27.668276,-3.51006 z" stroke-miterlimit="4" /><g style="stroke-miterlimit:4;stroke-dasharray:none" id="g4127" stroke-miterlimit="4" transform="matrix(0.61498728,0,0,0.63147657,-18.171616,453.28593)"><g id="g4111"><path style="fill:#808080;stroke:#373737;stroke-width:3.56837296" inkscape:connector-curvature="0" id="rect3040" d="m 110.97,771.16 31.694,4.8776 1.3007,44.257 -32.995,0 z" /><path style="fill:#b3b3b3;stroke:#565656;stroke-width:3.4000001;stroke-linecap:butt;stroke-linejoin:miter" inkscape:connector-curvature="0" id="path3024" d="m 96.83,686.82 58.353,-5.0761 c 15.608,27.569 6.8304,64.333 -5.0761,90.545 l -53.841,-2.538 z" /></g><g id="g4115" transform="translate(97.984785,0)"><path style="fill:#808080;stroke:#373737;stroke-width:3.56837296" inkscape:connector-curvature="0" id="path4117" d="m 110.97,771.16 31.694,4.8776 1.3007,44.257 -32.995,0 z" /><path style="fill:#b3b3b3;stroke:#565656;stroke-width:3.4000001;stroke-linecap:butt;stroke-linejoin:miter" inkscape:connector-curvature="0" id="path4119" d="m 96.83,686.82 58.353,-5.0761 c 15.608,27.569 6.8304,64.333 -5.0761,90.545 l -53.841,-2.538 z" /></g><g id="g4121" transform="translate(195.96959,0)"><path style="fill:#808080;stroke:#373737;stroke-width:3.56837296" inkscape:connector-curvature="0" id="path4123" d="m 110.97,771.16 31.694,4.8776 1.3007,44.257 -32.995,0 z" /><path style="fill:#b3b3b3;stroke:#565656;stroke-width:3.4000001;stroke-linecap:butt;stroke-linejoin:miter" inkscape:connector-curvature="0" id="path4125" d="m 96.83,686.82 58.353,-5.0761 c 15.608,27.569 6.8304,64.333 -5.0761,90.545 l -53.841,-2.538 z" /></g></g><g style="fill:#666666;stroke:#969696;stroke-width:3.99777174;stroke-miterlimit:4;stroke-dasharray:none" id="g4051" transform="translate(-42.878584,98.083591)" stroke-miterlimit="4"><g id="g4437" transform="matrix(0.74686368,0,0,0.74686368,-73.374214,285.30447)"><path inkscape:connector-curvature="0" id="rect4348" style="color:#000000;text-indent:0;text-transform:none;block-progression:tb;fill:#ffffff" d="m 567.31,584.22 0,42.25 0,3.4062 0,42.25 3.375,0 0,-42.25 27.062,0 0,42.25 3.375,0 0,-42.25 27.062,0 0,42.25 3.375,0 0,-42.25 27.062,0 0,42.25 3.4062,0 0,-43.969 0,-1.6875 -1.7188,0 -28.75,0 0,-42.25 -3.375,0 0,42.25 -27.062,0 0,-42.25 -3.375,0 0,42.25 -27.062,0 0,-42.25 -3.375,0 z" /><g style="fill:#a02c2c;stroke:#ffffff;stroke-width:3.4000001;stroke-linecap:square" id="g87" /></g></g></g></svg>';
var wheel_btn='<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="5.4777083mm" height="5.5003009mm" viewBox="0 0 19.409203 19.489255" id="svg3402" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="wheel_btn.svg"><defs id="defs3404" /><sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="22.4" inkscape:cx="4.7324003" inkscape:cy="15.245372" inkscape:document-units="px" inkscape:current-layer="layer1" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:window-width="1920" inkscape:window-height="1134" inkscape:window-x="0" inkscape:window-y="27" inkscape:window-maximized="1" /><metadata id="metadata3407"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(8.5754969e-8,-1032.873)"><path inkscape:connector-curvature="0" style="fill:#5276cf;stroke:#000000;stroke-width:3.4000001;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;fill-opacity:1" id="path4272" d="m 17.709101,1042.6176 a 8.0046,8.0046 0 1 1 -16.0089998,0 8.0046,8.0046 0 1 1 16.0089998,0 z" stroke-miterlimit="4" /></g></svg>';
var wheel_right_svg='<svg id="svg3400" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.507mm" width="15.1mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 53.504016 37.228838"><metadata id="metadata3405"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(-2.847e-7 -1015.1)"><path id="path4049" d="m26.584 1016.1c-12.631 0-23.15 9.858-25.478 22.922l50.705 12.18c0.47921-2.1565 0.73023-4.4099 0.73023-6.7204 0-15.677-11.621-28.382-25.957-28.382z" stroke="#5276cf" stroke-linecap="square" stroke-width="1.9247" fill="#666"/></g></svg>';
var wheel_left_svg='<svg id="svg3400" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="10.507mm" width="15.1mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 53.504016 37.228838"><metadata id="metadata3405"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(-2.847e-7 -1015.1)"><path id="path4033" d="m26.92 1016.1c-14.337 0-25.957 12.707-25.957 28.382 0 2.3225 0.26742 4.5784 0.74876 6.7386l50.681-12.18c-2.321-13.072-12.841-22.944-25.476-22.944z" stroke="#5276cf" stroke-linecap="square" stroke-width="1.9247" fill="#666"/></g></svg>';
var pedal_svg='<svg id="svg3386" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="12.859mm" width="5.2917mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 18.749999 45.562501"><metadata id="metadata3391"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1006.8)"><path id="rect4575" d="m9.3125 1006.8-9.3125 14.25h5.3125v17.094h-5.1875l9.3125 14.219 9.3125-14.219h-5.1562v-17.094h5.0312l-9.3125-14.25z" fill="#e6e6e6"/></g></svg>';
var wheel_settings_svg='<svg id="svg3458" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="50.447mm" width="83.899mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 297.28131 178.75"><metadata id="metadata3463"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -873.61)" fill="#e6e6e6"><path id="path4535" style="color:#000000;text-indent:0;block-progression:tb;text-decoration-line:none;text-transform:none" d="m33.875 873.61-18.5 8.8125 5.0626 3.0625c-12.899 22.78-20.438 49.17-20.438 77.44 0 28.284 7.5315 54.691 20.438 77.469l-5.0626 3.0625 18.5 8.8125 0.6563-20.469-5.531 3.3c-12.002-21.2-18.937-45.8-18.937-72.18 0-26.362 6.9415-50.99 18.937-72.188l5.5313 3.3438-0.6563-20.469z"/><path id="path4551" style="color:#000000;text-indent:0;block-progression:tb;text-decoration-line:none;text-transform:none" d="m263.38 873.71-0.6562 20.469 5.5312-3.3438c11.996 21.198 18.969 45.825 18.969 72.188 0 26.371-6.9672 51.011-18.969 72.219l-5.5312-3.3437 0.6562 20.469 18.5-8.8125-5.0312-3.0625c12.906-22.778 20.438-49.184 20.438-77.469 0-28.275-7.5391-54.665-20.438-77.438l5.0312-3.0625-18.5-8.8125z"/></g></svg>';
var gearbox_hor_svg='<svg id="svg3378" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="2.9016mm" width="9.2516mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 32.781198 10.281199"><metadata id="metadata3383"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1042.1)"><path id="rect4585" d="m32.781 1047.2-7.875-5.125v2.8437h-17.031v-2.8437l-7.875 5.1 7.875 5.1562v-2.8437h17.031v2.8437z" fill="#e6e6e6"/></g></svg>';
var gearbox_vert_svg='<svg id="svg3378" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="9.2516mm" width="2.9016mm" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="0 0 10.281248 32.7812"><metadata id="metadata3383"><rdf:RDF><cc:Work rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/><dc:title/></cc:Work></rdf:RDF></metadata><g id="layer1" transform="translate(0 -1019.6)"><path id="rect4585" d="m5.125 1019.6-5.125 7.9h2.8437v17.031h-2.8437l5.125 7.875 5.1562-7.875h-2.8438v-17.031h2.8438z" fill="#e6e6e6"/></g></svg>';
var _svg=[];var _selected_gamepad_num=-1;var _selected_btn=null;var _mode=VIEWER_MODE;var _main_element=null;var _device_elem=null;var _gamepad_elem=null;var _type_wheel_elem=null;var _type_pad_elem=null;var _device_id_label=null;var _tmp_gamepads=[];var _prefix="";var _elems=[];var _axis_elems=[];var _axis_settings_elems=[];var _is_pad_mode=true;var _axes_prev_val={};_axes_prev_val[m_input.GMPD_AXIS_0]=-2;_axes_prev_val[m_input.GMPD_AXIS_1]=-2;_axes_prev_val[m_input.GMPD_AXIS_2]=-2;_axes_prev_val[m_input.GMPD_AXIS_3]=
-2;_axes_prev_val[m_input.GMPD_AXIS_4]=-2;_axes_prev_val[m_input.GMPD_AXIS_5]=-2;_axes_prev_val[m_input.GMPD_AXIS_6]=-2;_axes_prev_val[m_input.GMPD_AXIS_7]=-2;_axes_prev_val[m_input.GMPD_AXIS_8]=-2;_axes_prev_val[m_input.GMPD_AXIS_9]=-2;_axes_prev_val[m_input.GMPD_AXIS_10]=-2;_axes_prev_val[m_input.GMPD_AXIS_11]=-2;_axes_prev_val[m_input.GMPD_AXIS_12]=-2;exports.show=function(){var main_div=document.createElement("div");_main_element=main_div;main_div.style.cssText="position: absolute;"+"width: 720px;"+
"height: 750px;"+"top: 50%;"+"left: 50%;"+"-moz-transform: translateY(-50%) translateX(-50%);"+"-ms-transform: translateY(-50%) translateX(-50%);"+"-webkit-transform: translateY(-50%) translateX(-50%);"+"transform: translateY(-50%) translateX(-50%);"+"background-color: black;"+"border: 4px solid white;"+"border-radius: 35px;"+"box-shadow: 0px 0px 20px 0px rgba(50, 50, 50, 1);";m_cont.insert_to_container(main_div,"LAST");create_pad_interface(main_div);var gamepad_data_cnt=document.createElement("div");
gamepad_data_cnt.style.cssText="position: absolute;"+"width: 637px;"+"top: 0px;"+"font-family: sans-serif;"+"text-align: center;"+"margin-top: 40px;"+"-moz-transform: translateX(-50%);"+"-ms-transform: translateX(-50%);"+"-webkit-transform: translateX(-50%);"+"transform: translateX(-50%);"+"left: 50%;";var main_label=document.createElement("div");main_label.innerHTML=MAIN_DEVICE_CAPTION;main_label.style.cssText="color: #fff;"+"display: inline-block;";gamepad_data_cnt.appendChild(main_label);for(var j=
0;j<4;j++){var sensors=create_sensors(j);var logic_func=function(){return true};var sensor_cb=function(obj,id,pulse){if(id!=_selected_gamepad_num)return;for(var i=0;i<_elems.length;i++){var elem=_elems[i];set_btn_state(elem,m_ctrl.get_sensor_value(obj,id,i),i)}};m_ctrl.create_sensor_manifold(null,j,m_ctrl.CT_CONTINUOUS,sensors,logic_func,sensor_cb)}var gamepads=get_gamepads();if(gamepads.length>0)_selected_gamepad_num=0;var gamepads_data=[];var gamepads_data_container=document.createElement("div");
gamepads_data_container.style.cssText="margin-top: 20px;";for(var i=0;i<4;i++){var gamepad_data_elem=create_device_icon_elem(i);if(i==_selected_gamepad_num){gamepad_data_elem.style.backgroundColor="green";_gamepad_elem=gamepad_data_elem}set_gmpd_config(i);gamepads_data_container.appendChild(gamepad_data_elem);gamepad_data_elem.setAttribute("data-device_type","PAD");gamepads_data.push(gamepad_data_elem);var click_cb=function(e){var gamepads=get_gamepads();var elem=e.target;for(var j=0;j<gamepads.length;j++)if(gamepads_data[j]==
elem){_selected_gamepad_num=j;_gamepad_elem=elem;set_gmpd_config(_selected_gamepad_num);change_device(elem.dataset.device_type)}};gamepad_data_elem.addEventListener("click",click_cb,false)}gamepad_data_cnt.appendChild(gamepads_data_container);_device_id_label=document.createElement("label");_device_id_label.style.cssText="position: relative;"+"display: block;"+"color: white;";gamepad_data_cnt.appendChild(_device_id_label);var type_and_action_container=document.createElement("div");type_and_action_container.style.cssText=
"margin-top: 20px;";var select_pad_elem=append_type_elem(type_and_action_container,"Pad");var select_wheel_elem=append_type_elem(type_and_action_container,"Wheel");select_pad_elem.setAttribute("checked","true");select_pad_elem.onchange=function(){change_device("PAD");if(_gamepad_elem)_gamepad_elem.setAttribute("data-device_type","PAD")};select_wheel_elem.onchange=function(){change_device("WHEEL");if(_gamepad_elem)_gamepad_elem.setAttribute("data-device_type","WHEEL")};select_pad_elem.setAttribute("id",
"test");_type_pad_elem=select_pad_elem;_type_wheel_elem=select_wheel_elem;var action_label=document.createElement("label");action_label.style.cssText+="color: #fff;"+"display: block;";type_and_action_container.appendChild(action_label);action_label.textContent=SELECT_BTN_CAPTION;action_label.setAttribute("id","action_label");gamepad_data_cnt.appendChild(type_and_action_container);main_div.appendChild(gamepad_data_cnt);var e_s=m_ctrl.create_elapsed_sensor();function e_sensor_cb(obj,id,pulse){var gamepads=
get_gamepads();var num=gamepads.length;if(_selected_gamepad_num==-1&&gamepads.length){_selected_gamepad_num=gamepads[0].index;_gamepad_elem=gamepads_data[_selected_gamepad_num]}for(var i=0;i<gamepads_data.length;i++)if(i<num){gamepads_data[i].textContent=gamepads[i].index;if(gamepads_data[i]==_gamepad_elem){gamepads_data[i].style.backgroundColor="green";_device_id_label.textContent="Selected device: "+gamepads[i].index+". Data: "+gamepads[i].id}else gamepads_data[i].style.backgroundColor="blue"}else gamepads_data[i].style.backgroundColor=
"black";if(!num){_selected_gamepad_num=-1;_device_id_label.textContent=""}}m_ctrl.create_sensor_manifold(null,"UPDATE_GAMEPAD_DATA",m_ctrl.CT_CONTINUOUS,[e_s],logic_func,e_sensor_cb);for(var j=0;j<4;j++){var sensors=create_axis_sensors(j);var logic_func=function(){return true};var sensor_cb=function(obj,id,pulse){if(id!="AXES"+_selected_gamepad_num)return;for(var i=0;i<_axis_elems.length;i=i+2){var elem=_axis_elems[i];set_axis_state(elem,obj,id,i)}if(_is_pad_mode)for(var i=0;i<12;i=i+2)change_dual_axis_setting_color(obj,
id,i);else for(var i=0;i<12;i++)change_single_axis_setting_color(obj,id,i)};m_ctrl.create_sensor_manifold(null,"AXES"+j,m_ctrl.CT_CONTINUOUS,sensors,logic_func,sensor_cb)}zoom_main_div();window.addEventListener("resize",zoom_main_div)};function set_axis_state(elem,obj,id,num){var x=m_ctrl.get_sensor_value(obj,id,num)*AXIS_STEP;var y=m_ctrl.get_sensor_value(obj,id,num+1)*AXIS_STEP;elem.style.transform="translate3d("+x+"px, "+y+"px, 0px) rotate("+0+"rad)"}function change_dual_axis_setting_color(obj,
id,num){if(num+1>_axis_settings_elems.length*2)return;var x=m_ctrl.get_sensor_value(obj,id,num);var y=m_ctrl.get_sensor_value(obj,id,num+1);if(_axes_prev_val[num]>-2){var delta_x=x-_axes_prev_val[num];var delta_y=y-_axes_prev_val[num+1];var elem=_axis_settings_elems[Math.floor(num/2)];var svg_id=elem.dataset.svgid;if(_mode==VIEWER_MODE)if(delta_x||delta_y)elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_id].replace(GREY_COLOR,GREEN_COLOR))+"')";else elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_id])+
"')";else if(_mode==AXIS_EDIT_MODE){var moved_axis=m_input.get_moved_gmpd_axis(_selected_gamepad_num);if(moved_axis>=0){if(moved_axis%2!=0)moved_axis--;_mode=VIEWER_MODE;elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_id])+"')";var sel_axis=parseFloat(_selected_btn.dataset.key);m_input.set_gamepad_key(_selected_gamepad_num,sel_axis,moved_axis);m_input.set_gamepad_key(_selected_gamepad_num,sel_axis+1,moved_axis+1);_selected_btn=null;document.getElementById("action_label").textContent=SELECT_BTN_CAPTION}}}_axes_prev_val[num]=
x;_axes_prev_val[num+1]=y}function change_single_axis_setting_color(obj,id,num){if(num>=_axis_settings_elems.length)return;var val=m_ctrl.get_sensor_value(obj,id,num);if(_axes_prev_val[num]>-2){var delta_val=val-_axes_prev_val[num];var elem=_axis_settings_elems[num];var svg_id=elem.dataset.svgid;if(_mode==VIEWER_MODE)if(delta_val)elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_id].replace(GREY_COLOR,GREEN_COLOR))+"')";else elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_id])+"')";else if(_mode==
AXIS_EDIT_MODE){var moved_axis=m_input.get_moved_gmpd_axis(_selected_gamepad_num);if(moved_axis>=0){_mode=VIEWER_MODE;elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_id])+"')";var sel_axis=parseFloat(_selected_btn.dataset.key);m_input.set_gamepad_key(_selected_gamepad_num,sel_axis,moved_axis);_selected_btn=null;document.getElementById("action_label").textContent=SELECT_BTN_CAPTION}}}_axes_prev_val[num]=val}function set_btn_state(elem,pressed,num){if(_mode==VIEWER_MODE){if(pressed&&elem.dataset.colorstate==
"B"){var svg=_svg[num];elem.style.backgroundImage=SVG_BASE64+btoa(svg.replace(BLUE_COLOR_REGEXP,GREEN_COLOR))+"')";elem.setAttribute("data-colorstate","G")}if(!pressed&&elem.dataset.colorstate!="B"){var svg=_svg[num];elem.style.backgroundImage=SVG_BASE64+btoa(svg)+"')";elem.setAttribute("data-colorstate","B")}}else{var pressed_btn_key=m_input.get_pressed_gmpd_btn(_selected_gamepad_num);if(pressed_btn_key>=0&&_selected_btn&&_mode==BTN_EDIT_MODE){var red_btn_val=_selected_btn.dataset.key;m_input.set_gamepad_key(_selected_gamepad_num,
red_btn_val,pressed_btn_key);save_config_to_local_mem(red_btn_val,pressed_btn_key);_selected_btn=null;document.getElementById("action_label").textContent=SELECT_BTN_CAPTION;_mode=VIEWER_MODE}}}exports.hide=function(){_mode=VIEWER_MODE;_selected_gamepad_num=-1;_gamepad_elem=null;_selected_btn=null;_type_wheel_elem=null;_type_pad_elem=null;_axis_elems.length=0;_elems.length=0;_axis_settings_elems.length=0;var main_container=m_cont.get_container();main_container.removeChild(_main_element);_main_element=
null;m_ctrl.remove_sensor_manifold(null,"UPDATE_GAMEPAD_DATA");for(var i=0;i<4;i++){m_ctrl.remove_sensor_manifold(null,i);m_ctrl.remove_sensor_manifold(null,"AXES"+i)}window.removeEventListener("resize",zoom_main_div)};function get_gamepads(){_tmp_gamepads.length=0;var gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];for(var i=0;i<gamepads.length;i++)if(gamepads[i])_tmp_gamepads.push(gamepads[i]);return _tmp_gamepads}function save_config_to_local_mem(red_btn_val,
pressed_btn_key){var gmpd_stngs_str=m_storage.get(_selected_gamepad_num+"gmpd_stngs","b4w")||"{}";var gmpd_stngs=JSON.parse(gmpd_stngs_str);gmpd_stngs[red_btn_val]=pressed_btn_key;m_storage.set(_selected_gamepad_num+"_gmpd_stngs",JSON.stringify(gmpd_stngs),"b4w")}function init_gmpd_stngs(gamepad_id){var settings=JSON.stringify(GMPD_DFLT_STNGS);m_storage.set(gamepad_id+"_gmpd_stngs",settings,"b4w")}function apply_settings(settings,gamepad_id){for(var button in settings)m_input.set_gamepad_key(gamepad_id,
button,settings[button])}function set_gmpd_config(gamepad_id){var gmpd_stngs=m_storage.get(gamepad_id+"_gmpd_stngs","b4w");if(gmpd_stngs)apply_settings(JSON.parse(gmpd_stngs),gamepad_id);else init_gmpd_stngs(gamepad_id)}function create_pad_interface(main_div){_is_pad_mode=true;var gamepad_elem=document.createElement("div");var dpad_group=document.createElement("div");var dpad_up_elem=document.createElement("div");var dpad_right_elem=document.createElement("div");var dpad_down_elem=document.createElement("div");
var dpad_left_elem=document.createElement("div");var face_group=document.createElement("div");var face_up_elem=document.createElement("div");var face_right_elem=document.createElement("div");var face_down_elem=document.createElement("div");var face_left_elem=document.createElement("div");var analog_left=document.createElement("div");var analog_right=document.createElement("div");var select_btn=document.createElement("div");var start_btn=document.createElement("div");var left_bumper=document.createElement("div");
var right_bumper=document.createElement("div");var right_trigger=document.createElement("div");var left_trigger=document.createElement("div");var main_btn=document.createElement("div");var left_axis_sittings=document.createElement("div");var right_axis_sittings=document.createElement("div");_device_elem=gamepad_elem;gamepad_elem.style.cssText="position: absolute;"+"height: auto;"+"background-image: "+SVG_BASE64+btoa(gamepad_svg)+"');"+"width: 637px;"+"height: 455px;"+"background-size: 100% 100%;"+
"left: 50%;"+"margin-bottom: 40px;"+"-moz-transform: translateX(-50%);"+"-ms-transform: translateX(-50%);"+"-webkit-transform: translateX(-50%);"+"bottom: 0px;";dpad_group.style.cssText="background-image: "+SVG_BASE64+btoa(dpad_svg)+"');"+"position: absolute;"+"top: 47px;"+"left: 65px;"+"width: 135px;"+"height: 135px;";dpad_up_elem.style.cssText="background-image: "+SVG_BASE64+btoa(dpad_up_svg)+"');"+"width: 36px;"+"height: 38px;"+"left: 49px;"+"top: 8px;"+"position: absolute;";dpad_right_elem.style.cssText=
"background-image: "+SVG_BASE64+btoa(dpad_right_svg)+"');"+"width: 38px;"+"height: 36px;"+"top: 47px;"+"left: 84px;"+"position: absolute;";dpad_down_elem.style.cssText="background-image: "+SVG_BASE64+btoa(dpad_down_svg)+"');"+"width: 36px;"+"height: 38px;"+"bottom: 11px;"+"left: 51px;"+"position: absolute;";dpad_left_elem.style.cssText="background-image: "+SVG_BASE64+btoa(dpad_left_svg)+"');"+"width: 38px;"+"height: 36px;"+"top: 47px;"+"left: 13px;"+"position: absolute;";face_group.style.cssText=
"position: absolute;"+"top: 55px;"+"left: 434px;"+"width: 150px;"+"height: 150px;";face_up_elem.style.cssText="background-image: "+SVG_BASE64+btoa(face_btn_svg)+"');"+"width: 50px;"+"height: 50px;"+"left: 53px;"+"top: 0px;"+"position: absolute;";face_right_elem.style.cssText="background-image: "+SVG_BASE64+btoa(face_btn_svg)+"');"+"width: 50px;"+"height: 50px;"+"left: 107px;"+"top: 51px;"+"position: absolute;";face_down_elem.style.cssText="background-image: "+SVG_BASE64+btoa(face_btn_svg)+"');"+"width: 50px;"+
"height: 50px;"+"left: 53px;"+"bottom: 0px;"+"position: absolute;";face_left_elem.style.cssText="background-image: "+SVG_BASE64+btoa(face_btn_svg)+"');"+"width: 50px;"+"height: 50px;"+"top: 51px;"+"position: absolute;";analog_left.style.cssText="background-image: "+SVG_BASE64+btoa(analog_btn_svg)+"');"+"position: absolute;"+"top: 222px;"+"left: 183px;"+"width: 85px;"+"height: 85px;";analog_right.style.cssText="background-image: "+SVG_BASE64+btoa(analog_btn_svg)+"');"+"position: absolute;"+"top: 223px;"+
"left: 376px;"+"width: 85px;"+"height: 85px;";select_btn.style.cssText="background-image: "+SVG_BASE64+btoa(start_btn_svg)+"');"+"position: absolute;"+"top: 76px;"+"left: 227px;"+"width: 34px;"+"height: 34px;";start_btn.style.cssText="background-image: "+SVG_BASE64+btoa(start_btn_svg)+"');"+"position: absolute;"+"top: 76px;"+"left: 376px;"+"width: 34px;"+"height: 34px;";left_bumper.style.cssText="background-image: "+SVG_BASE64+btoa(bumper_left_svg)+"');"+"position: absolute;"+"top: 4px;"+"left: 78px;"+
"width: 79px;"+"height: 33px;";right_bumper.style.cssText="background-image: "+SVG_BASE64+btoa(bumper_right_svg)+"');"+"position: absolute;"+"top: 4px;"+"left: 477px;"+"width: 79px;"+"height: 33px;";right_trigger.style.cssText="background-image: "+SVG_BASE64+btoa(trigger_btn_svg)+"');"+"position: absolute;"+"top: -7px;"+"left: 425px;"+"width: 50px;"+"height: 17px;";left_trigger.style.cssText="background-image: "+SVG_BASE64+btoa(trigger_btn_svg)+"');"+"position: absolute;"+"top: -7px;"+"left: 164px;"+
"width: 50px;"+"height: 17px;";main_btn.style.cssText="background-image: "+SVG_BASE64+btoa(main_svg)+"');"+"position: absolute;"+"top: 68px;"+"left: 274px;"+"width: 92px;"+"height: 92px;";left_axis_sittings.style.cssText="background-image: "+SVG_BASE64+btoa(axis_setting_svg)+"');"+"position: absolute;"+"top: 186px;"+"left: 148px;"+"width: 157px;"+"height: 157px;";right_axis_sittings.style.cssText="background-image: "+SVG_BASE64+btoa(axis_setting_svg)+"');"+"position: absolute;"+"top: 187px;"+"left: 339px;"+
"width: 157px;"+"height: 157px;";gamepad_elem.appendChild(left_axis_sittings);gamepad_elem.appendChild(right_axis_sittings);dpad_group.appendChild(dpad_up_elem);dpad_group.appendChild(dpad_right_elem);dpad_group.appendChild(dpad_down_elem);dpad_group.appendChild(dpad_left_elem);gamepad_elem.appendChild(dpad_group);face_group.appendChild(face_up_elem);face_group.appendChild(face_right_elem);face_group.appendChild(face_down_elem);face_group.appendChild(face_left_elem);gamepad_elem.appendChild(face_group);
gamepad_elem.appendChild(analog_left);gamepad_elem.appendChild(analog_right);gamepad_elem.appendChild(select_btn);gamepad_elem.appendChild(start_btn);gamepad_elem.appendChild(left_bumper);gamepad_elem.appendChild(right_bumper);gamepad_elem.appendChild(right_trigger);main_div.appendChild(gamepad_elem);gamepad_elem.appendChild(left_trigger);gamepad_elem.appendChild(main_btn);_elems.length=0;_svg.length=0;_axis_elems.length=0;_axis_settings_elems.length=0;_elems.push(face_down_elem,face_right_elem,face_left_elem,
face_up_elem,left_bumper,right_bumper,left_trigger,right_trigger,select_btn,start_btn,analog_left,analog_right,dpad_up_elem,dpad_down_elem,dpad_left_elem,dpad_right_elem,main_btn);_svg.push(face_btn_svg,face_btn_svg,face_btn_svg,face_btn_svg,bumper_left_svg,bumper_right_svg,trigger_btn_svg,trigger_btn_svg,start_btn_svg,start_btn_svg,analog_btn_svg,analog_btn_svg,dpad_up_svg,dpad_down_svg,dpad_left_svg,dpad_right_svg,main_svg);_axis_elems.push(analog_left,analog_left,analog_right,analog_right);_axis_settings_elems.push(left_axis_sittings,
right_axis_sittings);for(var i=0;i<_elems.length;i++){_elems[i].setAttribute("id","pad_btn_"+i);_elems[i].setAttribute("data-colorstate","B");_elems[i].setAttribute("data-key",i);_elems[i].setAttribute("data-svgid",i)}left_axis_sittings.setAttribute("id","pad_left_axis");left_axis_sittings.setAttribute("data-colorstate","GR");left_axis_sittings.setAttribute("data-key",m_input.GMPD_AXIS_0);left_axis_sittings.setAttribute("data-svgid",_svg.length);right_axis_sittings.setAttribute("id","pad_right_axis");
right_axis_sittings.setAttribute("data-colorstate","GR");right_axis_sittings.setAttribute("data-key",m_input.GMPD_AXIS_2);right_axis_sittings.setAttribute("data-svgid",_svg.length+1);_svg.push(axis_setting_svg,axis_setting_svg);append_elems_click_cb(_elems,BLUE_COLOR_REGEXP);append_elems_click_cb(_axis_settings_elems,GREY_COLOR)}function create_wheel_interface(main_div){_is_pad_mode=false;var wheel_elem=document.createElement("div");var wheel_btn_0=document.createElement("div");var wheel_btn_1=document.createElement("div");
var wheel_btn_2=document.createElement("div");var wheel_btn_3=document.createElement("div");var wheel_btn_4=document.createElement("div");var wheel_btn_5=document.createElement("div");var wheel_btn_6=document.createElement("div");var wheel_btn_7=document.createElement("div");var wheel_btn_8=document.createElement("div");var wheel_btn_9=document.createElement("div");var wheel_btn_10=document.createElement("div");var wheel_btn_11=document.createElement("div");var wheel_btn_12=document.createElement("div");
var wheel_btn_13=document.createElement("div");var wheel_btn_14=document.createElement("div");var wheel_btn_15=document.createElement("div");var wheel_btn_16=document.createElement("div");var wheel_btn_17=document.createElement("div");var wheel_btn_18=document.createElement("div");var wheel_btn_19=document.createElement("div");var wheel_btn_20=document.createElement("div");var wheel_btn_21=document.createElement("div");var wheel_btn_22=document.createElement("div");var wheel_btn_23=document.createElement("div");
var wheel_btn_24=document.createElement("div");var left_pedal_settings_elem=document.createElement("div");var midle_pedal_settings_elem=document.createElement("div");var right_pedal_settings_elem=document.createElement("div");var wheel_settings_elem=document.createElement("div");var gearbox_settings_hor_elem=document.createElement("div");var gearbox_settings_vert_elem=document.createElement("div");_device_elem=wheel_elem;var btn_def_style="position: absolute;"+"height: auto;"+"background-image: "+
SVG_BASE64+btoa(wheel_btn)+"');"+"width: 19px;"+"height: 19px;"+"background-size: 100% 100%;";wheel_elem.style.cssText="position: absolute;"+"background-image: "+SVG_BASE64+btoa(wheel_svg)+"');"+"width: 397px;"+"height: 455px;"+"-moz-transform: translateX(-50%);"+"-ms-transform: translateX(-50%);"+"-webkit-transform: translateX(-50%);"+"transform: translateX(-50%);"+"background-size: 100% 100%;"+"left: 50%;"+"margin-left: 25px;"+"margin-bottom: 40px;"+"bottom: 0px;";wheel_btn_0.style.cssText=btn_def_style+
"top: 132px;"+"left: 331px;";wheel_btn_1.style.cssText=btn_def_style+"top: 122px;"+"left: 315px;";wheel_btn_2.style.cssText=btn_def_style+"top: 122px;"+"left: 347px;";wheel_btn_3.style.cssText=btn_def_style+"top: 113px;"+"left: 331px;";wheel_btn_4.style.cssText="position: absolute;"+"height: auto;"+"background-image: "+SVG_BASE64+btoa(wheel_right_svg)+"');"+"width: 54px;"+"height: 37px;"+"background-size: 100% 100%;"+"top: 84px;"+"left: 166px;";wheel_btn_5.style.cssText="position: absolute;"+"height: auto;"+
"background-image: "+SVG_BASE64+btoa(wheel_left_svg)+"');"+"width: 54px;"+"height: 37px;"+"background-size: 100% 100%;"+"top: 84px;"+"left: 36px;";wheel_btn_6.style.cssText=btn_def_style+"top: 107px;"+"left: 141px;";wheel_btn_7.style.cssText=btn_def_style+"top: 107px;"+"left: 90px;";wheel_btn_8.style.cssText=btn_def_style+"top: 185px;"+"left: 321px;";wheel_btn_9.style.cssText=btn_def_style+"top: 185px;"+"left: 340px;";wheel_btn_10.style.cssText=btn_def_style+"top: 179px;"+"left: 358px;";wheel_btn_11.style.cssText=
btn_def_style+"top: 178px;"+"left: 303px;";wheel_btn_12.style.cssText=btn_def_style+"top: 210px;"+"left: 299px;";wheel_btn_13.style.cssText=btn_def_style+"top: 279px;"+"left: 299px;";wheel_btn_14.style.cssText=btn_def_style+"top: 210px;"+"left: 321px;";wheel_btn_15.style.cssText=btn_def_style+"top: 279px;"+"left: 321px;";wheel_btn_16.style.cssText=btn_def_style+"top: 210px;"+"left: 344px;";wheel_btn_17.style.cssText=btn_def_style+"top: 278px;"+"left: 344px;";wheel_btn_18.style.cssText=btn_def_style+
"top: 124px;"+"left: 147px;";wheel_btn_19.style.cssText=btn_def_style+"top: 138px;"+"left: 133px;";wheel_btn_20.style.cssText=btn_def_style+"top: 124px;"+"left: 82px;";wheel_btn_21.style.cssText=btn_def_style+"top: 138px;"+"left: 96px;";wheel_btn_22.style.cssText=btn_def_style+"top: 278px;"+"left: 367px;";var pedal_scc="position: absolute;"+"background-image: "+SVG_BASE64+btoa(pedal_svg)+"');"+"width: 19px;"+"height: 46px;"+"background-size: 100% 100%;";left_pedal_settings_elem.style.cssText=pedal_scc+
"top: 291px;"+"left: 50px;";midle_pedal_settings_elem.style.cssText=pedal_scc+"top: 291px;"+"left: 111px;";right_pedal_settings_elem.style.cssText=pedal_scc+"top: 291px;"+"left: 171px;";wheel_settings_elem.style.cssText="position: absolute;"+"background-image: "+SVG_BASE64+btoa(wheel_settings_svg)+"');"+"width: 297px;"+"height: 179px;"+"background-size: 100% 100%;"+"top: 43px;"+"left: -25px;";gearbox_settings_hor_elem.style.cssText="position: absolute;"+"background-image: "+SVG_BASE64+btoa(gearbox_hor_svg)+
"');"+"width: 33px;"+"height: 10px;"+"background-size: 100% 100%;"+"top: 159px;"+"left: 324px;";gearbox_settings_vert_elem.style.cssText="position: absolute;"+"background-image: "+SVG_BASE64+btoa(gearbox_vert_svg)+"');"+"width: 10px;"+"height: 33px;"+"background-size: 100% 100%;"+"top: 148px;"+"left: 335px;";main_div.appendChild(wheel_elem);wheel_elem.appendChild(left_pedal_settings_elem);wheel_elem.appendChild(midle_pedal_settings_elem);wheel_elem.appendChild(right_pedal_settings_elem);wheel_elem.appendChild(wheel_settings_elem);
wheel_elem.appendChild(gearbox_settings_hor_elem);wheel_elem.appendChild(gearbox_settings_vert_elem);wheel_elem.appendChild(wheel_btn_0);wheel_elem.appendChild(wheel_btn_1);wheel_elem.appendChild(wheel_btn_2);wheel_elem.appendChild(wheel_btn_3);wheel_elem.appendChild(wheel_btn_4);wheel_elem.appendChild(wheel_btn_5);wheel_elem.appendChild(wheel_btn_6);wheel_elem.appendChild(wheel_btn_7);wheel_elem.appendChild(wheel_btn_8);wheel_elem.appendChild(wheel_btn_9);wheel_elem.appendChild(wheel_btn_10);wheel_elem.appendChild(wheel_btn_11);
wheel_elem.appendChild(wheel_btn_12);wheel_elem.appendChild(wheel_btn_13);wheel_elem.appendChild(wheel_btn_14);wheel_elem.appendChild(wheel_btn_15);wheel_elem.appendChild(wheel_btn_16);wheel_elem.appendChild(wheel_btn_17);wheel_elem.appendChild(wheel_btn_18);wheel_elem.appendChild(wheel_btn_19);wheel_elem.appendChild(wheel_btn_20);wheel_elem.appendChild(wheel_btn_21);wheel_elem.appendChild(wheel_btn_22);_elems.length=0;_svg.length=0;_axis_elems.length=0;_axis_settings_elems.length=0;_elems.push(wheel_btn_0,
wheel_btn_1,wheel_btn_2,wheel_btn_3,wheel_btn_4,wheel_btn_5,wheel_btn_6,wheel_btn_7,wheel_btn_8,wheel_btn_9,wheel_btn_10,wheel_btn_11,wheel_btn_12,wheel_btn_13,wheel_btn_14,wheel_btn_15,wheel_btn_16,wheel_btn_17,wheel_btn_18,wheel_btn_19,wheel_btn_20,wheel_btn_21,wheel_btn_22);_svg.push(wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_right_svg,wheel_left_svg,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,wheel_btn,
wheel_btn,wheel_btn,wheel_btn);_axis_settings_elems.push(wheel_settings_elem,left_pedal_settings_elem,right_pedal_settings_elem,midle_pedal_settings_elem,gearbox_settings_hor_elem,gearbox_settings_vert_elem);for(var i=0;i<_elems.length;i++){_elems[i].setAttribute("id","wheel_btn_"+i);_elems[i].setAttribute("data-colorstate","B");_elems[i].setAttribute("data-key",i);_elems[i].setAttribute("data-svgid",i)}for(var i=0;i<_axis_settings_elems.length;i++){_elems[i].setAttribute("id","wheel_axis_"+i);_elems[i].setAttribute("data-colorstate",
"GR")}wheel_settings_elem.setAttribute("data-key",m_input.GMPD_AXIS_0);wheel_settings_elem.setAttribute("data-svgid",_svg.length);left_pedal_settings_elem.setAttribute("data-key",m_input.GMPD_AXIS_1);left_pedal_settings_elem.setAttribute("data-svgid",_svg.length+1);right_pedal_settings_elem.setAttribute("data-key",m_input.GMPD_AXIS_2);right_pedal_settings_elem.setAttribute("data-svgid",_svg.length+2);midle_pedal_settings_elem.setAttribute("data-key",m_input.GMPD_AXIS_3);midle_pedal_settings_elem.setAttribute("data-svgid",
_svg.length+3);gearbox_settings_hor_elem.setAttribute("data-key",m_input.GMPD_AXIS_4);gearbox_settings_hor_elem.setAttribute("data-svgid",_svg.length+4);gearbox_settings_vert_elem.setAttribute("data-key",m_input.GMPD_AXIS_5);gearbox_settings_vert_elem.setAttribute("data-svgid",_svg.length+5);_svg.push(wheel_settings_svg,pedal_svg,pedal_svg,pedal_svg,gearbox_hor_svg,gearbox_vert_svg);append_elems_click_cb(_elems,BLUE_COLOR_REGEXP);append_elems_click_cb(_axis_settings_elems,GREY_COLOR)}function create_sensors(gmpd_id){var sensors=
[m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_0,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_1,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_2,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_3,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_4,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_5,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_6,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_7,
gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_8,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_9,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_10,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_11,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_12,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_13,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_14,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_15,
gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_16,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_17,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_18,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_19,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_20,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_21,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_22,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_23,
gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_24,gmpd_id),m_ctrl.create_gamepad_btn_sensor(m_input.GMPD_BUTTON_25,gmpd_id)];return sensors}function create_axis_sensors(gmpd_id){var sensors=[m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_0,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_1,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_2,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_3,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_4,
gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_5,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_6,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_7,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_8,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_9,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_10,gmpd_id),m_ctrl.create_gamepad_axis_sensor(m_input.GMPD_AXIS_11,gmpd_id)];return sensors}function append_type_elem(parent,
text){var select_type_elem=document.createElement("input");select_type_elem.style.cssText="display: inline-block;"+"position = relative;";select_type_elem.setAttribute("type","radio");select_type_elem.setAttribute("name","choice");var select_type_label=document.createElement("label");select_type_label.textContent=text;select_type_label.style.cssText="position = relative;"+"display: inline-block;"+"color: white;";parent.appendChild(select_type_elem);parent.appendChild(select_type_label);return select_type_elem}
function reset_device_type(){_main_element.removeChild(_device_elem);_device_elem=null}function change_device(type){reset_device_type();switch(type){case "PAD":_type_pad_elem.checked=true;create_pad_interface(_main_element);break;case "WHEEL":_type_wheel_elem.checked=true;create_wheel_interface(_main_element);break}}function append_elems_click_cb(elems,original_color){var click_cb=function(e){var elem=e.target;if(_selected_gamepad_num<0||elem.dataset.colorstate=="G")return;if(_mode!=VIEWER_MODE){if(elem.dataset.colorstate==
"R"){_selected_btn=null;document.getElementById("action_label").textContent=SELECT_BTN_CAPTION;_mode=VIEWER_MODE}if(elem.dataset.colorstate=="B"||elem.dataset.colorstate=="GR"){var svg_num=parseFloat(_selected_btn.dataset.svgid);_selected_btn.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_num])+"')";_selected_btn.setAttribute("data-colorstate",elem.dataset.colorstate);_selected_btn=elem;svg_num=parseFloat(elem.dataset.svgid);elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_num].replace(original_color,
RED_COLOR))+"')";elem.setAttribute("data-colorstate","R")}}else{var svg_num=parseFloat(elem.dataset.svgid);var mode=elem.dataset.colorstate=="B"?BTN_EDIT_MODE:AXIS_EDIT_MODE;_mode=mode;elem.style.backgroundImage=SVG_BASE64+btoa(_svg[svg_num].replace(original_color,RED_COLOR))+"')";elem.setAttribute("data-colorstate","R");if(mode==BTN_EDIT_MODE)document.getElementById("action_label").textContent=PRESS_BTN_CAPTION;else document.getElementById("action_label").textContent=MOVE_AXIS_CAPTION;_selected_btn=
elem}};for(var i=0;i<elems.length;i++){var elem=elems[i];elem.addEventListener("click",click_cb,false)}}function create_device_icon_elem(number){var icon=document.createElement("label");icon.style.cssText="position: relative;"+"display: inline-block;"+"width: 50px;"+"color: white;"+"margin: 0 10px;"+"font-size: 36px;"+"line-height: 50px;"+"background-color: black;"+"border: 3px solid white;"+"border-radius: 5px;"+"height: 50px;";icon.textContent=number;return icon}function zoom_main_div(){var width=
window.innerWidth;var height=window.innerHeight;if(height<=750&&height>400||width<=750&&width>400)_main_element.style.zoom="0.5";else if(width<=400||height<=400)_main_element.style.zoom="0.3";else _main_element.style.zoom="1"}};b4w.module["gyroscope"]=function(exports,require){var m_cam=require("camera");var m_ctl=require("controls");var m_scenes=require("scenes");var m_trans=require("transform");var m_util=require("util");var m_vec3=require("vec3");var _begin_angles=new Float32Array(3);var _curr_angles=new Float32Array(3);var _vec3_tmp=m_vec3.create();var VERTICAL_BETA_ANGLE_THRESHOLD_UP=m_util.deg_to_rad(110);var VERTICAL_BETA_ANGLE_THRESHOLD_DOWN=m_util.deg_to_rad(70);var VERTICAL_GAMMA_ANGLE_THRESHOLD_UP=m_util.deg_to_rad(70);
var VERTICAL_GAMMA_ANGLE_THRESHOLD_DOWN=-m_util.deg_to_rad(70);exports.enable_camera_rotation=function(){var cam_obj=m_scenes.get_active_camera();create_camera_rotation_sensors(cam_obj)};function create_camera_rotation_sensors(obj){var g_a_sensor=m_ctl.create_gyro_angles_sensor();var g_q_sensor=m_ctl.create_gyro_quat_sensor();var save_angles=true;var cam_rotate_cb=function(obj,id,pulse){if(pulse>0)if(m_cam.is_eye_camera(obj)){var hmd_quat=m_ctl.get_sensor_payload(obj,id,1);var up_axis=m_vec3.transformQuat(m_util.AXIS_Z,
hmd_quat,_vec3_tmp);m_cam.set_vertical_axis(obj,up_axis);m_trans.set_rotation_v(obj,hmd_quat)}else{_curr_angles=m_ctl.get_sensor_payload(obj,id,0);if(save_angles){_begin_angles[0]=_curr_angles[0];_begin_angles[1]=_curr_angles[1];_begin_angles[2]=_curr_angles[2];save_angles=false}var delta_beta=0;var delta_gamma=0;if(window.orientation==0){delta_beta=_curr_angles[1]-_begin_angles[1];delta_gamma=_curr_angles[0]-_begin_angles[0];if(_curr_angles[1]>VERTICAL_BETA_ANGLE_THRESHOLD_DOWN&&_curr_angles[1]<
VERTICAL_BETA_ANGLE_THRESHOLD_UP)delta_gamma=0}if(window.orientation==180){delta_beta=_curr_angles[1]-_begin_angles[1];if(_curr_angles[1]<0)delta_beta=-delta_beta;delta_gamma=_begin_angles[0]-_curr_angles[0];if(delta_beta>Math.PI/2||delta_beta<-Math.PI/2)delta_beta=0;if(_curr_angles[1]>-VERTICAL_BETA_ANGLE_THRESHOLD_UP&&_curr_angles[1]<-VERTICAL_BETA_ANGLE_THRESHOLD_DOWN)delta_gamma=0}if(window.orientation==-90){delta_beta=_curr_angles[0]-_begin_angles[0];if(delta_beta>Math.PI/2||delta_beta<-Math.PI/
2)delta_beta=0;delta_gamma=_begin_angles[1]-_curr_angles[1];if(_curr_angles[0]>VERTICAL_GAMMA_ANGLE_THRESHOLD_UP||_curr_angles[0]<VERTICAL_GAMMA_ANGLE_THRESHOLD_DOWN)delta_gamma=0}if(window.orientation==90){delta_beta=_begin_angles[0]-_curr_angles[0];if(delta_beta>Math.PI/2||delta_beta<-Math.PI/2)delta_beta=0;delta_gamma=_curr_angles[1]-_begin_angles[1];if(_curr_angles[0]>VERTICAL_GAMMA_ANGLE_THRESHOLD_UP||_curr_angles[0]<VERTICAL_GAMMA_ANGLE_THRESHOLD_DOWN)delta_gamma=0}m_cam.rotate_camera(obj,delta_gamma,
delta_beta);_begin_angles[0]=_curr_angles[0];_begin_angles[1]=_curr_angles[1];_begin_angles[2]=_curr_angles[2]}};m_ctl.create_sensor_manifold(obj,"CAMERA_ROTATE_GYRO",m_ctl.CT_CONTINUOUS,[g_a_sensor,g_q_sensor],null,cam_rotate_cb)}exports.disable_camera_rotation=function(){var cam_obj=m_scenes.get_active_camera();m_ctl.remove_sensor_manifold(cam_obj,"CAMERA_ROTATE_GYRO")}};b4w.module["hmd_conf"]=function(exports,require){var m_cfg=require("config");var m_cont=require("container");var m_ctl=require("controls");var m_input=require("input");var m_print=require("print");var m_scs=require("scenes");var m_storage=require("storage");var m_util=require("util");var _is_shown=false;var _hmd_dialog=null;var _style=null;var _hmd_list=null;var _update=true;var _param_values={"profile":"custom","first_distortion":0,"second_distortion":0,"bevel_size":0,"screen_width":0,"screen_height":0,
"screen_lense":0,"ipd":0,"baseline":0};var DEFAULT_FIRST_DISTORTION=.34;var DEFAULT_SECOND_DISTORTION=.55;var DEFAULT_BEVEL_SIZE=4;var DEFAULT_SCREEN_WIDTH=110;var DEFAULT_SCREEN_HEIGHT=65;var DEFAULT_SCREEN_LENSE_DIST=50;var DEFAULT_EYE_DISTANCE=64;var DEFAULT_BASELINE_DIST=32;var INCH_TO_MM=25.4;var IS_IOS=/iPad|iPhone|iPod/.test(navigator.platform);var UPDATE_DELAY=1E3;var MM_TO_M=1/1E3;var P_COMMON=0;var P_MOBILE=1;var P_WEBVR=2;var _viewer_profiles={"oculus_dk2":{name:"Oculus Rift DK2",type:P_WEBVR,
"first_distortion":.22,"second_distortion":.28},"cardboard_1":{name:"Cardboard (2014)",type:P_MOBILE,"ipd":60,"baseline":35,"screen_lense":42,"first_distortion":.441,"second_distortion":.156},"cardboard_2":{name:"Cardboard (2015)",type:P_MOBILE,"ipd":64,"baseline":35,"screen_lense":39,"first_distortion":.34,"second_distortion":.55},"custom":{name:"Custom",type:P_COMMON,"ipd":64,"baseline":35,"screen_lense":39,"first_distortion":0,"second_distortion":0}};var _param_list=[{label:"Tray to lens-center distance.",
is_mobile:true,inputs:[{id:"baseline",max:"50",step:"0.5"}]},{label:"Interpupillary distance.",is_mobile:true,inputs:[{id:"ipd",max:"100",step:"1"}]},{label:"Screen to lense distance.",is_mobile:true,inputs:[{id:"screen_lense",max:"100",step:"1"}]},{label:"Screen height.",is_mobile:true,inputs:[{id:"screen_height",max:"150",step:"1"}]},{label:"Screen width.",is_mobile:true,inputs:[{id:"screen_width",max:"200",step:"1"}]},{label:"Bevel width.",is_mobile:true,inputs:[{id:"bevel_size",max:"20",step:"1"}]},
{label:"Distortion coefficients.",inputs:[{id:"first_distortion",max:"1.0",step:"0.01"},{id:"second_distortion",max:"1.0",step:"0.01"}]}];exports.check=function(){return m_input.can_use_device(m_input.DEVICE_HMD)};exports.show=function(css_class){_style=document.createElement("style");_style.innerHTML="html{-webkit-tap-highlight-color:rgba(0,0,0,0);}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{width:100%;height:8.4px;cursor:pointer;box-shadow:0 0 10px 0 rgba(50,50,50,1);background:#000;border-radius:1.3px;border:.2px solid #010101}input[type=range]::-webkit-slider-thumb{box-shadow:0 0 10px 0 rgba(50,50,50,1);border:1px solid #000;height:36px;width:16px;border-radius:3px;background:#fff;cursor:pointer;-webkit-appearance:none;margin-top:-14px}input[type=range]:focus::-webkit-slider-runnable-track{background:#000}input[type=range]::-moz-range-track{width:100%;height:8.4px;cursor:pointer;box-shadow:0 0 10px 0 rgba(50,50,50,1);background:#000;border-radius:1.3px;border:.2px solid #010101}input[type=range]::-moz-range-thumb{box-shadow:0 0 10px 0 rgba(50,50,50,1);border:1px solid #000;height:36px;width:16px;border-radius:3px;background:#fff;cursor:pointer}input[type=range]::-ms-track{width:100%;height:8.4px;cursor:pointer;background:0 0;border-color:transparent;color:transparent}input[type=range]::-ms-fill-lower{background:#000;border:.2px solid #010101;border-radius:2.6px;box-shadow:0 0 10px 0 rgba(50,50,50,1)}input[type=range]::-ms-fill-upper{background:#000;border:.2px solid #010101;border-radius:2.6px;box-shadow:0 0 10px 0 rgba(50,50,50,1)}input[type=range]::-ms-thumb{box-shadow:0 0 10px 0 rgba(50,50,50,1);border:1px solid #000;height:36px;width:16px;border-radius:3px;background:#fff;cursor:pointer}.text_label,.value_label{display:inline-block;text-decoration:none;height:30px;line-height:28px;position:relative;text-align:center;font-family:Arial;font-size:15px}input[type=range]:focus::-ms-fill-lower{background:#000}input[type=range]:focus::-ms-fill-upper{background:#000}.text_label{float:left;color:#fff;width:auto;padding:0 10px;background-color:#000;border:3px solid #fff;border-radius:15px;box-shadow:0 0 10px 0 rgba(50,50,50,1);margin-right:15px}.input_text,.value_label{border:3px solid #fff;background-color:#000;color:#fff;box-shadow:0 0 10px 0 rgba(50,50,50,1)}.value_label{right:0;width:40px;border-radius:15px;margin-left:15px}.slider{position:relative;cursor:pointer}.border{position:relative;width:100%;height:50px}.input_slider,.input_text{margin:13.8px 0;-webkit-appearance:none;width:50%;position:relative;display:inline-block}.input_text{border-radius:4px;padding-left:4px}.input_slider,_:-moz-tree-row(hover){-webkit-appearance:none;width:50%;margin:-4.8px 0;position:relative;display:inline-block}:root .input_slider,_:-ms-fullscreen{-webkit-appearance:none;width:50%;margin:-2.8px 0;position:relative;display:inline-block}button,select{display:block}button{background-color:#000;color:#fff;width:100px;border:3px solid #fff;text-align:center;font-family:Arial;border-radius:15px;box-shadow:0 0 10px 0 rgba(50,50,50,1);font-size:15px;line-height:30px;margin-right:10px}select{clear:both}";
document.head.appendChild(_style);var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(_is_shown||!device)return;_is_shown=true;restore_params();var container=m_cont.get_container();var mdevice=m_input.get_device_by_type_element(m_input.DEVICE_MOUSE,container);m_input.switch_prevent_default(mdevice,false);var tdevice=m_input.get_device_by_type_element(m_input.DEVICE_TOUCH,container);m_input.switch_prevent_default(tdevice,false);_hmd_dialog=document.createElement("div");_hmd_dialog.class=
css_class;container.appendChild(_hmd_dialog);_hmd_list=document.createElement("div");_hmd_dialog.appendChild(_hmd_list);_hmd_list.style.cssText="position: absolute;"+"background-color: #fff;"+"left: 10px;"+"top: 10px;"+"right: 10px;"+"bottom: 10px;"+"bottom: 10px;"+"min-width: 300px;"+"overflow: auto;"+"padding: 10px;"+"border: 1px solid #ddd;"+"border-radius: 4px;"+"bottom: 10px;";var select=create_profiles_select();_hmd_list.appendChild(select);for(var i=0;i<_param_list.length;i++)if(m_input.get_value_param(device,
m_input.HMD_WEBVR_TYPE)!=m_input.HMD_WEBVR_DESKTOP||!_param_list[i].is_mobile){var param_cont=create_param(_param_list[i]);_hmd_list.appendChild(param_cont)}var buttons=create_buttons();_hmd_list.appendChild(buttons);var time=m_ctl.create_timeline_sensor();var last_update_time=0;function update_cb(obj,id,pulse){var time=m_ctl.get_sensor_value(obj,id,0);if(time-last_update_time>UPDATE_DELAY){last_update_time=time;update_params()}}m_ctl.create_sensor_manifold(null,"UPDATE_HMD_RENDERING",m_ctl.CT_CONTINUOUS,
[time],null,update_params)};function create_profiles_select(){var hmd_conf_str=m_storage.get("hmd_conf","b4w");var hmd_conf_data=JSON.parse(hmd_conf_str?hmd_conf_str:"{}");var cur_profile=hmd_conf_data["profile"]||"custom";var select_cont=document.createElement("div");var label=document.createElement("label");label.innerHTML="Profile: ";label.className="text_label";select_cont.appendChild(label);var select=document.createElement("select");select_cont.appendChild(select);select_cont.style.cssText=
"margin: 20px 0;"+"padding: 10px;";var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(device)for(var i in _viewer_profiles)if(_viewer_profiles[i].type==P_COMMON||m_input.get_value_param(device,m_input.HMD_WEBVR_TYPE)==m_input.HMD_WEBVR_DESKTOP^_viewer_profiles[i].type==P_MOBILE){var option=document.createElement("option");option.value=i;option.text=_viewer_profiles[i].name;select.appendChild(option)}select.value=cur_profile;if(m_util.is_ie11())select.onchange=change_select_cb;else select.oninput=
change_select_cb;return select_cont}function change_select_cb(e){var profile=e.target.value;var profile_data=_viewer_profiles[profile];for(var name in _param_values)if(name in profile_data){var slider=document.getElementById(name+"_slider");if(slider){slider.disabled=profile!=="custom";slider.value=profile_data[name]}var number=document.getElementById(name+"_number");if(number){number.disabled=profile!=="custom";number.value=profile_data[name]}}}exports.hide=hide;function hide(){m_ctl.remove_sensor_manifold(null,
"UPDATE_HMD_RENDERING");restore_params();update_params();if(!_is_shown)return;_is_shown=false;remove_dom_tree()}exports.reset=reset;function reset(){restore_params(true);update_params();update_dom_tree()}exports.update=function(){restore_params();update_params()};function update_dom_tree(){for(var i in _param_values){var slider=document.getElementById(i+"_slider");if(slider)slider.value=_param_values[i];var number=document.getElementById(i+"_number");if(number)number.value=_param_values[i]}}function remove_dom_tree(){var container=
m_cont.get_container();container.removeChild(_hmd_dialog);document.head.removeChild(_style);_hmd_dialog=null;_hmd_list=null;_style=null}function get_screen_width(){return Math.max(window.screen.width,window.screen.height)*window.devicePixelRatio}function get_screen_height(){return Math.min(window.screen.width,window.screen.height)*window.devicePixelRatio}function check_rule(rule,ua,screenWidth,screenHeight){return rule["ua"]&&ua.indexOf(rule["ua"])>=0||!rule["ua"]&&rule["res"]&&rule["res"][0]&&rule["res"][1]&&
Math.min(screenWidth,screenHeight)==Math.min(rule["res"][0],rule["res"][1])&&Math.max(screenWidth,screenHeight)==Math.max(rule["res"][0],rule["res"][1])}function find_device_index(dpdb,user_agent,width,height){if(dpdb["format"]!=1||!dpdb["devices"]||!dpdb["devices"].length){m_print.error("DPDB isn't correct.");return-1}for(var i=0;i<dpdb["devices"].length;i++){var device=dpdb["devices"][i];if(!device["rules"]||(device["type"]!="ios"||!IS_IOS)&&device["type"]!="android")continue;var found=false;for(var j=
0;j<device["rules"].length;j++){var rule=device["rules"][j];if(check_rule(rule,user_agent,width,height)){found=true;break}}if(found)return i}return-1}function restore_params(ignore_storage){var user_agent=navigator.userAgent||navigator.vendor||window.opera;var width=get_screen_width();var height=get_screen_height();var width_dpmm=0;var height_dpmm=0;var bevel_mm=0;var device_index=find_device_index(DPDB,user_agent,width,height);if(device_index!=-1){var device=DPDB["devices"][device_index];var xdpi=
device["dpi"][0]||device["dpi"];var ydpi=device["dpi"][1]||device["dpi"];width_dpmm=Math.round(width*INCH_TO_MM/xdpi);height_dpmm=Math.round(height*INCH_TO_MM/ydpi);bevel_mm=Math.round(device["bw"])}var hmd_conf_str=m_storage.get("hmd_conf","b4w");var hmd_conf_data=JSON.parse(hmd_conf_str?hmd_conf_str:"{}");_param_values["first_distortion"]=!ignore_storage&&parseFloat(hmd_conf_data["first_distortion"])||DEFAULT_FIRST_DISTORTION;_param_values["second_distortion"]=!ignore_storage&&parseFloat(hmd_conf_data["second_distortion"])||
DEFAULT_SECOND_DISTORTION;_param_values["bevel_size"]=!ignore_storage&&parseFloat(hmd_conf_data["bevel_size"])||bevel_mm||DEFAULT_BEVEL_SIZE;_param_values["screen_width"]=!ignore_storage&&parseFloat(hmd_conf_data["screen_width"])||width_dpmm||DEFAULT_SCREEN_WIDTH;_param_values["screen_height"]=!ignore_storage&&parseFloat(hmd_conf_data["screen_height"])||height_dpmm||DEFAULT_SCREEN_HEIGHT;_param_values["screen_lense"]=!ignore_storage&&parseFloat(hmd_conf_data["screen_lense"])||DEFAULT_SCREEN_LENSE_DIST;
_param_values["ipd"]=!ignore_storage&&parseFloat(hmd_conf_data["ipd"])||DEFAULT_EYE_DISTANCE;_param_values["baseline"]=!ignore_storage&&parseFloat(hmd_conf_data["baseline"])||DEFAULT_BASELINE_DIST;_update=true}function save_changes(){m_storage.set("hmd_conf",JSON.stringify(_param_values),"b4w");remove_dom_tree()}function update_params(){if(_update){var device=m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(device){m_input.set_config(device,m_input.HMD_DISTORTION,[_param_values["first_distortion"],
_param_values["second_distortion"]]);if(m_input.get_value_param(device,m_input.HMD_WEBVR_TYPE)!=m_input.HMD_WEBVR_DESKTOP){m_input.set_config(device,m_input.HMD_BEVEL_SIZE,_param_values["bevel_size"]*MM_TO_M);m_input.set_config(device,m_input.HMD_SCREEN_WIDTH,_param_values["screen_width"]*MM_TO_M);m_input.set_config(device,m_input.HMD_SCREEN_HEIGHT,_param_values["screen_height"]*MM_TO_M);m_input.set_config(device,m_input.HMD_SCREEN_LENSE_DIST,_param_values["screen_lense"]*MM_TO_M);m_input.set_config(device,
m_input.HMD_EYE_DISTANCE,_param_values["ipd"]*MM_TO_M);m_input.set_config(device,m_input.HMD_BASELINE_DIST,_param_values["baseline"]*MM_TO_M)}var cam_obj=m_scs.get_active_camera()}_update=false}}function change_slider_cb(e){var id=e.target.id;var id_list=id.split("_");var value_id=id_list.splice(0,id_list.length-1).join("_");if(value_id in _param_values&&_param_values[value_id]!=e.target.value){_update=true;_param_values[value_id]=e.target.value;var slider=document.getElementById(value_id+"_slider");
slider.value=e.target.value;var number=document.getElementById(value_id+"_number");number.value=e.target.value}}function create_param(param){var param_cont=document.createElement("div");var label_d=document.createElement("label");label_d.className="text_label";label_d.textContent=param.label;param_cont.appendChild(label_d);param_cont.style.cssText="margin: 20px 0;"+"float: left;"+"display: inline-block;"+"width: 50%;"+"border: 1px solid #ddd;"+"box-sizing: border-box;"+"-webkit-box-sizing: border-box;"+
"padding: 10px;";for(var i=0;i<param.inputs.length;i++){var input_data=param.inputs[i];var slider=create_slider(input_data);param_cont.appendChild(slider)}return param_cont}function create_slider(input_data){var container=document.createElement("div");container.style.cssText+="clear: both; margin-bottom: 10px;";var input_s=document.createElement("input");input_s.className="input_slider";input_s.setAttribute("id",input_data.id+"_slider");input_s.setAttribute("type","range");input_s.setAttribute("min",
"0.00");input_s.setAttribute("step",input_data.step);input_s.setAttribute("value",_param_values[input_data.id]);input_s.setAttribute("max",input_data.max);input_s.style.cssText="float: left;";container.appendChild(input_s);var input_d=document.createElement("input");input_d.className="input_text";input_d.setAttribute("id",input_data.id+"_number");input_d.setAttribute("type","number");input_d.setAttribute("min","0.00");input_d.setAttribute("step",input_data.step);input_d.setAttribute("value",_param_values[input_data.id]);
input_d.setAttribute("max",input_data.max);container.appendChild(input_d);if(m_util.is_ie11()){input_s.onchange=change_slider_cb;input_d.onchange=change_slider_cb}else{input_s.oninput=change_slider_cb;input_d.oninput=change_slider_cb}return container}function create_buttons(){var buttons_container=document.createElement("div");var hmd_submit_button=create_button(save_changes,"SAVE");var hmd_cancel_button=create_button(hide,"CANCEL");var hmd_reset_button=create_button(reset,"RESET");buttons_container.style.clear=
"both";buttons_container.appendChild(hmd_submit_button);buttons_container.appendChild(hmd_cancel_button);buttons_container.appendChild(hmd_reset_button);return buttons_container}function create_button(callback,text_content){var button=document.createElement("button");button.onclick=callback;button.style.cssText="display: inline-block;";button.innerHTML=text_content;return button}var DPDB={"_comment":"AUTOMATICALLY GENERATED BY generate_dpdb.py. DO NOT EDIT.","format":1,"last_updated":"2016-01-26T23:11:18Z",
"devices":[{"type":"android","rules":[{"mdmh":"asus/*/Nexus 7/*"},{"ua":"Nexus 7"}],"dpi":[320.8,323],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"asus/*/ASUS_Z00AD/*"},{"ua":"ASUS_Z00AD"}],"dpi":[403,404.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"HTC/*/HTC6435LVW/*"},{"ua":"HTC6435LVW"}],"dpi":[449.7,443.3],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"HTC/*/HTC One XL/*"},{"ua":"HTC One XL"}],"dpi":[315.3,314.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"htc/*/Nexus 9/*"},
{"ua":"Nexus 9"}],"dpi":289,"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"HTC/*/HTC One M9/*"},{"ua":"HTC One M9"}],"dpi":[442.5,443.3],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"HTC/*/HTC One_M8/*"},{"ua":"HTC One_M8"}],"dpi":[449.7,447.4],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"HTC/*/HTC One/*"},{"ua":"HTC One"}],"dpi":472.8,"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Huawei/*/Nexus 6P/*"},{"ua":"Nexus 6P"}],"dpi":[515.1,518],"bw":3,"ac":1E3},{"type":"android",
"rules":[{"mdmh":"LGE/*/Nexus 5X/*"},{"ua":"Nexus 5X"}],"dpi":[422,419.9],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"LGE/*/LGMS345/*"},{"ua":"LGMS345"}],"dpi":[221.7,219.1],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"LGE/*/LG-D800/*"},{"ua":"LG-D800"}],"dpi":[422,424.1],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"LGE/*/LG-D850/*"},{"ua":"LG-D850"}],"dpi":[537.9,541.9],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"LGE/*/VS985 4G/*"},{"ua":"VS985 4G"}],"dpi":[537.9,
535.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"LGE/*/Nexus 5/*"},{"ua":"Nexus 5 B"}],"dpi":[442.4,444.8],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"LGE/*/Nexus 4/*"},{"ua":"Nexus 4"}],"dpi":[319.8,318.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"LGE/*/LG-P769/*"},{"ua":"LG-P769"}],"dpi":[240.6,247.5],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"LGE/*/LGMS323/*"},{"ua":"LGMS323"}],"dpi":[206.6,204.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"LGE/*/LGLS996/*"},
{"ua":"LGLS996"}],"dpi":[403.4,401.5],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Micromax/*/4560MMX/*"},{"ua":"4560MMX"}],"dpi":[240,219.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Micromax/*/A250/*"},{"ua":"Micromax A250"}],"dpi":[480,446.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Micromax/*/Micromax AQ4501/*"},{"ua":"Micromax AQ4501"}],"dpi":240,"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"motorola/*/DROID RAZR/*"},{"ua":"DROID RAZR"}],"dpi":[368.1,256.7],
"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"motorola/*/XT830C/*"},{"ua":"XT830C"}],"dpi":[254,255.9],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"motorola/*/XT1021/*"},{"ua":"XT1021"}],"dpi":[254,256.7],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"motorola/*/XT1023/*"},{"ua":"XT1023"}],"dpi":[254,256.7],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"motorola/*/XT1028/*"},{"ua":"XT1028"}],"dpi":[326.6,327.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"motorola/*/XT1034/*"},
{"ua":"XT1034"}],"dpi":[326.6,328.4],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"motorola/*/XT1053/*"},{"ua":"XT1053"}],"dpi":[315.3,316.1],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"motorola/*/XT1562/*"},{"ua":"XT1562"}],"dpi":[403.4,402.7],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"motorola/*/Nexus 6/*"},{"ua":"Nexus 6 B"}],"dpi":[494.3,489.7],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"motorola/*/XT1063/*"},{"ua":"XT1063"}],"dpi":[295,296.6],"bw":3,"ac":1E3},
{"type":"android","rules":[{"mdmh":"motorola/*/XT1064/*"},{"ua":"XT1064"}],"dpi":[295,295.6],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"motorola/*/XT1092/*"},{"ua":"XT1092"}],"dpi":[422,424.1],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"motorola/*/XT1095/*"},{"ua":"XT1095"}],"dpi":[422,423.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"OnePlus/*/A0001/*"},{"ua":"A0001"}],"dpi":[403.4,401],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"OnePlus/*/ONE E1005/*"},{"ua":"ONE E1005"}],
"dpi":[442.4,441.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"OnePlus/*/ONE A2005/*"},{"ua":"ONE A2005"}],"dpi":[391.9,405.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"OPPO/*/X909/*"},{"ua":"X909"}],"dpi":[442.4,444.1],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9082/*"},{"ua":"GT-I9082"}],"dpi":[184.7,185.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G360P/*"},{"ua":"SM-G360P"}],"dpi":[196.7,205.4],"bw":3,"ac":1E3},{"type":"android",
"rules":[{"mdmh":"samsung/*/Nexus S/*"},{"ua":"Nexus S"}],"dpi":[234.5,229.8],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9300/*"},{"ua":"GT-I9300"}],"dpi":[304.8,303.9],"bw":5,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SM-T230NU/*"},{"ua":"SM-T230NU"}],"dpi":216,"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SGH-T399/*"},{"ua":"SGH-T399"}],"dpi":[217.7,231.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-N9005/*"},{"ua":"SM-N9005"}],
"dpi":[386.4,387],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SAMSUNG-SM-N900A/*"},{"ua":"SAMSUNG-SM-N900A"}],"dpi":[386.4,387.7],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9500/*"},{"ua":"GT-I9500"}],"dpi":[442.5,443.3],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9505/*"},{"ua":"GT-I9505"}],"dpi":439.4,"bw":4,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G900F/*"},{"ua":"SM-G900F"}],"dpi":[415.6,431.6],"bw":5,"ac":1E3},
{"type":"android","rules":[{"mdmh":"samsung/*/SM-G900M/*"},{"ua":"SM-G900M"}],"dpi":[415.6,431.6],"bw":5,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G800F/*"},{"ua":"SM-G800F"}],"dpi":326.8,"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G906S/*"},{"ua":"SM-G906S"}],"dpi":[562.7,572.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9300/*"},{"ua":"GT-I9300"}],"dpi":[306.7,304.8],"bw":5,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-T535/*"},
{"ua":"SM-T535"}],"dpi":[142.6,136.4],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SM-N920C/*"},{"ua":"SM-N920C"}],"dpi":[515.1,518.4],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9300I/*"},{"ua":"GT-I9300I"}],"dpi":[304.8,305.8],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-I9195/*"},{"ua":"GT-I9195"}],"dpi":[249.4,256.7],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SPH-L520/*"},{"ua":"SPH-L520"}],"dpi":[249.4,255.9],"bw":3,
"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SAMSUNG-SGH-I717/*"},{"ua":"SAMSUNG-SGH-I717"}],"dpi":285.8,"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SPH-D710/*"},{"ua":"SPH-D710"}],"dpi":[217.7,204.2],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/GT-N7100/*"},{"ua":"GT-N7100"}],"dpi":265.1,"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SCH-I605/*"},{"ua":"SCH-I605"}],"dpi":265.1,"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/Galaxy Nexus/*"},
{"ua":"Galaxy Nexus"}],"dpi":[315.3,314.2],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-N910H/*"},{"ua":"SM-N910H"}],"dpi":[515.1,518],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-N910C/*"},{"ua":"SM-N910C"}],"dpi":[515.2,520.2],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G130M/*"},{"ua":"SM-G130M"}],"dpi":[165.9,164.8],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G928I/*"},{"ua":"SM-G928I"}],"dpi":[515.1,518.4],
"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G920F/*"},{"ua":"SM-G920F"}],"dpi":580.6,"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G920P/*"},{"ua":"SM-G920P"}],"dpi":[522.5,577],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G925F/*"},{"ua":"SM-G925F"}],"dpi":580.6,"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"samsung/*/SM-G925V/*"},{"ua":"SM-G925V"}],"dpi":[522.5,576.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Sony/*/C6903/*"},
{"ua":"C6903"}],"dpi":[442.5,443.3],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"Sony/*/D6653/*"},{"ua":"D6653"}],"dpi":[428.6,427.6],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Sony/*/E6653/*"},{"ua":"E6653"}],"dpi":[428.6,425.7],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Sony/*/E6853/*"},{"ua":"E6853"}],"dpi":[403.4,401.9],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"Sony/*/SGP321/*"},{"ua":"SGP321"}],"dpi":[224.7,224.1],"bw":3,"ac":500},{"type":"android","rules":[{"mdmh":"TCT/*/ALCATEL ONE TOUCH Fierce/*"},
{"ua":"ALCATEL ONE TOUCH Fierce"}],"dpi":[240,247.5],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"THL/*/thl 5000/*"},{"ua":"thl 5000"}],"dpi":[480,443.3],"bw":3,"ac":1E3},{"type":"android","rules":[{"mdmh":"ZTE/*/ZTE Blade L2/*"},{"ua":"ZTE Blade L2"}],"dpi":240,"bw":3,"ac":500},{"type":"ios","rules":[{"res":[640,960]}],"dpi":[325.1,328.4],"bw":4,"ac":1E3},{"type":"ios","rules":[{"res":[640,1136]}],"dpi":[317.1,320.2],"bw":3,"ac":1E3},{"type":"ios","rules":[{"res":[750,1334]}],"dpi":326.4,
"bw":4,"ac":1E3},{"type":"ios","rules":[{"res":[1242,2208]}],"dpi":[453.6,458.4],"bw":4,"ac":1E3},{"type":"ios","rules":[{"res":[1125,2001]}],"dpi":[410.9,415.4],"bw":4,"ac":1E3}]}};b4w.module["hmd"]=function(exports,require){var m_cam=require("camera");var m_ctl=require("controls");var m_input=require("input");var m_quat=require("quat");var m_scenes=require("scenes");var m_trans=require("transform");var m_util=require("util");var m_vec3=require("vec3");var _last_cam_quat=m_quat.create();var _yaw_cam_angle=0;var _was_target_camera=false;var _was_hover_camera=false;var _was_static_camera=false;var _vec3_tmp=m_vec3.create();var _vec3_tmp2=m_vec3.create();var _vec3_tmp3=m_vec3.create();
var _quat_tmp=m_quat.create();var _quat_tmp2=m_quat.create();var _quat_tmp3=m_quat.create();var HMD_NONE_MOUSE_ALL_AXES=0;exports.HMD_NONE_MOUSE_ALL_AXES=HMD_NONE_MOUSE_ALL_AXES;var HMD_ALL_AXES_MOUSE_NONE=1;exports.HMD_ALL_AXES_MOUSE_NONE=HMD_ALL_AXES_MOUSE_NONE;var HMD_ROLL_PITCH_MOUSE_YAW=2;exports.HMD_ROLL_PITCH_MOUSE_YAW=HMD_ROLL_PITCH_MOUSE_YAW;var HMD_ALL_AXES_MOUSE_YAW=3;exports.HMD_ALL_AXES_MOUSE_YAW=HMD_ALL_AXES_MOUSE_YAW;exports.enable_hmd=function(control_type){var sensor=null;var device=
m_input.get_device_by_type_element(m_input.DEVICE_HMD);if(device){if(m_input.get_value_param(device,m_input.HMD_WEBVR_TYPE)==m_input.HMD_WEBVR_DESKTOP)sensor=m_ctl.create_hmd_quat_sensor();else sensor=m_ctl.create_gyro_quat_sensor();process_hmd(control_type,sensor)}};exports.check_browser_support=function(){return Boolean(m_input.can_use_device(m_input.DEVICE_HMD))};exports.get_hmd_device=function(){return null};exports.reset=function(){m_input.reset_device(m_input.DEVICE_HMD)};function process_hmd(control_type,
sensor){if(!sensor)return;var cam_obj=m_scenes.get_active_camera();if(!cam_obj)return;else if(!m_cam.is_eye_camera(cam_obj)){_was_target_camera=m_cam.is_target_camera(cam_obj);_was_hover_camera=m_cam.is_hover_camera(cam_obj);_was_static_camera=m_cam.is_static_camera(cam_obj);m_cam.eye_setup(cam_obj)}var elapsed=m_ctl.create_elapsed_sensor();var updated_eye_data=false;var move_cam_cb=function(obj,id,pulse){if(pulse>0){var cam_obj=m_scenes.get_active_camera();if(!cam_obj)return;if(!updated_eye_data&&
m_input.enable_split_screen(cam_obj)){_last_cam_quat=m_trans.get_rotation(cam_obj,_last_cam_quat);updated_eye_data=true}if(updated_eye_data&&m_cam.is_eye_camera(cam_obj)){var hmd_quat=m_ctl.get_sensor_payload(obj,id,1);if(hmd_quat)if(control_type==HMD_ALL_AXES_MOUSE_NONE){var up_axis=m_vec3.transformQuat(m_util.AXIS_Z,hmd_quat,_vec3_tmp);m_cam.set_vertical_axis(cam_obj,up_axis);m_trans.set_rotation_v(cam_obj,hmd_quat)}else if(control_type==HMD_ROLL_PITCH_MOUSE_YAW||control_type==HMD_ALL_AXES_MOUSE_YAW){var cam_quat=
m_trans.get_rotation(cam_obj,_quat_tmp2);var inv_cam_quat=m_quat.invert(cam_quat,_quat_tmp2);var diff_cam_quat=m_quat.multiply(_last_cam_quat,inv_cam_quat,_quat_tmp2);var cur_vertical_axis=m_cam.get_vertical_axis(cam_obj,_vec3_tmp);if(Math.abs(cur_vertical_axis[2])<Math.PI/4)var first_horiz_vec=m_vec3.cross(cur_vertical_axis,m_util.AXIS_Z,_vec3_tmp2);else if(Math.abs(cur_vertical_axis[1])<Math.PI/4)var first_horiz_vec=m_vec3.cross(cur_vertical_axis,m_util.AXIS_Y,_vec3_tmp2);m_vec3.normalize(first_horiz_vec,
first_horiz_vec);var rotated_first_horiz_vec=m_vec3.transformQuat(first_horiz_vec,diff_cam_quat,_vec3_tmp3);var vertical_coef=m_vec3.dot(cur_vertical_axis,rotated_first_horiz_vec);var second_horiz_vec=m_vec3.scaleAndAdd(rotated_first_horiz_vec,cur_vertical_axis,-vertical_coef,_vec3_tmp3);m_vec3.normalize(second_horiz_vec,second_horiz_vec);var sign_horiz_vec=m_vec3.cross(cur_vertical_axis,first_horiz_vec,_vec3_tmp);var abs_yaw_angle=Math.acos(m_util.clamp(m_vec3.dot(first_horiz_vec,second_horiz_vec),
0,1));var sign_yaw_angle=m_util.sign(m_vec3.dot(second_horiz_vec,sign_horiz_vec));var diff_yaw_cam_angle=abs_yaw_angle*sign_yaw_angle;_yaw_cam_angle+=diff_yaw_cam_angle;var yaw_cam_quat=m_quat.setAxisAngle(m_util.AXIS_Y,-_yaw_cam_angle,_quat_tmp2);if(control_type==HMD_ALL_AXES_MOUSE_YAW)var new_cam_quat=m_quat.multiply(yaw_cam_quat,hmd_quat,_quat_tmp);else{var yaw_hmd_quat=m_util.quat_project(hmd_quat,m_util.AXIS_MY,m_util.AXIS_Y,m_util.AXIS_MZ,_quat_tmp3);var yaw_hmd_inv_quat=m_quat.invert(yaw_hmd_quat,
_quat_tmp3);var vertical_hmd_quat=m_quat.multiply(yaw_hmd_inv_quat,hmd_quat,_quat_tmp3);var new_cam_quat=m_quat.multiply(yaw_cam_quat,vertical_hmd_quat,_quat_tmp)}var up_axis=m_vec3.transformQuat(m_util.AXIS_Z,new_cam_quat,_vec3_tmp);m_cam.set_vertical_axis(cam_obj,up_axis);m_trans.set_rotation_v(cam_obj,new_cam_quat);m_quat.copy(new_cam_quat,_last_cam_quat)}}}};m_ctl.create_sensor_manifold(null,"HMD_ROTATE_CAMERA",m_ctl.CT_CONTINUOUS,[elapsed,sensor],null,move_cam_cb)}exports.disable_hmd=function(){m_ctl.remove_sensor_manifold(null,
"HMD_ROTATE_CAMERA");m_input.disable_split_screen();var cam_obj=m_scenes.get_active_camera();if(_was_target_camera)m_cam.target_setup(cam_obj);else if(_was_hover_camera)m_cam.hover_setup(cam_obj);else if(_was_static_camera)m_cam.static_setup(cam_obj);m_cam.set_vertical_axis(cam_obj,m_util.AXIS_Y);var cam_quat=m_trans.get_rotation(cam_obj,_quat_tmp);m_trans.set_rotation_v(cam_obj,cam_quat)}};b4w.module["mixer"]=function(exports,require){var m_ctl=require("controls");var m_hud=require("hud");var m_scenes=require("scenes");var m_sfx=require("sfx");var m_util=require("util");var TIMER_SLOW_PERIOD=.15;var TIMER_FAST_PERIOD=.05;var MIXER_CONTROLS_MANIFOLD=["SWITCH_STRIP","SWITCH_STRIP_HOLD","SWITCH_PARAM","INC_DEC","INC_DEC_HOLD","MUTE_SOLO"];var _mixer_strips=[];var _active_strip=0;var _filter_freq_arr=null;var _filter_mag_arr=null;var _filter_phase_arr=null;exports.enable_mixer_controls=
function(){init();var key_left_sqbr=m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT_SQ_BRACKET);var key_right_sqbr=m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT_SQ_BRACKET);var key_semi=m_ctl.create_keyboard_sensor(m_ctl.KEY_SEMI_COLON);var key_quote=m_ctl.create_keyboard_sensor(m_ctl.KEY_SINGLE_QUOTE);var key_shift=m_ctl.create_keyboard_sensor(m_ctl.KEY_SHIFT);var timer_slow=m_ctl.create_timer_sensor(TIMER_SLOW_PERIOD,true);var timer_fast=m_ctl.create_timer_sensor(TIMER_FAST_PERIOD,true);var mixer_keys=
[key_left_sqbr,key_right_sqbr,key_semi,key_quote,key_shift,timer_slow,timer_fast];var switch_strip_logic=function(s){return(s[0]||s[1])&&!s[4]};var switch_strip_logic_hold=function(s){return(s[0]||s[1])&&!s[4]&&s[5]};var switch_param_logic=function(s){return(s[0]||s[1])&&s[4]};var switch_spk_cb=function(obj,id,pulse){if(pulse==1){var dir=Boolean(m_ctl.get_sensor_value(obj,id,0))?-1:1;switch_strip(dir);if(id=="SWITCH_STRIP")m_ctl.reset_timer_sensor(obj,id,5,TIMER_SLOW_PERIOD+.3);else m_ctl.reset_timer_sensor(obj,
id,5,TIMER_SLOW_PERIOD)}else m_ctl.reset_timer_sensor(obj,id,5,10)};m_ctl.create_sensor_manifold(null,"SWITCH_STRIP",m_ctl.CT_TRIGGER,mixer_keys,switch_strip_logic,switch_spk_cb);m_ctl.create_sensor_manifold(null,"SWITCH_STRIP_HOLD",m_ctl.CT_SHOT,mixer_keys,switch_strip_logic_hold,switch_spk_cb);var switch_param_cb=function(obj,id,pulse){var dir=Boolean(m_ctl.get_sensor_value(obj,id,0))?-1:1;switch_param(dir)};m_ctl.create_sensor_manifold(null,"SWITCH_PARAM",m_ctl.CT_SHOT,mixer_keys,switch_param_logic,
switch_param_cb);var inc_dec_cb=function(obj,id,pulse){if(pulse==1){var dir=Boolean(m_ctl.get_sensor_value(obj,id,2))?-1:1;param_inc_dec(dir);if(id=="INC_DEC")m_ctl.reset_timer_sensor(obj,id,6,TIMER_FAST_PERIOD+.3);else m_ctl.reset_timer_sensor(obj,id,6,TIMER_FAST_PERIOD)}else m_ctl.reset_timer_sensor(obj,id,6,10)};var inc_dec_logic=function(s){return(s[2]||s[3])&&!s[4]};var inc_dec_logic_hold=function(s){return(s[2]||s[3])&&!s[4]&&s[6]};m_ctl.create_sensor_manifold(null,"INC_DEC",m_ctl.CT_TRIGGER,
mixer_keys,inc_dec_logic,inc_dec_cb);m_ctl.create_sensor_manifold(null,"INC_DEC_HOLD",m_ctl.CT_SHOT,mixer_keys,inc_dec_logic_hold,inc_dec_cb);var mute_solo_cb=function(obj,id,pulse){var mute_solo=Boolean(m_ctl.get_sensor_value(obj,id,2));if(mute_solo)switch_mute();else switch_solo()};var mute_solo_logic=function(s){return(s[2]||s[3])&&s[4]};m_ctl.create_sensor_manifold(null,"MUTE_SOLO",m_ctl.CT_SHOT,mixer_keys,mute_solo_logic,mute_solo_cb);var elapsed=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(null,
"MIXER_DRAW",m_ctl.CT_CONTINUOUS,[elapsed],null,function(){draw()});var timer=m_ctl.create_timer_sensor(1,true);m_ctl.create_sensor_manifold(null,"MIXER_UPDATE",m_ctl.CT_TRIGGER,[timer],null,function(){var strip_range=active_strip_range();for(var i=strip_range[0];i<=strip_range[1];i++)update_strip_params(_mixer_strips[i])})};exports.disable_mixer_controls=function(){for(var i=0;MIXER_CONTROLS_MANIFOLD.length;i++)m_ctl.remove_sensor_manifold(null,MIXER_CONTROLS_MANIFOLD[i])};function init(){_mixer_strips.length=
0;_active_strip=0;_filter_freq_arr=gen_freq_arr(100);_filter_mag_arr=new Float32Array(_filter_freq_arr.length);_filter_phase_arr=new Float32Array(_filter_freq_arr.length);var speakers=m_sfx.get_speaker_objects();if(!speakers.length)return;_mixer_strips.push(create_master_strip());for(var i=0;i<speakers.length;i++){var spk=speakers[i];_mixer_strips.push(create_speaker_strip(spk))}_mixer_strips.sort(function(a,b){if(a.id=="MASTER")return-1;else if(b.id=="MASTER")return 1;else if(a.id=="COMPRESSOR")return-1;
else if(b.id=="COMPRESSOR")return 1;else if(a.id.toUpperCase()<b.id.toUpperCase())return-1;else if(a.id.toUpperCase()>b.id.toUpperCase())return 1;else return 0})}function gen_freq_arr(steps){var FMIN=20;var FMAX=2E4;var freq_arr=new Float32Array(steps);var freq_base=FMAX/FMIN;var freq_pow=0;for(var i=0;i<steps;i++){freq_arr[i]=FMIN*Math.pow(freq_base,freq_pow);freq_pow+=1/(steps-1)}return freq_arr}function create_master_strip(){var strip=init_strip("MASTER");strip.params.push(["VOLUME",m_sfx.get_volume(null),
0,1,50,false]);var cparams=m_sfx.get_compressor_params();if(cparams){strip.params.push(["THRESHOLD",cparams["threshold"],-100,0,100,false]);strip.params.push(["KNEE",cparams["knee"],0,40,40,false]);strip.params.push(["RATIO",cparams["ratio"],1,20,20,false]);strip.params.push(["ATTACK",cparams["attack"],0,1,1E3,false]);strip.params.push(["RELEASE",cparams["release"],0,1,1E3,false])}strip.mute=m_sfx.is_muted(null)?1:0;strip.solo=-1;return strip}function init_strip(id){return{id:id,params:[],active_param:0,
mute:-1,solo:-1,speaker:null}}function create_speaker_strip(spk){var strip=init_strip(m_scenes.get_object_name(spk));strip.mute=m_sfx.is_muted(spk)?1:0;strip.solo=0;strip.speaker=spk;return strip}function switch_strip(dir){if(!_mixer_strips.length)return;if(dir==1&&_active_strip<_mixer_strips.length-1)_active_strip++;else if(dir==-1&&_active_strip>0)_active_strip--;var strip_range=active_strip_range();for(var i=strip_range[0];i<=strip_range[1];i++)update_strip_params(_mixer_strips[i])}function update_strip_params(strip){if(!strip.speaker)return;
strip.params.length=0;strip.params.push(["VOLUME",m_sfx.get_volume(strip.speaker),0,1,50,false]);var pparams=m_sfx.get_positional_params(strip.speaker);if(pparams){strip.params.push(["DIST_REF",pparams["dist_ref"],0,1E3,1E4,false]);strip.params.push(["ATTENUATION",pparams["attenuation"],0,50,1E3,false]);strip.params.push(["DIST_MAX",pparams["dist_max"],0,1E4,1E4,false])}var fparams=m_sfx.get_filter_params(strip.speaker);if(fparams){strip.params.push(["EQ_FREQ",fparams["freq"],20,2E4,100,true]);strip.params.push(["EQ_Q",
fparams["Q"],0,10,100,false]);strip.params.push(["EQ_GAIN",fparams["gain"],-70,30,100,false])}m_util.clamp(strip.active_param,0,strip.params.length-1)}function switch_param(dir){var strip=_mixer_strips[_active_strip];if(!strip)return;if(dir==1&&strip.active_param<strip.params.length-1)strip.active_param++;else if(dir==-1&&strip.active_param>0)strip.active_param--}function param_inc_dec(dir){var strip=_mixer_strips[_active_strip];if(!strip)return;var param=strip.params[strip.active_param];if(param[5])param[1]*=
Math.pow(param[3]/param[2],dir/param[4]);else param[1]+=dir*((param[3]-param[2])/param[4]);param[1]=m_util.clamp(param[1],param[2],param[3]);switch(param[0]){case "VOLUME":if(strip.id!="MASTER")m_sfx.set_volume(strip.speaker,param[1]);else m_sfx.set_volume(null,param[1]);break;case "DIST_REF":var pparams=m_sfx.get_positional_params(strip.speaker);pparams["dist_ref"]=param[1];m_sfx.set_positional_params(strip.speaker,pparams);break;case "ATTENUATION":var pparams=m_sfx.get_positional_params(strip.speaker);
pparams["attenuation"]=param[1];m_sfx.set_positional_params(strip.speaker,pparams);break;case "DIST_MAX":var pparams=m_sfx.get_positional_params(strip.speaker);pparams["dist_max"]=param[1];m_sfx.set_positional_params(strip.speaker,pparams);break;case "EQ_FREQ":var fparams=m_sfx.get_filter_params(strip.speaker);fparams["freq"]=param[1];m_sfx.set_filter_params(strip.speaker,fparams);break;case "EQ_Q":var fparams=m_sfx.get_filter_params(strip.speaker);fparams["Q"]=param[1];m_sfx.set_filter_params(strip.speaker,
fparams);break;case "EQ_GAIN":var fparams=m_sfx.get_filter_params(strip.speaker);fparams["gain"]=param[1];m_sfx.set_filter_params(strip.speaker,fparams);break;case "THRESHOLD":var cparams=m_sfx.get_compressor_params();cparams["threshold"]=param[1];m_sfx.set_compressor_params(cparams);break;case "KNEE":var cparams=m_sfx.get_compressor_params();cparams["knee"]=param[1];m_sfx.set_compressor_params(cparams);break;case "RATIO":var cparams=m_sfx.get_compressor_params();cparams["ratio"]=param[1];m_sfx.set_compressor_params(cparams);
break;case "ATTACK":var cparams=m_sfx.get_compressor_params();cparams["attack"]=param[1];m_sfx.set_compressor_params(cparams);break;case "RELEASE":var cparams=m_sfx.get_compressor_params();cparams["release"]=param[1];m_sfx.set_compressor_params(cparams);break;default:throw"Unknown strip param";break}}function switch_mute(){var strip=_mixer_strips[_active_strip];if(!strip)return;if(strip.mute>=0)flip_strip_mute(strip)}function flip_strip_mute(strip){var id=strip.id;if(id!="MASTER")if(strip.mute==0){strip.mute=
1;m_sfx.mute(strip.speaker,true);if(strip.solo==1){strip.solo=0;if(!is_other_solo(strip))unmute_other(strip)}}else{strip.mute=0;if(!is_other_solo(strip))m_sfx.mute(strip.speaker,false)}else if(strip.mute==0){strip.mute=1;m_sfx.mute(null,true)}else{strip.mute=0;m_sfx.mute(null,false)}}function is_other_solo(strip){for(var i=0;i<_mixer_strips.length;i++){var strip_i=_mixer_strips[i];if(strip_i!=strip&&strip_i.solo==1)return true}return false}function mute_other(strip){for(var i=0;i<_mixer_strips.length;i++){var strip_i=
_mixer_strips[i];if(strip_i!=strip&&strip_i.mute==0&&strip_i.solo==0)m_sfx.mute(strip_i.speaker,true)}}function unmute_other(strip){for(var i=0;i<_mixer_strips.length;i++){var strip_i=_mixer_strips[i];if(strip_i!=strip&&strip_i.mute==0&&strip_i.solo==0)m_sfx.mute(strip_i.speaker,false)}}function switch_solo(){var strip=_mixer_strips[_active_strip];if(!strip)return;if(strip.solo>=0)flip_strip_solo(strip)}function flip_strip_solo(strip){if(strip.solo==0){strip.solo=1;m_sfx.mute(strip.speaker,false);
if(strip.mute==1)strip.mute=0;mute_other(strip)}else{strip.solo=0;if(is_other_solo(strip))m_sfx.mute(strip.speaker,true);else unmute_other(strip)}}function draw(){if(!_mixer_strips[_active_strip])return;var strip_range=active_strip_range();for(var i=strip_range[0];i<=strip_range[1];i++){var strip=_mixer_strips[i];m_hud.draw_mixer_strip(strip.id,i==_active_strip,i%8,strip.params,strip.active_param,strip.mute,strip.solo);if(strip.speaker&&m_sfx.get_filter_params(strip.speaker)){m_sfx.get_filter_freq_response(strip.speaker,
_filter_freq_arr,_filter_mag_arr,_filter_phase_arr);for(var j=0;j<_filter_mag_arr.length;j++){var mag=_filter_mag_arr[j];_filter_mag_arr[j]=20*Math.log(mag)/Math.LN10}m_hud.plot_array("EQ",i%8,_filter_mag_arr,20,2E4,-10,10)}}}function active_strip_range(){if(_mixer_strips.length==0)return[0,-1];var strip_low=Math.floor(_active_strip/8)*8;var strip_high=strip_low+7;strip_low=m_util.clamp(strip_low,0,_mixer_strips.length-1);strip_high=m_util.clamp(strip_high,0,_mixer_strips.length-1);return[strip_low,
strip_high]}};b4w.module["npc_ai"]=function(exports,require){var m_anim=require("animation");var m_ctl=require("controls");var m_quat=require("quat");var m_scs=require("scenes");var m_time=require("time");var m_trans=require("transform");var m_util=require("util");var m_vec3=require("vec3");var _ev_tracks=[];var _mat3_tmp=new Float32Array(9);var _vec3_tmp=new Float32Array(3);var _vec3_tmp_2=new Float32Array(3);var _vec3_tmp_3=new Float32Array(3);var _vec3_tmp_4=new Float32Array(3);var _quat4_tmp=new Float32Array(4);
var _quat4_tmp_2=new Float32Array(4);var _quat4_tmp_3=new Float32Array(4);var NT_WALKING=exports.NT_WALKING=10;var NT_FLYING=exports.NT_FLYING=20;var NT_SWIMMING=exports.NT_SWIMMING=30;var MS_IDLE=10;var MS_MOVING=20;var NPC_MAX_ACTIVITY_DISTANCE=100;exports.new_event_track=function(graph){graph.destination=new Float32Array(3);graph.start=[];graph.ended=[];graph.fired=[];graph.y_correction=null;graph.prev_hit_pos=null;graph.y_cor_water=null;graph.reached=true;graph.rotation_mult=1;if(!graph.random)for(var i=
0;i<graph.path.length;i++){graph.start[i]=-1;graph.ended[i]=false;graph.fired[i]=false}_ev_tracks.push(graph)};function run_track(elapsed,ev_track){var destination=ev_track.destination;var base_pos=_vec3_tmp;m_trans.get_translation(ev_track.empty,base_pos);var current_loc=_vec3_tmp_2;m_trans.get_translation(ev_track.collider,current_loc);var y_correction=0;if(ev_track.y_cor_water)y_correction=ev_track.y_cor_water;else if(ev_track.y_correction){y_correction=ev_track.y_correction;if(ev_track.type==
NT_WALKING)y_correction*=.5;if(ev_track.type==NT_SWIMMING)y_correction*=elapsed}switch(ev_track.type){case NT_WALKING:if(ev_track.random&&ev_track.reached){destination[0]=(Math.random()*12-6)*ev_track.speed+base_pos[0];destination[2]=(Math.random()*12-6)*ev_track.speed+base_pos[2];move_destination_if_too_close(ev_track,destination,current_loc);ev_track.reached=false}destination[1]=current_loc[1];if(y_correction)destination[1]+=y_correction;break;case NT_FLYING:case NT_SWIMMING:if(ev_track.random&&
ev_track.reached){if(ev_track.type==NT_SWIMMING){ev_track.speed=Math.random()+.1;var magnitude=ev_track.max_depth-ev_track.min_depth}else var magnitude=ev_track.max_height-ev_track.min_height;var rot_speed=ev_track.rot_speed;destination[0]=Math.random()*10-5+base_pos[0];destination[1]=current_loc[1]+(Math.random()*magnitude-.5*magnitude);destination[2]=Math.random()*10-5+base_pos[2];ev_track.reached=false}if(y_correction)destination[1]=current_loc[1]+y_correction;break}anim_translation(elapsed,ev_track)}
function move_destination_if_too_close(ev_track,dest,cur_loc){var cur_rot_q=_quat4_tmp_2;var cur_hor_dir=_vec3_tmp_3;var speed=ev_track.speed;var rot_speed=ev_track.rot_speed;m_trans.get_rotation(ev_track.collider,cur_rot_q);m_vec3.transformQuat(m_util.AXIS_Z,cur_rot_q,cur_hor_dir);cur_hor_dir[1]=0;m_vec3.normalize(cur_hor_dir,cur_hor_dir);var sin_half_rot_angle=Math.sin(rot_speed/2);var walk_radius=.5*speed/sin_half_rot_angle;var dist=m_vec3.dist(dest,cur_loc);if(dist<2*walk_radius)m_vec3.scaleAndAdd(dest,
cur_hor_dir,2*walk_radius-dist,dest)}function anim_translation(elapsed,ev_track){var cur_loc=_vec3_tmp;var cur_dir=_vec3_tmp_2;var new_hor_dir=_vec3_tmp_3;var new_rot_q=_quat4_tmp_3;var rig=ev_track.rig;var collider=ev_track.collider;var dest=ev_track.destination;var speed=ev_track.speed;var actions=ev_track.actions;var cur_anim=m_anim.get_current_anim_name(rig);if(m_anim.is_play(rig)&&actions.idle&&actions.idle.indexOf(cur_anim)!=-1)return;m_trans.get_translation(collider,cur_loc);var delta_x=dest[0]-
cur_loc[0];var delta_z=dest[2]-cur_loc[2];var left_to_pass=Math.sqrt(delta_x*delta_x+delta_z*delta_z);if(left_to_pass>2*speed*elapsed){ev_track.state=MS_MOVING;m_util.xz_direction(dest,cur_loc,new_hor_dir);dest_anim_correction(ev_track,dest,left_to_pass,new_hor_dir);hor_rot(ev_track,cur_dir,elapsed,new_rot_q,new_hor_dir);vert_rot(ev_track,cur_dir,elapsed,new_rot_q);m_trans.set_rotation_v(collider,new_rot_q);trans_obj(elapsed,new_rot_q,ev_track,cur_loc,dest)}else if(ev_track.type==NT_WALKING)if(!actions.move){ev_track.state=
MS_IDLE;ev_track.reached=true}else if(cur_anim&&actions.move.indexOf(cur_anim)!=-1&&m_anim.is_play(rig))ev_track.state=MS_MOVING;else{ev_track.state=MS_IDLE;ev_track.reached=true}else if(ev_track.type==NT_SWIMMING||ev_track.type==NT_FLYING)ev_track.reached=true;if(need_proper_animation(ev_track))apply_animation(ev_track)}function hor_rot(ev_track,cur_dir,elapsed,new_rot_q,new_hor_dir){var cur_rot_q=_quat4_tmp_2;var cur_hor_dir=_vec3_tmp_4;m_trans.get_rotation(ev_track.collider,cur_rot_q);m_vec3.transformQuat(m_util.AXIS_Z,
cur_rot_q,cur_dir);cur_hor_dir[0]=cur_dir[0];cur_hor_dir[1]=0;cur_hor_dir[2]=cur_dir[2];m_vec3.normalize(cur_hor_dir,cur_hor_dir);var vec_dot=m_vec3.dot(cur_hor_dir,new_hor_dir);var angle_to_turn=Math.acos(vec_dot);var angle_ratio=Math.abs(angle_to_turn)/Math.PI;var slerp=elapsed/angle_ratio*ev_track.rot_speed*ev_track.rotation_mult;m_quat.rotationTo(cur_hor_dir,new_hor_dir,new_rot_q);m_quat.rotationTo(m_util.AXIS_Z,cur_hor_dir,cur_rot_q);if(Math.abs(vec_dot)>=1){m_quat.copy(cur_rot_q,new_rot_q);
return}m_quat.multiply(new_rot_q,cur_rot_q,new_rot_q);m_quat.slerp(cur_rot_q,new_rot_q,Math.min(slerp,1),new_rot_q)}function vert_rot(ev_track,cur_dir,elapsed,new_rot_q){if(ev_track.type==NT_FLYING)return;elapsed=Math.max(elapsed,1/60);var new_vert_q=_quat4_tmp;var cur_vert_q=_quat4_tmp_2;var cur_vert_angle=Math.asin(cur_dir[1]);m_quat.setAxisAngle(m_util.AXIS_X,-cur_vert_angle,cur_vert_q);var delta_hor_dist=ev_track.speed*elapsed;var delta_vert_dist=ev_track.y_correction;var new_vert_angle=Math.atan(delta_vert_dist/
delta_hor_dist);m_quat.setAxisAngle(m_util.AXIS_X,-new_vert_angle,new_vert_q);m_quat.slerp(cur_vert_q,new_vert_q,elapsed,new_vert_q);m_quat.multiply(new_rot_q,new_vert_q,new_rot_q)}function trans_obj(elapsed,new_rot_q,ev_track,cur_loc,dest){var new_dir=_vec3_tmp_3;var new_loc=_vec3_tmp_4;var def_dir=m_util.AXIS_Z;m_util.quat_to_dir(new_rot_q,def_dir,new_dir);m_vec3.scale(new_dir,ev_track.speed*elapsed,new_loc);m_vec3.add(new_loc,cur_loc,new_loc);if(ev_track.type!=NT_WALKING)new_loc[1]=(dest[1]-cur_loc[1])*
elapsed*.1+cur_loc[1];else new_loc[1]=dest[1];m_trans.set_translation_v(ev_track.collider,new_loc)}exports.enable_animation=function(){if(!_ev_tracks.length)return;create_sensors();var elapsed_cb=function(obj,id,pulse){if(pulse==1){var elapsed=m_ctl.get_sensor_value(obj,id,0);for(var i=0;i<_ev_tracks.length;i++)process_event_track(_ev_tracks[i],elapsed)}};var elapsed_sensor=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(_ev_tracks[0].collider,"ELAPSED",m_ctl.CT_CONTINUOUS,[elapsed_sensor],
function(s){return s[0]},elapsed_cb)};exports.disable_animation=function(){if(_ev_tracks.length<=0)return;for(var i=0;i<_ev_tracks.length;i++){var ev=_ev_tracks[i];if(m_ctl.check_sensor_manifolds(ev.collider))m_ctl.remove_sensor_manifold(ev.collider);if(m_anim.is_play(ev.rig))m_anim.stop(ev.rig)}};function elapsed_cb(obj,id,pulse){if(pulse==1)for(var i=0;i<_ev_tracks.length;i++){var elapsed=m_ctl.get_sensor_value(obj,id,0);process_event_track(_ev_tracks[i],elapsed)}}function process_event_track(ev_track,
elapsed){if(!m_scs.is_visible(ev_track.obj))return;if(ev_track.random)run_track(elapsed,ev_track);else{var focus_time=m_time.get_timeline();for(var j=0;j<ev_track.path.length;j++){if(ev_track.ended[j])continue;if(!ev_track.fired[j]){ev_track.fired[j]=true;ev_track.destination[0]=ev_track.path[j][0];ev_track.destination[1]=ev_track.path[j][1];ev_track.destination[2]=ev_track.path[j][2];ev_track.start[j]=focus_time+ev_track.delay[j]}if(focus_time<ev_track.start[j])break;run_track(elapsed,ev_track);
ev_track.ended[j]=ev_track.reached;break}if(is_all_ended(ev_track))unset_all_fired(ev_track)}}function unset_all_fired(track){for(var i=0;i<track.path.length;i++){track.fired[i]=false;track.ended[i]=false}}function is_all_ended(track){for(var i=0;i<track.path.length;i++)if(track.ended[i]==false)return false;return true}function ground_cb(obj,id,pulse,ev){if(!ev)return;if(pulse==1){var hit_pos;switch(ev.type){case NT_FLYING:hit_pos=100*flying_npc_hit_position(obj,id);if(hit_pos<ev.min_height)ev.y_correction=
10;else if(hit_pos>ev.max_height)ev.y_correction=-10;else ev.y_correction=0;break;case NT_WALKING:hit_pos=m_ctl.get_sensor_payload(obj,id,0).hit_fract;if(ev.prev_hit_pos==hit_pos)ev.y_correction=0;else ev.y_correction=1-hit_pos*100;ev.prev_hit_pos=hit_pos;break;case NT_SWIMMING:hit_pos=m_ctl.get_sensor_payload(obj,id,0).hit_fract;if(id=="CLOSE_GROUND"){ev.y_correction=hit_pos*100-1;if(ev.y_correction<.1)ev.y_correction=.05;else ev.y_correction=0}else if(id=="CLOSE_WATER"){ev.y_cor_water=hit_pos*100;
if(ev.y_cor_water<ev.min_depth)ev.y_cor_water=-.02;else if(ev.y_cor_water>ev.max_depth)ev.y_cor_water=.02;else ev.y_cor_water=0}break}}else ev.y_correction=0}function flying_npc_hit_position(obj,id){for(var i=0;i<3;i++){var hit_pos=m_ctl.get_sensor_payload(obj,id,i).hit_fract;if(hit_pos)return hit_pos}}function create_sensors(){for(var i=0;i<_ev_tracks.length;i++){var ev_track=_ev_tracks[i];create_track_ray_sensors(ev_track);create_track_collision_sensors(ev_track);if(ev_track.rig&&m_anim.get_current_anim_name(ev_track.rig))m_anim.play(ev_track.rig)}}
function create_track_ray_sensors(ev_track){var ZERO_POINT=m_vec3.create();var collider=ev_track.collider;switch(ev_track.type){case NT_FLYING:var near_ground_sens=m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,-100,0],"TERRAIN",true);var near_stone_sens=m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,-100,0],"STONE",true);var near_water_sens=m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,-100,0],"WATER",true);var ground_sens_arr=[near_ground_sens,near_stone_sens,near_water_sens];m_ctl.create_sensor_manifold(collider,
"CLOSE_GROUND",m_ctl.CT_CONTINUOUS,ground_sens_arr,function(s){return s[0]||s[1]||s[2]},ground_cb,ev_track);break;case NT_WALKING:var near_ground_sens=m_ctl.create_ray_sensor(collider,[0,1,0],[0,-99,0],"TERRAIN",true);var ground_sens_arr=[near_ground_sens];m_ctl.create_sensor_manifold(collider,"CLOSE_GROUND",m_ctl.CT_CONTINUOUS,ground_sens_arr,null,ground_cb,ev_track);break;case NT_SWIMMING:var near_ground_sens=m_ctl.create_ray_sensor(collider,[0,1,0],[0,-99,0],"TERRAIN",true);var near_water_sens=
m_ctl.create_ray_sensor(collider,ZERO_POINT,[0,100,0],"WATER",true);var ground_sens_arr=[near_ground_sens];var water_sens_arr=[near_water_sens];m_ctl.create_sensor_manifold(collider,"CLOSE_WATER",m_ctl.CT_CONTINUOUS,water_sens_arr,null,ground_cb,ev_track);m_ctl.create_sensor_manifold(collider,"CLOSE_GROUND",m_ctl.CT_CONTINUOUS,ground_sens_arr,null,ground_cb,ev_track);break}}function create_track_collision_sensors(ev_track){var collider=ev_track.collider;if(ev_track.type!=NT_WALKING)return;var need_payload=
false;var collision_sensor=m_ctl.create_collision_sensor(collider,"CONSTRUCTION",need_payload);function collision_cb(obj,id,pulse){if(pulse==1){m_trans.get_translation(ev_track.empty,ev_track.destination);ev_track.rotation_mult=4}else ev_track.rotation_mult=1}m_ctl.create_sensor_manifold(collider,"CONSTRUCTION_COLL",m_ctl.CT_CONTINUOUS,[collision_sensor],null,collision_cb)}function need_proper_animation(ev_track){var obj=ev_track.rig;if(!m_anim.is_play(obj))return true;var cur_anim=m_anim.get_current_anim_name(obj);
if(!cur_anim)return true;var actions=ev_track.actions;switch(ev_track.state){case MS_IDLE:if(!actions.idle)return false;if(actions.idle.indexOf(cur_anim)==-1)return true;break;case MS_MOVING:if(!actions.move)return false;if(actions.move.indexOf(cur_anim)!=-1)return false;if(actions.move_start&&actions.move_start.indexOf(cur_anim)!=-1)return false;if(actions.move_blends&&actions.move_blends.indexOf(cur_anim)!=-1)return false;break;default:return false}return true}function apply_animation(ev_track){var obj=
ev_track.rig;if(m_anim.is_play(obj))return;var anim_to_play=null;switch(ev_track.state){case MS_IDLE:anim_to_play=get_idle_animation(ev_track);break;case MS_MOVING:anim_to_play=get_move_animation(ev_track);break}if(anim_to_play){m_anim.apply(obj,anim_to_play);m_anim.set_behavior(obj,m_anim.AB_FINISH_RESET);m_anim.set_frame(obj,0);m_anim.play(obj)}}function get_idle_animation(ev_track){var actions=ev_track.actions;if(!actions.idle)return null;return m_util.random_from_array(actions.idle)}function get_move_animation(ev_track){var cur_anim=
m_anim.get_current_anim_name(ev_track.rig);var actions=ev_track.actions;if(need_move_blend_animation(ev_track,cur_anim))return get_proper_move_blend_animation(ev_track,cur_anim);if(need_move_animation(ev_track,cur_anim))return get_proper_move_animation(ev_track,cur_anim);if(need_move_start_animation(ev_track,cur_anim))return m_util.random_from_array(actions.move_start);return null}function need_move_animation(ev_track,cur_anim){var actions=ev_track.actions;if(!actions.move)return false;if(actions.move.indexOf(cur_anim)!=
-1)return true;if(!(actions.move_blends||actions.move_start))return true;if(!actions.move_start&&!cur_anim)return true;if(actions.move_blends&&actions.move_blends.indexOf(cur_anim)!=-1)return true;if(actions.move_start&&actions.move_start.indexOf(cur_anim)!=-1)return true;return false}function need_move_blend_animation(ev_track,cur_anim){var actions=ev_track.actions;if(!actions.move_blends)return false;if(actions.move_blends.indexOf(cur_anim)!=-1)return false;if(actions.move&&actions.move.indexOf(cur_anim)!=
-1){var identifier=Math.random();return identifier>.33}return false}function need_move_start_animation(ev_track,cur_anim){var actions=ev_track.actions;if(!actions.move_start)return false;if(actions.move_start.indexOf(cur_anim)!=-1)return false;if(actions.move&&actions.move.indexOf(cur_anim)==-1)return true;return false}function get_proper_move_blend_animation(ev_track,cur_anim){var actions=ev_track.actions;var ind=actions.move.indexOf(cur_anim);return actions.move_blends[ind]}function get_proper_move_animation(ev_track,
cur_anim){var actions=ev_track.actions;if(!actions.move_blends)return m_util.random_from_array(actions.move);var move_blend_anim_ind=actions.move_blends.indexOf(cur_anim);if(move_blend_anim_ind!=-1){var ind=move_blend_anim_ind+1;ind=ind<actions.move.length?ind:0;return actions.move[ind]}if(actions.move.indexOf(cur_anim)!=-1)return cur_anim;else return m_util.random_from_array(actions.move)}function dest_anim_correction(ev_track,dest,l_to_p,new_dir){var obj=ev_track.rig;if(!m_anim.is_animated(obj))return;
var speed=ev_track.speed;var left_to_pass=l_to_p;var cur_frame=m_anim.get_frame(obj);var anim_length=m_anim.get_anim_length(obj);var path_per_cycle=anim_length/24*speed;var left_to_pass_anim=(1-cur_frame/anim_length)*path_per_cycle;var correlation=left_to_pass/left_to_pass_anim;if(correlation<.9){var scale=left_to_pass_anim-left_to_pass;m_vec3.scaleAndAdd(dest,new_dir,scale,dest)}}};b4w.module["mouse"]=function(exports,require){var m_cam=require("camera");var m_cont=require("container");var m_ctl=require("controls");var m_phy=require("physics");var m_print=require("print");var m_scs=require("scenes");var m_util=require("util");var m_main=require("main");var FPS_MOUSE_MULT=4E-4;var DRAG_MOUSE_DELTA_MULT=2;var _smooth_factor=1;var CAM_SMOOTH_CHARACTER_MOUSE=.1;var CAM_SMOOTH_CHARACTER_TOUCH=.2;var PLS_NONE=0;var PLS_POINTERLOCK=1;var PLS_DRAG=2;var _mouse_x=0;var _mouse_y=0;var _mouse_delta=
new Float32Array(2);var _vec2_tmp=new Float32Array(2);var _use_mouse_control_cb=null;var _chosen_object=null;var _plock_state=PLS_NONE;exports.request_pointerlock=function(elem,enabled_cb,disabled_cb,mouse_move_cb,use_mouse_control_cb,rotation_cb){if(_plock_state==PLS_POINTERLOCK)return;_plock_state=PLS_POINTERLOCK;enabled_cb=enabled_cb||function(){};disabled_cb=disabled_cb||function(){};rotation_cb=rotation_cb||default_rotation_cb;use_mouse_control_cb=use_mouse_control_cb||function(){return true};
mouse_move_cb=mouse_move_cb||function(e){if(use_mouse_control_cb()){if(typeof e.movementX=="number"){var mx=e.movementX;var my=e.movementY}else if(typeof e.webkitMovementX=="number"){var mx=e.webkitMovementX;var my=e.webkitMovementY}else if(typeof e.mozMovementX=="number"){var mx=e.mozMovementX;var my=e.mozMovementY}else{var mx=0;var my=0}_mouse_delta[0]+=mx;_mouse_delta[1]+=my}};function on_pointerlock_change(){if(document.pointerLockElement===elem||document.webkitPointerLockElement===elem||document.mozPointerLockElement===
elem){exit_mouse_drag(elem);elem.addEventListener("mousemove",mouse_move_cb,false);var camera=m_scs.get_active_camera();if(!m_ctl.check_sensor_manifold(camera,"SMOOTH_PL")){var elapsed=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(camera,"SMOOTH_PL",m_ctl.CT_CONTINUOUS,[elapsed],null,smooth_cb,rotation_cb)}enabled_cb()}else{elem.removeEventListener("mousemove",mouse_move_cb,false);_plock_state=PLS_NONE;document.removeEventListener("pointerlockchange",on_pointerlock_change,false);document.removeEventListener("webkitpointerlockchange",
on_pointerlock_change,false);document.removeEventListener("mozpointerlockchange",on_pointerlock_change,false);disabled_cb()}}document.addEventListener("pointerlockchange",on_pointerlock_change,false);document.addEventListener("webkitpointerlockchange",on_pointerlock_change,false);document.addEventListener("mozpointerlockchange",on_pointerlock_change,false);var request_plock=elem.requestPointerLock||elem.webkitRequestPointerLock||elem.mozRequestPointerLock;if(typeof request_plock==="function")request_plock.apply(elem);
else m_print.error("Pointer lock is not available")};exports.exit_pointerlock=exit_pointerlock;function exit_pointerlock(){if(_plock_state==PLS_POINTERLOCK)_plock_state=PLS_NONE;var exit_plock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;if(typeof exit_plock==="function")exit_plock.apply(document);m_ctl.remove_sensor_manifold(m_scs.get_active_camera(),"SMOOTH_PL")}exports.check_pointerlock=function(elem){var request_plock=elem.requestPointerLock||elem.webkitRequestPointerLock||
elem.mozRequestPointerLock;if(typeof request_plock==="function")return true;else return false};exports.request_mouse_drag=request_mouse_drag;function request_mouse_drag(elem,use_mouse_control_cb,rotation_cb){if(_plock_state==PLS_DRAG)return;_plock_state=PLS_DRAG;exit_pointerlock();_use_mouse_control_cb=use_mouse_control_cb||function(){return true};rotation_cb=rotation_cb||default_rotation_cb;elem.addEventListener("mousedown",drag_mouse_down_cb,false);elem.addEventListener("mouseup",drag_mouse_up_cb,
false);var camera=m_scs.get_active_camera();if(!m_ctl.check_sensor_manifold(camera,"SMOOTH_DRAG")){var elapsed=m_ctl.create_elapsed_sensor();m_ctl.create_sensor_manifold(camera,"SMOOTH_DRAG",m_ctl.CT_CONTINUOUS,[elapsed],null,smooth_cb,rotation_cb)}}exports.exit_mouse_drag=exit_mouse_drag;function exit_mouse_drag(elem){if(_plock_state==PLS_DRAG)_plock_state=PLS_NONE;elem.removeEventListener("mousedown",drag_mouse_down_cb,false);elem.removeEventListener("mouseup",drag_mouse_up_cb,false);elem.removeEventListener("mousemove",
drag_mouse_move_cb,false);m_ctl.remove_sensor_manifold(m_scs.get_active_camera(),"SMOOTH_DRAG")}function drag_mouse_move_cb(e){if(_use_mouse_control_cb()){_mouse_delta[0]+=(e.clientX-_mouse_x)*DRAG_MOUSE_DELTA_MULT;_mouse_delta[1]+=(e.clientY-_mouse_y)*DRAG_MOUSE_DELTA_MULT;_mouse_x=e.clientX;_mouse_y=e.clientY}e.preventDefault()}function drag_mouse_down_cb(e){_mouse_x=e.clientX;_mouse_y=e.clientY;e.currentTarget.addEventListener("mousemove",drag_mouse_move_cb,false);e.preventDefault()}function drag_mouse_up_cb(e){e.currentTarget.removeEventListener("mousemove",
drag_mouse_move_cb,false);e.preventDefault()}function smooth_cb(obj,id,pulse,rot_callback){if(Math.abs(_mouse_delta[0])>.01||Math.abs(_mouse_delta[1])>.01){var elapsed=m_ctl.get_sensor_value(obj,id,0);var rot_x=m_util.smooth(_mouse_delta[0],0,elapsed,smooth_coeff_mouse());var rot_y=m_util.smooth(_mouse_delta[1],0,elapsed,smooth_coeff_mouse());_mouse_delta[0]-=rot_x;_mouse_delta[1]-=rot_y;rot_callback(-rot_x*FPS_MOUSE_MULT,-rot_y*FPS_MOUSE_MULT)}}function default_rotation_cb(rot_x,rot_y){var character=
m_scs.get_first_character();var camera=m_scs.get_active_camera();m_cam.eye_rotate(camera,rot_x,rot_y);if(character){var angles=m_cam.get_camera_angles_char(camera,_vec2_tmp);m_phy.set_character_rotation(character,angles[0],angles[1])}}exports.enable_mouse_hover_outline=enable_mouse_hover_outline;function enable_mouse_hover_outline(){if(!m_main.detect_mobile()){var main_canvas=m_cont.get_canvas();main_canvas.addEventListener("mousemove",objects_outline)}}exports.disable_mouse_hover_outline=disable_mouse_hover_outline;
function disable_mouse_hover_outline(){if(!m_main.detect_mobile()){var main_canvas=m_cont.get_canvas();main_canvas.removeEventListener("mousemove",objects_outline);if(_chosen_object)m_scs.set_outline_intensity(_chosen_object,0)}}function objects_outline(e){var canvas_xy=m_cont.client_to_canvas_coords(e.clientX,e.clientY,_vec2_tmp);var obj=m_scs.pick_object(canvas_xy[0],canvas_xy[1]);if(obj){if(m_scs.outlining_is_enabled(obj))m_scs.set_outline_intensity(obj,1);if(m_scs.outlining_is_enabled(_chosen_object)&&
obj!=_chosen_object)m_scs.set_outline_intensity(_chosen_object,0)}else if(m_scs.outlining_is_enabled(_chosen_object))m_scs.set_outline_intensity(_chosen_object,0);_chosen_object=obj}exports.get_coords_x=get_coords_x;function get_coords_x(event,target_touches){var touches=target_touches?event.targetTouches:event.touches;if("clientX"in event)return event.clientX;else if(touches&&"clientX"in touches[0])return touches[0].clientX;else return-1}exports.get_coords_y=get_coords_y;function get_coords_y(event,
target_touches){var touches=target_touches?event.targetTouches:event.touches;if("clientY"in event)return event.clientY;else if(touches&&"clientY"in touches[0])return touches[0].clientY;else return-1}function smooth_coeff_mouse(){return CAM_SMOOTH_CHARACTER_MOUSE*_smooth_factor}function smooth_coeff_touch(){return CAM_SMOOTH_CHARACTER_TOUCH*_smooth_factor}exports.set_plock_smooth_factor=function(value){_smooth_factor=value};exports.get_plock_smooth_factor=function(){return _smooth_factor}};b4w.module["preloader"]=function(exports,require){var m_app=require("app");var _preloader={};var _canvas_container_elem=null;exports.create_simple_preloader=function(options){var canvas_container_id=null;var background_container_id=null;var bar_color="#bf9221";var bg_color="#000";for(var opt in options)switch(opt){case "canvas_container_id":canvas_container_id=options.canvas_container_id;break;case "background_container_id":background_container_id=options.background_container_id;break;case "bg_color":bg_color=
options.bg_color;break;case "bar_color":bar_color=options.bar_color;break;case "preloader_fadeout":_preloader.fadeout=options.preloader_fadeout;break}var container=document.createElement("div");var frame=document.createElement("div");container.id="simple_preloader_container";var bar=document.createElement("div");var caption=document.createElement("div");var background_container=document.getElementById(background_container_id);_canvas_container_elem=document.getElementById(canvas_container_id);container.style.cssText=
"z-index: 4;"+"background-color: "+bg_color+";"+"width: 100%;"+"height: 100%;"+"position: absolute;"+"margin: 0;"+"padding: 0;"+"top: 0;"+"left: 0;";frame.style.cssText="position: absolute;"+"left: 50%;"+"top: 82%;"+"width: 300px;"+"height: 20px;"+"margin-left: -150px;"+"margin-top: -10px;"+"border-style:solid;"+"border-width:4px;"+"border-color: "+"#000"+";"+"border-radius: 0px;";bar.style.cssText="position: absolute;"+"left: 0px;"+"top: 1px;"+"width: 0px;"+"height: 18px;"+"background-color: "+bar_color+
";"+"border-radius: 0px;";caption.style.cssText="position: absolute;"+"left: 50%;"+"top: 50%;"+"width: 100%;"+"height: 100%;"+"margin-left: -150px;"+"margin-top: -10px;"+"text-align: center;"+"font-size: 17px;"+"font-weight: bold;"+"color: #000;"+"font-family: Verdana;"+frame.appendChild(bar);frame.appendChild(caption);container.appendChild(frame);document.body.appendChild(container);_preloader.type="SIMPLE";_preloader.container=container;_preloader.bar=bar;_preloader.caption=caption;_preloader.background=
background_container};exports.create_rotation_preloader=function(options){var canvas_container_id=null;var background_container_id=null;var frame_bg_color="rgba(0,0,0,0)";var frame_class="";var anim_elem_class="";var bg_color="rgba(0,0,0,0)";for(var opt in options)switch(opt){case "canvas_container_id":canvas_container_id=options.canvas_container_id;break;case "background_container_id":background_container_id=options.background_container_id;break;case "frame_bg_color":frame_bg_color=options.frame_bg_color;
break;case "bg_color":bg_color=options.bg_color;break;case "frame_class":frame_class=options.frame_class;break;case "anim_elem_class":anim_elem_class=options.anim_elem_class;break}var container=document.createElement("div");var frame=document.createElement("div");var anim_elem=document.createElement("div");var caption=document.createElement("div");var background_container=document.getElementById(background_container_id);_canvas_container_elem=document.getElementById(canvas_container_id);container.style.cssText=
"z-index: 4;"+"background-color: "+bg_color+";"+"width: 100%;"+"height: 100%;"+"position: absolute;"+"margin: 0;"+"padding: 0;"+"top: 0;"+"left: 0;";frame.style.cssText="position: absolute;"+"left: 50%;"+"top: 50%;"+"width: 117px;"+"height: 117px;"+"margin-left: -58px;"+"margin-top: -58px;"+"background-color: "+frame_bg_color+";";anim_elem.style.cssText="position: absolute;"+"left: 0px;"+"top: 0px;"+"width: 100%;"+"height: 100%;"+"background-position: center;"+"background-repeat: no-repeat;";caption.style.cssText=
"position: absolute;"+"width: 100%;"+"height: 100%;"+"text-align: center;"+"margin-top: 38px;"+"font-size: 36px;"+"color: #ffffff;"+"font-family: Arial;"+"font-weight: bold;";anim_elem.className=anim_elem_class;frame.appendChild(anim_elem);frame.className=frame_class;frame.appendChild(caption);container.appendChild(frame);_canvas_container_elem.appendChild(container);_preloader.type="ROTATION";_preloader.container=container;_preloader.anim_elem=anim_elem;_preloader.caption=caption;_preloader.background=
background_container};exports.create_advanced_preloader=function(options){var img_width=options.img_width;var preloader_width=options.preloader_width;var canvas_container_id=options.canvas_container_id;var preloader_container_id=options.preloader_container_id;var band_width=preloader_width-img_width;var ratio=preloader_width/band_width;var preloader_bar=document.getElementById(options.preloader_bar_id);var fill_band=document.getElementById(options.fill_band_id);var preloader_caption=document.getElementById(options.preloader_caption_id);
var preloader_container=document.getElementById(options.preloader_container_id);var background_container=document.getElementById(options.background_container_id);_canvas_container_elem=document.getElementById(canvas_container_id);_preloader.type="ADVANCED";_preloader.bar=preloader_bar;_preloader.fill=fill_band;_preloader.ratio=ratio;_preloader.caption=preloader_caption;_preloader.container=preloader_container;_preloader.background=background_container};exports.update_preloader=function(percentage){_preloader.caption.innerHTML=
percentage+"%";if(_preloader.type=="SIMPLE")_preloader.bar.style.width=percentage+"%";if(_preloader.type=="ADVANCED"){_preloader.bar.style.width=percentage/_preloader.ratio+"%";_preloader.fill.style.width=100-percentage+"%"}if(_preloader.type=="ROTATION")_preloader.anim_elem.style.transform="rotate("+percentage+"deg)";if(percentage==100)if(_preloader.fadeout){m_app.css_animate(_preloader.background,"opacity",1,0,1500,null,null,function(){_preloader.background.parentNode.removeChild(_preloader.background)});
m_app.css_animate(_preloader.container,"opacity",1,0,1E3,null,null,function(){_preloader.container.parentNode.removeChild(_preloader.container)})}else{_preloader.container.parentNode.removeChild(_preloader.container);if(_preloader.background)_preloader.background.parentNode.removeChild(_preloader.background)}}};b4w.module["storage"]=function(exports,require){var m_print=require("__print");var _prefix="b4w";var _storage=null;exports.init=init;function init(prefix){if(prefix)if(prefix!=="b4w")_prefix=prefix;else m_print.error("b4w prefix denied");else m_print.warn("Prefix should be a string. "+"Last declared storage prefix will be used.")}function init_storage(){try{_storage=window.localStorage;try{_storage["tmp"]=null;delete _storage["tmp"]}catch(e){m_print.warn("localStorage quota is limited. Disabling localStorage");
_storage=null}}catch(e){m_print.warn("Applying chrome localStorage bug workaround");_storage=null}if(!_storage){m_print.warn("localStorage is not available, initializing temporary storage");_storage={}}}exports.set=function(key,value,prefix){var b4w_st=get_b4w_storage(prefix);b4w_st[key]=String(value);set_b4w_storage(b4w_st,prefix)};function get_b4w_storage(prefix){if(_storage[prefix?prefix:_prefix])return JSON.parse(_storage[prefix?prefix:_prefix]);else return{}}function set_b4w_storage(b4w_storage,
prefix){_storage[prefix?prefix:_prefix]=JSON.stringify(b4w_storage)}exports.cleanup=function(prefix){delete _storage[prefix?prefix:_prefix]};exports.get=function(key,prefix){var b4w_st=get_b4w_storage(prefix);if(b4w_st[key])return b4w_st[key];else return""};exports.debug=function(prefix){m_print.log(get_b4w_storage(prefix?prefix:_prefix))};init_storage()};b4w.module["screenshooter"]=function(exports,require){var m_main=require("main");exports.shot=function(){var cb=function(data){var a=window.document.createElement("a");document.body.appendChild(a);a.style.display="none";a.href=data;a.download="screenshot.png";a.click();document.body.removeChild(a)};m_main.canvas_data_url(cb)}};
