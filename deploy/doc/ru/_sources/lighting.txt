.. _lighting:


.. index:: освещение

*********************
Освещение, тени и фон
*********************

.. index:: затенение, затенение; типы

Типы затенения
==============

Результат расчета освещения (затенения) зависит от направления векторов нормалей. Поддерживаются стандартные типы затенения, использующиеся в Blender, ``Shading: Flat`` (используются нормали граней) и ``Shading: Smooth`` (используются интерполированные нормали вершин), а также их комбинации.


.. image:: src_images/lighting/flat_smooth_shading.png
   :align: center
   :width: 100%

|


Если желаемый результат недостижим стандартными средствами, можно воспользоваться :ref:`редактором нормалей <normals_editor>`.

Результат применения различных типов затенения и использования редактора нормалей:

.. image:: src_images/lighting/different_shadings_comparison.jpg
   :align: center
   :width: 100%


#. Flat Shading
#. Smooth Shading
#. Smooth Shading + фаска
#. Smooth Shading + фаска + редактирование нормалей


.. _normals_editor:

.. index:: нормали, нормали; редактор

Редактор нормалей
=================

Редактирование нормалей - достаточно простой и эффективный способ изменить собственное затенение трехмерной модели, не усложняя ее геометрию.

С помощью редактора нормалей, в некоторых случаях, можно достичь результатов, аналогичных применению :ref:`карт нормалей <normal_map>`. При этом метод редактирования нормалей является более предпочтительным с точки зрения потребления вычислительных ресурсов и видео-памяти.

Пример работы редактора нормалей:

    .. image:: src_images/lighting/vnt_img01.jpg
       :align: center
       :width: 100%

Слева - обычное затенение геометрии, справа - дерево с редактированными нормалями.


    .. image:: src_images/lighting/vnt_img02.jpg
       :align: center
       :width: 100%

Слева - ворота с обычным затенением, в центре - ворота с редактированными нормалями, справа - геометрия модели ворот с сеткой.

    .. image:: src_images/lighting/vnt_img03.jpg
       :align: center
       :width: 100%

Слева - обычное затенение геометрии травы, справа - трава с редактированными нормалями.

    .. image:: src_images/lighting/vnt_img04.jpg
       :align: center
       :width: 100%

Слева - очки с обычным затенением, справа - затенение геометрии с редактированными нормалями.

Основные особенности редактора нормалей:
----------------------------------------

#. для хранилища массива данных с направлениями вертексных нормалей используется "родной" блок данных Blender (появился в версии 2.74);
#. редактирование нормалей и отображение затенения теперь происходит в режиме редактирования (``Edit Mode``);
#. все изменения записываются сразу же автоматически;
#. вращение нормали выделенного вертекса можно производить непосредственно в окне Viewport'a по горячим клавишам ``Shift+Ctrl+R``, подобно остальным операциям вращения в Blender;
#. редактированные нормали экспортируются автоматически.

Интерфейс редактора вертексных нормалей
---------------------------------------

Интерфейс редактора нормалей располагается на панели инструментов ``Blend4Web > Normal Editor``. Перед началом работы редактора для объекта необходимо включить режим затенения ``Shading: Smooth`` и нажать кнопку ``Activate`` на панели редактора нормалей или выставить галочку ``Auto Smooth`` в настройках меша.

.. image:: src_images/lighting/vnt_img05.jpg
   :align: center
   :width: 100%

Activate
--------

*Описание*

Новая кнопка ``Activate`` включает режим редактирования вертекных нормалей.

*Использование*

Достаточно в режиме ``Edit Mode`` нажать кнопу ``Activate``, и можно приступать к редактированию вертексных нормалей. Пока она остаётся в активном режиме, затенение объекта и его экспорт будут осуществляться с учетом редактированных вертексных нормалей. Другими словами, после внесения изменений, для их отображения во Viewport'е Blender и в движке Blend4Web кнопка должна быть оставлена активной.

Show Normals
------------

*Описание*

Для удобства в панель продублирована оригинальная кнопка Blender, включающая отображение маркеров вертексных нормалей во Viewport'е, а так же настройка их длины.

*Использование*

Достаточно просто включить кнопку ``Show Normals`` прямо на панели редактора вертексных нормалей Blend4Web или в правой панели Blender в разделе ``Mesh Display`` и настроить комфортную длину маркера в поле ``Size``.

.. only:: latex

    .. image:: src_images/lighting/vnt_img07.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img07.gif
       :align: center
       :width: 100%

Вращение
--------

*Описание*

При помощи этого инструментария можно вращать нормаль каждого вертекса индивидуально.

Кнопка ``Rotate`` (горячие клавиши ``Shift+Ctrl+R``) позволяет вращать вертексные нормали в привычном для пользователя Blender режиме.

*Использование*

Выделив один или несколько вертексов, которые хотите изменить, вращайте их, используя визуальную сферу на панели редактора вертексных нормалей Blend4Web, или задайте направление каждой координате в цифровом значении.

Более удобный вариант манипуляции с вертексными нормалями предоставляет кнопка ``Rotate``. Вращение происходит по координатам в пространстве экрана, но, как и при обычном вращении объектов в Blender, можно изолировать нужную ось координат и вращать только по ней (нажав ``X``, ``Y`` или ``Z``).

.. only:: latex

    .. image:: src_images/lighting/vnt_img08.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img08.gif
       :align: center
       :width: 100%

Split Normals
-------------

*Описание*

Режим ``Split Normals`` позволяет редактировать вертексные нормали индивидуально для каждой грани (``face`` в Blender), образующей редактируемую вершину (``vertex`` в Blender). Переключатель вертексных индексов позволяет перемещаться между нормалями разделенного вертекса.

Использование

Перейдя в режим ``Split Normals``, выберите нужный вертекc и измените направление его нормали. Прежде всего подвергнется модификации та нормаль, которая имеет наименьший индекс в очереди (то есть 0) редактируемого вертекса. Далее, перемещаясь по индексам, перейдите на следующую нормаль этого вертекса и редактируйте ее.

.. only:: latex

    .. image:: src_images/lighting/vnt_img09.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img09.gif
       :align: center
       :width: 100%

Average Split
-------------

*Описание*

``Average Split`` усредняет направление вертексной нормали, исходя из направлений нормалей, разделенных функцией ``Split Normals``.

*Использование*

Для того, чтобы объединить несколько разделенных вертексных нормалей в одну так, чтобы она имела их среднее направление, достаточно выделить нужный вертекс и нажать ``Average Split``.

.. only:: latex

    .. image:: src_images/lighting/vnt_img10.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img10.gif
       :align: center
       :width: 100%

Restore
-------

*Описание*

Кнопка ``Restore`` восстанавливает исходное направление нормалей выделенных вертексов.

*Использование*

Для того, чтобы восстановить нормали к исходному направлению (которое раcсчитывается на основе нормалей полигонов), нужно выделить нужные вертексы и нажать кнопку ``Restore``.

.. only:: latex

    .. image:: src_images/lighting/vnt_img11.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img11.gif
       :align: center
       :width: 100%

Tree, Foliage и Face
--------------------

*Описание*

Функция ``Tree`` направляет нормали выделенных вертексов в сторону от 3D-курсора. ``Foliage`` направляет нормали вертекcов строго вверх по глобальной оси ``Z``. ``Face`` направляет нормали вертексов выделенного полигона параллельно нормали этого полигона.

Использование

Чтобы воспользоваться функцией ``Tree``, выделите нужные вертексы и расположите курсор в нужном вам месте. После нажатия кнопки ``Tree`` все выделенные вертексы будут направлены в сторону от курсора, как будто бы они выстреливают из одной точки.

Функция ``Foliage`` очень проста в использовании: выделите нужные вертексы и нажмите кнопку, и функция направит их строго вверх.

Чтобы направить нормали вертексов параллельно нормали полигона, выделите нужный полигон и нажмите ``Face``. Все нормали вертексов, образующих этот полигон, будут направлены параллельно нормали самого полигона. Эта функция работает только с одним выделенным полигоном одновременно.

.. only:: latex

    .. image:: src_images/lighting/vnt_img12_01.jpg
       :align: center
       :width: 100%

    .. image:: src_images/lighting/vnt_img12_02.jpg
       :align: center
       :width: 100%

    .. image:: src_images/lighting/vnt_img12_03.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img12.gif
       :align: center
       :width: 100%

Copy/Paste
----------

*Описание*

Копирует направление нормали с одного вертекса на другой.

*Использование*

Выделите вертекс для копирования и нажмите ``Copy``. Затем выделите вертекс, на который хотите копировать результат, и нажмите ``Paste``. Вставлять скопированную информацию можно на множество разных вертексов. Кнопки не активны в режиме ``Split Mode`` и не переносят данные уже "разделенных" нормалей на другие вертексы.

.. only:: latex

    .. image:: src_images/lighting/vnt_img13.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img13.gif
       :align: center
       :width: 100%

Copy From Mesh
--------------

*Описание*

Эта функция позволяет копировать направление вертексных нормалей с одной геометрии на другую. Существует два режима копирования, ``Matched Vertices`` и ``Nearest Vertices``.

В режиме ``Matched Vertices`` копируются направления нормалей с вертекса одной модели на вертекс другой, если у них одинаковые координаты; прочие вертексы игнорируются. В режиме ``Nearest Vertices`` копируются нормали с ближайших вертексов другой модели.

*Использование*

Работа с этой функцией производится в объектном режиме. Первым нужно выделить объект, с которого будет происходить копирование, далее объект, на который будет происходить копирование. Необходимо также выделить вертексы целевого объекта, на которые необходимо произвести перенос направления нормалей.

.. only:: latex

    .. image:: src_images/lighting/vnt_img14.jpg
       :align: center
       :width: 100%

.. only:: html

    .. image:: src_images/lighting/vnt_img14.gif
       :align: center
       :width: 100%

.. index:: источники света

Освещение от источников света
=============================

На сцене может быть несколько (но не менее одного) источников света разного типа.


Типы источников света
---------------------

Поддерживаются источники света следующих типов:

*Point*
    Точечный. Свет распространяется из одной точки равномерно во все стороны, с постепенным затуханием.

*Sun*
    "Солнце". Свет распространяется из бесконечной плоскости прямолинейно в одном направлении, без затухания.

*Spot*
    Прожектор. Свет распространяется из одной точки, с ограничением угла распространения, с постепенным затуханием.

*Hemi*
    Полусфера. Свет распространяется из бесконечной полусферы, без затухания.


Настройка источников света
--------------------------

Производится во вкладке ``Object Data`` при выборе объекта-лампы.

.. image:: src_images/lighting/lighting_setup.jpg
   :align: center
   :width: 100%

|

*Color*
    Цветовая характеристика света. Значение по умолчанию (1.0, 1.0, 1.0) (белый).

*Energy*
    Интенсивность излучения. Значение по умолчанию 1.0.

*Falloff*
    Тип затухания. Значение экспортируется, но в движке всегда используется ``Inverse Square`` (обратный квадратичный). Применяется для источников света типа ``Point`` и ``Spot``. Значение по умолчанию ``Inverse Square``.

*Distance*
    Параметр затухания. Применяется для источников света типа ``Point`` и ``Spot``. Значение по умолчанию 25.0.

*Specular*
    Создание отблеска на объектах. По умолчанию включено.

*Diffuse*
    Применение рассеянного освещения к объектам. По умолчанию включено.

*Spot Shape > Size*
    Угол конуса в градусах. Применяется для источников света типа ``Spot``. Значение по умолчанию 45º.

*Spot Shape > Blend*
    Параметр смягчения края светового пятна. Применяется для источников света типа ``Spot``. Значение по умолчанию 0.15.

*Dynamic intesity*
    Источник света используется для расчета изменения времени суток. Применяется для источников света типа "Солнце". По умолчанию отключено.

*Shadows > Generate shadows*
    Источник света используется для расчета падающих теней. Применяется в случае наличия нескольких источников света. По умолчанию отключено.


.. _environment_lighting:

Освещение от окружающей среды
=============================

Движок поддерживает 3 метода симуляции рассеянного освещения от окружающих объектов.

1. "Плоское" освещение белым цветом.
2. Полусферическая модель освещения, в которой задается цвет горизонта и цвет зенита, в результате чего объекты заливаются градиентом между этими цветами в зависимости от направления нормалей.
3. Освещение с помощью :ref:`карты окружения <environment_map>` - т.н. методика image-based lighting.

Активация
---------

Включить опцию ``Environment Lighting`` во вкладке ``World``.

.. image:: src_images/lighting/lighting_environment.jpg
   :align: center
   :width: 100%


Настройка
---------

*World > Environment Lighting > Energy*
    Интенсивность освещения от окружающей среды. Значение по умолчанию 1.0.

*World > Environment Lighting > Environment Color*
    Выбор метода симуляции рассеянного освещения: ``White`` - "плоское" освещение белым цветом, ``Sky Color`` - полусферическая модель , ``Sky Texture`` - освещение с помощью :ref:`карты окружения <environment_map>`. Значение по умолчанию ``White``.

*World > Horizon Color* и *World > Zenith Color*
    Если выбрана полусферическая модель рассеянного освещения ``Sky Color``, цвет горизонта и цвет зенита задаются цветоподборщиками ``World > Horizon Color`` (цвет горизонта) и ``World > Zenith Color`` (цвет зенита). При выборе цвета рекомендуется активировать опцию ``World > Blend Sky``.


Использование карты окружения
-----------------------------

Для того, чтобы использовать карту окружения в целях реализации освещения от окружающей среды, необходимо:

#. Включить опцию ``Environment Lighting`` во вкладке ``World``.
#. Выбрать метод ``Environment Lighting > Sky Texture``.
#. Перейти из вкладки ``World`` во вкладку ``Texture``.
#. Создать :ref:`карту окружения <environment_map>`, загрузить в нее соответствующее изображение.
#. Для карты окружения на панели ``Export Options`` для значения ``Sky Texture Usage`` выбрать ``ENVIRONMENT_LIGHTING`` или ``BOTH`` (опция ``BOTH`` активирует также использование этой текстуры в качестве :ref:`текстуры неба <skydome_texture>`).


.. image:: src_images/lighting/lighting_environment_texture.jpg
   :align: center
   :width: 100%

|

.. _shadows:

Тени
====

Тени - один из важнейших элементов при рендеринге конечного изображения. Они предоставляют зрителю не только информацию о силуэте объектов, но и об их высоте и взаимном расположении, положении источника света и т.д.

Платформой Blend4Web реализуются такие техники, как каскадные карты теней (CSM) и смягченные тени (PCF).

Активация
---------

#. На объектах, **отбрасывающих** тени, включить опцию ``Shadows: Cast`` во вкладке ``Object``.
#. На объектах, **получающих** тени, включить опцию ``Shadows: Receive`` во вкладке ``Object``.
#. Убедиться, что включена опция ``Shadows`` ``AUTO`` или ``ON`` во вкладке ``Render``.

.. note::

    Объекты, имеющие :ref:`прозрачные материалы с градиентом <alpha_blend>`, не отбрасывают теней.

    .. image:: src_images/lighting/alpha_shadows.jpg
       :align: center
       :width: 100%

|

Настройка
---------

*Направление*
    В случае наличия нескольких источников света рекомендуется указать, какой именно источник света будет использоваться для расчета падающих теней, включив опцию ``Shadows > Generate Shadows`` во вкладке ``Object Data`` при выборе объекта-лампы.

*Цвет*
    Цвет тени определяется настройками :ref:`освещения от окружающей среды <environment_lighting>`.


Во вкладке ``Render`` на панели ``Shadows`` находятся дополнительные настройки:

.. image:: src_images/lighting/b4w_shadow_settings.png
   :align: center
   :width: 100%

*Resolution*
    Разрешение используемой карты теней. Значение по умолчанию: 2048x2048px.

*Self-shadow polygon offset*
    Коэффициент смещения полигона в зависимости от ориентации к источнику света. Значение по умолчанию: 1.

*Self-shadow normal offset*
    Коэффициент смещения полигона по нормали. Значение по умолчанию: 0.01.

Последние две настройки служат для борьбы с артефактами самозатенения. Они проявляются на объектах, одновременно отбрасывающих и принимающих тени.
Параметр ``Self-shadow polygon offset`` лучше справляется с артефактами во внутренних областях полигонов, а ``Self-shadow normal offset`` - в приграничных.
Оба параметра приводят к искажению теней, поэтому рекомендуется держать их как можно меньшими.

.. image:: src_images/lighting/self_shadow_artifacts.png
   :align: center
   :width: 100%

|

*Enable CSM*
    Включение каскадной модели теней; открывает доступ к расширенным настройкам. Отключено по умолчанию.

Эта опция позволяет выбрать один из следующих вариантов наложения теней:

* Стандартная модель, использующая одну оптимизированную карту теней, охватывающую всю сцену (``Enable CSM`` отключена).
* Каскады теней (``Enable CSM`` включена).

*Blur radius*
    Коэффициент размытия теней, позволяющий настроить cмягченные тени. Значение по умолчанию: 3. Коэффициент 0 даст жесткие тени.

.. image:: src_images/lighting/blur_radius.png
   :align: center
   :width: 100%

|

Смягченные тени могут повысить качество и реалистичность изображения. Они скрывают неизбежную при использовании основанных на изображениях техник зубчатость краев, особенно сильно проявляющуюся для карт теней низкого разрешения. Использование смягченных теней часто позволяет снизить разрешение без существенной потери качества.


Стандартная модель
..................

Этот вариант больше подходит для маленьких сцен, состоящих из небольшого числа объектов. Благодаря оптимизации на таких сценах можно добиться более высокого качества теней по сравнению с каскадной моделью. Данный вариант проще и быстрее настроить, а использование всего лишь одной карты теней положительно сказывается на производительности.


Каскады теней
.............

.. note::

    Данные настройки поддерживаются только для источников освещения типа ``Sun``. Для других источников каскады автоматически отключаются.

Для обеспечения приемлемого качества теней и одновременно покрытия значительных пространств необходимо использовать несколько стадий генерации теней (каскадов). При этом вблизи наблюдателя располагается каскад с наилучшим качеством, вдали от наблюдателя — с наихудшим.
Этот вариант больше подходит для сцен среднего и большого размера, например, игровых уровней.

При включении предоставляет расширенные настройки:

.. image:: src_images/lighting/b4w_shadow_settings_csm.png
   :align: center

|

*CSM number*
    Количество каскадов теней. Поддерживается от 1 до 4 каскадов. Значение по умолчанию: 1.

*CSM first cascade border*
    Размер первого каскада. Значение по умолчанию: 10.0.

*CSM last cascade border*
    Размер последнего каскада. Значение по умолчанию: 100.0.

Размеры промежуточных каскадов интерполируются на основе последних двух параметров.

.. note::

    При настройке следует помнить, что, увеличивая размер каскада, мы получаем на нем менее качественные тени. С другой стороны, уменьшение параметра ``CSM first cascade border`` приблизит к камере и сделает более заметными последующие менее детальные каскады. Уменьшение параметра ``CSM last cascade border`` приведет к исчезновению теней на более близком расстоянии от камеры. Однако, при использовании мягких теней качество в целом улучшится благодаря размытию на границах.

.. image:: src_images/lighting/csm_cascade_distance.png
   :align: center
   :width: 100%

|

*CSM first cascade blur radius*
    Коэффициент размытия на первом каскаде. Значение по умолчанию: 3. Коэффициент 0 даст жесткие тени.

*CSM last cascade blur radius*
    Коэффициент размытия на последнем каскаде. Значение по умолчанию: 1.5. Коэффициент 0 даст жесткие тени.

Радиус размытия каждого промежуточного каскада интерполируется на основе этих параметров.

.. note::

    Смягченные тени рекомендуется настраивать сначала на первом каскаде опцией ``CSM first cascade blur radius``, а далее на всех остальных с помощью ``CSM last cascade blur radius``. Часто на последнем каскаде может потребоваться размытие меньшее, нежели на первом. Это нужно для того, чтобы тени на последнем каскаде не стали слишком блеклыми из-за низкой детализации, к тому же это уменьшит нежелательные артефакты самозатенения.


*Fade-out last cascade*
    Плавное исчезновение последнего каскада. По умолчанию включено.

*Blend between cascades*
    Сглаживание границ между каскадами. По умолчанию включено.

.. image:: src_images/lighting/blend_between_cascades.png
   :align: center
   :width: 100%

|

.. index:: цвет фона

Цвет фона
=========

Цвет фона можно задать несколькими способами:

1. Установить параметры ``Horizon Color`` и ``Zenith Color`` на вкладке ``World`` в Blender, предварительно выставив опцию ``World > Render Sky``.

2. Поместить сцену внутрь модели (например, куба или сферы) с направленными внутрь нормалями, с материалом и опциональной текстурой.

3. Разместить перед камерой поверхность с материалом и опциональной текстурой, присоединить ее к камере связью родитель-потомок. При необходимости настроить расстояние до поверхности, переднюю и заднюю плоскости отсечения камеры.

.. image:: src_images/lighting/parented_background.jpg
   :align: center
   :width: 100%

4. Использовать :ref:`текстуру неба <skydome_texture>`.

5. Настроить динамически генерируемую :ref:`атмосферу <atmosphere>`.

6. Установить параметр движка ``background_color``, используя программный метод ``config.set()``, предварительно отключив опцию ``World > Render Sky`` на вкладке ``World`` в Blender. Установленное значение используется в качестве аргумента метода WebGL ``clearColor()``. Для получения корректных результатов рекомендуется отключить прозрачность контекста WebGL (параметр ``alpha``). Такая конфигурация используется по умолчанию в стандартном веб-плеере движка.

    .. code-block:: javascript

        var m_cfg = b4w.require("config");
        var m_main = b4w.require("main");

        // gray
        m_cfg.set("background_color", new Float32Array([0.224, 0.224, 0.224, 1.0]));
        m_cfg.set("alpha", false);

        m_main.init(...);

7. В качестве фона можно использовать любой HTML контент, находящийся позади элемента ``canvas``, который используется для рендеринга. Для это необходимо активировать прозрачность контекста WebGL (параметр ``alpha``), предварительно отключив опцию ``World > Render Sky`` на вкладке ``World`` в Blender. Для получения корректных результатов рекомендуется выставить полностью прозрачный черный цвет фона. Такая конфигурация используется по умолчанию в стандартном :ref:`просмотрщике сцен <viewer>` SDK движка.

    .. code-block:: javascript

        var m_cfg = b4w.require("config");
        var m_main = b4w.require("main");

        m_cfg.set("background_color", new Float32Array([0.0, 0.0, 0.0, 0.0]));
        m_cfg.set("alpha", true);

        m_main.init(...);


    .. seealso:: :ref:`alpha_compositing`
