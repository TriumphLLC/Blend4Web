.. _animation:

.. index:: анимация

********
Анимация
********

В общем случае, к анимации относятся изменения параметров объектов во времени.
Движком поддерживаются следующие типы анимации:

* Объектная анимация. Заключается в трансформации объекта в пространстве как
  единого целого.

* Скелетная анимация, то есть деформация геометрии объекта с помощью системы
  костей (скиннинг). Сюда же относится анимация костей в арматурном объекте с
  целью прикрепления объектов к костям.

* Вертексная анимация. Заключается в покадровой записи деформаций объекта с их
  последующим воспроизведением.

* Параметризация источников звука. Изменяемые параметры: громкость
  (``Volume``) и высота звука (``Pitch``).

* Анимация выходного значения ноды ``Value`` в нодовом материале.

* Процедурная анимация в виде колебаний объекта под действием ветра. Описано
  :ref:`отдельно <wind>`.

* Эмиссия частиц из источника. Описано в :ref:`соответствующем разделе <particles>`.

Управление анимацией
====================

Управление анимацией в движке осуществляется одним из двух способов:

#. Автоматически, с помощью активации панели ``Animation`` и указания поведения анимации
   ``Behavior`` в свойствах объекта. В данном случае будет осуществлён
   поиск доступного метода и в случае положительного результата, объект
   анимируется с момента загрузки сцены. В случае скелетной анимации, по
   умолчанию воспроизводится актор, назначенный на объекте в окне ``Action
   Editor``.

#. Программно, используя функции модуля движка ``animation``.

Для отладки анимации имеет смысл использовать интерфейс ``Animation``
программы-просмотрщика, рассмотренный в :ref:`соответствующем разделе <viewer>`.


.. _whole_object_anim:

Объектная анимация
==================

Изменяемые параметры: координаты центра (``Location``), поворот (``Rotation``) и масштабирование (``Scale``).

.. image:: src_images/animation/wind_generator.jpg
   :align: center
   :width: 100%

|

Осуществляется с помощью добавления ключей анимации для движения объекта в программе Blender и
их последующего воспроизведения в движке.

Поддерживаются следующие типы ключей:

* *Location*

* *Rotation* -- необходимо осуществлять в режиме ``Quaternion(WXYZ)`` либо ``XYZ Euler``.

* *Scale* -- для получения корректных результатов, фактор масштабирования должен
  быть одинаковым вдоль любых из осей.

* *LocRot* -- комбинация *Location* и *Rotation*.

* *LocScale* -- комбинация *Location* и *Scale*.

* *LocRotScale* -- комбинация *Location*, *Rotation* и *Scale*.

* *RotScale* -- комбинация *Rotation* и *Scale*.

В случае анимации объекта-меша, необходимо включение опции ``Force Dynamic Object`` панели ``Rendering Properties`` на
вкладке свойств объекта.


Скиннинг и скелетная анимация
=============================

.. image:: src_images/animation/rig.jpg
   :align: center
   :width: 100%

|

Для осуществления скелетной анимации, кроме деформируемого объекта-меша требуется
объект-арматура. Осуществляется в четыре этапа:

#. Создание скелета объекта в арматурном объекте.
#. Назначение вертексных групп в объекте-меше и их привязка к костям. Может быть осуществлено, например, методом "раскраски" весов (weight painting).
#. Анимация костей в арматурном объекте. Используются те же ключи, что и в случае
   объектной анимации.
#. В случае нетривиальных видов скелетной анимации, включающих инверсную кинематику,
   требуется стадия запекания анимационных акторов (блок ``Action`` в Blender).
   Запекание производится с помощью интерфейса ``Bake Skeletal Animation``, расположенного на панели инструментов ``Blend4Web``:

.. image:: src_images/animation/skeletal_anim_baker.png
   :align: center
   :width: 100%

|

.. _animation_bake:

Запекание производится при выделенном арматурном объекте. Элементы интерфейса ``Bake Skeletal Animation``:


* Окно со списком запекаемых акторов -- запекать только те акторы, которые
  указаны в списке, иначе запекать все возможные акторы.

* *Name* -- имя текущего актора из списка запекаемых акторов.

* *Optimize Keyframes* -- произвести оптимизацию ключей анимации после запекания. В
  случае получения некорректных результатов, рекомендуется отключить опцию.

* *Bake* -- произвести запекание. После успешного окончания процесса на
  сцене появляются акторы с именами вида *ИМЯ_B4W_BAKED*. Данные акторы будут
  автоматически назначены на арматурном объекте и воспроизведены в движке.
  Стоит отметить, что работа подобных акторов в Blender не гарантируется.

.. note::
    Движок поддерживает не более 4-х вертексных групп на каждом из вертексов,
    эти группы отбираются по величине влияния или "веса" вертекса. В процессе
    загрузки исходного файла со сценой "веса" вертексов проходят через процедуру
    нормализации, т.е. их сумма приводится в единице.

    Для удаления вертексных групп, которые не используются арматурой, можно воспользоваться
    кнопкой ``Clean Unused Vertex Groups`` в одноименной панели.

    .. image:: src_images/animation/vgroups_cleaner.png
       :align: center
       :width: 100%

В Blend4Web присутствует начальная поддержка ограничителей для костей. На сегодняшний день поддерживается только один тип ограничителя, ``Copy Transform``. Это позволяет привязывать арматуру к различным объектам, в том числе физическим (ragdoll). Поддержка других ограничителей ожидается в будущих версиях.

Вертексная анимация
===================

.. image:: src_images/animation/flag.jpg
   :align: center
   :width: 100%

|

Позволяет записать любые изменения геометрии объекта-меша. Необходимо учитывать,
что каждый кадр вертексной анимации эквивалентен мешу. Не рекомендуется создание
длинной анимации для высокополигонального меша, поскольку это может привести к
существенному возрастанию размера исходного и экспортируемого файлов, а также
замедлить работу движка.

.. _ver_anim:

Для запекания вертексной анимации предусмотрен инструмент ``Bake Vertex Animation``, 
расположенный на панели инструментов ``Blend4Web``.

.. image:: src_images/animation/vertex_anim_baker.jpg
   :align: center
   :width: 100%


Параметризация источников звука
===============================

На объектах-спикерах дополнительно поддерживаются следующие типы анимационных
ключей:

* *Volume* -- громкость звука источника.

* *Pitch* -- высота звука источника.

Параметризация источников звука по своей сути повторяет объектную анимацию.


.. _node_anim:

Анимация нод Value и RGB
========================

В нодовых материалах поддерживается воспроизведение анимационных ключей, проставленных на нодах ``Value`` и ``RGB``.

.. image:: src_images/animation/node_value_anim.jpg
   :align: center

|

.. image:: src_images/animation/node_RGB_anim.png
   :align: center

|

.. note::
    Анимация числовых и цветовых значений в других нодах не поддерживается.

Может быть также использована для создания треков в :ref:`редакторе нелинейной анимации <nla_editor>`. Поддерживается несколько анимированных нод ``Value`` и ``RGB`` в одном материале. Значения нод могут быть также установлены программно с помощью методов ``set_nodemat_value`` и ``set_nodemat_rgb`` модуля ``objects``.

.. seealso:: :ref:`node_time`


