.. _outdoor_rendering:

***********************
Рендеринг наружных сцен
***********************

.. _water:

Вода
====

Активация
---------

Для предполагаемого материала воды активировать панель ``Water`` во вкладке ``Material``. 

.. image:: src_images/outdoor_rendering/water_material_setup.png
   :align: center
   :width: 100%

Базовые настройки
-----------------

*Прозрачность*
    Рекомендуется включить прозрачность с градиентом ``Transparency > Alpha Blend`` и настроить значение ``Alpha``. 

*Параметры освещения*
    Параметры освещения материала воды настраиваются как описано в разделе :ref:`material_lighting_params`.

Динамика волн
-------------

Рябь на водной поверхности симулируется при помощи карт нормалей с анимированными развертками (в количестве от 0 до 4). Для текстур - карт нормалей используется только одно общее изображение, текстуры различаются параметрами ``Mapping > Size``. Меш для воды должен иметь текстурную развертку.
   
Смачивание поверхностей
-----------------------

Осуществляется автоматически. Для включения эффекта на соответствующих материалах необходимо активировать опцию ``Wettable`` на панели ``Rendering Options``.


Отражение и эффект Френеля
--------------------------

Для материала воды поддерживается как статическое, так и динамическое зеркальное отражение, с эффектом Френеля. См. раздел :ref:`material_mirror`.


.. image:: src_images/outdoor_rendering/water_reflection_dynamic.jpg
   :align: center
   :width: 100%

Сглаживание у береговой линии
-----------------------------

Эффект заключается в том, что вода ближе к берегу становится прозрачнее.

*Water > Shore Smoothing*
    Включить сглаживание.

*Water > Absorb Factor*
    Коэффициент поглощения света водой. Чем он выше, тем прозрачнее вода.


Градиент цвета
--------------
Для создания цветого градиента на материале воды должна быть наложена текстура с включенной опцией ``Export Options > Shore Distance Map``, генерируемая с помощью скрипта для :ref:`запекания параметров береговой линии <shore_distance_bake>`.

*Shallow water > Color*
    Цвет воды на мелководье.

*Shallow water > Factor*
    Коэффициент примешивания цвета воды на мелководье.

*Shore water > Color*
    Цвет воды непосредственно у береговой линии.

*Shore water > Factor*
    Коэффициент примешивания цвета воды на береговой линии.

Преломление
-----------

Во вкладке ``Render``  в панели ``Reflections and Refractions`` выставить опцию ``Refractions`` в положение ``ON`` или ``AUTO``.

.. image:: src_images/outdoor_rendering/water_refraction.jpg
   :align: center
   :width: 100%

Пена
----

Активация
.........

Для создания пены необходимо добавить в текстурный слот материала воды диффузную текстуру, в каждом из RGB - каналов которой сделует расположить черно-белые текстуры пены. Для полученной текстуры необходимо активировать панель ``Water Foam``.


.. image:: src_images/outdoor_rendering/water_texture_setup_foam.png
   :align: center
   :width: 100%


Настройка текстур
.................

*Influence > Color*
    Фактор влияния цвета текстуры. Значение по умолчанию 1.0.

*Water Foam > UV Frequency*
    Частота колебаний анимированной развертки. Значение по умолчанию (1.0, 1.0).

*Water Foam > UV Magnitude*
    Амплитуда колебаний анимированной развертки. Значение по умолчанию (1.0, 1.0).


Настройка материала
...................

*Foam > Factor*
    Фактор общего влияния пены. Значение по умолчанию 0.5.


Каустика и хроматическая аберрация
----------------------------------

Для создания каустики на подводных объектах следует включить опцию ``Caustics``. Так же на сцене должен присутстовать источник освещение типа ``Sun``.

.. image:: src_images/outdoor_rendering/water_caustics.jpg
   :align: center
   :width: 100%

*Scale*
    Размер ячеек процедурной текстуры. Значение по умолчанию 0.25.

*Brightness*
    Фактор влияния каустики. Значение по умолчанию 0.5.

Подводная среда
---------------

.. image:: src_images/outdoor_rendering/underwater.jpg
   :align: center
   :width: 100%

Настройки видимости ("туман")
.............................

*Underwater Fog > Color*
    Цвет тумана. Значение по умолчанию (0.4, 0.6, 0.7).

*Underwater Fog > Density*
    Экспоненциальный фактор, влияющий на плотность и расстояние. Значение по умолчанию 0.06.

Применяются также настройки :ref:`сумеречных лучей <god_rays>`.


.. note::
    Для корректного отображения водной поверхности необходимо выключить опцию ``Rendering Options > Backface Culling``.

.. image:: src_images/outdoor_rendering/water_border.jpg
   :align: center
   :width: 100%

.. _water_volumetric_waves:

Объемные волны
--------------

Активация
.........

Для создания объемных волн следует включить опцию ``Waves``.

.. image:: src_images/outdoor_rendering/water_waves.jpg
   :align: center
   :width: 100%

Настройка
.........

*Wave Height*
    Высота волн. Значение по умолчанию 0.0.

*Wave Length*
    Длина волн. Значение по умолчанию 10.0.

*Noise Dist Scale 0*
    Размер первого компонента волн, удаленных от берега.

*Noise Dist Scale 1*
    Размер второго компонента волн, удаленных от берега.

*Noise Dist Freq 0*
    Частота первого компонента волн, удаленных от берега.

*Noise Dist Freq 1*
    Частота второго компонента волн, удаленных от берега.

*Min Dir Shore Fac*
    Минимальный коэффициент уменьшения высоты прибрежных волн.

*Dir Frequency*
    Частота накатывания прибрежных волн.

*Noise Dir Scale*
    Размер шума на прибрежных волнах.

*Noise Dir Freq*
    Частота шума на прибрежных волнах.

*Min Dir Noise Fac*
    Минимальное значение шума на прибрежных волнах.
    
*Min Dist Fac*
    Минимальный коэффициент примешивания волн, удаленных от берега.

*Horizontal Factor*
    Коэффициент смещения прибрежных волн в направлении к берегу.

Настройки генерируемой поверхности
----------------------------------

*Generate Mesh*
    Включить генерируемую поверхность.

*Cascades Number*
    Количество каскадов в генерируемой поверхности.

*Subdivisions*
    Количество подразделений в генерируемой поверхности.

*Detailed Distance*
    Максимальное расстояние от камеры до края последнего каскада.


.. index:: параметры берега, береговая линия

.. _shore_distance_bake:

Создание текстуры с параметрами береговой линии
...............................................

На панели инструментов (горячая клавиша "T") во вкладке ``Blend4Web`` открыть панель ``Bake Shore Distance Map``. Выставить настройки максимального расстояния до берега ``Maximum Distance`` и размера получаемой текстуры ``Texture Size``. Выбрать сначала объект (или несколько объектов) ландшафта, затем объект воды. Нажать кнопку ``Bake``. 

В зависимости от размера текстуры и количества вершин в обрабатываемых мешах время выполнения скрипта варьируется от долей секунды до нескольких минут. Убедиться, что в меше воды создана текстура с названием ``ShoreDistance``. 

При вызове скрипта в материале воды сохраняются некоторые системные свойства. Поэтому, после его работы обязательно нужно сохранять сцену. 


.. _atmosphere:

Атмосфера
=========

Рассеивание
-----------

Во вкладке ``World`` активировать панель ``Procedural Sky``, предварительно выставив опцию ``World > Render Sky``. Если одновременно с этим используется статическая :ref:`текстура неба <skydome_texture>`, она будет заменена.

.. note::

    Кроме того, процедурная текстура неба может быть использована для имитации рассеянного :ref:`освещения от окружающей среды <environment_lighting>`, по аналогии со статической :ref:`текстурой неба <skydome_texture>`. Для этого необходимо выставить опции ``Procedural Sky > Use as Environment Lighting`` и ``Environment Lighting > Sky Texture``. Если текстура мира для рассеянного освещения уже существует, она будет заменена.


.. image:: src_images/outdoor_rendering/skydome_procedural.jpg
   :align: center
   :width: 100%

|

Движком поддерживаются следующие настройки:

*Procedural Sky > Sky Color*
     Базовый цвет неба. Значение по умолчанию (0.087, 0.255, 0.6) (голубой).

*Procedural Sky > Rayleigh Brightness*
     Яркость рэлеевского рассеяния (на малых частицах). Значение по умолчанию 3.3.

*Procedural Sky > Mie Brightness*
     Яркость рассеяния Ми (на крупных частицах). Значение по умолчанию 0.1.

*Procedural Sky > Spot Brightness*
     Яркость пятна солнца. Значение по умолчанию 20.0.

*Procedural Sky > Scatter Strength*
     Фактор рассеяния света. Значение по умолчанию 0.2.

*Procedural Sky > Rayleigh Strength*
     Фактор рэлеевского рассеяния. Значение по умолчанию 0.2.

*Procedural Sky > Mie Strength*
     Фактор рассеяния Ми. Значение по умолчанию 0.006.

*Procedural Sky > Rayleigh Collection Power*
     Степенной коэффицент рэлеевского рассеяния. Значение по умолчанию 0.35.

*Procedural Sky > Mie Collection Power*
     Степенной коэффицент рассеяния Ми. Значение по умолчанию 0.5.

*Procedural Sky > Mie Distribution*
     Распределение рассеяния Ми. Значение по умолчанию 0.4.



Туман
-----

Настраивается во вкладке ``World``.

*Mist > Density*
    Экспоненциальный фактор, влияющий на плотность и расстояние. Значение по умолчанию 0.0.

*Mist > Color*
    Цвет тумана. Значение по умолчанию (0.5, 0.5, 0.5) (серый).
    
При использовании динамического неба цвет тумана определяется цветом неба.


Время суток
-----------

Для лампы необходимо выставить опцию ``Dynamic Intensity``.

Время суток устанавливается приложениями с использованием соответствующего API. В частности, время суток может устанавливаться в интерфейсе ``Lighting``
:ref:`просмотрщика сцен <viewer>`. 

.. image:: src_images/outdoor_rendering/sunset.jpg
   :align: center
   :width: 100%


Звезды
------

Настройка данного эффекта описывается в разделе :ref:`material_halo`.

.. image:: src_images/outdoor_rendering/stars.jpg
   :align: center
   :width: 100%

.. _wind:

Ветер
=====

Сила и направление ветра оказывает воздействие на:
    - :ref:`анимацию травы и крон деревьев <wind_bending>`
    - :ref:`динамику систем частиц <particles_force_fields>`
    - :ref:`частоту колебаний волн воды <water_volumetric_waves>` (в настоящий момент влияет только сила)


Активация
---------

Добавить на сцену объект - силовое поле типа ``Wind``.


Настройка
---------

*Направление*
    Направление задается посредством вращения объекта - силового поля.

*Force Fields > Strength*
    Сила ветра. Располагается во вкладке ``Physics``. Значение по умолчанию 1.0.


.. _wind_bending:

Анимация травы и крон деревьев
------------------------------

Подготовка ресурсов для рендеринга травы описана в разделе :ref:`particles_grass`.


Активация
.........

На объекте травы или дерева активировать панель ``Wind Bending``.


Настройка
.........

Интерфейс для настроек появляется после активации панели ``Wind Bending``.

.. image:: src_images/outdoor_rendering/wind_bending_setup.jpg
   :align: center
   :width: 80%

|

*Main bending > Angle*
    Амплитуда угла "основного" отклонения под действием ветра (в градусах). Значение по умолчанию 10.0.
    
*Main bending > Frequency*
    Частота "основного" отклонения под действием ветра. Значение по умолчанию 0.25.

*Main bending > Main Stiffness (A)*
    Текстовое поле для названия слоя вертексного цвета, содержащего информацию о жесткости "основного" отклонения. Может быть оставлено пустым. 

*Detail bending > Amplitude*
    Амплитуда угла "детализованного" отклонения под действием ветра (в градусах). Значение по умолчанию 0.1.

*Detail bending > Branch Amplitude*
    Амплитуда угла отклонения ветвей под действием ветра (в градусах). Значение по умолчанию 0.3.

*Detail bending > Bending Frequency*
    Частота колебаний ветвей. Значение по умолчанию 1.0.

*Detail bending > Leaves Stiffness (R)*
    Текстовое поле для названия слоя вертексного цвета, содержащего информацию о жесткости листвы. Может быть оставлено пустым. 

*Detail bending > Leaves Phase (G)*
    Текстовое поле для названия слоя вертексного цвета, содержащего информацию о фазе отклонения листвы. Может быть оставлено пустым. 

*Detail bending > Overall Stiffness (B)*
    Текстовое поле для названия слоя вертексного цвета, содержащего информацию об общей жесткости листвы. Может быть оставлено пустым. 

Слои вертексных цветов с указанными в настройках названиями должны существовать в меше.

.. image:: src_images/outdoor_rendering/wind_bending_vcolors.jpg
   :align: center
   :width: 100%

